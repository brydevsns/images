/*! For license information please see livechat-widget.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("LiveChatWidget",[],t):"object"==typeof exports?exports.LiveChatWidget=t():e.LiveChatWidget=t()}(this,(()=>(()=>{var e={4069:e=>{"use strict";for(var t=/[\\\"\x00-\x1F]/g,n={},r=0;r<32;++r)n[String.fromCharCode(r)]="\\U"+("0000"+r.toString(16)).slice(-4).toUpperCase();function i(e){return t.lastIndex=0,e.replace(t,(function(e){return n[e]}))}n["\b"]="\\b",n["\t"]="\\t",n["\n"]="\\n",n["\f"]="\\f",n["\r"]="\\r",n['"']='\\"',n["\\"]="\\\\",e.exports={stringify:function e(t){switch(typeof t){case"string":return'"'+i(t)+'"';case"number":return isFinite(t)?t:"null";case"boolean":return t;case"object":return null===t?"null":Array.isArray(t)?function(t){for(var n="[",r="",i=0;i<t.length;++i)r+=n,n=",",r+=e(t[i]);return","!=n?"[]":r+"]"}(t):function(t){var n="{",r="",s=Object.keys(t);s.sort();for(var o=0;o<s.length;++o){var a=s[o];r+=n+'"'+i(a)+'":',n=",",r+=e(t[a])}return","!=n?"{}":r+"}"}(t);default:throw new Error("Cannot stringify: "+typeof t)}}}},2748:e=>{var t={},n=1,r={htmlInitCb:null,notifyCb:null};window.addEventListener("message",(function(e){var t;"xjw"===e.data.pwd&&("htmlInit"!==e.data.type&&"resetStatus"!==e.data.type||(t=e.data.data,r.htmlInitCb||console.error("[pm] 未设置页面初始化回调 htmlInitCb"),r.htmlInitCb(t)),"notify"===e.data.type&&function(e){r.notifyCb||console.error("[pm] 未设置推送通知处理参数"),r.notifyCb(e)}(e.data.data))}),!1),e.exports={pm:r,$p:function(e,r,i){var s=e.type;"api"!=s&&s?window.parent.postMessage(e,"*"):(e.type||(e={type:"api",data:e}),e._index_=n,t[n]={data:e,fun:r,err:i},window.parent.postMessage(e,"*"),t[n].load=function(e){e.data&&e.data._index_&&t[e.data._index_]&&(t[e.data._index_].err&&e.data.err?t[e.data._index_].err(e.data.data):t[e.data._index_].fun&&t[e.data._index_].fun(e.data.data),window.removeEventListener("message",t[e.data._index_].load,!1),delete t[e.data._index_])},window.addEventListener("message",t[n].load,!1),++n)}}},5364:e=>{"use strict";e.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var r=0;r<e.length;r++){var i=e.charAt(r),s=i.charCodeAt(0);if(255!==t[s])throw new TypeError(i+" is ambiguous");t[s]=r}var o=e.length,a=e.charAt(0),c=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function u(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;for(var n=0,r=0,i=0;e[n]===a;)r++,n++;for(var s=(e.length-n)*c+1>>>0,l=new Uint8Array(s);e[n];){var u=t[e.charCodeAt(n)];if(255===u)return;for(var d=0,h=s-1;(0!==u||d<i)&&-1!==h;h--,d++)u+=o*l[h]>>>0,l[h]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=d,n++}for(var p=s-i;p!==s&&0===l[p];)p++;for(var g=new Uint8Array(r+(s-p)),f=r;p!==s;)g[f++]=l[p++];return g}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,s=t.length;i!==s&&0===t[i];)i++,n++;for(var c=(s-i)*l+1>>>0,u=new Uint8Array(c);i!==s;){for(var d=t[i],h=0,p=c-1;(0!==d||h<r)&&-1!==p;p--,h++)d+=256*u[p]>>>0,u[p]=d%o>>>0,d=d/o>>>0;if(0!==d)throw new Error("Non-zero carry");r=h,i++}for(var g=c-r;g!==c&&0===u[g];)g++;for(var f=a.repeat(n);g<c;++g)f+=e.charAt(u[g]);return f},decodeUnsafe:u,decode:function(e){var t=u(e);if(t)return t;throw new Error("Non-base"+o+" character")}}}},7063:function(e,t){var n,r;n=function(){var e=XMLHttpRequest;if(!e)throw new Error("missing XMLHttpRequest");t.log={trace:r,debug:r,info:r,warn:r,error:r};function t(s,o){if("function"!=typeof o)throw new Error("Bad callback given: "+o);if(!s)throw new Error("No options given");var a=s.onResponse;if((s="string"==typeof s?{uri:s}:JSON.parse(JSON.stringify(s))).onResponse=a,s.verbose&&(t.log=function(){var e,t,n={},s=["trace","debug","info","warn","error"];for(t=0;t<s.length;t++)n[e=s[t]]=r,"undefined"!=typeof console&&console&&console[e]&&(n[e]=i(console,e));return n}()),s.url&&(s.uri=s.url,delete s.url),!s.uri&&""!==s.uri)throw new Error("options.uri is a required argument");if("string"!=typeof s.uri)throw new Error("options.uri must be a string");for(var c=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],l=0;l<c.length;l++)if(s[c[l]])throw new Error("options."+c[l]+" is not supported");if(s.callback=o,s.method=s.method||"GET",s.headers=s.headers||{},s.body=s.body||null,s.timeout=s.timeout||t.DEFAULT_TIMEOUT,s.headers.host)throw new Error("Options.headers.host is not supported");s.json&&(s.headers.accept=s.headers.accept||"application/json","GET"!==s.method&&(s.headers["content-type"]="application/json"),"boolean"!=typeof s.json?s.body=JSON.stringify(s.json):"string"!=typeof s.body&&(s.body=JSON.stringify(s.body)));var u=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};if(s.qs){var d="string"==typeof s.qs?s.qs:u(s.qs);-1!==s.uri.indexOf("?")?s.uri=s.uri+"&"+d:s.uri=s.uri+"?"+d}if(s.form){if("string"==typeof s.form)throw"form name unsupported";if("POST"===s.method){var h=(s.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(s.headers["content-type"]=h,h){case"application/x-www-form-urlencoded":s.body=u(s.form).replace(/%20/g,"+");break;case"multipart/form-data":var p=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var n=[];for(var r in e)e.hasOwnProperty(r)&&n.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+r+'"\n\n'+e[r]+"\n");return n.push("--"+t.boundry+"--"),t.body=n.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t}(s.form);s.body=p.body,s.headers["content-type"]=p.type;break;default:throw new Error("unsupported encoding:"+h)}}}return s.onResponse=s.onResponse||r,!0===s.onResponse&&(s.onResponse=o,s.callback=r),!s.headers.authorization&&s.auth&&(s.headers.authorization="Basic "+function(e){var t,n,r,i,s,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=0,c=0,l="",u=[];if(!e)return e;do{t=(s=e.charCodeAt(a++)<<16|e.charCodeAt(a++)<<8|e.charCodeAt(a++))>>18&63,n=s>>12&63,r=s>>6&63,i=63&s,u[c++]=o.charAt(t)+o.charAt(n)+o.charAt(r)+o.charAt(i)}while(a<e.length);switch(l=u.join(""),e.length%3){case 1:l=l.slice(0,-2)+"==";break;case 2:l=l.slice(0,-1)+"="}return l}(s.auth.username+":"+s.auth.password)),function(r){var i=new e,s=!1,o=function(e){var t,n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(e){(t=document.createElement("a")).href="",t=t.href}var r=n.exec(t.toLowerCase())||[],i=n.exec(e.toLowerCase());return!(!i||i[1]==r[1]&&i[2]==r[2]&&(i[3]||("http:"===i[1]?80:443))==(r[3]||("http:"===r[1]?80:443)))}(r.uri),a="withCredentials"in i;if(n+=1,i.seq_id=n,i.id=n+": "+r.method+" "+r.uri,i._id=i.id,o&&!a){var c=new Error("Browser does not support cross-origin request: "+r.uri);return c.cors="unsupported",r.callback(c,i)}function l(){s=!0;var e=new Error("ETIMEDOUT");return e.code="ETIMEDOUT",e.duration=r.timeout,t.log.error("Timeout",{id:i._id,milliseconds:r.timeout}),r.callback(e,i)}i.timeoutTimer=setTimeout(l,r.timeout);var u={response:!1,loading:!1,end:!1};return i.onreadystatechange=d,i.open(r.method,r.uri,!0),o&&(i.withCredentials=!!r.withCredentials),i.send(r.body),i;function d(n){if(s)return t.log.debug("Ignoring timed out state change",{state:i.readyState,id:i.id});if(t.log.debug("State change",{state:i.readyState,id:i.id,timed_out:s}),i.readyState===e.OPENED)for(var o in t.log.debug("Request started",{id:i.id}),r.headers)i.setRequestHeader(o,r.headers[o]);else i.readyState===e.HEADERS_RECEIVED?h():i.readyState===e.LOADING?(h(),p()):i.readyState===e.DONE&&(h(),p(),g())}function h(){if(!u.response){if(u.response=!0,t.log.debug("Got response",{id:i.id,status:i.status}),clearTimeout(i.timeoutTimer),i.statusCode=i.status,o&&0==i.statusCode){var e=new Error("CORS request rejected: "+r.uri);return e.cors="rejected",u.loading=!0,u.end=!0,r.callback(e,i)}r.onResponse(null,i)}}function p(){u.loading||(u.loading=!0,t.log.debug("Response body loading",{id:i.id}))}function g(){if(!u.end){if(u.end=!0,t.log.debug("Request done",{id:i.id}),i.body=i.responseText,r.json)try{i.body=JSON.parse(i.responseText)}catch(e){return r.callback(e,i)}r.callback(null,i,i.body)}}}(s)}var n=0;function r(){}function i(e,t){return function(n,r){return"object"==typeof r&&(n+=" "+JSON.stringify(r)),e[t].call(e,n)}}return t.withCredentials=!1,t.DEFAULT_TIMEOUT=18e4,t.defaults=function(e,n){var r=function(t){return function(n,r){for(var i in n="string"==typeof n?{uri:n}:JSON.parse(JSON.stringify(n)),e)void 0===n[i]&&(n[i]=e[i]);return t(n,r)}},i=r(t);return i.get=r(t.get),i.post=r(t.post),i.put=r(t.put),i.head=r(t.head),i},["get","put","post","head"].forEach((function(e){var n=e.toUpperCase();t[e.toLowerCase()]=function(e){"string"==typeof e?e={method:n,uri:e}:(e=JSON.parse(JSON.stringify(e))).method=n;var r=[e].concat(Array.prototype.slice.apply(arguments,[1]));return t.apply(this,r)}})),t.couch=function(e,n){return"string"==typeof e&&(e={uri:e}),e.json=!0,e.body&&(e.json=e.body),delete e.body,n=n||r,t(e,(function(e,t,r){if(e)return n(e,t,r);if((t.statusCode<200||t.statusCode>299)&&r.error){for(var i in e=new Error("CouchDB error: "+(r.error.reason||r.error.error)),r)e[i]=r[i];return n(e,t,r)}return n(e,t,r)}))},t},void 0===(r=n.apply(t,[]))||(e.exports=r)},6763:(e,t,n)=>{const r=n(5364);e.exports=r("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")},8075:(e,t,n)=>{"use strict";var r=n(453),i=n(487),s=i(r("String.prototype.indexOf"));e.exports=function(e,t){var n=r(e,!!t);return"function"==typeof n&&s(e,".prototype.")>-1?i(n):n}},487:(e,t,n)=>{"use strict";var r=n(6743),i=n(453),s=n(6897),o=n(9675),a=i("%Function.prototype.apply%"),c=i("%Function.prototype.call%"),l=i("%Reflect.apply%",!0)||r.call(c,a),u=n(655),d=i("%Math.max%");e.exports=function(e){if("function"!=typeof e)throw new o("a function is required");var t=l(r,c,arguments);return s(t,1+d(0,e.length-(arguments.length-1)),!0)};var h=function(){return l(r,a,arguments)};u?u(e.exports,"apply",{value:h}):e.exports.apply=h},8597:(e,t)=>{"use strict";var n=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,r=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,i=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,o=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function c(e){var t=String(e);if(i.test(t))return t;if(t.length>0&&!r.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(o,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}t.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,n=e.type;if(!n||!a.test(n))throw new TypeError("invalid type");var r=n;if(t&&"object"==typeof t)for(var s,o=Object.keys(t).sort(),l=0;l<o.length;l++){if(s=o[l],!i.test(s))throw new TypeError("invalid parameter name");r+="; "+s+"="+c(t[s])}return r},t.parse=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;if("function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]),"string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var r=t.indexOf(";"),i=-1!==r?t.slice(0,r).trim():t.trim();if(!a.test(i))throw new TypeError("invalid media type");var o=new l(i.toLowerCase());if(-1!==r){var c,u,d;for(n.lastIndex=r;u=n.exec(t);){if(u.index!==r)throw new TypeError("invalid parameter format");r+=u[0].length,c=u[1].toLowerCase(),34===(d=u[2]).charCodeAt(0)&&-1!==(d=d.slice(1,-1)).indexOf("\\")&&(d=d.replace(s,"$1")),o.parameters[c]=d}if(r!==t.length)throw new TypeError("invalid parameter format")}return o}},275:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var r=n(4991),i=n.n(r),s=n(6314),o=n.n(s)()(i());o.push([e.id,'button.btn-livechat {\n  position: fixed;\n  bottom: 55px;\n  right: 18px;\n  width: 60px;\n  height: 60px;\n  cursor: pointer;\n  background-color: transparent;\n  border: none;\n  padding: 0;\n  z-index: 100;\n}\nbutton.btn-livechat.btn-livechat-hide {\n  display: none !important;\n  user-select: none;\n}\nbutton.btn-livechat img {\n  display: block;\n  width: 100%;\n  height: auto;\n}\n#chatPopup {\n  position: fixed;\n  display: flex;\n  flex-direction: column;\n  top: 20%;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  color: #667085;\n  background-color: #fff;\n  z-index: 999;\n  visibility: hidden;\n  opacity: 0;\n  transition: all 0.3s ease-in-out;\n  font-size: 14px;\n  font-family: "SF Pro", sans-serif;\n  z-index: -999;\n}\n#chatPopup.chat-window-hide {\n  display: none !important;\n  user-select: none;\n}\n#chatPopup * {\n  font-family: "SF Pro", sans-serif;\n  box-sizing: border-box;\n}\n#chatPopup h2 {\n  color: #454B58;\n  font-size: 20px;\n  font-weight: 700;\n}\n#chatPopup p {\n  position: relative;\n  margin: 0;\n}\n#chatPopup img {\n  max-width: 100%;\n}\n#chatPopup.chat-hidden {\n  transition: all 0.3s ease-in-out;\n}\n#chatPopup.chat-visible {\n  top: 0;\n  visibility: visible;\n  opacity: 1;\n  transition: all 0.3s ease-in-out;\n  z-index: 999;\n}\n.chat-header {\n  position: relative;\n  display: flex;\n  align-items: center;\n  flex-wrap: nowrap;\n  width: 100%;\n  padding: 6px 0 5px;\n  border-bottom: 1px solid #CBCBCB;\n}\n.chat-header .btn-widget-back {\n  position: relative;\n  display: block;\n  border: none;\n  width: 45px;\n  height: 45px;\n  cursor: pointer;\n  background-color: transparent;\n  padding: 10px;\n}\n.chat-header .btn-widget-back img {\n  display: block;\n  width: 100%;\n  height: auto;\n}\n.chat-header .chatbot-user {\n  position: relative;\n  display: flex;\n  align-items: center;\n  flex-wrap: nowrap;\n  gap: 14px;\n}\n.chat-header .chatbot-user .chatbot-pic {\n  position: relative;\n  display: block;\n  width: 48px;\n  height: 48px;\n}\n.chat-header .chatbot-user .chatbot-pic:before {\n  content: \'\';\n  position: absolute;\n  display: block;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  z-index: 10;\n  border: 1px solid #E3E3E3;\n  border-radius: 100%;\n}\n.chat-header .chatbot-user .chatbot-pic img {\n  position: relative;\n  border-radius: 100%;\n  z-index: 0;\n}\n.chat-header .chatbot-user .chatbot-pic .chatbot-status {\n  position: absolute;\n  display: block;\n  width: 10.5px;\n  height: 10.5px;\n  background-color: #2ACA6F;\n  border-radius: 100%;\n  bottom: 8.5px;\n  right: 8.5px;\n  z-index: 20;\n  transform: translate(50%, 50%);\n}\n.chat-header .chatbot-user .chatbot-title {\n  position: relative;\n}\n.chat-header .chatbot-user .chatbot-title h2 {\n  margin: 0;\n}\n.chat-header .chatbot-user .chatbot-title h6 {\n  font-size: 14px;\n  font-weight: 400;\n  opacity: 0.8;\n  margin: 0;\n}\n.chat-header .endchat-btn {\n  position: relative;\n  font-size: 14px;\n  font-weight: 700;\n  margin-left: auto;\n  margin-right: 18.5px;\n  background-color: transparent;\n  color: #3769FF;\n  border: 1px solid #3769FF;\n  border-radius: 10px;\n  padding: 6px 10px;\n}\n.chat-header .endchat-btn:hover,\n.chat-header .endchat-btn:active {\n  background-color: #3769FF;\n  color: #fff;\n}\n.chat-area {\n  position: relative;\n  background-color: #F6F6F7;\n  height: -webkit-fill-available;\n  flex-grow: 1;\n  overflow: hidden;\n}\n.chat-area .chat-message {\n  position: relative;\n  display: block;\n  height: 100%;\n  padding: 10px;\n  overflow-y: scroll;\n}\n.chat-area .chat-message .chat-user {\n  position: relative;\n  display: flex;\n  align-items: center;\n  gap: 7px;\n}\n.chat-area .chat-message .chat-user.user-incoming {\n  justify-content: flex-start;\n}\n.chat-area .chat-message .chat-user.user-incoming .chat-user-pic {\n  position: relative;\n  display: block;\n  width: 28px;\n  height: 28px;\n  border-radius: 100%;\n  background-color: #fff;\n  z-index: 0;\n}\n.chat-area .chat-message .chat-user.user-incoming .chat-user-pic:before {\n  content: \'\';\n  position: absolute;\n  display: block;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  z-index: 10;\n  border: 1px solid #E3E3E3;\n  border-radius: 100%;\n}\n.chat-area .chat-message .chat-user.user-incoming .chat-user-pic img {\n  position: relative;\n}\n.chat-area .chat-message .chat-user.user-outgoing {\n  justify-content: flex-end;\n}\n.chat-area .chat-message .chat-user .chat-user-name {\n  position: relative;\n  font-size: 12px;\n  line-height: 28px;\n}\n.chat-area .chat-message .chat-user .chat-user-name .chat-time {\n  position: relative;\n  text-transform: uppercase;\n}\n.chat-area .chat-message .chat-bubble {\n  position: relative;\n  display: block;\n  margin: 0 35px 20px;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-text {\n  position: relative;\n  display: block;\n  font-size: 14px;\n  font-weight: 400;\n  line-height: 1.6;\n  border-radius: 10px;\n  width: fit-content;\n  word-break: break-word;\n  padding: 6px 10px;\n  border: 1px solid #E3E3E3;\n  background-color: #fff;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-text:not(:last-child) {\n  margin-bottom: 8px;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-text p {\n  white-space: pre-line;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-text p {\n  white-space: pre-line;\n}\n.chat-area .chat-message .chat-bubble .bubble-read-receipt {\n  display: block;\n  text-align: right;\n  font-size: 12px;\n  overflow: hidden;\n  height: 14.5px;\n  transform: scaleY(1);\n  transition: all 0.3s ease;\n}\n.chat-area .chat-message .chat-bubble .bubble-read-receipt.hide {\n  height: 0;\n  transform: scaleY(1);\n  transition: all 0.3s ease;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-image {\n  position: relative;\n  display: block;\n  border-radius: 10px;\n  width: fit-content;\n  border: 1px solid #E3E3E3;\n  padding: 6px;\n  background-color: #ffffff;\n  margin-left: auto;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-image img {\n  max-width: 60vw !important;\n  border-radius: 6px;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-video {\n  display: block;\n  margin-left: auto;\n  max-width: 90%;\n  overflow: hidden;\n  border-radius: 10px;\n}\n.chat-area .chat-message .chat-bubble .chat-bubble-video video {\n  position: relative;\n  display: block;\n  width: 100%;\n  height: auto;\n  max-height: 250px;\n  border-radius: 10px;\n  background: #000;\n}\n.chat-area .chat-message .chat-bubble.bubble-incoming {\n  position: relative;\n  overflow-y: visible;\n  margin: 0;\n  padding: 0 55px 8px 35px;\n}\n.chat-area .chat-message .chat-bubble.bubble-incoming .chat-bubble-text {\n  margin-right: auto;\n}\n.chat-area .chat-message .chat-bubble.bubble-incoming + .chat-user.user-incoming {\n  display: none;\n}\n.chat-area .chat-message .chat-bubble.bubble-incoming + .bubble-incoming {\n  padding: 0 35px 8px;\n  margin: 0 -5px 0;\n}\n.chat-area .chat-message .chat-bubble.bubble-outgoing {\n  position: relative;\n  margin: 0 0 8px 35px;\n}\n.chat-area .chat-message .chat-bubble.bubble-outgoing .chat-bubble-text {\n  color: #fff;\n  padding: 6px 20px;\n  border: 1px solid #3769FF;\n  background-color: #3769FF;\n  margin-left: auto;\n}\n.chat-area .chat-message .chat-bubble.bubble-outgoing + .chat-user.user-outgoing {\n  display: none;\n}\n.chat-area .chat-message .chat-bubble.bubble-outgoing + .chat-user.user-incoming {\n  margin-top: 20px;\n}\n.chat-area .chat-message .chat-bubble.chat-loading span {\n  content: "";\n  animation: blink 1s infinite;\n  animation-fill-mode: both;\n  height: 10px;\n  width: 10px;\n  background: #D8E1FF;\n  position: absolute;\n  left: 0;\n  top: 0;\n  border-radius: 50%;\n}\n.chat-area .chat-message .chat-bubble.chat-loading span:nth-child(2) {\n  animation-delay: 0.2s;\n  margin-left: 15px;\n}\n.chat-area .chat-message .chat-bubble.chat-loading span:nth-child(3) {\n  animation-delay: 0.4s;\n  margin-left: 30px;\n}\n.chat-area .chat-message .chat-history {\n  position: relative;\n  display: block;\n  height: 1px;\n  background-color: #E3E3E3;\n  margin-top: 15px;\n  margin-bottom: 15px;\n}\n.chat-area .chat-message .chat-history:first-child {\n  display: none;\n}\n.chat-area .chat-attachment {\n  position: absolute;\n  display: flex;\n  align-items: center;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n  background-color: #F6F6F7;\n  padding: 35px;\n  visibility: hidden;\n}\n.chat-area .chat-attachment.active {\n  position: absolute;\n  visibility: visible;\n}\n.chat-area .chat-attachment .attachment-wrap {\n  position: relative;\n  display: block;\n  background-color: #D8E1FF;\n  padding: 10px;\n  width: 100%;\n  border-radius: 15px;\n}\n.chat-area .chat-attachment .attachment-wrap.inserted {\n  position: relative;\n}\n.chat-area .chat-attachment .attachment-wrap.inserted .file-icon,\n.chat-area .chat-attachment .attachment-wrap.inserted h5 {\n  display: none;\n}\n.chat-area .chat-attachment .attachment-btn {\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 100%;\n  min-height: 376px;\n  border: 1px dashed #667085;\n  border-radius: 15px;\n  padding: 10px;\n  cursor: pointer;\n}\n.chat-area .chat-attachment .attachment-btn input {\n  position: relative;\n}\n.chat-area .chat-attachment .file-upload {\n  position: relative;\n  text-align: center;\n  background: unset;\n}\n.chat-area .chat-attachment .file-upload h5 {\n  font-size: 16px;\n  font-weight: 500;\n  margin-bottom: 15px;\n}\n.chat-area .chat-attachment .file-upload p {\n  font-size: 12px;\n  color: rgba(102, 112, 133, 0.5);\n}\n.chat-area .chat-attachment .file-upload .file-preview,\n.chat-area .chat-attachment .file-upload .file-icon {\n  position: relative;\n}\n.chat-area .chat-attachment .file-upload .file-preview:not(:empty),\n.chat-area .chat-attachment .file-upload .file-icon:not(:empty) {\n  margin-bottom: 30px;\n}\n.chat-area .chat-attachment .file-upload .file-preview img,\n.chat-area .chat-attachment .file-upload .file-icon img {\n  display: block;\n  margin: 0 auto;\n  max-width: 80px;\n  max-height: 80px;\n  width: auto;\n  height: auto;\n}\n.chat-area .chat-attachment .file-upload .file-preview p,\n.chat-area .chat-attachment .file-upload .file-icon p {\n  position: relative;\n}\n.chat-input-wrap {\n  position: relative;\n  border-top: 1px solid #CBCBCB;\n}\n.chat-input-wrap .chat-input {\n  position: relative;\n  display: flex;\n  align-items: center;\n}\n.chat-input-wrap .chat-input textarea {\n  position: relative;\n  display: block;\n  margin: 0;\n  padding: 8px 20px 8px 20px;\n  color: #667085;\n  font-size: 16px;\n  flex-grow: 1;\n  border: none;\n  height: 60px;\n  align-content: center;\n  box-sizing: border-box;\n}\n.chat-input-wrap .chat-input textarea:focus,\n.chat-input-wrap .chat-input textarea:focus-visible {\n  outline: none;\n}\n.chat-input-wrap .chat-input textarea[disabled],\n.chat-input-wrap .chat-input textarea[disabled]::placeholder {\n  background-color: transparent;\n  color: transparent;\n}\n.chat-input-wrap .chat-tool {\n  position: relative;\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding-right: 20px;\n}\n.chat-input-wrap .chat-tool button {\n  position: relative;\n  display: block;\n  background-color: transparent;\n  border: none;\n  box-sizing: border-box;\n  padding: 0;\n  width: 24px;\n  height: 24px;\n  cursor: pointer;\n  pointer-events: auto;\n}\n.chat-input-wrap .chat-tool button img {\n  vertical-align: middle;\n}\n.chat-input-wrap .chat-tool button.emoji-btn:after,\n.chat-input-wrap .chat-tool button.send-btn:after,\n.chat-input-wrap .chat-tool button.liveagent-btn:after {\n  content: \'\';\n  position: absolute;\n  display: block;\n  width: 100%;\n  height: 100%;\n  left: 0;\n  top: 0;\n  mask-size: contain;\n  mask-repeat: no-repeat;\n  mask-position: center;\n  background-color: #667085;\n}\n.chat-input-wrap .chat-tool button.emoji-btn.active:after,\n.chat-input-wrap .chat-tool button.send-btn.active:after,\n.chat-input-wrap .chat-tool button.liveagent-btn.active:after {\n  background-color: #3769FF;\n}\n#chatPopup[data-env="3"] .chat-input-wrap .chat-tool button.emoji-btn:after,\n#chatPopup[data-env="4"] .chat-input-wrap .chat-tool button.emoji-btn:after {\n  mask-image: url("https://cp-images.client88.me/images/cp/images/ailivechat/icon-emoji.svg");\n}\n#chatPopup[data-env="2"] .chat-input-wrap .chat-tool button.emoji-btn:after {\n  mask-image: url("https://cp-images.client99.me/images/cp/images/ailivechat/icon-emoji.svg");\n}\n#chatPopup[data-env="1"] .chat-input-wrap .chat-tool button.emoji-btn:after {\n  mask-image: url("https://cp-images.casinoplus.live/images/cp/images/ailivechat/icon-emoji.svg");\n}\n#chatPopup[data-env="3"] .chat-input-wrap .chat-tool button.liveagent-btn:after,\n#chatPopup[data-env="4"] .chat-input-wrap .chat-tool button.liveagent-btn:after {\n  mask-image: url("https://cp-images.client88.me/images/cp/images/ailivechat/icon-liveagent.svg");\n}\n#chatPopup[data-env="2"] .chat-input-wrap .chat-tool button.liveagent-btn:after {\n  mask-image: url("https://cp-images.client99.me/images/cp/images/ailivechat/icon-liveagent.svg");\n}\n#chatPopup[data-env="1"] .chat-input-wrap .chat-tool button.liveagent-btn:after {\n  mask-image: url("https://cp-images.casinoplus.live/images/cp/images/ailivechat/icon-liveagent.svg");\n}\n.chat-input-wrap .chat-tool button.liveagent-btn:not(.disabled):active:after {\n  background-color: #1c55ff;\n}\n.chat-input-wrap .chat-tool button.liveagent-btn.disabled:active:after {\n  background-color: #7f889b;\n}\n.chat-input-wrap .chat-tool button.attachment-btn.active:after {\n  content: \'\';\n  position: absolute;\n  display: block;\n  width: 100%;\n  height: 100%;\n  left: 0;\n  top: 0;\n  mask-size: contain;\n  mask-repeat: no-repeat;\n  mask-position: center;\n  background-color: #3769FF;\n}\n#chatPopup[data-env="3"] .chat-input-wrap .chat-tool button.attachment-btn.active:after,\n#chatPopup[data-env="4"] .chat-input-wrap .chat-tool button.attachment-btn.active:after {\n  mask-image: url("https://cp-images.client88.me/images/cp/images/ailivechat/icon-bubble.svg");\n}\n#chatPopup[data-env="2"] .chat-input-wrap .chat-tool button.attachment-btn.active:after {\n  mask-image: url("https://cp-images.client99.me/images/cp/images/ailivechat/icon-bubble.svg");\n}\n#chatPopup[data-env="1"] .chat-input-wrap .chat-tool button.attachment-btn.active:after {\n  mask-image: url("https://cp-images.casinoplus.live/images/cp/images/ailivechat/icon-bubble.svg");\n}\n.chat-input-wrap .chat-tool button.attachment-btn.hide {\n  display: none;\n}\n.chat-input-wrap .chat-tool button.attachment-btn:not(.active) img:nth-child(2) {\n  display: none;\n}\n.chat-input-wrap .chat-tool button.attachment-btn.active img:nth-child(1) {\n  display: none;\n}\n#chatPopup[data-env="3"] .chat-input-wrap .chat-tool button.send-btn:after,\n#chatPopup[data-env="4"] .chat-input-wrap .chat-tool button.send-btn:after {\n  mask-image: url("https://cp-images.client88.me/images/cp/images/ailivechat/icon-send.svg");\n}\n#chatPopup[data-env="2"] .chat-input-wrap .chat-tool button.send-btn:after {\n  mask-image: url("https://cp-images.client99.me/images/cp/images/ailivechat/icon-send.svg");\n}\n#chatPopup[data-env="1"] .chat-input-wrap .chat-tool button.send-btn:after {\n  mask-image: url("https://cp-images.casinoplus.live/images/cp/images/ailivechat/icon-send.svg");\n}\n.chat-input-wrap .chat-tool button.send-btn.active:active:after {\n  background-color: #1c55ff;\n}\n.chat-input-wrap .chat-tool button.send-btn:not(.active):active:after {\n  background-color: #7f889b;\n}\n.chat-input-wrap .emoji-popup {\n  position: absolute;\n  visibility: hidden;\n  opacity: 0;\n  bottom: calc(100% - 13px);\n  right: 86px;\n  margin-right: -95px;\n}\n.chat-input-wrap .emoji-popup:before {\n  content: \'\';\n  position: absolute;\n  z-index: 1;\n  width: 0;\n  height: 0;\n  border: 14px solid;\n  border-color: #fff transparent transparent transparent;\n  right: 81px;\n  bottom: 2px;\n}\n@media (max-width: 315px) {\n  .chat-input-wrap .emoji-popup:before {\n    right: 114px;\n  }\n}\n.chat-input-wrap .emoji-popup:after {\n  content: \'\';\n  display: block;\n  width: 0;\n  height: 0;\n  border: 15px solid;\n  border-color: #E3E3E3 transparent transparent transparent;\n  filter: drop-shadow(1px 1px 4px rgba(0, 0, 0, 0.1));\n  margin-left: auto;\n  margin-right: 79.5px;\n}\n@media (max-width: 315px) {\n  .chat-input-wrap .emoji-popup:after {\n    margin-right: 112.5px;\n  }\n}\n.chat-input-wrap .emoji-popup.active {\n  visibility: visible;\n  opacity: 1;\n}\n.chat-input-wrap .emoji-popup.active.attachment-hidden {\n  margin-right: -61px;\n}\n.chat-input-wrap .emoji-popup.active.attachment-hidden:before {\n  right: 47px;\n}\n@media (max-width: 315px) {\n  .chat-input-wrap .emoji-popup.active.attachment-hidden:before {\n    right: 80px;\n  }\n}\n.chat-input-wrap .emoji-popup.active.attachment-hidden:after {\n  margin-right: 45.5px;\n}\n@media (max-width: 315px) {\n  .chat-input-wrap .emoji-popup.active.attachment-hidden:after {\n    margin-right: 78.5px;\n  }\n}\n.chat-input-wrap .emoji-popup .emoji-list {\n  position: relative;\n  border: 1px solid #E3E3E3;\n  box-shadow: 1px 1px 4px 0px rgba(0, 0, 0, 0.1);\n  border-radius: 10px;\n  background-color: #fff;\n  justify-content: space-between;\n  padding: 14px 20px;\n}\n.chat-input-wrap .emoji-popup .emoji-list .emoji-row {\n  position: relative;\n  display: flex;\n  gap: 8px;\n}\n.chat-input-wrap .emoji-popup .emoji-list .emoji {\n  font-size: 30px;\n  text-align: center;\n  cursor: pointer;\n}\n.chat-rate-review {\n  position: absolute;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  z-index: 100;\n  background-color: #00000099;\n  padding: 20px;\n  visibility: hidden;\n  opacity: 0;\n}\n.chat-rate-review.rate-review-visible {\n  visibility: visible;\n  opacity: 1;\n  transition: all 0.3s ease-in-out;\n  z-index: 1000;\n}\n.chat-rate-review .rate-review-wrap {\n  position: relative;\n  display: block;\n  width: 100%;\n  border-radius: 8px;\n  background-color: #fff;\n  padding: 20px;\n  width: 750px;\n}\n.chat-rate-review .rate-review-close {\n  position: absolute;\n  display: block;\n  top: 15px;\n  right: 15px;\n  z-index: 100;\n}\n.chat-rate-review .rate-review-close img {\n  position: relative;\n}\n.chat-rate-review .rate-review-content {\n  position: relative;\n}\n.chat-rate-review .rate-review-content h2 {\n  color: #454B58;\n  font-size: 20px;\n  font-weight: 700;\n  text-align: center;\n  margin-bottom: 16px;\n}\n.chat-rate-review .rate-review-content h6 {\n  font-size: 14px;\n  font-weight: 400;\n  text-align: center;\n  margin-bottom: 30px;\n}\n.chat-rate-review .rate-review-content .rate {\n  position: relative;\n  display: flex;\n  flex-direction: row-reverse;\n  gap: 7px;\n  justify-content: center;\n  margin-bottom: 10px;\n}\n.chat-rate-review .rate-review-content .rate input {\n  position: relative;\n  appearance: none;\n}\n.chat-rate-review .rate-review-content .rate label {\n  position: relative;\n  display: block;\n  font-size: 0;\n  width: 31px;\n  height: 31px;\n  background-size: cover;\n  background-repeat: no-repeat;\n  background-position: center;\n}\n#chatPopup[data-env="3"] .chat-rate-review .rate-review-content .rate label,\n#chatPopup[data-env="4"] .chat-rate-review .rate-review-content .rate label {\n  background-image: url("https://cp-images.client88.me/images/cp/images/ailivechat/icon-star.svg");\n}\n#chatPopup[data-env="2"] .chat-rate-review .rate-review-content .rate label {\n  background-image: url("https://cp-images.client99.me/images/cp/images/ailivechat/icon-star.svg");\n}\n#chatPopup[data-env="1"] .chat-rate-review .rate-review-content .rate label {\n  background-image: url("https://cp-images.casinoplus.live/images/cp/images/ailivechat/icon-star.svg");\n}\n.chat-rate-review .rate-review-content .rate label:before {\n  content: \'\';\n}\n.chat-rate-review .rate-review-content .rate:not(:checked) {\n  position: relative;\n}\n.chat-rate-review .rate-review-content .rate:not(:checked) input {\n  position: relative;\n}\n.chat-rate-review .rate-review-content .rate:not(:checked) input:checked ~ label {\n  filter: unset;\n}\n.chat-rate-review .rate-review-content .rate:not(:checked) input:checked + label:hover,\n.chat-rate-review .rate-review-content .rate:not(:checked) input:checked + label:hover ~ label,\n.chat-rate-review .rate-review-content .rate:not(:checked) input:checked ~ label:hover,\n.chat-rate-review .rate-review-content .rate:not(:checked) input:checked ~ label:hover ~ label {\n  filter: brightness(1);\n}\n.chat-rate-review .rate-review-content .rate:not(:checked) label {\n  position: relative;\n  display: block;\n  filter: grayscale(1) brightness(1.02);\n}\n.chat-rate-review .rate-review-content .rate:not(:checked) label:hover,\n.chat-rate-review .rate-review-content .rate:not(:checked) label:hover ~ label {\n  filter: brightness(0.95);\n}\n.chat-rate-review .rate-review-content .rate:not(:checked) label:hover ~ input:checked ~ label {\n  filter: brightness(0.85);\n}\n.chat-rate-review .rate-review-content .review {\n  position: relative;\n}\n.chat-rate-review .rate-review-content .review textarea {\n  position: relative;\n  display: block;\n  width: 100%;\n  padding: 15px 10px;\n  border: none;\n  background-color: #F8F8F8;\n}\n.chat-rate-review .rate-review-content .review textarea::placeholder {\n  color: #B3B3B3;\n}\n.chat-rate-review .rate-review-content .error-message {\n  display: none;\n  color: red;\n  font-size: 12px;\n  margin-top: 5px;\n}\n.chat-rate-review .rate-review-content .rate-review-btn {\n  position: relative;\n  display: flex;\n  gap: 13px;\n  margin-top: 20px;\n}\n.chat-rate-review .rate-review-content .rate-review-btn .btn-ratereview {\n  position: relative;\n  font-size: 12px;\n  font-weight: 700;\n  text-align: center;\n  padding: 13px;\n  border-radius: 8px;\n  color: #fff;\n  width: 100%;\n}\n.chat-rate-review .rate-review-content .rate-review-btn .btn-ratereview#rateCancel {\n  position: relative;\n  background-color: #98A4BD;\n}\n.chat-rate-review .rate-review-content .rate-review-btn .btn-ratereview#rateSubmit {\n  position: relative;\n  background-color: #3769FF;\n}\n.chat-error {\n  position: absolute;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  z-index: 100;\n  background-color: #00000099;\n  padding: 20px;\n  visibility: hidden;\n  opacity: 0;\n}\n.chat-error.chat-error-visible {\n  visibility: visible;\n  opacity: 1;\n  transition: all 0.3s ease-in-out;\n  z-index: 1000;\n}\n.chat-error .error-wrap {\n  position: relative;\n  display: block;\n  width: 100%;\n  border-radius: 8px;\n  background-color: #fff;\n  padding: 20px;\n  width: 750px;\n}\n.chat-error .error-content {\n  position: relative;\n}\n.chat-error .error-content h2 {\n  color: #454B58;\n  font-size: 20px;\n  font-weight: 700;\n  text-align: center;\n  margin-bottom: 16px;\n}\n.chat-error .error-content p {\n  font-size: 14px;\n  font-weight: 400;\n  text-align: center;\n  margin-bottom: 30px;\n}\n.chat-error .error-content .error-btn {\n  position: relative;\n  display: flex;\n  gap: 13px;\n  margin-top: 20px;\n}\n.chat-error .error-content .error-btn .btn-error {\n  position: relative;\n  font-size: 12px;\n  font-weight: 700;\n  text-align: center;\n  padding: 13px;\n  border-radius: 8px;\n  color: #fff;\n  max-width: 140px;\n  width: 100%;\n  background-color: #3769FF;\n  margin-left: auto;\n  margin-right: auto;\n}\n@keyframes blink {\n  0% {\n    opacity: 0.1;\n  }\n  20% {\n    opacity: 1;\n  }\n  100% {\n    opacity: 0.1;\n  }\n}\n',"",{version:3,sources:["webpack://./src/styles/widget.less","webpack://./src/styles/variable.less"],names:[],mappings:"AAEA;EACI,eAAA;EACA,YAAA;EACA,WAAA;EACA,WAAA;EACA,YAAA;EACA,eAAA;EACA,6BAAA;EACA,YAAA;EACA,UAAA;EACA,YAAA;AADJ;AAGI;EACI,wBAAA;EACA,iBAAA;AADR;AAbA;EAkBQ,cAAA;EACA,WAAA;EACA,YAAA;AAFR;AAMA;EACI,eAAA;EACA,aAAA;EACA,sBAAA;EACA,QAAA;EACA,OAAA;EACA,WAAA;EACA,YAAA;EACA,cAAA;EACA,sBAAA;EACA,YAAA;EACA,kBAAA;EACA,UAAA;EACA,gCAAA;EACA,eAAA;EACA,iCAAA;EACA,aAAA;AAJJ;AAMI;EACI,wBAAA;EACA,iBAAA;AAJR;AAhBA;EAwBQ,iCAAA;EACA,sBAAA;AALR;AApBA;EA6BQ,cAAA;EACA,eAAA;EACA,gBAAA;AANR;AAzBA;EAmCQ,kBAAA;EACA,SAAA;AAPR;AA7BA;EAwCQ,eAAA;AARR;AAcI;EACI,gCAAA;AAZR;AAeI;EACI,MAAA;EACA,mBAAA;EACA,UAAA;EACA,gCAAA;EACA,YAAA;AAbR;AAqBA;EACI,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,iBAAA;EACA,WAAA;EACA,kBAAA;EACA,gCAAA;AAnBJ;AAYA;EAUQ,kBAAA;EACA,cAAA;EACA,YAAA;EACA,WAAA;EACA,YAAA;EACA,eAAA;EACA,6BAAA;EACA,aAAA;AAnBR;AAEA;EAoBY,cAAA;EACA,WAAA;EACA,YAAA;AAnBZ;AAHA;EA2BQ,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,iBAAA;EACA,SAAA;AArBR;AAVA;EAkCY,kBAAA;EACA,cAAA;EACA,WAAA;EACA,YAAA;AArBZ;AAuBY;EACI,WAAA;EACA,kBAAA;EACA,cAAA;EACA,MAAA;EACA,QAAA;EACA,SAAA;EACA,OAAA;EACA,WAAA;EACA,yBAAA;EACA,mBAAA;AArBhB;AA5BA;EAqDgB,kBAAA;EACA,mBAAA;EACA,UAAA;AAtBhB;AAjCA;EA2DgB,kBAAA;EACA,cAAA;EACA,aAAA;EACA,cAAA;EACA,yBAAA;EACA,mBAAA;EACA,aAAA;EACA,YAAA;EACA,WAAA;EACA,8BAAA;AAvBhB;AA7CA;EAyEY,kBAAA;AAzBZ;AAhDA;EA4EgB,SAAA;AAzBhB;AAnDA;EAiFgB,eAAA;EACA,gBAAA;EACA,YAAA;EACA,SAAA;AA3BhB;AAzDA;EAiGQ,kBAAA;EACA,eAAA;EACA,gBAAA;EACA,iBAAA;EACA,oBAAA;EACA,6BAAA;EACA,cAAA;EACA,yBAAA;EACA,mBAAA;EACA,iBAAA;AArCR;AAsBQ;;EAEI,yBAAA;EACA,WAAA;AApBZ;AAoCA;EACI,kBAAA;EACA,yBAAA;EACA,8BAAA;EACA,YAAA;EACA,gBAAA;AAlCJ;AA6BA;EAQQ,kBAAA;EACA,cAAA;EACA,YAAA;EACA,aAAA;EACA,kBAAA;AAlCR;AAsBA;EAeY,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,QAAA;AAlCZ;AAoCY;EACI,2BAAA;AAlChB;AAiCY;EAIQ,kBAAA;EACA,cAAA;EACA,WAAA;EACA,YAAA;EACA,mBAAA;EACA,sBAAA;EACA,UAAA;AAlCpB;AAoCoB;EACI,WAAA;EACA,kBAAA;EACA,cAAA;EACA,MAAA;EACA,QAAA;EACA,SAAA;EACA,OAAA;EACA,WAAA;EACA,yBAAA;EACA,mBAAA;AAlCxB;AAYY;EA0BY,kBAAA;AAnCxB;AAwCY;EACI,yBAAA;AAtChB;AAdA;EAwDgB,kBAAA;EACA,eAAA;EACA,iBAAA;AAvChB;AAnBA;EA6DoB,kBAAA;EACA,yBAAA;AAvCpB;AAvBA;EAoEY,kBAAA;EACA,cAAA;EACA,mBAAA;AA1CZ;AA5BA;EAyEgB,kBAAA;EACA,cAAA;EAEA,eAAA;EACA,gBAAA;EACA,gBAAA;EACA,mBAAA;EACA,kBAAA;EACA,sBAAA;EACA,iBAAA;EACA,yBAAA;EACA,sBAAA;AA3ChB;AA6CgB;EACI,kBAAA;AA3CpB;AA5CA;EA2FoB,qBAAA;AA5CpB;AA/CA;EA+FoB,qBAAA;AA7CpB;AAlDA;EAoGgB,cAAA;EACA,iBAAA;EACA,eAAA;EACA,gBAAA;EACA,cAAA;EACA,oBAAA;EACA,yBAAA;AA/ChB;AAiDgB;EACI,SAAA;EACA,oBAAA;EACA,yBAAA;AA/CpB;AAhEA;EAoHgB,kBAAA;EACA,cAAA;EACA,mBAAA;EACA,kBAAA;EACA,yBAAA;EACA,YAAA;EACA,yBAAA;EACA,iBAAA;AAjDhB;AA1EA;EA8HoB,0BAAA;EACA,kBAAA;AAjDpB;AA9EA;EAoIgB,cAAA;EACA,iBAAA;EACA,cAAA;EACA,gBAAA;EACA,mBAAA;AAnDhB;AArFA;EA2IoB,kBAAA;EACA,cAAA;EACA,WAAA;EACA,YAAA;EACA,iBAAA;EACA,mBAAA;EACA,gBAAA;AAnDpB;AAuDY;EACI,kBAAA;EACA,mBAAA;EAEA,SAAA;EAIA,wBAAA;AAzDhB;AAiDY;EAWQ,kBAAA;AAzDpB;AA8CY;EAeQ,aAAA;AA1DpB;AA2CY;EAqBQ,mBAAA;EACA,gBAAA;AA7DpB;AAiEY;EACI,kBAAA;EACA,oBAAA;AA/DhB;AA6DY;EAKQ,WAAA;EACA,iBAAA;EACA,yBAAA;EACA,yBAAA;EACA,iBAAA;AA/DpB;AAsDY;EAaQ,aAAA;AAhEpB;AAmDY;EAiBQ,gBAAA;AAjEpB;AAqEY;EAEQ,WAAA;EACA,4BAAA;EACA,yBAAA;EACA,YAAA;EACA,WAAA;EACA,mBAAA;EACA,kBAAA;EACA,OAAA;EACA,MAAA;EACA,kBAAA;AApEpB;AAsEoB;EACI,qBAAA;EACA,iBAAA;AApExB;AAuEoB;EACI,qBAAA;EACA,iBAAA;AArExB;AAnJA;EA+NY,kBAAA;EACA,cAAA;EACA,WAAA;EACA,yBAAA;EACA,gBAAA;EACA,mBAAA;AAzEZ;AA2EY;EACI,aAAA;AAzEhB;AA9JA;EA6OQ,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,OAAA;EACA,MAAA;EACA,WAAA;EACA,YAAA;EACA,yBAAA;EACA,aAAA;EACA,kBAAA;AA5ER;AA8EQ;EACI,kBAAA;EACA,mBAAA;AA5EZ;AA9KA;EA8PY,kBAAA;EACA,cAAA;EACA,yBAAA;EACA,aAAA;EACA,WAAA;EACA,mBAAA;AA7EZ;AA+EY;EACI,kBAAA;AA7EhB;AA4EY;;EAKQ,aAAA;AA7EpB;AA7LA;EAgRY,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,uBAAA;EACA,WAAA;EACA,iBAAA;EACA,0BAAA;EACA,mBAAA;EACA,aAAA;EACA,eAAA;AAhFZ;AAzMA;EA4RgB,kBAAA;AAhFhB;AA5MA;EAiSY,kBAAA;EACA,kBAAA;EACA,iBAAA;AAlFZ;AAjNA;EAsSgB,eAAA;EACA,gBAAA;EACA,mBAAA;AAlFhB;AAtNA;EA4SgB,eAAA;EACA,+BAAA;AAnFhB;AA1NA;;EAkTgB,kBAAA;AApFhB;AAsFgB;;EACI,mBAAA;AAnFpB;AAlOA;;EAyToB,cAAA;EACA,cAAA;EACA,eAAA;EACA,gBAAA;EACA,WAAA;EACA,YAAA;AAnFpB;AA3OA;;EAkUoB,kBAAA;AAnFpB;AA0FA;EACI,kBAAA;EACA,6BAAA;AAxFJ;AAsFA;EAKQ,kBAAA;EACA,aAAA;EACA,mBAAA;AAxFR;AAiFA;EAUY,kBAAA;EACA,cAAA;EACA,SAAA;EACA,0BAAA;EACA,cAAA;EACA,eAAA;EACA,YAAA;EACA,YAAA;EACA,YAAA;EACA,qBAAA;EACA,sBAAA;AAxFZ;AA0FY;;EAEI,aAAA;AAxFhB;AA2FY;;EAEI,6BAAA;EACA,kBAAA;AAzFhB;AA2DA;EAoCQ,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,SAAA;EACA,mBAAA;AA5FR;AAoDA;EA2CY,kBAAA;EACA,cAAA;EACA,6BAAA;EACA,YAAA;EACA,sBAAA;EACA,UAAA;EACA,WAAA;EACA,YAAA;EACA,eAAA;EACA,oBAAA;AA5FZ;AAwCA;EAuDgB,sBAAA;AA5FhB;AAkGgB;;;EACI,WAAA;EACA,kBAAA;EACA,cAAA;EACA,WAAA;EACA,YAAA;EACA,OAAA;EACA,MAAA;EACA,kBAAA;EACA,sBAAA;EACA,qBAAA;EACA,yBAAA;AA9FpB;AAiGgB;;;EACI,yBAAA;AA7FpB;AC/eI;;EAEI,2FAAA;ADifR;AC9eI;EACI,2FAAA;ADgfR;AC7eI;EACI,+FAAA;AD+eR;ACzfI;;EAEI,+FAAA;AD2fR;ACxfI;EACI,+FAAA;AD0fR;ACvfI;EACI,mGAAA;ADyfR;AAsFgB;EACI,yBAAA;AApFpB;AAuFgB;EACI,yBAAA;AArFpB;AA0FgB;EACI,WAAA;EACA,kBAAA;EACA,cAAA;EACA,WAAA;EACA,YAAA;EACA,OAAA;EACA,MAAA;EACA,kBAAA;EACA,sBAAA;EACA,qBAAA;EACA,yBAAA;AAxFpB;ACthBI;;EAEI,4FAAA;ADwhBR;ACrhBI;EACI,4FAAA;ADuhBR;ACphBI;EACI,gGAAA;ADshBR;AAkFgB;EACI,aAAA;AAhFpB;AAoFY;EACI,aAAA;AAlFhB;AAqFY;EACI,aAAA;AAnFhB;ACziBI;;EAEI,0FAAA;AD2iBR;ACxiBI;EACI,0FAAA;AD0iBR;ACviBI;EACI,8FAAA;ADyiBR;AAiFgB;EACI,yBAAA;AA/EpB;AAkFgB;EACI,yBAAA;AAhFpB;AAzDA;EA0JQ,kBAAA;EACA,kBAAA;EACA,UAAA;EACA,yBAAA;EACA,WAAA;EACA,mBAAA;AA9FR;AAgGQ;EACI,WAAA;EACA,kBAAA;EACA,UAAA;EACA,QAAA;EACA,SAAA;EACA,kBAAA;EACA,sDAAA;EACA,WAAA;EACA,WAAA;AA9FZ;AAgGY;EAAA;IACI,YAAA;EA7Fd;AACF;AAgGQ;EACI,WAAA;EACA,cAAA;EACA,QAAA;EACA,SAAA;EACA,kBAAA;EACA,yDAAA;EACA,mDAAA;EACA,iBAAA;EACA,oBAAA;AA9FZ;AAgGY;EAAA;IACI,qBAAA;EA7Fd;AACF;AAgGQ;EACI,mBAAA;EACA,UAAA;AA9FZ;AAgGY;EACI,mBAAA;AA9FhB;AAgGgB;EACI,WAAA;AA9FpB;AAgGoB;EAAA;IACI,WAAA;EA7FtB;AACF;AAgGgB;EACI,oBAAA;AA9FpB;AAgGoB;EAAA;IACI,oBAAA;EA7FtB;AACF;AAxHA;EA2NY,kBAAA;EACA,yBAAA;EACA,8CAAA;EACA,mBAAA;EACA,sBAAA;EACA,8BAAA;EACA,kBAAA;AAhGZ;AAjIA;EAoOgB,kBAAA;EACA,aAAA;EACA,QAAA;AAhGhB;AAtIA;EA0OgB,eAAA;EACA,kBAAA;EACA,eAAA;AAjGhB;AAuGA;EACI,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,uBAAA;EACA,MAAA;EACA,OAAA;EACA,WAAA;EACA,YAAA;EACA,YAAA;EACA,2BAAA;EACA,aAAA;EACA,kBAAA;EACA,UAAA;AArGJ;AAuGI;EACI,mBAAA;EACA,UAAA;EACA,gCAAA;EACA,aAAA;AArGR;AAkFA;EAuBQ,kBAAA;EACA,cAAA;EACA,WAAA;EACA,kBAAA;EACA,sBAAA;EACA,aAAA;EACA,YAAA;AAtGR;AAyEA;EAiCQ,kBAAA;EACA,cAAA;EACA,SAAA;EACA,WAAA;EACA,YAAA;AAvGR;AAkEA;EAwCY,kBAAA;AAvGZ;AA+DA;EA6CQ,kBAAA;AAzGR;AA4DA;EAgDY,cAAA;EACA,eAAA;EACA,gBAAA;EACA,kBAAA;EACA,mBAAA;AAzGZ;AAqDA;EAwDY,eAAA;EACA,gBAAA;EACA,kBAAA;EACA,mBAAA;AA1GZ;AA+CA;EA+DY,kBAAA;EACA,aAAA;EACA,2BAAA;EACA,QAAA;EACA,uBAAA;EACA,mBAAA;AA3GZ;AAuCA;EAuEgB,kBAAA;EACA,gBAAA;AA3GhB;AAmCA;EA4EgB,kBAAA;EACA,cAAA;EACA,YAAA;EAEA,WAAA;EACA,YAAA;EACA,sBAAA;EACA,4BAAA;EACA,2BAAA;AA7GhB;ACxuBI;;EAEI,gGAAA;AD0uBR;ACvuBI;EACI,gGAAA;ADyuBR;ACtuBI;EACI,oGAAA;ADwuBR;AAqGgB;EACI,WAAA;AAnGpB;AAuGY;EACI,kBAAA;AArGhB;AAoGY;EAIQ,kBAAA;AArGpB;AAuGoB;EAEQ,aAAA;AAtG5B;AAoGoB;;;;EASQ,qBAAA;AAvG5B;AAwFY;EAqBQ,kBAAA;EACA,cAAA;EACA,qCAAA;AA1GpB;AA4GoB;;EAEI,wBAAA;AA1GxB;AA6GoB;EACI,wBAAA;AA3GxB;AAfA;EAiIY,kBAAA;AA/GZ;AAlBA;EAoIgB,kBAAA;EACA,cAAA;EACA,WAAA;EACA,kBAAA;EACA,YAAA;EACA,yBAAA;AA/GhB;AAiHgB;EACI,cAAA;AA/GpB;AA7BA;EAkJY,aAAA;EACA,UAAA;EACA,eAAA;EACA,eAAA;AAlHZ;AAnCA;EAyJY,kBAAA;EACA,aAAA;EACA,SAAA;EACA,gBAAA;AAnHZ;AAzCA;EA+JgB,kBAAA;EACA,eAAA;EACA,gBAAA;EACA,kBAAA;EACA,aAAA;EACA,kBAAA;EACA,WAAA;EACA,WAAA;AAnHhB;AAqHgB;EACI,kBAAA;EACA,yBAAA;AAnHpB;AAsHgB;EACI,kBAAA;EACA,yBAAA;AApHpB;AA2HA;EACI,kBAAA;EACA,aAAA;EACA,mBAAA;EACA,uBAAA;EACA,MAAA;EACA,OAAA;EACA,WAAA;EACA,YAAA;EACA,YAAA;EACA,2BAAA;EACA,aAAA;EACA,kBAAA;EACA,UAAA;AAzHJ;AA2HI;EACI,mBAAA;EACA,UAAA;EACA,gCAAA;EACA,aAAA;AAzHR;AAsGA;EAuBQ,kBAAA;EACA,cAAA;EACA,WAAA;EACA,kBAAA;EACA,sBAAA;EACA,aAAA;EACA,YAAA;AA1HR;AA6FA;EAiCQ,kBAAA;AA3HR;AA0FA;EAoCY,cAAA;EACA,eAAA;EACA,gBAAA;EACA,kBAAA;EACA,mBAAA;AA3HZ;AAmFA;EA4CY,eAAA;EACA,gBAAA;EACA,kBAAA;EACA,mBAAA;AA5HZ;AA6EA;EAmDY,kBAAA;EACA,aAAA;EACA,SAAA;EACA,gBAAA;AA7HZ;AAuEA;EAyDgB,kBAAA;EACA,eAAA;EACA,gBAAA;EACA,kBAAA;EACA,aAAA;EACA,kBAAA;EACA,WAAA;EACA,gBAAA;EACA,WAAA;EACA,yBAAA;EACA,iBAAA;EACA,kBAAA;AA7HhB;AAmIA;EACI;IACI,YAAA;EAjIN;EAoIE;IACI,UAAA;EAlIN;EAqIE;IACI,YAAA;EAnIN;AACF",sourcesContent:["@import './variable.less';\n\nbutton.btn-livechat {\n    position: fixed;\n    bottom: 55px;\n    right: 18px;\n    width: 60px;\n    height: 60px;\n    cursor: pointer;\n    background-color: transparent;\n    border: none;\n    padding: 0;\n    z-index: 100;\n\n    &.btn-livechat-hide {\n        display: none !important;\n        user-select: none;\n    }\n\n    img {\n        display: block;\n        width: 100%;\n        height: auto;\n    }\n}\n\n#chatPopup {\n    position: fixed;\n    display: flex;\n    flex-direction: column;\n    top: 20%;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    color: #667085;\n    background-color: #fff;\n    z-index: 999;\n    visibility: hidden;\n    opacity: 0;\n    transition: all .3s ease-in-out;\n    font-size: 14px;\n    font-family: \"SF Pro\", sans-serif;\n    z-index: -999;\n\n    &.chat-window-hide {\n        display: none !important;\n        user-select: none;\n    }\n\n    * {\n        font-family: \"SF Pro\", sans-serif;\n        box-sizing: border-box;\n    }\n\n    h2 {\n        color: #454B58;\n        font-size: 20px;\n        font-weight: 700;\n    }\n\n    p {\n        position: relative;\n        margin: 0;\n    }\n\n    img {\n        max-width: 100%;\n    }\n\n    // &.chat-init {\n    // position: relative;\n    // }\n    &.chat-hidden {\n        transition: all .3s ease-in-out;\n    }\n\n    &.chat-visible {\n        top: 0;\n        visibility: visible;\n        opacity: 1;\n        transition: all .3s ease-in-out;\n        z-index: 999;\n    }\n\n    // &.chat-ended {\n    // transition: all .3s ease-in-out;\n    // }\n}\n\n.chat-header {\n    position: relative;\n    display: flex;\n    align-items: center;\n    flex-wrap: nowrap;\n    width: 100%;\n    padding: 6px 0 5px;\n    border-bottom: 1px solid #CBCBCB;\n\n    .btn-widget-back {\n        position: relative;\n        display: block;\n        border: none;\n        width: 45px;\n        height: 45px;\n        cursor: pointer;\n        background-color: transparent;\n        padding: 10px;\n\n        img {\n            display: block;\n            width: 100%;\n            height: auto;\n        }\n    }\n\n    .chatbot-user {\n        position: relative;\n        display: flex;\n        align-items: center;\n        flex-wrap: nowrap;\n        gap: 14px;\n\n        .chatbot-pic {\n            position: relative;\n            display: block;\n            width: 48px;\n            height: 48px;\n\n            &:before {\n                content: '';\n                position: absolute;\n                display: block;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                left: 0;\n                z-index: 10;\n                border: 1px solid #E3E3E3;\n                border-radius: 100%;\n            }\n\n            img {\n                position: relative;\n                border-radius: 100%;\n                z-index: 0;\n            }\n\n            .chatbot-status {\n                position: absolute;\n                display: block;\n                width: 10.5px;\n                height: 10.5px;\n                background-color: #2ACA6F;\n                border-radius: 100%;\n                bottom: 8.5px;\n                right: 8.5px;\n                z-index: 20;\n                transform: translate(50%, 50%);\n            }\n        }\n\n        .chatbot-title {\n            position: relative;\n\n            h2 {\n                margin: 0;\n            }\n\n            // to-be removed\n            h6 {\n                font-size: 14px;\n                font-weight: 400;\n                opacity: .8;\n                margin: 0;\n            }\n        }\n    }\n\n    .endchat-btn {\n\n        &:hover,\n        &:active {\n            background-color: #3769FF;\n            color: #fff;\n        }\n\n        position: relative;\n        font-size: 14px;\n        font-weight: 700;\n        margin-left: auto;\n        margin-right: 18.5px;\n        background-color: transparent;\n        color: #3769FF;\n        border: 1px solid #3769FF;\n        border-radius: 10px;\n        padding: 6px 10px;\n    }\n}\n\n.chat-area {\n    position: relative;\n    background-color: #F6F6F7;\n    height: -webkit-fill-available;\n    flex-grow: 1;\n    overflow: hidden;\n\n    .chat-message {\n        position: relative;\n        display: block;\n        height: 100%;\n        padding: 10px;\n        overflow-y: scroll;\n\n        .chat-user {\n            position: relative;\n            display: flex;\n            align-items: center;\n            gap: 7px;\n\n            &.user-incoming {\n                justify-content: flex-start;\n\n                .chat-user-pic {\n                    position: relative;\n                    display: block;\n                    width: 28px;\n                    height: 28px;\n                    border-radius: 100%;\n                    background-color: #fff;\n                    z-index: 0;\n\n                    &:before {\n                        content: '';\n                        position: absolute;\n                        display: block;\n                        top: 0;\n                        right: 0;\n                        bottom: 0;\n                        left: 0;\n                        z-index: 10;\n                        border: 1px solid #E3E3E3;\n                        border-radius: 100%;\n                    }\n\n                    img {\n                        position: relative;\n                    }\n                }\n            }\n\n            &.user-outgoing {\n                justify-content: flex-end;\n            }\n\n            .chat-user-name {\n                position: relative;\n                font-size: 12px;\n                line-height: 28px;\n\n                .chat-time {\n                    position: relative;\n                    text-transform: uppercase;\n                }\n            }\n        }\n\n        .chat-bubble {\n            position: relative;\n            display: block;\n            margin: 0 35px 20px;\n\n            .chat-bubble-text {\n                position: relative;\n                display: block;\n                font-size: 14px;\n                font-size: 14px;\n                font-weight: 400;\n                line-height: 1.6;\n                border-radius: 10px;\n                width: fit-content;\n                word-break: break-word;\n                padding: 6px 10px;\n                border: 1px solid #E3E3E3;\n                background-color: #fff;\n\n                &:not(:last-child) {\n                    margin-bottom: 8px;\n                }\n\n                p {\n                    white-space: pre-line;\n                }\n\n                p {\n                    white-space: pre-line;\n                }\n            }\n\n            .bubble-read-receipt {\n                display: block;\n                text-align: right;\n                font-size: 12px;\n                overflow: hidden;\n                height: 14.5px;\n                transform: scaleY(1);\n                transition: all .3s ease;\n\n                &.hide {\n                    height: 0;\n                    transform: scaleY(1);\n                    transition: all .3s ease;\n                }\n            }\n\n            .chat-bubble-image {\n                position: relative;\n                display: block;\n                border-radius: 10px;\n                width: fit-content;\n                border: 1px solid #E3E3E3;\n                padding: 6px;\n                background-color: #ffffff;\n                margin-left: auto;\n\n                img {\n                    max-width: 60vw !important;\n                    border-radius: 6px;\n                }\n            }\n\n            .chat-bubble-video {\n                display: block;\n                margin-left: auto;\n                max-width: 90%;\n                overflow: hidden;\n                border-radius: 10px;\n\n                video {\n                    position: relative;\n                    display: block;\n                    width: 100%;\n                    height: auto;\n                    max-height: 250px;\n                    border-radius: 10px;\n                    background: #000;\n                }\n            }\n\n            &.bubble-incoming {\n                position: relative;\n                overflow-y: visible;\n                // overflow-x: scroll;\n                margin: 0;\n                // padding: 0 35px 20px;\n                padding: 0 55px 8px 35px;\n                // padding: 0 35px 20px;\n                padding: 0 55px 8px 35px;\n\n                .chat-bubble-text {\n                    margin-right: auto;\n                }\n\n                +.chat-user.user-incoming {\n                    display: none;\n                }\n\n                +.bubble-incoming {\n                    // padding: 10px;\n                    // margin: -20px -10px 0;\n                    padding: 0 35px 8px;\n                    margin: 0 -5px 0;\n                }\n            }\n\n            &.bubble-outgoing {\n                position: relative;\n                margin: 0 0 8px 35px;\n\n                .chat-bubble-text {\n                    color: #fff;\n                    padding: 6px 20px;\n                    border: 1px solid #3769FF;\n                    background-color: #3769FF;\n                    margin-left: auto;\n                }\n\n                +.chat-user.user-outgoing {\n                    display: none;\n                }\n\n                +.chat-user.user-incoming {\n                    margin-top: 20px;\n                }\n            }\n\n            &.chat-loading {\n                span {\n                    content: \"\";\n                    animation: blink 1s infinite;\n                    animation-fill-mode: both;\n                    height: 10px;\n                    width: 10px;\n                    background: #D8E1FF;\n                    position: absolute;\n                    left: 0;\n                    top: 0;\n                    border-radius: 50%;\n\n                    &:nth-child(2) {\n                        animation-delay: 0.2s;\n                        margin-left: 10px * 1.5;\n                    }\n\n                    &:nth-child(3) {\n                        animation-delay: 0.4s;\n                        margin-left: 10px * 3;\n                    }\n                }\n            }\n        }\n\n        .chat-history {\n            position: relative;\n            display: block;\n            height: 1px;\n            background-color: #E3E3E3;\n            margin-top: 15px;\n            margin-bottom: 15px;\n\n            &:first-child {\n                display: none;\n            }\n        }\n    }\n\n    .chat-attachment {\n        position: absolute;\n        display: flex;\n        align-items: center;\n        left: 0;\n        top: 0;\n        width: 100%;\n        height: 100%;\n        background-color: #F6F6F7;\n        padding: 35px;\n        visibility: hidden;\n\n        &.active {\n            position: absolute;\n            visibility: visible;\n        }\n\n        .attachment-wrap {\n            position: relative;\n            display: block;\n            background-color: #D8E1FF;\n            padding: 10px;\n            width: 100%;\n            border-radius: 15px;\n\n            &.inserted {\n                position: relative;\n\n                .file-icon,\n                h5 {\n                    display: none;\n                }\n            }\n        }\n\n        .attachment-btn {\n            position: relative;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            width: 100%;\n            min-height: 376px;\n            border: 1px dashed #667085;\n            border-radius: 15px;\n            padding: 10px;\n            cursor: pointer;\n\n            input {\n                position: relative;\n            }\n        }\n\n        .file-upload {\n            position: relative;\n            text-align: center;\n            background: unset;\n\n            h5 {\n                font-size: 16px;\n                font-weight: 500;\n                margin-bottom: 15px;\n            }\n\n            p {\n                font-size: 12px;\n                color: rgba(102, 112, 133, .5);\n            }\n\n            .file-preview,\n            .file-icon {\n                position: relative;\n\n                &:not(:empty) {\n                    margin-bottom: 30px;\n                }\n\n                img {\n                    display: block;\n                    margin: 0 auto;\n                    max-width: 80px;\n                    max-height: 80px;\n                    width: auto;\n                    height: auto;\n                }\n\n                p {\n                    position: relative;\n                }\n            }\n        }\n    }\n}\n\n.chat-input-wrap {\n    position: relative;\n    border-top: 1px solid #CBCBCB;\n\n    .chat-input {\n        position: relative;\n        display: flex;\n        align-items: center;\n\n        textarea {\n            position: relative;\n            display: block;\n            margin: 0;\n            padding: 8px 20px 8px 20px;\n            color: #667085;\n            font-size: 16px;\n            flex-grow: 1;\n            border: none;\n            height: 60px;\n            align-content: center;\n            box-sizing: border-box;\n\n            &:focus,\n            &:focus-visible {\n                outline: none;\n            }\n\n            &[disabled],\n            &[disabled]::placeholder {\n                background-color: transparent;\n                color: transparent;\n            }\n        }\n    }\n\n    .chat-tool {\n        position: relative;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        padding-right: 20px;\n\n        button {\n            position: relative;\n            display: block;\n            background-color: transparent;\n            border: none;\n            box-sizing: border-box;\n            padding: 0;\n            width: 24px;\n            height: 24px;\n            cursor: pointer;\n            pointer-events: auto;\n\n            img {\n                vertical-align: middle;\n            }\n\n            &.emoji-btn,\n            &.send-btn,\n            &.liveagent-btn {\n                &:after {\n                    content: '';\n                    position: absolute;\n                    display: block;\n                    width: 100%;\n                    height: 100%;\n                    left: 0;\n                    top: 0;\n                    mask-size: contain;\n                    mask-repeat: no-repeat;\n                    mask-position: center;\n                    background-color: #667085;\n                }\n\n                &.active:after {\n                    background-color: #3769FF;\n                }\n            }\n\n            &.emoji-btn:after {\n                .mask-image('/images/ailivechat/icon-emoji.svg');\n            }\n\n            &.liveagent-btn {\n                &:after {\n                    .mask-image('/images/ailivechat/icon-liveagent.svg');\n                }\n\n                &:not(.disabled):active:after {\n                    background-color: #1c55ff;\n                }\n\n                &.disabled:active:after {\n                    background-color: #7f889b;\n                }\n            }\n\n            &.attachment-btn {\n                &.active:after {\n                    content: '';\n                    position: absolute;\n                    display: block;\n                    width: 100%;\n                    height: 100%;\n                    left: 0;\n                    top: 0;\n                    mask-size: contain;\n                    mask-repeat: no-repeat;\n                    mask-position: center;\n                    background-color: #3769FF;\n                    .mask-image('/images/ailivechat/icon-bubble.svg');\n                }\n\n                &.hide {\n                    display: none;\n                }\n            }\n\n            &.attachment-btn:not(.active) img:nth-child(2) {\n                display: none;\n            }\n\n            &.attachment-btn.active img:nth-child(1) {\n                display: none;\n            }\n\n            &.send-btn {\n                &:after {\n                    .mask-image('/images/ailivechat/icon-send.svg');\n                }\n\n                &.active:active:after {\n                    background-color: #1c55ff;\n                }\n\n                &:not(.active):active:after {\n                    background-color: #7f889b;\n                }\n            }\n        }\n\n        // .emoji-btn.active svg path {\n        //     fill: #3769FF;\n        // }\n\n        // .attachment-btn.active svg path {\n        //     stroke: #3769FF;\n        // }\n\n        .send-btn:hover svg path {}\n    }\n\n    .emoji-popup {\n        position: absolute;\n        visibility: hidden;\n        opacity: 0;\n        bottom: calc(100% - 13px);\n        right: 86px;\n        margin-right: -95px;\n\n        &:before {\n            content: '';\n            position: absolute;\n            z-index: 1;\n            width: 0;\n            height: 0;\n            border: 14px solid;\n            border-color: #fff transparent transparent transparent;\n            right: 81px;\n            bottom: 2px;\n\n            @media (max-width: 315px) {\n                right: 114px;\n            }\n        }\n\n        &:after {\n            content: '';\n            display: block;\n            width: 0;\n            height: 0;\n            border: 15px solid;\n            border-color: #E3E3E3 transparent transparent transparent;\n            filter: drop-shadow(1px 1px 4px rgba(0, 0, 0, 0.1));\n            margin-left: auto;\n            margin-right: 79.5px;\n\n            @media (max-width: 315px) {\n                margin-right: 112.5px;\n            }\n        }\n\n        &.active {\n            visibility: visible;\n            opacity: 1;\n\n            &.attachment-hidden {\n                margin-right: -61px;\n\n                &:before {\n                    right: 47px;\n\n                    @media (max-width: 315px) {\n                        right: 80px;\n                    }\n                }\n\n                &:after {\n                    margin-right: 45.5px;\n\n                    @media (max-width: 315px) {\n                        margin-right: 78.5px;\n                    }\n                }\n            }\n        }\n\n        .emoji-list {\n            position: relative;\n            border: 1px solid #E3E3E3;\n            box-shadow: 1px 1px 4px 0px rgba(0, 0, 0, 0.1);\n            border-radius: 10px;\n            background-color: #fff;\n            justify-content: space-between;\n            padding: 14px 20px;\n\n            .emoji-row {\n                position: relative;\n                display: flex;\n                gap: 8px;\n            }\n\n            .emoji {\n                font-size: 30px;\n                text-align: center;\n                cursor: pointer;\n            }\n        }\n    }\n}\n\n.chat-rate-review {\n    position: absolute;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    z-index: 100;\n    background-color: #00000099;\n    padding: 20px;\n    visibility: hidden;\n    opacity: 0;\n\n    &.rate-review-visible {\n        visibility: visible;\n        opacity: 1;\n        transition: all .3s ease-in-out;\n        z-index: 1000;\n    }\n\n    .rate-review-wrap {\n        position: relative;\n        display: block;\n        width: 100%;\n        border-radius: 8px;\n        background-color: #fff;\n        padding: 20px;\n        width: 750px;\n    }\n\n    .rate-review-close {\n        position: absolute;\n        display: block;\n        top: 15px;\n        right: 15px;\n        z-index: 100;\n\n        img {\n            position: relative;\n        }\n    }\n\n    .rate-review-content {\n        position: relative;\n\n        h2 {\n            color: #454B58;\n            font-size: 20px;\n            font-weight: 700;\n            text-align: center;\n            margin-bottom: 16px;\n        }\n\n        h6 {\n            font-size: 14px;\n            font-weight: 400;\n            text-align: center;\n            margin-bottom: 30px;\n        }\n\n        .rate {\n            position: relative;\n            display: flex;\n            flex-direction: row-reverse;\n            gap: 7px;\n            justify-content: center;\n            margin-bottom: 10px;\n\n            input {\n                position: relative;\n                appearance: none;\n            }\n\n            label {\n                position: relative;\n                display: block;\n                font-size: 0;\n                .bg-img('/images/ailivechat/icon-star.svg');\n                width: 31px;\n                height: 31px;\n                background-size: cover;\n                background-repeat: no-repeat;\n                background-position: center;\n\n                &:before {\n                    content: '';\n                }\n            }\n\n            &:not(:checked) {\n                position: relative;\n\n                input {\n                    position: relative;\n\n                    &:checked {\n                        ~label {\n                            filter: unset;\n                        }\n\n                        +label:hover,\n                        +label:hover~label,\n                        ~label:hover,\n                        ~label:hover~label {\n                            filter: brightness(1);\n                        }\n                    }\n                }\n\n                label {\n                    position: relative;\n                    display: block;\n                    filter: grayscale(1) brightness(1.02);\n\n                    &:hover,\n                    &:hover~label {\n                        filter: brightness(.95);\n                    }\n\n                    &:hover~input:checked~label {\n                        filter: brightness(.85);\n                    }\n                }\n            }\n        }\n\n        .review {\n            position: relative;\n\n            textarea {\n                position: relative;\n                display: block;\n                width: 100%;\n                padding: 15px 10px;\n                border: none;\n                background-color: #F8F8F8;\n\n                &::placeholder {\n                    color: #B3B3B3;\n                }\n            }\n        }\n\n        .error-message {\n            display: none;\n            color: red;\n            font-size: 12px;\n            margin-top: 5px;\n        }\n\n        .rate-review-btn {\n            position: relative;\n            display: flex;\n            gap: 13px;\n            margin-top: 20px;\n\n            .btn-ratereview {\n                position: relative;\n                font-size: 12px;\n                font-weight: 700;\n                text-align: center;\n                padding: 13px;\n                border-radius: 8px;\n                color: #fff;\n                width: 100%;\n\n                &#rateCancel {\n                    position: relative;\n                    background-color: #98A4BD;\n                }\n\n                &#rateSubmit {\n                    position: relative;\n                    background-color: #3769FF;\n                }\n            }\n        }\n    }\n}\n\n.chat-error {\n    position: absolute;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    z-index: 100;\n    background-color: #00000099;\n    padding: 20px;\n    visibility: hidden;\n    opacity: 0;\n\n    &.chat-error-visible {\n        visibility: visible;\n        opacity: 1;\n        transition: all .3s ease-in-out;\n        z-index: 1000;\n    }\n\n    .error-wrap {\n        position: relative;\n        display: block;\n        width: 100%;\n        border-radius: 8px;\n        background-color: #fff;\n        padding: 20px;\n        width: 750px;\n    }\n\n    .error-content {\n        position: relative;\n\n        h2 {\n            color: #454B58;\n            font-size: 20px;\n            font-weight: 700;\n            text-align: center;\n            margin-bottom: 16px;\n        }\n\n        p {\n            font-size: 14px;\n            font-weight: 400;\n            text-align: center;\n            margin-bottom: 30px;\n        }\n\n        .error-btn {\n            position: relative;\n            display: flex;\n            gap: 13px;\n            margin-top: 20px;\n\n            .btn-error {\n                position: relative;\n                font-size: 12px;\n                font-weight: 700;\n                text-align: center;\n                padding: 13px;\n                border-radius: 8px;\n                color: #fff;\n                max-width: 140px;\n                width: 100%;\n                background-color: #3769FF;\n                margin-left: auto;\n                margin-right: auto;\n            }\n        }\n    }\n}\n\n@keyframes blink {\n    0% {\n        opacity: 0.1;\n    }\n\n    20% {\n        opacity: 1;\n    }\n\n    100% {\n        opacity: 0.1;\n    }\n}",'.bg-img(@img) {\n    #chatPopup[data-env="3"] &,\n    #chatPopup[data-env="4"] & {\n        background-image: url("https://cp-images.client88.me/images/cp@{img}");\n    }\n\n    #chatPopup[data-env="2"] & {\n        background-image: url("https://cp-images.client99.me/images/cp@{img}");\n    }\n\n    #chatPopup[data-env="1"] & {\n        background-image: url("https://cp-images.casinoplus.live/images/cp@{img}");\n    }\n}\n\n.mask-image(@img) {\n    #chatPopup[data-env="3"] &,\n    #chatPopup[data-env="4"] & {\n        mask-image: url("https://cp-images.client88.me/images/cp@{img}");\n    }\n\n    #chatPopup[data-env="2"] & {\n        mask-image: url("https://cp-images.client99.me/images/cp@{img}");\n    }\n\n    #chatPopup[data-env="1"] & {\n        mask-image: url("https://cp-images.casinoplus.live/images/cp@{img}");\n    }\n}'],sourceRoot:""}]);const a=o},6314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=e(t);return t[2]?"@media ".concat(t[2]," {").concat(n,"}"):n})).join("")},t.i=function(e,n,r){"string"==typeof e&&(e=[[null,e,""]]);var i={};if(r)for(var s=0;s<this.length;s++){var o=this[s][0];null!=o&&(i[o]=!0)}for(var a=0;a<e.length;a++){var c=[].concat(e[a]);r&&i[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),t.push(c))}},t}},4991:e=>{"use strict";function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}e.exports=function(e){var n,r,i=(r=4,function(e){if(Array.isArray(e))return e}(n=e)||function(e,t){var n=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null!=n){var r,i,s=[],o=!0,a=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(s.push(r.value),!t||s.length!==t);o=!0);}catch(e){a=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(a)throw i}}return s}}(n,r)||function(e,n){if(e){if("string"==typeof e)return t(e,n);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?t(e,n):void 0}}(n,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),s=i[1],o=i[3];if(!o)return s;if("function"==typeof btoa){var a=btoa(unescape(encodeURIComponent(JSON.stringify(o)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),l="/*# ".concat(c," */"),u=o.sources.map((function(e){return"/*# sourceURL=".concat(o.sourceRoot||"").concat(e," */")}));return[s].concat(u).concat([l]).join("\n")}return[s].join("\n")}},41:(e,t,n)=>{"use strict";var r=n(655),i=n(8068),s=n(9675),o=n(5795);e.exports=function(e,t,n){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new s("`obj` must be an object or a function`");if("string"!=typeof t&&"symbol"!=typeof t)throw new s("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new s("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new s("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new s("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new s("`loose`, if provided, must be a boolean");var a=arguments.length>3?arguments[3]:null,c=arguments.length>4?arguments[4]:null,l=arguments.length>5?arguments[5]:null,u=arguments.length>6&&arguments[6],d=!!o&&o(e,t);if(r)r(e,t,{configurable:null===l&&d?d.configurable:!l,enumerable:null===a&&d?d.enumerable:!a,value:n,writable:null===c&&d?d.writable:!c});else{if(!u&&(a||c||l))throw new i("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=n}}},655:(e,t,n)=>{"use strict";var r=n(453)("%Object.defineProperty%",!0)||!1;if(r)try{r({},"a",{value:1})}catch(e){r=!1}e.exports=r},1237:e=>{"use strict";e.exports=EvalError},9383:e=>{"use strict";e.exports=Error},9290:e=>{"use strict";e.exports=RangeError},9538:e=>{"use strict";e.exports=ReferenceError},8068:e=>{"use strict";e.exports=SyntaxError},9675:e=>{"use strict";e.exports=TypeError},5345:e=>{"use strict";e.exports=URIError},7007:e=>{"use strict";var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,s),r(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}f(e,t,s,{once:!0}),"error"!==t&&function(e,t){"function"==typeof e.on&&f(e,"error",t,{once:!0})}(e,i)}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function l(e,t,n,r){var i,s,o,l;if(a(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),void 0===o)o=s[t]=n,++e._eventsCount;else if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=c(e))>0&&o.length>i&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,l=u,console&&console.warn&&console.warn(l)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=u.bind(r);return i.listener=n,r.wrapFn=i,i}function h(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function f(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(s){r.once&&e.removeEventListener(t,i),n(s)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,s=this._events;if(void 0!==s)i=i&&void 0===s.error;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(void 0===c)return!1;if("function"==typeof c)r(c,this,t);else{var l=c.length,u=g(c,l);for(n=0;n<l;++n)r(u[n],this,t)}return!0},s.prototype.addListener=function(e,t){return l(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return l(this,e,t,!0)},s.prototype.once=function(e,t){return a(t),this.on(e,d(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,d(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,i,s,o;if(a(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return h(this,e,!0)},s.prototype.rawListeners=function(e){return h(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},s.prototype.listenerCount=p,s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},9353:e=>{"use strict";var t=Object.prototype.toString,n=Math.max,r=function(e,t){for(var n=[],r=0;r<e.length;r+=1)n[r]=e[r];for(var i=0;i<t.length;i+=1)n[i+e.length]=t[i];return n};e.exports=function(e){var i=this;if("function"!=typeof i||"[object Function]"!==t.apply(i))throw new TypeError("Function.prototype.bind called on incompatible "+i);for(var s,o=function(e){for(var t=[],n=1,r=0;n<e.length;n+=1,r+=1)t[r]=e[n];return t}(arguments),a=n(0,i.length-o.length),c=[],l=0;l<a;l++)c[l]="$"+l;if(s=Function("binder","return function ("+function(e){for(var t="",n=0;n<e.length;n+=1)t+=e[n],n+1<e.length&&(t+=",");return t}(c)+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var t=i.apply(this,r(o,arguments));return Object(t)===t?t:this}return i.apply(e,r(o,arguments))})),i.prototype){var u=function(){};u.prototype=i.prototype,s.prototype=new u,u.prototype=null}return s}},6743:(e,t,n)=>{"use strict";var r=n(9353);e.exports=Function.prototype.bind||r},453:(e,t,n)=>{"use strict";var r,i=n(9383),s=n(1237),o=n(9290),a=n(9538),c=n(8068),l=n(9675),u=n(5345),d=Function,h=function(e){try{return d('"use strict"; return ('+e+").constructor;")()}catch(e){}},p=Object.getOwnPropertyDescriptor;if(p)try{p({},"")}catch(e){p=null}var g=function(){throw new l},f=p?function(){try{return g}catch(e){try{return p(arguments,"callee").get}catch(e){return g}}}():g,m=n(4039)(),v=n(24)(),y=Object.getPrototypeOf||(v?function(e){return e.__proto__}:null),_={},b="undefined"!=typeof Uint8Array&&y?y(Uint8Array):r,E={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":m&&y?y([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":_,"%AsyncGenerator%":_,"%AsyncGeneratorFunction%":_,"%AsyncIteratorPrototype%":_,"%Atomics%":"undefined"==typeof Atomics?r:Atomics,"%BigInt%":"undefined"==typeof BigInt?r:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?r:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":i,"%eval%":eval,"%EvalError%":s,"%Float32Array%":"undefined"==typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":d,"%GeneratorFunction%":_,"%Int8Array%":"undefined"==typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":m&&y?y(y([][Symbol.iterator]())):r,"%JSON%":"object"==typeof JSON?JSON:r,"%Map%":"undefined"==typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&m&&y?y((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?r:Promise,"%Proxy%":"undefined"==typeof Proxy?r:Proxy,"%RangeError%":o,"%ReferenceError%":a,"%Reflect%":"undefined"==typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&m&&y?y((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":m&&y?y(""[Symbol.iterator]()):r,"%Symbol%":m?Symbol:r,"%SyntaxError%":c,"%ThrowTypeError%":f,"%TypedArray%":b,"%TypeError%":l,"%Uint8Array%":"undefined"==typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?r:Uint32Array,"%URIError%":u,"%WeakMap%":"undefined"==typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?r:WeakSet};if(y)try{null.error}catch(e){var A=y(y(e));E["%Error.prototype%"]=A}var S=function e(t){var n;if("%AsyncFunction%"===t)n=h("async function () {}");else if("%GeneratorFunction%"===t)n=h("function* () {}");else if("%AsyncGeneratorFunction%"===t)n=h("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(n=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&y&&(n=y(i.prototype))}return E[t]=n,n},w={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},I=n(6743),T=n(9957),k=I.call(Function.call,Array.prototype.concat),R=I.call(Function.apply,Array.prototype.splice),O=I.call(Function.call,String.prototype.replace),C=I.call(Function.call,String.prototype.slice),P=I.call(Function.call,RegExp.prototype.exec),D=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,N=/\\(\\)?/g,x=function(e,t){var n,r=e;if(T(w,r)&&(r="%"+(n=w[r])[0]+"%"),T(E,r)){var i=E[r];if(i===_&&(i=S(r)),void 0===i&&!t)throw new l("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:n,name:r,value:i}}throw new c("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new l("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new l('"allowMissing" argument must be a boolean');if(null===P(/^%?[^%]*%?$/,e))throw new c("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var n=function(e){var t=C(e,0,1),n=C(e,-1);if("%"===t&&"%"!==n)throw new c("invalid intrinsic syntax, expected closing `%`");if("%"===n&&"%"!==t)throw new c("invalid intrinsic syntax, expected opening `%`");var r=[];return O(e,D,(function(e,t,n,i){r[r.length]=n?O(i,N,"$1"):t||e})),r}(e),r=n.length>0?n[0]:"",i=x("%"+r+"%",t),s=i.name,o=i.value,a=!1,u=i.alias;u&&(r=u[0],R(n,k([0,1],u)));for(var d=1,h=!0;d<n.length;d+=1){var g=n[d],f=C(g,0,1),m=C(g,-1);if(('"'===f||"'"===f||"`"===f||'"'===m||"'"===m||"`"===m)&&f!==m)throw new c("property names with quotes must have matching quotes");if("constructor"!==g&&h||(a=!0),T(E,s="%"+(r+="."+g)+"%"))o=E[s];else if(null!=o){if(!(g in o)){if(!t)throw new l("base intrinsic for "+e+" exists, but the property is not available.");return}if(p&&d+1>=n.length){var v=p(o,g);o=(h=!!v)&&"get"in v&&!("originalValue"in v.get)?v.get:o[g]}else h=T(o,g),o=o[g];h&&!a&&(E[s]=o)}}return o}},5795:(e,t,n)=>{"use strict";var r=n(453)("%Object.getOwnPropertyDescriptor%",!0);if(r)try{r([],"length")}catch(e){r=null}e.exports=r},592:(e,t,n)=>{"use strict";var r=n(655),i=function(){return!!r};i.hasArrayLengthDefineBug=function(){if(!r)return null;try{return 1!==r([],"length",{value:1}).length}catch(e){return!0}},e.exports=i},24:e=>{"use strict";var t={__proto__:null,foo:{}},n=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!(t instanceof n)}},4039:(e,t,n)=>{"use strict";var r="undefined"!=typeof Symbol&&Symbol,i=n(1333);e.exports=function(){return"function"==typeof r&&"function"==typeof Symbol&&"symbol"==typeof r("foo")&&"symbol"==typeof Symbol("bar")&&i()}},1333:e=>{"use strict";e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),n=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(n))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var r=Object.getOwnPropertySymbols(e);if(1!==r.length||r[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var i=Object.getOwnPropertyDescriptor(e,t);if(42!==i.value||!0!==i.enumerable)return!1}return!0}},9957:(e,t,n)=>{"use strict";var r=Function.prototype.call,i=Object.prototype.hasOwnProperty,s=n(6743);e.exports=s.call(r,i)},3065:function(e,t,n){var r,i;!function(){"use strict";r=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],i={},s=null;function o(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(){for(var n=this.getLevel(),i=0;i<r.length;i++){var s=r[i];this[s]=i<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function l(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function u(r,i,s){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?a:void 0!==console[r]?o(console,r):void 0!==console.log?o(console,"log"):e)}(r)||l.apply(this,arguments)}function d(e,n){var o,a,l,d=this,h="loglevel";function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=encodeURIComponent(h),i=n.indexOf(r+"=");-1!==i&&(e=/^([^;]+)/.exec(n.slice(i+r.length+1))[1])}catch(e){}return void 0===d.levels[e]&&(e=void 0),e}}function g(e){var t=e;if("string"==typeof t&&void 0!==d.levels[t.toUpperCase()]&&(t=d.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=d.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),d.name=e,d.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},d.methodFactory=n||u,d.getLevel=function(){return null!=l?l:null!=a?a:o},d.setLevel=function(e,n){return l=g(e),!1!==n&&function(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+n+";"}catch(e){}}}(l),c.call(d)},d.setDefaultLevel=function(e){a=g(e),p()||d.setLevel(e,!1)},d.resetLevel=function(){l=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),c.call(d)},d.enableAll=function(e){d.setLevel(d.levels.TRACE,e)},d.disableAll=function(e){d.setLevel(d.levels.SILENT,e)},d.rebuild=function(){if(s!==d&&(o=g(s.getLevel())),c.call(d),s===d)for(var e in i)i[e].rebuild()},o=g(s?s.getLevel():"WARN");var f=p();null!=f&&(l=g(f)),c.call(d)}(s=new d).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=i[e];return t||(t=i[e]=new d(e,s.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=h),s},s.getLoggers=function(){return i},s.default=s,s},void 0===(i=r.call(t,n,t,e))||(e.exports=i)}()},9283:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvents=void 0;var r=n(2670),i=n(8262),s=n(8980),o=n(3361),a=n(3776),c=n(5134),l=n(3449);function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),h(this,"interpreters",new r.NamespacedMap([[s.LEGACY_M_ROOM_MESSAGE,s.parseMRoomMessage],[a.M_MESSAGE,o.parseMMessage],[a.M_EMOTE,o.parseMMessage],[a.M_NOTICE,o.parseMMessage],[c.M_POLL_START,l.parseMPoll],[c.M_POLL_RESPONSE,l.parseMPoll],[c.M_POLL_END,l.parseMPoll]])),h(this,"_unknownInterpretOrder",[a.M_MESSAGE])}var t,n,p;return t=e,p=[{key:"defaultInstance",get:function(){return e._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return e.defaultInstance.unknownInterpretOrder},set:function(t){e.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,n){e.defaultInstance.registerInterpreter(t,n)}},{key:"parse",value:function(t){return e.defaultInstance.parse(t)}}],(n=[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}(this.unknownInterpretOrder);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(this.interpreters.has(r)){var s=this.interpreters.get(r)(e);if(s)return s}}}catch(e){n.e(e)}finally{n.f()}return null}catch(e){if(e instanceof i.InvalidEventError)return null;throw e}}}])&&d(t.prototype,n),p&&d(t,p),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.ExtensibleEvents=p,h(p,"_defaultInstance",new p)},3239:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},8262:(e,t)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e){var t="function"==typeof Map?new Map:void 0;return r=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return i(e,arguments,a(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),o(r,e)},r(e)}function i(e,t,n){return i=s()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&o(i,n.prototype),i},i.apply(null,arguments)}function s(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidEventError=void 0;var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t)}(l,e);var t,r,i,c=(r=l,i=s(),function(){var e,t=a(r);if(i){var s=a(this).constructor;e=Reflect.construct(t,arguments,s)}else e=t.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,e)});function l(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),c.call(this,e)}return t=l,Object.defineProperty(t,"prototype",{writable:!1}),t}(r(Error));t.InvalidEventError=c},2670:(e,t)=>{"use strict";function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMap=void 0;var i=function(){function e(t){var r,i,s;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r=this,i="internalMap",s=new Map,i in r?Object.defineProperty(r,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):r[i]=s,t){var o,a=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,s=function(){};return{s,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(c)throw o}}}}(t);try{for(a.s();!(o=a.n()).done;){var c=o.value;this.set(c[0],c[1])}}catch(e){a.e(e)}finally{a.f()}}}var t,i;return t=e,(i=[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap.delete(e.name),e.altName&&this.internalMap.delete(e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}])&&r(t.prototype,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.NamespacedMap=i},8993:(e,t)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t){return r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},r(e,t)}function i(e){return i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},i(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.NamespacedValue=void 0;var c=function(){function e(t,n){if(s(this,e),this.stable=t,this.unstable=n,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return a(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();t.NamespacedValue=c;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&r(e,t)}(l,e);var t,o,c=(t=l,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=i(t);if(o){var s=i(this).constructor;e=Reflect.construct(r,arguments,s)}else e=r.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,e)});function l(e,t){var n;if(s(this,l),!(n=c.call(this,e,t)).unstable)throw new Error("Unstable value must be supplied");return n}return a(l,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),l}(c);t.UnstableValue=l},1921:(e,t,n)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.EmoteEvent=void 0;var i=n(1624),s=n(3776),o=n(6419);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(){return l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},l.apply(this,arguments)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}(f,e);var t,n,i,h,p,g=(h=f,p=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=d(h);if(p){var n=d(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,e)});function f(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),g.call(this,e)}return t=f,i=[{key:"from",value:function(e,t){var n;return new f({type:s.M_EMOTE.name,content:(n={},a(n,s.M_TEXT.name,e),a(n,s.M_HTML.name,t),n)})}}],(n=[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,s.M_EMOTE)||l(d(f.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=l(d(f.prototype),"serialize",this).call(this);return e.content.msgtype="m.emote",e}}])&&c(t.prototype,n),i&&c(t,i),Object.defineProperty(t,"prototype",{writable:!1}),f}(i.MessageEvent);t.EmoteEvent=h},8474:(e,t)=>{"use strict";function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvent=void 0;var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.wireFormat=t}var t,r;return t=e,(r=[{key:"wireContent",get:function(){return this.wireFormat.content}}])&&n(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.ExtensibleEvent=r},1624:(e,t,n)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEvent=void 0;var i=n(8474),s=n(2666),o=n(8262),a=n(3776),c=n(6419);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){f(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t)}(y,e);var t,n,i,l,m,v=(l=y,m=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=g(l);if(m){var n=g(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}(this,e)});function y(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,y),f(p(t=v.call(this,e)),"text",void 0),f(p(t),"html",void 0),f(p(t),"renderings",void 0);var n=a.M_MESSAGE.findIn(t.wireContent),r=a.M_TEXT.findIn(t.wireContent),i=a.M_HTML.findIn(t.wireContent);if((0,s.isProvided)(n)){if(!Array.isArray(n))throw new o.InvalidEventError("m.message contents must be an array");var c=n.find((function(e){return!(0,s.isProvided)(e.mimetype)||"text/plain"===e.mimetype})),l=n.find((function(e){return"text/html"===e.mimetype}));if(!c)throw new o.InvalidEventError("m.message is missing a plain text representation");t.text=c.body,t.html=null==l?void 0:l.body,t.renderings=n}else{if(!(0,s.isOptionalAString)(r))throw new o.InvalidEventError("Missing textual representation for event");t.text=r,t.html=i,t.renderings=[{body:r,mimetype:"text/plain"}],t.html&&t.renderings.push({body:t.html,mimetype:"text/html"})}return t}return t=y,i=[{key:"from",value:function(e,t){var n;return new y({type:a.M_MESSAGE.name,content:(n={},f(n,a.M_TEXT.name,e),f(n,a.M_HTML.name,t),n)})}}],(n=[{key:"isEmote",get:function(){return a.M_EMOTE.matches(this.wireFormat.type)||(0,s.isProvided)(a.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return a.M_NOTICE.matches(this.wireFormat.type)||(0,s.isProvided)(a.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,a.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=f({},a.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;void 0!==t&&"text/plain"!==t||(e=f({},a.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:u(u({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}])&&d(t.prototype,n),i&&d(t,i),Object.defineProperty(t,"prototype",{writable:!1}),y}(i.ExtensibleEvent);t.MessageEvent=m},7985:(e,t,n)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.NoticeEvent=void 0;var i=n(1624),s=n(3776),o=n(6419);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(){return l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},l.apply(this,arguments)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}(f,e);var t,n,i,h,p,g=(h=f,p=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=d(h);if(p){var n=d(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,e)});function f(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),g.call(this,e)}return t=f,i=[{key:"from",value:function(e,t){var n;return new f({type:s.M_NOTICE.name,content:(n={},a(n,s.M_TEXT.name,e),a(n,s.M_HTML.name,t),n)})}}],(n=[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,s.M_NOTICE)||l(d(f.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=l(d(f.prototype),"serialize",this).call(this);return e.content.msgtype="m.notice",e}}])&&c(t.prototype,n),i&&c(t,i),Object.defineProperty(t,"prototype",{writable:!1}),f}(i.MessageEvent);t.NoticeEvent=h},7055:(e,t,n)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollEndEvent=void 0;var i=n(5134),s=n(8262),o=n(6309),a=n(1624),c=n(3776),l=n(6419);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){m(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}(b,e);var t,n,u,v,y,_=(v=b,y=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=f(v);if(y){var n=f(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return g(e)}(this,e)});function b(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,b),m(g(t=_.call(this,e)),"pollEventId",void 0),m(g(t),"closingMessage",void 0);var n=t.wireContent["m.relates_to"];if(!o.REFERENCE_RELATION.matches(null==n?void 0:n.rel_type)||"string"!=typeof(null==n?void 0:n.event_id))throw new s.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=n.event_id,t.closingMessage=new a.MessageEvent(t.wireFormat),t}return t=b,u=[{key:"from",value:function(e,t){var n;return new b({type:i.M_POLL_END.name,content:(n={"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:e}},m(n,i.M_POLL_END.name,{}),m(n,c.M_TEXT.name,t),n)})}}],(n=[{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,i.M_POLL_END)}},{key:"serialize",value:function(){return{type:i.M_POLL_END.name,content:d(m({"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:this.pollEventId}},i.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}])&&h(t.prototype,n),u&&h(t,u),Object.defineProperty(t,"prototype",{writable:!1}),b}(n(8474).ExtensibleEvent);t.PollEndEvent=v},8591:(e,t,n)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollResponseEvent=void 0;var i=n(8474),s=n(5134),o=n(8262),a=n(6309),c=n(6419);function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}(v,e);var t,n,i,g,f,m=(g=v,f=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=h(g);if(f){var n=h(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}(this,e)});function v(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,v),p(d(t=m.call(this,e)),"internalAnswerIds",void 0),p(d(t),"internalSpoiled",void 0),p(d(t),"pollEventId",void 0);var n=t.wireContent["m.relates_to"];if(!a.REFERENCE_RELATION.matches(null==n?void 0:n.rel_type)||"string"!=typeof(null==n?void 0:n.event_id))throw new o.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=n.event_id,t.validateAgainst(null),t}return t=v,i=[{key:"from",value:function(e,t){return new v({type:s.M_POLL_RESPONSE.name,content:p({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:t}},s.M_POLL_RESPONSE.name,{answers:e})})}}],(n=[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=s.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==t?void 0:t.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);var n=t.answers;if(n.some((function(e){return"string"!=typeof e}))||0===n.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(n.some((function(t){return!e.answers.some((function(e){return e.id===t}))})))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);n=n.slice(0,e.maxSelections)}this.internalAnswerIds=n,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,s.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:s.M_POLL_RESPONSE.name,content:p({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:this.pollEventId}},s.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}])&&l(t.prototype,n),i&&l(t,i),Object.defineProperty(t,"prototype",{writable:!1}),v}(i.ExtensibleEvent);t.PollResponseEvent=g},4560:(e,t,n)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollStartEvent=t.PollAnswerSubevent=void 0;var i=n(5134),s=n(1624),o=n(3776),a=n(8262),c=n(8993),l=n(6419),u=n(8474);function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){A(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t&&f(e.prototype,t),n&&f(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function v(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&y(e,t)}function y(e,t){return y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},y(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=E(e);if(t){var s=E(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return b(e)}(this,n)}}function b(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function E(e){return E=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},E(e)}function A(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(e){v(n,e);var t=_(n);function n(e){var r;g(this,n),A(b(r=t.call(this,e)),"id",void 0);var i=e.content.id;if(!i||"string"!=typeof i)throw new a.InvalidEventError("Answer ID must be a non-empty string");return r.id=i,r}return m(n,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:p({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new n({type:"org.matrix.sdk.poll.answer",content:A({id:e},o.M_TEXT.name,t)})}}]),n}(s.MessageEvent);t.PollAnswerSubevent=S;var w=function(e){v(n,e);var t=_(n);function n(e){var r;g(this,n),A(b(r=t.call(this,e)),"question",void 0),A(b(r),"kind",void 0),A(b(r),"rawKind",void 0),A(b(r),"maxSelections",void 0),A(b(r),"answers",void 0);var o=i.M_POLL_START.findIn(r.wireContent);if(!o.question)throw new a.InvalidEventError("A question is required");if(r.question=new s.MessageEvent({type:"org.matrix.sdk.poll.question",content:o.question}),r.rawKind=o.kind,i.M_POLL_KIND_DISCLOSED.matches(r.rawKind)?r.kind=i.M_POLL_KIND_DISCLOSED:r.kind=i.M_POLL_KIND_UNDISCLOSED,r.maxSelections=Number.isFinite(o.max_selections)&&o.max_selections>0?o.max_selections:1,!Array.isArray(o.answers))throw new a.InvalidEventError("Poll answers must be an array");var c=o.answers.slice(0,20).map((function(e){return new S({type:"org.matrix.sdk.poll.answer",content:e})}));if(c.length<=0)throw new a.InvalidEventError("No answers available");return r.answers=c,r}return m(n,[{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,i.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:i.M_POLL_START.name,content:(e={},A(e,i.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map((function(e){return e.serialize().content}))}),A(e,o.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map((function(e,t){return"".concat(t+1,". ").concat(e.text)})).join("\n"))),e)}}}],[{key:"from",value:function(e,t,r){var s,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new n({type:i.M_POLL_START.name,content:(s={},A(s,o.M_TEXT.name,e),A(s,i.M_POLL_START.name,{question:A({},o.M_TEXT.name,e),kind:r instanceof c.NamespacedValue?r.name:r,max_selections:a,answers:t.map((function(e){return A({id:(t=Array(16),function(e){if(Array.isArray(e))return d(e)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(e,t){if(e){if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d(e,t):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).map((function(){return I.charAt(Math.floor(Math.random()*I.length))})).join("")},o.M_TEXT.name,e);var t}))}),s)})}}]),n}(u.ExtensibleEvent);t.PollStartEvent=w;var I="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"},3776:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TEXT=t.M_NOTICE=t.M_MESSAGE=t.M_HTML=t.M_EMOTE=void 0;var r=n(8993),i=new r.UnstableValue("m.message","org.matrix.msc1767.message");t.M_MESSAGE=i;var s=new r.UnstableValue("m.text","org.matrix.msc1767.text");t.M_TEXT=s;var o=new r.UnstableValue("m.html","org.matrix.msc1767.html");t.M_HTML=o;var a=new r.UnstableValue("m.emote","org.matrix.msc1767.emote");t.M_EMOTE=a;var c=new r.UnstableValue("m.notice","org.matrix.msc1767.notice");t.M_NOTICE=c},5134:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var r=n(8993),i=new r.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");t.M_POLL_KIND_DISCLOSED=i;var s=new r.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");t.M_POLL_KIND_UNDISCLOSED=s;var o=new r.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");t.M_POLL_START=o;var a=new r.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");t.M_POLL_RESPONSE=a;var c=new r.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");t.M_POLL_END=c},6309:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=void 0;var r=new(n(8993).NamespacedValue)("m.reference");t.REFERENCE_RELATION=r},9787:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(9283);Object.keys(r).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))}));var i=n(3239);Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var s=n(8262);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var o=n(8993);Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var a=n(2670);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=n(2666);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=n(5556);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var u=n(6419);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var d=n(8980);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var h=n(3361);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var p=n(3449);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var g=n(6309);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var f=n(8474);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var m=n(3776);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var v=n(1624);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var y=n(1921);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var _=n(7985);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var b=n(5134);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var E=n(4560);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var A=n(8591);Object.keys(A).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===A[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return A[e]}}))}));var S=n(7055);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}))},8980:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LEGACY_M_ROOM_MESSAGE=void 0,t.parseMRoomMessage=function(e){var t,n,o;if(a.M_MESSAGE.findIn(e.content)||a.M_TEXT.findIn(e.content))return new r.MessageEvent(e);var c,d,h,p=null===(t=e.content)||void 0===t?void 0:t.msgtype,g=null===(n=e.content)||void 0===n?void 0:n.body,f="org.matrix.custom.html"===(null===(o=e.content)||void 0===o?void 0:o.format)?e.content.formatted_body:null;return"m.text"===p?new r.MessageEvent(l(l({},e),{},{content:l(l({},e.content),{},(c={},u(c,a.M_TEXT.name,g),u(c,a.M_HTML.name,f),c))})):"m.notice"===p?new i.NoticeEvent(l(l({},e),{},{content:l(l({},e.content),{},(d={},u(d,a.M_TEXT.name,g),u(d,a.M_HTML.name,f),d))})):"m.emote"===p?new s.EmoteEvent(l(l({},e),{},{content:l(l({},e.content),{},(h={},u(h,a.M_TEXT.name,g),u(h,a.M_HTML.name,f),h))})):null};var r=n(1624),i=n(7985),s=n(1921),o=n(8993),a=n(3776);function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=new o.NamespacedValue("m.room.message");t.LEGACY_M_ROOM_MESSAGE=d},3361:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMMessage=function(e){return i.M_EMOTE.matches(e.type)?new s.EmoteEvent(e):i.M_NOTICE.matches(e.type)?new o.NoticeEvent(e):new r.MessageEvent(e)};var r=n(1624),i=n(3776),s=n(1921),o=n(7985)},3449:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMPoll=function(e){return r.M_POLL_START.matches(e.type)?new i.PollStartEvent(e):r.M_POLL_RESPONSE.matches(e.type)?new s.PollResponseEvent(e):r.M_POLL_END.matches(e.type)?new o.PollEndEvent(e):null};var r=n(5134),i=n(4560),s=n(8591),o=n(7055)},2666:(e,t)=>{"use strict";function n(e){return null!=e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=function(e){return n(e)&&"string"==typeof e},t.isProvided=n},5556:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyMsgType=void 0,t.isEventLike=function(e,t){var n=e.content;return t===r.Text?i.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&"m.text"===(null==n?void 0:n.msgtype):t===r.Emote?i.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&"m.emote"===(null==n?void 0:n.msgtype):t===r.Notice&&(i.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&"m.notice"===(null==n?void 0:n.msgtype))};var r,i=n(3776);t.LegacyMsgType=r,function(e){e.Text="m.text",e.Notice="m.notice",e.Emote="m.emote"}(r||(t.LegacyMsgType=r={}))},6419:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEventTypeSame=function(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);var n=t,r=e;return n.matches(r.name)||n.matches(r.altName)}},2496:(e,t)=>{"use strict";let n,r,i,s,o,a;Object.defineProperty(t,"__esModule",{value:!0}),t.TweakName=t.RuleId=t.PushRuleKind=t.PushRuleActionName=t.DMMemberCountCondition=t.ConditionOperator=t.ConditionKind=void 0,t.isDmMemberCountCondition=function(e){return"==2"===e||"2"===e},t.PushRuleActionName=n,function(e){e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce"}(n||(t.PushRuleActionName=n={})),t.TweakName=r,function(e){e.Highlight="highlight",e.Sound="sound"}(r||(t.TweakName=r={})),t.ConditionOperator=i,function(e){e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<="}(i||(t.ConditionOperator=i={})),t.DMMemberCountCondition="2",t.ConditionKind=s,function(e){e.EventMatch="event_match",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission"}(s||(t.ConditionKind=s={})),t.PushRuleKind=o,function(e){e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride"}(o||(t.PushRuleKind=o={})),t.RuleId=a,function(e){e.Master=".m.rule.master",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone"}(a||(t.RuleId=a={}))},4643:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_BEACON_INFO=t.M_BEACON=void 0;var r=n(7259);const i=new r.UnstableValue("m.beacon_info","org.matrix.msc3672.beacon_info");t.M_BEACON_INFO=i;const s=new r.UnstableValue("m.beacon","org.matrix.msc3672.beacon");t.M_BEACON=s},4703:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UNSTABLE_MSC3089_TREE_SUBTYPE=t.UNSTABLE_MSC3089_LEAF=t.UNSTABLE_MSC3089_BRANCH=t.UNSTABLE_MSC3088_PURPOSE=t.UNSTABLE_MSC3088_ENABLED=t.UNSTABLE_MSC2716_MARKER=t.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=t.RoomType=t.RoomCreateTypeField=t.RelationType=t.PUSHER_ENABLED=t.PUSHER_DEVICE_ID=t.MsgType=t.LOCAL_NOTIFICATION_SETTINGS_PREFIX=t.EventType=t.EVENT_VISIBILITY_CHANGE_TYPE=void 0;var r=n(7259);let i,s,o,a;t.EventType=i,function(e){e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomAliases="m.room.aliases",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy"}(i||(t.EventType=i={})),t.RelationType=s,function(e){e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread"}(s||(t.RelationType=s={})),t.MsgType=o,function(e){e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request"}(o||(t.MsgType=o={})),t.RoomCreateTypeField="type",t.RoomType=a,function(e){e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video"}(a||(t.RoomType=a={}));const c=new r.UnstableValue("m.room.purpose","org.matrix.msc3088.purpose");t.UNSTABLE_MSC3088_PURPOSE=c;const l=new r.UnstableValue("m.enabled","org.matrix.msc3088.enabled");t.UNSTABLE_MSC3088_ENABLED=l;const u=new r.UnstableValue("m.data_tree","org.matrix.msc3089.data_tree");t.UNSTABLE_MSC3089_TREE_SUBTYPE=u;const d=new r.UnstableValue("m.leaf","org.matrix.msc3089.leaf");t.UNSTABLE_MSC3089_LEAF=d;const h=new r.UnstableValue("m.branch","org.matrix.msc3089.branch");t.UNSTABLE_MSC3089_BRANCH=h;const p=new r.UnstableValue("m.room.marker","org.matrix.msc2716.marker");t.UNSTABLE_MSC2716_MARKER=p;const g=new r.UnstableValue("io.element.functional_members","io.element.functional_members");t.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=g;const f=new r.UnstableValue("m.visibility","org.matrix.msc3531.visibility");t.EVENT_VISIBILITY_CHANGE_TYPE=f;const m=new r.UnstableValue("enabled","org.matrix.msc3881.enabled");t.PUSHER_ENABLED=m;const v=new r.UnstableValue("device_id","org.matrix.msc3881.device_id");t.PUSHER_DEVICE_ID=v;const y=new r.UnstableValue("m.local_notification_settings","org.matrix.msc3890.local_notification_settings");t.LOCAL_NOTIFICATION_SETTINGS_PREFIX=y},3368:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TEXT_NODE_TYPE=void 0;const r=new(n(7259).UnstableValue)("m.text","org.matrix.msc1767.text");t.TEXT_NODE_TYPE=r},9668:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TIMESTAMP=t.M_LOCATION=t.M_ASSET=t.LocationAssetType=void 0;var r=n(7259);let i;n(3368),t.LocationAssetType=i,function(e){e.Self="m.self",e.Pin="m.pin"}(i||(t.LocationAssetType=i={}));const s=new r.UnstableValue("m.asset","org.matrix.msc3488.asset");t.M_ASSET=s;const o=new r.UnstableValue("m.ts","org.matrix.msc3488.ts");t.M_TIMESTAMP=o;const a=new r.UnstableValue("m.location","org.matrix.msc3488.location");t.M_LOCATION=a},8673:(e,t)=>{"use strict";let n,r,i,s,o,a;Object.defineProperty(t,"__esModule",{value:!0}),t.Visibility=t.RestrictedAllowType=t.Preset=t.JoinRule=t.HistoryVisibility=t.GuestAccess=void 0,t.Visibility=n,function(e){e.Public="public",e.Private="private"}(n||(t.Visibility=n={})),t.Preset=r,function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(r||(t.Preset=r={})),t.JoinRule=i,function(e){e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted"}(i||(t.JoinRule=i={})),t.RestrictedAllowType=s,function(e){e.RoomMembership="m.room_membership"}(s||(t.RestrictedAllowType=s={})),t.GuestAccess=o,function(e){e.CanJoin="can_join",e.Forbidden="forbidden"}(o||(t.GuestAccess=o={})),t.HistoryVisibility=a,function(e){e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable"}(a||(t.HistoryVisibility=a={}))},251:(e,t)=>{"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiptType=void 0,t.ReceiptType=n,function(e){e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="m.read.private"}(n||(t.ReceiptType=n={}))},7465:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},4179:(e,t)=>{"use strict";var n;let r;Object.defineProperty(t,"__esModule",{value:!0}),t.SearchOrderBy=void 0,function(e){e.RoomId="room_id",e.Sender="sender"}(n||(n={})),t.SearchOrderBy=r,function(e){e.Recent="recent",e.Rank="rank"}(r||(t.SearchOrderBy=r={}))},2956:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TOPIC=void 0;const r=new(n(7259).UnstableValue)("m.topic","org.matrix.msc3765.topic");t.M_TOPIC=r},7259:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.ServerControlledNamespacedValue=t.NamespacedValue=void 0;var i=r(n(3693));class s{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){const e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}t.NamespacedValue=s,t.ServerControlledNamespacedValue=class extends s{constructor(...e){super(...e),(0,i.default)(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}},t.UnstableValue=class extends s{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}},2300:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.TypedReEmitter=t.ReEmitter=void 0;var i=r(n(3693));class s{constructor(e){this.target=e,(0,i.default)(this,"reEmitters",new Map)}reEmit(e,t){let n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));for(const r of t){const t=(...t)=>{"error"===r&&0===this.target.listenerCount("error")||this.target.emit(r,...t,e)};e.on(r,t),n.set(r,t)}}stopReEmitting(e,t){const n=this.reEmitters.get(e);if(n){for(const r of t)e.off(r,n.get(r)),n.delete(r);0===n.size&&this.reEmitters.delete(e)}}}t.ReEmitter=s,t.TypedReEmitter=class extends s{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}},2656:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceMessageQueue=void 0;var i=r(n(3693)),s=n(9849),o=n(7703);t.ToDeviceMessageQueue=class{constructor(e){this.client=e,(0,i.default)(this,"sending",!1),(0,i.default)(this,"running",!0),(0,i.default)(this,"retryTimeout",null),(0,i.default)(this,"retryAttempts",0),(0,i.default)(this,"sendQueue",(async()=>{if(null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.sending||!this.running)return;let e;s.logger.debug("Attempting to send queued to-device messages"),this.sending=!0;try{for(;this.running&&(e=await this.client.store.getOldestToDeviceBatch(),null!==e);)await this.sendBatch(e),await this.client.store.removeToDeviceBatch(e.id),this.retryAttempts=0;if(!this.running)return;s.logger.debug("All queued to-device messages sent")}catch(t){++this.retryAttempts;const n=o.MatrixScheduler.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,t);if(-1===n)return void(4===Math.floor(t.httpStatus/100)?(s.logger.error("Fatal error when sending to-device message - dropping to-device batch!",t),await this.client.store.removeToDeviceBatch(e.id)):s.logger.info("Automatic retry limit reached for to-device messages."));s.logger.info(`Failed to send batch of to-device messages. Will retry in ${n}ms`,t),this.retryTimeout=setTimeout(this.sendQueue,n)}finally{this.sending=!1}}))}start(){this.running=!0,this.sendQueue()}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null}async queueBatch(e){const t=[];for(let n=0;n<e.batch.length;n+=20)t.push({eventType:e.eventType,batch:e.batch.slice(n,n+20),txnId:this.client.makeTxnId()});await this.client.store.saveToDeviceBatches(t),this.sendQueue()}async sendBatch(e){const t={};for(const n of e.batch)t[n.userId]||(t[n.userId]={}),t[n.userId][n.deviceId]=n.payload;s.logger.info(`Sending batch of ${e.batch.length} to-device messages with ID ${e.id}`),await this.client.sendToDevice(e.eventType,t,e.txnId)}}},3014:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.AutoDiscoveryAction=t.AutoDiscovery=void 0;var i=r(n(3693)),s=n(9849);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let c;t.AutoDiscoveryAction=c,function(e){e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR"}(c||(t.AutoDiscoveryAction=c={}));class l{static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:l.FAIL_ERROR,error:l.ERROR_INVALID,base_url:null},"m.identity_server":{state:l.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return s.logger.error("No m.homeserver key in config"),t["m.homeserver"].state=l.FAIL_PROMPT,t["m.homeserver"].error=l.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return s.logger.error("No m.homeserver base_url in config"),t["m.homeserver"].state=l.FAIL_PROMPT,t["m.homeserver"].error=l.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const n=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!n)return s.logger.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=l.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const r=await this.fetchWellKnownObject(`${n}/_matrix/client/versions`);if(!r||!r.raw.versions)return s.logger.error("Invalid /versions response"),t["m.homeserver"].error=l.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=n,Promise.resolve(t);t["m.homeserver"]={state:l.SUCCESS,error:null,base_url:n};let i="";if(e["m.identity_server"]){const n={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:l.FAIL_PROMPT,error:l.ERROR_INVALID_IS,base_url:null}};if(i=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!i)return s.logger.error("Invalid base_url for m.identity_server"),n["m.identity_server"].error=l.ERROR_INVALID_IS_BASE_URL,Promise.resolve(n);const r=await this.fetchWellKnownObject(`${i}/_matrix/identity/api/v1`);if(!r||!r.raw||r.action!==c.SUCCESS)return s.logger.error("Invalid /api/v1 response"),n["m.identity_server"].error=l.ERROR_INVALID_IDENTITY_SERVER,n["m.identity_server"].base_url=i,Promise.resolve(n)}return i&&i.toString().length>0&&(t["m.identity_server"]={state:l.SUCCESS,error:null,base_url:i}),Object.keys(e).forEach((n=>{if("m.homeserver"===n||"m.identity_server"===n){const r=["error","state","base_url"];for(const i of Object.keys(e[n]))r.includes(i)||(t[n][i]=e[n][i])}else t[n]=e[n]})),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:l.FAIL_ERROR,error:l.ERROR_INVALID,base_url:null},"m.identity_server":{state:l.PROMPT,error:null,base_url:null}},n=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return n&&n.action===c.SUCCESS?l.fromDiscoveryConfig(n.raw):(s.logger.error("No response or error when parsing .well-known"),n.reason&&s.logger.error(n.reason),n.action===c.IGNORE?t["m.homeserver"]={state:l.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=l.FAIL_PROMPT,t["m.homeserver"].error=l.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{let t=null;try{t=new URL(e)}catch(e){s.logger.error("Could not parse url",e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;const n=t.port?`:${t.port}`:"",r=t.pathname?t.pathname:"";let i=`${t.protocol}//${t.hostname}${n}${r}`;return i.endsWith("/")&&(i=i.substring(0,i.length-1)),i}catch(e){return s.logger.error(e),!1}}static fetchWellKnownObject(e){return new Promise((t=>{const r=n(2660).getRequest();if(!r)throw new Error("No request library available");r({method:"GET",uri:e,timeout:5e3},((e,n,r)=>{if(e||(null==n?void 0:n.statusCode)<200||(null==n?void 0:n.statusCode)>=300){const r={error:e,raw:{}};return t(404===(null==n?void 0:n.statusCode)?a(a({},r),{},{action:c.IGNORE,reason:l.ERROR_MISSING_WELLKNOWN}):a(a({},r),{},{action:c.FAIL_PROMPT,reason:(null==e?void 0:e.message)||"General failure"}))}try{return t({raw:JSON.parse(r),action:c.SUCCESS})}catch(e){return t({error:e,raw:{},action:c.FAIL_PROMPT,reason:"SyntaxError"===(null==e?void 0:e.name)?l.ERROR_INVALID_JSON:l.ERROR_INVALID})}}))}))}}t.AutoDiscovery=l,(0,i.default)(l,"ERROR_INVALID","Invalid homeserver discovery response"),(0,i.default)(l,"ERROR_GENERIC_FAILURE","Failed to get autodiscovery configuration from server"),(0,i.default)(l,"ERROR_INVALID_HS_BASE_URL","Invalid base_url for m.homeserver"),(0,i.default)(l,"ERROR_INVALID_HOMESERVER","Homeserver URL does not appear to be a valid Matrix homeserver"),(0,i.default)(l,"ERROR_INVALID_IS_BASE_URL","Invalid base_url for m.identity_server"),(0,i.default)(l,"ERROR_INVALID_IDENTITY_SERVER","Identity server URL does not appear to be a valid identity server"),(0,i.default)(l,"ERROR_INVALID_IS","Invalid identity server discovery response"),(0,i.default)(l,"ERROR_MISSING_WELLKNOWN","No .well-known JSON file found"),(0,i.default)(l,"ERROR_INVALID_JSON","Invalid JSON"),(0,i.default)(l,"ALL_ERRORS",[l.ERROR_INVALID,l.ERROR_GENERIC_FAILURE,l.ERROR_INVALID_HS_BASE_URL,l.ERROR_INVALID_HOMESERVER,l.ERROR_INVALID_IS_BASE_URL,l.ERROR_INVALID_IDENTITY_SERVER,l.ERROR_INVALID_IS,l.ERROR_MISSING_WELLKNOWN,l.ERROR_INVALID_JSON]),(0,i.default)(l,"FAIL_ERROR",c.FAIL_ERROR),(0,i.default)(l,"FAIL_PROMPT",c.FAIL_PROMPT),(0,i.default)(l,"PROMPT",c.PROMPT),(0,i.default)(l,"SUCCESS",c.SUCCESS)},7964:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0});var i={};t.default=void 0;var s=r(n(7063)),o=r(n(5373)),a=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=c(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(2660));function c(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(c=function(e){return e?n:t})(e)}if(Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))})),a.getRequest())throw new Error("Multiple matrix-js-sdk entrypoints detected!");let l;a.request((function(e,t){return e.qs=o.default.stringify(e.qs||{},e.qsStringifyOptions),(0,s.default)(e,t)}));try{l=n.g.indexedDB}catch(e){}l&&a.setCryptoStoreFactory((function(){return new a.IndexedDBCryptoStore(l,"matrix-js-sdk:crypto")}));var u=a;t.default=u,n.g.matrixcs=a},642:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomVersionStability=t.PendingEventOrdering=t.MatrixClient=t.M_AUTHENTICATION=t.ClientEvent=t.CRYPTO_ENABLED=void 0;var i=r(n(3693)),s=n(9787),o=n(7314),a=n(224),c=n(1031),l=n(9435),u=n(2763),d=n(7367),h=X(n(4148)),p=n(6418),g=n(5889),f=n(3014),m=X(n(1978)),v=n(2300),y=n(3408),_=n(9849),b=n(2118),E=n(84),A=n(8091),S=n(5905),w=n(6891),I=n(8057),T=n(7777),k=n(1082),R=n(5392),O=n(2660),C=n(319),P=X(n(9228)),D=n(4703),N=n(8673),x=n(6387),M=n(3759),L=n(5849),B=n(3211),U=n(4179),F=n(2496),j=n(2547),q=n(7022),K=n(251),$=n(9818),V=n(990),G=n(4643),H=n(7259),W=n(2656),J=n(103),Y=n(1519);function z(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(z=function(e){return e?n:t})(e)}function X(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=z(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}function Q(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Z(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Q(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const ee=(0,A.isCryptoAvailable)();t.CRYPTO_ENABLED=ee;const te=6e5;let ne,re;var ie;t.PendingEventOrdering=ne,function(e){e.Chronological="chronological",e.Detached="detached"}(ne||(t.PendingEventOrdering=ne={})),t.RoomVersionStability=re,function(e){e.Stable="stable",e.Unstable="unstable"}(re||(t.RoomVersionStability=re={})),function(e){e.MasterKey="master_key",e.SelfSigningKey="self_signing_key",e.UserSigningKey="user_signing_key"}(ie||(ie={}));const se=new H.UnstableValue("m.authentication","org.matrix.msc2965.authentication");t.M_AUTHENTICATION=se;const oe="$";let ae;t.ClientEvent=ae,function(e){e.Sync="sync",e.Event="event",e.ToDeviceEvent="toDeviceEvent",e.AccountData="accountData",e.Room="Room",e.DeleteRoom="deleteRoom",e.SyncUnexpectedError="sync.unexpectedError",e.ClientWellKnown="WellKnown.client",e.TurnServers="turnServers",e.TurnServersError="turnServers.error"}(ae||(t.ClientEvent=ae={}));const ce=new H.UnstableValue("action","org.matrix.msc3824.action");class le extends q.TypedEventEmitter{constructor(e){super(),(0,i.default)(this,"reEmitter",new v.TypedReEmitter(this)),(0,i.default)(this,"olmVersion",null),(0,i.default)(this,"usingExternalCrypto",!1),(0,i.default)(this,"store",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"credentials",void 0),(0,i.default)(this,"pickleKey",void 0),(0,i.default)(this,"scheduler",void 0),(0,i.default)(this,"clientRunning",!1),(0,i.default)(this,"timelineSupport",!1),(0,i.default)(this,"urlPreviewCache",{}),(0,i.default)(this,"identityServer",void 0),(0,i.default)(this,"http",void 0),(0,i.default)(this,"crypto",void 0),(0,i.default)(this,"cryptoCallbacks",void 0),(0,i.default)(this,"callEventHandler",void 0),(0,i.default)(this,"supportsCallTransfer",!1),(0,i.default)(this,"forceTURN",!1),(0,i.default)(this,"iceCandidatePoolSize",0),(0,i.default)(this,"idBaseUrl",void 0),(0,i.default)(this,"baseUrl",void 0),(0,i.default)(this,"canSupportVoip",!1),(0,i.default)(this,"peekSync",null),(0,i.default)(this,"isGuestAccount",!1),(0,i.default)(this,"ongoingScrollbacks",{}),(0,i.default)(this,"notifTimelineSet",null),(0,i.default)(this,"cryptoStore",void 0),(0,i.default)(this,"verificationMethods",void 0),(0,i.default)(this,"fallbackICEServerAllowed",!1),(0,i.default)(this,"roomList",void 0),(0,i.default)(this,"syncApi",void 0),(0,i.default)(this,"roomNameGenerator",void 0),(0,i.default)(this,"pushRules",void 0),(0,i.default)(this,"syncLeftRoomsPromise",void 0),(0,i.default)(this,"syncedLeftRooms",!1),(0,i.default)(this,"clientOpts",void 0),(0,i.default)(this,"clientWellKnownIntervalID",void 0),(0,i.default)(this,"canResetTimelineCallback",void 0),(0,i.default)(this,"pushProcessor",new g.PushProcessor(this)),(0,i.default)(this,"serverVersionsPromise",void 0),(0,i.default)(this,"cachedCapabilities",void 0),(0,i.default)(this,"clientWellKnown",void 0),(0,i.default)(this,"clientWellKnownPromise",void 0),(0,i.default)(this,"turnServers",[]),(0,i.default)(this,"turnServersExpiry",0),(0,i.default)(this,"checkTurnServersIntervalID",null),(0,i.default)(this,"exportedOlmDeviceToImport",void 0),(0,i.default)(this,"txnCtr",0),(0,i.default)(this,"mediaHandler",new j.MediaHandler(this)),(0,i.default)(this,"pendingEventEncryption",new Map),(0,i.default)(this,"toDeviceMessageQueue",void 0),(0,i.default)(this,"ignoredInvites",void 0),(0,i.default)(this,"startCallEventHandler",(()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.off(ae.Sync,this.startCallEventHandler))})),e.baseUrl=h.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=h.ensureNoTrailingSlash(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=e.usingExternalCrypto,this.store=e.store||new c.StubStore,this.deviceId=e.deviceId||null;const t=e.userId||null;this.credentials={userId:t},this.http=new E.MatrixHttpApi(this,{baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:E.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?_.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?_.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):_.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((async e=>{const t=this.getRoom(e.getRoomId());e.status!==a.EventStatus.SENDING&&this.updatePendingEventStatus(t,e,a.EventStatus.SENDING);const n=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,a.EventStatus.SENT,n.event_id),n})),(0,l.supportsMatrixCall)()&&(this.callEventHandler=new d.CallEventHandler(this),this.canSupportVoip=!0,this.on(ae.Sync,this.startCallEventHandler)),this.timelineSupport=Boolean(e.timelineSupport),this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.roomList=new y.RoomList(this.cryptoStore),this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new W.ToDeviceMessageQueue(this),this.on(a.MatrixEventEvent.Decrypted,(e=>{var t,n;const r=e.getPushActions(),i=this.getPushActionsForEvent(e,!0),s=this.getRoom(e.getRoomId());if(!s)return;const o=s.getUnreadNotificationCount(O.NotificationCountType.Highlight),a=!(null==r||null===(t=r.tweaks)||void 0===t||!t.highlight),c=!(null==i||null===(n=i.tweaks)||void 0===n||!n.highlight);if((a!==c||o>0)&&!s.hasUserReadEvent(this.getUserId(),e.getId())){let e=o;c&&!a&&e++,!c&&a&&e--,s.setUnreadNotificationCount(O.NotificationCountType.Highlight,e),s.getUnreadNotificationCount(O.NotificationCountType.Total)<e&&s.setUnreadNotificationCount(O.NotificationCountType.Total,e)}})),this.on(O.RoomEvent.Receipt,((e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const n=e.getContent();if(!(Object.keys(n).filter((e=>{for(const[t,r]of Object.entries(n[e]))if(h.isSupportedReceiptType(t)&&r&&Object.keys(r).includes(this.getUserId()))return!0;return!1})).length>0))return;const r=20,i=t.getLiveTimeline().getEvents();let s=0;for(let e=i.length-1;e>=0;e--){if(e===i.length-r)return;const n=i[e];if(t.hasUserReadEvent(this.getUserId(),n.getId()))break;const o=this.getPushActionsForEvent(n);s+=o.tweaks&&o.tweaks.highlight?1:0}t.setUnreadNotificationCount(O.NotificationCountType.Highlight,s)}})),this.ignoredInvites=new Y.IgnoredInvites(this)}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new I.User(t)),this.crypto&&(this.crypto.uploadDeviceKeys(),this.crypto.start()),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval((()=>{this.checkTurnServers()}),te),this.checkTurnServers()),this.syncApi&&(_.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{const{serverSupport:e,stable:t}=await this.doesServerSupportThread();V.Thread.setServerSideSupport(e,t)}catch(e){V.Thread.setServerSideSupport(!1,!0)}this.clientOpts=Object.assign({},e),this.clientOpts.crypto=this.crypto,this.clientOpts.canResetEntireTimeline=e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),this.clientOpts.slidingSync?this.syncApi=new $.SlidingSyncSdk(this.clientOpts.slidingSync,this,this.clientOpts):this.syncApi=new o.SyncApi(this,this.clientOpts),this.syncApi.sync(),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval((()=>{this.fetchClientWellKnown()}),1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start()}stopClient(){var e,t,r,i;null===(e=this.crypto)||void 0===e||e.stop(),this.clientRunning&&(_.logger.log("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=null,null===(r=this.peekSync)||void 0===r||r.stopPeeking(),null===(i=this.callEventHandler)||void 0===i||i.stop(),this.callEventHandler=null,n.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=null,void 0!==this.clientWellKnownIntervalID&&n.g.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop())}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const e=await this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id)return void _.logger.info("no dehydrated device found");const t=new n.g.Olm.Account;try{const n=e.device_data;if(n.algorithm!==R.DEHYDRATION_ALGORITHM)return void _.logger.warn("Wrong algorithm for dehydrated device");_.logger.log("unpickling dehydrated device");const r=await this.cryptoCallbacks.getDehydrationKey(n,(e=>{t.unpickle(new Uint8Array(e),n.account)}));if(t.unpickle(r,n.account),_.logger.log("unpickled device"),!0===(await this.http.authedRequest(void 0,E.Method.Post,"/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=e.device_id,_.logger.info("using dehydrated device");const n=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:t.pickle(n),sessions:[],pickleKey:n},t.free(),this.deviceId}return t.free(),void _.logger.info("not using dehydrated device")}catch(e){t.free(),_.logger.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(void 0,E.Method.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void _.logger.info("could not get dehydrated device",e.toString())}}setDehydrationKey(e,t,n){if(this.crypto)return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,n);_.logger.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,n){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,n),this.crypto.dehydrationManager.dehydrateDevice();_.logger.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};_.logger.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}createCall(e){return(0,l.createNewMatrixCall)(this,e)}getSyncState(){return this.syncApi?this.syncApi.getSyncState():null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===o.SyncState.Prepared||e===o.SyncState.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){return this.toDeviceMessageQueue.sendQueue(),this.syncApi.retryImmediately()}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){const t=(new Date).getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(_.logger.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(void 0,E.Method.Get,"/capabilities").catch((e=>{_.logger.error(e)})).then(((e={})=>{const n=e.capabilities||{},r=Object.keys(n).length?216e5:6e4+5e3*Math.random();return this.cachedCapabilities={capabilities:n,expiration:t+r},_.logger.log("Caching capabilities: ",n),n}))}async initCrypto(){if(!(0,A.isCryptoAvailable)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.crypto)return void _.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");_.logger.log("Crypto: Starting up crypto store..."),await this.cryptoStore.startup(),_.logger.log("Crypto: initialising roomlist..."),await this.roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new A.Crypto(this,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,[A.CryptoEvent.KeyBackupFailed,A.CryptoEvent.KeyBackupSessionsRemaining,A.CryptoEvent.RoomKeyRequest,A.CryptoEvent.RoomKeyRequestCancellation,A.CryptoEvent.Warning,A.CryptoEvent.DevicesUpdated,A.CryptoEvent.WillUpdateDevices,A.CryptoEvent.DeviceVerificationChanged,A.CryptoEvent.UserTrustStatusChanged,A.CryptoEvent.KeysChanged]),_.logger.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=A.Crypto.getOlmVersion(),t.registerEventHandlers(this),this.crypto=t}isCryptoEnabled(){return!!this.crypto}getDeviceEd25519Key(){return this.crypto?this.crypto.getDeviceEd25519Key():null}getDeviceCurve25519Key(){return this.crypto?this.crypto.getDeviceCurve25519Key():null}async uploadKeys(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.uploadDeviceKeys()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,n=!0){const r=this.setDeviceVerification(e,t,n,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),r}setDeviceBlocked(e,t,n=!0){return this.setDeviceVerification(e,t,null,n,null)}setDeviceKnown(e,t,n=!0){return this.setDeviceVerification(e,t,null,null,n)}async setDeviceVerification(e,t,n,r,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,n,r,i)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,n)}checkSecretStorageKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalBlacklistUnverifiedDevices(e)}getGlobalBlacklistUnverifiedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalBlacklistUnverifiedDevices()}setGlobalErrorOnUnknownDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalErrorOnUnknownDevices(e)}getGlobalErrorOnUnknownDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalErrorOnUnknownDevices()}getCrossSigningId(e=C.CrossSigningKey.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,n)}prepareToEncrypt(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.prepareToEncrypt(e)}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(e,t,n)}hasSecretStorageKey(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(e)}storeSecret(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(e,t,n)}getSecret(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(e)}isSecretStored(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}cancelAndResendEventRoomKeyRequest(e){return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){const t=this.getRoom(e);return!!t&&(!!t.currentState.getStateEvents(D.EventType.RoomEncryption,"")||this.roomList.isRoomEncrypted(e))}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");this.crypto.forceDiscardSession(e)}exportRoomKeys(){return this.crypto?this.crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(void 0,E.Method.Get,"/room_keys/version",void 0,void 0,{prefix:E.PREFIX_UNSTABLE})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}return L.BackupManager.checkBackupVersion(e),e}isKeyBackupTrusted(e){return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:n,auth_data:r,recovery_key:i,privateKey:s}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.storeSecret("m.megolm_backup.v1",(0,m.encodeBase64)(s)),_.logger.info("Key backup private key stored in secret storage")),{algorithm:n,auth_data:r,recovery_key:i}}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const n=await this.http.authedRequest(void 0,E.Method.Post,"/room_keys/version",void 0,t,{prefix:E.PREFIX_UNSTABLE});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||_.logger.error("Key backup not usable even though we just created it"),n}deleteKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();const t=h.encodeUri("/room_keys/version/$version",{$version:e});return this.http.authedRequest(void 0,E.Method.Delete,t,void 0,void 0,{prefix:E.PREFIX_UNSTABLE})}makeKeyBackupPath(e,t,n){let r;return r=void 0!==t?h.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?h.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",{path:r,queryData:void 0===n?void 0:{version:n}}}sendKeyBackup(e,t,n,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=this.makeKeyBackupPath(e,t,n);return this.http.authedRequest(void 0,E.Method.Put,i.path,i.queryData,r,{prefix:E.PREFIX_UNSTABLE})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return(0,S.decodeRecoveryKey)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return(0,w.keyFromAuthData)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return(0,S.decodeRecoveryKey)(e)}async restoreKeyBackupWithPassword(e,t,n,r,i){const s=await(0,w.keyFromAuthData)(r.auth_data,e);return this.restoreKeyBackup(s,t,n,r,i)}async restoreKeyBackupWithSecretStorage(e,t,n,r){const i=await this.getSecret("m.megolm_backup.v1"),s=(0,A.fixBackupKey)(i);if(s){const[e]=await this.crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",s,[e])}const o=(0,m.decodeBase64)(s||i);return this.restoreKeyBackup(o,t,n,e,r)}restoreKeyBackupWithRecoveryKey(e,t,n,r,i){const s=(0,S.decodeRecoveryKey)(e);return this.restoreKeyBackup(s,t,n,r,i)}async restoreKeyBackupWithCache(e,t,n,r){const i=await this.crypto.getSessionBackupPrivateKey();if(!i)throw new Error("Couldn't get key");return this.restoreKeyBackup(i,e,t,n,r)}async restoreKeyBackup(e,t,n,r,i){const s=null==i?void 0:i.cacheCompleteCallback,o=null==i?void 0:i.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let a=0,c=[];const l=this.makeKeyBackupPath(t,n,r.version),u=await L.BackupManager.makeAlgorithm(r,(async()=>e)),d=u.untrusted;try{if(!await u.keyMatches(e))return Promise.reject(new E.MatrixError({errcode:le.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch((e=>{_.logger.warn("Error caching session backup key:",e)})).then(s),o&&o({stage:"fetch"});const r=await this.http.authedRequest(void 0,E.Method.Get,l.path,l.queryData,void 0,{prefix:E.PREFIX_UNSTABLE});if(r.rooms){const e=r.rooms;for(const[t,n]of Object.entries(e)){if(!n.sessions)continue;a+=Object.keys(n.sessions).length;const e=await u.decryptSessions(n.sessions);for(const n of e)n.room_id=t,c.push(n)}}else if(r.sessions){const e=r.sessions;a=Object.keys(e).length,c=await u.decryptSessions(e);for(const e of c)e.room_id=t}else{a=1;try{const[e]=await u.decryptSessions({[n]:r});e.room_id=t,e.session_id=n,c.push(e)}catch(e){_.logger.log("Failed to decrypt megolm session from backup",e)}}}finally{u.free()}return await this.importRoomKeys(c,{progressCallback:o,untrusted:d,source:"backup"}),await this.checkKeyBackup(),{total:a,imported:c.length}}deleteKeysFromBackup(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const r=this.makeKeyBackupPath(e,t,n);return this.http.authedRequest(void 0,E.Method.Delete,r.path,r.queryData,void 0,{prefix:E.PREFIX_UNSTABLE})}async sendSharedHistoryKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.roomList.getRoomEncryption(e);if(!n)return void _.logger.error("Unknown room.  Not sharing decryption keys");const r=await this.crypto.downloadKeys(t),i={};for(const[e,t]of Object.entries(r))i[e]=Object.values(t);const s=this.crypto.getRoomDecryptor(e,n.algorithm);s.sendSharedHistoryInboundSessions?await s.sendSharedHistoryInboundSessions(i):_.logger.warn("Algorithm does not support sharing previous keys",n.algorithm)}getMediaConfig(e){return this.http.authedRequest(e,E.Method.Get,"/config",void 0,void 0,{prefix:E.PREFIX_MEDIA_R0})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){const e=this.store.getRooms(),t=new Set;for(const n of e){const e=n.currentState.getStateEvents(D.EventType.RoomCreate,"");if(e){const n=e.getContent().predecessor;n&&n.room_id&&t.add(n.room_id)}}return e.filter((e=>!e.currentState.getStateEvents(D.EventType.RoomTombstone,"")||!t.has(e.roomId)))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t,n){const r=h.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),i=(0,E.retryNetworkOperation)(5,(()=>this.http.authedRequest(void 0,E.Method.Put,r,void 0,t)));return n&&i.then((e=>n(null,e)),n),i}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=h.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(void 0,E.Method.Get,t)}catch(e){var n;if("M_NOT_FOUND"===(null===(n=e.data)||void 0===n?void 0:n.errcode))return null;throw e}}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e,t){const n={ignored_users:{}};return e.forEach((e=>{n.ignored_users[e]={}})),this.setAccountData("m.ignored_user_list",n,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t,n){if(h.isFunction(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const r=this.getRoom(e);if(r&&r.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(r);let i=Promise.resolve();t.inviteSignUrl&&(i=this.http.requestOtherUrl(void 0,E.Method.Post,t.inviteSignUrl,{mxid:this.credentials.userId}));const s={};t.viaServers&&(s.server_name=t.viaServers);const a={qsStringifyOptions:{arrayFormat:"repeat"}};try{const r={},c=await i;c&&(r.third_party_signed=c);const l=h.encodeUri("/join/$roomid",{$roomid:e}),u=(await this.http.authedRequest(void 0,E.Method.Post,l,s,r,a)).room_id,d=new o.SyncApi(this,this.clientOpts).createRoom(u);return t.syncRoom,null==n||n(null,d),d}catch(e){throw null==n||n(e),e}}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,a.EventStatus.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![a.EventStatus.QUEUED,a.EventStatus.NOT_SENT,a.EventStatus.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===a.EventStatus.ENCRYPTING?this.pendingEventEncryption.delete(e.getId()):this.scheduler&&e.status===a.EventStatus.QUEUED&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,a.EventStatus.CANCELLED)}setRoomName(e,t,n){return this.sendStateEvent(e,D.EventType.RoomName,{name:t},void 0,n)}setRoomTopic(e,t,n){const r="function"==typeof n,i=r?void 0:n,s=r?n:void 0,o=P.makeTopicContent(t,i);return this.sendStateEvent(e,D.EventType.RoomTopic,o,void 0,s)}getRoomTags(e,t){const n=h.encodeUri("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(t,E.Method.Get,n)}setRoomTag(e,t,n,r){const i=h.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(r,E.Method.Put,i,void 0,n)}deleteRoomTag(e,t,n){const r=h.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(n,E.Method.Delete,r)}setRoomAccountData(e,t,n,r){const i=h.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(r,E.Method.Put,i,void 0,n)}setPowerLevel(e,t,n,r,i){let s={users:{}};(null==r?void 0:r.getType())===D.EventType.RoomPowerLevels&&(s=h.deepCopy(r.getContent())),s.users[t]=n;const o=h.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(i,E.Method.Put,o,void 0,s)}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){const n=this.getUserId();return this.sendStateEvent(e,G.M_BEACON_INFO.name,t,n)}sendEvent(e,t,n,r,i,s){var o,a;if(null!==(o=t)&&void 0!==o&&o.startsWith(oe)||null===t||(s=i,i=r,r=n,n=t,t=null),t&&(null===(a=r["m.relates_to"])||void 0===a||!a.rel_type)){var c,l;const n=!(null===(c=r["m.relates_to"])||void 0===c||!c["m.in_reply_to"]);r["m.relates_to"]=Z(Z({},r["m.relates_to"]),{},{rel_type:V.THREAD_RELATION_TYPE.name,event_id:t,is_falling_back:!n});const i=null===(l=this.getRoom(e))||void 0===l?void 0:l.getThread(t);var u,d;i&&!n&&(r["m.relates_to"]["m.in_reply_to"]={event_id:null!==(u=null===(d=i.lastReply((e=>e.isRelation(V.THREAD_RELATION_TYPE.name)&&!e.status)))||void 0===d?void 0:d.getId())&&void 0!==u?u:t})}return this.sendCompleteEvent(e,t,{type:n,content:r},i,s)}sendCompleteEvent(e,t,n,r,i){h.isFunction(r)&&(i=r,r=void 0),r||(r=this.makeTxnId());const s=new a.MatrixEvent(Object.assign(n,{event_id:"~"+e+":"+r,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),c=null==o?void 0:o.getThread(t);c&&s.setThread(c),this.reEmitter.reEmit(s,[a.MatrixEventEvent.Replaced,a.MatrixEventEvent.VisibilityChange]),null==o||o.reEmitter.reEmit(s,[a.MatrixEventEvent.BeforeRedaction]);const l=s.getAssociatedId();if(null!=l&&l.startsWith("~")){const e=o.getPendingEvents().find((e=>e.getId()===l));e.once(a.MatrixEventEvent.LocalEventIdReplaced,(()=>{s.updateAssociatedId(e.getId())}))}const u=s.getType();return _.logger.log(`sendEvent of type ${u} in ${e} with txnId ${r}`),s.setTxnId(r),s.setStatus(a.EventStatus.SENDING),null==o||o.addPendingEvent(s,r),s.status===a.EventStatus.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,s,i)}encryptAndSendEvent(e,t,n){let r=!1;return Promise.resolve().then((()=>{const n=this.encryptEventIfNeeded(t,e);return n?(this.pendingEventEncryption.set(t.getId(),n),this.updatePendingEventStatus(e,t,a.EventStatus.ENCRYPTING),n.then((()=>{this.pendingEventEncryption.has(t.getId())?this.updatePendingEventStatus(e,t,a.EventStatus.SENDING):r=!0}))):null})).then((()=>{if(r)return{};let n;return this.scheduler&&(n=this.scheduler.queueEvent(t),n&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,a.EventStatus.QUEUED)),n||(n=this.sendEventHttpRequest(t),e&&(n=n.then((n=>(e.updatePendingEvent(t,a.EventStatus.SENT,n.event_id),n))))),n})).then((e=>(null==n||n(null,e),e))).catch((r=>{_.logger.error("Error sending event",r.stack||r);try{t.error=r,this.updatePendingEventStatus(e,t,a.EventStatus.NOT_SENT),r.event=t,null==n||n(r)}catch(e){_.logger.error("Exception in error handler!",e.stack||r)}throw r}))}encryptEventIfNeeded(e,t){if(e.isEncrypted())return null;if(e.isRedaction())return null;if(!this.isRoomEncrypted(e.getRoomId()))return null;if(!this.crypto&&this.usingExternalCrypto)return null;if(e.getType()===D.EventType.Reaction)return null;if(!this.crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.crypto.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===D.EventType.Reaction?t:this.isRoomEncrypted(e)?D.EventType.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const n={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let r;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),r=h.encodeUri(t,n)}else if(e.isRedaction()){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";r=h.encodeUri(t,Object.assign({$redactsEventId:e.event.redacts},n))}else r=h.encodeUri("/rooms/$roomId/send/$eventType/$txnId",n);return this.http.authedRequest(void 0,E.Method.Put,r,void 0,e.getWireContent()).then((t=>(_.logger.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t)))}redactEvent(e,t,n,r,i){var s;null!==(s=n)&&void 0!==s&&s.startsWith(oe)||(i=r,r=n,n=t,t=null);const o=("object"==typeof i?i:{}).reason,a="function"==typeof i?i:void 0;return this.sendCompleteEvent(e,t,{type:D.EventType.RoomRedaction,content:{reason:o},redacts:n},r,a)}sendMessage(e,t,n,r,i){"string"!=typeof t&&null!==t&&(i=r,r=n,n=t,t=null),h.isFunction(r)&&(i=r,r=void 0);let o=D.EventType.RoomMessage,a=n;const c=(e={},t=!0)=>{let n=null;if(e.msgtype===D.MsgType.Text?n=s.MessageEvent.from(e.body,e.formatted_body).serialize():e.msgtype===D.MsgType.Emote?n=s.EmoteEvent.from(e.body,e.formatted_body).serialize():e.msgtype===D.MsgType.Notice&&(n=s.NoticeEvent.from(e.body,e.formatted_body).serialize()),n&&e["m.new_content"]&&t){const t=c(e["m.new_content"],!1);t&&(n.content["m.new_content"]=t.content)}if(n)for(const[t,r]of Object.entries(e))n.content.hasOwnProperty(t)||(n.content[t]=r);return n},l=c(a);return l&&(o=l.type,a=l.content),this.sendEvent(e,t,o,a,r,i)}sendTextMessage(e,t,n,r,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(oe)||null===t||(i=r,r=n,n=t,t=null);const o=P.makeTextMessage(n);return this.sendMessage(e,t,o,r,i)}sendNotice(e,t,n,r,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(oe)||null===t||(i=r,r=n,n=t,t=null);const o=P.makeNotice(n);return this.sendMessage(e,t,o,r,i)}sendEmoteMessage(e,t,n,r,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(oe)||null===t||(i=r,r=n,n=t,t=null);const o=P.makeEmoteMessage(n);return this.sendMessage(e,t,o,r,i)}sendImageMessage(e,t,n,r,i="Image",s){var o;null!==(o=t)&&void 0!==o&&o.startsWith(oe)||null===t||(s=i,i=r||"Image",r=n,n=t,t=null),h.isFunction(i)&&(s=i,i=void 0);const a={msgtype:D.MsgType.Image,url:n,info:r,body:i};return this.sendMessage(e,t,a,void 0,s)}sendStickerMessage(e,t,n,r,i="Sticker",s){var o;null!==(o=t)&&void 0!==o&&o.startsWith(oe)||null===t||(s=i,i=r||"Sticker",r=n,n=t,t=null),h.isFunction(i)&&(s=i,i=void 0);const a={url:n,info:r,body:i};return this.sendEvent(e,t,D.EventType.Sticker,a,void 0,s)}sendHtmlMessage(e,t,n,r,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(oe)||null===t||(i=r,r=n,n=t,t=null);const o=P.makeHtmlMessage(n,r);return this.sendMessage(e,t,o,void 0,i)}sendHtmlNotice(e,t,n,r,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(oe)||null===t||(i=r,r=n,n=t,t=null);const o=P.makeHtmlNotice(n,r);return this.sendMessage(e,t,o,void 0,i)}sendHtmlEmote(e,t,n,r,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(oe)||null===t||(i=r,r=n,n=t,t=null);const o=P.makeHtmlEmote(n,r);return this.sendMessage(e,t,o,void 0,i)}async sendReceipt(e,t,n,r){if("function"==typeof n&&(r=n,n={}),this.isGuest())return Promise.resolve({});const i=h.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()});if(await this.doesServerSupportUnstableFeature("org.matrix.msc3771")){const t=!!e.threadRootId;n.thread_id=t?e.threadRootId:J.MAIN_ROOM_TIMELINE}const s=this.http.authedRequest(r,E.Method.Post,i,void 0,n||{}),o=this.getRoom(e.getRoomId());return o&&this.credentials.userId&&o.addLocalEchoReceipt(this.credentials.userId,e,t),s}async sendReadReceipt(e,t=K.ReceiptType.Read,n){if(!e)return;const r=e.getId(),i=this.getRoom(e.getRoomId());if(i&&i.hasPendingEvent(r))throw new Error(`Cannot set read receipt to a pending event (${r})`);return this.sendReceipt(e,t,{},n)}async setRoomReadMarkers(e,t,n,r){const i=this.getRoom(e);if(i&&i.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let s,o;if(n){if(s=n.getId(),null!=i&&i.hasPendingEvent(s))throw new Error(`Cannot set read receipt to a pending event (${s})`);null==i||i.addLocalEchoReceipt(this.credentials.userId,n,K.ReceiptType.Read)}if(r){if(o=r.getId(),null!=i&&i.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);null==i||i.addLocalEchoReceipt(this.credentials.userId,r,K.ReceiptType.ReadPrivate)}return await this.setRoomReadMarkersHttpRequest(e,t,s,o)}getUrlPreview(e,t,n){t=6e4*Math.floor(t/6e4);const r=new URL(e);r.hash="";const i=t+"_"+(e=r.toString()),s=this.urlPreviewCache[i];if(s)return n&&s.then(n).catch(n),s;const o=this.http.authedRequest(n,E.Method.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:E.PREFIX_MEDIA_R0});return this.urlPreviewCache[i]=o,o}sendTyping(e,t,n,r){if(this.isGuest())return Promise.resolve({});const i=h.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),s={typing:t};return t&&(s.timeout=n||2e4),this.http.authedRequest(r,E.Method.Put,i,void 0,s)}getRoomUpgradeHistory(e,t=!1){let n=this.getRoom(e);if(!n)return[];const r=[n];let i=n.currentState.getStateEvents(D.EventType.RoomCreate,"");for(;i;){const e=i.getContent().predecessor;if(!e||!e.room_id)break;{const n=this.getRoom(e.room_id);if(!n)break;if(t){const e=n.currentState.getStateEvents(D.EventType.RoomTombstone,"");if(!e||e.getContent().replacement_room!==n.roomId)break}r.splice(0,0,n),i=n.currentState.getStateEvents(D.EventType.RoomCreate,"")}}let s=n.currentState.getStateEvents(D.EventType.RoomTombstone,"");for(;s;){const e=this.getRoom(s.getContent().replacement_room);if(!e)break;if(e.roomId===n.roomId)break;if(t){if(i=e.currentState.getStateEvents(D.EventType.RoomCreate,""),!i||!i.getContent().predecessor)break;if(i.getContent().predecessor.room_id!==n.roomId)break}if(r.push(e),new Set(r.map((e=>e.roomId))).size<r.length)return r.slice(0,r.length-1);n=e,s=n.currentState.getStateEvents(D.EventType.RoomTombstone,"")}return r}invite(e,t,n,r){return this.membershipChange(e,t,"invite",r,n)}inviteByEmail(e,t,n){return this.inviteByThreePid(e,"email",t,n)}async inviteByThreePid(e,t,n,r){var i;const s=h.encodeUri("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl(!0);if(!o)return Promise.reject(new E.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const a={id_server:o,medium:t,address:n};if(null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(a.id_access_token=e)}return this.http.authedRequest(r,E.Method.Post,s,void 0,a)}leave(e,t){return this.membershipChange(e,void 0,"leave",void 0,t)}leaveRoomChain(e,t=!0){const n=this.getRoomUpgradeHistory(e);let r=n;if(!t){r=[];for(const t of n)if(r.push(t),t.roomId===e)break}const i={},s=[],o=e=>this.leave(e).then((()=>{i[e]=null})).catch((t=>(i[e]=t,null)));for(const e of r)s.push(o(e.roomId));return Promise.all(s).then((()=>i))}ban(e,t,n,r){return this.membershipChange(e,t,"ban",n,r)}forget(e,t,n){void 0===t&&(t=!0);const r=this.membershipChange(e,void 0,"forget",void 0,n);return t?r.then((t=>(this.store.removeRoom(e),this.emit(ae.DeleteRoom,e),t))):r}unban(e,t,n){const r=h.encodeUri("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(n,E.Method.Post,r,void 0,i)}kick(e,t,n,r){const i=h.encodeUri("/rooms/$roomId/kick",{$roomId:e}),s={user_id:t,reason:n};return this.http.authedRequest(r,E.Method.Post,i,void 0,s)}membershipChange(e,t,n,r,i){h.isFunction(r)&&(i=r,r=void 0);const s=h.encodeUri("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(i,E.Method.Post,s,void 0,{user_id:t,reason:r})}getPushActionsForEvent(e,t=!1){return e.getPushActions()&&!t||e.setPushActions(this.pushProcessor.actionsForEvent(e)),e.getPushActions()}setProfileInfo(e,t,n){const r=h.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(n,E.Method.Put,r,void 0,t)}async setDisplayName(e,t){const n=await this.setProfileInfo("displayname",{displayname:e},t),r=this.getUser(this.getUserId());return r&&(r.displayName=e,r.emit(I.UserEvent.DisplayName,r.events.presence,r)),n}async setAvatarUrl(e,t){const n=await this.setProfileInfo("avatar_url",{avatar_url:e},t),r=this.getUser(this.getUserId());return r&&(r.avatarUrl=e,r.emit(I.UserEvent.AvatarUrl,r.events.presence,r)),n}mxcUrlToHttp(e,t,n,r,i){return(0,T.getHttpUriForMxc)(this.baseUrl,e,t,n,r,i)}setPresence(e,t){const n=h.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});if("string"==typeof e&&(e={presence:e}),-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this.http.authedRequest(t,E.Method.Put,n,void 0,e)}getPresence(e,t){const n=h.encodeUri("/presence/$userId/status",{$userId:e});return this.http.authedRequest(t,E.Method.Get,n)}scrollback(e,t=30,n){h.isFunction(t)&&(n=t,t=void 0);let r=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;r=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t-=s;const o=new Promise(((i,s)=>{(0,h.sleep)(r).then((()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,p.Direction.Backward))).then((t=>{var r;const s=t.chunk.map(this.getEventMapper());if(t.state){const n=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(n)}const[o,a]=e.partitionThreadedEvents(s);this.processBeaconEvents(e,o),e.addEventsToTimeline(o,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,s,t.end,!0),this.ongoingScrollbacks[e.roomId]=null,null===(r=n)||void 0===r||r(null,e),i(e)})).catch((t=>{var r;this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},null===(r=n)||void 0===r||r(t),s(t)}))}));return i={promise:o,errorTs:null},this.ongoingScrollbacks[e.roomId]=i,o}getEventMapper(e){return(0,x.eventMapperFor)(this,e||{})}async getEventTimeline(e,t){var n,r,i;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const s=h.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let o;this.clientOpts.lazyLoadMembers&&(o={filter:JSON.stringify(u.Filter.LAZY_LOADING_MESSAGES_FILTER)});const a=await this.http.authedRequest(void 0,E.Method.Get,s,o);if(!a.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const c=this.getEventMapper(),l=c(a.event),d=[...a.events_after.reverse().map(c),l,...a.events_before.map(c)];if(this.supportsExperimentalThreads()){if(!e.canContain(l))return;if(V.Thread.hasServerSideSupport&&e.thread){const n=e.thread,r={direction:p.Direction.Backward,limit:50};await n.fetchInitialEvents();let i=n.liveTimeline.getPaginationToken(p.Direction.Backward);for(;!n.findEventById(t)&&(i&&(r.from=i),({nextBatch:i}=await n.fetchEvents(r)),i););return n.liveTimeline}}let g=e.getTimelineForEvent(d[0].getId());g?g.getState(p.EventTimeline.BACKWARDS).setUnknownStateEvents(a.state.map(c)):(g=e.addTimeline(),g.initialiseState(a.state.map(c)),g.getState(p.EventTimeline.FORWARDS).paginationToken=a.end);const[f,m]=e.room.partitionThreadedEvents(d);return e.addEventsToTimeline(f,!0,g,a.start),this.processThreadEvents(e.room,m,!0),this.processBeaconEvents(e.room,f),null!==(n=null!==(r=e.getTimelineForEvent(t))&&void 0!==r?r:null===(i=e.room.findThreadForEvent(l))||void 0===i?void 0:i.liveTimeline)&&void 0!==n?n:g}async getLatestTimeline(e){var t;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const n=h.encodeUri("/rooms/$roomId/messages",{$roomId:e.room.roomId}),r={dir:"b"};this.clientOpts.lazyLoadMembers&&(r.filter=JSON.stringify(u.Filter.LAZY_LOADING_MESSAGES_FILTER));const i=null===(t=(await this.http.authedRequest(void 0,E.Method.Get,n,r)).chunk)||void 0===t?void 0:t[0];if(!i)throw new Error("No message returned from /messages when trying to construct getLatestTimeline");return this.getEventTimeline(e,i.event_id)}createMessagesRequest(e,t,n=30,r,i){const s=h.encodeUri("/rooms/$roomId/messages",{$roomId:e}),o={limit:n.toString(),dir:r};t&&(o.from=t);let a=null;var c;return this.clientOpts.lazyLoadMembers&&(a=Object.assign({},u.Filter.LAZY_LOADING_MESSAGES_FILTER)),i&&(a=a||{},Object.assign(a,null===(c=i.getRoomTimelineFilterComponent())||void 0===c?void 0:c.toJSON())),a&&(o.filter=JSON.stringify(a)),this.http.authedRequest(void 0,E.Method.Get,s,o)}paginateEventTimeline(e,t){const n=e.getTimelineSet()===this.notifTimelineSet,r=(t=t||{}).backwards||!1;if(n&&!r)throw new Error("paginateNotifTimeline can only paginate backwards");const i=r?p.EventTimeline.BACKWARDS:p.EventTimeline.FORWARDS,s=e.getPaginationToken(i),o=e.paginationRequests[i];if(o)return o;let a,c,l;if(n){var u;a="/notifications",c={limit:(null!==(u=t.limit)&&void 0!==u?u:30).toString(),only:"highlight"},"end"!==s&&(c.from=s),l=this.http.authedRequest(void 0,E.Method.Get,"/notifications",c).then((async t=>{const n=t.next_token,s=[];for(let e=0;e<t.notifications.length;e++){const n=t.notifications[e],r=this.getEventMapper()(n.event);r.setPushActions(g.PushProcessor.actionListToActionsObject(n.actions)),r.event.room_id=n.room_id,s[e]=r}const o=e.getTimelineSet();return o.addEventsToTimeline(s,r,e,n),this.processBeaconEvents(o.room,s),r&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token})).finally((()=>{e.paginationRequests[i]=null})),e.paginationRequests[i]=l}else{const n=this.getRoom(e.getRoomId());if(!n)throw new Error("Unknown room "+e.getRoomId());l=this.createMessagesRequest(e.getRoomId(),s,t.limit,i,e.getFilter()).then((t=>{if(t.state){const n=e.getState(i),r=t.state.map(this.getEventMapper());n.setUnknownStateEvents(r)}const s=t.end,o=t.chunk.map(this.getEventMapper()),a=e.getTimelineSet(),[c,l]=a.room.partitionThreadedEvents(o);a.addEventsToTimeline(c,r,e,s),this.processBeaconEvents(a.room,c),this.processThreadEvents(n,l,r);const u=void 0===t.end||t.end===t.start;return r&&u&&e.setPaginationToken(null,i),!u})).finally((()=>{e.paginationRequests[i]=null})),e.paginationRequests[i]=l}return l}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end",null)}peekInRoom(e){return this.peekSync&&this.peekSync.stopPeeking(),this.peekSync=new o.SyncApi(this,this.clientOpts),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const n=this.sendStateEvent(e,D.EventType.RoomGuestAccess,{guest_access:t.allowJoin?"can_join":"forbidden"},"");let r=Promise.resolve(void 0);return t.allowRead&&(r=this.sendStateEvent(e,D.EventType.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([r,n]).then()}requestRegisterEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestRegisterMsisdnToken(e,t,n,r,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})}requestAdd3pidEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestAdd3pidMsisdnToken(e,t,n,r,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})}requestPasswordEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestPasswordMsisdnToken(e,t,n,r,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})}async requestTokenFromEndpoint(e,t){const n=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){var r;const e=new URL(this.idBaseUrl);if(n.id_server=e.host,null!==(r=this.identityServer)&&void 0!==r&&r.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(n.id_access_token=e)}}return this.http.request(void 0,E.Method.Post,e,void 0,n)}getRoomPushRule(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");if(this.pushRules[e]&&this.pushRules[e].room)for(let n=0;n<this.pushRules[e].room.length;n++){const r=this.pushRules[e].room[n];if(r.rule_id===t)return r}}setRoomMutePushRule(e,t,n){let r,i=!1;const s=this.getRoomPushRule(e,t);if(null!=s&&s.actions.includes(O.PushRuleActionName.DontNotify)&&(i=!0),n)if(s){if(!i){const n=h.defer();this.deletePushRule(e,F.PushRuleKind.RoomSpecific,s.rule_id).then((()=>{this.addPushRule(e,F.PushRuleKind.RoomSpecific,t,{actions:[O.PushRuleActionName.DontNotify]}).then((()=>{n.resolve()})).catch((e=>{n.reject(e)}))})).catch((e=>{n.reject(e)})),r=n.promise}}else r=this.addPushRule(e,F.PushRuleKind.RoomSpecific,t,{actions:[O.PushRuleActionName.DontNotify]});else i&&(r=this.deletePushRule(e,F.PushRuleKind.RoomSpecific,s.rule_id));if(r)return new Promise(((e,t)=>{r.then((()=>{this.getPushRules().then((t=>{this.pushRules=t,e()})).catch((e=>{t(e)}))})).catch((e=>{this.getPushRules().then((n=>{this.pushRules=n,t(e)})).catch((n=>{t(e)}))}))}))}searchMessageText(e,t){const n={search_term:e.query};return"keys"in e&&(n.keys=e.keys),this.search({body:{search_categories:{room_events:n}}},t)}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:U.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then((e=>this.processRoomEventsSearch(n,e)))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},n=this.search(t).then((t=>this.processRoomEventsSearch(e,t))).finally((()=>{e.pendingRequest=null}));return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,r;const i=t.search_categories.room_events;e.count=i.count,e.next_batch=i.next_batch;const s=new Set(i.highlights);e.highlights.forEach((e=>{s.add(e)})),e.highlights=Array.from(s);const o=this.getEventMapper(),a=null!==(n=null===(r=i.results)||void 0===r?void 0:r.length)&&void 0!==n?n:0;for(let t=0;t<a;t++){const n=k.SearchResult.fromJson(i.results[t],o),r=this.getRoom(n.context.getEvent().getRoomId());if(r)for(const e of n.context.getTimeline()){const t=r.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(n)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new o.SyncApi(this,this.clientOpts);return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then((()=>{_.logger.log("Marking success of sync left room request"),this.syncedLeftRooms=!0})).finally((()=>{this.syncLeftRoomsPromise=null})),this.syncLeftRoomsPromise}createFilter(e){const t=h.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,E.Method.Post,t,void 0,e).then((t=>{const n=u.Filter.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(n),n}))}getFilter(e,t,n){if(n){const n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}const r=h.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(void 0,E.Method.Get,r).then((n=>{const r=u.Filter.fromJson(e,t,n);return this.store.storeFilter(r),r}))}async getOrCreateFilter(e,t){const n=this.store.getFilterIdByName(e);let r;if(n){try{const e=await this.getFilter(this.credentials.userId,n,!0);if(e){const i=e.getDefinition(),s=t.getDefinition();h.deepCompare(i,s)&&(r=n)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}r||this.store.setFilterIdByName(e,void 0)}if(r)return r;const i=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,i.filterId),i.filterId}getOpenIdToken(){const e=h.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,E.Method.Post,e,void 0,{})}turnServer(e){return this.http.authedRequest(e,E.Method.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return null!==this.checkTurnServersIntervalID}async checkTurnServers(){if(!this.canSupportVoip)return;let e=!1;const t=this.turnServersExpiry-Date.now();if(t>te)_.logger.debug("TURN creds are valid for another "+t+" ms: not fetching new ones."),e=!0;else{_.logger.debug("Fetching new TURN credentials");try{const t=await this.turnServer();if(t.uris){_.logger.log("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");const n={urls:t.uris,username:t.username,credential:t.password};this.turnServers=[n],this.turnServersExpiry=Date.now()+1e3*t.ttl,e=!0,this.emit(ae.TurnServers,this.turnServers)}}catch(e){_.logger.error("Failed to get TURN URIs",e),403===e.httpStatus?(_.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&n.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=null,this.emit(ae.TurnServersError,e,!0)):this.emit(ae.TurnServersError,e,!1)}}return e}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=h.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(void 0,E.Method.Get,e,void 0,void 0,{prefix:""}).then((e=>e.admin))}whoisSynapseUser(e){const t=h.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(void 0,E.Method.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=h.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(void 0,E.Method.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){this.clientWellKnownPromise=f.AutoDiscovery.getRawClientConfig(this.getDomain()),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(ae.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter((([t,n])=>e.includes(typeof n))).reduce(((e,[t,n])=>(e[t]=n,e)),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){const t=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),n=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms");if(!t&&!n)throw Error("Server does not support mutual_rooms API");const r=h.encodeUri(`/uk.half-shot.msc2666/user/${n?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e});return(await this.http.authedRequest(void 0,E.Method.Get,r,void 0,void 0,{prefix:E.PREFIX_UNSTABLE})).joined}getVersions(){return this.serverVersionsPromise||(this.serverVersionsPromise=this.http.request(void 0,E.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch((e=>{throw this.serverVersionsPromise=null,e}))),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportLazyLoading(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return t&&t.includes("r0.5.0")||n&&n["m.lazy_load_members"]}async doesServerRequireIdServerParam(){const e=await this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const n=e.unstable_features;return!n||void 0===n["m.require_identity_server"]||n["m.require_identity_server"]}async doesServerAcceptIdentityAccessToken(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return t&&t.includes("r0.6.0")||n&&n["m.id_access_token"]}async doesServerSupportSeparateAddAndBind(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return(null==t?void 0:t.includes("r0.6.0"))||(null==n?void 0:n["m.separate_add_and_bind"])}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const n=t.unstable_features;return n&&!!n[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const n=t.unstable_features,r=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n[`io.element.e2ee_forced.${r}`]}async doesServerSupportThread(){try{const e=await this.doesServerSupportUnstableFeature("org.matrix.msc3440"),t=await this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable");return{serverSupport:e||t,stable:t}}catch(e){return null}}doesServerSupportLogoutDevices(){return this.isVersionSupported("r0.6.1")}hasLazyLoadMembersEnabled(){return!!this.clientOpts.lazyLoadMembers}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,n,r,i={direction:p.Direction.Backward}){const s=this.getEncryptedIfNeededEventType(e,r),o=await this.fetchRelations(e,t,n,s,i),a=this.getEventMapper(),c=o.original_event?a(o.original_event):void 0;let l=o.chunk.map(a);if(s===D.EventType.RoomMessageEncrypted){const e=c?l.concat(c):l;await Promise.all(e.map((e=>this.decryptEventIfNeeded(e)))),null!==r&&(l=l.filter((e=>e.getType()===r)))}return c&&n===D.RelationType.Replace&&(l=l.filter((e=>e.getSender()===c.getSender()))),{originalEvent:c,events:l,nextBatch:o.next_batch,prevBatch:o.prev_batch}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,M.randomString)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&e.attemptDecryption(this.crypto,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case b.SERVICE_TYPES.IS:return t+E.PREFIX_IDENTITY_V2+"/terms";case b.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=h.ensureNoTrailingSlash(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}setAccessToken(e){this.http.opts.accessToken=e}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(void 0,E.Method.Get,"/register/available",{username:e}).then((e=>e.available)).catch((e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e)))}register(e,t,n,r,i,s,o,a){!0===i?i={email:!0}:null!=i&&!1!==i||(i={}),"function"==typeof o&&(a=o,o=void 0),n&&(r.session=n);const c={auth:r,refresh_token:!0};return null!=e&&(c.username=e),null!=t&&(c.password=t),i.email&&(c.bind_email=!0),i.msisdn&&(c.bind_msisdn=!0),null!=s&&(c.guest_access_token=s),null!=o&&(c.inhibit_login=o),null!=t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,a)}registerGuest(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)}registerRequest(e,t,n){const r={};return t&&(r.kind=t),this.http.request(n,E.Method.Post,"/register",r,e)}refreshToken(e){return this.http.authedRequest(void 0,E.Method.Post,"/refresh",void 0,{refresh_token:e},{prefix:E.PREFIX_V1,inhibitLogoutEmit:!0})}loginFlows(e){return this.http.request(e,E.Method.Get,"/login")}login(e,t,n){const r={type:e};return Object.assign(r,t),this.http.authedRequest(((e,t)=>{t&&t.access_token&&t.user_id&&(this.http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),n&&n(e,t)}),E.Method.Post,"/login",void 0,r)}loginWithPassword(e,t,n){return this.login("m.login.password",{user:e,password:t},n)}loginWithSAML2(e,t){return this.login("m.login.saml2",{relay_state:e},t)}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",n,r){let i="/login/"+t+"/redirect";n&&(i+="/"+n);const s={redirectUrl:e,[ce.unstable]:r};return this.http.getUrl(i,s,E.PREFIX_R0)}loginWithToken(e,t){return this.login("m.login.token",{token:e},t)}async logout(e,t=!1){var n,r;if(null!==(n=this.crypto)&&void 0!==n&&null!==(r=n.backupManager)&&void 0!==r&&r.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(e){_.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",e)}return t&&this.stopClient(),this.http.authedRequest(e,E.Method.Post,"/logout")}deactivateAccount(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const n={};return e&&(n.auth=e),void 0!==t&&(n.erase=t),this.http.authedRequest(void 0,E.Method.Post,"/account/deactivate",void 0,n)}requestLoginToken(e){const t={auth:e};return this.http.authedRequest(void 0,E.Method.Post,"/org.matrix.msc3882/login/token",void 0,t,{prefix:E.PREFIX_UNSTABLE})}getFallbackAuthUrl(e,t){const n=h.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t},E.PREFIX_R0)}async createRoom(e,t){var n;const r=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(r.length>0&&null!==(n=this.identityServer)&&void 0!==n&&n.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of r)t.id_access_token=e}return this.http.authedRequest(t,E.Method.Post,"/createRoom",void 0,e)}fetchRelations(e,t,n,r,i={direction:p.Direction.Backward}){const s=h.encodeParams(i);let o="/rooms/$roomId/relations/$eventId";null!==n?(o+="/$relationType",null!==r&&(o+="/$eventType")):null!==r&&(_.logger.warn(`eventType: ${r} ignored when fetching\n            relations as relationType is null`),r=null);const a=h.encodeUri(o+"?"+s,{$roomId:e,$eventId:t,$relationType:n,$eventType:r});return this.http.authedRequest(void 0,E.Method.Get,a,void 0,void 0,{prefix:E.PREFIX_UNSTABLE})}roomState(e,t){const n=h.encodeUri("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(t,E.Method.Get,n)}fetchRoomEvent(e,t,n){const r=h.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(n,E.Method.Get,r)}members(e,t,n,r,i){const s={};t&&(s.membership=t),n&&(s.not_membership=n),r&&(s.at=r);const o=h.encodeParams(s),a=h.encodeUri("/rooms/$roomId/members?"+o,{$roomId:e});return this.http.authedRequest(i,E.Method.Get,a)}upgradeRoom(e,t){const n=h.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(void 0,E.Method.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n,r){const i={$roomId:e,$eventType:t,$stateKey:n};let s=h.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==n&&(s=h.encodeUri(s+"/$stateKey",i)),this.http.authedRequest(r,E.Method.Get,s)}sendStateEvent(e,t,n,r="",i){const s={$roomId:e,$eventType:t,$stateKey:r};let o=h.encodeUri("/rooms/$roomId/state/$eventType",s);return void 0!==r&&(o=h.encodeUri(o+"/$stateKey",s)),this.http.authedRequest(i,E.Method.Put,o,void 0,n)}roomInitialSync(e,t,n){var r,i;h.isFunction(t)&&(n=t,t=void 0);const s=h.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(n,E.Method.Get,s,{limit:null!==(r=null===(i=t)||void 0===i?void 0:i.toString())&&void 0!==r?r:"30"})}async setRoomReadMarkersHttpRequest(e,t,n,r){const i=h.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),s={[K.ReceiptType.FullyRead]:t,[K.ReceiptType.Read]:n};return(await this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await this.isVersionSupported("v1.4"))&&(s[K.ReceiptType.ReadPrivate]=r),this.http.authedRequest(void 0,E.Method.Post,i,void 0,s)}getJoinedRooms(){const e=h.encodeUri("/joined_rooms",{});return this.http.authedRequest(void 0,E.Method.Get,e)}getJoinedRoomMembers(e){const t=h.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(void 0,E.Method.Get,t)}publicRooms(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const n={};return e.server&&(n.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(n).length?this.http.authedRequest(t,E.Method.Get,"/publicRooms"):this.http.authedRequest(t,E.Method.Post,"/publicRooms",n,e)}createAlias(e,t,n){const r=h.encodeUri("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(n,E.Method.Put,r,void 0,i)}deleteAlias(e,t){const n=h.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,E.Method.Delete,n)}getLocalAliases(e){const t=h.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),n=E.PREFIX_V3;return this.http.authedRequest(void 0,E.Method.Get,t,void 0,void 0,{prefix:n})}getRoomIdForAlias(e,t){const n=h.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,E.Method.Get,n)}resolveRoomAlias(e,t){const n=h.encodeUri("/directory/room/$alias",{$alias:e});return this.http.request(t,E.Method.Get,n)}getRoomDirectoryVisibility(e,t){const n=h.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(t,E.Method.Get,n)}setRoomDirectoryVisibility(e,t,n){const r=h.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(n,E.Method.Put,r,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,n,r){const i=h.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(r,E.Method.Put,i,void 0,{visibility:n})}searchUserDirectory(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this.http.authedRequest(void 0,E.Method.Post,"/user_directory/search",void 0,t)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t,n){h.isFunction(t)&&(n=t,t=void 0);const r=t?h.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):h.encodeUri("/profile/$userId",{$userId:e});return this.http.authedRequest(n,E.Method.Get,r)}getThreePids(e){return this.http.authedRequest(e,E.Method.Get,"/account/3pid")}addThreePid(e,t,n){const r={threePidCreds:e,bind:t};return this.http.authedRequest(n,E.Method.Post,"/account/3pid",void 0,r)}async addThreePidOnly(e){const t=await this.isVersionSupported("r0.6.0")?E.PREFIX_R0:E.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,E.Method.Post,"/account/3pid/add",void 0,e,{prefix:t})}async bindThreePid(e){const t=await this.isVersionSupported("r0.6.0")?E.PREFIX_R0:E.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,E.Method.Post,"/account/3pid/bind",void 0,e,{prefix:t})}async unbindThreePid(e,t){const n={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},r=await this.isVersionSupported("r0.6.0")?E.PREFIX_R0:E.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,E.Method.Post,"/account/3pid/unbind",void 0,n,{prefix:r})}deleteThreePid(e,t){return this.http.authedRequest(void 0,E.Method.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,n,r){"function"==typeof n&&(r=n),"boolean"!=typeof n&&(n=void 0);const i={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(r,E.Method.Post,"/account/password",void 0,i)}getDevices(){return this.http.authedRequest(void 0,E.Method.Get,"/devices")}getDevice(e){const t=h.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,E.Method.Get,t)}setDeviceDetails(e,t){const n=h.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,E.Method.Put,n,void 0,t)}deleteDevice(e,t){const n=h.encodeUri("/devices/$device_id",{$device_id:e}),r={};return t&&(r.auth=t),this.http.authedRequest(void 0,E.Method.Delete,n,void 0,r)}deleteMultipleDevices(e,t){const n={devices:e};return t&&(n.auth=t),this.http.authedRequest(void 0,E.Method.Post,"/delete_devices",void 0,n)}async getPushers(e){const t=await this.http.authedRequest(e,E.Method.Get,"/pushers");return await this.doesServerSupportUnstableFeature("org.matrix.msc3881")||(t.pushers=t.pushers.map((e=>(e.hasOwnProperty(D.PUSHER_ENABLED.name)||(e[D.PUSHER_ENABLED.name]=!0),e)))),t}setPusher(e,t){return this.http.authedRequest(t,E.Method.Post,"/pushers/set",void 0,e)}setLocalNotificationSettings(e,t){const n=`${D.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${e}`;return this.setAccountData(n,t)}getPushRules(e){return this.http.authedRequest(e,E.Method.Get,"/pushrules/").then((e=>g.PushProcessor.rewriteDefaultRules(e)))}addPushRule(e,t,n,r,i){const s=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(i,E.Method.Put,s,void 0,r)}deletePushRule(e,t,n,r){const i=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(r,E.Method.Delete,i)}setPushRuleEnabled(e,t,n,r,i){const s=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(i,E.Method.Put,s,void 0,{enabled:r})}setPushRuleActions(e,t,n,r,i){const s=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(i,E.Method.Put,s,void 0,{actions:r})}search(e,t){const n={};return e.next_batch&&(n.next_batch=e.next_batch),this.http.authedRequest(t,E.Method.Post,"/search",n,e.body)}uploadKeysRequest(e,t,n){return this.http.authedRequest(n,E.Method.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(void 0,E.Method.Post,"/keys/signatures/upload",void 0,e,{prefix:E.PREFIX_UNSTABLE})}downloadKeysForUsers(e,t){if(h.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const n={device_keys:{}};return"token"in(t=t||{})&&(n.token=t.token),e.forEach((e=>{n.device_keys[e]=[]})),this.http.authedRequest(void 0,E.Method.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e,t="signed_curve25519",n){const r={};void 0===t&&(t="signed_curve25519");for(let n=0;n<e.length;++n){const i=e[n][0],s=e[n][1],o=r[i]||{};r[i]=o,o[s]=t}const i={one_time_keys:r};return n&&(i.timeout=n),this.http.authedRequest(void 0,E.Method.Post,"/keys/claim",void 0,i)}getKeyChanges(e,t){const n={from:e,to:t};return this.http.authedRequest(void 0,E.Method.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){const n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(void 0,E.Method.Post,"/keys/device_signing/upload",void 0,n,{prefix:E.PREFIX_UNSTABLE})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.idBaseUrl+E.PREFIX_IDENTITY_V2+"/account/register";return this.http.requestOtherUrl(void 0,E.Method.Post,t,null,e)}requestEmailToken(e,t,n,r,i,s){const o={client_secret:t,email:e,send_attempt:null==n?void 0:n.toString(),next_link:r};return this.http.idServerRequest(i,E.Method.Post,"/validate/email/requestToken",o,E.PREFIX_IDENTITY_V2,s)}requestMsisdnToken(e,t,n,r,i,s,o){const a={client_secret:n,country:e,phone_number:t,send_attempt:null==r?void 0:r.toString(),next_link:i};return this.http.idServerRequest(s,E.Method.Post,"/validate/msisdn/requestToken",a,E.PREFIX_IDENTITY_V2,o)}submitMsisdnToken(e,t,n,r){const i={sid:e,client_secret:t,token:n};return this.http.idServerRequest(void 0,E.Method.Post,"/validate/msisdn/submitToken",i,E.PREFIX_IDENTITY_V2,r)}submitMsisdnTokenOtherUrl(e,t,n,r){const i={sid:t,client_secret:n,token:r};return this.http.requestOtherUrl(void 0,E.Method.Post,e,void 0,i)}getIdentityHashDetails(e){return this.http.idServerRequest(void 0,E.Method.Get,"/hash_details",null,E.PREFIX_IDENTITY_V2,e)}async identityHashedLookup(e,t){const r={},i=await this.getIdentityHashDetails(t);if(!i||!i.lookup_pepper||!i.algorithms)throw new Error("Unsupported identity server: bad response");r.pepper=i.lookup_pepper;const s={};if(i.algorithms.includes("sha256")){const t=new n.g.Olm.Utility;r.addresses=e.map((e=>{const n=e[0].toLowerCase(),i=e[1].toLowerCase(),o=t.sha256(`${n} ${i} ${r.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return s[o]=e[0],o})),r.algorithm="sha256"}else{if(!i.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");r.addresses=e.map((e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return s[t]=e[0],t})),r.algorithm="none"}const o=await this.http.idServerRequest(void 0,E.Method.Post,"/lookup",r,E.PREFIX_IDENTITY_V2,t);if(!o||!o.mappings)return[];const a=[];for(const e of Object.keys(o.mappings)){const t=o.mappings[e],n=s[e];if(!n)throw new Error("Identity server returned more results than expected");a.push({address:n,mxid:t})}return a}async lookupThreePid(e,t,n,r){const i=(await this.identityHashedLookup([[t,e]],r)).find((e=>e.address===t));if(!i)return n&&n(null,{}),{};const s={address:t,medium:e,mxid:i.mxid};return n&&n(null,s),s}async bulkLookupThreePids(e,t){const n=await this.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),r=[];for(const t of n){const n=e.find((e=>e[1]===t.address));if(!n)throw new Error("Identity sever returned unexpected results");r.push([n[0],t.address,t.mxid])}return{threepids:r}}getIdentityAccount(e){return this.http.idServerRequest(void 0,E.Method.Get,"/account",void 0,E.PREFIX_IDENTITY_V2,e)}sendToDevice(e,t,n){const r=h.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),i={messages:t},s=Object.keys(t).reduce(((e,n)=>(e[n]=Object.keys(t[n]),e)),{});return _.logger.log(`PUT ${r}`,s),this.http.authedRequest(void 0,E.Method.Put,r,void 0,i)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(void 0,E.Method.Get,"/thirdparty/protocols").then((e=>{if(!e||"object"!=typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e}))}getThirdpartyLocation(e,t){const n=h.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(void 0,E.Method.Get,n,t)}getThirdpartyUser(e,t){const n=h.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(void 0,E.Method.Get,n,t)}getTerms(e,t){const n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(void 0,E.Method.Get,n)}agreeToTerms(e,t,n,r){const i=this.termsUrlForService(e,t),s={Authorization:"Bearer "+n};return this.http.requestOtherUrl(void 0,E.Method.Post,i,null,{user_accepts:r},{headers:s})}reportEvent(e,t,n,r){const i=h.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(void 0,E.Method.Post,i,void 0,{score:n,reason:r})}getRoomHierarchy(e,t,n,r=!1,i){const s=h.encodeUri("/rooms/$roomId/hierarchy",{$roomId:e}),o={suggested_only:String(r),max_depth:null==n?void 0:n.toString(),from:i,limit:null==t?void 0:t.toString()};return this.http.authedRequest(void 0,E.Method.Get,s,o,void 0,{prefix:E.PREFIX_V1}).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(void 0,E.Method.Get,s,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e}))}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:N.Preset.PrivateChat,power_level_content_override:Z(Z({},B.DEFAULT_TREE_POWER_LEVELS_TEMPLATE),{},{users:{[this.getUserId()]:100}}),creation_content:{[D.RoomCreateTypeField]:D.RoomType.Space},initial_state:[{type:D.UNSTABLE_MSC3088_PURPOSE.name,state_key:D.UNSTABLE_MSC3089_TREE_SUBTYPE.name,content:{[D.UNSTABLE_MSC3088_ENABLED.name]:!0}},{type:D.EventType.RoomEncryption,state_key:"",content:{algorithm:m.MEGOLM_ALGORITHM}}]});return new B.MSC3089TreeSpace(this,t)}unstableGetFileTreeSpace(e){var t,n;const r=this.getRoom(e);if("join"!==(null==r?void 0:r.getMyMembership()))return null;const i=r.currentState.getStateEvents(D.EventType.RoomCreate,""),s=r.currentState.getStateEvents(D.UNSTABLE_MSC3088_PURPOSE.name,D.UNSTABLE_MSC3089_TREE_SUBTYPE.name);if(!i)throw new Error("Expected single room create event");return null!=s&&null!==(t=s.getContent())&&void 0!==t&&t[D.UNSTABLE_MSC3088_ENABLED.name]?(null===(n=i.getContent())||void 0===n?void 0:n[D.RoomCreateTypeField])!==D.RoomType.Space?null:new B.MSC3089TreeSpace(this,e):null}slidingSync(e,t){const n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);const r=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(void 0,E.Method.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:r})}supportsExperimentalThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.experimentalThreadSupport)||!1}async getRoomSummary(e,t){const n=h.encodeUri("/rooms/$roomid/summary",{$roomid:e});return this.http.authedRequest(void 0,E.Method.Get,n,{via:t},void 0,{qsStringifyOptions:{arrayFormat:"repeat"},prefix:"/_matrix/client/unstable/im.nheko.summary"})}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processBeaconEvents(e,t){null!=t&&t.length&&e&&e.currentState.processBeaconEvents(t,this)}async whoami(){return this.http.authedRequest(void 0,E.Method.Get,"/account/whoami")}timestampToEvent(e,t,n){const r=h.encodeUri("/rooms/$roomId/timestamp_to_event",{$roomId:e});return this.http.authedRequest(void 0,E.Method.Get,r,{ts:t.toString(),dir:n},void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"})}}t.MatrixClient=le,(0,i.default)(le,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")},9228:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.makeBeaconInfoContent=t.makeBeaconContent=t.getTextForLocationEvent=void 0,t.makeEmoteMessage=function(e){return{msgtype:o.MsgType.Emote,body:e}},t.makeHtmlEmote=function(e,t){return{msgtype:o.MsgType.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlMessage=function(e,t){return{msgtype:o.MsgType.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlNotice=function(e,t){return{msgtype:o.MsgType.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeLocationContent=void 0,t.makeNotice=function(e){return{msgtype:o.MsgType.Notice,body:e}},t.makeTextMessage=function(e){return{msgtype:o.MsgType.Text,body:e}},t.parseTopicContent=t.parseLocationEvent=t.parseBeaconInfoContent=t.parseBeaconContent=t.makeTopicContent=void 0;var i=r(n(3693)),s=n(9787),o=n(4703),a=n(3368),c=n(9668),l=n(2956);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}const d=(e,t,n,r)=>{const i=`at ${new Date(n).toISOString()}`;return[t===c.LocationAssetType.Self?"User":void 0,"Location",r?`"${r}"`:void 0,e,i].filter(Boolean).join(" ")};t.getTextForLocationEvent=d;const h=(e,t,n,r,s)=>{const l=null!=e?e:d(t,s||c.LocationAssetType.Self,n,r),h=n?{[c.M_TIMESTAMP.name]:n}:{};return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({msgtype:o.MsgType.Location,body:l,geo_uri:t,[c.M_LOCATION.name]:{description:r,uri:t},[c.M_ASSET.name]:{type:s||c.LocationAssetType.Self},[a.TEXT_NODE_TYPE.name]:l},h)};t.makeLocationContent=h,t.parseLocationEvent=e=>{var t,n;const r=c.M_LOCATION.findIn(e),i=c.M_ASSET.findIn(e),s=c.M_TIMESTAMP.findIn(e),o=a.TEXT_NODE_TYPE.findIn(e),l=null!==(t=null==r?void 0:r.uri)&&void 0!==t?t:null==e?void 0:e.geo_uri,u=null==r?void 0:r.description,d=null!==(n=null==i?void 0:i.type)&&void 0!==n?n:c.LocationAssetType.Self,p=null!=o?o:e.body;return h(p,l,s,u,d)},t.makeTopicContent=(e,t)=>{const n=[{body:e,mimetype:"text/plain"}];return(0,s.isProvided)(t)&&n.push({body:t,mimetype:"text/html"}),{topic:e,[l.M_TOPIC.name]:n}},t.parseTopicContent=e=>{var t,n,r;const i=l.M_TOPIC.findIn(e);return{text:null!==(t=null==i||null===(n=i.find((e=>!(0,s.isProvided)(e.mimetype)||"text/plain"===e.mimetype)))||void 0===n?void 0:n.body)&&void 0!==t?t:e.topic,html:null==i||null===(r=i.find((e=>"text/html"===e.mimetype)))||void 0===r?void 0:r.body}},t.makeBeaconInfoContent=(e,t,n,r,i)=>({description:n,timeout:e,live:t,[c.M_TIMESTAMP.name]:i||Date.now(),[c.M_ASSET.name]:{type:null!=r?r:c.LocationAssetType.Self}}),t.parseBeaconInfoContent=e=>{const{description:t,timeout:n,live:r}=e,i=c.M_TIMESTAMP.findIn(e),s=c.M_ASSET.findIn(e);return{description:t,timeout:n,live:r,assetType:null==s?void 0:s.type,timestamp:i}},t.makeBeaconContent=(e,t,n,r)=>({[c.M_LOCATION.name]:{description:r,uri:e},[c.M_TIMESTAMP.name]:t,"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:n}}),t.parseBeaconContent=e=>{const t=c.M_LOCATION.findIn(e),n=c.M_TIMESTAMP.findIn(e);return{description:null==t?void 0:t.description,uri:null==t?void 0:t.uri,timestamp:n}}},7777:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHttpUriForMxc=function(e,t,n,i,s,o=!1){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return o?t:"";let a=t.slice(6),c="/_matrix/media/r0/download/";const l={};n&&(l.width=Math.round(n).toString()),i&&(l.height=Math.round(i).toString()),s&&(l.method=s),Object.keys(l).length>0&&(c="/_matrix/media/r0/thumbnail/");const u=a.indexOf("#");let d="";u>=0&&(d=a.slice(u),a=a.slice(0,u));return e+c+a+(0===Object.keys(l).length?"":"?"+r.encodeParams(l))+d};var r=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=i(t);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var a=s?Object.getOwnPropertyDescriptor(e,o):null;a&&(a.get||a.set)?Object.defineProperty(r,o,a):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}(n(4148));function i(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(i=function(e){return e?n:t})(e)}},2180:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.UserTrustLevel=t.DeviceTrustLevel=t.CrossSigningLevel=t.CrossSigningInfo=void 0,t.createCryptoStoreCacheCallbacks=function(e,t){return{getCrossSigningKeyCache:async function(n,r){const i=await new Promise((t=>e.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(r=>{e.getSecretStorePrivateKey(r,t,n)}))));if(i&&i.ciphertext){const e=Buffer.from(t.pickleKey),r=await(0,c.decryptAES)(i,e,n);return(0,s.decodeBase64)(r)}return i},storeCrossSigningKeyCache:async function(n,r){if(!(r instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${r}`);const i=Buffer.from(t.pickleKey),o=await(0,c.encryptAES)((0,s.encodeBase64)(r),i,n);return e.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{e.storeSecretStorePrivateKey(t,n,o)}))}}},t.requestKeysDuringVerification=function(e,t,n){if(e.getUserId()===t)return o.logger.log("Cross-signing: Self-verification done; requesting keys"),new Promise(((t,r)=>{const i=e,a=i.crypto.crossSigningInfo,c=new d(a.userId,{getCrossSigningKey:async e=>{o.logger.debug("Cross-signing: requesting secret",e,n);const{promise:t}=i.requestSecret(`m.cross_signing.${e}`,[n]),r=await t,a=(0,s.decodeBase64)(r);return Uint8Array.from(a)}},a.getCacheCallbacks());c.keys=a.keys;const u=new Promise((e=>{setTimeout(e,l,new Error("Timeout"))})),h=(async()=>{if(!await i.crypto.getSessionBackupPrivateKey()){o.logger.info("No cached backup key found. Requesting...");const e=i.requestSecret("m.megolm_backup.v1",[n]),t=await e.promise;o.logger.info("Got key backup key, decoding...");const r=(0,s.decodeBase64)(t);o.logger.info("Decoded backup key, storing..."),await i.crypto.storeSessionBackupPrivateKey(Uint8Array.from(r)),o.logger.info("Backup key stored. Starting backup restore...");const a=await i.getKeyBackupVersion();i.restoreKeyBackupWithCache(void 0,void 0,a).then((()=>{o.logger.info("Backup restored.")}))}})();return Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),h]),u]).then(t,r)})).catch((e=>{o.logger.warn("Cross-signing: failure while requesting keys:",e)}))};var i=r(n(3693)),s=n(1978),o=n(9849),a=n(3514),c=n(5936);const l=6e4;function u(e){return Object.values(e.keys)[0]}class d{constructor(e,t={},n={}){this.userId=e,this.callbacks=t,this.cacheCallbacks=n,(0,i.default)(this,"keys",{}),(0,i.default)(this,"firstUse",!0),(0,i.default)(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){const n=new d(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(e,t){const r=["master","self_signing","user_signing"].indexOf(e)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function i(e){if(!e)return;const r=new n.g.Olm.PkSigning,i=r.init_with_seed(e);if(i===t)return[i,r];r.free()}let s;void 0===t&&(t=this.getId(e)),this.cacheCallbacks.getCrossSigningKeyCache&&r&&(s=await this.cacheCallbacks.getCrossSigningKeyCache(e,t));const o=i(s);if(o)return o;s=await this.callbacks.getCrossSigningKey(e,t);const a=i(s);if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&r&&await this.cacheCallbacks.storeCrossSigningKeyCache(e,s),a;if(!s)throw new Error("getCrossSigningKey callback for "+e+" returned falsey");throw new Error("Key type "+e+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master")||{};function n(e){for(const n of Object.keys(t))e[n]||delete t[n]}for(const t of["self_signing","user_signing"])n(await e.isStored(`m.cross_signing.${t}`)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[n,r]of e){const e=(0,s.encodeBase64)(r);await t.store(`m.cross_signing.${n}`,e)}}static async getFromSecretStorage(e,t){const n=await t.get(`m.cross_signing.${e}`);return n?(0,s.decodeBase64)(n):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const n=e?[e]:["master","self_signing","user_signing"];for(const e of n)if(!await t.getCrossSigningKeyCache(e))return!1;return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const n of["master","self_signing","user_signing"]){const r=await t.getCrossSigningKeyCache(n);r&&e.set(n,r)}return e}getId(e="master"){return this.keys[e]?u(this.keys[e]):null}async resetKeys(e){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===e||e&h.MASTER||!this.keys.master)e=h.MASTER|h.USER_SIGNING|h.SELF_SIGNING;else if(0===e)return;const t={},r={};let i,o;try{if(e&h.MASTER?(i=new n.g.Olm.PkSigning,t.master=i.generate_seed(),o=i.init_with_seed(t.master),r.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+o]:o}}):[o,i]=await this.getCrossSigningKey("master"),e&h.SELF_SIGNING){const e=new n.g.Olm.PkSigning;try{t.self_signing=e.generate_seed();const n=e.init_with_seed(t.self_signing);r.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+n]:n}},(0,s.pkSign)(r.self_signing,i,this.userId,o)}finally{e.free()}}if(e&h.USER_SIGNING){const e=new n.g.Olm.PkSigning;try{t.user_signing=e.generate_seed();const n=e.init_with_seed(t.user_signing);r.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+n]:n}},(0,s.pkSign)(r.user_signing,i,this.userId,o)}finally{e.free()}}Object.assign(this.keys,r),this.callbacks.saveCrossSigningKeys(t)}finally{i&&i.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw o.logger.error(t),new Error(t)}this.keys.master?u(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const n=u(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw o.logger.error(t),new Error(t)}try{(0,s.pkVerify)(e.user_signing,n,this.userId)}catch(e){throw o.logger.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw o.logger.error(t),new Error(t)}try{(0,s.pkVerify)(e.self_signing,n,this.userId)}catch(e){throw o.logger.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[n,r]=await this.getCrossSigningKey(t);try{return(0,s.pkSign)(e,r,this.userId,n),e}finally{r.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");o.logger.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");o.logger.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new p(!0,!0,this.firstUse);if(!this.keys.user_signing)return new p(!1,!1,e.firstUse);let t;const n=e.keys.master,r=this.getId("user_signing");try{(0,s.pkVerify)(n,r,this.userId),t=!0}catch(e){t=!1}return new p(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,n,r){const i=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new g(!1,!1,n,r);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,s.pkVerify)(o,e.getId(),e.userId),(0,s.pkVerify)(a,u(o),e.userId),g.fromUserTrustLevel(i,n,r)}catch(e){return new g(!1,!1,n,r)}}getCacheCallbacks(){return this.cacheCallbacks}}let h;t.CrossSigningInfo=d,t.CrossSigningLevel=h,function(e){e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING"}(h||(t.CrossSigningLevel=h={}));class p{constructor(e,t,n){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}t.UserTrustLevel=p;class g{constructor(e,t,n,r){this.crossSigningVerified=e,this.tofu=t,this.localVerified=n,this.trustCrossSignedDevices=r}static fromUserTrustLevel(e,t,n){return new g(e.isCrossSigningVerified(),e.isTofu(),t,n)}isVerified(){return Boolean(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}t.DeviceTrustLevel=g},5577:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.TrackingStatus=t.DeviceList=void 0;var i=r(n(3693)),s=n(9849),o=n(4981),a=n(2180),c=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=p(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(1978)),l=n(3514),u=n(4148),d=n(7022),h=n(8091);function p(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(p=function(e){return e?n:t})(e)}let g;t.TrackingStatus=g,function(e){e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate"}(g||(t.TrackingStatus=g={}));class f extends d.TypedEventEmitter{constructor(e,t,n,r=250){super(),this.cryptoStore=t,this.keyDownloadChunkSize=r,(0,i.default)(this,"devices",{}),(0,i.default)(this,"crossSigningInfo",{}),(0,i.default)(this,"userByIdentityKey",{}),(0,i.default)(this,"deviceTrackingStatus",{}),(0,i.default)(this,"syncToken",null),(0,i.default)(this,"keyDownloadsInProgressByUser",{}),(0,i.default)(this,"dirty",!1),(0,i.default)(this,"savePromise",null),(0,i.default)(this,"resolveSavePromise",null),(0,i.default)(this,"savePromiseTime",null),(0,i.default)(this,"saveTimer",null),(0,i.default)(this,"hasFetched",null),(0,i.default)(this,"serialiser",void 0),this.serialiser=new m(e,n,this)}async load(){await this.cryptoStore.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_DEVICE_DATA],(e=>{this.cryptoStore.getEndToEndDeviceData(e,(e=>{this.hasFetched=Boolean(e&&e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=e?e.syncToken:null,this.userByIdentityKey={};for(const e of Object.keys(this.devices)){const t=this.devices[e];for(const n of Object.keys(t)){const r=t[n].keys["curve25519:"+n];void 0!==r&&(this.userByIdentityKey[r]=e)}}}))}));for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==g.DownloadInProgress&&(this.deviceTrackingStatus[e]=g.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(e=500){if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let n=this.savePromise;if(null===n&&(n=new Promise((e=>{this.resolveSavePromise=e})),this.savePromise=n),null===this.saveTimer){const n=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout((()=>{s.logger.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_DEVICE_DATA],(e=>{this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:this.syncToken},e)})).then((()=>{this.dirty=!1,n(!0)}),(e=>{s.logger.error("Failed to save device tracking data",this.syncToken),s.logger.error(e)}))}),e)}return n}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const n=[],r=[];if(e.forEach((e=>{const i=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser[e]?(s.logger.log(`downloadKeys: already have a download in progress for ${e}: awaiting its result`),r.push(this.keyDownloadsInProgressByUser[e])):(t||i!=g.UpToDate)&&n.push(e)})),0!=n.length){s.logger.log("downloadKeys: downloading for",n);const e=this.doKeyDownload(n);r.push(e)}return 0===r.length&&s.logger.log("downloadKeys: already have all necessary keys"),Promise.all(r).then((()=>this.getDevicesFromStore(e)))}getDevicesFromStore(e){const t={};return e.forEach((e=>{t[e]={},(this.getStoredDevicesForUser(e)||[]).forEach((function(n){t[e][n.deviceId]=n}))})),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const n=[];for(const e in t)t.hasOwnProperty(e)&&n.push(o.DeviceInfo.fromStorage(t[e],e));return n}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?a.CrossSigningInfo.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const n=this.devices[e];if(n&&n[t])return o.DeviceInfo.fromStorage(n[t],t)}getUserByIdentityKey(e,t){return e!==c.OLM_ALGORITHM&&e!==c.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const n=this.getUserByIdentityKey(e,t);if(!n)return null;const r=this.devices[n];if(!r)return null;for(const e in r){if(!r.hasOwnProperty(e))continue;const n=r[e];for(const r in n.keys)if(n.keys.hasOwnProperty(r)&&0===r.indexOf("curve25519:")&&n.keys[r]==t)return o.DeviceInfo.fromStorage(n,e)}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(s.logger.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=g.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(s.logger.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=g.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=g.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(s.logger.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=g.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[t]==g.PendingDownload&&e.push(t);return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,n]of Object.entries(this.devices[e])){const e=n.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[n,r]of Object.entries(t)){const t=r.keys["curve25519:"+n];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then((()=>{n(!0)}),(t=>{throw s.logger.error("Error downloading keys for "+e+":",t),n(!1),t}));e.forEach((e=>{this.keyDownloadsInProgressByUser[e]=t,this.deviceTrackingStatus[e]==g.PendingDownload&&(this.deviceTrackingStatus[e]=g.DownloadInProgress)}));const n=n=>{this.emit(h.CryptoEvent.WillUpdateDevices,e,!this.hasFetched),e.forEach((e=>{this.dirty=!0,this.keyDownloadsInProgressByUser[e]===t?(delete this.keyDownloadsInProgressByUser[e],this.deviceTrackingStatus[e]==g.DownloadInProgress&&(n?(this.deviceTrackingStatus[e]=g.UpToDate,s.logger.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=g.PendingDownload)):s.logger.log("Another update in the queue for",e,"- not marking up-to-date")})),this.saveIfDirty(),this.emit(h.CryptoEvent.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}t.DeviceList=f;class m{constructor(e,t,n){this.baseApis=e,this.olmDevice=t,this.deviceList=n,(0,i.default)(this,"downloadInProgress",!1),(0,i.default)(this,"keyDownloadsQueuedByUser",{}),(0,i.default)(this,"queuedQueryDeferred",null),(0,i.default)(this,"syncToken",null)}updateDevicesForUsers(e,t){return e.forEach((e=>{this.keyDownloadsQueuedByUser[e]=!0})),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,u.defer)()),this.syncToken=t,this.downloadInProgress?(s.logger.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=null,s.logger.log("Starting key download for",e),this.downloadInProgress=!0;const n={};this.syncToken&&(n.token=this.syncToken);const r=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){const i=e.slice(t,t+this.deviceList.keyDownloadChunkSize);r.push((()=>this.baseApis.downloadKeysForUsers(i,n)))}return(0,u.chunkPromises)(r,3).then((async t=>{const n=Object.assign({},...t.map((e=>e.device_keys||{}))),r=Object.assign({},...t.map((e=>e.master_keys||{}))),i=Object.assign({},...t.map((e=>e.self_signing_keys||{}))),o=Object.assign({},...t.map((e=>e.user_signing_keys||{})));for(const t of e){await(0,u.sleep)(5);try{await this.processQueryResponseForUser(t,n[t],{master:r[t],self_signing:i[t],user_signing:o[t]})}catch(e){s.logger.error(`Error processing keys for ${t}:`,e)}}})).then((()=>{s.logger.log("Completed key download for "+e),this.downloadInProgress=!1,t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()}),(n=>{s.logger.warn("Error downloading keys for "+e+":",n),this.downloadInProgress=!1,t.reject(n)})),t.promise}async processQueryResponseForUser(e,t,n){s.logger.log("got device keys for "+e+":",t),s.logger.log("got cross-signing keys for "+e+":",n);{const n={},r=this.deviceList.getRawStoredDevicesForUser(e);r&&Object.keys(r).forEach((e=>{const t=o.DeviceInfo.fromStorage(r[e],e);n[e]=t})),await async function(e,t,n,r,i,o){let a=!1;for(const e in n)if(n.hasOwnProperty(e)&&!(e in r)){if(t===i&&e===o){s.logger.warn(`Local device ${e} missing from sync, skipping removal`);continue}s.logger.log("Device "+t+":"+e+" has been removed"),delete n[e],a=!0}for(const i in r){if(!r.hasOwnProperty(i))continue;const o=r[i];o.user_id===t?o.device_id===i?await v(e,n,o)&&(a=!0):s.logger.warn("Mismatched device_id "+o.device_id+" in keys from "+t+":"+i):s.logger.warn("Mismatched user_id "+o.user_id+" in keys from "+t+":"+i)}return a}(this.olmDevice,e,n,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const i={};Object.keys(n).forEach((e=>{i[e]=n[e].toStorage()})),this.deviceList.setRawStoredDevicesForUser(e,i)}if(n&&(n.master||n.self_signing||n.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new a.CrossSigningInfo(e);t.setKeys(n),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit(h.CryptoEvent.UserCrossSigningUpdated,e)}}}async function v(e,t,n){if(!n.keys)return!1;const r=n.device_id,i=n.user_id,a="ed25519:"+r,l=n.keys[a];if(!l)return s.logger.warn("Device "+i+":"+r+" has no ed25519 key"),!1;const u=n.unsigned||{},d=n.signatures||{};try{await c.verifySignature(e,n,i,r,l)}catch(e){return s.logger.warn("Unable to verify signature on device "+i+":"+r+":"+e),!1}let h;if(r in t){if(h=t[r],h.getFingerprint()!=l)return s.logger.warn("Ed25519 key for device "+i+":"+r+" has changed"),!1}else t[r]=h=new o.DeviceInfo(r);return h.keys=n.keys||{},h.algorithms=n.algorithms||[],h.unsigned=u,h.signatures=d,!0}},8045:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.EncryptionSetupOperation=t.EncryptionSetupBuilder=void 0;var i=r(n(3693)),s=n(9849),o=n(224),a=n(2180),c=n(3514),l=n(84),u=n(2660),d=n(7022);t.EncryptionSetupBuilder=class{constructor(e,t){(0,i.default)(this,"accountDataClientAdapter",void 0),(0,i.default)(this,"crossSigningCallbacks",void 0),(0,i.default)(this,"ssssCryptoCallbacks",void 0),(0,i.default)(this,"crossSigningKeys",null),(0,i.default)(this,"keySignatures",null),(0,i.default)(this,"keyBackupInfo",null),(0,i.default)(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new p(e),this.crossSigningCallbacks=new g,this.ssssCryptoCallbacks=new f(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,n){this.keySignatures||(this.keySignatures={});const r=this.keySignatures[e]||{};this.keySignatures[e]=r,r[t]=n}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new h(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){const t=(0,a.createCryptoStoreCacheCallbacks)(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){s.logger.log(`Cache ${e} cross-signing private key locally`);const n=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,n)}await e.cryptoStore.doTxn("readwrite",[c.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)}))}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}};class h{constructor(e,t,n,r){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=n,this.keySignatures=r}async apply(e){const t=e.baseApis;if(this.crossSigningKeys){const n={};for(const[e,t]of Object.entries(this.crossSigningKeys.keys))n[e+"_key"]=t;await this.crossSigningKeys.authUpload((e=>t.uploadDeviceSigningKeys(e,n))),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[e,n]of this.accountData)await t.setAccountData(e,n);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(void 0,l.Method.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:l.PREFIX_UNSTABLE}):await t.http.authedRequest(void 0,l.Method.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:l.PREFIX_UNSTABLE}))}}t.EncryptionSetupOperation=h;class p extends d.TypedEventEmitter{constructor(e){super(),this.existingValues=e,(0,i.default)(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const n=this.existingValues[e];return n?n.getContent():null}setAccountData(e,t){const n=this.values.get(e);return this.values.set(e,t),Promise.resolve().then((()=>{const r=new o.MatrixEvent({type:e,content:t});return this.emit(u.ClientEvent.AccountData,r,n),{}}))}}class g{constructor(){(0,i.default)(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,n]of Object.entries(e))this.privateKeys.set(t,n)}}class f{constructor(e){this.delegateCryptoCallbacks=e,(0,i.default)(this,"privateKeys",new Map)}async getSecretStorageKey({keys:e},t){var n;for(const t of Object.keys(e)){const e=this.privateKeys.get(t);if(e)return[t,e]}if(null!=this&&null!==(n=this.delegateCryptoCallbacks)&&void 0!==n&&n.getSecretStorageKey){const n=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(n){const[e,t]=n;this.privateKeys.set(e,t)}return n}return null}addPrivateKey(e,t,n){var r,i;this.privateKeys.set(e,n),null===(r=this.delegateCryptoCallbacks)||void 0===r||null===(i=r.cacheSecretStorageKey)||void 0===i||i.call(r,e,t,n)}}},8315:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.WITHHELD_MESSAGES=t.OlmDevice=void 0;var i=r(n(3693)),s=n(9849),o=n(3514),a=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=c(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4422));function c(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(c=function(e){return e?n:t})(e)}function l(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}t.OlmDevice=class{constructor(e){this.cryptoStore=e,(0,i.default)(this,"pickleKey","DEFAULT_KEY"),(0,i.default)(this,"deviceCurve25519Key",null),(0,i.default)(this,"deviceEd25519Key",null),(0,i.default)(this,"maxOneTimeKeys",null),(0,i.default)(this,"outboundGroupSessionStore",{}),(0,i.default)(this,"inboundGroupSessionMessageIndexes",{}),(0,i.default)(this,"sessionsInProgress",{}),(0,i.default)(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return n.g.Olm.get_library_version()}async init({pickleKey:e,fromExportedDevice:t}={}){let r;const i=new n.g.Olm.Account;try{t?(e&&s.logger.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=t.pickleKey,await this.initialiseFromExportedDevice(t,i)):(e&&(this.pickleKey=e),await this.initialiseAccount(i)),r=JSON.parse(i.identity_keys()),this.maxOneTimeKeys=i.max_number_of_one_time_keys()}finally{i.free()}this.deviceCurve25519Key=r.curve25519,this.deviceEd25519Key=r.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach((e=>{const{deviceKey:n,sessionId:r}=e,i={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(n,r,i,t)}))})),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.cryptoStore.getAccount(t,(n=>{null!==n?e.unpickle(this.pickleKey,n):(e.create(),n=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,n))}))}))}getAccount(e,t){this.cryptoStore.getAccount(e,(e=>{const r=new n.g.Olm.Account;try{r.unpickle(this.pickleKey,e),t(r)}finally{r.free()}}))}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.getAccount(t,(t=>{e.pickledAccount=t})),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,(t=>{e.sessions.push(t)}))})),e}getSession(e,t,n,r){this.cryptoStore.getEndToEndSession(e,t,n,(e=>{this.unpickleSession(e,r)}))}unpickleSession(e,t){const r=new n.g.Olm.Session;try{r.unpickle(this.pickleKey,e.session),t(Object.assign({},e,{session:r}))}finally{r.free()}}saveSession(e,t,n){const r=t.session.session_id(),i=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,r,i,n)}getUtility(e){const t=new n.g.Olm.Utility;try{return e(t)}finally{t.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(n=>{this.getAccount(n,(n=>{t=n.sign(e)}))})),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.one_time_keys())}))})),e}maxNumberOfOneTimeKeys(){return this.maxOneTimeKeys}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.mark_keys_as_published(),this.storeAccount(e,t)}))}))}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.getAccount(t,(n=>{n.generate_one_time_keys(e),this.storeAccount(t,n)}))}))}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.generate_fallback_key(),this.storeAccount(e,t)}))}))}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.unpublished_fallback_key())}))})),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)}))}))}async createOutboundSession(e,t){let r;return await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(i=>{this.getAccount(i,(s=>{const o=new n.g.Olm.Session;try{o.create_outbound(s,e,t),r=o.session_id(),this.storeAccount(i,s);const n={session:o,lastReceivedMessageTs:Date.now()};this.saveSession(e,n,i)}finally{o.free()}}))}),s.logger.withPrefix("[createOutboundSession]")),r}async createInboundSession(e,t,r){if(0!==t)throw new Error("Need messageType == 0 to create inbound session");let i;return await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(s=>{this.getAccount(s,(o=>{const a=new n.g.Olm.Session;try{a.create_inbound_from(o,e,r),o.remove_one_time_keys(a),this.storeAccount(s,o);const n=a.decrypt(t,r),c={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(e,c,s),i={payload:n,session_id:a.session_id()}}finally{a.free()}}))}),s.logger.withPrefix("[createInboundSession]")),i}async getSessionIdsForDevice(e){const t=s.logger.withPrefix("[getSessionIdsForDevice]");if(this.sessionsInProgress[e]){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}let n;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{n=Object.keys(e)}))}),t),n}async getSessionIdForDevice(e,t=!1,n){const r=await this.getSessionInfoForDevice(e,t,n);if(0===r.length)return null;let i=0;for(let e=1;e<r.length;e++){const t=r[e],n=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,s=r[i],o=void 0===s.lastReceivedMessageTs?0:s.lastReceivedMessageTs;(n>o||n===o&&t.sessionId<s.sessionId)&&(i=e)}return r[i].sessionId}async getSessionInfoForDevice(e,t=!1,n=s.logger){if(n=n.withPrefix("[getSessionInfoForDevice]"),this.sessionsInProgress[e]&&!t){n.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}const r=[];return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{const t=Object.keys(e).sort();for(const n of t)this.unpickleSession(e[n],(e=>{r.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:n})}))}))}),n),r}async encryptMessage(e,t,n){let r;return l(n),await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_SESSIONS],(i=>{this.getSession(e,t,i,(o=>{const a=o.session.describe();s.logger.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),r=o.session.encrypt(n),this.saveSession(e,o,i)}))}),s.logger.withPrefix("[encryptMessage]")),r}async decryptMessage(e,t,n,r){let i;return await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_SESSIONS],(o=>{this.getSession(e,t,o,(a=>{const c=a.session.describe();s.logger.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),i=a.session.decrypt(n,r),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,o)}))}),s.logger.withPrefix("[decryptMessage]")),i}async matchesSession(e,t,n,r){if(0!==n)return!1;let i;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SESSIONS],(n=>{this.getSession(e,t,n,(e=>{i=e.session.matches_inbound(r)}))}),s.logger.withPrefix("[matchesSession]")),i}async recordSessionProblem(e,t,n){await this.cryptoStore.storeEndToEndSessionProblem(e,t,n)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){const r=this.outboundGroupSessionStore[e];if(void 0===r)throw new Error("Unknown outbound group session "+e);const i=new n.g.Olm.OutboundGroupSession;try{return i.unpickle(this.pickleKey,r),t(i)}finally{i.free()}}createOutboundGroupSession(){const e=new n.g.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return s.logger.log(`encrypting msg with megolm session ${e}`),l(t),this.getOutboundGroupSession(e,(e=>{const n=e.encrypt(t);return this.saveOutboundGroupSession(e),n}))}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(e,t){const r=new n.g.Olm.InboundGroupSession;try{return r.unpickle(this.pickleKey,e.session),t(r)}finally{r.free()}}getInboundGroupSession(e,t,n,r,i){this.cryptoStore.getEndToEndInboundGroupSession(t,n,r,((t,n)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,(e=>{i(e,t,n)}))}else i(null,null,n)}))}async addInboundGroupSession(e,t,r,i,a,c,l,u={}){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,o.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(o=>{this.getInboundGroupSession(e,t,i,o,((d,h)=>{const p=new n.g.Olm.InboundGroupSession;try{if(l?p.import_session(a):p.create(a),i!=p.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(d&&(s.logger.log("Update for megolm session "+t+"/"+i),d.first_known_index()<=p.first_known_index())){if(!h.untrusted||u.untrusted)return void s.logger.log(`Keeping existing megolm session ${i}`);if(d.first_known_index()<p.first_known_index())return void(d.export_session(p.first_known_index())===p.export_session(p.first_known_index())?(s.logger.info("Upgrading trust of existing megolm session "+i+" based on newly-received trusted session"),h.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(t,i,h,o)):s.logger.warn("Newly-received megolm session "+i+" does not match existing session! Keeping existing session"))}s.logger.info("Storing megolm session "+t+"/"+i+" with first index "+p.first_known_index());const n=Object.assign({},u,{room_id:e,session:p.pickle(this.pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:r});this.cryptoStore.storeEndToEndInboundGroupSession(t,i,n,o),!d&&u.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(e,t,i,o)}finally{p.free()}}))}),s.logger.withPrefix("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,n,r,i){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(s=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,n,{room_id:e,code:r,reason:i},s)}))}async decryptGroupMessage(e,t,n,r,i,c){let l,u;if(await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(s=>{this.getInboundGroupSession(e,t,n,s,((e,o,h)=>{if(null===e)return h&&(u=new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",d(h),{session:t+"|"+n})),void(l=null);let p;try{p=e.decrypt(r)}catch(e){return void(u=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&h?new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",d(h),{session:t+"|"+n}):e)}let g=p.plaintext;if(void 0===g)g=p;else{const e=t+"|"+n+"|"+p.message_index;if(e in this.inboundGroupSessionMessageIndexes){const t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==i||t.timestamp!==c)return void(u=new Error("Duplicate message index, possible replay attack: "+e))}this.inboundGroupSessionMessageIndexes[e]={id:i,timestamp:c}}o.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,n,o,s),l={result:g,keysClaimed:o.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:o.forwardingCurve25519KeyChain||[],untrusted:o.untrusted}}))}),s.logger.withPrefix("[decryptGroupMessage]")),u)throw u;return l}async hasInboundSessionKeys(e,t,n){let r;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(i=>{this.cryptoStore.getEndToEndInboundGroupSession(t,n,i,(i=>{null!==i?e!==i.room_id?(s.logger.warn(`requested keys for inbound group session ${t}|${n}, with incorrect room_id (expected ${i.room_id}, was ${e})`),r=!1):r=!0:r=!1}))}),s.logger.withPrefix("[hasInboundSessionKeys]")),r}async getInboundGroupSessionKey(e,t,n,r){let i;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(s=>{this.getInboundGroupSession(e,t,n,s,((e,t)=>{if(null===e)return void(i=null);void 0===r&&(r=e.first_known_index());const n=e.export_session(r),s=(t.keysClaimed||{}).ed25519||null,o=t.forwardingCurve25519KeyChain||[],a="untrusted"in t?t.untrusted:o.length>0;i={chain_index:r,key:n,forwarding_curve25519_key_chain:o,sender_claimed_ed25519_key:s,shared_history:t.sharedHistory||!1,untrusted:a}}))}),s.logger.withPrefix("[getInboundGroupSessionKey]")),i}exportInboundGroupSession(e,t,n){return this.unpickleInboundGroupSession(n,(r=>{const i=r.first_known_index();return{sender_key:e,sender_claimed_keys:n.keysClaimed,room_id:n.room_id,session_id:t,session_key:r.export_session(i),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:r.first_known_index(),"org.matrix.msc3061.shared_history":n.sharedHistory||!1}}))}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(n=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,n)}),s.logger.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,n){this.getUtility((function(r){r.ed25519_verify(e,t,n)}))}};const u={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function d(e){return e.code&&e.code in u?u[e.code]:e.reason?e.reason:"decryption key withheld"}t.WITHHELD_MESSAGES=u},4875:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomKeyRequestState=t.OutgoingRoomKeyRequestManager=void 0;var i=r(n(3693)),s=n(9849),o=n(4703);let a;function c(e){return e.room_id+" / "+e.session_id}function l(e){return"["+e.map((e=>`${e.userId}:${e.deviceId}`)).join(",")+"]"}t.RoomKeyRequestState=a,function(e){e[e.Unsent=0]="Unsent",e[e.Sent=1]="Sent",e[e.CancellationPending=2]="CancellationPending",e[e.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend"}(a||(t.RoomKeyRequestState=a={})),t.OutgoingRoomKeyRequestManager=class{constructor(e,t,n){this.baseApis=e,this.deviceId=t,this.cryptoStore=n,(0,i.default)(this,"sendOutgoingRoomKeyRequestsTimer",null),(0,i.default)(this,"sendOutgoingRoomKeyRequestsRunning",!1),(0,i.default)(this,"clientRunning",!1)}start(){this.clientRunning=!0}stop(){s.logger.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t,n=!1){const r=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(r)switch(r.state){case a.CancellationPendingAndWillResend:case a.Unsent:return;case a.CancellationPending:{const e=n?a.CancellationPendingAndWillResend:a.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,a.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case a.Sent:if(n){const i=a.CancellationPendingAndWillResend,o=await this.cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,a.Sent,{state:i,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!o)return this.queueRoomKeyRequest(e,t,n);try{await this.sendOutgoingRoomKeyRequestCancellation(o,!0)}catch(e){s.logger.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+r.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:a.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then((t=>{if(t)switch(t.state){case a.CancellationPending:case a.CancellationPendingAndWillResend:return;case a.Unsent:return s.logger.log("deleting unnecessary room key request for "+c(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,a.Unsent);case a.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,a.Sent,{state:a.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then((t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch((e=>{s.logger.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()})):s.logger.log("Tried to cancel room key request for "+c(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+t.state)}}))}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[a.Sent])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(a.Sent);return Promise.all(e.map((({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0))))}startTimer(){this.sendOutgoingRoomKeyRequestsTimer||(this.sendOutgoingRoomKeyRequestsTimer=setTimeout((()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally((()=>{this.sendOutgoingRoomKeyRequestsRunning=!1})).catch((e=>{s.logger.warn(`error in OutgoingRoomKeyRequestManager: ${e}`)}))}),500))}sendOutgoingRoomKeyRequests(){return this.clientRunning?this.cryptoStore.getOutgoingRoomKeyRequestByState([a.CancellationPending,a.CancellationPendingAndWillResend,a.Unsent]).then((e=>{if(!e)return void(this.sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case a.Unsent:t=this.sendOutgoingRoomKeyRequest(e);break;case a.CancellationPending:t=this.sendOutgoingRoomKeyRequestCancellation(e);break;case a.CancellationPendingAndWillResend:t=this.sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then((()=>this.sendOutgoingRoomKeyRequests())).catch((e=>{s.logger.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=null}))})):(this.sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}sendOutgoingRoomKeyRequest(e){s.logger.log(`Requesting keys for ${c(e.requestBody)} from ${l(e.recipients)}(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then((()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,a.Unsent,{state:a.Sent})))}sendOutgoingRoomKeyRequestCancellation(e,t=!1){s.logger.log(`Sending cancellation for key request for ${c(e.requestBody)} to ${l(e.recipients)} (cancellation id ${e.cancellationTxnId})`);const n={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then((()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,a.CancellationPendingAndWillResend,{state:a.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,a.CancellationPending)))}sendMessageToDevices(e,t,n){const r={};for(const n of t)r[n.userId]||(r[n.userId]={}),r[n.userId][n.deviceId]=e;return this.baseApis.sendToDevice(o.EventType.RoomKeyRequest,r,n)}}},3408:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomList=void 0;var i=r(n(3693)),s=n(3514);t.RoomList=class{constructor(e){this.cryptoStore=e,(0,i.default)(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ROOMS],(e=>{this.cryptoStore.getEndToEndRooms(e,(e=>{this.roomEncryption=e}))}))}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ROOMS],(n=>{this.cryptoStore.storeEndToEndRoom(e,t,n)}))}}},4430:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SecretStorage=t.SECRET_STORAGE_ALGORITHM_V1_AES=void 0;var i=r(n(3693)),s=n(9849),o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=u(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(1978)),a=n(3759),c=n(5936),l=n(2660);function u(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(u=function(e){return e?n:t})(e)}const d="m.secret_storage.v1.aes-hmac-sha2";t.SECRET_STORAGE_ALGORITHM_V1_AES=d,t.SecretStorage=class{constructor(e,t,n){this.accountDataAdapter=e,this.cryptoCallbacks=t,this.baseApis=n,(0,i.default)(this,"requests",new Map)}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(((t,n)=>{const r=n=>{"m.secret_storage.default_key"===n.getType()&&n.getContent().key===e&&(this.accountDataAdapter.removeListener(l.ClientEvent.AccountData,r),t())};this.accountDataAdapter.on(l.ClientEvent.AccountData,r),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch((e=>{this.accountDataAdapter.removeListener(l.ClientEvent.AccountData,r),n(e)}))}))}async addKey(e,t,n){const r={algorithm:e};if(t||(t={}),t.name&&(r.name=t.name),e!==d)throw new Error(`Unknown key algorithm ${e}`);if(t.passphrase&&(r.passphrase=t.passphrase),t.key){const{iv:e,mac:n}=await(0,c.calculateKeyCheck)(t.key);r.iv=e,r.mac=n}if(!n)do{n=(0,a.randomString)(32)}while(await this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${n}`));return await this.accountDataAdapter.setAccountData(`m.secret_storage.key.${n}`,r),{keyId:n,keyInfo:r}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return Boolean(await this.getKey(e))}async checkKey(e,t){if(t.algorithm===d){if(t.mac){const{mac:n}=await(0,c.calculateKeyCheck)(e,t.iv);return t.mac.replace(/=+$/g,"")===n.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}async store(e,t,n){const r={};if(!n){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");n=[e]}if(0===n.length)throw new Error("Zero keys given to encrypt with!");for(const i of n){const n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+i);if(!n)throw new Error("Unknown key: "+i);if(n.algorithm===d){const s={[i]:n},[,o]=await this.getSecretStorageKey(s,e);r[i]=await o.encrypt(t)}else s.logger.warn("unknown algorithm for secret storage key "+i+": "+n.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:r})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const n={};for(const e of Object.keys(t.encrypted)){const r=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e),i=t.encrypted[e];r.algorithm===d&&i.iv&&i.ciphertext&&i.mac&&(n[e]=r)}if(0===Object.keys(n).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let r,i;try{[r,i]=await this.getSecretStorageKey(n,e);const s=t.encrypted[r];return s.passthrough?(0,o.encodeBase64)(i.get_private_key()):i.decrypt(s)}finally{i&&i.free&&i.free()}}async isStored(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(null==t||!t.encrypted)return null;const n={};for(const e of Object.keys(t.encrypted)){const r=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);if(!r)continue;const i=t.encrypted[e];r.algorithm===d&&i.iv&&i.ciphertext&&i.mac&&(n[e]=r)}return Object.keys(n).length?n:null}request(e,t){const n=this.baseApis.makeTxnId();let r,i;const o=new Promise(((e,t)=>{r=e,i=t}));this.requests.set(n,{name:e,devices:t,resolve:r,reject:i});const a={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:n},c={};for(const e of t)c[e]=a;return s.logger.info(`Request secret ${e} from ${t}, id ${n}`),this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:c}),{requestId:n,promise:o,cancel:e=>{const r={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:n},s={};for(const e of t)s[e]=r;this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:s}),i(new Error(e||"Cancelled"))}}}async onRequestReceived(e){const t=e.getSender(),n=e.getContent();if(t!==this.baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))return;const r=n.requesting_device_id;if("request_cancellation"===n.action);else if("request"===n.action){if(r===this.baseApis.deviceId)return;if(s.logger.info("received request for secret ("+t+", "+r+", "+n.request_id+")"),!this.cryptoCallbacks.onSecretRequested)return;const e=await this.cryptoCallbacks.onSecretRequested(t,r,n.request_id,n.name,this.baseApis.checkDeviceTrust(t,r));if(e){s.logger.info(`Preparing ${n.name} secret for ${r}`);const i={type:"m.secret.send",content:{request_id:n.request_id,secret:e}},a={algorithm:o.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{}};await o.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,{[t]:[this.baseApis.getStoredDevice(t,r)]}),await o.encryptMessageForDevice(a.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,r),i);const c={[t]:{[r]:a}};s.logger.info(`Sending ${n.name} secret for ${r}`),this.baseApis.sendToDevice("m.room.encrypted",c)}else s.logger.info(`Request denied for ${n.name} secret for ${r}`)}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;if(!o.isOlmEncrypted(e))return void s.logger.error("secret event not properly encrypted");const t=e.getContent();if(this.baseApis.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,e.getSenderKey()||"")!==e.getSender())return void s.logger.error("sending device does not belong to the user it claims to be from");s.logger.log("got secret share for request",t.request_id);const n=this.requests.get(t.request_id);if(n){const r=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,e.getSenderKey());if(!r)return void s.logger.log("secret share from unknown device with key",e.getSenderKey());if(!n.devices.includes(r.deviceId))return void s.logger.log("unsolicited secret share from device",r.deviceId);if(!this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),r).isVerified())return void s.logger.log("secret share from unverified device");s.logger.log(`Successfully received secret ${n.name} from ${r.deviceId}`),n.resolve(t.secret)}}async getSecretStorageKey(e,t){if(!this.cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const n=await this.cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[r,i]=n;if(!e[r])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[r].algorithm===d)return[r,{encrypt:function(e){return(0,c.encryptAES)(e,i,t)},decrypt:function(e){return(0,c.decryptAES)(e,i,t)}}];throw new Error("Unknown key type: "+e[r].algorithm)}}},5936:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateKeyCheck=function(e,t){return l(u,e,"",t)},t.decryptAES=function(e,t,n){return s?async function(e,t,n){const[r,o]=await c(t,n),a=(0,i.decodeBase64)(e.ciphertext);if(!await s.verify({name:"HMAC"},o,(0,i.decodeBase64)(e.mac),a))throw new Error(`Error decrypting secret ${n}: bad MAC`);const l=await s.decrypt({name:"AES-CTR",counter:(0,i.decodeBase64)(e.iv),length:64},r,a);return(new TextDecoder).decode(new Uint8Array(l))}(e,t,n):async function(e,t,n){const s=(0,r.getCrypto)();if(!s)throw new Error("No usable crypto implementation");const[o,c]=a(t,n);if(s.createHmac("sha256",c).update(Buffer.from(e.ciphertext,"base64")).digest("base64").replace(/=+$/g,"")!==e.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${n}: bad MAC`);const l=s.createDecipheriv("aes-256-ctr",o,(0,i.decodeBase64)(e.iv));return l.update(e.ciphertext,"base64","utf8")+l.final("utf8")}(e,t,n)},t.encryptAES=l;var r=n(4148),i=n(1978);const s="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,o=new Uint8Array(8);function a(e,t){const n=(0,r.getCrypto)(),i=n.createHmac("sha256",o).update(e).digest(),s=Buffer.alloc(1,1),a=n.createHmac("sha256",i).update(t,"utf8").update(s).digest();return s[0]=2,[a,n.createHmac("sha256",i).update(a).update(t,"utf8").update(s).digest()]}async function c(e,t){const n=await s.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),r=await s.deriveBits({name:"HKDF",salt:o,info:(new TextEncoder).encode(t),hash:"SHA-256"},n,512),i=r.slice(0,32),a=r.slice(32),c=s.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=s.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([c,l])}function l(e,t,n,o){return s?async function(e,t,n,r){let o;r?o=(0,i.decodeBase64)(r):(o=new Uint8Array(16),window.crypto.getRandomValues(o),o[8]&=127);const[a,l]=await c(t,n),u=(new TextEncoder).encode(e),d=await s.encrypt({name:"AES-CTR",counter:o,length:64},a,u),h=await s.sign({name:"HMAC"},l,d);return{iv:(0,i.encodeBase64)(o),ciphertext:(0,i.encodeBase64)(d),mac:(0,i.encodeBase64)(h)}}(e,t,n,o):async function(e,t,n,s){const o=(0,r.getCrypto)();if(!o)throw new Error("No usable crypto implementation");let c;s?c=(0,i.decodeBase64)(s):(c=o.randomBytes(16),c[8]&=127);const[l,u]=a(t,n),d=o.createCipheriv("aes-256-ctr",l,c),h=Buffer.concat([d.update(e,"utf8"),d.final()]),p=o.createHmac("sha256",u).update(h).digest("base64");return{iv:(0,i.encodeBase64)(c),ciphertext:h.toString("base64"),mac:p}}(e,t,n,o)}const u="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"},2589:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.UnknownDeviceError=t.EncryptionAlgorithm=t.ENCRYPTION_CLASSES=t.DecryptionError=t.DecryptionAlgorithm=t.DECRYPTION_CLASSES=void 0,t.registerAlgorithm=function(e,t,n){s.set(e,t),o.set(e,n)};var i=r(n(3693));const s=new Map;t.ENCRYPTION_CLASSES=s;const o=new Map;t.DECRYPTION_CLASSES=o,t.EncryptionAlgorithm=class{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"crypto",void 0),(0,i.default)(this,"olmDevice",void 0),(0,i.default)(this,"baseApis",void 0),(0,i.default)(this,"roomId",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,n){}},t.DecryptionAlgorithm=class{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"crypto",void 0),(0,i.default)(this,"olmDevice",void 0),(0,i.default)(this,"baseApis",void 0),(0,i.default)(this,"roomId",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}async onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}};class a extends Error{constructor(e,t,n){super(t),this.code=e,(0,i.default)(this,"detailedString",void 0),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let n=e.name+"[msg: "+e.message;return t&&(n+=", "+Object.keys(t).map((e=>e+": "+t[e])).join(", ")),n+="]",n}(this,n)}}t.DecryptionError=a;class c extends Error{constructor(e,t){super(e),this.devices=t,this.name="UnknownDeviceError",this.devices=t}}t.UnknownDeviceError=c},4422:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(3984),n(8259);var r=n(2589);Object.keys(r).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))}))},8259:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.isRoomSharedHistory=d;var i=r(n(3693)),s=n(9849),o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=u(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(1978)),a=n(2589),c=n(8315),l=n(4875);function u(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(u=function(e){return e?n:t})(e)}function d(e){var t,n;const r=null==e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),i=null==r||null===(n=r.getContent())||void 0===n?void 0:n.history_visibility;return["world_readable","shared"].includes(i)}class h{constructor(e,t=!1){this.sessionId=e,this.sharedHistory=t,(0,i.default)(this,"useCount",0),(0,i.default)(this,"creationTime",void 0),(0,i.default)(this,"sharedWithDevices",{}),(0,i.default)(this,"blockedDevicesNotified",{}),this.creationTime=(new Date).getTime()}needsRotation(e,t){const n=(new Date).getTime()-this.creationTime;return(this.useCount>=e||n>=t)&&(s.logger.log("Rotating megolm session after "+this.useCount+" messages, "+n+"ms"),!0)}markSharedWithDevice(e,t,n,r){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]={deviceKey:n,messageIndex:r}}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0}sharedWithTooManyDevices(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return s.logger.log("Starting new megolm session because we shared with "+t),!0;for(const n in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(n)&&!e[t].hasOwnProperty(n))return s.logger.log("Starting new megolm session because we shared with "+t+":"+n),!0}return!1}}class p extends a.EncryptionAlgorithm{constructor(e){var t,n,r,s;super(e),(0,i.default)(this,"setupPromise",Promise.resolve(null)),(0,i.default)(this,"outboundSessions",{}),(0,i.default)(this,"sessionRotationPeriodMsgs",void 0),(0,i.default)(this,"sessionRotationPeriodMs",void 0),(0,i.default)(this,"encryptionPreparation",void 0),this.sessionRotationPeriodMsgs=null!==(t=null===(n=e.config)||void 0===n?void 0:n.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(r=null===(s=e.config)||void 0===s?void 0:s.rotation_period_ms)&&void 0!==r?r:6048e5}async ensureOutboundSession(e,t,n,r=!1){const i=this.setupPromise.then((async i=>{const o=d(e),a=await this.prepareSession(t,o,i);try{await this.shareSession(t,o,r,n,a)}catch(e){s.logger.error(`Failed to ensure outbound session in ${this.roomId}`,e)}return a}));return i.catch((e=>{s.logger.error(`Failed to setup outbound session in ${this.roomId}`,e)})),this.setupPromise=i,i}async prepareSession(e,t,n){var r,i;return n&&t!==n.sharedHistory&&(n=null),null!==(r=n)&&void 0!==r&&r.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(s.logger.log("Starting new megolm session because we need to rotate."),n=null),null!==(i=n)&&void 0!==i&&i.sharedWithTooManyDevices(e)&&(n=null),n||(s.logger.log(`Starting new megolm session for room ${this.roomId}`),n=await this.prepareNewSession(t),s.logger.log(`Started new megolm session ${n.sessionId} for room ${this.roomId}`),this.outboundSessions[n.sessionId]=n),n}async shareSession(e,t,n,r,i){const a={};for(const[t,n]of Object.entries(e))for(const[e,r]of Object.entries(n))r.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(i.sharedWithDevices[t]&&void 0!==i.sharedWithDevices[t][e]||(a[t]=a[t]||[],a[t].push(r)));const c=this.olmDevice.getOutboundGroupSessionKey(i.sessionId),l={type:"m.room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:i.sessionId,session_key:c.key,chain_index:c.chain_index,"org.matrix.msc3061.shared_history":t}},[u,d]=await o.getExistingOlmSessions(this.olmDevice,this.baseApis,a);await Promise.all([(async()=>{s.logger.debug(`Sharing keys with existing Olm sessions in ${this.roomId}`,d),await this.shareKeyWithOlmSessions(i,c,l,d),s.logger.debug(`Shared keys with existing Olm sessions in ${this.roomId}`)})(),(async()=>{s.logger.debug(`Sharing keys (start phase 1) with new Olm sessions in ${this.roomId}`,u);const e=[],t=Date.now(),r=[];await this.shareKeyWithDevices(i,c,l,u,e,n?1e4:2e3,r),s.logger.debug(`Shared keys (end phase 1) with new Olm sessions in ${this.roomId}`),!n&&Date.now()-t<1e4?(async()=>{const t={},n=new Set;for(const e of r)n.add(e);const o=[];for(const{userId:r,deviceInfo:i}of e){const e=r.slice(r.indexOf(":")+1);n.has(e)?(t[r]=t[r]||[],t[r].push(i)):o.push({userId:r,deviceInfo:i})}s.logger.debug(`Sharing keys (start phase 2) with new Olm sessions in ${this.roomId}`),await this.shareKeyWithDevices(i,c,l,t,o,3e4),s.logger.debug(`Shared keys (end phase 2) with new Olm sessions in ${this.roomId}`),await this.notifyFailedOlmDevices(i,c,o)})():await this.notifyFailedOlmDevices(i,c,e),s.logger.debug(`Shared keys (all phases done) with new Olm sessions in ${this.roomId}`)})(),(async()=>{s.logger.debug(`There are ${Object.entries(r).length} blocked devices in ${this.roomId}`,Object.entries(r)),s.logger.debug(`Notifying newly blocked devices in ${this.roomId}`);const e={};let t=0;for(const[n,s]of Object.entries(r))for(const[r,o]of Object.entries(s))i.blockedDevicesNotified[n]&&void 0!==i.blockedDevicesNotified[n][r]||(e[n]=e[n]||{},e[n][r]={device:o},t++);await this.notifyBlockedDevices(i,e),s.logger.debug(`Notified ${t} newly blocked devices in ${this.roomId}`,e)})()])}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),n=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,n.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new h(t,e)}getDevicesWithoutSessions(e,t,n=[]){for(const[r,i]of Object.entries(t)){const t=e[r];for(const e of i){const i=e.deviceId;t[i].sessionId||(n.push({userId:r,deviceInfo:e}),delete t[i])}}return n}splitDevices(e){let t=[];const n=[t];for(const[r,i]of Object.entries(e)){for(const e of Object.values(i))t.push({userId:r,deviceInfo:e.device});t.length>20&&(t=[],n.push(t))}return 0===t.length&&n.pop(),n}encryptAndSendKeysToDevices(e,t,n,r){return this.crypto.encryptAndSendToDevices(n,r).then((()=>{for(const r of n)e.markSharedWithDevice(r.userId,r.deviceInfo.deviceId,r.deviceInfo.getIdentityKey(),t)})).catch((e=>{throw s.logger.error("failed to encryptAndSendToDevices",e),e}))}async sendBlockedNotificationsToDevices(e,t,n){const r={};for(const e of t){const t=e.userId,i=e.deviceInfo,s=i.deviceInfo.deviceId,o=Object.assign({},n);o.code=i.code,o.reason=i.reason,"m.no_olm"===o.code&&(delete o.room_id,delete o.session_id),r[t]||(r[t]={}),r[t][s]=o}await this.baseApis.sendToDevice("m.room_key.withheld",r);for(const t of Object.keys(r))for(const n of Object.keys(r[t]))e.markNotifiedBlockedDevice(t,n)}async reshareKeyWithDevice(e,t,n,r){const i=this.outboundSessions[t];if(!i)return void s.logger.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===i.sharedWithDevices[n])return void s.logger.debug(`megolm session ${t} never shared with user ${n}`);const a=i.sharedWithDevices[n][r.deviceId];if(void 0===a)return void s.logger.debug("megolm session ID "+t+" never shared with device "+n+":"+r.deviceId);if(a.deviceKey!==r.getIdentityKey())return void s.logger.warn(`Session has been shared with device ${r.deviceId} but with identity key ${a.deviceKey}. Key is now ${r.getIdentityKey()}!`);const c=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,a.messageIndex);if(!c)return void s.logger.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[n]:[r]});const l={type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},u={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(u.ciphertext,this.userId,this.deviceId,this.olmDevice,n,r,l),await this.baseApis.sendToDevice("m.room.encrypted",{[n]:{[r.deviceId]:u}}),s.logger.debug(`Re-shared key for megolm session ${t} with ${n}:${r.deviceId}`)}async shareKeyWithDevices(e,t,n,r,i,a,c){var l;s.logger.debug(`Ensuring Olm sessions for devices in ${this.roomId}`);const u=await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,r,!1,a,c,null===(l=s.logger.withPrefix)||void 0===l?void 0:l.call(s.logger,`[${this.roomId}]`));s.logger.debug(`Ensured Olm sessions for devices in ${this.roomId}`),this.getDevicesWithoutSessions(u,r,i),s.logger.debug(`Sharing keys with newly created Olm sessions in ${this.roomId}`),await this.shareKeyWithOlmSessions(e,t,n,u),s.logger.debug(`Shared keys with newly created Olm sessions in ${this.roomId}`)}async shareKeyWithOlmSessions(e,t,n,r){const i=this.splitDevices(r);for(let r=0;r<i.length;r++){const o=`megolm keys for ${e.sessionId} in ${this.roomId} (slice ${r+1}/${i.length})`;try{s.logger.debug(`Sharing ${o}`,i[r].map((e=>`${e.userId}/${e.deviceInfo.deviceId}`))),await this.encryptAndSendKeysToDevices(e,t.chain_index,i[r],n),s.logger.debug(`Shared ${o}`)}catch(e){throw s.logger.error(`Failed to share ${o}`),e}}}async notifyFailedOlmDevices(e,t,n){s.logger.debug(`Notifying ${n.length} devices we failed to create Olm sessions in ${this.roomId}`);for(const{userId:r,deviceInfo:i}of n){const n=i.deviceId;e.markSharedWithDevice(r,n,i.getIdentityKey(),t.chain_index)}const r=await this.olmDevice.filterOutNotifiedErrorDevices(n);s.logger.debug(`Need to notify ${r.length} failed devices which haven't been notified before in ${this.roomId}`);const i={};for(const{userId:e,deviceInfo:t}of r)i[e]=i[e]||{},i[e][t.deviceId]={device:{code:"m.no_olm",reason:c.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:t}};await this.notifyBlockedDevices(e,i),s.logger.debug(`Notified ${r.length} devices we failed to create Olm sessions in ${this.roomId}`)}async notifyBlockedDevices(e,t){const n={room_id:this.roomId,session_id:e.sessionId,algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},r=this.splitDevices(t);for(let t=0;t<r.length;t++)try{await this.sendBlockedNotificationsToDevices(e,r[t],n),s.logger.log(`Completed blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${t+1}/${r.length})`)}catch(n){throw s.logger.log(`blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${t+1}/${r.length}) failed`),n}}prepareToEncrypt(e){if(null==this.encryptionPreparation)s.logger.debug(`Preparing to encrypt events for ${this.roomId}`),this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{s.logger.debug(`Getting devices in ${this.roomId}`);const[t,n]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.removeUnknownDevices(t),s.logger.debug(`Ensuring outbound session in ${this.roomId}`),await this.ensureOutboundSession(e,t,n,!0),s.logger.debug(`Ready to encrypt events for ${this.roomId}`)}catch(e){s.logger.error(`Failed to prepare to encrypt events for ${this.roomId}`,e)}finally{delete this.encryptionPreparation}})()};else{const e=Date.now()-this.encryptionPreparation.startTime;s.logger.debug(`Already started preparing to encrypt for ${this.roomId} ${e} ms ago, skipping`)}}async encryptMessage(e,t,n){if(s.logger.log(`Starting to encrypt event for ${this.roomId}`),null!=this.encryptionPreparation)try{await this.encryptionPreparation.promise}catch(e){}const[r,i]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.checkForUnknownDevices(r);const a=await this.ensureOutboundSession(e,r,i),c={room_id:this.roomId,type:t,content:n},l=this.olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),u={algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:l,session_id:a.sessionId,device_id:this.deviceId};return a.useCount++,u}forceDiscardSession(){this.setupPromise=this.setupPromise.then((()=>null))}checkForUnknownDevices(e){const t={};if(Object.keys(e).forEach((n=>{Object.keys(e[n]).forEach((r=>{const i=e[n][r];i.isUnverified()&&!i.isKnown()&&(t[n]||(t[n]={}),t[n][r]=i)}))})),Object.keys(t).length)throw new a.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,n]of Object.entries(e)){for(const[e,t]of Object.entries(n))t.isUnverified()&&!t.isKnown()&&delete n[e];0===Object.keys(n).length&&delete e[t]}}async getDevicesInRoom(e){const t=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));let n=this.crypto.getGlobalBlacklistUnverifiedDevices();"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(n=e.getBlacklistUnverifiedDevices());const r=await this.crypto.downloadKeys(t,!1),i={};for(const e in r){if(!r.hasOwnProperty(e))continue;const t=r[e];for(const r in t){if(!t.hasOwnProperty(r))continue;const s=this.crypto.checkDeviceTrust(e,r);if(t[r].isBlocked()||!s.isVerified()&&n){i[e]||(i[e]={});const n=t[r].isBlocked();i[e][r]={code:n?"m.blacklisted":"m.unverified",reason:c.WITHHELD_MESSAGES[n?"m.blacklisted":"m.unverified"],deviceInfo:t[r]},delete t[r]}}}return[r,i]}}class g extends a.DecryptionAlgorithm{constructor(...e){super(...e),(0,i.default)(this,"pendingEvents",new Map),(0,i.default)(this,"olmlib",o)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new a.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");let n;this.addEventToPendingList(e);try{n=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(n){if("DecryptionError"===n.name)throw n;let r="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw n&&"OLM.UNKNOWN_MESSAGE_INDEX"===n.message&&(this.requestKeysForEvent(e),r="OLM_UNKNOWN_MESSAGE_INDEX"),new a.DecryptionError(r,n?n.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===n){this.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),t.session_id).catch((()=>{})),this.requestKeysForEvent(e);const n=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(n){let e=f[n.type]||f.unknown;throw n.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}n.untrusted||this.removeEventFromPendingList(e);const r=JSON.parse(n.result);if(r.room_id!==e.getRoomId())throw new a.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+r.room_id);return{clearEvent:r,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),n=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},n)}addEventToPendingList(e){var t;const n=e.getWireContent(),r=n.sender_key,i=n.session_id;this.pendingEvents.has(r)||this.pendingEvents.set(r,new Map);const s=this.pendingEvents.get(r);s.has(i)||s.set(i,new Set),null===(t=s.get(i))||void 0===t||t.add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),n=t.sender_key,r=t.session_id,i=this.pendingEvents.get(n),s=null==i?void 0:i.get(r);s&&(s.delete(e),0===s.size&&i.delete(r),0===i.size&&this.pendingEvents.delete(n))}async onRoomKeyEvent(e){const t=e.getContent();let n,r=e.getSenderKey(),i=[],a=!1;const c={};if(t.room_id&&t.session_key&&t.session_id&&t.algorithm)if(o.isOlmEncrypted(e)){if(t["org.matrix.msc3061.shared_history"]&&(c.sharedHistory=!0),"m.forwarded_room_key"==e.getType()){var u,d,h;const p=this.crypto.deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,r);if(this.baseApis.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,r)!==e.getSender())return void s.logger.error("sending device does not belong to the user it claims to be from");const g=(p?await this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),p.deviceId,[l.RoomKeyRequestState.Sent]):[]).some((e=>e.requestBody.room_id===t.room_id&&e.requestBody.session_id===t.session_id)),f=this.baseApis.getRoom(t.room_id),m=null==f||null===(u=f.getMember(this.userId))||void 0===u?void 0:u.events.member,v=(null==m?void 0:m.getSender())===e.getSender()||(null==m||null===(d=m.getUnsigned())||void 0===d?void 0:d.prev_sender)===e.getSender()&&"invite"===(null==m||null===(h=m.getPrevContent())||void 0===h?void 0:h.membership),y=e.getSender()===this.baseApis.getUserId();if(!g&&!y){if(!c.sharedHistory)return void s.logger.log("forwarded key not shared history - ignoring");if(f&&!v)return void s.logger.log("forwarded key not from inviter or from us - ignoring")}if(a=!0,i=Array.isArray(t.forwarding_curve25519_key_chain)?t.forwarding_curve25519_key_chain:[],i=i.slice(),i.push(r),!t.sender_key)return void s.logger.error("forwarded_room_key event is missing sender_key field");const _=t.sender_claimed_ed25519_key;if(!_)return void s.logger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");if(n={ed25519:_},!f){const r={senderId:e.getSender(),senderKey:t.sender_key,sessionId:t.session_id,sessionKey:t.session_key,keysClaimed:n,forwardingCurve25519KeyChain:i};return void await this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],(e=>this.crypto.cryptoStore.addParkedSharedHistory(t.room_id,r,e)),s.logger.withPrefix("[addParkedSharedHistory]"))}const b=this.crypto.deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,r),E=this.crypto.checkDeviceInfoTrust(e.getSender(),b);if(y&&!E.isVerified())return;c.untrusted=!0,r=t.sender_key}else n=e.getKeysClaimed();t["org.matrix.msc3061.shared_history"]&&(c.sharedHistory=!0);try{await this.olmDevice.addInboundGroupSession(t.room_id,r,i,t.session_id,t.session_key,n,a,c),await this.retryDecryption(r,t.session_id,!c.untrusted)&&this.crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:r}),await this.crypto.backupManager.backupGroupSession(r,t.session_id)}catch(e){s.logger.error(`Error handling m.room_key_event: ${e}`)}}else s.logger.error("key event not properly encrypted");else s.logger.error("key event is missing fields")}async onRoomKeyWithheldEvent(e){const t=e.getContent(),n=t.sender_key;if("m.no_olm"===t.code){const r=e.getSender();if(s.logger.warn(`${r}:${n} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(n))return s.logger.debug("New session already created.  Not creating a new one."),await this.olmDevice.recordSessionProblem(n,"no_olm",!0),void this.retryDecryptionFromSender(n);let i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n);if(!i&&(await this.crypto.downloadKeys([r],!1),i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n),!i))return s.logger.info("Couldn't find device for identity key "+n+": not establishing session"),await this.olmDevice.recordSessionProblem(n,"no_olm",!1),void this.retryDecryptionFromSender(n);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[r]:[i]},!1);const a={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(a.ciphertext,this.userId,void 0,this.olmDevice,r,i,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(n,"no_olm",!0),this.retryDecryptionFromSender(n),await this.baseApis.sendToDevice("m.room.encrypted",{[r]:{[i.deviceId]:a}})}else await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,n,t.session_id,t.code,t.reason)}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,n=e.deviceId,r=this.crypto.getStoredDevice(t,n),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[t]:[r]}).then((e=>e[t][n].sessionId?(s.logger.log("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+t+":"+n),this.buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null)).then((e=>{const i={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,t,r,e).then((()=>{const e={[t]:{[n]:i}};return this.baseApis.sendToDevice("m.room.encrypted",e)}))}))}async buildKeyForwardingMessage(e,t,n){const r=await this.olmDevice.getInboundGroupSessionKey(e,t,n);return{type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:r.sender_claimed_ed25519_key,session_id:n,session_key:r.key,chain_index:r.chain_index,forwarding_curve25519_key_chain:r.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":r.shared_history||!1}}}importRoomKey(e,t={}){const n={};return(t.untrusted||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then((()=>{"backup"!==t.source&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch((e=>{s.logger.log("Failed to back up megolm session",e)})),this.retryDecryption(e.sender_key,e.session_id,!n.untrusted)}))}async retryDecryption(e,t,n){var r;const i=this.pendingEvents.get(e);if(!i)return!0;const o=i.get(t);return!(o&&(s.logger.debug("Retrying decryption on events",[...o]),await Promise.all([...o].map((async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:n})}catch(e){}}))),null!==(r=this.pendingEvents.get(e))&&void 0!==r&&r.has(t)))}async retryDecryptionFromSender(e){const t=this.pendingEvents.get(e);return!t||(this.pendingEvents.delete(e),await Promise.all([...t].map((async([e,t])=>{await Promise.all([...t].map((async e=>{try{await e.attemptDecryption(this.crypto)}catch(e){}})))}))),!this.pendingEvents.has(e))}async sendSharedHistoryInboundSessions(e){await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e),s.logger.log("sendSharedHistoryInboundSessions to users",Object.keys(e));const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);s.logger.log("shared-history sessions",t);for(const[n,r]of t){const t=await this.buildKeyForwardingMessage(this.roomId,n,r),i=[],a={};for(const[n,r]of Object.entries(e)){a[n]={};for(const e of r){const r={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};a[n][e.deviceId]=r,i.push(o.encryptMessageForDevice(r.ciphertext,this.userId,void 0,this.olmDevice,n,e,t))}}await Promise.all(i);for(const e of Object.keys(a)){for(const t of Object.keys(a[e]))0===Object.keys(a[e][t].ciphertext).length&&(s.logger.log("No ciphertext for device "+e+":"+t+": pruning"),delete a[e][t]);0===Object.keys(a[e]).length&&(s.logger.log("Pruned all devices for user "+e),delete a[e])}if(0===Object.keys(a).length)return void s.logger.log("No users left to send to: aborting");await this.baseApis.sendToDevice("m.room.encrypted",a)}}}const f={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};(0,a.registerAlgorithm)(o.MEGOLM_ALGORITHM,p,g)},3984:(e,t,n)=>{"use strict";var r=n(4994)(n(3693)),i=n(9849),s=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=c(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(1978)),o=n(4981),a=n(2589);function c(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(c=function(e){return e?n:t})(e)}const l=o.DeviceInfo.DeviceVerification;class u extends a.EncryptionAlgorithm{constructor(...e){super(...e),(0,r.default)(this,"sessionPrepared",!1),(0,r.default)(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then((()=>this.crypto.ensureOlmSessionsForUsers(e))).then((()=>{this.sessionPrepared=!0})).finally((()=>{this.prepPromise=null})),this.prepPromise)}async encryptMessage(e,t,n){const r=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));await this.ensureSession(r);const i={room_id:e.roomId,type:t,content:n},o={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},a=[];for(let e=0;e<r.length;++e){const t=r[e],n=this.crypto.getStoredDevicesForUser(t)||[];for(let e=0;e<n.length;++e){const r=n[e];r.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&r.verified!=l.BLOCKED&&a.push(s.encryptMessageForDevice(o.ciphertext,this.userId,this.deviceId,this.olmDevice,t,r,i))}}return Promise.all(a).then((()=>o))}}class d extends a.DecryptionAlgorithm{async decryptEvent(e){const t=e.getWireContent(),n=t.sender_key,r=t.ciphertext;if(!r)throw new a.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in r))throw new a.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const i=r[this.olmDevice.deviceCurve25519Key];let o;try{o=await this.decryptMessage(n,i)}catch(e){throw new a.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:e})}const c=JSON.parse(o);if(c.recipient!=this.userId)throw new a.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+c.recipient);if(c.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new a.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:c.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});await this.crypto.deviceList.downloadKeys([e.getSender()],!1);const l=this.crypto.deviceList.getUserByIdentityKey(s.OLM_ALGORITHM,n);if(l!==e.getSender()&&void 0!==l)throw new a.DecryptionError("OLM_BAD_SENDER","Message claimed to be from "+e.getSender(),{real_sender:l});if(c.sender!=e.getSender())throw new a.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+c.sender,{reported_sender:e.getSender()});if(c.room_id!==e.getRoomId())throw new a.DecryptionError("OLM_BAD_ROOM","Message intended for room "+c.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});return{clearEvent:c,senderCurve25519Key:n,claimedEd25519Key:(c.keys||{}).ed25519||null}}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{const n=this.olmDevice.olmPrekeyPromise.then((()=>this.reallyDecryptMessage(e,t)));return this.olmDevice.olmPrekeyPromise=n.catch((()=>{})),n}}async reallyDecryptMessage(e,t){const n=await this.olmDevice.getSessionIdsForDevice(e),r={};for(let s=0;s<n.length;s++){const o=n[s];try{const n=await this.olmDevice.decryptMessage(e,o,t.type,t.body);return i.logger.log("Decrypted Olm message from "+e+" with session "+o),n}catch(n){if(await this.olmDevice.matchesSession(e,o,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+o+": "+n.message);r[o]=n.message}}if(0!==t.type){if(0===n.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(r))}let s;try{s=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw r["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(r))}return i.logger.log("created new inbound Olm session ID "+s.session_id+" with "+e),s.payload}}(0,a.registerAlgorithm)(s.OLM_ALGORITHM,u,d)},319:(e,t)=>{"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.CrossSigningKey=void 0,t.CrossSigningKey=n,function(e){e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing"}(n||(t.CrossSigningKey=n={}))},5849:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.algorithmsByName=t.DefaultAlgorithm=t.Curve25519=t.BackupManager=t.Aes256=void 0;var i=r(n(3693)),s=n(642),o=n(9849),a=n(1978),c=n(6891),l=n(4148),u=n(3514),d=n(5905),h=n(5936),p=n(7259),g=n(8091);class f{constructor(e,t){this.baseApis=e,this.getKey=t,(0,i.default)(this,"algorithm",void 0),(0,i.default)(this,"backupInfo",void 0),(0,i.default)(this,"checkedForBackup",void 0),(0,i.default)(this,"sendingBackups",void 0),(0,i.default)(this,"sessionLastCheckAttemptedTime",{}),this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=_[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!=typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){const n=_[e.algorithm];if(!n)throw new Error("Unknown backup algorithm");return n.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await f.makeAlgorithm(e,this.getKey),this.baseApis.emit(g.CryptoEvent.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(g.CryptoEvent.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const n=t?_[t]:b;if(!n)throw new Error("Unknown backup algorithm");const[r,i]=await n.prepare(e),s=(0,d.encodeRecoveryKey)(r);return{algorithm:n.algorithmName,auth_data:i,recovery_key:s,privateKey:r}}async createKeyBackupVersion(e){this.algorithm=await f.makeAlgorithm(e,this.getKey)}async checkAndStart(){if(o.logger.log("Checking key backup status..."),this.baseApis.isGuest())return o.logger.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{e=await this.baseApis.getKeyBackupVersion()}catch(e){return o.logger.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(o.logger.log("Found usable key backup v"+e.version+": enabling key backups"),await this.enableKeyBackup(e)):!t.usable&&this.backupInfo?(o.logger.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(o.logger.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):o.logger.log("Backup version "+e.version+" still current")):o.logger.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(e,t){if(!this.backupInfo)return;const n=(new Date).getTime();(!this.sessionLastCheckAttemptedTime[t]||n-this.sessionLastCheckAttemptedTime[t]>5e3)&&(this.sessionLastCheckAttemptedTime[t]=n,await this.baseApis.restoreKeyBackupWithCache(e,t,this.backupInfo,{}))}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.signatures))return o.logger.info("Key backup is absent or missing required data"),t;const n=await this.baseApis.crypto.getSessionBackupPrivateKey();if(n){let r;try{r=await f.makeAlgorithm(e,(async()=>n)),await r.keyMatches(n)&&(o.logger.info("Backup is trusted locally"),t.trusted_locally=!0)}catch{}finally{r&&r.free()}}const r=e.auth_data.signatures[this.baseApis.getUserId()]||{};for(const n of Object.keys(r)){const r=n.split(":");if("ed25519"!==r[0]){o.logger.log("Ignoring unknown signature type: "+r[0]);continue}const i={deviceId:r[1]},s=this.baseApis.crypto.crossSigningInfo.getId();if(s===i.deviceId){i.crossSigningId=!0;try{await(0,a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),i.deviceId,s),i.valid=!0}catch(e){o.logger.warn("Bad signature from cross signing key "+s,e),i.valid=!1}t.sigs.push(i);continue}const c=this.baseApis.crypto.deviceList.getStoredDevice(this.baseApis.getUserId(),i.deviceId);if(c){i.device=c,i.deviceTrust=this.baseApis.checkDeviceTrust(this.baseApis.getUserId(),i.deviceId);try{await(0,a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),c.deviceId,c.getFingerprint()),i.valid=!0}catch(t){o.logger.info("Bad signature from key ID "+n+" userID "+this.baseApis.getUserId()+" device ID "+c.deviceId+" fingerprint: "+c.getFingerprint(),e.auth_data,t),i.valid=!1}}else i.valid=null,o.logger.info("Ignoring signature from unknown key "+n);t.sigs.push(i)}return t.usable=t.sigs.some((e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId))),t}async scheduleKeyBackupSend(e=1e4){if(!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;await(0,l.sleep)(t);let n=0;for(;;){if(!this.algorithm)return;try{if(0===await this.backupPendingKeys(200))return;n=0}catch(e){if(n++,o.logger.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.baseApis.crypto.emit(g.CryptoEvent.KeyBackupFailed,e.data.errcode),e}n&&await(0,l.sleep)(1e3*Math.pow(2,Math.min(n-1,4)))}}finally{this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(g.CryptoEvent.KeyBackupSessionsRemaining,n);const r={};for(const e of t){const t=e.sessionData.room_id;void 0===r[t]&&(r[t]={sessions:{}});const n=this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);n.algorithm=a.MEGOLM_ALGORITHM;const i=(n.forwarding_curve25519_key_chain||[]).length,s=this.baseApis.crypto.deviceList.getUserByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey),o=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey),c=this.baseApis.crypto.checkDeviceInfoTrust(s,o).isVerified();r[t].sessions[e.sessionId]={first_message_index:n.first_known_index,forwarded_count:i,is_verified:c,session_data:await this.algorithm.encryptSession(n)}}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:r}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(g.CryptoEvent.KeyBackupSessionsRemaining,n),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,u.IndexedDBCryptoStore.STORE_BACKUP],(e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,(t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)}))}));const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(g.CryptoEvent.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}t.BackupManager=f;class m{constructor(e,t,n){this.authData=e,this.publicKey=t,this.getKey=n}static async init(e,t){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");const r=new n.g.Olm.PkEncryption;return r.set_recipient_key(e.public_key),new m(e,r,t)}static async prepare(e){const t=new n.g.Olm.PkDecryption;try{const r={};if(e)if(e instanceof Uint8Array)r.public_key=t.init_with_private_key(e);else{const n=await(0,c.keyFromPassphrase)(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,r.public_key=t.init_with_private_key(n.key)}else r.public_key=t.generate_key();return(new n.g.Olm.PkEncryption).set_recipient_key(r.public_key),[t.get_private_key(),r]}finally{t.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(e){const t=await this.getKey(),r=new n.g.Olm.PkDecryption;try{if(r.init_with_private_key(t)!==this.authData.public_key)throw{errcode:s.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY};const n=[];for(const[t,i]of Object.entries(e))try{const e=JSON.parse(r.decrypt(i.session_data.ephemeral,i.session_data.mac,i.session_data.ciphertext));e.session_id=t,n.push(e)}catch(e){o.logger.log("Failed to decrypt megolm session from backup",e,i)}return n}finally{r.free()}}async keyMatches(e){const t=new n.g.Olm.PkDecryption;let r;try{r=t.init_with_private_key(e)}finally{t.free()}return r===this.authData.public_key}free(){this.publicKey.free()}}t.Curve25519=m,(0,i.default)(m,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const v=new p.UnstableValue(null,"org.matrix.msc3270.v1.aes-hmac-sha2");class y{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const n=await t();if(e.mac){const{mac:t}=await(0,h.calculateKeyCheck)(n,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw new Error("Key does not match")}return new y(e,n)}static async prepare(e){let t;const n={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{const r=await(0,c.keyFromPassphrase)(e);n.private_key_salt=r.salt,n.private_key_iterations=r.iterations,t=r.key}else t=function(){var e;const t=(0,l.getCrypto)();if(t)return t.randomBytes(32);if(null!==(e=window)&&void 0!==e&&e.crypto){const e=new Uint8Array(32);return window.crypto.getRandomValues(e),e}throw new Error("No usable crypto implementation")}();const{iv:r,mac:i}=await(0,h.calculateKeyCheck)(t);return n.iv=r,n.mac=i,[t,n]}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,(0,h.encryptAES)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[n,r]of Object.entries(e))try{const e=JSON.parse(await(0,h.decryptAES)(r.session_data,this.key,n));e.session_id=n,t.push(e)}catch(e){o.logger.log("Failed to decrypt megolm session from backup",e,r)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await(0,h.calculateKeyCheck)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}return!0}free(){this.key.fill(0)}}t.Aes256=y,(0,i.default)(y,"algorithmName",v.name);const _={[m.algorithmName]:m,[y.algorithmName]:y};t.algorithmsByName=_;const b=m;t.DefaultAlgorithm=b},5392:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.DehydrationManager=t.DEHYDRATION_ALGORITHM=void 0;var i=r(n(3693)),s=r(n(4069)),o=n(1978),a=n(3514),c=n(5936),l=n(9849),u=n(84);const d="org.matrix.msc2697.v1.olm.libolm_pickle";t.DEHYDRATION_ALGORITHM=d;const h=6048e5;t.DehydrationManager=class{constructor(e){this.crypto=e,(0,i.default)(this,"inProgress",!1),(0,i.default)(this,"timeoutId",void 0),(0,i.default)(this,"key",void 0),(0,i.default)(this,"keyInfo",void 0),(0,i.default)(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.getSecretStorePrivateKey(e,(async e=>{if(e){const{key:t,keyInfo:r,deviceDisplayName:i,time:s}=e,a=Buffer.from(this.crypto.olmDevice.pickleKey),l=await(0,c.decryptAES)(t,a,d);this.key=(0,o.decodeBase64)(l),this.keyInfo=r,this.deviceDisplayName=i;const u=Date.now(),p=Math.max(1,s+h-u);this.timeoutId=n.g.setTimeout(this.dehydrateDevice.bind(this),p)}}),"dehydration")}))}async setKeyAndQueueDehydration(e,t={},n=void 0){await this.setKey(e,t,n)||this.dehydrateDevice()}async setKey(e,t={},r=void 0){if(!e)return this.timeoutId&&(n.g.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),this.key=void 0,void(this.keyInfo=void 0);let i=this.key&&e.length==this.key.length;for(let t=0;i&&t<e.length;t++)e[t]!=this.key[t]&&(i=!1);return i||(this.key=e,this.keyInfo=t,this.deviceDisplayName=r),i}async dehydrateDevice(){if(this.inProgress)l.logger.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(n.g.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const e=Buffer.from(this.crypto.olmDevice.pickleKey),t=await(0,c.encryptAES)((0,o.encodeBase64)(this.key),e,d);await this.crypto.cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:t,deviceDisplayName:this.deviceDisplayName,time:Date.now()})})),l.logger.log("Attempting to dehydrate device"),l.logger.log("Creating account");const r=new n.g.Olm.Account;r.create();const i=JSON.parse(r.identity_keys()),p=r.max_number_of_one_time_keys();r.generate_one_time_keys(p/2),r.generate_fallback_key();const g=JSON.parse(r.one_time_keys()),f=JSON.parse(r.fallback_key());r.mark_keys_as_published();const m=r.pickle(new Uint8Array(this.key)),v={algorithm:d,account:m};this.keyInfo.passphrase&&(v.passphrase=this.keyInfo.passphrase),l.logger.log("Uploading account to server");const y=(await this.crypto.baseApis.http.authedRequest(void 0,u.Method.Put,"/dehydrated_device",void 0,{device_data:v,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;l.logger.log("Preparing device keys",y);const _={algorithms:this.crypto.supportedAlgorithms,device_id:y,user_id:this.crypto.userId,keys:{[`ed25519:${y}`]:i.ed25519,[`curve25519:${y}`]:i.curve25519}},b=r.sign(s.default.stringify(_));_.signatures={[this.crypto.userId]:{[`ed25519:${y}`]:b}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(_,"self_signing"),l.logger.log("Preparing one-time keys");const E={};for(const[e,t]of Object.entries(g.curve25519)){const n={key:t},i=r.sign(s.default.stringify(n));n.signatures={[this.crypto.userId]:{[`ed25519:${y}`]:i}},E[`signed_curve25519:${e}`]=n}l.logger.log("Preparing fallback keys");const A={};for(const[e,t]of Object.entries(f.curve25519)){const n={key:t,fallback:!0},i=r.sign(s.default.stringify(n));n.signatures={[this.crypto.userId]:{[`ed25519:${y}`]:i}},A[`signed_curve25519:${e}`]=n}return l.logger.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(void 0,u.Method.Post,"/keys/upload/"+encodeURI(y),void 0,{device_keys:_,one_time_keys:E,"org.matrix.msc2732.fallback_keys":A}),l.logger.log("Done dehydrating"),this.timeoutId=n.g.setTimeout(this.dehydrateDevice.bind(this),h),y}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(n.g.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}},4981:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=void 0;var i,s=r(n(3693));!function(e){e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified"}(i||(i={}));class o{static fromStorage(e,t){const n=new o(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}constructor(e){this.deviceId=e,(0,s.default)(this,"algorithms",void 0),(0,s.default)(this,"keys",{}),(0,s.default)(this,"verified",i.Unverified),(0,s.default)(this,"known",!1),(0,s.default)(this,"unsigned",{}),(0,s.default)(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==i.Blocked}isVerified(){return this.verified==i.Verified}isUnverified(){return this.verified==i.Unverified}isKnown(){return!0===this.known}}t.DeviceInfo=o,(0,s.default)(o,"DeviceVerification",{VERIFIED:i.Verified,UNVERIFIED:i.Unverified,BLOCKED:i.Blocked})},8091:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.IncomingRoomKeyRequest=t.CryptoEvent=t.Crypto=void 0,t.fixBackupKey=V,t.isCryptoAvailable=function(){return Boolean(n.g.Olm)},t.verificationMethods=void 0;var i=r(n(3693)),s=r(n(4069)),o=n(4703),a=n(2300),c=n(9849),l=n(8315),u=B(n(1978)),d=n(5577),h=n(4981),p=B(n(4422)),g=n(2180),f=n(8045),m=n(4430),v=n(4875),y=n(3514),_=n(8825),b=n(518),E=n(6891),A=n(5905),S=n(5673),w=n(7466),I=n(2999),T=n(2336),k=n(2382),R=n(5936),O=n(5392),C=n(5849),P=n(5489),D=n(9948),N=n(224),x=n(642),M=n(7022);function L(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(L=function(e){return e?n:t})(e)}function B(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=L(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}const F=h.DeviceInfo.DeviceVerification,j={[_.ReciprocateQRCode.NAME]:_.ReciprocateQRCode,[b.SAS.NAME]:b.SAS,[_.SHOW_QR_CODE_METHOD]:T.IllegalMethod,[_.SCAN_QR_CODE_METHOD]:T.IllegalMethod},q={RECIPROCATE_QR_CODE:_.ReciprocateQRCode.NAME,SAS:b.SAS.NAME};let K;t.verificationMethods=q,t.CryptoEvent=K,function(e){e.DeviceVerificationChanged="deviceVerificationChanged",e.UserTrustStatusChanged="userTrustStatusChanged",e.UserCrossSigningUpdated="userCrossSigningUpdated",e.RoomKeyRequest="crypto.roomKeyRequest",e.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",e.KeyBackupStatus="crypto.keyBackupStatus",e.KeyBackupFailed="crypto.keyBackupFailed",e.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",e.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",e.VerificationRequest="crypto.verification.request",e.Warning="crypto.warning",e.WillUpdateDevices="crypto.willUpdateDevices",e.DevicesUpdated="crypto.devicesUpdated",e.KeysChanged="crossSigning.keysChanged"}(K||(t.CryptoEvent=K={}));class $ extends M.TypedEventEmitter{static getOlmVersion(){return l.OlmDevice.getOlmVersion()}constructor(e,t,n,r,s,o,h){if(super(),this.baseApis=e,this.userId=t,this.deviceId=n,this.clientStore=r,this.cryptoStore=s,this.roomList=o,(0,i.default)(this,"backupManager",void 0),(0,i.default)(this,"crossSigningInfo",void 0),(0,i.default)(this,"olmDevice",void 0),(0,i.default)(this,"deviceList",void 0),(0,i.default)(this,"dehydrationManager",void 0),(0,i.default)(this,"secretStorage",void 0),(0,i.default)(this,"reEmitter",void 0),(0,i.default)(this,"verificationMethods",void 0),(0,i.default)(this,"supportedAlgorithms",void 0),(0,i.default)(this,"outgoingRoomKeyRequestManager",void 0),(0,i.default)(this,"toDeviceVerificationRequests",void 0),(0,i.default)(this,"inRoomVerificationRequests",void 0),(0,i.default)(this,"trustCrossSignedDevices",!0),(0,i.default)(this,"lastOneTimeKeyCheck",null),(0,i.default)(this,"oneTimeKeyCheckInProgress",!1),(0,i.default)(this,"roomEncryptors",new Map),(0,i.default)(this,"roomDecryptors",new Map),(0,i.default)(this,"deviceKeys",{}),(0,i.default)(this,"globalBlacklistUnverifiedDevices",!1),(0,i.default)(this,"globalErrorOnUnknownDevices",!0),(0,i.default)(this,"receivedRoomKeyRequests",[]),(0,i.default)(this,"receivedRoomKeyRequestCancellations",[]),(0,i.default)(this,"processingRoomKeyRequests",!1),(0,i.default)(this,"lazyLoadMembers",!1),(0,i.default)(this,"roomDeviceTrackingState",{}),(0,i.default)(this,"lastNewSessionForced",{}),(0,i.default)(this,"sendKeyRequestsImmediately",!1),(0,i.default)(this,"oneTimeKeyCount",void 0),(0,i.default)(this,"needsNewFallback",void 0),(0,i.default)(this,"fallbackCleanup",void 0),(0,i.default)(this,"onDeviceListUserCrossSigningUpdated",(async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),n=t?t.getId():null,r=this.crossSigningInfo.getId();r&&n&&r===n?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit(K.KeysChanged,{}),this.emit(K.UserTrustStatusChanged,this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit(K.UserTrustStatusChanged,e,this.checkUserTrust(e))}})),(0,i.default)(this,"onMembership",((e,t,n)=>{try{this.onRoomMembership(e,t,n)}catch(e){c.logger.error("Error handling membership change:",e)}})),(0,i.default)(this,"onToDeviceEvent",(e=>{try{c.logger.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"m.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once(N.MatrixEventEvent.Decrypted,(e=>{this.onToDeviceEvent(e)})))}catch(e){c.logger.error("Error handling toDeviceEvent:",e)}})),(0,i.default)(this,"onTimelineEvent",((e,t,n,r,{liveEvent:i=!0}={})=>{w.InRoomChannel.validateEvent(e,this.baseApis)&&this.handleVerificationEvent(e,this.inRoomVerificationRequests,(e=>{const t=new w.InRoomChannel(this.baseApis,e.getRoomId());return new S.VerificationRequest(t,this.verificationMethods,this.baseApis)}),i)})),this.reEmitter=new a.TypedReEmitter(this),h){this.verificationMethods=new Map;for(const e of h)"string"==typeof e?j[e]&&this.verificationMethods.set(e,j[e]):e.NAME?this.verificationMethods.set(e.NAME,e):c.logger.warn(`Excluding unknown verification method ${e}`)}else this.verificationMethods=new Map(Object.entries(j));this.backupManager=new C.BackupManager(e,(async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.getSecret("m.megolm_backup.v1");if(t){const e=V(t);if(e){const[t]=await this.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",e,[t])}return u.decodeBase64(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new l.OlmDevice(s),this.deviceList=new d.DeviceList(e,s,this.olmDevice),this.deviceList.on(K.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[K.DevicesUpdated,K.WillUpdateDevices]),this.supportedAlgorithms=Array.from(p.DECRYPTION_CLASSES.keys()),this.outgoingRoomKeyRequestManager=new v.OutgoingRoomKeyRequestManager(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new I.ToDeviceRequests,this.inRoomVerificationRequests=new w.InRoomRequests;const f=this.baseApis.cryptoCallbacks||{},y=(0,g.createCryptoStoreCacheCallbacks)(s,this.olmDevice);this.crossSigningInfo=new g.CrossSigningInfo(t,f,y),this.secretStorage=new m.SecretStorage(e,f,e),this.dehydrationManager=new O.DehydrationManager(this),!f.getCrossSigningKey&&f.getSecretStorageKey&&(f.getCrossSigningKey=async e=>g.CrossSigningInfo.getFromSecretStorage(e,this.secretStorage))}async init({exportedOlmDevice:e,pickleKey:t}={}){c.logger.log("Crypto: initialising Olm..."),await n.g.Olm.init(),c.logger.log(e?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:e,pickleKey:t}),c.logger.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,c.logger.log("Crypto: fetching own devices...");let r=this.deviceList.getRawStoredDevicesForUser(this.userId);if(r||(r={}),!r[this.deviceId]){c.logger.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:F.VERIFIED,known:!0};r[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,r),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[y.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.cryptoStore.getCrossSigningKeys(e,(e=>{e&&0!==Object.keys(e).length&&(c.logger.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))}))})),this.deviceList.startTrackingDeviceList(this.userId),c.logger.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const e of this.deviceList.getKnownUserIds()){const t=this.deviceList.getRawStoredDevicesForUser(e);for(const n of Object.keys(t)){const t=this.checkDeviceTrust(e,n);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this.deviceList.getStoredDevice(e,n);this.emit(K.DeviceVerificationChanged,e,n,t)}}}}async createRecoveryKeyFromPassphrase(e){const t=new n.g.Olm.PkDecryption;try{const n={};if(e){const r=await(0,E.keyFromPassphrase)(e);n.passphrase={algorithm:"m.pbkdf2",iterations:r.iterations,salt:r.salt},n.pubkey=t.init_with_private_key(r.key)}else n.pubkey=t.generate_key();const r=t.get_private_key();return{keyInfo:n,encodedPrivateKey:(0,A.encodeRecoveryKey)(r),privateKey:r}}finally{t&&t.free()}}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),n=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&n)}async bootstrapCrossSigning({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){c.logger.log("Bootstrapping cross-signing");const n=this.baseApis.cryptoCallbacks,r=new f.EncryptionSetupBuilder(this.baseApis.store.accountData,n),i=new g.CrossSigningInfo(this.userId,r.crossSigningCallbacks,r.crossSigningCallbacks),s=this.crossSigningInfo.getId(),o=await this.crossSigningInfo.isStoredInKeyCache(),a=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),l=o||a;c.logger.log({setupNewCrossSigning:t,publicKeysOnDevice:s,privateKeysInCache:o,privateKeysInStorage:a,privateKeysExistSomewhere:l}),!l||t?(c.logger.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await(async()=>{i.resetKeys(),await this.signObject(i.keys.master),r.addCrossSigningKeys(e,i.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await i.signDevice(this.userId,t);r.addKeySignature(this.userId,this.deviceId,n),this.backupManager.backupInfo&&(await i.signObject(this.backupManager.backupInfo.auth_data,"master"),r.addSessionBackup(this.backupManager.backupInfo))})()):s&&o?c.logger.log("Cross-signing public keys trusted and private keys found locally"):a&&(c.logger.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const u=r.crossSigningCallbacks.privateKeys;if(u.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new m.SecretStorage(r.accountDataClientAdapter,r.ssssCryptoCallbacks);await e.hasKey()&&(c.logger.log("Storing new cross-signing private keys in secret storage"),await g.CrossSigningInfo.storeInSecretStorage(u,e))}const d=r.buildOperation();await d.apply(this),await r.persist(this),c.logger.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:e=async()=>({}),keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:r,getKeyBackupPassphrase:i}={}){c.logger.log("Bootstrapping Secure Secret Storage");const s=this.baseApis.cryptoCallbacks,o=new f.EncryptionSetupBuilder(this.baseApis.store.accountData,s),a=new m.SecretStorage(o.accountDataClientAdapter,o.ssssCryptoCallbacks);let l=null;const d=async(e,t)=>{t&&(e.key=t);const{keyId:n,keyInfo:r}=await a.addKey(m.SECRET_STORAGE_ALGORITHM_V1_AES,e);return t&&o.ssssCryptoCallbacks.addPrivateKey(n,r,t),await a.setDefaultKeyId(n),n},h=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{c.logger.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(e){c.logger.error("Signing key backup with cross-signing keys failed",e)}else c.logger.warn("Cross-signing keys not available, skipping signature on key backup")},p=await this.getSecretStorageKey(),[v,y]=p||[null,null],_=!r&&y&&y.algorithm===m.SECRET_STORAGE_ALGORITHM_V1_AES;if(c.logger.log({keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:r,storageExists:_,oldKeyInfo:y}),_||t)if(!_&&t){c.logger.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await i(),n={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(n.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),l=await d(n,e),await a.store("m.megolm_backup.v1",u.encodeBase64(e),[l]),await h(t.auth_data),o.addSessionBackup(t)}else c.logger.log("Secret storage exists"),y&&y.algorithm===m.SECRET_STORAGE_ALGORITHM_V1_AES&&await(async(e,t)=>{if(!t.mac){const n=await this.baseApis.cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(n){const r=n[1];o.ssssCryptoCallbacks.addPrivateKey(e,t,r);const{iv:i,mac:s}=await(0,R.calculateKeyCheck)(r);t.iv=i,t.mac=s,await o.setAccountData(`m.secret_storage.key.${e}`,t)}}})(v,y);else{c.logger.log("Secret storage does not exist, creating new storage key");const{keyInfo:t={},privateKey:n}=await e();l=await d(t,n)}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(l||!await this.crossSigningInfo.isStoredInSecretStorage(a))){c.logger.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await g.CrossSigningInfo.storeInSecretStorage(e,a)}if(n&&!t){c.logger.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=(0,A.decodeRecoveryKey)(e.recovery_key);await a.store("m.megolm_backup.v1",u.encodeBase64(t));const n={algorithm:e.algorithm,auth_data:e.auth_data};await h(n.auth_data),await this.signObject(n.auth_data),o.addSessionBackup(n)}const b=await a.get("m.megolm_backup.v1");if(b){c.logger.info("Got session backup key from secret storage: caching");const e=V(b);e&&await a.store("m.megolm_backup.v1",e,[l||v]);const t=new Uint8Array(u.decodeBase64(e||b));o.addSessionBackupPrivateKeyToCache(t)}else if(this.backupManager.getKeyBackupEnabled()){const e=await this.getSessionBackupPrivateKey()||await i();if(!e)return void c.logger.error("Key backup is enabled but couldn't get key backup key!");c.logger.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await a.store("m.megolm_backup.v1",u.encodeBase64(e))}const E=o.buildOperation();await E.apply(this),await o.persist(this),c.logger.log("Secure Secret Storage ready")}addSecretStorageKey(e,t,n){return this.secretStorage.addKey(e,t,n)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,n){return this.secretStorage.store(e,t,n)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){let r=null;try{return r=new n.g.Olm.PkDecryption,r.init_with_private_key(e)===t}finally{r&&r.free()}}async getSessionBackupPrivateKey(){let e=await new Promise((e=>{this.cryptoStore.doTxn("readonly",[y.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")}))}));if(e&&"string"==typeof e&&(e=new Uint8Array(u.decodeBase64(V(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=Buffer.from(this.olmDevice.pickleKey),n=await(0,R.decryptAES)(e,t,"m.megolm_backup.v1");e=u.decodeBase64(n)}return e}async storeSessionBackupPrivateKey(e){if(!(e instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${e}`);const t=Buffer.from(this.olmDevice.pickleKey),n=await(0,R.encryptAES)(u.encodeBase64(e),t,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[y.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",n)}))}checkCrossSigningPrivateKey(e,t){let r=null;try{return r=new n.g.Olm.PkSigning,r.init_with_seed(e)===t}finally{r&&r.free()}}async afterCrossSigningLocalKeyChange(){c.logger.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);c.logger.info(`Starting background key sig upload for ${this.deviceId}`);const n=({shouldEmit:e=!1})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then((t=>{const{failures:r}=t||{};if(Object.keys(r||[]).length>0)throw e&&this.baseApis.emit(K.KeySignatureUploadFailure,r,"afterCrossSigningLocalKeyChange",n),new k.KeySignatureUploadError("Key upload failed",{failures:r});c.logger.info(`Finished background key sig upload for ${this.deviceId}`)})).catch((e=>{c.logger.error(`Error during background key sig upload for ${this.deviceId}`,e)}));n({shouldEmit:!0});const r=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(r){c.logger.info("Starting device verification upgrade");const e={};for(const[t,n]of Object.entries(this.deviceList.crossSigningInfo)){const r=await this.checkForDeviceVerificationUpgrade(t,g.CrossSigningInfo.fromStorage(n,t));r&&(e[t]=r)}if(Object.keys(e).length>0){c.logger.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await r({users:e});if(t)for(const n of t)n in e&&await this.baseApis.setDeviceVerified(n,e[n].crossSigningInfo.getId())}catch(e){c.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}c.logger.info("Finished device verification upgrade")}c.logger.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const n=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.isVerified()){const n=this.deviceList.getRawStoredDevicesForUser(e),r=await this.checkForValidDeviceSignature(e,t.keys.master,n);if(r.length)return{devices:r.map((e=>h.DeviceInfo.fromStorage(n[e],e))),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,n){const r=[];if(n&&t.signatures&&t.signatures[e])for(const i of Object.keys(t.signatures[e])){const[,s]=i.split(":",2);if(s in n&&n[s].verified===F.VERIFIED)try{await u.verifySignature(this.olmDevice,t,e,s,n[s].keys[i]),r.push(s)}catch(e){}}return r}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new g.UserTrustLevel(!1,!1,!1)}checkDeviceTrust(e,t){const n=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,n)}checkDeviceInfoTrust(e,t){const n=!(!t||!t.isVerified()),r=this.deviceList.getStoredCrossSigningForUser(e);if(t&&r){const i=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(r,t,n,i)}return new g.DeviceTrustLevel(!1,!1,n,!1)}checkIfOwnDeviceCrossSigned(e){const t=this.deviceList.getStoredDevice(this.userId,e),n=this.deviceList.getStoredCrossSigningForUser(this.userId);return n.checkDeviceTrust(n,t,!1,!0).isCrossSigningVerified()}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:e=!1}={}){const t=this.userId;await this.downloadKeys([this.userId]);const n=await this.crossSigningInfo.getCrossSigningKeysFromCache(),r=this.deviceList.getStoredCrossSigningForUser(t);if(!r)return void c.logger.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const i=r.getId(),s=this.crossSigningInfo.getId()!==i,o=r.getId()&&!n.has("master");if(s&&c.logger.info("Got new master public key",i),e&&(s||o)){c.logger.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("master",i))[1],c.logger.info("Got cross-signing master private key")}finally{e&&e.free()}}const a=this.crossSigningInfo.getId("self_signing"),l=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(r.keys);const u=a!==r.getId("self_signing"),d=l!==r.getId("user_signing"),h=r.getId("self_signing")&&!n.has("self_signing"),p=r.getId("user_signing")&&!n.has("user_signing"),g={};if(u&&c.logger.info("Got new self-signing key",r.getId("self_signing")),e&&(u||h)){c.logger.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("self_signing",r.getId("self_signing")))[1],c.logger.info("Got cross-signing self-signing private key")}finally{e&&e.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await this.crossSigningInfo.signDevice(this.userId,t);g[this.deviceId]=n}if(d&&c.logger.info("Got new user-signing key",r.getId("user_signing")),e&&(d||p)){c.logger.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("user_signing",r.getId("user_signing")))[1],c.logger.info("Got cross-signing user-signing private key")}finally{e&&e.free()}}if(s){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];g[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const f=Object.keys(g);if(f.length){const e=({shouldEmit:t=!1})=>(c.logger.info(`Starting background key sig upload for ${f}`),this.baseApis.uploadKeySignatures({[this.userId]:g}).then((n=>{const{failures:r}=n||{};if(c.logger.info(`Finished background key sig upload for ${f}`),Object.keys(r||[]).length>0)throw t&&this.baseApis.emit(K.KeySignatureUploadFailure,r,"checkOwnCrossSigningTrust",e),new k.KeySignatureUploadError("Key upload failed",{failures:r})})).catch((e=>{c.logger.error(`Error during background key sig upload for ${f}`,e)})));e({shouldEmit:!0})}this.emit(K.UserTrustStatusChanged,t,this.checkUserTrust(t)),s&&(this.emit(K.KeysChanged,{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[y.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)}))}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(c.logger.info(`Starting device verification upgrade for ${e}`),this.crossSigningInfo.keys.user_signing){const n=this.deviceList.getStoredCrossSigningForUser(e);if(n){const r=await this.checkForDeviceVerificationUpgrade(e,n);r&&(await t({users:{[e]:r}})).includes(e)&&await this.baseApis.setDeviceVerified(e,n.getId())}}c.logger.info(`Finished device verification upgrade for ${e}`)}}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(D.RoomMemberEvent.Membership,this.onMembership),e.on(x.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),e.on(P.RoomEvent.Timeline,this.onTimelineEvent),e.on(N.MatrixEventEvent.Decrypted,this.onTimelineEvent)}start(){this.outgoingRoomKeyRequestManager.start()}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){this.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){return this.globalErrorOnUnknownDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then((()=>this.baseApis.uploadKeysRequest({device_keys:e})))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}setNeedsNewFallback(e){this.needsNewFallback=!!e}getNeedsNewFallback(){return this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const e=Date.now();if(null!==this.lastOneTimeKeyCheck&&e-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=e;const t=this.olmDevice.maxNumberOfOneTimeKeys(),n=Math.floor(t/2),r=async e=>{for(;n>e||this.getNeedsNewFallback();){if(n>e){c.logger.info("generating oneTimeKeys");const t=Math.min(n-e,5);await this.olmDevice.generateOneTimeKeys(t)}if(this.getNeedsNewFallback()){const e=await this.olmDevice.getFallbackKey();e.curve25519&&0!=Object.keys(e.curve25519).length||(c.logger.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}c.logger.info("calling uploadOneTimeKeys");const t=await this.uploadOneTimeKeys();if(!t.one_time_key_counts||!t.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=t.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then((()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then((e=>e.one_time_key_counts.signed_curve25519||0)))).then((e=>r(e))).catch((e=>{c.logger.error("Error uploading one-time keys",e.stack||e)})).finally((()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1}))}async uploadOneTimeKeys(){const e=[];let t;if(this.getNeedsNewFallback()){t={};const n=await this.olmDevice.getFallbackKey();for(const[r,i]of Object.entries(n.curve25519)){const n={key:i,fallback:!0};t["signed_curve25519:"+r]=n,e.push(this.signObject(n))}this.setNeedsNewFallback(!1)}const n=await this.olmDevice.getOneTimeKeys(),r={};for(const t in n.curve25519)if(n.curve25519.hasOwnProperty(t)){const i={key:n.curve25519[t]};r["signed_curve25519:"+t]=i,e.push(this.signObject(i))}await Promise.all(e);const i={one_time_keys:r};t&&(i["org.matrix.msc2732.fallback_keys"]=t,i.fallback_keys=t);const s=await this.baseApis.uploadKeysRequest(i);return t&&(this.fallbackCleanup=setTimeout((()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()}),36e5)),await this.olmDevice.markKeysAsPublished(),s}downloadKeys(e,t){return this.deviceList.downloadKeys(e,t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerification(e,t,n,r,i,s){void 0===n&&(n=null),void 0===r&&(r=null),void 0===i&&(i=null);const o=this.deviceList.getStoredCrossSigningForUser(e);if(o&&o.getId()===t){if(null!==r||null!==i)throw new Error("Cannot set blocked or known for a cross-signing key");if(!n)throw new Error("Cannot set a cross-signing key as unverified");const a=s?Object.values(s)[0]:null;if(s&&(1!==Object.values(s).length||a!==o.getId()))throw new Error(`Key did not match expected value: expected ${o.getId()}, got ${a}`);if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(o.keys),this.emit(K.UserTrustStatusChanged,this.userId,this.checkUserTrust(e))),e!==this.userId){c.logger.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const n=await this.crossSigningInfo.signUser(o);if(n){const r=async({shouldEmit:i=!1})=>{c.logger.info("Uploading signature for "+e+"...");const s=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:o}=s||{};if(Object.keys(o||[]).length>0)throw i&&this.baseApis.emit(K.KeySignatureUploadFailure,o,"setDeviceVerification",r),new k.KeySignatureUploadError("Key upload failed",{failures:o})};await r({shouldEmit:!0})}return n}return o}const a=this.deviceList.getRawStoredDevicesForUser(e);if(!a||!a[t])throw new Error("Unknown device "+e+":"+t);const l=a[t];let u=l.verified;if(n){if(s)for(const[e,t]of Object.entries(s))if(l.keys[e]!==t)throw new Error(`Key did not match expected value: expected ${t}, got ${l.keys[e]}`);u=F.VERIFIED}else null!==n&&u==F.VERIFIED&&(u=F.UNVERIFIED);r?u=F.BLOCKED:null!==r&&u==F.BLOCKED&&(u=F.UNVERIFIED);let d=l.known;if(null!==i&&(d=i),l.verified===u&&l.known===d||(l.verified=u,l.known=d,this.deviceList.storeDevicesForUser(e,a),this.deviceList.saveIfDirty()),n&&e===this.userId){let n;if(c.logger.info("Own device "+t+" marked verified: signing"),this.checkDeviceTrust(e,t).isCrossSigningVerified()?c.logger.log(`Own device ${t} already cross-signing verified`):n=await this.crossSigningInfo.signDevice(e,h.DeviceInfo.fromStorage(l,t)),n){const r=async({shouldEmit:i=!1})=>{c.logger.info("Uploading signature for "+t);const s=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:o}=s||{};if(Object.keys(o||[]).length>0)throw i&&this.baseApis.emit(K.KeySignatureUploadFailure,o,"setDeviceVerification",r),new k.KeySignatureUploadError("Key upload failed",{failures:o})};await r({shouldEmit:!0})}}const p=h.DeviceInfo.fromStorage(l,t);return this.emit(K.DeviceVerificationChanged,e,t,p),p}findVerificationRequestDMInProgress(e){return this.inRoomVerificationRequests.findRequestInProgress(e)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const n=this.inRoomVerificationRequests.findRequestInProgress(t);if(n)return Promise.resolve(n);const r=new w.InRoomChannel(this.baseApis,t,e);return this.requestVerificationWithChannel(e,r,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const n=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(n)return Promise.resolve(n);const r=new I.ToDeviceChannel(this.baseApis,e,t,I.ToDeviceChannel.makeTransactionId());return this.requestVerificationWithChannel(e,r,this.toDeviceVerificationRequests)}async requestVerificationWithChannel(e,t,n){let r=new S.VerificationRequest(t,this.verificationMethods,this.baseApis);t.transactionId&&n.setRequestByChannel(t,r),await r.sendRequest();const i=n.getRequestByChannel(t);return i?r=i:(c.logger.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),n.setRequestByChannel(t,r)),r}beginKeyVerification(e,t,n,r=null){let i;if(r){if(i=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,r),!i)throw new Error(`No request found for user ${t} with transactionId ${r}`)}else{r=I.ToDeviceChannel.makeTransactionId();const e=new I.ToDeviceChannel(this.baseApis,t,[n],r,n);i=new S.VerificationRequest(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,r,i)}return i.beginKeyVerification(e,{userId:t,deviceId:n})}async legacyDeviceVerification(e,t,n){const r=I.ToDeviceChannel.makeTransactionId(),i=new I.ToDeviceChannel(this.baseApis,e,[t],r,t),s=new S.VerificationRequest(i,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,r,s);const o=s.beginKeyVerification(n,{userId:e,deviceId:t});return await Promise.race([o.verify(),s.waitFor((e=>e.started))]),s}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],n={};for(let e=0;e<t.length;++e){const r=t[e],i=r.getIdentityKey(),s=await this.olmDevice.getSessionInfoForDevice(i);n[r.deviceId]={deviceIdKey:i,sessions:s}}return n}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),n=e.getWireContent().algorithm;if(!t||!n)return null;if(e.isKeySourceUntrusted())return null;const r=this.deviceList.getDeviceByIdentityKey(n,t);if(null===r)return null;const i=e.getClaimedEd25519Key();return i?i!==r.getFingerprint()?(c.logger.warn("Event "+e.getId()+" claims ed25519 key "+i+" but sender device has key "+r.getFingerprint()),null):r:(c.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0,e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this.deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const n=e.getClaimedEd25519Key();return n||(c.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&n!==t.sender.getFingerprint()&&(c.logger.warn("Event "+e.getId()+" claims ed25519 key "+n+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t}forceDiscardSession(e){const t=this.roomEncryptors.get(e);if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()}async setRoomEncryption(e,t,n){if(!t.algorithm)return void c.logger.log("Ignoring setRoomEncryption with no algorithm");const r=this.roomList.getRoomEncryption(e);if(r&&JSON.stringify(r)!=JSON.stringify(t))return void c.logger.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this.roomEncryptors.get(e))return;let i=null;r||(i=this.roomList.setRoomEncryption(e,t));const s=p.ENCRYPTION_CLASSES.get(t.algorithm);if(!s)throw new Error("Unable to encrypt with "+t.algorithm);const o=new s({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e,config:t});this.roomEncryptors.set(e,o),i&&await i,this.lazyLoadMembers?c.logger.log("Enabling encryption in "+e):(c.logger.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),n||this.deviceList.refreshOutdatedDeviceLists())}trackRoomDevices(e){let t=this.roomDeviceTrackingState[e];return t||(t=(async()=>{if(!this.roomEncryptors.has(e))return;const t=this.clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);c.logger.log(`Starting to track devices for room ${e} ...`),(await t.getEncryptionTargetMembers()).forEach((e=>{this.deviceList.startTrackingDeviceList(e.userId)}))})(),this.roomDeviceTrackingState[e]=t.catch((t=>{throw this.roomDeviceTrackingState[e]=null,t}))),t}ensureOlmSessionsForUsers(e,t){const n={};for(let t=0;t<e.length;++t){const r=e[t];n[r]=[];const i=this.getStoredDevicesForUser(r)||[];for(let e=0;e<i.length;++e){const t=i[e];t.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&t.verified!=F.BLOCKED&&n[r].push(t)}}return u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,n,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[y.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],(t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,(t=>{if(null===t)return;const n=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete n.first_known_index,n.algorithm=u.MEGOLM_ALGORITHM,e.push(n)}))})),e}importRoomKeys(e,t={}){let n=0,r=0;const i=e.length;function s(){t.progressCallback({stage:"load_keys",successes:n,failures:r,total:i})}return Promise.all(e.map((e=>e.room_id&&e.algorithm?this.getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally((()=>{n++,t.progressCallback&&s()})):(c.logger.warn("ignoring room key entry with missing fields",e),r++,t.progressCallback&&s(),null)))).then()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const n=e.getRoomId(),r=this.roomEncryptors.get(n);if(!r)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this.roomDeviceTrackingState[n]||this.trackRoomDevices(n),await this.roomDeviceTrackingState[n];let i=e.getContent();const s=i["m.relates_to"];s&&(i=Object.assign({},i),delete i["m.relates_to"]);const o=i["io.element.performance_metrics"];o&&(i=Object.assign({},i),delete i["io.element.performance_metrics"]);const a=await r.encryptMessage(t,e.getType(),i);s&&(a["m.relates_to"]=s),o&&(a["io.element.performance_metrics"]=o),e.makeEncrypted("m.room.encrypted",a,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new N.MatrixEvent(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({room_id:e.getRoomId()},e.getUnsigned().redacted_because)),n=await this.decryptEvent(t);return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n.clearEvent}}}}{const t=e.getWireContent();return this.getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)}}async handleDeviceListChanges(e,t){e.oldSyncToken&&await this.evalDeviceListChanges(t)}requestRoomKey(e,t,n=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,n).then((()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((e=>{c.logger.error("Error requesting key for event",e)}))}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((e=>{c.logger.warn("Error clearing pending room key requests",e)}))}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e){const t=e.getRoomId(),n=e.getContent();try{await this.setRoomEncryption(t,n,!0)}catch(e){c.logger.error("Error configuring encryption in room "+t+":",e)}}async onSyncWillProcess(e){e.oldSyncToken||(c.logger.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){this.deviceList.setSyncToken(e.nextSyncToken),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach((e=>{this.deviceList.invalidateUserDeviceList(e)})),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach((e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)}))}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const n=await t.getEncryptionTargetMembers();for(const t of n)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter((e=>{if(!this.roomEncryptors.get(e.roomId))return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t}))}async encryptAndSendToDevices(e,t){const n={eventType:o.EventType.RoomMessageEncrypted,batch:[]};try{await Promise.all(e.map((async({userId:e,deviceInfo:r})=>{const i=r.deviceId,s={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};n.batch.push({userId:e,deviceId:i,payload:s}),await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[e]:[r]}),await u.encryptMessageForDevice(s.ciphertext,this.userId,this.deviceId,this.olmDevice,e,r,t)}))),n.batch=n.batch.filter((e=>Object.keys(e.payload.ciphertext).length>0||(c.logger.log(`No ciphertext for device ${e.userId}:${e.deviceId}: pruning`),!1)));try{await this.baseApis.queueToDevice(n)}catch(e){throw c.logger.error("sendToDevice failed",e),e}}catch(e){throw c.logger.error("encryptAndSendToDevices promises failed",e),e}}onRoomKeyEvent(e){const t=e.getContent();t.room_id&&t.algorithm?(this.backupManager.checkedForBackup||this.backupManager.checkAndStart(),this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)):c.logger.error("key event is missing fields")}onRoomKeyWithheldEvent(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void c.logger.error("key withheld event is missing fields");c.logger.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const n=this.getRoomDecryptor(t.room_id,t.algorithm);if(n.onRoomKeyWithheldEvent&&n.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const n of e)n.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){I.ToDeviceChannel.validateEvent(e,this.baseApis)&&this.handleVerificationEvent(e,this.toDeviceVerificationRequests,(e=>{if(!I.ToDeviceChannel.canCreateRequest(I.ToDeviceChannel.getEventType(e)))return;const t=e.getContent(),n=t&&t.from_device;if(!n)return;const r=e.getSender(),i=new I.ToDeviceChannel(this.baseApis,r,[n]);return new S.VerificationRequest(i,this.verificationMethods,this.baseApis)}))}async handleVerificationEvent(e,t,n,r=!0){if(e.isSending()&&e.status!=N.EventStatus.SENT){let t,n;try{await new Promise(((r,i)=>{t=r,n=()=>{e.status==N.EventStatus.CANCELLED&&i(new Error("Event status set to CANCELLED."))},e.once(N.MatrixEventEvent.LocalEventIdReplaced,t),e.on(N.MatrixEventEvent.Status,n)}))}catch(e){return void c.logger.error("error while waiting for the verification event to be sent: ",e)}finally{e.removeListener(N.MatrixEventEvent.LocalEventIdReplaced,t),e.removeListener(N.MatrixEventEvent.Status,n)}}let i=t.getRequest(e),s=!1;if(!i){if(i=n(e),!i)return void c.logger.log(`Crypto: could not find VerificationRequest for ${e.getType()}, and could not create one, so ignoring.`);s=!0,t.setRequest(e,i)}e.setVerificationRequest(i);try{await i.channel.handleEvent(e,i,r)}catch(e){c.logger.error("error while handling verification event",e)}s&&!i.initiatedByMe&&!i.invalid&&!i.observeOnly&&this.baseApis.emit(K.VerificationRequest,i)}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),n=e.getSender(),r=t.algorithm,i=t.sender_key,s=()=>{const e=this.getRoomDecryptors(u.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(i)};if(void 0===n||void 0===i||void 0===i)return;this.lastNewSessionForced[n]=this.lastNewSessionForced[n]||{};const o=this.lastNewSessionForced[n][i]||0;if(o+36e5>Date.now())return c.logger.debug("New session already forced with device "+n+":"+i+" at "+o+": not forcing another"),await this.olmDevice.recordSessionProblem(i,"wedged",!0),void s();let a=this.deviceList.getDeviceByIdentityKey(r,i);if(!a&&(await this.downloadKeys([n],!1),a=this.deviceList.getDeviceByIdentityKey(r,i),!a))return c.logger.info("Couldn't find device for identity key "+i+": not re-establishing session"),await this.olmDevice.recordSessionProblem(i,"wedged",!1),void s();const l={};l[n]=[a],await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,l,!0),this.lastNewSessionForced[n][i]=Date.now();const d={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await u.encryptMessageForDevice(d.ciphertext,this.userId,this.deviceId,this.olmDevice,n,a,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(i,"wedged",!0),s(),await this.baseApis.sendToDevice("m.room.encrypted",{[n]:{[a.deviceId]:d}});const h=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,a.deviceId);for(const e of h)this.requestRoomKey(e.requestBody,e.recipients,!0)}onRoomMembership(e,t,n){const r=t.roomId,i=this.roomEncryptors.get(r);i&&(this.roomDeviceTrackingState[r]&&("join"==t.membership?(c.logger.log("Join event for "+t.userId+" in "+r),this.deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this.clientStore.getRoom(r).shouldEncryptForInvitedMembers()&&(c.logger.log("Invite event for "+t.userId+" in "+r),this.deviceList.startTrackingDeviceList(t.userId))),i.onRoomMembership(e,t,n))}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new G(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new H(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map((e=>this.processReceivedRoomKeyRequest(e)))),await Promise.all(t.map((e=>this.processReceivedRoomKeyRequestCancellation(e))))}catch(e){c.logger.error(`Error processing room key requsts: ${e}`)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,n=e.deviceId,r=e.requestBody,i=r.room_id,s=r.algorithm;if(c.logger.log(`m.room_key_request from ${t}:${n} for ${i} / ${r.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors.get(i))return void c.logger.debug(`room key request for unencrypted room ${i}`);const e=this.roomEncryptors.get(i),s=this.deviceList.getStoredDevice(t,n);if(!s)return void c.logger.debug(`Ignoring keyshare for unknown device ${t}:${n}`);try{await e.reshareKeyWithDevice(r.sender_key,r.session_id,t,s)}catch(e){c.logger.warn("Failed to re-share keys for session "+r.session_id+" with device "+t+":"+s.deviceId,e)}return}if(n===this.deviceId)return void c.logger.log("Ignoring room key request from ourselves");if(!this.roomDecryptors.has(i))return void c.logger.log(`room key request for unencrypted room ${i}`);const o=this.roomDecryptors.get(i).get(s);if(o)if(await o.hasKeysForKeyRequest(e)){if(e.share=()=>{o.shareKeysWithDevice(e)},this.checkDeviceTrust(t,n).isVerified())return c.logger.log("device is already verified: sharing keys"),void e.share();this.emit(K.RoomKeyRequest,e)}else c.logger.log(`room key request for unknown session ${i} / `+r.session_id);else c.logger.log(`room key request for unknown alg ${s} in room ${i}`)}async processReceivedRoomKeyRequestCancellation(e){c.logger.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit(K.RoomKeyRequestCancellation,e)}getRoomDecryptor(e,t){let n,r;if((e=e||null)&&(n=this.roomDecryptors.get(e),n||(n=new Map,this.roomDecryptors.set(e,n)),r=n.get(t),r))return r;const i=p.DECRYPTION_CLASSES.get(t);if(!i)throw new p.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return r=new i({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e}),n&&n.set(t,r),r}getRoomDecryptors(e){const t=[];for(const n of this.roomDecryptors.values())n.has(e)&&t.push(n.get(e));return t}async signObject(e){const t=e.signatures||{},n=e.unsigned;delete e.signatures,delete e.unsigned,t[this.userId]=t[this.userId]||{},t[this.userId]["ed25519:"+this.deviceId]=await this.olmDevice.sign(s.default.stringify(e)),e.signatures=t,void 0!==n&&(e.unsigned=n)}}function V(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),(e=>parseInt(e)));return u.encodeBase64(t)}t.Crypto=$;class G{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"requestId",void 0),(0,i.default)(this,"requestBody",void 0),(0,i.default)(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}t.IncomingRoomKeyRequest=G;class H{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}},6891:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deriveKey=c,t.keyFromAuthData=function(e,t){if(!n.g.Olm)throw new Error("Olm is not available");if(!e.private_key_salt||!e.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return c(t,e.private_key_salt,e.private_key_iterations,e.private_key_bits||a)},t.keyFromPassphrase=async function(e){if(!n.g.Olm)throw new Error("Olm is not available");const t=(0,r.randomString)(32);return{key:await c(e,t,o,a),salt:t,iterations:o}};var r=n(3759),i=n(4148);const s="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,o=5e5,a=256;async function c(e,t,r,o=a){return s?async function(e,t,r,i){const s=n.g.crypto.subtle,o=n.g.TextEncoder;if(!s||!o)throw new Error("Password-based backup is not avaiable on this platform");const a=await s.importKey("raw",(new o).encode(e),{name:"PBKDF2"},!1,["deriveBits"]),c=await s.deriveBits({name:"PBKDF2",salt:(new o).encode(t),iterations:r,hash:"SHA-512"},a,i);return new Uint8Array(c)}(e,t,r,o):async function(e,t,n,r){const s=(0,i.getCrypto)();if(!s)throw new Error("No usable crypto implementation");return s.pbkdf2Sync(e,Buffer.from(t,"binary"),n,r,"sha512")}(e,t,r,o)}},1978:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.OLM_ALGORITHM=t.MEGOLM_BACKUP_ALGORITHM=t.MEGOLM_ALGORITHM=void 0,t.decodeBase64=function(e){return Buffer.from(e,"base64")},t.encodeBase64=p,t.encodeUnpaddedBase64=function(e){return p(e).replace(/=+$/g,"")},t.encryptMessageForDevice=async function(e,t,n,r,i,s,a){const c=s.getIdentityKey(),l=await r.getSessionIdForDevice(c);if(null===l)return;o.logger.log("Using sessionid "+l+" for device "+i+":"+s.deviceId);const u={sender:t,sender_device:n,keys:{ed25519:r.deviceEd25519Key},recipient:i,recipient_keys:{ed25519:s.getFingerprint()}};Object.assign(u,a),e[c]=await r.encryptMessage(c,l,JSON.stringify(u))},t.ensureOlmSessionsForDevices=async function(e,t,n,r=!1,i,s,a=o.logger){"number"==typeof r&&(a=s,s=i,i=r,r=!1);const c=[],l={},u={};for(const[,t]of Object.entries(n))for(const n of t){const t=n.getIdentityKey();t!==e.deviceCurve25519Key&&(e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise((n=>{u[t]=r=>{delete e.sessionsInProgress[t],n(r)}}))))}for(const[t,i]of Object.entries(n)){l[t]={};for(const n of i){const i=n.deviceId,s=n.getIdentityKey();if(s===e.deviceCurve25519Key){a.info("Attempted to start session with ourself! Ignoring"),l[t][i]={device:n,sessionId:null};continue}const o=`for ${s} (${t}:${i})`,d=await e.getSessionIdForDevice(s,!!u[s],a);null!==d&&u[s]&&u[s](),(null===d||r)&&(r?a.info(`Forcing new Olm session ${o}`):a.info(`Making new Olm session ${o}`),c.push([t,i])),l[t][i]={device:n,sessionId:d}}}if(0===c.length)return l;const h="signed_curve25519";let p,g=`one-time keys for ${c.length} devices`;try{a.debug(`Claiming ${g}`),p=await t.claimOneTimeKeys(c,h,i),a.debug(`Claimed ${g}`)}catch(e){for(const e of Object.values(u))e();throw a.log(`Failed to claim ${g}`,e,c),e}s&&"failures"in p&&s.push(...Object.keys(p.failures));const f=p.one_time_keys||{},m=[];for(const[t,i]of Object.entries(n)){const n=f[t]||{};for(let s=0;s<i.length;s++){const o=i[s],c=o.deviceId,p=o.getIdentityKey();if(p===e.deviceCurve25519Key)continue;if(l[t][c].sessionId&&!r)continue;const g=n[c]||{};let f=null;for(const e in g)0===e.indexOf(h+":")&&(f=g[e]);f?m.push(d(e,f,t,o).then((e=>{u[p]&&u[p](e),l[t][c].sessionId=e}),(e=>{throw u[p]&&u[p](),e}))):(a.warn(`No one-time keys (alg=${h}) for device ${t}:${c}`),u[p]&&u[p]())}}return g=`Olm sessions for ${m.length} devices`,a.debug(`Starting ${g}`),await Promise.all(m),a.debug(`Started ${g}`),l},t.getExistingOlmSessions=async function(e,t,n){const r={},i={},s=[];for(const[t,o]of Object.entries(n))for(const n of o){const o=n.deviceId,a=n.getIdentityKey();s.push((async()=>{const s=await e.getSessionIdForDevice(a,!0);null===s?(r[t]=r[t]||[],r[t].push(n)):(i[t]=i[t]||{},i[t][o]={device:n,sessionId:s})})())}return await Promise.all(s),[r,i]},t.isOlmEncrypted=function(e){return e.getSenderKey()?!(e.getWireType()!==a.EventType.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(e.getWireContent().algorithm))||(o.logger.error("Event was not encrypted using an appropriate algorithm"),!1):(o.logger.error("Event has no sender key (not encrypted?)"),!1)},t.pkSign=function(e,t,r,i){let o=!1;if(t instanceof Uint8Array){const e=new n.g.Olm.PkSigning;i=e.init_with_seed(t),t=e,o=!0}const a=e.signatures||{};delete e.signatures;const c=e.unsigned;e.unsigned&&delete e.unsigned;try{const n=a[r]||{};return a[r]=n,n["ed25519:"+i]=t.sign(s.default.stringify(e))}finally{e.signatures=a,c&&(e.unsigned=c),o&&t.free()}},t.pkVerify=function(e,t,r){const i="ed25519:"+t;if(!(e.signatures&&e.signatures[r]&&e.signatures[r][i]))throw new Error("No signature");const o=e.signatures[r][i],a=new n.g.Olm.Utility,c=e.signatures;delete e.signatures;const l=e.unsigned;e.unsigned&&delete e.unsigned;try{a.ed25519_verify(t,s.default.stringify(e),o)}finally{e.signatures=c,l&&(e.unsigned=l),a.free()}},t.verifySignature=h;var i,s=r(n(4069)),o=n(9849),a=n(4703);!function(e){e.Olm="m.olm.v1.curve25519-aes-sha2",e.Megolm="m.megolm.v1.aes-sha2",e.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2"}(i||(i={}));const c=i.Olm;t.OLM_ALGORITHM=c;const l=i.Megolm;t.MEGOLM_ALGORITHM=l;const u=i.MegolmBackup;async function d(e,t,n,r){const i=r.deviceId;try{await h(e,t,n,i,r.getFingerprint())}catch(e){return o.logger.error("Unable to verify signature on one-time key for device "+n+":"+i+":",e),null}let s;try{s=await e.createOutboundSession(r.getIdentityKey(),t.key)}catch(e){return o.logger.error("Error starting olm session with device "+n+":"+i+": "+e),null}return o.logger.log("Started new olm sessionid "+s+" for device "+n+":"+i),s}async function h(e,t,n,r,i){const o="ed25519:"+r,a=((t.signatures||{})[n]||{})[o];if(!a)throw Error("No signature");const c=Object.assign({},t);"unsigned"in c&&delete c.unsigned,delete c.signatures;const l=s.default.stringify(c);e.verifySignature(i,l,a)}function p(e){return Buffer.from(e).toString("base64")}t.MEGOLM_BACKUP_ALGORITHM=u},5905:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.decodeRecoveryKey=function(e){const t=r.decode(e.replace(/ /g,""));let i=0;for(const e of t)i^=e;if(0!==i)throw new Error("Incorrect parity");for(let e=0;e<s.length;++e)if(t[e]!==s[e])throw new Error("Incorrect prefix");if(t.length!==s.length+n.g.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(s.length,s.length+n.g.Olm.PRIVATE_KEY_LENGTH))},t.encodeRecoveryKey=function(e){const t=Buffer.alloc(s.length+e.length+1);t.set(s,0),t.set(e,s.length);let n=0;for(let e=0;e<t.length-1;++e)n^=t[e];return t[t.length-1]=n,r.encode(t).match(/.{1,4}/g).join(" ")};var r=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=i(t);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var a=s?Object.getOwnPropertyDescriptor(e,o):null;a&&(a.get||a.set)?Object.defineProperty(r,o,a):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}(n(6763));function i(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(i=function(e){return e?n:t})(e)}const s=[139,1]},2051:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=t.Backend=void 0,t.upgradeDatabase=function(e,t){s.logger.log(`Upgrading IndexedDBCryptoStore from version ${t} to ${l}`),c.forEach(((n,r)=>{t<=r&&n(e)}))};var i=r(n(3693)),s=n(9849),o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=a(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148));function a(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(a=function(e){return e?n:t})(e)}t.Backend=class{constructor(e){this.db=e,(0,i.default)(this,"nextTxnId",0),e.onversionchange=()=>{s.logger.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise(((n,r)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readwrite");i.onerror=r,this._getOutgoingRoomKeyRequest(i,t,(r=>{if(r)return s.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void n(r);s.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),i.oncomplete=()=>{n(e)},i.objectStore("outgoingRoomKeyRequests").add(e)}))}))}getOutgoingRoomKeyRequest(e){return new Promise(((t,n)=>{const r=this.db.transaction("outgoingRoomKeyRequests","readonly");r.onerror=n,this._getOutgoingRoomKeyRequest(r,e,(e=>{t(e)}))}))}_getOutgoingRoomKeyRequest(e,t,n){const r=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);r.onsuccess=()=>{const e=r.result;if(!e)return void n(null);const i=e.value;o.deepCompare(i.requestBody,t)?n(i):e.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,n=0;const r=this.db.transaction("outgoingRoomKeyRequests","readonly"),i=r.objectStore("outgoingRoomKeyRequests"),s=e[n];return i.index("state").openCursor(s).onsuccess=function r(){const i=this.result;if(i)return void(t=i.value);if(n++,n>=e.length)return;const s=e[n];this.source.openCursor(s).onsuccess=r},d(r).then((()=>t))}getAllOutgoingRoomKeyRequestsByState(e){return new Promise(((t,n)=>{const r=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);r.onsuccess=()=>t(r.result),r.onerror=()=>n(r.error)}))}getOutgoingRoomKeyRequestsByTarget(e,t,n){let r=0;const i=[],s=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=s.objectStore("outgoingRoomKeyRequests"),a=n[r];return o.index("state").openCursor(a).onsuccess=function s(){const o=this.result;if(o){const n=o.value;n.recipients.some((n=>n.userId===e&&n.deviceId===t))&&i.push(n),o.continue()}else{if(r++,r>=n.length)return;const e=n[r];this.source.openCursor(e).onsuccess=s}},d(s).then((()=>i))}updateOutgoingRoomKeyRequest(e,t,n){let r=null;const i=this.db.transaction("outgoingRoomKeyRequests","readwrite");return i.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(){const e=this.result;if(!e)return;const i=e.value;i.state==t?(Object.assign(i,n),e.update(i),r=i):s.logger.warn(`Cannot update room key request from ${t} as it was already updated to ${i.state}`)},d(i).then((()=>r))}deleteOutgoingRoomKeyRequest(e,t){const n=this.db.transaction("outgoingRoomKeyRequests","readwrite"),r=n.objectStore("outgoingRoomKeyRequests").openCursor(e);return r.onsuccess=()=>{const e=r.result;if(!e)return;const n=e.value;n.state==t?e.delete():s.logger.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`)},d(n)}getAccount(e,t){const n=e.objectStore("account").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){u(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const n=e.objectStore("account").get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(t){u(e,t)}}}getSecretStorePrivateKey(e,t,n){const r=e.objectStore("account").get(`ssss_cache:${n}`);r.onsuccess=function(){try{t(r.result||null)}catch(t){u(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,n){e.objectStore("account").put(n,`ssss_cache:${t}`)}countEndToEndSessions(e,t){const n=e.objectStore("sessions").count();n.onsuccess=function(){try{t(n.result)}catch(t){u(e,t)}}}getEndToEndSessions(e,t,n){const r=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};r.onsuccess=function(){const e=r.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{n(i)}catch(e){u(t,e)}}}getEndToEndSession(e,t,n,r){const i=n.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?r({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):r(null)}catch(e){u(n,e)}}}getAllEndToEndSessions(e,t){const n=e.objectStore("sessions").openCursor();n.onsuccess=function(){try{const e=n.result;e?(t(e.value),e.continue()):t(null)}catch(t){u(e,t)}}}storeEndToEndSession(e,t,n,r){r.objectStore("sessions").put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,n){const r=this.db.transaction("session_problems","readwrite");return r.objectStore("session_problems").put({deviceKey:e,type:t,fixed:n,time:Date.now()}),d(r)}async getEndToEndSessionProblem(e,t){let n;const r=this.db.transaction("session_problems","readwrite"),i=r.objectStore("session_problems").index("deviceKey").getAll(e);return i.onsuccess=()=>{const e=i.result;if(!e.length)return void(n=null);e.sort(((e,t)=>e.time-t.time));const r=e[e.length-1];for(const i of e)if(i.time>t)return void(n=Object.assign({},i,{fixed:r.fixed}));n=r.fixed?null:r},await d(r),n}async filterOutNotifiedErrorDevices(e){const t=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),n=[];return await Promise.all(e.map((e=>new Promise((r=>{const{userId:i,deviceInfo:s}=e,o=t.get([i,s.deviceId]);o.onsuccess=function(){o.result||(t.put({userId:i,deviceId:s.deviceId}),n.push(e)),r()}}))))),n}getEndToEndInboundGroupSession(e,t,n,r){let i=!1,s=!1;const o=n.objectStore("inbound_group_sessions").get([e,t]);o.onsuccess=function(){try{i=o.result?o.result.session:null,!1!==s&&r(i,s)}catch(e){u(n,e)}};const a=n.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{s=a.result?a.result.session:null,!1!==i&&r(i,s)}catch(e){u(n,e)}}}getAllEndToEndInboundGroupSessions(e,t){const n=e.objectStore("inbound_group_sessions").openCursor();n.onsuccess=function(){const r=n.result;if(r){try{t({senderKey:r.value.senderCurve25519Key,sessionId:r.value.sessionId,sessionData:r.value.session})}catch(t){u(e,t)}r.continue()}else try{t(null)}catch(t){u(e,t)}}}addEndToEndInboundGroupSession(e,t,n,r){const i=r.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:n});i.onerror=n=>{"ConstraintError"===i.error.name?(n.stopPropagation(),n.preventDefault(),s.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):u(r,new Error("Failed to add inbound group session: "+i.error))}}storeEndToEndInboundGroupSession(e,t,n,r){r.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:n})}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){r.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:n})}getEndToEndDeviceData(e,t){const n=e.objectStore("device_data").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){u(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,n){n.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const n={},r=e.objectStore("rooms").openCursor();r.onsuccess=function(){const i=r.result;if(i)n[i.key]=i.value,i.continue();else try{t(n)}catch(t){u(e,t)}}}getSessionsNeedingBackup(e){return new Promise(((t,n)=>{const r=[],i=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=n,i.oncomplete=function(){t(r)};const s=i.objectStore("sessions_needing_backup"),o=i.objectStore("inbound_group_sessions"),a=s.openCursor();a.onsuccess=function(){const t=a.result;if(t){const n=o.get(t.key);n.onsuccess=function(){r.push({senderKey:n.result.senderCurve25519Key,sessionId:n.result.sessionId,sessionData:n.result.session})},(!e||r.length<e)&&t.continue()}}}))}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise(((e,n)=>{const r=t.count();r.onerror=n,r.onsuccess=()=>e(r.result)}))}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,r)=>{const i=n.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=r})))))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,r)=>{const i=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=r})))))}addSharedHistoryInboundGroupSession(e,t,n,r){r||(r=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const i=r.objectStore("shared_history_inbound_group_sessions"),s=i.get([e]);s.onsuccess=()=>{const{sessions:r}=s.result||{sessions:[]};r.push([t,n]),i.put({roomId:e,sessions:r})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const n=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise(((e,t)=>{n.onsuccess=()=>{const{sessions:t}=n.result||{sessions:[]};e(t)},n.onerror=t}))}addParkedSharedHistory(e,t,n){n||(n=this.db.transaction("parked_shared_history","readwrite"));const r=n.objectStore("parked_shared_history"),i=r.get([e]);i.onsuccess=()=>{const{parked:n}=i.result||{parked:[]};n.push(t),r.put({roomId:e,parked:n})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));const n=t.objectStore("parked_shared_history").openCursor(e);return new Promise(((e,t)=>{n.onsuccess=()=>{const t=n.result;if(!t)return void e([]);const r=t.value;t.delete(),e(r)},n.onerror=t}))}doTxn(e,t,n,r=s.logger){const i=this.db.transaction(t,e),o=d(i),a=n(i);return o.then((()=>a))}};const c=[e=>{!function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e)},e=>{e.createObjectStore("account")},e=>{e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],l=c.length;function u(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function d(e){return new Promise(((t,n)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&n(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(s.logger.log("Error performing indexeddb txn",t),n(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(s.logger.log("Error performing indexeddb txn",t),n(e.error))}}))}t.VERSION=l},3514:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBCryptoStore=void 0;var i=r(n(3693)),s=n(9849),o=n(1039),a=n(7926),c=h(n(2051)),l=n(2382),u=h(n(7038));function d(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(d=function(e){return e?n:t})(e)}function h(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=d(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}class p{static exists(e,t){return u.exists(e,t)}constructor(e,t){this.indexedDB=e,this.dbName=t,(0,i.default)(this,"backendPromise",null),(0,i.default)(this,"backend",null)}startup(){return this.backendPromise||(this.backendPromise=new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));s.logger.log(`connecting to indexeddb ${this.dbName}`);const n=this.indexedDB.open(this.dbName,c.VERSION);n.onupgradeneeded=e=>{const t=n.result,r=e.oldVersion;c.upgradeDatabase(t,r)},n.onblocked=()=>{s.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{s.logger.log("Error connecting to indexeddb",e),t(n.error)},n.onsuccess=()=>{const t=n.result;s.logger.log(`connected to indexeddb ${this.dbName}`),e(new c.Backend(t))}})).then((e=>e.doTxn("readonly",[p.STORE_INBOUND_GROUP_SESSIONS,p.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(t=>{e.getEndToEndInboundGroupSession("","",t,(()=>{}))})).then((()=>e)))).catch((e=>{if("VersionError"===e.name)throw s.logger.warn("Crypto DB is too new for us to use!",e),new l.InvalidCryptoStoreError(l.InvalidCryptoStoreError.TOO_NEW);s.logger.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${e}`);try{return new o.LocalStorageCryptoStore(n.g.localStorage)}catch(e){return s.logger.warn(`unable to open localStorage: falling back to in-memory store: ${e}`),new a.MemoryCryptoStore}})).then((e=>(this.backend=e,e)))),this.backendPromise}deleteAllData(){return new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));s.logger.log(`Removing indexeddb instance: ${this.dbName}`);const n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{s.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{s.logger.log("Error deleting data from indexeddb",e),t(n.error)},n.onsuccess=()=>{s.logger.log(`Removed indexeddb instance: ${this.dbName}`),e()}})).catch((e=>{s.logger.warn(`unable to delete IndexedDBCryptoStore: ${e}`)}))}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,n){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,n)}updateOutgoingRoomKeyRequest(e,t,n){return this.backend.updateOutgoingRoomKeyRequest(e,t,n)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,r){this.backend.getEndToEndSession(e,t,n,r)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,n,r){this.backend.storeEndToEndSession(e,t,n,r)}storeEndToEndSessionProblem(e,t,n){return this.backend.storeEndToEndSessionProblem(e,t,n)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,n,r){this.backend.getEndToEndInboundGroupSession(e,t,n,r)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,n,r){this.backend.addEndToEndInboundGroupSession(e,t,n,r)}storeEndToEndInboundGroupSession(e,t,n,r){this.backend.storeEndToEndInboundGroupSession(e,t,n,r)}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,n,r)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,n){this.backend.storeEndToEndRoom(e,t,n)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,n,r){this.backend.addSharedHistoryInboundGroupSession(e,t,n,r)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,n){this.backend.addParkedSharedHistory(e,t,n)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,n,r){return this.backend.doTxn(e,t,n,r)}}t.IndexedDBCryptoStore=p,(0,i.default)(p,"STORE_ACCOUNT","account"),(0,i.default)(p,"STORE_SESSIONS","sessions"),(0,i.default)(p,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,i.default)(p,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,i.default)(p,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,i.default)(p,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),(0,i.default)(p,"STORE_DEVICE_DATA","device_data"),(0,i.default)(p,"STORE_ROOMS","rooms"),(0,i.default)(p,"STORE_BACKUP","sessions_needing_backup")},1039:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageCryptoStore=void 0;var r=n(9849),i=n(7926);const s="crypto.",o=s+"account",a=s+"cross_signing_keys",c=s+"notified_error_devices",l=s+"device_data",u=s+"inboundgroupsessions/",d=s+"inboundgroupsessions.withheld/",h=s+"rooms/",p=s+"sessionsneedingbackup";function g(e){return s+"sessions/"+e}function f(e){return s+"session.problems/"+e}function m(e,t){return u+e+"/"+t}function v(e,t){return d+e+"/"+t}function y(e){return h+e}class _ extends i.MemoryCryptoStore{static exists(e){const t=e.length;for(let n=0;n<t;n++)if(e.key(n).startsWith(s))return!0;return!1}constructor(e){super(),this.store=e}countEndToEndSessions(e,t){let n=0;for(let e=0;e<this.store.length;++e)this.store.key(e).startsWith(g(""))&&++n;t(n)}_getEndToEndSessions(e){const t=b(this.store,g(e)),n={};for(const[e,r]of Object.entries(t||{}))n[e]="string"==typeof r?{session:r}:r;return n}getEndToEndSession(e,t,n,r){r(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,n){n(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e)if(this.store.key(e).startsWith(g(""))){const n=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(n)))t(e)}}storeEndToEndSession(e,t,n,r){const i=this._getEndToEndSessions(e)||{};i[t]=n,E(this.store,g(e),i)}async storeEndToEndSessionProblem(e,t,n){const r=f(e),i=b(this.store,r)||[];i.push({type:t,fixed:n,time:Date.now()}),i.sort(((e,t)=>e.time-t.time)),E(this.store,r,i)}async getEndToEndSessionProblem(e,t){const n=f(e),r=b(this.store,n)||[];if(!r.length)return null;const i=r[r.length-1];for(const e of r)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=b(this.store,c)||{},n=[];for(const r of e){const{userId:e,deviceInfo:i}=r;e in t?i.deviceId in t[e]||(n.push(r),t[e][i.deviceId]=!0):(n.push(r),t[e]={[i.deviceId]:!0})}return E(this.store,c,t),n}getEndToEndInboundGroupSession(e,t,n,r){r(b(this.store,m(e,t)),b(this.store,v(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const n=this.store.key(e);n.startsWith(u)&&t({senderKey:n.slice(28,71),sessionId:n.slice(72),sessionData:b(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,n,r){b(this.store,m(e,t))||this.storeEndToEndInboundGroupSession(e,t,n,r)}storeEndToEndInboundGroupSession(e,t,n,r){E(this.store,m(e,t),n)}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){E(this.store,v(e,t),n)}getEndToEndDeviceData(e,t){t(b(this.store,l))}storeEndToEndDeviceData(e,t){E(this.store,l,e)}storeEndToEndRoom(e,t,n){E(this.store,y(e),t)}getEndToEndRooms(e,t){const n={},r=y("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);t.startsWith(r)&&(n[t.slice(r.length)]=b(this.store,t))}t(n)}getSessionsNeedingBackup(e){const t=b(this.store,p)||{},n=[];for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)){const t=r.slice(0,43),i=r.slice(44);if(this.getEndToEndInboundGroupSession(t,i,null,(e=>{n.push({senderKey:t,sessionId:i,sessionData:e})})),e&&n.length>=e)break}return Promise.resolve(n)}countSessionsNeedingBackup(){const e=b(this.store,p)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=b(this.store,p)||{};for(const n of e)delete t[n.senderKey+"/"+n.sessionId];return E(this.store,p,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=b(this.store,p)||{};for(const n of e)t[n.senderKey+"/"+n.sessionId]=!0;return E(this.store,p,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(o),Promise.resolve()}getAccount(e,t){t(b(this.store,o))}storeAccount(e,t){E(this.store,o,t)}getCrossSigningKeys(e,t){t(b(this.store,a))}getSecretStorePrivateKey(e,t,n){t(b(this.store,s+`ssss_cache.${n}`))}storeCrossSigningKeys(e,t){E(this.store,a,t)}storeSecretStorePrivateKey(e,t,n){E(this.store,s+`ssss_cache.${t}`,n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function b(e,t){try{return JSON.parse(e.getItem(t))}catch(e){r.logger.log("Error: Failed to get key %s: %s",t,e.stack||e),r.logger.log(e.stack)}return null}function E(e,t,n){e.setItem(t,JSON.stringify(n))}t.LocalStorageCryptoStore=_},7926:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryCryptoStore=void 0;var i=r(n(3693)),s=n(9849),o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=a(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148));function a(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(a=function(e){return e?n:t})(e)}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.MemoryCryptoStore=class{constructor(){(0,i.default)(this,"outgoingRoomKeyRequests",[]),(0,i.default)(this,"account",null),(0,i.default)(this,"crossSigningKeys",null),(0,i.default)(this,"privateKeys",{}),(0,i.default)(this,"sessions",{}),(0,i.default)(this,"sessionProblems",{}),(0,i.default)(this,"notifiedErrorDevices",{}),(0,i.default)(this,"inboundGroupSessions",{}),(0,i.default)(this,"inboundGroupSessionsWithheld",{}),(0,i.default)(this,"deviceData",null),(0,i.default)(this,"rooms",{}),(0,i.default)(this,"sessionsNeedingBackup",{}),(0,i.default)(this,"sharedHistoryInboundGroupSessions",{}),(0,i.default)(this,"parkedSharedHistory",new Map)}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return o.promiseTry((()=>{const n=this._getOutgoingRoomKeyRequest(t);return n?(s.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),n):(s.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)}))}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if(o.deepCompare(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const n of e)if(t.state===n)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter((t=>t.state==e)))}getOutgoingRoomKeyRequestsByTarget(e,t,n){const r=[];for(const i of this.outgoingRoomKeyRequests)for(const s of n)i.state===s&&i.recipients.some((n=>n.userId===e&&n.deviceId===t))&&r.push(i);return Promise.resolve(r)}updateOutgoingRoomKeyRequest(e,t,n){for(const r of this.outgoingRoomKeyRequests)if(r.requestId===e)return r.state!==t?(s.logger.warn(`Cannot update room key request from ${t} as it was already updated to ${r.state}`),Promise.resolve(null)):(Object.assign(r,n),Promise.resolve(r));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let n=0;n<this.outgoingRoomKeyRequests.length;n++){const r=this.outgoingRoomKeyRequests[n];if(r.requestId===e)return r.state!=t?(s.logger.warn(`Cannot delete room key request in state ${r.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(n,1),Promise.resolve(r))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){t(this.privateKeys[n]||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){t(Object.keys(this.sessions).length)}getEndToEndSession(e,t,n,r){r((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach((([e,n])=>{Object.entries(n).forEach((([n,r])=>{t(l(l({},r),{},{deviceKey:e,sessionId:n}))}))}))}storeEndToEndSession(e,t,n,r){let i=this.sessions[e];void 0===i&&(i={},this.sessions[e]=i),i[t]=n}async storeEndToEndSessionProblem(e,t,n){const r=this.sessionProblems[e]=this.sessionProblems[e]||[];r.push({type:t,fixed:n,time:Date.now()}),r.sort(((e,t)=>e.time-t.time))}async getEndToEndSessionProblem(e,t){const n=this.sessionProblems[e]||[];if(!n.length)return null;const r=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:r.fixed});return r.fixed?null:r}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,n=[];for(const r of e){const{userId:e,deviceInfo:i}=r;e in t?i.deviceId in t[e]||(n.push(r),t[e][i.deviceId]=!0):(n.push(r),t[e]={[i.deviceId]:!0})}return n}getEndToEndInboundGroupSession(e,t,n,r){const i=e+"/"+t;r(this.inboundGroupSessions[i]||null,this.inboundGroupSessionsWithheld[i]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this.inboundGroupSessions))t({senderKey:e.slice(0,43),sessionId:e.slice(44),sessionData:this.inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,n,r){const i=e+"/"+t;void 0===this.inboundGroupSessions[i]&&(this.inboundGroupSessions[i]=n)}storeEndToEndInboundGroupSession(e,t,n,r){this.inboundGroupSessions[e+"/"+t]=n}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){const i=e+"/"+t;this.inboundGroupSessionsWithheld[i]=n}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,n){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const n in this.sessionsNeedingBackup)if(this.inboundGroupSessions[n]&&(t.push({senderKey:n.slice(0,43),sessionId:n.slice(44),sessionData:this.inboundGroupSessions[n]}),e&&n.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,n){const r=this.sharedHistoryInboundGroupSessions[e]||[];r.push([t,n]),this.sharedHistoryInboundGroupSessions[e]=r}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var n;const r=null!==(n=this.parkedSharedHistory.get(e))&&void 0!==n?n:[];r.push(t),this.parkedSharedHistory.set(e,r)}takeParkedSharedHistory(e){var t;const n=null!==(t=this.parkedSharedHistory.get(e))&&void 0!==t?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(n)}doTxn(e,t,n){return Promise.resolve(n(null))}}},3602:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationEvent=t.VerificationBase=t.SwitchStartEventError=void 0;var i=r(n(3693)),s=n(224),o=n(9849),a=n(4981),c=n(6845),l=n(2180),u=n(7022);const d=new Error("Verification timed out");class h extends Error{constructor(e){super(),this.startEvent=e}}let p;t.SwitchStartEventError=h,t.VerificationEvent=p,function(e){e.Cancel="cancel"}(p||(t.VerificationEvent=p={}));class g extends u.TypedEventEmitter{constructor(e,t,n,r,s,o){super(),this.channel=e,this.baseApis=t,this.userId=n,this.deviceId=r,this.startEvent=s,this.request=o,(0,i.default)(this,"cancelled",!1),(0,i.default)(this,"_done",!1),(0,i.default)(this,"promise",null),(0,i.default)(this,"transactionTimeoutTimer",null),(0,i.default)(this,"expectedEvent",void 0),(0,i.default)(this,"resolve",void 0),(0,i.default)(this,"reject",void 0),(0,i.default)(this,"resolveEvent",void 0),(0,i.default)(this,"rejectEvent",void 0),(0,i.default)(this,"started",void 0),(0,i.default)(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){o.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout((()=>{this._done||this.cancelled||(o.logger.info("Triggering verification timeout"),this.cancel(d))}),6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise(((e,t)=>{this.resolveEvent=e,this.rejectEvent=t})))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(o.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new h(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this.expectedEvent)"m.key.verification.done"!==this.expectedEvent&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),this.resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this.reject;if(this.reject=void 0,t){const n=e.getContent(),{reason:r,code:i}=n;t(new Error(`Other side cancelled verification because ${r} (${i})`))}}else if(this.expectedEvent){const t=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),this.resolve(),(0,l.requestKeysDuringVerification)(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===d){const e=(0,c.newTimeoutError)();this.send(e.getType(),e.getContent())}else if(e instanceof s.MatrixEvent){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send("m.key.verification.cancel",t)):this.send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(p.Cancel,e)}}verify(){return this.promise||(this.promise=new Promise(((e,t)=>{this.resolve=(...t)=>{this._done=!0,this.endTimer(),e(...t)},this.reject=e=>{this._done=!0,this.endTimer(),t(e)}})),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise(((e,t)=>{var n;(null===(n=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))||void 0===n?void 0:n.getId())===this.deviceId&&t(new Error("Device ID is the same as the cross-signing ID")),e()})).then((()=>this.doVerification())).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,n){const r=[];for(const[i,s]of Object.entries(t)){const t=i.split(":",2)[1],c=this.baseApis.getStoredDevice(e,t);if(c)n(i,c,s),r.push([t,i,c.keys[i]]);else{const c=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===t?(n(i,a.DeviceInfo.fromStorage({keys:{[i]:t}},t),s),r.push([t,i,t])):o.logger.warn(`verification: Could not find device ${t} to verify`)}}if(!r.length)throw new Error("No devices could be verified");o.logger.info("Verification completed! Marking devices verified: ",r);for(const[t,n,i]of r)await this.baseApis.crypto.setDeviceVerification(e,t,!0,null,null,{[n]:i});e==this.baseApis.credentials.userId&&await this.baseApis.checkKeyBackup()}get events(){}}t.VerificationBase=g},6845:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errorFactory=s,t.errorFromEvent=function(e){const t=e.getContent();if(t){const{code:e,reason:n}=t;return{code:e,reason:n}}return{code:"Unknown error",reason:"m.unknown"}},t.newUserCancelledError=t.newUnknownMethodError=t.newUnexpectedMessageError=t.newTimeoutError=t.newKeyMismatchError=t.newInvalidMessageError=void 0,t.newVerificationError=i;var r=n(224);function i(e,t,n){const i=Object.assign({},{code:e,reason:t},n);return new r.MatrixEvent({type:"m.key.verification.cancel",content:i})}function s(e,t){return function(n){return i(e,t,n)}}const o=s("m.user","Cancelled by user");t.newUserCancelledError=o;const a=s("m.timeout","Timed out");t.newTimeoutError=a;const c=s("m.unknown_method","Unknown method");t.newUnknownMethodError=c;const l=s("m.unexpected_message","Unexpected message");t.newUnexpectedMessageError=l;const u=s("m.key_mismatch","Key mismatch");t.newKeyMismatchError=u;const d=s("m.invalid_message","Invalid message");t.newInvalidMessageError=d},2336:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.IllegalMethod=void 0;var i=r(n(3693)),s=n(3602);class o extends s.VerificationBase{constructor(...e){super(...e),(0,i.default)(this,"doVerification",(async()=>{throw new Error("Verification is not possible with this method")}))}static factory(e,t,n,r,i,s){return new o(e,t,n,r,i,s)}static get NAME(){return"org.matrix.illegal_method"}}t.IllegalMethod=o},8825:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SHOW_QR_CODE_METHOD=t.SCAN_QR_CODE_METHOD=t.ReciprocateQRCode=t.QrCodeEvent=t.QRCodeData=void 0;var i=r(n(3693)),s=n(3602),o=n(6845),a=n(1978),c=n(9849);let l;t.SHOW_QR_CODE_METHOD="m.qr_code.show.v1",t.SCAN_QR_CODE_METHOD="m.qr_code.scan.v1",t.QrCodeEvent=l,function(e){e.ShowReciprocateQr="show_reciprocate_qr"}(l||(t.QrCodeEvent=l={}));class u extends s.VerificationBase{constructor(...e){super(...e),(0,i.default)(this,"reciprocateQREvent",void 0),(0,i.default)(this,"doVerification",(async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==e.encodedSharedSecret)throw(0,o.newKeyMismatchError)();await new Promise(((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t((0,o.newUserCancelledError)())},this.emit(l.ShowReciprocateQr,this.reciprocateQREvent)}));const t={};switch(e.mode){case d.VerifyOtherUser:{const n=e.otherUserMasterKey;t[`ed25519:${n}`]=n;break}case d.VerifySelfTrusted:{const n=this.request.targetDevice.deviceId;t[`ed25519:${n}`]=e.otherDeviceKey;break}case d.VerifySelfUntrusted:{const n=e.myMasterKey;t[`ed25519:${n}`]=n;break}}await this.verifyKeys(this.userId,t,((e,n,r)=>{const i=t[e];if(!i)throw(0,o.newKeyMismatchError)();if(r!==i)throw c.logger.error("key ID from key info does not match"),(0,o.newKeyMismatchError)();for(const e in n.keys){if(!e.startsWith("ed25519"))continue;const r=t[e];if(!r)throw(0,o.newKeyMismatchError)();if(n.keys[e]!==r)throw c.logger.error("master key does not match"),(0,o.newKeyMismatchError)()}}))}))}static factory(e,t,n,r,i,s){return new u(e,t,n,r,i,s)}static get NAME(){return"m.reciprocate.v1"}}var d;t.ReciprocateQRCode=u,function(e){e[e.VerifyOtherUser=0]="VerifyOtherUser",e[e.VerifySelfTrusted=1]="VerifySelfTrusted",e[e.VerifySelfUntrusted=2]="VerifySelfUntrusted"}(d||(d={}));class h{constructor(e,t,n,r,i,s){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=n,this.otherDeviceKey=r,this.myMasterKey=i,this.buffer=s}static async create(e,t){const n=h.generateSharedSecret(),r=h.determineMode(e,t);let i=null,s=null,o=null;if(r===d.VerifyOtherUser)i=t.getStoredCrossSigningForUser(e.otherUserId).getId("master");else if(r===d.VerifySelfTrusted)s=await h.getOtherDeviceKey(e,t);else if(r===d.VerifySelfUntrusted){const e=t.getUserId();o=t.getStoredCrossSigningForUser(e).getId("master")}const a=h.generateQrData(e,t,r,n,i,s,o),c=h.generateBuffer(a);return new h(r,n,i,s,o,c)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const e=new Uint8Array(11);return n.g.crypto.getRandomValues(e),(0,a.encodeUnpaddedBase64)(e)}static async getOtherDeviceKey(e,t){const n=t.getUserId(),r=e.targetDevice,i=r?r.deviceId:null,s=t.getStoredDevice(n,i);if(!s)throw new Error("could not find device "+i);return s.getFingerprint()}static determineMode(e,t){const n=t.getUserId(),r=e.otherUserId;let i=d.VerifyOtherUser;return n===r&&(i=t.checkUserTrust(n).isCrossSigningVerified()?d.VerifySelfTrusted:d.VerifySelfUntrusted),i}static generateQrData(e,t,n,r,i,s,o){const a=t.getUserId(),c={prefix:"MATRIX",version:2,mode:n,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:r},l=t.getStoredCrossSigningForUser(a);return n===d.VerifyOtherUser?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=i):n===d.VerifySelfTrusted?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=s):n===d.VerifySelfUntrusted&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=o),c}static generateBuffer(e){let t=Buffer.alloc(0);const n=e=>{const n=Buffer.from([e]);t=Buffer.concat([t,n])},r=(e,n,r=!0)=>{const i=Buffer.from(e,n);r&&(e=>{const n=Buffer.alloc(2);n.writeInt16BE(e,0),t=Buffer.concat([t,n])})(i.byteLength),t=Buffer.concat([t,i])},i=e=>{const n=(0,a.decodeBase64)(e),r=Buffer.from(n);t=Buffer.concat([t,r])};return r(e.prefix,"ascii",!1),n(e.version),n(e.mode),r(e.transactionId,"utf-8"),i(e.firstKeyB64),i(e.secondKeyB64),i(e.secretB64),t}}t.QRCodeData=h},518:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SasEvent=t.SAS=void 0;var i=r(n(3693)),s=r(n(4069)),o=n(3602),a=n(6845),c=n(9849);const l="m.key.verification.start",u=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let d;const h=(0,a.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),p=(0,a.errorFactory)("m.mismatched_commitment","Mismatched commitment"),g=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["🙂","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓️","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]],f={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((e=>g[e]))}};function m(e,t){const n={};for(const r of t)r in f&&(n[r]=f[r](e));return n}const v={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function y(e,t){return function(...n){const r=e[v[t]].apply(e,n);return c.logger.log("SAS calculateMAC:",t,n,r),r}}const _={"curve25519-hkdf-sha256":function(e,t,n){const r=`${e.baseApis.getUserId()}|${e.baseApis.deviceId}|${e.ourSASPubKey}|`,i=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,s="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?r+i:i+r)+e.channel.transactionId;return t.generate_bytes(s,n)},curve25519:function(e,t,n){const r=`${e.baseApis.getUserId()}${e.baseApis.deviceId}`,i=`${e.userId}${e.deviceId}`,s="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?r+i:i+r)+e.channel.transactionId;return t.generate_bytes(s,n)}},b=["curve25519-hkdf-sha256","curve25519"],E=["sha256"],A=["org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],S=Object.keys(f),w=new Set(b),I=new Set(E),T=new Set(A),k=new Set(S);function R(e,t){return e instanceof Array?e.filter((e=>t.has(e))):[]}let O;t.SasEvent=O,function(e){e.ShowSas="show_sas"}(O||(t.SasEvent=O={}));class C extends o.VerificationBase{constructor(...e){super(...e),(0,i.default)(this,"waitingForAccept",void 0),(0,i.default)(this,"ourSASPubKey",void 0),(0,i.default)(this,"theirSASPubKey",void 0),(0,i.default)(this,"sasEvent",void 0),(0,i.default)(this,"doVerification",(async()=>{await n.g.Olm.init(),d=d||new n.g.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let e=!1;do{try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(t){if(!(t instanceof o.SwitchStartEventError))throw t;this.startEvent=t.startEvent,e=!0}}while(e)}))}static get NAME(){return"m.sas.v1"}get events(){return u}canSwitchStartEvent(e){if(e.getType()!==l)return!1;const t=e.getContent();return t&&t.method===C.NAME&&this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(l,{method:C.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:b,hashes:E,message_authentication_codes:A,short_authentication_string:S});return await this.channel.sendCompleted(l,e),e}async doSendVerification(){let e,t;if(this.waitingForAccept=!0,e=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new o.SwitchStartEventError(this.startEvent);try{t=await this.waitForEvent("m.key.verification.accept")}finally{this.waitingForAccept=!1}let r=t.getContent();const i=R(r.short_authentication_string,k);if(!(w.has(r.key_agreement_protocol)&&I.has(r.hash)&&T.has(r.message_authentication_code)&&i.length))throw(0,a.newUnknownMethodError)();if("string"!=typeof r.commitment)throw(0,a.newInvalidMessageError)();const c=r.key_agreement_protocol,l=r.message_authentication_code,u=r.commitment,g=new n.g.Olm.SAS;try{this.ourSASPubKey=g.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey}),t=await this.waitForEvent("m.key.verification.key"),r=t.getContent();const n=r.key+s.default.stringify(e);if(d.sha256(n)!==u)throw p();this.theirSASPubKey=r.key,g.set_their_key(r.key);const o=_[c](this,g,6),f=new Promise(((e,t)=>{this.sasEvent={sas:m(o,i),confirm:async()=>{try{await this.sendMAC(g,l),e()}catch(e){t(e)}},cancel:()=>t((0,a.newUserCancelledError)()),mismatch:()=>t(h())},this.emit(O.ShowSas,this.sasEvent)}));[t]=await Promise.all([this.waitForEvent("m.key.verification.mac").then((e=>(this.expectedEvent="m.key.verification.done",e))),f]),r=t.getContent(),await this.checkMAC(g,r,l)}finally{g.free()}}async doRespondVerification(){let e=this.channel.completedContentFromEvent(this.startEvent);const t=R(b,new Set(e.key_agreement_protocols))[0],r=R(E,new Set(e.hashes))[0],i=R(A,new Set(e.message_authentication_codes))[0],o=R(e.short_authentication_string,k);if(void 0===t||void 0===r||void 0===i||!o.length)throw(0,a.newUnknownMethodError)();const c=new n.g.Olm.SAS;try{const n=c.get_pubkey()+s.default.stringify(e);await this.send("m.key.verification.accept",{key_agreement_protocol:t,hash:r,message_authentication_code:i,short_authentication_string:o,commitment:d.sha256(n)});let l=await this.waitForEvent("m.key.verification.key");e=l.getContent(),this.theirSASPubKey=e.key,c.set_their_key(e.key),this.ourSASPubKey=c.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey});const u=_[t](this,c,6),p=new Promise(((e,t)=>{this.sasEvent={sas:m(u,o),confirm:async()=>{try{await this.sendMAC(c,i),e()}catch(e){t(e)}},cancel:()=>t((0,a.newUserCancelledError)()),mismatch:()=>t(h())},this.emit(O.ShowSas,this.sasEvent)}));[l]=await Promise.all([this.waitForEvent("m.key.verification.mac").then((e=>(this.expectedEvent="m.key.verification.done",e))),p]),e=l.getContent(),await this.checkMAC(c,e,i)}finally{c.free()}}sendMAC(e,t){const n={},r=[],i="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,s=`ed25519:${this.baseApis.deviceId}`;n[s]=y(e,t)(this.baseApis.getDeviceEd25519Key(),i+s),r.push(s);const o=this.baseApis.getCrossSigningId();if(o){const s=`ed25519:${o}`;n[s]=y(e,t)(o,i+s),r.push(s)}const a=y(e,t)(r.sort().join(","),i+"KEY_IDS");return this.send("m.key.verification.mac",{mac:n,keys:a})}async checkMAC(e,t,n){const r="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==y(e,n)(Object.keys(t.mac).sort().join(","),r+"KEY_IDS"))throw(0,a.newKeyMismatchError)();await this.verifyKeys(this.userId,t.mac,((t,i,s)=>{if(s!==y(e,n)(i.keys[t],r+t))throw(0,a.newKeyMismatchError)()}))}}t.SAS=C},7466:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.InRoomRequests=t.InRoomChannel=void 0;var i=r(n(3693)),s=n(5673),o=n(9849);const a=n(4703).EventType.RoomMessage,c="m.reference",l="m.relates_to";class u{constructor(e,t,n=null){this.client=e,this.roomId=t,this.userId=n,(0,i.default)(this,"requestEventId",null)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(u.getEventType(e)!==s.REQUEST_TYPE)return;const n=t.getUserId(),r=e.getSender(),i=e.getContent().to;return r===n?i:i===n?r:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===s.REQUEST_TYPE}canCreateRequest(e){return u.canCreateRequest(e)}static getTransactionId(e){if(u.getEventType(e)===s.REQUEST_TYPE)return e.getId();{const t=e.getRelation();if(t&&t.rel_type===c)return t.event_id}}static validateEvent(e,t){const n=u.getTransactionId(e);if("string"!=typeof n||0===n.length)return!1;const r=u.getEventType(e),i=e.getContent();if(r===s.REQUEST_TYPE){if(!i||"string"!=typeof i.to||!i.to.length)return o.logger.log("InRoomChannel: validateEvent: no valid to "+(i&&i.to)),!1;if(!u.getOtherPartyUserId(e,t))return o.logger.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${e.getSender()}, ${i&&i.to}`),!1}return s.VerificationRequest.validateEvent(r,e,t)}static getEventType(e){const t=e.getType();if(t===a){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===s.REQUEST_TYPE)return s.REQUEST_TYPE}}return t&&t!==s.REQUEST_TYPE?t:""}handleEvent(e,t,n=!1){if(t.hasEventId(e.getId()))return;const r=u.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(null===this.userId){const t=u.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}const i=this.client.getUserId(),s=e.getSender();if(null!==this.userId&&s!==i&&s!==this.userId)return void o.logger.log(`InRoomChannel: ignoring verification event from non-participating sender ${s}`);null===this.requestEventId&&(this.requestEventId=u.getTransactionId(e));const a=!!e.getUnsigned().transaction_id,c=e.getSender()===this.client.getUserId();return t.handleEvent(r,e,n,a,c)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[l]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==s.REQUEST_TYPE&&e!==s.READY_TYPE&&e!==s.START_TYPE||(t.from_device=this.client.getDeviceId()),e===s.REQUEST_TYPE?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:s.REQUEST_TYPE,to:this.userId,from_device:t.from_device,methods:t.methods}:t[l]={rel_type:c,event_id:this.transactionId},t}send(e,t){const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n=e;e===s.REQUEST_TYPE&&(n=a);const r=await this.client.sendEvent(this.roomId,n,t);e===s.REQUEST_TYPE&&(this.requestEventId=r.event_id)}}t.InRoomChannel=u,t.InRoomRequests=class{constructor(){(0,i.default)(this,"requestsByRoomId",new Map)}getRequest(e){const t=e.getRoomId(),n=u.getTransactionId(e);return this.getRequestByTxnId(t,n)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const n=this.requestsByRoomId.get(e);if(n)return n.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),u.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,n){let r=this.requestsByRoomId.get(e);r||(r=new Map,this.requestsByRoomId.set(e,r)),r.set(t,n)}removeRequest(e){const t=e.getRoomId(),n=this.requestsByRoomId.get(t);n&&(n.delete(u.getTransactionId(e)),0===n.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this.requestsByRoomId.get(e);if(t)for(const e of t.values())if(e.pending)return e}}},2999:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceRequests=t.ToDeviceChannel=void 0;var i=r(n(3693)),s=n(3759),o=n(9849),a=n(5673),c=n(6845),l=n(224);class u{constructor(e,t,n,r=null,s=null){this.client=e,this.userId=t,this.devices=n,this.transactionId=r,this.deviceId=s,(0,i.default)(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===a.REQUEST_TYPE||e===a.START_TYPE}canCreateRequest(e){return u.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return o.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;const n=e.getContent();if(!n)return o.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!n.transaction_id)return o.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const r=e.getType();if(r===a.REQUEST_TYPE){if(!Number.isFinite(n.timestamp))return o.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&n.from_device==t.getDeviceId())return o.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return a.VerificationRequest.validateEvent(r,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,n=!1){const r=e.getType(),i=e.getContent();if(r===a.REQUEST_TYPE||r===a.READY_TYPE||r===a.START_TYPE){this.transactionId||(this.transactionId=i.transaction_id);const e=i.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){const t=this.completeContent(a.CANCEL_TYPE,(0,c.errorFromEvent)((0,c.newUnexpectedMessageError)()));return this.sendToDevices(a.CANCEL_TYPE,t,[e])}}const s=t.phase===a.PHASE_STARTED||t.phase===a.PHASE_READY;await t.handleEvent(e.getType(),e,n,!1,!1);const o=t.phase===a.PHASE_STARTED||t.phase===a.PHASE_READY;if((r===a.START_TYPE||r===a.READY_TYPE)&&!s&&o&&this.deviceId){const e=this.devices.filter((e=>e!==this.deviceId&&e!==this.client.getDeviceId()));if(e.length){const t=this.completeContent(a.CANCEL_TYPE,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(a.CANCEL_TYPE,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==a.REQUEST_TYPE&&e!==a.READY_TYPE&&e!==a.START_TYPE||(t.from_device=this.client.getDeviceId()),e===a.REQUEST_TYPE&&(t.timestamp=Date.now()),t}send(e,t={}){e!==a.REQUEST_TYPE&&e!==a.START_TYPE||this.transactionId||(this.transactionId=u.makeTransactionId());const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n;n=e===a.REQUEST_TYPE||e===a.CANCEL_TYPE&&!this.deviceId?await this.sendToDevices(e,t,this.devices):await this.sendToDevices(e,t,[this.deviceId]);const r=new l.MatrixEvent({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,r,!0,!0,!0),n}async sendToDevices(e,t,n){if(n.length){const r={};for(const e of n)r[e]=t;await this.client.sendToDevice(e,{[this.userId]:r})}}static makeTransactionId(){return(0,s.randomString)(32)}}t.ToDeviceChannel=u,t.ToDeviceRequests=class{constructor(){(0,i.default)(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),u.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const n=this.requestsByUserId.get(e);if(n)return n.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),u.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,n){let r=this.requestsByUserId.get(e);r||(r=new Map,this.requestsByUserId.set(e,r)),r.set(t,n)}removeRequest(e){const t=e.getSender(),n=this.requestsByUserId.get(t);n&&(n.delete(u.getTransactionId(e)),0===n.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const n=this.requestsByUserId.get(e);if(n)for(const e of n.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter((e=>e.pending)):[]}}},5673:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationRequestEvent=t.VerificationRequest=t.START_TYPE=t.REQUEST_TYPE=t.READY_TYPE=t.Phase=t.PHASE_UNSENT=t.PHASE_STARTED=t.PHASE_REQUESTED=t.PHASE_READY=t.PHASE_DONE=t.PHASE_CANCELLED=t.EVENT_PREFIX=t.DONE_TYPE=t.CANCEL_TYPE=void 0;var i=r(n(3693)),s=n(9849),o=n(6845),a=n(8825),c=n(7022);const l="m.key.verification.";t.EVENT_PREFIX=l;const u=l+"request";t.REQUEST_TYPE=u;const d=l+"start";t.START_TYPE=d;const h=l+"cancel";t.CANCEL_TYPE=h;const p=l+"done";t.DONE_TYPE=p;const g=l+"ready";let f;t.READY_TYPE=g,t.Phase=f,function(e){e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done"}(f||(t.Phase=f={}));const m=f.Unsent;t.PHASE_UNSENT=m;const v=f.Requested;t.PHASE_REQUESTED=v;const y=f.Ready;t.PHASE_READY=y;const _=f.Started;t.PHASE_STARTED=_;const b=f.Cancelled;t.PHASE_CANCELLED=b;const E=f.Done;let A;t.PHASE_DONE=E,t.VerificationRequestEvent=A,function(e){e.Change="change"}(A||(t.VerificationRequestEvent=A={}));class S extends c.TypedEventEmitter{constructor(e,t,n){super(),this.channel=e,this.verificationMethods=t,this.client=n,(0,i.default)(this,"eventsByUs",new Map),(0,i.default)(this,"eventsByThem",new Map),(0,i.default)(this,"_observeOnly",!1),(0,i.default)(this,"timeoutTimer",null),(0,i.default)(this,"_accepting",!1),(0,i.default)(this,"_declining",!1),(0,i.default)(this,"verifierHasFinished",!1),(0,i.default)(this,"_cancelled",!1),(0,i.default)(this,"_chosenMethod",null),(0,i.default)(this,"_qrCodeData",null),(0,i.default)(this,"requestReceivedAt",null),(0,i.default)(this,"commonMethods",[]),(0,i.default)(this,"_phase",void 0),(0,i.default)(this,"_cancellingUserId",void 0),(0,i.default)(this,"_verifier",void 0),(0,i.default)(this,"cancelOnTimeout",(async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){s.logger.error("Error while cancelling verification request",e)}})),this.channel.request=this,this.setPhase(m,!1)}static validateEvent(e,t,n){const r=t.getContent();return!(!e||!e.startsWith(l))&&(r?e!==u&&e!==g||Array.isArray(r.methods)?e!==u&&e!==g&&e!==d||"string"==typeof r.from_device&&0!==r.from_device.length||(s.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(s.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(s.logger.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===m}get requested(){return this.phase===v}get cancelled(){return this.phase===b}get ready(){return this.phase===y}get started(){return this.phase===_}get done(){return this.phase===E}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=v){const e=this.requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(u);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(u)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<y&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==E&&this._phase!==b}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const n=this.eventsByThem.get(u)||this.eventsByThem.get(g);if(!n){if(this.started&&this.initiatedByMe){const t=this.eventsByUs.get(d),n=t&&t.getContent();return e==(n&&n.method)}return!1}const r=n.getContent();if(!r)return!1;const{methods:i}=r;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===m&&e)return!0;const t=this.eventsByUs.has(u),n=this.eventsByThem.has(u);if(t&&!n)return!0;if(!t&&n)return!1;const r=this.eventsByUs.has(d),i=this.eventsByThem.has(d);return!(!r||i)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get(h),t=this.eventsByThem.get(h);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this.getEventByEither(h);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=(this.eventsByThem.get(u)||this.eventsByThem.get(g)||this.eventsByThem.get(d)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier&&(this.phase===v||this.phase===y||this.phase===m&&this.channel.canCreateRequest(d))){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw(0,o.newUnknownMethodError)();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw(0,o.newUnknownMethodError)();this._chosenMethod=e}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===m){const e=[...this.verificationMethods.keys()];await this.channel.send(u,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==b){if(this._declining=!0,this.emit(A.Change),this._verifier)return this._verifier.cancel((0,o.errorFactory)(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(h,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===v&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(A.Change),await this.channel.send(g,{methods:e})}}waitFor(e){return new Promise(((t,n)=>{const r=()=>{let i=!1;return e(this)?(t(this),i=!0):this.cancelled&&(n(new Error("cancelled")),i=!0),i&&this.off(A.Change,r),i};r()||this.on(A.Change,r)}))}setPhase(e,t=!0){this._phase=e,t&&this.emit(A.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e,t=!1){return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:m}],t=()=>e[e.length-1].phase,n=this.eventsByThem.has(u),r=this.getEventBy(u,n);r&&e.push({phase:v,event:r});const i=r&&this.getEventBy(g,!n);let s;if(i&&t()===v&&e.push({phase:y,event:i}),i||!r){const e=this.eventsByThem.get(d),t=this.eventsByUs.get(d);s=e&&t?e.getSender()<t.getSender()?e:t:e||t}else s=this.getEventBy(d,!n);if(s){const n=t()===v&&r.getSender()!==s.getSender(),i=t()===m&&this.channel.canCreateRequest(d);(n||t()===y||i)&&e.push({phase:_,event:s})}const o=this.eventsByUs.get(p);(this.verifierHasFinished||o&&t()===_)&&e.push({phase:E});const a=this.getEventByEither(h);return(this._cancelled||a)&&t()!==E?(e.push({phase:b,event:a}),e):e}transitionToPhase(e){const{phase:t,event:n}=e;if((t===v||t===y)&&!this.wasSentByOwnDevice(n)){const e=n.getContent();this.commonMethods=e.methods.filter((e=>this.verificationMethods.has(e)))}if(this.observeOnly||t!==v&&t!==_&&t!==y||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(n)&&!this.wasSentByOwnDevice(n)&&(this._observeOnly=!0),t===_){const{method:e}=n.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,n),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${e}`}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex((e=>e.phase===this.phase)),n=e.slice(t+1);for(const e of n)this.transitionToPhase(e);return n}isWinningStartRace(e){if(e.getType()!==d)return!1;const t=this._verifier.startEvent;let n,r;if(this.isSelfVerification)if(t){const e=t.getContent();n=e&&e.from_device}else n=this.client.getDeviceId();else n=t?t.getSender():this.client.getUserId();if(this.isSelfVerification){const t=e.getContent();r=t&&t.from_device}else r=e.getSender();return r<n}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,n,r,i){if(this.done||this.cancelled)return;const o=this._observeOnly;if(this.adjustObserveOnly(t,n),!this.observeOnly&&!r&&await this.cancelOnError(e,t))return;if(i?this.eventsByUs.has(e):this.eventsByThem.has(e))return;const c=this.phase;this.addEvent(e,t,i);const l=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const n=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&n)this._verifier.switchStartEvent(t);else if(!r){var u;(e===h||null!==(u=this._verifier.events)&&void 0!==u&&u.includes(e))&&this._verifier.handleEvent(t)}}if(l.length){n&&l.some((e=>e.phase===y))&&this.otherPartySupportsMethod(a.SCAN_QR_CODE_METHOD,!0)&&(this._qrCodeData=await a.QRCodeData.create(this,this.client));const e=l[l.length-1],{phase:t}=e;this.setupTimeout(t),this.setPhase(t)}else this._observeOnly!==o&&this.emit(A.Change)}finally{s.logger.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${i}, isLiveEvent:${n}, isRemoteEcho:${r}, phase:${c}=>${this.phase}, observeOnly:${o}=>${this._observeOnly}`)}}setupTimeout(e){!this.timeoutTimer&&!this.observeOnly&&e===v&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer&&(e===_||e===y||e===E||e===b)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}async cancelOnError(e,t){if(e===d){const e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel((0,o.errorFromEvent)((0,o.newUnknownMethodError)())),!0}const n=e===u&&this.phase!==m,r=e===g&&this.phase!==v&&this.phase!==_;if(this.phase!==m&&(n||r)){s.logger.warn(`Cancelling, unexpected ${e} verification event from ${t.getSender()}`);const n=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel((0,o.errorFromEvent)((0,o.newUnexpectedMessageError)({reason:n}))),!0}return!1}adjustObserveOnly(e,t=!1){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}addEvent(e,t,n=!1){if(n?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===u){for(const[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e,t=null,n=null){n||(n=this.targetDevice);const{userId:r,deviceId:i}=n,o=this.verificationMethods.get(e);if(o)return new o(this.channel,this.client,r,i,t,this);s.logger.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return e.getSender()===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}t.VerificationRequest=S},2382:(e,t)=>{"use strict";function n(e,t){const n=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,r=Reflect.construct(Error,[n]);return Reflect.setPrototypeOf(r,Reflect.getPrototypeOf(this)),r.reason=e,r.value=t,r}function r(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.name="InvalidCryptoStoreError",n}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidCryptoStoreError=r,t.InvalidStoreError=n,t.KeySignatureUploadError=void 0,n.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",n.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(n,Error),r.TOO_NEW="TOO_NEW",r.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(r,Error);class i extends Error{constructor(e,t){super(e),this.value=t}}t.KeySignatureUploadError=i},6387:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.eventMapperFor=function(e,t){let n=Boolean(t.preventReEmit);const r=!1!==t.decrypt;return function(i){t.toDevice&&delete i.room_id;const o=e.getRoom(i.room_id);let c;o&&void 0===i.state_key&&(c=o.findEventById(i.event_id)),!c||c.status?c=new s.MatrixEvent(i):(c.setUnsigned(a(a({},c.getUnsigned()),i.unsigned)),n=!0);const l=null==o?void 0:o.findThreadForEvent(c);return l&&c.setThread(l),c.isEncrypted()&&(n||e.reEmitter.reEmit(c,[s.MatrixEventEvent.Decrypted]),r&&e.decryptEventIfNeeded(c)),n||(e.reEmitter.reEmit(c,[s.MatrixEventEvent.Replaced,s.MatrixEventEvent.VisibilityChange]),null==o||o.reEmitter.reEmit(c,[s.MatrixEventEvent.BeforeRedaction])),c}};var i=r(n(3693)),s=n(224);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}},193:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilterComponent=void 0;var r=n(990);t.FilterComponent=class{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n;const i=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},s=Object.keys(i),o=[];return this.userId&&null!=i&&null!==(n=i[r.THREAD_RELATION_TYPE.name])&&void 0!==n&&n.current_user_participated&&o.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,s,o)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[r.FILTER_RELATED_BY_SENDERS.name]:this.filterJson[r.FILTER_RELATED_BY_SENDERS.name]||[],[r.FILTER_RELATED_BY_REL_TYPES.name]:this.filterJson[r.FILTER_RELATED_BY_REL_TYPES.name]||[]}}checkFields(e,t,n,i,s,o){const a={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const n=t.slice(0,-1);return e.slice(0,n.length)===n}return e===t}(n,e)}};for(let e=0;e<Object.keys(a).length;e++){const t=Object.keys(a)[e],n=a[t],r="not_"+t,i=this.filterJson[r];if(null!=i&&i.some(n))return!1;const s=this.filterJson[t];if(s&&!s.some(n))return!1}const c=this.filterJson.contains_url;if(void 0!==c&&c!==i)return!1;const l=this.filterJson[r.FILTER_RELATED_BY_REL_TYPES.name];if(void 0!==l&&!this.arrayMatchesFilter(l,s))return!1;const u=this.filterJson[r.FILTER_RELATED_BY_SENDERS.name];return!(void 0!==u&&!this.arrayMatchesFilter(u,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every((e=>t.includes(e)))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}},2763:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=void 0;var i=r(n(3693)),s=n(193);function o(e,t,n){const r=t.split(".");let i=e;for(let e=0;e<r.length-1;e++)i[r[e]]||(i[r[e]]={}),i=i[r[e]];i[r[r.length-1]]=n}class a{static fromJson(e,t,n){const r=new a(e,t);return r.setDefinition(n),r}constructor(e,t){this.userId=e,this.filterId=t,(0,i.default)(this,"definition",{}),(0,i.default)(this,"roomFilter",void 0),(0,i.default)(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new s.FilterComponent(n,this.userId),this.roomTimelineFilter=new s.FilterComponent((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomTimelineFilter.filter(this.roomFilter.filter(e))}setTimelineLimit(e){o(this.definition,"room.timeline.limit",e)}setLazyLoadMembers(e){o(this.definition,"room.state.lazy_load_members",!!e)}setIncludeLeaveRooms(e){o(this.definition,"room.include_leave",e)}}t.Filter=a,(0,i.default)(a,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},84:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.PREFIX_V3=t.PREFIX_V1=t.PREFIX_UNSTABLE=t.PREFIX_R0=t.PREFIX_MEDIA_R0=t.PREFIX_IDENTITY_V2=t.PREFIX_IDENTITY_V1=t.Method=t.MatrixHttpApi=t.MatrixError=t.HttpApiEvent=t.ConnectionError=t.AbortError=void 0,t.retryNetworkOperation=async function(e,t){let n=0,r=null;for(;n<e;)try{if(n>0){const e=1e3*Math.pow(2,n);c.logger.log(`network operation failed ${n} times, retrying in ${e}ms...`),await(0,a.sleep)(e)}return t()}catch(e){if(!(e instanceof y))throw e;n+=1,r=e}throw r};var i=r(n(3693)),s=n(8597),o=u(n(2485)),a=u(n(4148)),c=n(9849);function l(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(l=function(e){return e?n:t})(e)}function u(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=l(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let p,g;function f(e){return e.status||e.statusCode}function m(e,t,n=!1,r){return function(i,o,a){i&&("AbortError"===i.name||"aborted"===i||i instanceof v||(i=new y("request failed",i)));let c=a;if(!i)try{f(o)>=400?i=function(e,t){const n=f(e),r=function(e){let t;if(e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null),!t)return null;try{return(0,s.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e);let i;if(r)if("application/json"===r.type){const e="object"==typeof t?t:JSON.parse(t);i=new v(e)}else"text/plain"===r.type&&(i=new Error(`Server returned ${n} error: ${t}`));return i||(i=new Error(`Server returned ${n} error`)),i.httpStatus=n,i}(o,a):r&&(c=r(a))}catch(e){i=new Error(`Error parsing server response: ${e}`)}if(i)e.reject(i),null==t||t(i);else if(n)e.resolve(c),null==t||t(null,c);else{const n={code:f(o),headers:o.headers,data:c};e.resolve(n),null==t||t(null,n)}}}t.PREFIX_R0="/_matrix/client/r0",t.PREFIX_V1="/_matrix/client/v1",t.PREFIX_V3="/_matrix/client/v3",t.PREFIX_UNSTABLE="/_matrix/client/unstable",t.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1",t.PREFIX_IDENTITY_V2="/_matrix/identity/v2",t.PREFIX_MEDIA_R0="/_matrix/media/r0",t.Method=p,function(e){e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE"}(p||(t.Method=p={})),t.HttpApiEvent=g,function(e){e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent"}(g||(t.HttpApiEvent=g={})),t.MatrixHttpApi=class{constructor(e,t){this.eventEmitter=e,this.opts=t,(0,i.default)(this,"uploads",[]),a.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=!!t.useAuthorizationHeader}setIdBaseUrl(e){this.opts.idBaseUrl=e}getContentUri(){return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:{access_token:this.opts.accessToken}}}uploadContent(e,t){a.isFunction(t)?t={callback:t}:t||(t={});const r=!1!==t.includeFilename,i=t.type||e.type||"application/octet-stream",s=t.name||e.name;let l=e;const u=l.stream;u&&"function"!=typeof u&&(c.logger.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=u);let d=t.rawResponse;void 0===d&&(n.g.XMLHttpRequest?d=!1:(c.logger.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),d=!0));let h=t.onlyContentUri;d||void 0!==h||(n.g.XMLHttpRequest?(c.logger.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),h=!0):h=!1);const g={loaded:0,total:0};let f,v;if(d||(v=function(e){let t=JSON.parse(e);if(h&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),n.g.XMLHttpRequest){const e=a.defer(),c=new n.g.XMLHttpRequest,u=m(e,t.callback,this.opts.onlyData),d=function(){c.abort(),u(new Error("Timeout"))};let h=o.setTimeout(d,3e4);c.onreadystatechange=function(){let e;if(c.readyState===n.g.XMLHttpRequest.DONE){o.clearTimeout(h);try{if(0===c.status)throw new _;if(!c.responseText)throw new Error("No response body.");e=c.responseText,v&&(e=v(e))}catch(e){return e.httpStatus=c.status,void u(e)}u(void 0,c,e)}},c.upload.addEventListener("progress",(function(e){o.clearTimeout(h),g.loaded=e.loaded,g.total=e.total,h=o.setTimeout(d,3e4),t.progressHandler&&t.progressHandler({loaded:e.loaded,total:e.total})}));let p=this.opts.baseUrl+"/_matrix/media/r0/upload";const y=[];r&&s&&y.push("filename="+encodeURIComponent(s)),this.opts.useAuthorizationHeader||y.push("access_token="+encodeURIComponent(this.opts.accessToken)),y.length>0&&(p+="?"+y.join("&")),c.open("POST",p),this.opts.useAuthorizationHeader&&c.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),c.setRequestHeader("Content-Type",i),c.send(l),f=e.promise,f.abort=c.abort.bind(c)}else{const e={};r&&s&&(e.filename=s);const n={"Content-Type":i};0===l.length&&(n["Content-Length"]="0"),f=this.authedRequest(t.callback,p.Post,"/upload",e,l,{prefix:"/_matrix/media/r0",headers:n,json:!1,bodyParser:v})}return g.promise=f.finally((()=>{for(let e=0;e<this.uploads.length;++e)if(this.uploads[e]===g)return void this.uploads.splice(e,1)})),g.promise.abort=f.abort,this.uploads.push(g),g.promise}cancelUpload(e){return!!e.abort&&(e.abort(),!0)}getCurrentUploads(){return this.uploads}idServerRequest(e,t,n,r,i,s){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");const o=this.opts.idBaseUrl+i+n;if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:o,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};t===p.Get?c.qs=r:"object"==typeof r&&(c.json=r),s&&(c.headers.Authorization=`Bearer ${s}`);const l=a.defer();return this.opts.request(c,m(l,e,this.opts.onlyData)),l.promise}authedRequest(e,t,n,r,i,s){r||(r={});let o=s||{};this.opts.useAuthorizationHeader?(isFinite(s)&&(o={localTimeoutMs:s}),o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),r.access_token&&delete r.access_token):r.access_token||(r.access_token=this.opts.accessToken);const a=this.request(e,t,n,r,i,o);return a.catch((e=>{var t;"M_UNKNOWN_TOKEN"!=e.errcode||null!==(t=o)&&void 0!==t&&t.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==e.errcode&&this.eventEmitter.emit(g.NoConsent,e.message,e.data.consent_uri):this.eventEmitter.emit(g.SessionLoggedOut,e)})),a}request(e,t,n,r,i,s){var o,a;const c=null!==(o=null==s?void 0:s.prefix)&&void 0!==o?o:this.opts.prefix,l=(null!==(a=null==s?void 0:s.baseUrl)&&void 0!==a?a:this.opts.baseUrl)+c+n;return this.requestOtherUrl(e,t,l,r,i,s)}requestOtherUrl(e,t,n,r,i,s){let o=s||{};return isFinite(s)&&(o={localTimeoutMs:s}),this.doRequest(e,t,n,r,i,o)}getUrl(e,t,n){let r="";return t&&(r="?"+a.encodeParams(t)),this.opts.baseUrl+n+e+r}doRequest(e,t,n,r,i,s){var c;if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);this.opts.extraParams&&(r=h(h({},r||{}),this.opts.extraParams));const l=Object.assign({},s.headers||{});s||(s={});const u=null===(c=s.json)||void 0===c||c;let d=s.bodyParser;u&&(i&&(i=JSON.stringify(i),l["content-type"]="application/json"),l.accept||(l.accept="application/json"),void 0===d&&(d=function(e){return JSON.parse(e)}));const p=a.defer();let g,f,y=!1;const _=s.localTimeoutMs||this.opts.localTimeoutMs,b=()=>{_&&(g&&o.clearTimeout(g),g=o.setTimeout((function(){var e,t;y=!0,null===(e=f)||void 0===e||null===(t=e.abort)||void 0===t||t.call(e),p.reject(new v({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:_}))}),_))};b();const E=p.promise;try{f=this.opts.request({uri:n,method:t,withCredentials:!1,qs:r,qsStringifyOptions:s.qsStringifyOptions,useQuerystring:!0,body:i,json:!1,timeout:_,headers:l||{},_matrix_opts:this.opts},((t,n,r)=>{_&&(o.clearTimeout(g),y)||m(p,e,this.opts.onlyData,d)(t,n,r)})),f&&("onprogress"in f&&(f.onprogress=e=>{b()}),f.abort&&(E.abort=f.abort.bind(f)))}catch(t){p.reject(t),e&&e(t)}return E}};class v extends Error{constructor(e={}){super(`MatrixError: ${e.errcode}`),(0,i.default)(this,"errcode",void 0),(0,i.default)(this,"data",void 0),(0,i.default)(this,"httpStatus",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}t.MatrixError=v;class y extends Error{constructor(e,t=void 0){super(e+(t?`: ${t.message}`:""))}get name(){return"ConnectionError"}}t.ConnectionError=y;class _ extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}t.AbortError=_},7038:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exists=function(e,t){return new Promise(((n,r)=>{let i=!0;const s=e.open(t);s.onupgradeneeded=()=>{i=!1},s.onblocked=()=>r(s.error),s.onsuccess=()=>{s.result.close(),i||e.deleteDatabase(t),n(i)},s.onerror=e=>r(s.error)}))}},8644:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveAuth=t.AuthType=void 0;var i=r(n(3693)),s=n(9849),o=n(4148);const a="m.login.email.identity",c="m.login.msisdn";let l;t.AuthType=l,function(e){e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="m.login.registration_token",e.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token"}(l||(t.AuthType=l={}));class u extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,(0,i.default)(this,"name","NoAuthFlowFoundError")}}t.InteractiveAuth=class{constructor(e){var t;(0,i.default)(this,"matrixClient",void 0),(0,i.default)(this,"inputs",void 0),(0,i.default)(this,"clientSecret",void 0),(0,i.default)(this,"requestCallback",void 0),(0,i.default)(this,"busyChangedCallback",void 0),(0,i.default)(this,"stateUpdatedCallback",void 0),(0,i.default)(this,"requestEmailTokenCallback",void 0),(0,i.default)(this,"data",void 0),(0,i.default)(this,"emailSid",void 0),(0,i.default)(this,"requestingEmailToken",!1),(0,i.default)(this,"attemptAuthDeferred",null),(0,i.default)(this,"chosenFlow",null),(0,i.default)(this,"currentStage",null),(0,i.default)(this,"emailAttempt",1),(0,i.default)(this,"submitPromise",null),(0,i.default)(this,"requestEmailToken",(async()=>{if(this.requestingEmailToken)s.logger.warn("Could not request email token: Already requesting");else{s.logger.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{const e=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=e.sid,s.logger.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=null!==(t=e.emailSid)&&void 0!==t?t:null}attemptAuth(){var e;this.attemptAuthDeferred=(0,o.defer)();const t=this.attemptAuthDeferred.promise;if(null!==(e=this.data)&&void 0!==e&&e.flows)this.startNextAuthStage();else{var n;null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0);const e=this.data.session?{session:this.data.session}:null;this.doRequest(e).finally((()=>{var e;null===(e=this.busyChangedCallback)||void 0===e||e.call(this,!1)}))}return t}async poll(){if(!this.data.session)return;if(!this.attemptAuthDeferred)return;if(this.submitPromise)return;let e={};if(this.currentStage==a&&this.emailSid){const t={sid:this.emailSid,client_secret:this.clientSecret};if(await this.matrixClient.doesServerRequireIdServerParam()){const e=new URL(this.matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:a,threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)}getSessionId(){var e;return null===(e=this.data)||void 0===e?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(e,t=!1){if(!this.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");var n;for(t||null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0);this.submitPromise;)try{await this.submitPromise}catch(e){}let r;this.data.session?(r={session:this.data.session},Object.assign(r,e)):r=e;try{this.submitPromise=this.doRequest(r,t),await this.submitPromise}finally{var i;this.submitPromise=null,t||null===(i=this.busyChangedCallback)||void 0===i||i.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}async doRequest(e,t=!1){try{const n=await this.requestCallback(e,t);this.attemptAuthDeferred.resolve(n),this.attemptAuthDeferred=null}catch(e){var n,r;const o=null!==(n=null===(r=e.data)||void 0===r?void 0:r.flows)&&void 0!==n?n:null,a=this.data.flows||Boolean(o);var i;401===e.httpStatus&&e.data&&a||(t?s.logger.log("Background poll request failed doing UI auth: ignoring",e):null===(i=this.attemptAuthDeferred)||void 0===i||i.reject(e)),e.data||(e.data={}),e.data.flows||e.data.completed||e.data.session||(e.data.flows=this.data.flows,e.data.completed=this.data.completed,e.data.session=this.data.session),this.data=e.data;try{this.startNextAuthStage()}catch(e){return this.attemptAuthDeferred.reject(e),void(this.attemptAuthDeferred=null)}if(!this.emailSid&&this.chosenFlow.stages.includes(l.Email))try{await this.requestEmailToken()}catch(e){this.attemptAuthDeferred.reject(e),this.attemptAuthDeferred=null}}}startNextAuthStage(){var e,t;const n=this.chooseStage();if(!n)throw new Error("No incomplete flows from the server");var r,i;this.currentStage=n,n!==l.Dummy?null!==(e=this.data)&&void 0!==e&&e.errcode||null!==(t=this.data)&&void 0!==t&&t.error?this.stateUpdatedCallback(n,{errcode:(null===(r=this.data)||void 0===r?void 0:r.errcode)||"",error:(null===(i=this.data)||void 0===i?void 0:i.error)||""}):this.stateUpdatedCallback(n,n===a?{emailSid:this.emailSid}:{}):this.submitAuthDict({type:"m.login.dummy"})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),s.logger.log("Active flow => %s",JSON.stringify(this.chosenFlow));const e=this.firstUncompletedStage(this.chosenFlow);return s.logger.log("Next stage: %s",e),e}chooseFlow(){const e=this.data.flows||[],t=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),n=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);for(const r of e){let e=!1,i=!1;for(const t of r.stages)t===a?e=!0:t==c&&(i=!0);if(e==t&&i==n)return r}const r=[];throw t&&r.push(a),n&&r.push(c),new u("No appropriate authentication flow found",r,e)}firstUncompletedStage(e){const t=this.data.completed||[];for(let n=0;n<e.stages.length;++n){const r=e.stages[n];if(-1===t.indexOf(r))return r}}}},9849:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;var i=r(n(3065));const s="matrix";i.default.methodFactory=function(e,t,n){return function(...t){return this.prefix&&t.unshift(this.prefix),"error"===e||"warn"===e||"trace"===e||"info"===e?console[e](...t):console.log(...t)}};const o=i.default.getLogger(s);t.logger=o,o.setLevel(i.default.levels.DEBUG,!1),function e(t){t.withPrefix=function(t){return function(t){const n=i.default.getLogger(`${s}-${t}`);return n.prefix!==t&&(e(n),n.prefix=t,n.setLevel(i.default.levels.DEBUG,!1)),n}((this.prefix||"")+t)}}(o)},2660:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={request:!0,getRequest:!0,wrapRequest:!0,setCryptoStoreFactory:!0,createClient:!0,ContentHelpers:!0,createNewMatrixCall:!0};t.ContentHelpers=void 0,t.createClient=function(e){return"string"==typeof e&&(e={baseUrl:e}),e.request=e.request||L,e.store=e.store||new s.MemoryStore({localStorage:n.g.localStorage}),e.scheduler=e.scheduler||new o.MatrixScheduler,e.cryptoStore=e.cryptoStore||B(),new a.MatrixClient(e)},Object.defineProperty(t,"createNewMatrixCall",{enumerable:!0,get:function(){return x.createNewMatrixCall}}),t.getRequest=function(){return L},t.request=function(e){L=e},t.setCryptoStoreFactory=function(e){B=e},t.wrapRequest=function(e){const t=L;L=function(n,r){return e(t,n,r)}};var i=n(7926);Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var s=n(6124);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var o=n(7703);Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var a=n(642);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=n(84);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=n(3014);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var u=n(4589);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var d=n(2382);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var h=n(1062);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var p=n(224);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var g=n(5489);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var f=n(6418);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var m=n(8931);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var v=n(9948);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var y=n(9589);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var _=n(8057);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var b=n(2763);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var E=n(1215);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var A=n(8644);Object.keys(A).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===A[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return A[e]}}))}));var S=n(2118);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var w=n(3764);Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var I=n(3514);Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var T=n(7777);Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))}));var k=n(4703);Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===k[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))}));var R=n(2496);Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===R[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))}));var O=n(8673);Object.keys(O).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===O[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))}));var C=n(7465);Object.keys(C).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===C[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))}));var P=n(4179);Object.keys(P).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===P[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return P[e]}}))}));var D=n(8764);Object.keys(D).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===D[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return D[e]}}))}));var N=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=M(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(9228));t.ContentHelpers=N;var x=n(9435);function M(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(M=function(e){return e?n:t})(e)}let L,B=()=>new i.MemoryCryptoStore},3073:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.MSC3089Branch=void 0;var i=r(n(3693)),s=n(4703),o=n(6418);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.MSC3089Branch=class{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){const e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,s.UNSTABLE_MSC3089_BRANCH.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,s.UNSTABLE_MSC3089_BRANCH.name,c(c({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,s.UNSTABLE_MSC3089_BRANCH.name,c(c({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){const e=(await this.getFileEvent()).getOriginalContent().file,t=this.client.mxcUrlToHttp(e.url);if(!t)throw new Error(`No HTTP URL available for ${e.url}`);return{info:e,httpUrl:t}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);for(;!t&&e.getLiveTimeline().getState(o.EventTimeline.BACKWARDS).paginationToken;)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t,{emit:!0,isRetry:!0}),t}async createNewVersion(e,t,n,r){const i=await this.directory.createFile(e,t,n,c(c({},null!=r?r:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:s.RelationType.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,s.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:e,version:this.version+1},i.event_id),await this.client.sendStateEvent(this.roomId,s.UNSTABLE_MSC3089_BRANCH.name,c(c({},this.indexEvent.getContent()),{},{active:!1}),this.id),i}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const n=[...t.getLiveTimeline().getEvents()].reverse();let r,i=await this.getFileEvent();do{if(r=n.find((e=>e.replacingEventId()===i.getId())),r){const t=this.directory.getFile(r.getId());if(!t)break;e.push(t),i=r}}while(r);return e}}},3211:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.TreePermissions=t.MSC3089TreeSpace=t.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=void 0;var i=r(n(3693)),s=r(n(4116)),o=n(4703),a=n(9849),c=n(4148),l=n(3073),u=n(8259);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const p={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[o.EventType.RoomPowerLevels]:100,[o.EventType.RoomHistoryVisibility]:100,[o.EventType.RoomTombstone]:100,[o.EventType.RoomEncryption]:100,[o.EventType.RoomName]:50,[o.EventType.RoomMessage]:50,[o.EventType.RoomMessageEncrypted]:50,[o.EventType.Sticker]:50},users:{}};let g;t.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=p,t.TreePermissions=g,function(e){e.Viewer="viewer",e.Editor="editor",e.Owner="owner"}(g||(t.TreePermissions=g={})),t.MSC3089TreeSpace=class{constructor(e,t){if(this.client=e,this.roomId=t,(0,i.default)(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(o.EventType.SpaceParent);return null==e||!e.length||e.every((e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)}))}async setName(e){await this.client.sendStateEvent(this.roomId,o.EventType.RoomName,{name:e},"")}async invite(e,t=!0,n=!0){const r=[this.retryInvite(e)];return t&&r.push(...this.getDirectories().map((r=>r.invite(e,t,n)))),Promise.all(r).then((()=>{n&&(0,u.isRoomSharedHistory)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])}))}retryInvite(e){return(0,c.simpleRetryOperation)((async()=>{await this.client.invite(this.roomId,e).catch((e=>{if("M_FORBIDDEN"===(null==e?void 0:e.errcode))throw new s.default.AbortError(e);throw e}))}))}async setPermissions(e,t){var n;const r=this.room.currentState.getStateEvents(o.EventType.RoomPowerLevels,"");if(Array.isArray(r))throw new Error("Unexpected return type for power levels");const i=r.getContent()||{},s=i.users_default||0,a=i.events_default||50,c=(null===(n=i.events)||void 0===n?void 0:n[o.EventType.RoomPowerLevels])||100,l=i.users||{};switch(t){case g.Viewer:l[e]=s;break;case g.Editor:l[e]=a;break;case g.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}i.users=l,await this.client.sendStateEvent(this.roomId,o.EventType.RoomPowerLevels,i,"")}getPermissions(e){var t,n;const r=this.room.currentState.getStateEvents(o.EventType.RoomPowerLevels,"");if(Array.isArray(r))throw new Error("Unexpected return type for power levels");const i=r.getContent()||{},s=i.users_default||0,a=i.events_default||50,c=(null===(t=i.events)||void 0===t?void 0:t[o.EventType.RoomPowerLevels])||100,l=(null===(n=i.users)||void 0===n?void 0:n[e])||s;return l>=c?g.Owner:l>=a?g.Editor:g.Viewer}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,o.EventType.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,o.EventType.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(o.EventType.SpaceChild);for(const n of t)try{const t=n.getStateKey();if(t){const n=this.client.unstableGetFileTreeSpace(t);n&&e.push(n)}}catch(e){a.logger.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find((t=>t.roomId===e))}async delete(){const e=this.getDirectories();for(const t of e)await t.delete();const t=["invite","knock","join"],n=this.room.currentState.getStateEvents(o.EventType.RoomMember);for(const e of n)if(e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)){const t=e.getStateKey();if(!t)throw new Error("State key not found for branch");await this.client.kick(this.roomId,t,"Room deleted")}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map((e=>({roomId:e.getStateKey(),order:e.getContent().order}))).filter((e=>e.roomId));return t.sort(((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return(0,c.lexicographicCompare)(e.order,t.order);{var n,r,i,s;const a=this.client.getRoom(e.roomId),l=this.client.getRoom(t.roomId);if(!a||!l)return(0,c.lexicographicCompare)(e.roomId,t.roomId);const u=null!==(n=null===(r=a.currentState.getStateEvents(o.EventType.RoomCreate,""))||void 0===r?void 0:r.getTs())&&void 0!==n?n:0,d=null!==(i=null===(s=l.currentState.getStateEvents(o.EventType.RoomCreate,""))||void 0===s?void 0:s.getTs())&&void 0!==i?i:0;return u===d?(0,c.lexicographicCompare)(e.roomId,t.roomId):u-d}})),t}getParentRoom(){const e=this.room.currentState.getStateEvents(o.EventType.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=e.getStateKey();if(!t)throw new Error("No state key found for parent");const n=this.client.getRoom(t);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(o.EventType.SpaceChild);return this.getOrderedChildren(e).findIndex((e=>e.roomId===this.roomId))}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const n=this.getParentRoom(),r=n.currentState.getStateEvents(o.EventType.SpaceChild),i=this.getOrderedChildren(r);e=Math.max(Math.min(e,i.length-1),0);const s=this.getOrder()<e;s&&e===i.length-1?e--:s||0!==e||e++;const a=i[s?e:e-1],l=i[s?e+1:e];let u=c.DEFAULT_ALPHABET[0],d=!1;if(a)if(e===i.length-1)null!=l&&l.order&&(u=(0,c.nextString)(l.order));else{const e=null==a?void 0:a.order,t=null==l?void 0:l.order;e&&t?u=e===t?(0,c.nextString)(e):(0,c.averageBetweenStrings)(e,t):e?u=(0,c.nextString)(e):t?u=(0,c.prevString)(t):d=!0}else null!=l&&l.order&&(u=(0,c.prevString)(l.order));if(d){let t;for(let r=0;r<=e;r++){const e=i[r];if(0===r&&(t=e.order),e.order)t=e.order;else{var p;t=t?(0,c.nextString)(t):c.DEFAULT_ALPHABET[0];const r=n.currentState.getStateEvents(o.EventType.SpaceChild,e.roomId),i=null!==(p=null==r?void 0:r.getContent())&&void 0!==p?p:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,o.EventType.SpaceChild,h(h({},i),{},{order:t}),e.roomId)}}t&&(u=(0,c.nextString)(t))}const g=n.currentState.getStateEvents(o.EventType.SpaceChild,this.roomId),f=null!==(t=null==g?void 0:g.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,o.EventType.SpaceChild,h(h({},f),{},{order:u}),this.roomId)}async createFile(e,t,n,r){var i;const s=await this.client.uploadContent(t,{includeFilename:!1,onlyContentUri:!0,rawResponse:!1});n.url=s;const a={msgtype:o.MsgType.File,body:e,url:s,file:n};(r=null!==(i=r)&&void 0!==i?i:{})["m.new_content"]&&(r["m.new_content"]=a);const c=await this.client.sendMessage(this.roomId,h(h(h({},r),a),{},{[o.UNSTABLE_MSC3089_LEAF.name]:{}}));return await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:e},c.event_id),c}getFile(e){const t=this.room.currentState.getStateEvents(o.UNSTABLE_MSC3089_BRANCH.name,e);return t?new l.MSC3089Branch(this.client,t,this):null}listFiles(){return this.listAllFiles().filter((e=>e.isActive))}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(o.UNSTABLE_MSC3089_BRANCH.name))&&void 0!==e?e:[]).map((e=>new l.MSC3089Branch(this.client,e,this)))}}},1062:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.isTimestampInDuration=t.getBeaconInfoIdentifier=t.BeaconEvent=t.Beacon=void 0;var i=r(n(3693)),s=n(9228),o=n(4148),a=n(7022);let c;t.BeaconEvent=c,function(e){e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate"}(c||(t.BeaconEvent=c={}));const l=(e,t,n)=>n>=e&&e+t>=n;t.isTimestampInDuration=l;const u=e=>`${e.getRoomId()}_${e.getStateKey()}`;t.getBeaconInfoIdentifier=u;class d extends a.TypedEventEmitter{constructor(e){super(),this.rootEvent=e,(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"_beaconInfo",void 0),(0,i.default)(this,"_isLive",void 0),(0,i.default)(this,"livenessWatchTimeout",void 0),(0,i.default)(this,"_latestLocationEvent",void 0),(0,i.default)(this,"clearLatestLocation",(()=>{this._latestLocationEvent=void 0,this.emit(c.LocationUpdate,this.latestLocationState)})),this.setBeaconInfo(this.rootEvent),this.roomId=this.rootEvent.getRoomId()}get isLive(){return this._isLive}get identifier(){return u(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,s.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(u(e)!==this.identifier)throw new Error("Invalid updating event");e.event.origin_server_ts<this.rootEvent.event.origin_server_ts||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(c.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(c.Destroy,this.identifier)}monitorLiveness(){var e;if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.isLive){var t,n;const e=(null===(t=this._beaconInfo)||void 0===t?void 0:t.timestamp)+(null===(n=this._beaconInfo)||void 0===n?void 0:n.timeout)-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),e))}else if((null===(e=this._beaconInfo)||void 0===e?void 0:e.timestamp)>Date.now()){var r;this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),(null===(r=this.beaconInfo)||void 0===r?void 0:r.timestamp)-Date.now())}}addLocations(e){var t;if(!this.isLive)return;const n=null===(t=e.filter((e=>{const t=e.getContent(),n=(0,s.parseBeaconContent)(t);if(!n.uri||!n.timestamp)return!1;const{timestamp:r}=n;return l(this._beaconInfo.timestamp,this._beaconInfo.timeout,r)&&(!this.latestLocationState||r>this.latestLocationState.timestamp)})).sort(o.sortEventsByLatestContentTimestamp))||void 0===t?void 0:t[0];n&&(this._latestLocationEvent=n,this.emit(c.LocationUpdate,this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=(0,s.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){var e,t,n,r,i;const s=this.isLive,o=(null===(e=this._beaconInfo)||void 0===e?void 0:e.timestamp)>Date.now()?(null===(t=this._beaconInfo)||void 0===t?void 0:t.timestamp)-36e4:null===(n=this._beaconInfo)||void 0===n?void 0:n.timestamp;this._isLive=!(null===(r=this._beaconInfo)||void 0===r||!r.live)&&l(o,null===(i=this._beaconInfo)||void 0===i?void 0:i.timeout,Date.now()),s!==this.isLive&&this.emit(c.LivenessChange,this.isLive,this)}}t.Beacon=d},7790:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.EventContext=void 0;var i=r(n(3693)),s=n(6418);t.EventContext=class{constructor(e){this.ourEvent=e,(0,i.default)(this,"timeline",void 0),(0,i.default)(this,"ourEventIndex",0),(0,i.default)(this,"paginateTokens",{[s.Direction.Backward]:null,[s.Direction.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(e=!1){return this.paginateTokens[e?s.Direction.Backward:s.Direction.Forward]}setPaginateToken(e,t=!1){this.paginateTokens[t?s.Direction.Backward:s.Direction.Forward]=e}addEvents(e,t=!1){t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}},779:(e,t)=>{"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.EventStatus=void 0,t.EventStatus=n,function(e){e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled"}(n||(t.EventStatus=n={}))},8931:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimelineSet=t.DuplicateStrategy=void 0;var i=r(n(3693)),s=n(6418),o=n(9849),a=n(5489),c=n(7022),l=n(7903);let u,d;u=o.logger.log.bind(o.logger),t.DuplicateStrategy=d,function(e){e.Ignore="ignore",e.Replace="replace"}(d||(t.DuplicateStrategy=d={}));class h extends c.TypedEventEmitter{constructor(e,t={},n,r){var o,a,c;super(),this.room=e,this.thread=r,(0,i.default)(this,"relations",void 0),(0,i.default)(this,"timelineSupport",void 0),(0,i.default)(this,"displayPendingEvents",void 0),(0,i.default)(this,"liveTimeline",void 0),(0,i.default)(this,"timelines",void 0),(0,i.default)(this,"_eventIdToTimeline",new Map),(0,i.default)(this,"filter",void 0),this.timelineSupport=Boolean(t.timelineSupport),this.liveTimeline=new s.EventTimeline(this),this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=t.filter,this.relations=null!==(o=null===(a=this.room)||void 0===a?void 0:a.relations)&&void 0!==o?o:new l.RelationsContainer(null!==(c=null==e?void 0:e.client)&&void 0!==c?c:n)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){const n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){const n=!this.timelineSupport||!t,r=this.liveTimeline,i=n?r.forkLive(s.EventTimeline.FORWARDS):r.fork(s.EventTimeline.FORWARDS);n?(this.timelines=[i],this._eventIdToTimeline=new Map):this.timelines.push(i),t&&r.setPaginationToken(t,s.EventTimeline.FORWARDS),i.setPaginationToken(e,s.EventTimeline.BACKWARDS),this.liveTimeline=i,this.emit(a.RoomEvent.TimelineReset,this.room,this,n)}getTimelineForEvent(e){if(null===e)return null;const t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new s.EventTimeline(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,r){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(e=this.filter.filterRoomTimeline(e)).length)return;const i=t?s.EventTimeline.BACKWARDS:s.EventTimeline.FORWARDS,a=t?s.EventTimeline.FORWARDS:s.EventTimeline.BACKWARDS;let c=!1,l=!1;for(let r=0;r<e.length;r++){const d=e[r],h=d.getId(),p=this._eventIdToTimeline.get(h);if(!p){this.addEventToTimeline(d,n,{toStartOfTimeline:t}),l=!0,c=!0;continue}if(l=!1,p==n){u("Event "+h+" already in timeline "+n);continue}const g=n.getNeighbouringTimeline(i);if(g){u(p==g?"Event "+h+" in neighbouring timeline - switching to "+p:"Event "+h+" already in a different timeline "+p),n=p;continue}o.logger.info("Already have timeline for "+h+" - joining timeline "+n+" to "+p);const f=p===this.liveTimeline,m=n===this.liveTimeline,v=i===s.EventTimeline.BACKWARDS&&f,y=i===s.EventTimeline.FORWARDS&&m;v||y?(v&&o.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+p+")"),y&&o.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")")):(n.setNeighbouringTimeline(p,i),p.setNeighbouringTimeline(n,a),n=p,c=!0)}if(l||!c){if(i===s.EventTimeline.FORWARDS&&n===this.liveTimeline)return o.logger.warn({lastEventWasNew:l,didUpdate:c}),void o.logger.warn(`Refusing to set forwards pagination token of live timeline ${n} to ${r}`);n.setPaginationToken(r,i)}}addLiveEvent(e,t,n=!1,r){let i,a=t||d.Ignore;if("object"==typeof t?({duplicateStrategy:a=d.Ignore,fromCache:n=!1,roomState:r,timelineWasEmpty:i}=t):void 0!==t&&o.logger.warn("Overload deprecated: `EventTimelineSet.addLiveEvent(event, duplicateStrategy?, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addLiveEvent(event, IAddLiveEventOptions)`"),this.filter&&!this.filter.filterRoomTimeline([e]).length)return;const c=this._eventIdToTimeline.get(e.getId());if(c)if(a===d.Replace){u("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=c.getEvents();for(let n=0;n<t.length;n++)if(t[n].getId()===e.getId()){r||(r=c.getState(s.EventTimeline.FORWARDS)),s.EventTimeline.setEventMetadata(e,r,!1),t[n]=e;break}}else u("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:n,roomState:r,timelineWasEmpty:i})}addEventToTimeline(e,t,n,r=!1,i){let s,c=!!n;"object"==typeof n?({toStartOfTimeline:c,fromCache:r=!1,roomState:i,timelineWasEmpty:s}=n):void 0!==n&&o.logger.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`");const l=e.getId();t.addEvent(e,{toStartOfTimeline:c,roomState:i,timelineWasEmpty:s}),this._eventIdToTimeline.set(l,t),this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this);const u={timeline:t,liveEvent:!c&&t==this.liveTimeline&&!r};this.emit(a.RoomEvent.Timeline,e,this.room,Boolean(c),!1,u)}handleRemoteEcho(e,t,n){const r=this._eventIdToTimeline.get(t);r?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,r)):this.filter&&!this.filter.filterRoomTimeline([e]).length||this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){const t=this._eventIdToTimeline.get(e);if(!t)return null;const n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);const r={timeline:t};this.emit(a.RoomEvent.Timeline,n,this.room,void 0,!0,r)}return n}compareEventOrdering(e,t){if(e==t)return 0;const n=this._eventIdToTimeline.get(e),r=this._eventIdToTimeline.get(t);if(void 0===n)return null;if(void 0===r)return null;if(n===r){let r,i;const s=n.getEvents();for(let n=0;n<s.length&&(void 0===r||void 0===i);n++){const o=s[n].getId();o==e&&(r=n),o==t&&(i=n)}return r-i}let i=n;for(;i;){if(i===r)return-1;i=i.getNeighbouringTimeline(s.EventTimeline.FORWARDS)}for(i=n;i;){if(i===r)return 1;i=i.getNeighbouringTimeline(s.EventTimeline.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");const{threadId:t,shouldLiveInRoom:n}=this.room.eventShouldLiveIn(e);return this.thread?this.thread.id===t:n}}t.EventTimelineSet=h},6418:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimeline=t.Direction=void 0;var i=r(n(3693)),s=n(9849),o=n(9589),a=n(4703);let c;t.Direction=c,function(e){e.Backward="b",e.Forward="f"}(c||(t.Direction=c={}));class l{static setEventMetadata(e,t,n){var r,i,s,o;null!==(r=e.sender)&&void 0!==r&&null!==(i=r.events)&&void 0!==i&&i.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(s=e.target)&&void 0!==s&&null!==(o=s.events)&&void 0!==o&&o.member||e.getType()!==a.EventType.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&n&&(e.forwardLooking=!1)}constructor(e){var t,n;this.eventTimelineSet=e,(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"name",void 0),(0,i.default)(this,"events",[]),(0,i.default)(this,"baseIndex",0),(0,i.default)(this,"startState",void 0),(0,i.default)(this,"endState",void 0),(0,i.default)(this,"prevTimeline",void 0),(0,i.default)(this,"nextTimeline",void 0),(0,i.default)(this,"paginationRequests",{[c.Backward]:null,[c.Forward]:null}),this.roomId=null!==(t=null===(n=e.room)||void 0===n?void 0:n.roomId)&&void 0!==t?t:null,this.startState=new o.RoomState(this.roomId),this.startState.paginationToken=null,this.endState=new o.RoomState(this.roomId),this.endState.paginationToken=null,this.prevTimeline=null,this.nextTimeline=null,this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e,{timelineWasEmpty:t}={}){if(this.events.length>0)throw new Error("Cannot initialise state after events are added");for(const t of e)Object.freeze(t);this.startState.setStateEvents(e,{timelineWasEmpty:t}),this.endState.setStateEvents(e,{timelineWasEmpty:t})}forkLive(e){const t=this.getState(e),n=new l(this.eventTimelineSet);return n.startState=t.clone(),n.endState=t,this.endState=t.clone(),n}fork(e){const t=this.getState(e),n=new l(this.eventTimelineSet);return n.startState=t.clone(),n.endState=t.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==l.BACKWARDS)return this.startState;if(e==l.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.getState(e).paginationToken}setPaginationToken(e,t){this.getState(t).paginationToken=e}getNeighbouringTimeline(e){if(e==l.BACKWARDS)return this.prevTimeline;if(e==l.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==l.BACKWARDS)this.prevTimeline=e;else{if(t!=l.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,t,n){let r,i=!!t;"object"==typeof t?({toStartOfTimeline:i,roomState:n,timelineWasEmpty:r}=t):void 0!==t&&s.logger.warn("Overload deprecated: `EventTimeline.addEvent(event, toStartOfTimeline, roomState?)` is deprecated in favor of the overload with `EventTimeline.addEvent(event, IAddEventOptions)`"),n||(n=i?this.startState:this.endState);const o=this.getTimelineSet();let a;o.room&&(l.setEventMetadata(e,n,i),e.isState()&&o.room.getUnfilteredTimelineSet()===o&&(n.setStateEvents([e],{timelineWasEmpty:r}),e.sender&&("m.room.member"!==e.getType()||i)||l.setEventMetadata(e,n,i))),a=i?0:this.events.length,this.events.splice(a,0,e),i&&this.baseIndex++}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}}t.EventTimeline=l,(0,i.default)(l,"BACKWARDS",c.Backward),(0,i.default)(l,"FORWARDS",c.Forward)},224:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"EventStatus",{enumerable:!0,get:function(){return h.EventStatus}}),t.MatrixEventEvent=t.MatrixEvent=void 0;var i=r(n(3693)),s=n(9787),o=n(9849),a=n(4703),c=n(4148),l=n(990),u=n(2300),d=n(7022),h=n(779);const p=Object.freeze({visible:!0});let g;t.MatrixEventEvent=g,function(e){e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated"}(g||(t.MatrixEventEvent=g={}));class f extends d.TypedEventEmitter{constructor(e={}){var t;super(),this.event=e,(0,i.default)(this,"pushActions",null),(0,i.default)(this,"_replacingEvent",null),(0,i.default)(this,"_localRedactionEvent",null),(0,i.default)(this,"_isCancelled",!1),(0,i.default)(this,"clearEvent",void 0),(0,i.default)(this,"visibility",p),(0,i.default)(this,"_hasCachedExtEv",!1),(0,i.default)(this,"_cachedExtEv",void 0),(0,i.default)(this,"senderCurve25519Key",null),(0,i.default)(this,"claimedEd25519Key",null),(0,i.default)(this,"forwardingCurve25519KeyChain",[]),(0,i.default)(this,"untrusted",null),(0,i.default)(this,"_decryptionPromise",null),(0,i.default)(this,"retryDecryption",!1),(0,i.default)(this,"txnId",null),(0,i.default)(this,"thread",null),(0,i.default)(this,"threadId",void 0),(0,i.default)(this,"localTimestamp",void 0),(0,i.default)(this,"sender",null),(0,i.default)(this,"target",null),(0,i.default)(this,"status",null),(0,i.default)(this,"error",null),(0,i.default)(this,"forwardLooking",!0),(0,i.default)(this,"verificationRequest",null),(0,i.default)(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach((t=>{"string"==typeof e[t]&&(e[t]=(0,c.internaliseString)(e[t]))})),["membership","avatar_url","displayname"].forEach((t=>{var n;"string"==typeof(null===(n=e.content)||void 0===n?void 0:n[t])&&(e.content[t]=(0,c.internaliseString)(e.content[t]))})),["rel_type"].forEach((t=>{var n,r;"string"==typeof(null===(n=e.content)||void 0===n||null===(r=n["m.relates_to"])||void 0===r?void 0:r[t])&&(e.content["m.relates_to"][t]=(0,c.internaliseString)(e.content["m.relates_to"][t]))})),this.txnId=e.txn_id||null,this.localTimestamp=Date.now()-(null!==(t=this.getAge())&&void 0!==t?t:0),this.reEmitter=new u.TypedReEmitter(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=s.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===a.EventType.RoomMessageEncrypted)for(const[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;const t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];return(null==t?void 0:t.rel_type)===l.THREAD_RELATION_TYPE.name?t.event_id:(null===(n=this.getThread())||void 0===n?void 0:n.id)||this.threadId;var n}get isThreadRoot(){var e;return!!this.getServerAggregatedRelation(l.THREAD_RELATION_TYPE.name)||(null===(e=this.getThread())||void 0===e?void 0:e.id)===this.getId()}get replyEventId(){var e;const t=this.getContent()["m.relates_to"]||this.getWireContent()["m.relates_to"];return null==t||null===(e=t["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e,t;return null===(e=this.getWireContent())||void 0===e||null===(t=e["m.relates_to"])||void 0===t?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(e,t,n,r){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=r}isBeingDecrypted(){return null!=this._decryptionPromise}getDecryptionPromise(){return this._decryptionPromise}isDecryptionFailure(){var e,t;return"m.bad.encrypted"===(null===(e=this.clearEvent)||void 0===e||null===(t=e.content)||void 0===t?void 0:t.msgtype)}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}async attemptDecryption(e,t={}){if("boolean"==typeof t&&(t={isRetry:t}),!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");const n=this.clearEvent&&!this.isDecryptionFailure(),r=t.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(n&&!r)throw new Error("Attempt to decrypt event which has already been decrypted");return this._decryptionPromise?(o.logger.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this.decryptionLoop(e,t),this._decryptionPromise)}cancelAndResendKeyRequest(e,t){const n=this.getWireContent();return e.requestRoomKey({algorithm:n.algorithm,room_id:this.getRoomId(),session_id:n.session_id,sender_key:n.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){const t=this.getWireContent(),n=[{userId:e,deviceId:"*"}],r=this.getSender();return r!==e&&n.push({userId:r,deviceId:t.device_id}),n}async decryptionLoop(e,t={}){for(await Promise.resolve();;){let n,r;this.retryDecryption=!1;try{e?(n=await e.decryptEvent(this),!0===t.isRetry&&o.logger.info(`Decrypted event on retry (id=${this.getId()})`)):n=this.badEncryptedMessage("Encryption not enabled")}catch(e){if("DecryptionError"!==e.name){const n=t.isRetry?"re":"";return o.logger.error(`Error ${n}decrypting event (id=${this.getId()}): ${e.stack||e}`),this._decryptionPromise=null,void(this.retryDecryption=!1)}if(r=e,this.retryDecryption){o.logger.log(`Got error decrypting event (id=${this.getId()}: ${e.detailedString}), but retrying`,e);continue}o.logger.warn(`Got error decrypting event (id=${this.getId()}: ${e.detailedString})`,e),n=this.badEncryptedMessage(e.message)}return this._decryptionPromise=null,this.retryDecryption=!1,this.setClearData(n),this.setPushActions(null),void(!1!==t.emit&&this.emit(g.Decrypted,this,r))}}badEncryptedMessage(e){return{clearEvent:{type:a.EventType.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}}setClearData(e){this.clearEvent=e.clearEvent,this.senderCurve25519Key=e.senderCurve25519Key||null,this.claimedEd25519Key=e.claimedEd25519Key||null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===a.EventType.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return{ed25519:this.claimedEd25519Key}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(g.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){const t=!e||e.visible,n=e?e.reason:null;let r=!1;this.visibility.visible!==e.visible?r=!0:this.visibility.visible||this.visibility.reason===n||(r=!0),r&&(this.visibility=t?p:Object.freeze({visible:!1,reason:n}),this.emit(g.VisibilityChange,this,t))}messageVisibility(){return this.visibility}makeRedacted(e){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(g.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(const e in this.event)this.event.hasOwnProperty(e)&&!m.has(e)&&delete this.event[e];this.isEncrypted()&&(this.clearEvent=null);const t=v[this.getType()]||{},n=this.getContent();for(const e in n)n.hasOwnProperty(e)&&!t[e]&&delete n[e];this.invalidateExtensibleEvent()}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===a.EventType.RoomRedaction}asVisibilityChange(){if(!a.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType()))return null;const e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;const t=e.event_id;if(!t)return null;const n=this.getWireContent(),r=!!n.visible,i=n.reason;return i&&"string"!=typeof i?null:{visible:r,reason:i,eventId:t}}isVisibilityEvent(){return a.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType())}getRedactionEvent(){var e,t;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null===(t=this.clearEvent)||void 0===t?void 0:t.unsigned.redacted_because:this.event.unsigned.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushActions}setPushActions(e){this.pushActions=e}handleRemoteEcho(e){const t=this.getUnsigned(),n=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(g.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(g.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(g.LocalEventIdReplaced,this)}isRelation(e=void 0){var t;const n=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return(!this.isState()||(null==n?void 0:n.rel_type)!==a.RelationType.Replace)&&(null==n?void 0:n.rel_type)&&n.event_id&&(!e||n.rel_type===e)}getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit(g.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(a.RelationType.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(a.RelationType.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new f(JSON.parse(JSON.stringify(this.event)));for(const[t,n]of Object.entries(this))"event"!==t&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=(0,c.deepSortedObjectEntries)(this.event),n=(0,c.deepSortedObjectEntries)(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.thread=e,this.setThreadId(e.id),this.reEmitter.reEmit(e,[l.ThreadEvent.Update])}getThread(){return this.thread}setThreadId(e){this.threadId=e}}t.MatrixEvent=f;const m=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),v={[a.EventType.RoomMember]:{membership:1},[a.EventType.RoomCreate]:{creator:1},[a.EventType.RoomJoinRules]:{join_rule:1},[a.EventType.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},[a.EventType.RoomAliases]:{aliases:1}}},1519:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PolicyScope=t.POLICIES_ACCOUNT_EVENT_TYPE=t.IgnoredInvites=t.IGNORE_INVITES_ACCOUNT_EVENT_KEY=void 0;var r=n(9787),i=n(6418),s=n(8673),o=n(4148);const a=new r.UnstableValue("m.policies","org.matrix.msc3847.policies");t.POLICIES_ACCOUNT_EVENT_TYPE=a;const c=new r.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites");var l;let u;t.IGNORE_INVITES_ACCOUNT_EVENT_KEY=c,function(e){e.Ban="m.ban"}(l||(l={})),t.PolicyScope=u,function(e){e.User="m.policy.user",e.Room="m.policy.room",e.Server="m.policy.server"}(u||(t.PolicyScope=u={})),t.IgnoredInvites=class{constructor(e){this.client=e}async addRule(e,t,n){const r=await this.getOrCreateTargetRoom();return(await this.client.sendStateEvent(r.roomId,e,{entity:t,reason:n,recommendation:l.Ban})).event_id}async removeRule(e){await this.client.redactEvent(e.getRoomId(),e.getId())}async addSource(e){await this.client.joinRoom(e);const t=(await this.getOrCreateSourceRooms()).map((e=>e.roomId));return!t.includes(e)&&(t.push(e),await this.withIgnoreInvitesPolicies((e=>{e.sources=t})),!0)}async getRuleForInvite({sender:e,roomId:t}){const n=await this.getOrCreateSourceRooms(),r=e.split(":")[1],s=t.split(":")[1];for(const a of n){const n=a.getUnfilteredTimelineSet().getLiveTimeline().getState(i.EventTimeline.FORWARDS);for(const{scope:i,entities:a}of[{scope:u.Room,entities:[t]},{scope:u.User,entities:[e]},{scope:u.Server,entities:[r,s]}]){const e=n.getStateEvents(i);for(const t of e){const e=t.getContent();if((null==e?void 0:e.recommendation)!=l.Ban)continue;const n=null==e?void 0:e.entity;if(!n)continue;let r;try{r=new RegExp((0,o.globToRegexp)(n,!1))}catch(e){continue}for(const e of a)if(e&&r.test(e))return t}}}return null}async getOrCreateTargetRoom(){let e=this.getIgnoreInvitesPolicies().target;if("string"!=typeof e&&(e=null),e){const t=this.client.getRoom(e);if(t)return t;e=null}return e=(await this.client.createRoom({name:"Individual Policy Room",preset:s.Preset.PrivateChat})).room_id,await this.withIgnoreInvitesPolicies((t=>{t.target=e})),this.client.getRoom(e)}async getOrCreateSourceRooms(){let e=this.getIgnoreInvitesPolicies().sources,t=!1;Array.isArray(e)||(t=!0,e=[]);let n=e.filter((e=>"string"==typeof e)).map((e=>this.client.getRoom(e))).filter((e=>!!e));return n.length!=e.length&&(t=!0),0==n.length&&(t=!0,n=[await this.getOrCreateTargetRoom()]),t&&await this.withIgnoreInvitesPolicies((t=>{t.sources=e})),n}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(e){const{policies:t,ignoreInvitesPolicies:n}=this.getPoliciesAndIgnoreInvitesPolicies();e(n),t[c.name]=n,await this.client.setAccountData(a.name,t)}getPoliciesAndIgnoreInvitesPolicies(){let e={};for(const n of[a.name,a.altName]){var t;if(!n)continue;const r=null===(t=this.client.getAccountData(n))||void 0===t?void 0:t.getContent();if(r){e=r;break}}let n={},r=!1;for(const t of[c.name,c.altName]){if(!t)continue;const i=e[t];if(i&&"object"==typeof i){n=i,r=!0;break}}return r||(e[c.name]=n),{policies:e,ignoreInvitesPolicies:n}}}},103:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.ReadReceipt=t.MAIN_ROOM_TIMELINE=void 0,t.synthesizeReceipt=d;var i=r(n(3693)),s=n(251),o=n(2660),a=n(7022),c=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=l(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148));function l(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(l=function(e){return e?n:t})(e)}const u="main";function d(e,t,n){var r;return new o.MatrixEvent({content:{[t.getId()]:{[n]:{[e]:{ts:t.getTs(),threadId:null!==(r=t.threadRootId)&&void 0!==r?r:u}}}},type:o.EventType.Receipt,room_id:t.getRoomId()})}t.MAIN_ROOM_TIMELINE=u;class h extends a.TypedEventEmitter{constructor(...e){super(...e),(0,i.default)(this,"receipts",{}),(0,i.default)(this,"receiptCacheByEventId",{}),(0,i.default)(this,"timeline",void 0)}getReadReceiptForUserId(e,t=!1,n=s.ReceiptType.Read){var r,i;const[o,a]=null!==(r=null===(i=this.receipts[n])||void 0===i?void 0:i[e])&&void 0!==r?r:[];return t?o:null!=a?a:o}getEventReadUpTo(e,t=!1){var n,r,i,o,a;const c=this.getUnfilteredTimelineSet(),l=this.getReadReceiptForUserId(e,t,s.ReceiptType.Read),u=this.getReadReceiptForUserId(e,t,s.ReceiptType.ReadPrivate);let d;var h,p;return null!=l&&l.eventId&&null!=u&&u.eventId&&(d=c.compareEventOrdering(null==l?void 0:l.eventId,null==u?void 0:u.eventId)),!d&&null!=l&&null!==(n=l.data)&&void 0!==n&&n.ts&&null!=u&&null!==(r=u.data)&&void 0!==r&&r.ts&&(d=(null==l||null===(h=l.data)||void 0===h?void 0:h.ts)-(null==u||null===(p=u.data)||void 0===p?void 0:p.ts)),d?null!==(a=d<0?null==u?void 0:u.eventId:null==l?void 0:l.eventId)&&void 0!==a?a:null:null!==(i=null!==(o=null==u?void 0:u.eventId)&&void 0!==o?o:null==l?void 0:l.eventId)&&void 0!==i?i:null}addReceiptToStructure(e,t,n,r,i){var s,o;this.receipts[t]||(this.receipts[t]={}),this.receipts[t][n]||(this.receipts[t][n]=[null,null]);const a=this.receipts[t][n];let c=a[0];var l;if(i&&(c=null!==(l=a[1])&&void 0!==l?l:a[0]),c){const t=this.getUnfilteredTimelineSet().compareEventOrdering(c.eventId,e);if(null!==t&&t>=0)return}const u={eventId:e,data:r},d=i?a[0]:u,h=i?u:a[1];let p=null;d&&h&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(d.eventId,h.eventId));const g=null===p||p<0,f=null!==(s=a[1])&&void 0!==s?s:a[0];if(i&&g?a[1]=u:i||(a[0]=u,g||(a[1]=null)),f!==(null!==(o=a[1])&&void 0!==o?o:a[0])){if(f&&this.receiptCacheByEventId[f.eventId]){const e=f.eventId;this.receiptCacheByEventId[e]=this.receiptCacheByEventId[e].filter((e=>e.type!==t||e.userId!==n)),this.receiptCacheByEventId[e].length<1&&delete this.receiptCacheByEventId[e]}this.receiptCacheByEventId[e]||(this.receiptCacheByEventId[e]=[]),this.receiptCacheByEventId[e].push({userId:n,type:t,data:r})}}getReceiptsForEvent(e){return this.receiptCacheByEventId[e.getId()]||[]}addLocalEchoReceipt(e,t,n){this.addReceipt(d(e,t,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return c.isSupportedReceiptType(e.type)})).map((function(e){return e.userId}))}hasUserReadEvent(e,t){const n=this.getEventReadUpTo(e,!1);if(n===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=this.timeline.length-1;e>=0;--e){const r=this.timeline[e];if(r.getId()===t)return!1;if(r.getId()===n)return!0}return!1}}t.ReadReceipt=h},7903:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RelationsContainer=void 0;var i=r(n(3693)),s=n(4869),o=n(224);t.RelationsContainer=class{constructor(e,t){this.client=e,this.room=t,(0,i.default)(this,"relations",new Map)}getChildEventsForEvent(e,t,n){var r,i;return null===(r=this.relations.get(e))||void 0===r||null===(i=r.get(t))||void 0===i?void 0:i.get(n)}getAllChildEventsForEvent(e){var t;const n=null!==(t=this.relations.get(e))&&void 0!==t?t:new Map,r=[];for(const e of n.values())for(const t of e.values())r.push(...t.getRelations());return r}aggregateParentEvent(e){const t=this.relations.get(e.getId());if(t)for(const n of t.values())for(const t of n.values())t.setTargetEvent(e)}aggregateChildEvent(e,t){if(e.isRedacted()||e.status===o.EventStatus.CANCELLED)return;const n=e.getRelation();if(!n)return;const r=()=>{e.isDecryptionFailure()?e.once(o.MatrixEventEvent.Decrypted,r):this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once(o.MatrixEventEvent.Decrypted,r);const{event_id:i,rel_type:a}=n,c=e.getType();let l=this.relations.get(i);l||(l=new Map,this.relations.set(i,l));let u=l.get(a);u||(u=new Map,l.set(a,u));let d=u.get(c);if(!d){var h,p,g;d=new s.Relations(a,c,this.client),u.set(c,d);const e=null!==(h=this.room)&&void 0!==h?h:null==t?void 0:t.room,n=null!==(p=null!==(g=null==t?void 0:t.findEventById(i))&&void 0!==g?g:null==e?void 0:e.findEventById(i))&&void 0!==p?p:null==e?void 0:e.getPendingEvent(i);n&&d.setTargetEvent(n)}d.addEvent(e)}}},4869:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RelationsEvent=t.Relations=void 0;var i=r(n(3693)),s=n(224),o=n(9849),a=n(4703),c=n(7022),l=n(5489);let u;t.RelationsEvent=u,function(e){e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction"}(u||(t.RelationsEvent=u={}));class d extends c.TypedEventEmitter{constructor(e,t,n){super(),this.relationType=e,this.eventType=t,(0,i.default)(this,"relationEventIds",new Set),(0,i.default)(this,"relations",new Set),(0,i.default)(this,"annotationsByKey",{}),(0,i.default)(this,"annotationsBySender",{}),(0,i.default)(this,"sortedAnnotationsByKey",[]),(0,i.default)(this,"targetEvent",null),(0,i.default)(this,"creationEmitted",!1),(0,i.default)(this,"client",void 0),(0,i.default)(this,"onEventStatus",((e,t)=>{e.isSending()?t===s.EventStatus.CANCELLED&&(e.removeListener(s.MatrixEventEvent.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(s.MatrixEventEvent.Status,this.onEventStatus)})),(0,i.default)(this,"onBeforeRedaction",(async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===a.RelationType.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener(s.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(u.Redaction,e)}})),this.client=n instanceof l.Room?n.client:n}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void o.logger.error("Event must have relation info");const n=t.rel_type,r=e.getType();if(this.relationType===n&&this.eventType===r){if(e.isSending()&&e.on(s.MatrixEventEvent.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===a.RelationType.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on(s.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(u.Add,e),this.maybeEmitCreated()}else o.logger.error("Event relation info doesn't match this container")}async removeEvent(e){if(!this.relations.has(e))return;const t=e.getRelation();if(!t)return void o.logger.error("Event must have relation info");const n=t.rel_type,r=e.getType();if(this.relationType===n&&this.eventType===r){if(this.relations.delete(e),this.relationType===a.RelationType.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit(u.Remove,e)}else o.logger.error("Event relation info doesn't match this container")}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let n=this.annotationsByKey[t];n||(n=this.annotationsByKey[t]=new Set,this.sortedAnnotationsByKey.push([t,n])),n.add(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const n=e[1];return t[1].size-n.size}));const r=e.getSender();let i=this.annotationsBySender[r];i||(i=this.annotationsBySender[r]=new Set),i.add(e)}removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const n=this.annotationsByKey[t];n&&(n.delete(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const n=e[1];return t[1].size-n.size})));const r=e.getSender(),i=this.annotationsBySender[r];i&&i.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==a.RelationType.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==a.RelationType.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==a.RelationType.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(a.RelationType.Replace),t=null==e?void 0:e.origin_server_ts,n=this.getRelations().reduce(((e,n)=>n.getSender()!==this.targetEvent.getSender()||t&&t>n.getTs()||e&&e.getTs()>n.getTs()?e:n),null);return null!=n&&n.shouldAttemptDecryption()?await n.attemptDecryption(this.client.crypto):null!=n&&n.isBeingDecrypted()&&await n.getDecryptionPromise(),n}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===a.RelationType.Replace&&!this.targetEvent.isState()){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(s.MatrixEventEvent.RelationsCreated,this.relationType,this.eventType))}}t.Relations=d},9948:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomMemberEvent=t.RoomMember=void 0;var i=r(n(3693)),s=n(7777),o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=u(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148)),a=n(9849),c=n(7022),l=n(4703);function u(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(u=function(e){return e?n:t})(e)}let d;t.RoomMemberEvent=d,function(e){e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing"}(d||(t.RoomMemberEvent=d={}));class h extends c.TypedEventEmitter{constructor(e,t){super(),this.roomId=e,this.userId=t,(0,i.default)(this,"_isOutOfBand",!1),(0,i.default)(this,"_modified",void 0),(0,i.default)(this,"_requestedProfileInfo",void 0),(0,i.default)(this,"typing",!1),(0,i.default)(this,"name",void 0),(0,i.default)(this,"rawDisplayName",void 0),(0,i.default)(this,"powerLevel",0),(0,i.default)(this,"powerLevelNorm",0),(0,i.default)(this,"user",null),(0,i.default)(this,"membership",null),(0,i.default)(this,"disambiguate",!1),(0,i.default)(this,"events",{member:null}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){const n=e.getDirectionalContent().displayname;if(e.getType()!==l.EventType.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;const r=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&a.logger.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=function(e,t,n){if(!t||t===e)return!1;if(!o.removeHiddenChars(t))return!1;if(!n)return!1;if(p.test(t))return!0;if(g.test(t))return!0;return!!n.getUserIdsWithDisplayName(t).some((t=>t!==e))}(this.userId,n,t);const i=this.name;this.name=function(e,t,n,r){return r?o.removeDirectionOverrideChars(t)+" ("+e+")":t&&t!==e&&o.removeHiddenChars(t)?o.removeDirectionOverrideChars(t):e}(this.userId,n,0,this.disambiguate),this.rawDisplayName=o.removeDirectionOverrideChars(e.getDirectionalContent().displayname),this.rawDisplayName&&o.removeHiddenChars(this.rawDisplayName)||(this.rawDisplayName=this.userId),r!==this.membership&&(this.updateModifiedTime(),this.emit(d.Membership,e,this,r)),i!==this.name&&(this.updateModifiedTime(),this.emit(d.Name,e,this,i))}setPowerLevelEvent(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let n=t.users_default||0;const r=t.users||{};Object.values(r).forEach((function(e){n=Math.max(n,e)}));const i=this.powerLevel,s=this.powerLevelNorm;void 0!==r[this.userId]&&Number.isInteger(r[this.userId])?this.powerLevel=r[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,n>0&&(this.powerLevelNorm=100*this.powerLevel/n),i===this.powerLevel&&s===this.powerLevelNorm||(this.updateModifiedTime(),this.emit(d.PowerLevel,e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const n=e.getContent().user_ids;Array.isArray(n)&&(-1!==n.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(d.Typing,e,this)))}updateModifiedTime(){this._modified=Date.now()}getLastModifiedTime(){return this._modified}isKicked(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),n=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return n}}getAvatarUrl(e,t,n,r,i=!0,o){const a=this.getMxcAvatarUrl();if(!a&&!i)return null;return(0,s.getHttpUriForMxc)(e,a,t,n,r,o)||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}}t.RoomMember=h;const p=/@.+:.+/,g=/[\u200E\u200F\u202A-\u202F]/},9589:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomStateEvent=t.RoomState=void 0;var i,s=r(n(3693)),o=n(9948),a=n(9849),c=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=m(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148)),l=n(4703),u=n(224),d=n(8673),h=n(7022),p=n(1062),g=n(2300),f=n(4643);function m(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(m=function(e){return e?n:t})(e)}function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){(0,s.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let _;!function(e){e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished"}(i||(i={})),t.RoomStateEvent=_,function(e){e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness",e.Marker="RoomState.Marker"}(_||(t.RoomStateEvent=_={}));class b extends h.TypedEventEmitter{constructor(e,t={status:i.NotStarted}){super(),this.roomId=e,this.oobMemberFlags=t,(0,s.default)(this,"reEmitter",new g.TypedReEmitter(this)),(0,s.default)(this,"sentinels",{}),(0,s.default)(this,"displayNameToUserIds",new Map),(0,s.default)(this,"userIdsToDisplayNames",{}),(0,s.default)(this,"tokenToInvite",{}),(0,s.default)(this,"joinedMemberCount",null),(0,s.default)(this,"summaryJoinedMemberCount",null),(0,s.default)(this,"invitedMemberCount",null),(0,s.default)(this,"summaryInvitedMemberCount",null),(0,s.default)(this,"modified",void 0),(0,s.default)(this,"members",{}),(0,s.default)(this,"events",new Map),(0,s.default)(this,"paginationToken",null),(0,s.default)(this,"beacons",new Map),(0,s.default)(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce(((e,t)=>"join"===t.membership?e+1:e),0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce(((e,t)=>"invite"===t.membership?e+1:e),0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter((t=>!e.includes(t.userId)))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new o.RoomMember(this.roomId,e);const n=this.members[e];n&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());return this.events.get(e).get(t)||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const e=new b(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=i.NotStarted,Array.from(this.events.values()).forEach((t=>{e.setStateEvents(Array.from(t.values()))})),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==i.Finished&&this.getMembers().forEach((t=>{t.isOutOfBand()&&e.getMember(t.userId).markOutOfBand()})),e}setUnknownStateEvents(e){const t=e.filter((e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey())));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach((e=>{if(e.getRoomId()!==this.roomId)return;if(!e.isState())return;f.M_BEACON_INFO.matches(e.getType())&&this.setBeacon(e);const t=this.getStateEventMatching(e);this.setStateEvent(e),e.getType()===l.EventType.RoomMember&&(this.updateDisplayNameCache(e.getStateKey(),e.getContent().displayname),this.updateThirdPartyTokenCache(e)),this.emit(_.Events,e,this,t)})),this.onBeaconLivenessChange(),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===l.EventType.RoomMember){const t=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit(_.Members,e,this,n)}else if(e.getType()===l.EventType.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach((t=>{const n=t.getLastModifiedTime();t.setPowerLevelEvent(e),n!==t.getLastModifiedTime()&&this.emit(_.Members,e,this,t)})),this.sentinels={}}else l.UNSTABLE_MSC2716_MARKER.matches(e.getType())&&this.emit(_.Marker,e,t)})),this.emit(_.Update,this)}processBeaconEvents(e,t){if(!e.length||!this.beacons.size)return;const n=[...this.beacons.values()].reduce(((e,t)=>y(y({},e),{},{[t.beaconInfoId]:t})),{}),r=(e,t)=>{if(!f.M_BEACON.matches(t.getType()))return;const r=n[e];r&&r.addLocations([t])};e.forEach((e=>{var i;const s=null===(i=e.getRelation())||void 0===i?void 0:i.event_id;n[s]&&(t.decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()?e.once(u.MatrixEventEvent.Decrypted,(async()=>{r(s,e)})):r(s,e))}))}getOrCreateMember(e,t){let n=this.members[e];return n||(n=new o.RoomMember(this.roomId,e),this.members[e]=n,this.emit(_.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){const t=(0,p.getBeaconInfoIdentifier)(e);if(this.beacons.has(t)){const r=this.beacons.get(t);var n;return e.isRedacted()?void(r.beaconInfoId===(null===(n=e.getRedactionEvent())||void 0===n?void 0:n.redacts)&&(r.destroy(),this.beacons.delete(t))):r.update(e)}if(e.isRedacted())return;const r=new p.Beacon(e);this.reEmitter.reEmit(r,[p.BeaconEvent.New,p.BeaconEvent.Update,p.BeaconEvent.Destroy,p.BeaconEvent.LivenessChange]),this.emit(p.BeaconEvent.New,e,r),r.on(p.BeaconEvent.LivenessChange,this.onBeaconLivenessChange.bind(this)),r.on(p.BeaconEvent.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(r.identifier,r)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter((e=>e.isLive)).map((e=>e.identifier)),this.emit(_.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return null!==(t=null===(n=this.events.get(e.getType()))||void 0===n?void 0:n.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){const t=this.getStateEvents(l.EventType.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===i.NotStarted}markOutOfBandMembersStarted(){this.oobMemberFlags.status===i.NotStarted&&(this.oobMemberFlags.status=i.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===i.InProgress&&(this.oobMemberFlags.status=i.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach((t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])})),a.logger.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=i.NotStarted}setOutOfBandMembers(e){a.logger.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===i.InProgress&&(a.logger.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=i.Finished,e.forEach((e=>this.setOutOfBandMember(e))),this.emit(_.Update,this))}setOutOfBandMember(e){if(e.getType()!==l.EventType.RoomMember)return;const t=e.getStateKey(),n=this.getMember(t);if(n&&!n.isOutOfBand())return;const r=this.getOrCreateMember(t,e);r.setMembershipEvent(e,this),r.markOutOfBand(),this.updateDisplayNameCache(r.userId,r.name),this.setStateEvent(e),this.updateMember(r),this.emit(_.Members,e,this,r)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!==(t=this.displayNameToUserIds.get(c.removeHiddenChars(e)))&&void 0!==t?t:[]}maySendRedactionForEvent(e,t){const n=this.getMember(t);if(!n||"leave"===n.membership)return!1;if(e.status||e.isRedacted())return!1;const r=this.maySendEvent(l.EventType.RoomRedaction,t);return e.getSender()===t?r:this.hasSufficientPowerLevelFor("redact",n.powerLevel)}hasSufficientPowerLevelFor(e,t){const n=this.getStateEvents(l.EventType.RoomPowerLevels,"");let r={};n&&(r=n.getContent());let i=50;return c.isNumber(r[e])&&(i=r[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(l.EventType.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){const r=this.getStateEvents(l.EventType.RoomPowerLevels,"");let i,s={},o=0,a=0,c=0;if(r){i=r.getContent(),s=i.events||{},o=Number.isSafeInteger(i.state_default)?i.state_default:50;const e=i.users&&i.users[t];Number.isSafeInteger(e)?c=e:Number.isSafeInteger(i.users_default)&&(c=i.users_default),Number.isSafeInteger(i.events_default)&&(a=i.events_default)}let u=n?o:a;return Number.isSafeInteger(s[e])&&(u=s[e]),c>=u}mayTriggerNotifOfType(e,t){const n=this.getMember(t);if(!n)return!1;const r=this.getStateEvents(l.EventType.RoomPowerLevels,"");let i=50;return r&&r.getContent()&&r.getContent().notifications&&c.isNumber(r.getContent().notifications[e])&&(i=r.getContent().notifications[e]),n.powerLevel>=i}getJoinRule(){var e;const t=this.getStateEvents(l.EventType.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||d.JoinRule.Invite}getHistoryVisibility(){var e;const t=this.getStateEvents(l.EventType.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||d.HistoryVisibility.Shared}getGuestAccess(){var e;const t=this.getStateEvents(l.EventType.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||d.GuestAccess.Forbidden}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;t&&this.getStateEvents(l.EventType.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){const t=c.removeHiddenChars(n),r=this.displayNameToUserIds.get(t);if(r){const n=r.filter((t=>t!==e));this.displayNameToUserIds.set(t,n)}}this.userIdsToDisplayNames[e]=t;const r=t&&c.removeHiddenChars(t);if(r){var i;const t=null!==(i=this.displayNameToUserIds.get(r))&&void 0!==i?i:[];t.push(e),this.displayNameToUserIds.set(r,t)}}}t.RoomState=b},8764:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomSummary=void 0,t.RoomSummary=class{constructor(e,t){this.roomId=e}}},5489:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomNameType=t.RoomEvent=t.Room=t.NotificationCountType=t.KNOWN_SAFE_ROOM_VERSION=void 0;var i=r(n(3693)),s=n(8931),o=n(6418),a=n(7777),c=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=w(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148)),l=n(224),u=n(779),d=n(9948),h=n(8764),p=n(9849),g=n(2300),f=n(4703),m=n(642),v=n(2763),y=n(9589),_=n(1062),b=n(990),E=n(251),A=n(7903),S=n(103);function w(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(w=function(e){return e?n:t})(e)}function I(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function T(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?I(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.KNOWN_SAFE_ROOM_VERSION="9";const k=["1","2","3","4","5","6","7","8","9"];let R,O;t.NotificationCountType=R,function(e){e.Highlight="highlight",e.Total="total"}(R||(t.NotificationCountType=R={})),t.RoomEvent=O,function(e){e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset",e.TimelineRefresh="Room.TimelineRefresh",e.OldStateUpdated="Room.OldStateUpdated",e.CurrentStateUpdated="Room.CurrentStateUpdated",e.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline"}(O||(t.RoomEvent=O={}));class C extends S.ReadReceipt{constructor(e,t,n,r={}){super(),this.roomId=e,this.client=t,this.myUserId=n,this.opts=r,(0,i.default)(this,"reEmitter",void 0),(0,i.default)(this,"txnToEvent",{}),(0,i.default)(this,"notificationCounts",{}),(0,i.default)(this,"timelineSets",void 0),(0,i.default)(this,"threadsTimelineSets",[]),(0,i.default)(this,"filteredTimelineSets",{}),(0,i.default)(this,"timelineNeedsRefresh",!1),(0,i.default)(this,"pendingEventList",void 0),(0,i.default)(this,"blacklistUnverifiedDevices",null),(0,i.default)(this,"selfMembership",null),(0,i.default)(this,"summaryHeroes",null),(0,i.default)(this,"getTypeWarning",!1),(0,i.default)(this,"getVersionWarning",!1),(0,i.default)(this,"membersPromise",void 0),(0,i.default)(this,"name",void 0),(0,i.default)(this,"normalizedName",void 0),(0,i.default)(this,"tags",{}),(0,i.default)(this,"accountData",{}),(0,i.default)(this,"summary",null),(0,i.default)(this,"storageToken",void 0),(0,i.default)(this,"timeline",void 0),(0,i.default)(this,"oldState",void 0),(0,i.default)(this,"currentState",void 0),(0,i.default)(this,"relations",new A.RelationsContainer(this.client,this)),(0,i.default)(this,"threads",new Map),(0,i.default)(this,"lastThread",void 0),(0,i.default)(this,"visibilityEvents",new Map),(0,i.default)(this,"threadTimelineSetsPromise",null),(0,i.default)(this,"threadsReady",!1),(0,i.default)(this,"applyRedaction",(e=>{if(e.isRedaction()){const t=e.event.redacts,n=this.findEventById(t);n&&(n.makeRedacted(e),n.isState()&&this.currentState.getStateEvents(n.getType(),n.getStateKey()).getId()===n.getId()&&this.currentState.setStateEvents([n]),this.emit(O.Redaction,e,this),this.visibilityEvents.delete(t),n.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e))}})),this.setMaxListeners(100),this.reEmitter=new g.TypedReEmitter(this),r.pendingEventOrdering=r.pendingEventOrdering||m.PendingEventOrdering.Chronological,this.name=e,this.timelineSets=[new s.EventTimelineSet(this,r)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[O.Timeline,O.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===m.PendingEventOrdering.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then((e=>{e.forEach((async e=>{const t=new l.MatrixEvent(e);t.getType()===f.EventType.RoomMessageEncrypted&&await t.attemptDecryption(this.client.crypto),t.setStatus(u.EventStatus.NOT_SENT),this.addPendingEvent(t,t.getTxnId())}))}))),this.opts.lazyLoadMembers?this.membersPromise=null:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(e=this.client)&&void 0!==e&&e.supportsExperimentalThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(b.ThreadFilterType.My)]);const e=await this.threadTimelineSetsPromise;this.threadsTimelineSets.push(...e)}catch(e){this.threadTimelineSetsPromise=null}}decryptCriticalEvents(){const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),n=t.findIndex((t=>t.event.event_id===e)),r=t.slice(n).filter((e=>e.shouldAttemptDecryption())).reverse().map((e=>e.attemptDecryption(this.client.crypto,{isRetry:!0})));return Promise.allSettled(r)}decryptAllEvents(){const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().filter((e=>e.shouldAttemptDecryption())).reverse().map((e=>e.attemptDecryption(this.client.crypto,{isRetry:!0})));return Promise.allSettled(e)}getCreator(){var e;const t=this.currentState.getStateEvents(f.EventType.RoomCreate,"");return null!==(e=null==t?void 0:t.getContent().creator)&&void 0!==e?e:null}getVersion(){const e=this.currentState.getStateEvents(f.EventType.RoomCreate,"");if(!e)return this.getVersionWarning||(p.logger.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1";const t=e.getContent().room_version;return void 0===t?"1":t}shouldUpgradeToVersion(){return k.includes(this.getVersion())?null:"9"}async getRecommendedVersion(){let e=(await this.client.getCapabilities())["m.room_versions"];if(!e){e={default:"9",available:{}};for(const t of k)e.available[t]=m.RoomVersionStability.Stable}let t=this.checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){if(p.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),e=(await this.client.getCapabilities(!0))["m.room_versions"],!e)return p.logger.warn("No room version capability - assuming upgrade required."),t;t=this.checkVersionAgainstCapability(e)}return t}checkVersionAgainstCapability(e){const t=this.getVersion();p.logger.log(`[${this.roomId}] Current version: ${t}`),p.logger.log(`[${this.roomId}] Version capability: `,e);const n={version:t,needsUpgrade:!1,urgent:!1};return t===e.default||Object.keys(e.available).filter((t=>"stable"===e.available[t])).includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?p.logger.warn(`URGENT upgrade required on ${this.roomId}`):p.logger.warn(`Non-urgent upgrade required on ${this.roomId}`)),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(f.EventType.RoomTombstone,e)}getPendingEvents(){if(this.opts.pendingEventOrdering!==m.PendingEventOrdering.Detached)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(this.opts.pendingEventOrdering!==m.PendingEventOrdering.Detached)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=c.removeElement(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){return this.opts.pendingEventOrdering===m.PendingEventOrdering.Detached&&this.pendingEventList.some((t=>t.getId()===e))}getPendingEvent(e){return this.opts.pendingEventOrdering!==m.PendingEventOrdering.Detached?null:this.pendingEventList.find((t=>t.getId()===e))}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){const e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():Number.MIN_SAFE_INTEGER}getMyMembership(){return this.selfMembership}getDMInviter(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this.selfMembership&&2==this.getInvitedAndJoinedMemberCount()&&this.summaryHeroes.length)return this.summaryHeroes[0]}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const t=this.currentState.getMembers().find((e=>e.userId!==this.myUserId));return t?t.userId:this.myUserId}getAvatarFallbackMember(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(e){const e=this.summaryHeroes.map((e=>this.getMember(e))).find((e=>!!e));if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find((e=>e.userId!==this.myUserId));if(e)return e}if(e){const e=this.summaryHeroes.map((e=>this.client.getUser(e))).find((e=>!!e));if(e){const t=new d.RoomMember(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit(O.MyMembership,this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,"leave",e)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);return(null===t||this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId))&&(e=!0,t=await this.loadMembersFromServer(),p.logger.log(`LL: got ${t.length} members from server for room ${this.roomId}`)),{memberEvents:t.map(this.client.getEventMapper()),fromServer:e}}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then((e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId)&&this.client.crypto.trackRoomDevices(this.roomId),e.fromServer))).catch((e=>{throw this.membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e}));return e.then((e=>{if(e){const e=this.currentState.getMembers().filter((e=>e.isOutOfBand())).map((e=>e.events.member.event));return p.logger.log(`LL: telling store to write ${e.length} members for room ${this.roomId}`),this.client.store.setOutOfBandMembers(this.roomId,e).catch((e=>{p.logger.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((e=>{p.logger.error(e)})),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=null)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch((e=>{p.logger.error(`error after clearing loaded members from room ${this.roomId} after leaving`),p.logger.log(e)}))}async refreshLiveTimeline(){const e=this.getLiveTimeline(),t=e.getPaginationToken(o.EventTimeline.FORWARDS),n=e.getPaginationToken(o.EventTimeline.BACKWARDS),r=e.getEvents(),i=r[r.length-1];p.logger.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${i&&i.getId()} liveTimelineBefore=${e.toString()} forwardPaginationToken=${t} backwardPaginationToken=${n}`);const s=this.getUnfilteredTimelineSet();let a;i?(this.resetLiveTimeline(null,null),this.emit(O.TimelineRefresh,this,s),a=await this.client.getEventTimeline(s,i.getId())):a=await this.client.getLatestTimeline(s);const c=s.getLiveTimeline();!c||null===c.getPaginationToken(o.Direction.Forward)&&null===c.getPaginationToken(o.Direction.Backward)&&0===c.getEvents().length?(p.logger.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),a.setPaginationToken(t,o.EventTimeline.FORWARDS),s.setLiveTimeline(a),this.fixUpLegacyTimelineFields()):p.logger.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`),this.setTimelineNeedsRefresh(!1),this.emit(O.TimelineRefresh,this,s)}resetLiveTimeline(e,t){for(let n=0;n<this.timelineSets.length;n++)this.timelineSets[n].resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){const e=this.oldState,t=this.currentState;this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(o.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(o.EventTimeline.FORWARDS),e!==this.oldState&&this.emit(O.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(O.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[y.RoomStateEvent.Events,y.RoomStateEvent.Members,y.RoomStateEvent.NewMember,y.RoomStateEvent.Update,y.RoomStateEvent.Marker,_.BeaconEvent.New,_.BeaconEvent.Update,_.BeaconEvent.Destroy,_.BeaconEvent.LivenessChange]),this.reEmitter.reEmit(this.currentState,[y.RoomStateEvent.Events,y.RoomStateEvent.Members,y.RoomStateEvent.NewMember,y.RoomStateEvent.Update,y.RoomStateEvent.Marker,_.BeaconEvent.New,_.BeaconEvent.Update,_.BeaconEvent.Destroy,_.BeaconEvent.LivenessChange]))}async hasUnverifiedDevices(){if(!this.client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e)if(this.client.getStoredDevicesForUser(t.userId).some((e=>e.isUnverified())))return!0;return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getLiveTimeline():this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){const n=this.getThreads();for(let r=0;r<n.length;r++)if(t=n[r].findEventById(e),t)return t}return t}getUnreadNotificationCount(e=R.Total){return this.notificationCounts[e]}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t}setSummary(e){const t=e["m.heroes"],n=e["m.joined_member_count"],r=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(r)&&this.currentState.setInvitedMemberCount(r),Array.isArray(t)&&(this.summaryHeroes=t.filter((e=>e!==this.myUserId)))}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,r,i=!0){const s=this.currentState.getStateEvents(f.EventType.RoomAvatar,"");if(!s&&!i)return null;const o=s?s.getContent().url:null;return o?(0,a.getHttpUriForMxc)(e,o,t,n,r):null}getMxcAvatarUrl(){var e,t;return(null===(e=this.currentState.getStateEvents(f.EventType.RoomAvatar,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.url)||null}getAliases(){const e=[],t=this.currentState.getStateEvents(f.EventType.RoomAliases);if(t)for(const n of t)if(Array.isArray(n.getContent().aliases)){const t=n.getContent().aliases.filter((e=>"string"==typeof e&&"#"===e[0]&&!!e.endsWith(`:${n.getStateKey()}`)));e.push(...t)}return e}getCanonicalAlias(){const e=this.currentState.getStateEvents(f.EventType.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(f.EventType.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,n,r){n.getTimelineSet().addEventsToTimeline(e,t,n,r)}getThread(e){return this.threads.get(e)}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(f.EventType.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const n=this.getMember(e);return!!n&&n.membership===t}getOrCreateFilteredTimelineSet(e,{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:r=!0}={}){if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const i=Object.assign({filter:e,pendingEvents:r},this.opts),a=new s.EventTimelineSet(this,i);this.reEmitter.reEmit(a,[O.Timeline,O.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=a,this.timelineSets.push(a));const c=this.getLiveTimeline();if(t){c.getEvents().forEach((function(e){a.addLiveEvent(e)}));let e=c;for(;e.getNeighbouringTimeline(o.EventTimeline.BACKWARDS);)e=e.getNeighbouringTimeline(o.EventTimeline.BACKWARDS);a.getLiveTimeline().setPaginationToken(e.getPaginationToken(o.EventTimeline.BACKWARDS),o.EventTimeline.BACKWARDS)}else if(n){const e=c.getPaginationToken(o.Direction.Forward);a.getLiveTimeline().setPaginationToken(e,o.Direction.Backward)}return a}async getThreadListFilter(e=b.ThreadFilterType.All){const t=this.client.getUserId(),n=new v.Filter(t),r={room:{timeline:{[b.FILTER_RELATED_BY_REL_TYPES.name]:[b.THREAD_RELATION_TYPE.name]}}};e===b.ThreadFilterType.My&&(r.room.timeline[b.FILTER_RELATED_BY_SENDERS.name]=[t]),n.setDefinition(r);const i=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${e}`,n);return n.filterId=i,n}async createThreadTimelineSet(e){let t;if(b.Thread.hasServerSideSupport){const n=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new s.EventTimelineSet(this,{pendingEvents:!1}),Array.from(this.threads).forEach((([,n])=>{if(0===n.length)return;const r=n.events.some((e=>e.getSender()===this.client.getUserId()));(e!==b.ThreadFilterType.My||r)&&t.getLiveTimeline().addEvent(n.rootEvent,{toStartOfTimeline:!1})}));return t}async fetchRoomThreads(){if(this.threadsReady||!this.client.supportsExperimentalThreads())return;const e=await this.getThreadListFilter(),{chunk:t}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,o.Direction.Backward,e);if(!t.length)return;const n=t.map(this.client.getEventMapper()).sort(((e,t)=>{const n=e.getServerAggregatedRelation(f.RelationType.Thread),r=t.getServerAggregatedRelation(f.RelationType.Thread);return n.latest_event.origin_server_ts-r.latest_event.origin_server_ts}));let r;const i=this.getLiveTimeline().getState(o.EventTimeline.FORWARDS);for(const e of n)this.threadsTimelineSets[0].addLiveEvent(e,{duplicateStrategy:s.DuplicateStrategy.Ignore,fromCache:!1,roomState:i}),e.getServerAggregatedRelation(f.RelationType.Thread).current_user_participated&&(this.threadsTimelineSets[1].addLiveEvent(e,{duplicateStrategy:s.DuplicateStrategy.Ignore,fromCache:!1,roomState:i}),r=e),this.getThread(e.getId())||this.createThread(e.getId(),e,[],!0);this.client.decryptEventIfNeeded(n[n.length-1]),r&&this.client.decryptEventIfNeeded(r),this.threadsReady=!0,this.on(b.ThreadEvent.NewReply,this.onThreadNewReply)}onThreadNewReply(e){for(const t of this.threadsTimelineSets)t.removeEvent(e.id),t.addLiveEvent(e.rootEvent)}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var r;if(!this.client.supportsExperimentalThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=n&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};if(e.isRelation(b.THREAD_RELATION_TYPE.name))return{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:e.threadRootId};const i=e.getAssociatedId(),s=null!==(r=this.findEventById(i))&&void 0!==r?r:null==t?void 0:t.find((e=>e.getId()===i));return s&&(e.isRelation()||e.isRedaction())?this.eventShouldLiveIn(s,t,n):null!=n&&n.has(e.relationEventId)?{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.relationEventId}:{shouldLiveInRoom:!0,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;const{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t,n=!1){let r=this.getThread(e);if(r)r.addEvents(t,n);else{var i;const s=null!==(i=this.findEventById(e))&&void 0!==i?i:t.find((t=>t.getId()===e));r=this.createThread(e,s,t,n),this.emit(b.ThreadEvent.Update,r)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);const n={};for(const t of e){var r;const{threadId:e,shouldLiveInThread:i}=this.eventShouldLiveIn(t);i&&!n[e]&&(n[e]=[]),null===(r=n[e])||void 0===r||r.push(t)}Object.entries(n).map((([e,n])=>this.addThreadedEvents(e,n,t)))}createThread(e,t,n=[],r){var i;if(t){const e=this.relations.getAllChildEventsForEvent(t.getId());null!=e&&e.length&&(n=n.concat(e.filter((e=>!e.isRelation(f.RelationType.Replace)))))}const s=new b.Thread(e,t,{initialEvents:n,room:this,client:this.client});return this.threads.set(s.id,s),this.reEmitter.reEmit(s,[b.ThreadEvent.Update,b.ThreadEvent.NewReply,O.Timeline,O.TimelineReset]),(!this.lastThread||(null===(i=this.lastThread.rootEvent)||void 0===i?void 0:i.localTimestamp)<(null==t?void 0:t.localTimestamp))&&(this.lastThread=s),this.emit(b.ThreadEvent.New,s,r),this.threadsReady&&this.threadsTimelineSets.forEach((e=>{s.rootEvent&&(b.Thread.hasServerSideSupport?e.addLiveEvent(s.rootEvent):e.addEventToTimeline(s.rootEvent,e.getLiveTimeline(),r))})),s}processLiveEvent(e){if(this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId)for(const t in this.txnToEvent)if(this.txnToEvent[t].getId()===e.getId()){p.logger.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());const n=e.getUnsigned();n.transaction_id=t,e.setUnsigned(n);break}}addLiveEvent(e,t){const{duplicateStrategy:n,timelineWasEmpty:r,fromCache:i}=t;for(let t=0;t<this.timelineSets.length;t++)this.timelineSets[t].addLiveEvent(e,{duplicateStrategy:n,fromCache:i,timelineWasEmpty:r});e.sender&&e.getType()!==f.EventType.RoomRedaction&&this.addReceipt((0,S.synthesizeReceipt)(e.sender.userId,e,E.ReceiptType.Read),!0)}addPendingEvent(e,t){if(e.status!==u.EventStatus.SENDING&&e.status!==u.EventStatus.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(o.EventTimeline.setEventMetadata(e,this.getLiveTimeline().getState(o.EventTimeline.FORWARDS),!1),this.txnToEvent[t]=e,this.opts.pendingEventOrdering===m.PendingEventOrdering.Detached){if(this.pendingEventList.some((e=>e.status===u.EventStatus.NOT_SENT))&&(p.logger.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(u.EventStatus.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n;const t=e.event.redacts;let r=null===(n=this.pendingEventList)||void 0===n?void 0:n.find((e=>e.getId()===t));r||(r=this.findEventById(t)),r&&(r.markLocallyRedacted(e),this.emit(O.Redaction,e,this))}}else for(let t=0;t<this.timelineSets.length;t++){const n=this.timelineSets[t];n.getFilter()?n.getFilter().filterRoomTimeline([e]).length&&n.addEventToTimeline(e,n.getLiveTimeline(),{toStartOfTimeline:!1}):n.addEventToTimeline(e,n.getLiveTimeline(),{toStartOfTimeline:!1})}this.emit(O.LocalEchoUpdated,e,this,null,null)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map((e=>T(T({},e.event),{},{txn_id:e.getTxnId()}))).filter((e=>{const t=e.type===f.EventType.RoomMessageEncrypted,n=this.client.isRoomEncrypted(this.roomId);return t||!n}));this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent[e]}handleRemoteEcho(e,t){const n=t.getId(),r=e.getId(),i=t.status;p.logger.debug(`Got remote echo for event ${n} -> ${r} old status ${i}`),delete this.txnToEvent[e.getUnsigned().transaction_id],this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);const{shouldLiveInRoom:s,threadId:o}=this.eventShouldLiveIn(e),a=this.getThread(o);if(null==a||a.timelineSet.handleRemoteEcho(t,n,r),s)for(let e=0;e<this.timelineSets.length;e++)this.timelineSets[e].handleRemoteEcho(t,n,r);this.emit(O.LocalEchoUpdated,t,this,n,i)}updatePendingEvent(e,t,n){if(p.logger.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${n}`),t==u.EventStatus.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==u.EventStatus.SENT&&this.getTimelineForEvent(n)){const t=this.findEventById(n);if(!t.getUnsigned().transaction_id){const n=t.getUnsigned();n.transaction_id=e.getTxnId(),t.setUnsigned(n),this.removeEvent(t.getId()),this.handleRemoteEcho(t,e)}return}const r=e.status,i=e.getId();if(!r)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const s=P[r];if(!s||s.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+r+"->"+t);if(e.setStatus(t),t==u.EventStatus.SENT){e.replaceLocalEventId(n);const{shouldLiveInRoom:t,threadId:r}=this.eventShouldLiveIn(e),s=this.getThread(r);if(null==s||s.timelineSet.replaceEventId(i,n),t)for(let e=0;e<this.timelineSets.length;e++)this.timelineSets[e].replaceEventId(i,n)}else if(t==u.EventStatus.CANCELLED){if(this.pendingEventList){const e=this.getPendingEvent(i);this.removePendingEvent(i),e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(i)}this.savePendingEvents(),this.emit(O.LocalEchoUpdated,e,this,i,r)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(O.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}addLiveEvents(e,t,n=!1){let r=t,i=!1;if("object"==typeof t?({duplicateStrategy:r,fromCache:n=!1,timelineWasEmpty:i}=t):void 0!==t&&p.logger.warn("Overload deprecated: `Room.addLiveEvents(events, duplicateStrategy?, fromCache?)` is deprecated in favor of the overload with `Room.addLiveEvents(events, IAddLiveEventOptions)`"),r&&-1===["replace","ignore"].indexOf(r))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let e=0;e<this.timelineSets.length;e++){const t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(o.EventTimeline.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(o.EventTimeline.FORWARDS)+")");if(t.getNeighbouringTimeline(o.EventTimeline.FORWARDS))throw new Error(`live timeline ${e} is no longer live - it has a neighbouring timeline`)}const s=this.findThreadRoots(e),a={},c={duplicateStrategy:r,fromCache:n,timelineWasEmpty:i};for(const t of e){var l;if(this.processLiveEvent(t),t.getUnsigned().transaction_id){const e=this.txnToEvent[t.getUnsigned().transaction_id];if(e){this.handleRemoteEcho(t,e);continue}}const{shouldLiveInRoom:n,shouldLiveInThread:r,threadId:i}=this.eventShouldLiveIn(t,e,s);r&&!a[null!=i?i:""]&&(a[null!=i?i:""]=[]),null===(l=a[null!=i?i:""])||void 0===l||l.push(t),n&&this.addLiveEvent(t,c)}Object.entries(a).forEach((([e,t])=>{this.addThreadedEvents(e,t,!1)}))}partitionThreadedEvents(e){if(this.client.supportsExperimentalThreads()){const t=this.findThreadRoots(e);return e.reduce(((n,r)=>{const{shouldLiveInRoom:i,shouldLiveInThread:s,threadId:o}=this.eventShouldLiveIn(r,e,t);return i&&n[0].push(r),s&&(r.setThreadId(null!=o?o:""),n[1].push(r)),n}),[[],[]])}return[e,[]]}findThreadRoots(e){const t=new Set;for(const r of e){var n;r.isRelation(b.THREAD_RELATION_TYPE.name)&&t.add(null!==(n=r.relationEventId)&&void 0!==n?n:"")}return t}addReceipt(e,t=!1){const n=e.getContent();Object.keys(n).forEach((e=>{Object.keys(n[e]).forEach((r=>{Object.keys(n[e][r]).forEach((i=>{var s;const o=n[e][r][i],a=o.thread_id&&o.thread_id!==S.MAIN_ROOM_TIMELINE?this.threads.get(null!==(s=o.thread_id)&&void 0!==s?s:""):this;null==a||a.addReceiptToStructure(e,r,i,o,t)}))}))})),this.emit(O.Receipt,e,this)}addEphemeralEvents(e){for(const t of e)t.getType()===f.EventType.Typing?this.currentState.setTypingEvent(t):t.getType()===f.EventType.Receipt&&this.addReceipt(t)}removeEvents(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])}removeEvent(e){let t=!1;for(let n=0;n<this.timelineSets.length;n++){const r=this.timelineSets[n].removeEvent(e);r&&(r.isRedaction()&&this.revertRedactionLocalEcho(r),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(f.EventType.RoomMember,this.myUserId);if(e){const t=e.getContent().membership;this.updateMyMembership(t),"invite"===t&&(e.getUnsigned().invite_room_state||[]).forEach((e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new l.MatrixEvent({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])}))}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,c.normalize)(this.name),this.summary=new h.RoomSummary(this.roomId,{title:this.name}),t!==this.name&&this.emit(O.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(O.Tags,e,this)}addAccountData(e){for(let t=0;t<e.length;t++){const n=e[t];"m.tag"===n.getType()&&this.addTags(n);const r=this.accountData[n.getType()];this.accountData[n.getType()]=n,this.emit(O.AccountData,n,this,r)}}getAccountData(e){return this.accountData[e]}maySendMessage(){return"join"===this.getMyMembership()&&(this.client.isRoomEncrypted(this.roomId)?this.currentState.maySendEvent(f.EventType.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(f.EventType.RoomMessage,this.myUserId))}canInvite(e){let t="join"===this.getMyMembership();const n=this.currentState.getStateEvents(f.EventType.RoomPowerLevels,""),r=n&&n.getContent(),i=this.getMember(e);return r&&i&&r.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(f.EventType.RoomCreate,"");if(e)return e.getContent()[f.RoomCreateTypeField];this.getTypeWarning||(p.logger.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===f.RoomType.Space}isCallRoom(){return this.getType()===f.RoomType.UnstableCall}isElementVideoRoom(){return this.getType()===f.RoomType.ElementVideo}roomNameGenerator(e){if(this.client.roomNameGenerator){const t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case D.Actual:return e.name;case D.Generated:return"Inviting"===e.subtype?`Inviting ${N(e.names,e.count)}`:N(e.names,e.count);case D.EmptyRoom:return e.oldName?`Empty room (was ${e.oldName})`:"Empty room"}}calculateRoomName(e,t=!1){if(!t){const e=this.currentState.getStateEvents(f.EventType.RoomName,"");if(null!=e&&e.getContent().name)return this.roomNameGenerator({type:D.Actual,name:e.getContent().name})}const n=this.getCanonicalAlias();if(n)return this.roomNameGenerator({type:D.Actual,name:n});let r=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,i=[];const s=this.currentState.getStateEvents(f.UNSTABLE_ELEMENT_FUNCTIONAL_USERS.name,"");Array.isArray(null==s?void 0:s.getContent().service_members)&&(i=s.getContent().service_members);let o=null;if(this.summaryHeroes)o=[],this.summaryHeroes.forEach((e=>{if(i.includes(e))return void r--;const t=this.getMember(e);o.push(t?t.name:e)}));else{let t=this.currentState.getMembers().filter((t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership)));t=t.filter((({userId:e})=>!i.includes(e)||(r--,!1))),t.sort(((e,t)=>c.compare(e.userId,t.userId))),t=t.slice(0,5),o=t.map((e=>e.name))}if(r)return this.roomNameGenerator({type:D.Generated,names:o,count:r});if("join"==this.getMyMembership()){const e=this.currentState.getStateEvents(f.EventType.RoomThirdPartyInvite);if(null!=e&&e.length){const t=e.map((e=>e.getContent().display_name));return this.roomNameGenerator({type:D.Generated,subtype:"Inviting",names:t,count:t.length+1})}}let a,l=o;return l.length||(l=this.currentState.getMembers().filter((t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership)).map((e=>e.name))),l.length&&(a=this.roomNameGenerator({type:D.Generated,names:l,count:l.length+1})),this.roomNameGenerator({type:D.EmptyRoom,oldName:a})}applyNewVisibilityEvent(e){const t=e.asVisibilityChange();if(!t)return;const n=e.getSender();if(!n)return;if(!(f.EVENT_VISIBILITY_CHANGE_TYPE.name&&this.currentState.maySendStateEvent(f.EVENT_VISIBILITY_CHANGE_TYPE.name,n)||f.EVENT_VISIBILITY_CHANGE_TYPE.altName&&this.currentState.maySendStateEvent(f.EVENT_VISIBILITY_CHANGE_TYPE.altName,n)))return;const r=this.visibilityEvents.get(t.eventId);if(r){let t=r.length-1;const n=Math.max(0,r.length-30);for(;t>=n&&!(r[t].getTs()<e.getTs());--t);-1===t?r.unshift(e):r.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);const i=this.findEventById(t.eventId);i&&i.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");const t=e.getRelation().event_id,n=this.visibilityEvents.get(t);if(!n)return;const r=n.findIndex((t=>t.getId()===e.getId()));if(-1!==r&&(n.splice(r,1),r===n.length)){const e=this.findEventById(t);if(!e)return;if(0===r)this.visibilityEvents.delete(t),e.applyVisibilityEvent();else{const t=n[n.length-1].asVisibilityChange();if(!t)throw new Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(t)}}}applyPendingVisibilityEvents(e){const t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;const n=t[t.length-1],r=n.asVisibilityChange();r&&(r.visible,n.getTs()<e.getTs()||e.applyVisibilityEvent(r))}}t.Room=C;const P={[u.EventStatus.ENCRYPTING]:[u.EventStatus.SENDING,u.EventStatus.NOT_SENT,u.EventStatus.CANCELLED],[u.EventStatus.SENDING]:[u.EventStatus.ENCRYPTING,u.EventStatus.QUEUED,u.EventStatus.NOT_SENT,u.EventStatus.SENT],[u.EventStatus.QUEUED]:[u.EventStatus.SENDING,u.EventStatus.CANCELLED],[u.EventStatus.SENT]:[],[u.EventStatus.NOT_SENT]:[u.EventStatus.SENDING,u.EventStatus.QUEUED,u.EventStatus.CANCELLED],[u.EventStatus.CANCELLED]:[]};let D;function N(e,t){const n=t-1;return e.length?1===e.length&&n<=1?e[0]:2===e.length&&n<=2?`${e[0]} and ${e[1]}`:n>1?`${e[0]} and ${n} others`:`${e[0]} and 1 other`:"Empty room"}t.RoomNameType=D,function(e){e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual"}(D||(t.RoomNameType=D={}))},1082:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchResult=void 0;var r=n(7790);class i{static fromJson(e,t){const n=e.context||{};let s=(n.events_before||[]).map(t),o=(n.events_after||[]).map(t);const a=new r.EventContext(t(e.result)),c=a.ourEvent.threadRootId;return s=s.filter((e=>e.threadRootId===c)),o=o.filter((e=>e.threadRootId===c)),a.setPaginateToken(n.start,!0),a.addEvents(s,!0),a.addEvents(o,!1),a.setPaginateToken(n.end,!1),new i(e.rank,a)}constructor(e,t){this.rank=e,this.context=t}}t.SearchResult=i},990:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.ThreadFilterType=t.ThreadEvent=t.Thread=t.THREAD_RELATION_TYPE=t.FILTER_RELATED_BY_SENDERS=t.FILTER_RELATED_BY_REL_TYPES=void 0;var i=r(n(3693)),s=n(2660),o=n(2300),a=n(224),c=n(6418),l=n(8931),u=n(7259),d=n(9849),h=n(103);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}let g;t.ThreadEvent=g,function(e){e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread"}(g||(t.ThreadEvent=g={}));class f extends h.ReadReceipt{constructor(e,t,n){var r;if(super(),this.id=e,this.rootEvent=t,(0,i.default)(this,"timelineSet",void 0),(0,i.default)(this,"_currentUserParticipated",!1),(0,i.default)(this,"reEmitter",void 0),(0,i.default)(this,"lastEvent",void 0),(0,i.default)(this,"replyCount",0),(0,i.default)(this,"room",void 0),(0,i.default)(this,"client",void 0),(0,i.default)(this,"initialEventsFetched",!f.hasServerSideSupport),(0,i.default)(this,"onBeforeRedaction",((e,t)=>{null!=e&&e.isRelation(y.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.emit(g.Update,this))})),(0,i.default)(this,"onRedaction",(e=>{var t;if(e.threadRootId!==this.id)return;const n=[...this.timelineSet.getLiveTimeline().getEvents()].reverse();this.lastEvent=null!==(t=n.find((e=>!e.isRedacted()&&e.isRelation(y.name))))&&void 0!==t?t:this.rootEvent,this.emit(g.Update,this)})),(0,i.default)(this,"onEcho",(e=>{if(e.threadRootId!==this.id)return;if(this.lastEvent===e)return;if(!e.isRelation(y.name))return;const t=e.isRelation(y.name);(!this.lastEvent||this.lastEvent.isRedacted()||t&&e.getId()!==this.lastEvent.getId()&&e.localTimestamp>this.lastEvent.localTimestamp)&&(this.lastEvent=e,this.lastEvent.getId()!==this.id&&(f.hasServerSideSupport&&this.replyCount++,this.emit(g.NewReply,this,e))),this.emit(g.Update,this)})),null==n||!n.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.timelineSet=new l.EventTimelineSet(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new o.TypedReEmitter(this),this.reEmitter.reEmit(this.timelineSet,[s.RoomEvent.Timeline,s.RoomEvent.TimelineReset]),this.room.on(s.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.room.on(s.RoomEvent.Redaction,this.onRedaction),this.room.on(s.RoomEvent.LocalEchoUpdated,this.onEcho),this.timelineSet.on(s.RoomEvent.Timeline,this.onEcho),n.initialEvents&&this.addEvents(n.initialEvents,!1),this.initialiseThread(),null===(r=this.rootEvent)||void 0===r||r.setThread(this)}async fetchRootEvent(){var e;this.rootEvent=this.room.findEventById(this.id);try{const e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){d.logger.error("Failed to fetch thread root to construct thread with",e)}null===(e=this.rootEvent)||void 0===e||e.setThread(this),this.emit(g.Update,this)}static setServerSideSupport(e,t){f.hasServerSideSupport=e,t||(m.setPreferUnstable(!0),v.setPreferUnstable(!0),y.setPreferUnstable(!0))}get roomState(){return this.room.getLiveTimeline().getState(c.EventTimeline.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}addEvents(e,t){e.forEach((e=>this.addEvent(e,t,!1))),this.emit(g.Update,this)}addEvent(e,t,n=!0){var r;if(e.setThread(this),this._currentUserParticipated||e.getSender()!==this.client.getUserId()||(this._currentUserParticipated=!0),f.hasServerSideSupport){if(!t&&this.initialEventsFetched&&e.localTimestamp>(null===(r=this.lastReply())||void 0===r?void 0:r.localTimestamp))this.fetchEditsWhereNeeded(e),this.addEventToTimeline(e,!1);else if(e.isRelation(s.RelationType.Annotation)||e.isRelation(s.RelationType.Replace))return this.timelineSet.relations.aggregateParentEvent(e),void this.timelineSet.relations.aggregateChildEvent(e,this.timelineSet)}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e,{});f.hasServerSideSupport&&this.rootEvent||!e.isRelation(y.name)||this.replyCount++,n&&this.emit(g.Update,this)}getRootEventBundledRelationship(e=this.rootEvent){return null==e?void 0:e.getServerAggregatedRelation(y.name)}async initialiseThread(){let e=this.getRootEventBundledRelationship();if(f.hasServerSideSupport&&!e&&(await this.fetchRootEvent(),e=this.getRootEventBundledRelationship()),f.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=e.current_user_participated;const t=new a.MatrixEvent(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({room_id:this.rootEvent.getRoomId()},e.latest_event));this.setEventMetadata(t),t.setThread(this),this.lastEvent=t,this.fetchEditsWhereNeeded(t)}this.emit(g.Update,this)}async fetchEditsWhereNeeded(...e){return Promise.all(e.filter((e=>e.isEncrypted())).map((e=>{if(!e.isRelation())return this.client.relations(this.roomId,e.getId(),s.RelationType.Replace,e.getType(),{limit:1}).then((t=>{t.events.length&&e.makeReplaced(t.events[0])})).catch((e=>{d.logger.error("Failed to load edits for encrypted thread event",e)}))})))}async fetchInitialEvents(){this.initialEventsFetched||(await this.fetchEvents(),this.initialEventsFetched=!0)}setEventMetadata(e){c.EventTimeline.setEventMetadata(e,this.roomState,!1),e.setThread(this)}findEventById(e){var t;return(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())===e?this.lastEvent:this.timelineSet.findEventById(e)}lastReply(e=()=>!0){for(let t=this.events.length-1;t>=0;t--){const n=this.events[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount}get replyToEvent(){var e;return null!==(e=this.lastEvent)&&void 0!==e?e:this.lastReply()}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof a.MatrixEvent}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}async fetchEvents(e={limit:20,direction:c.Direction.Backward}){var t;let{originalEvent:n,events:r,prevBatch:i,nextBatch:s}=await this.client.relations(this.room.roomId,this.id,y.name,null,e);e.to||s||(r=[...r,n]),await this.fetchEditsWhereNeeded(...r),await Promise.all(r.map((e=>(this.setEventMetadata(e),this.client.decryptEventIfNeeded(e)))));const o=(null!==(t=e.direction)&&void 0!==t?t:c.Direction.Backward)===c.Direction.Backward;return this.timelineSet.addEventsToTimeline(r,o,this.liveTimeline,o?s:i),{originalEvent:n,events:r,prevBatch:i,nextBatch:s}}getUnfilteredTimelineSet(){return this.timelineSet}get timeline(){return this.events}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}}t.Thread=f,(0,i.default)(f,"hasServerSideSupport",void 0);const m=new u.ServerControlledNamespacedValue("related_by_senders","io.element.relation_senders");t.FILTER_RELATED_BY_SENDERS=m;const v=new u.ServerControlledNamespacedValue("related_by_rel_types","io.element.relation_types");t.FILTER_RELATED_BY_REL_TYPES=v;const y=new u.ServerControlledNamespacedValue("m.thread","io.element.thread");let _;t.THREAD_RELATION_TYPE=y,t.ThreadFilterType=_,function(e){e[e.My=0]="My",e[e.All=1]="All"}(_||(t.ThreadFilterType=_={}))},7022:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventEmitter=t.EventEmitterEvents=void 0;var r=n(7007);let i;t.EventEmitterEvents=i,function(e){e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error"}(i||(t.EventEmitterEvents=i={}));class s extends r.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e,...t){return super.emit(e,...t)}eventNames(){return super.eventNames()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}t.TypedEventEmitter=s},8057:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.UserEvent=t.User=void 0;var i=r(n(3693)),s=n(7022);let o;t.UserEvent=o,function(e){e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs"}(o||(t.UserEvent=o={}));class a extends s.TypedEventEmitter{constructor(e){super(),this.userId=e,(0,i.default)(this,"modified",void 0),(0,i.default)(this,"displayName",void 0),(0,i.default)(this,"rawDisplayName",void 0),(0,i.default)(this,"avatarUrl",void 0),(0,i.default)(this,"presenceStatusMsg",null),(0,i.default)(this,"presence","offline"),(0,i.default)(this,"lastActiveAgo",0),(0,i.default)(this,"lastPresenceTs",0),(0,i.default)(this,"currentlyActive",!1),(0,i.default)(this,"events",{presence:null,profile:null}),this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.updateModifiedTime()}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const n=[];(e.getContent().presence!==this.presence||t)&&n.push(o.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(o.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(o.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push(o.CurrentlyActive),this.presence=e.getContent().presence,n.push(o.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(let t=0;t<n.length;t++)this.emit(n[t],e,this)}setDisplayName(e){const t=this.displayName;this.displayName="string"==typeof e?e:void 0,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName="string"==typeof e?e:void 0}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}t.User=a},5889:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.PushProcessor=void 0;var i=r(n(3693)),s=n(4148),o=n(9849),a=n(2496),c=n(4703);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const d=[a.PushRuleKind.Override,a.PushRuleKind.ContentSpecific,a.PushRuleKind.RoomSpecific,a.PushRuleKind.SenderSpecific,a.PushRuleKind.Underride],h=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:a.ConditionKind.EventMatch,key:"type",pattern:"m.reaction"}],actions:[a.PushRuleActionName.DontNotify]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:a.ConditionKind.EventMatch,key:"type",pattern:c.EventType.RoomServerAcl},{kind:a.ConditionKind.EventMatch,key:"state_key",pattern:""}],actions:[]}];class p{constructor(e){this.client=e}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(let n=0;n<e.length;++n){const r=e[n];r===a.PushRuleActionName.Notify?t.notify=!0:"object"==typeof r&&(void 0===r.value&&(r.value=!0),t.tweaks[r.set_tweak]=r.value)}return t}static rewriteDefaultRules(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const n=t.global.override;for(const e of h){const t=n.find((t=>t.rule_id===e.rule_id));if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;o.logger.warn(`Adding default global override for ${t}`),n.push(e)}}return t}matchingRuleFromKindSet(e,t){for(let n=0;n<d.length;++n){const r=d[n],i=t[r];if(i)for(let t=0;t<i.length;++t){const n=i[t];if(!n.enabled)continue;const s=this.templateRuleToRaw(r,n);if(s&&this.ruleMatchesEvent(s,e))return u(u({},n),{},{kind:r})}}return null}templateRuleToRaw(e,t){const n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case a.PushRuleKind.Underride:case a.PushRuleKind.Override:n.conditions=t.conditions;break;case a.PushRuleKind.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.ConditionKind.EventMatch,key:"room_id",value:t.rule_id});break;case a.PushRuleKind.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.ConditionKind.EventMatch,key:"user_id",value:t.rule_id});break;case a.PushRuleKind.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:a.ConditionKind.EventMatch,key:"content.body",pattern:t.pattern})}return n}eventFulfillsCondition(e,t){switch(e.kind){case a.ConditionKind.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case a.ConditionKind.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case a.ConditionKind.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case a.ConditionKind.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const n=e.key;if(!n)return!1;const r=this.client.getRoom(t.getRoomId());return!(null==r||!r.currentState)&&r.currentState.mayTriggerNotifOfType(n,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;const r=n.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)(\d*)$/);if(!i)return!1;const s=i[1],o=parseInt(i[2]);if(isNaN(o))return!1;switch(s){case"":case"==":return r==o;case"<":return r<o;case">":return r>o;case"<=":return r<=o;case">=":return r>=o;default:return!1}}eventFulfillsDisplayNameCondition(e,t){let n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;const r=this.client.getRoom(t.getRoomId());if(!(r&&r.currentState&&r.currentState.members&&r.currentState.getMember(this.client.credentials.userId)))return!1;const i=r.currentState.getMember(this.client.credentials.userId).name,o=new RegExp("(^|\\W)"+(0,s.escapeRegExp)(i)+"(\\W|$)","i");return n.body.search(o)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const n=this.valueForDottedKey(e.key,t);if("string"!=typeof n)return!1;if(e.value)return e.value===n;if("string"!=typeof e.pattern)return!1;const r="content.body"===e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!n.match(r)}createCachedRegex(e,t,n){return p.cachedGlobToRegex[t]||(p.cachedGlobToRegex[t]=new RegExp(e+(0,s.globToRegexp)(t)+n,"i")),p.cachedGlobToRegex[t]}valueForDottedKey(e,t){const n=e.split(".");let r;const i=n[0];for("content"===i?(r=t.getContent(),n.shift()):"type"===i?(r=t.getType(),n.shift()):r=t.event;n.length>0;){const e=n.shift();if((0,s.isNullOrUndefined)(r[e]))return null;r=r[e]}return r}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.credentials.userId?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){const n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};const r=p.actionListToActionsObject(n.actions);return void 0===r.tweaks.highlight&&(r.tweaks.highlight=n.kind==a.PushRuleKind.ContentSpecific),r}ruleMatchesEvent(e,t){var n;if(null===(n=e.conditions)||void 0===n||!n.length)return!0;let r=!0;for(let n=0;n<e.conditions.length;++n){const i=e.conditions[n];r&=this.eventFulfillsCondition(i,t)}return r}actionsForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){for(const t of["global"])if(void 0!==this.client.pushRules[t])for(const n of d)if(void 0!==this.client.pushRules[t][n])for(const r of this.client.pushRules[t][n])if(r.rule_id===e)return r;return null}}t.PushProcessor=p,(0,i.default)(p,"cachedGlobToRegex",{})},3759:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomLowercaseString=function(e){return s(e,n)},t.randomString=function(e){return s(e,r+n+i)},t.randomUppercaseString=function(e){return s(e,r)};const n="abcdefghijklmnopqrstuvwxyz",r="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i="0123456789";function s(e,t){let n="";for(let r=0;r<e;++r)n+=t.charAt(Math.floor(Math.random()*t.length));return n}},2485:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clearTimeout=function(e){if(0===a.length)return;let t;for(t=0;t<a.length;t++)if(a[t].key==e){a.splice(t,1);break}0===t&&l()},t.setTimeout=function(e,t,...n){(t=t||0)<0&&(t=0);const r=Date.now()+t,i=o++;c("setTimeout: scheduling cb",i,"at",r,"(delay",t,")");const s={runAt:r,func:e,params:n,key:i},u=function(e){let t=0,n=e.length;for(;t<n;){const i=t+n>>1;e[i].runAt-r>0?n=i:t=i+1}return t}(a);return a.splice(u,0,s),l(),i};var r=n(9849);const i=1e3;let s,o=0;const a=[],c=function(...e){};function l(){s&&n.g.clearTimeout(s);const e=a[0];if(!e)return void c("scheduleRealCallback: no more callbacks, not rescheduling");const t=Date.now(),r=Math.min(e.runAt-t,i);c("scheduleRealCallback: now:",t,"delay:",r),s=n.g.setTimeout(u,r)}function u(){let e;const t=Date.now();c("runCallbacks: now:",t);const i=[];for(;;){const n=a[0];if(!n||n.runAt>t)break;e=a.shift(),c("runCallbacks: popping",e.key),i.push(e)}l();for(let t=0;t<i.length;t++){e=i[t];try{e.func.apply(n.g,e.params)}catch(e){r.logger.error("Uncaught exception in callback function",e.stack||e)}}}},7703:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixScheduler=void 0;var i=r(n(3693)),s=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=a(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148)),o=(n(9849),n(4703));function a(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(a=function(e){return e?n:t})(e)}class c{static RETRY_BACKOFF_RATELIMIT(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus)return-1;if("rejected"===n.cors)return-1;if("M_TOO_LARGE"===n.name)return-1;if("M_LIMIT_EXCEEDED"===n.name){const e=n.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)}static QUEUE_MESSAGES(e){return e.getType()===o.EventType.RoomMessage||e.hasAssocation()?"message":null}constructor(e=c.RETRY_BACKOFF_RATELIMIT,t=c.QUEUE_MESSAGES){this.retryAlgorithm=e,this.queueAlgorithm=t,(0,i.default)(this,"queues",{}),(0,i.default)(this,"activeQueues",[]),(0,i.default)(this,"procFn",null),(0,i.default)(this,"processQueue",(e=>{const t=this.peekNextEvent(e);if(!t){const t=this.activeQueues.indexOf(e);return t>=0&&this.activeQueues.splice(t,1),void l()}l(this.queues[e].length),Promise.resolve().then((()=>this.procFn(t.event))).then((n=>{this.removeNextEvent(e),l(t.event.getId()),t.defer.resolve(n),this.processQueue(e)}),(n=>{t.attempts+=1;const r=this.retryAlgorithm(t.event,t.attempts,n);l(t.attempts,t.event.getId()),-1===r?(l(t.event.getId()),this.removeNextEvent(e),t.defer.reject(n),this.processQueue(e)):setTimeout(this.processQueue,r,e)}))}))}getQueueForEvent(e){const t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let n=!1;return s.removeElement(this.queues[t],(t=>{if(t.event.getId()===e.getId())return n=!0,!0})),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const n=s.defer();return this.queues[t].push({event:e,defer:n,attempts:0}),l(e.getId()),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter((e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0)).forEach((e=>{this.activeQueues.push(e),l(),this.processQueue(e)}))}peekNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t[0]:null}removeNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t.shift():null}}function l(...e){}t.MatrixScheduler=c},2118:(e,t)=>{"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.SERVICE_TYPES=void 0,t.SERVICE_TYPES=n,function(e){e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM"}(n||(t.SERVICE_TYPES=n={}))},9818:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SlidingSyncSdk=void 0;var i=r(n(3693)),s=n(5489),o=n(9849),a=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=f(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148)),c=n(6418),l=n(642),u=n(7314),d=n(84),h=n(9063),p=n(2660),g=n(5889);function f(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(f=function(e){return e?n:t})(e)}class m{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return h.ExtensionState.PreProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(e.device_lists&&await this.crypto.handleDeviceListChanges({oldSyncToken:"yep"},e.device_lists),e.device_one_time_keys_count){const t=e.device_one_time_keys_count.signed_curve25519||0;this.crypto.updateOneTimeKeyCount(t)}if(e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]){const t=e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"];this.crypto.setNeedsNewFallback(t instanceof Array&&!t.includes("signed_curve25519"))}}}class v{constructor(e){this.client=e,(0,i.default)(this,"nextBatch",null)}name(){return"to_device"}when(){return h.ExtensionState.PreProcess}onRequest(e){const t={since:null!==this.nextBatch?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}async onResponse(e){const t=[];e.events=e.events||[],e.events.map(this.client.getEventMapper()).map((e=>{if("m.key.verification.cancel"===e.getType()){const n=e.getContent().transaction_id;n&&t.push(n)}return e})).forEach((e=>{const n=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){const r=n.transaction_id;t.includes(r)&&e.flagCancelled()}this.client.emit(l.ClientEvent.ToDeviceEvent,e)}else o.logger.log("Ignoring undecryptable to-device event from "+e.getSender())})),this.nextBatch=e.next_batch}}class y{constructor(e){this.client=e}name(){return"account_data"}when(){return h.ExtensionState.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){e.global&&e.global.length>0&&this.processGlobalAccountData(e.global);for(const t in e.rooms){const n=_(this.client,t,e.rooms[t]),r=this.client.getRoom(t);r?(r.addAccountData(n),n.forEach((e=>{this.client.emit(l.ClientEvent.Event,e)}))):o.logger.warn("got account data for room but room doesn't exist on client:",t)}}processGlobalAccountData(e){const t=_(this.client,void 0,e),n=t.reduce(((e,t)=>(e[t.getId()]=this.client.store.getAccountData(t.getType()),e)),{});this.client.store.storeAccountDataEvents(t),t.forEach((e=>{if(e.getType()===p.EventType.PushRules){const t=e.getContent();this.client.pushRules=g.PushProcessor.rewriteDefaultRules(t)}const t=n[e.getId()];return this.client.emit(l.ClientEvent.AccountData,e,t),e}))}}function _(e,t,n,r=!0){const i=e.getEventMapper({decrypt:r});return n.map((function(e){return e.room_id=t,i(e)}))}t.SlidingSyncSdk=class{constructor(e,t,n={}){var r;this.slidingSync=e,this.client=t,this.opts=n,(0,i.default)(this,"syncState",null),(0,i.default)(this,"syncStateData",void 0),(0,i.default)(this,"lastPos",null),(0,i.default)(this,"failCount",0),(0,i.default)(this,"notifEvents",[]),this.opts.initialSyncLimit=null!==(r=this.opts.initialSyncLimit)&&void 0!==r?r:8,this.opts.resolveInvitesToProfiles=this.opts.resolveInvitesToProfiles||!1,this.opts.pollTimeout=this.opts.pollTimeout||3e4,this.opts.pendingEventOrdering=this.opts.pendingEventOrdering||l.PendingEventOrdering.Chronological,this.opts.experimentalThreadSupport=!0===this.opts.experimentalThreadSupport,n.canResetEntireTimeline||(n.canResetEntireTimeline=e=>!1),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[s.RoomEvent.Timeline,s.RoomEvent.TimelineReset]),this.slidingSync.on(h.SlidingSyncEvent.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(h.SlidingSyncEvent.RoomData,this.onRoomData.bind(this));const o=[new v(this.client),new y(this.client)];this.opts.crypto&&o.push(new m(this.opts.crypto)),o.forEach((e=>{this.slidingSync.registerExtension(e)}))}onRoomData(e,t){let n=this.client.store.getRoom(e);if(!n){if(!t.initial)return void o.logger.debug("initial flag not set but no stored room exists for room ",e,t);n=(0,u._createAndReEmitRoom)(this.client,e,this.opts)}this.processRoomData(this.client,n,t)}onLifecycle(e,t,n){switch(n&&o.logger.debug("onLifecycle",e,n),e){case h.SlidingSyncState.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(u.SyncState.Prepared,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(u.SyncState.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case h.SlidingSyncState.RequestFinished:if(n){if(this.failCount+=1,this.updateSyncState(this.failCount>3?u.SyncState.Error:u.SyncState.Reconnecting,{error:new d.MatrixError(n)}),this.shouldAbortSync(new d.MatrixError(n)))return}else this.failCount=0}}async syncLeftRooms(){return[]}async peek(e){return null}stopPeeking(){}getSyncState(){return this.syncState}getSyncStateData(){return this.syncStateData}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(o.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(u.SyncState.Error,{error:e}),!0)}async processRoomData(e,t,n){n=function(e,t,n){if(!n.name)return n;for(const e of n.required_state)if(e.type===p.EventType.RoomName&&""===e.state_key)return e.content={name:n.name},n;return n.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:p.EventType.RoomName,content:{name:n.name},sender:e.getUserId(),origin_server_ts:(new Date).getTime()}),n}(e,t.roomId,n);const r=_(this.client,t.roomId,n.required_state);let i=_(this.client,t.roomId,n.timeline,!1);const o=[];if(n.initial){const e=new Set;t.getLiveTimeline().getEvents().forEach((t=>{e.add(t.getId())}));const r=[],s=[];let o=!1;for(let t=i.length-1;t>=0;t--){const n=i[t];e.has(n.getId())?o=!0:o?r.push(n):s.unshift(n)}i=s,r.length>0&&t.addEventsToTimeline(r,!0,t.getLiveTimeline(),n.prev_batch)}const u=this.client.isRoomEncrypted(t.roomId);if(null!=n.notification_count&&t.setUnreadNotificationCount(s.NotificationCountType.Total,n.notification_count),null!=n.highlight_count&&(!u||u&&t.getUnreadNotificationCount(s.NotificationCountType.Highlight)<=0)&&t.setUnreadNotificationCount(s.NotificationCountType.Highlight,n.highlight_count),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){const e=_(this.client,t.roomId,n.invite_state);return this.processRoomEvents(t,e),n.initial&&(t.recalculate(),this.client.store.storeRoom(t),this.client.emit(l.ClientEvent.Room,t)),e.forEach((e=>{this.client.emit(l.ClientEvent.Event,e)})),void t.updateMyMembership("invite")}n.initial&&t.getLiveTimeline().setPaginationToken(n.prev_batch,c.EventTimeline.BACKWARDS),this.processRoomEvents(t,r,i,!1),t.addEphemeralEvents(o),t.updateMyMembership("join"),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(l.ClientEvent.Room,t)),this.addNotifications(i);const d=async t=>{e.emit(l.ClientEvent.Event,t),t.isState()&&t.getType()==p.EventType.RoomEncryption&&this.opts.crypto&&await this.opts.crypto.onCryptoEvent(t)};await a.promiseMapSeries(r,d),await a.promiseMapSeries(i,d),o.forEach((function(t){e.emit(l.ClientEvent.Event,t)})),t.decryptCriticalEvents()}processRoomEvents(e,t,n,r=!1){n=n||[],t=t||[];const i=e.getLiveTimeline(),s=0==i.getEvents().length;if(s){for(const e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t)}s||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t)),e.addLiveEvents(n,{fromCache:r}),e.recalculate(),this.resolveInvites(e)}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n._requestedProfileInfo)return;n._requestedProfileInfo=!0;const r=t.getUser(n.userId);let i;i=r?Promise.resolve({avatar_url:r.avatarUrl,displayname:r.displayName}):t.getProfileInfo(n.userId),i.then((function(t){const r=n.events.member;"invite"===r.getContent().membership&&(r.getContent().avatar_url=t.avatar_url,r.getContent().displayname=t.displayname,n.setMembershipEvent(r,e.currentState))}),(function(e){}))}))}retryImmediately(){return!0}async sync(){for(o.logger.debug("Sliding sync init loop");!this.client.isGuest();)try{o.logger.debug("Getting push rules...");const e=await this.client.getPushRules();o.logger.debug("Got push rules"),this.client.pushRules=e;break}catch(e){if(o.logger.error("Getting push rules failed",e),this.shouldAbortSync(e))return}await this.slidingSync.start()}stop(){o.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){const n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(l.ClientEvent.Sync,this.syncState,n,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(const t of e){const e=this.client.getPushActionsForEvent(t);e&&e.notify&&e.tweaks&&e.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((e=>{this.client.getNotifTimelineSet().addLiveEvent(e)})),this.notifEvents=[]}}},9063:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SlidingSyncState=t.SlidingSyncEvent=t.SlidingSync=t.ExtensionState=void 0;var i=r(n(3693)),s=n(9849),o=n(7022),a=n(4148);function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let u,d,h;t.SlidingSyncState=u,function(e){e.RequestFinished="FINISHED",e.Complete="COMPLETE"}(u||(t.SlidingSyncState=u={}));class p{constructor(e){(0,i.default)(this,"list",void 0),(0,i.default)(this,"isModified",void 0),(0,i.default)(this,"roomIndexToRoomId",void 0),(0,i.default)(this,"joinedCount",void 0),this.replaceList(e)}setModified(e){this.isModified=e}updateListRange(e){this.list.ranges=JSON.parse(JSON.stringify(e))}replaceList(e){e.filters=e.filters||{},e.ranges=e.ranges||[],this.list=JSON.parse(JSON.stringify(e)),this.isModified=!0,this.roomIndexToRoomId={},this.joinedCount=0}getList(e){let t={ranges:JSON.parse(JSON.stringify(this.list.ranges))};return(this.isModified||e)&&(t=JSON.parse(JSON.stringify(this.list))),t}isIndexInRange(e){for(const t of this.list.ranges)if(t[0]<=e&&e<=t[1])return!0;return!1}}t.ExtensionState=d,function(e){e.PreProcess="ExtState.PreProcess",e.PostProcess="ExtState.PostProcess"}(d||(t.ExtensionState=d={})),t.SlidingSyncEvent=h,function(e){e.RoomData="SlidingSync.RoomData",e.Lifecycle="SlidingSync.Lifecycle",e.List="SlidingSync.List"}(h||(t.SlidingSyncEvent=h={}));class g extends o.TypedEventEmitter{constructor(e,t,n,r,s){super(),this.proxyBaseUrl=e,this.roomSubscriptionInfo=n,this.client=r,this.timeoutMS=s,(0,i.default)(this,"lists",void 0),(0,i.default)(this,"listModifiedCount",0),(0,i.default)(this,"terminated",!1),(0,i.default)(this,"needsResend",!1),(0,i.default)(this,"txnId",null),(0,i.default)(this,"txnIdDefers",[]),(0,i.default)(this,"extensions",{}),(0,i.default)(this,"desiredRoomSubscriptions",new Set),(0,i.default)(this,"confirmedRoomSubscriptions",new Set),(0,i.default)(this,"pendingReq",void 0),this.lists=t.map((e=>new p(e)))}listLength(){return this.lists.length}getListData(e){return this.lists[e]?{joinedCount:this.lists[e].joinedCount,roomIndexToRoomId:Object.assign({},this.lists[e].roomIndexToRoomId)}:null}getList(e){return this.lists[e]?this.lists[e].getList(!0):null}setListRanges(e,t){return this.lists[e].updateListRange(t),this.resend()}setList(e,t){return this.lists[e]?this.lists[e].replaceList(t):this.lists[e]=new p(t),this.listModifiedCount+=1,this.resend()}getRoomSubscriptions(){return new Set(Array.from(this.desiredRoomSubscriptions))}modifyRoomSubscriptions(e){return this.desiredRoomSubscriptions=e,this.resend()}modifyRoomSubscriptionInfo(e){return this.roomSubscriptionInfo=e,this.confirmedRoomSubscriptions=new Set,this.resend()}registerExtension(e){if(this.extensions[e.name()])throw new Error(`registerExtension: ${e.name()} already exists as an extension`);this.extensions[e.name()]=e}getExtensionRequest(e){const t={};return Object.keys(this.extensions).forEach((n=>{t[n]=this.extensions[n].onRequest(e)})),t}onPreExtensionsResponse(e){Object.keys(e).forEach((t=>{this.extensions[t].when()==d.PreProcess&&this.extensions[t].onResponse(e[t])}))}onPostExtensionsResponse(e){Object.keys(e).forEach((t=>{this.extensions[t].when()==d.PostProcess&&this.extensions[t].onResponse(e[t])}))}invokeRoomDataListeners(e,t){t.required_state||(t.required_state=[]),t.timeline||(t.timeline=[]),this.emit(h.RoomData,e,t)}invokeLifecycleListeners(e,t,n){this.emit(h.Lifecycle,e,t,n)}shiftRight(e,t,n){for(let r=t;r>n;r--)this.lists[e].isIndexInRange(r)&&(this.lists[e].roomIndexToRoomId[r]=this.lists[e].roomIndexToRoomId[r-1])}shiftLeft(e,t,n){for(let r=n;r<t;r++)this.lists[e].isIndexInRange(r)&&(this.lists[e].roomIndexToRoomId[r]=this.lists[e].roomIndexToRoomId[r+1])}removeEntry(e,t){let n=-1;for(const t in this.lists[e].roomIndexToRoomId)Number(t)>n&&(n=Number(t));n<0||t>n||(this.shiftLeft(e,n,t),delete this.lists[e].roomIndexToRoomId[n])}addEntry(e,t){let n=-1;for(const t in this.lists[e].roomIndexToRoomId)Number(t)>n&&(n=Number(t));n<0||t>n||this.shiftRight(e,n+1,t)}processListOps(e,t){let n=-1;e.ops.forEach((e=>{switch(e.op){case"DELETE":s.logger.debug("DELETE",t,e.index,";"),delete this.lists[t].roomIndexToRoomId[e.index],-1!==n&&this.removeEntry(t,n),n=e.index;break;case"INSERT":s.logger.debug("INSERT",t,e.index,e.room_id,";"),this.lists[t].roomIndexToRoomId[e.index]&&(n<0?this.addEntry(t,e.index):n>e.index?this.shiftRight(t,n,e.index):n<e.index&&this.shiftLeft(t,e.index,n),n=-1),this.lists[t].roomIndexToRoomId[e.index]=e.room_id;break;case"INVALIDATE":for(let n=e.range[0];n<=e.range[1];n++)delete this.lists[t].roomIndexToRoomId[n];s.logger.debug("INVALIDATE",t,e.range[0],e.range[1],";");break;case"SYNC":{const n=e.range[0];for(let r=n;r<=e.range[1];r++){const i=e.room_ids[r-n];if(!i)break;this.lists[t].roomIndexToRoomId[r]=i}s.logger.debug("SYNC",t,e.range[0],e.range[1],(e.room_ids||[]).join(" "),";");break}}})),-1!==n&&this.removeEntry(t,n)}resend(){var e;if(this.needsResend&&this.txnIdDefers.length>0)return this.txnIdDefers[this.txnIdDefers.length-1].promise;this.needsResend=!0,this.txnId=this.client.makeTxnId();const t=(0,a.defer)();return this.txnIdDefers.push(l(l({},t),{},{txnId:this.txnId})),null===(e=this.pendingReq)||void 0===e||e.abort(),t.promise}resolveTransactionDefers(e){if(!e)return;let t=-1;for(let n=0;n<this.txnIdDefers.length;n++)if(this.txnIdDefers[n].txnId===e){t=n;break}if(-1!==t){for(let e=0;e<t;e++)this.txnIdDefers[e].reject(this.txnIdDefers[e].txnId);this.txnIdDefers[t].resolve(e),this.txnIdDefers=this.txnIdDefers.slice(t+1)}else s.logger.warn(`resolveTransactionDefers: seen ${e} but it isn't a pending txn, ignoring.`)}stop(){var e;this.terminated=!0,null===(e=this.pendingReq)||void 0===e||e.abort(),this.removeAllListeners(h.Lifecycle),this.removeAllListeners(h.List),this.removeAllListeners(h.RoomData)}async start(){let e;for(;!this.terminated;){this.needsResend=!1;let t,n=!1;try{const r=this.listModifiedCount,i={lists:this.lists.map((e=>e.getList(!1))),pos:e,timeout:this.timeoutMS,clientTimeout:this.timeoutMS+1e4,extensions:this.getExtensionRequest(void 0===e)},o=f(this.desiredRoomSubscriptions,this.confirmedRoomSubscriptions),a=f(this.confirmedRoomSubscriptions,this.desiredRoomSubscriptions);if(a.size>0&&(i.unsubscribe_rooms=Array.from(a)),o.size>0){i.room_subscriptions={};for(const e of o)i.room_subscriptions[e]=this.roomSubscriptionInfo}this.txnId&&(i.txn_id=this.txnId,this.txnId=null),this.pendingReq=this.client.slidingSync(i,this.proxyBaseUrl),t=await this.pendingReq,s.logger.debug(t),e=t.pos;for(const e of o)this.confirmedRoomSubscriptions.add(e);for(const e of a)this.confirmedRoomSubscriptions.delete(e);r!==this.listModifiedCount&&(s.logger.debug("list modified during await call, not updating list"),n=!0),this.lists.forEach((e=>{e.setModified(!1)})),t.lists=t.lists||[],t.rooms=t.rooms||{},t.extensions=t.extensions||{},t.lists.forEach(((e,t)=>{this.lists[t].joinedCount=e.count})),this.invokeLifecycleListeners(u.RequestFinished,t)}catch(e){if(e.httpStatus)this.invokeLifecycleListeners(u.RequestFinished,null,e),await(0,a.sleep)(3e3);else{if(this.needsResend||"aborted"===e)continue;s.logger.error(e),await(0,a.sleep)(3e3)}}if(!t)continue;this.onPreExtensionsResponse(t.extensions),Object.keys(t.rooms).forEach((e=>{this.invokeRoomDataListeners(e,t.rooms[e])}));const r=new Set;n||t.lists.forEach(((e,t)=>{e.ops=e.ops||[],e.ops.length>0&&r.add(t),this.processListOps(e,t)})),this.invokeLifecycleListeners(u.Complete,t),this.onPostExtensionsResponse(t.extensions),r.forEach((e=>{this.emit(h.List,e,this.lists[e].joinedCount,Object.assign({},this.lists[e].roomIndexToRoomId))})),this.resolveTransactionDefers(t.txn_id)}}}t.SlidingSync=g;const f=(e,t)=>{const n=new Set(e);for(const e of t)n.delete(e);return n}},2415:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.LocalIndexedDBStoreBackend=void 0;var i=r(n(3693)),s=n(4589),o=u(n(4148)),a=u(n(7038)),c=n(9849);function l(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(l=function(e){return e?n:t})(e)}function u(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=l(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}const d=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],h=d.length;function p(e,t,n){const r=e.openCursor(t);return new Promise(((e,t)=>{const i=[];r.onerror=()=>{t(new Error("Query failed: "+r.error))},r.onsuccess=()=>{const t=r.result;t?(i.push(n(t)),t.continue()):e(i)}}))}function g(e){return new Promise(((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function f(e){return new Promise(((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function m(e){return f(e).then((t=>e.result))}t.LocalIndexedDBStoreBackend=class{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),a.exists(e,t)}constructor(e,t){this.indexedDB=e,(0,i.default)(this,"dbName",void 0),(0,i.default)(this,"syncAccumulator",void 0),(0,i.default)(this,"db",null),(0,i.default)(this,"disconnected",!0),(0,i.default)(this,"_isNewlyCreated",!1),(0,i.default)(this,"isPersisting",!1),(0,i.default)(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+(t||"default"),this.syncAccumulator=new s.SyncAccumulator}connect(){if(!this.disconnected)return c.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,c.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this.dbName,h);return e.onupgradeneeded=t=>{const n=e.result,r=t.oldVersion;c.logger.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${r}`),r<1&&(this._isNewlyCreated=!0),d.forEach(((e,t)=>{r<=t&&e(n)}))},e.onblocked=()=>{c.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},c.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),f(e).then((()=>(c.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.result,this.db.onversionchange=()=>{this.db.close()},this.init())))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then((([e,t])=>{c.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,account_data:{events:e}},!0)}))}getOutOfBandMembers(e){return new Promise(((t,n)=>{const r=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),s=r.openCursor(i),o=[];let a=!1;s.onsuccess=()=>{const e=s.result;if(!e)return o.length||a?t(o):t(null);const n=e.value;n.oob_written?a=!0:o.push(n),e.continue()},s.onerror=e=>{n(e)}})).then((t=>(c.logger.log(`LL: got ${null==t?void 0:t.length} membershipEvents from storage for room ${e} ...`),t)))}async setOutOfBandMembers(e,t){c.logger.log(`LL: backend about to store ${t.length} members for ${e}`);const n=this.db.transaction(["oob_membership_events"],"readwrite"),r=n.objectStore("oob_membership_events");t.forEach((e=>{r.put(e)}));const i={room_id:e,oob_written:!0,state_key:0};r.put(i),await g(n),c.logger.log(`LL: backend done storing for ${e}!`)}async clearOutOfBandMembers(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),n=IDBKeyRange.only(e),r=m(t.openKeyCursor(n,"next")).then((e=>e&&e.primaryKey[1])),i=m(t.openKeyCursor(n,"prev")).then((e=>e&&e.primaryKey[1])),[s,o]=await Promise.all([r,i]),a=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),l=IDBKeyRange.bound([e,s],[e,o]);var u;c.logger.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,s],[e,o]),await(u=a.delete(l),new Promise(((e,t)=>{u.onsuccess=()=>e(u),u.onerror=e=>t(e)})))}clearDatabase(){return new Promise((e=>{c.logger.log(`Removing indexeddb instance: ${this.dbName}`);const t=this.indexedDB.deleteDatabase(this.dbName);t.onblocked=()=>{c.logger.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},t.onerror=()=>{c.logger.warn(`unable to delete js-sdk store indexeddb: ${t.error}`),e()},t.onsuccess=()=>{c.logger.log(`Removed indexeddb instance: ${this.dbName}`),e()}}))}getSavedSync(e=!0){const t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(o.deepCopy(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then((()=>{this.syncAccumulator.accumulate(e)}))}async syncToDatabase(e){if(this.isPersisting)return c.logger.warn("Skipping syncToDatabase() as persist already in flight"),void this.pendingUserPresenceData.push(...e);e.unshift(...this.pendingUserPresenceData),this.isPersisting=!0;try{const t=this.syncAccumulator.getJSON(!0);await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t.nextBatch,t.roomsData)])}finally{this.isPersisting=!1}}persistSyncData(e,t){return c.logger.log("Persisting sync data up to",e),o.promiseTry((()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),g(n).then((()=>{c.logger.log("Persisted sync data up to",e)}))}))}persistAccountData(e){return o.promiseTry((()=>{const t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(let t=0;t<e.length;t++)n.put(e[t]);return g(t).then()}))}persistUserPresenceEvents(e){return o.promiseTry((()=>{const t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(const t of e)n.put({userId:t[0],event:t[1]});return g(t).then()}))}getUserPresenceEvents(){return o.promiseTry((()=>p(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,(e=>[e.value.userId,e.value.event]))))}loadAccountData(){return c.logger.log("LocalIndexedDBStoreBackend: loading account data..."),o.promiseTry((()=>p(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(e=>e.value)).then((e=>(c.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e)))))}loadSyncData(){return c.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),o.promiseTry((()=>p(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(e=>e.value)).then((e=>(c.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&c.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))))}getClientOptions(){return Promise.resolve().then((()=>p(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options})).then((e=>e[0]))))}async storeClientOptions(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await g(t)}async saveToDeviceBatches(e){const t=this.db.transaction(["to_device_queue"],"readwrite"),n=t.objectStore("to_device_queue");for(const t of e)n.add(t);await g(t)}async getOldestToDeviceBatch(){const e=this.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),t=await m(e.openCursor());if(!t)return null;const n=t.value;return{id:t.key,txnId:n.txnId,eventType:n.eventType,batch:n.batch}}async removeToDeviceBatch(e){const t=this.db.transaction(["to_device_queue"],"readwrite");t.objectStore("to_device_queue").delete(e),await g(t)}}},6290:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteIndexedDBStoreBackend=void 0;var i=r(n(3693)),s=n(9849),o=n(4148);t.RemoteIndexedDBStoreBackend=class{constructor(e,t){this.workerFactory=e,this.dbName=t,(0,i.default)(this,"worker",void 0),(0,i.default)(this,"nextSeq",0),(0,i.default)(this,"inFlight",{}),(0,i.default)(this,"startPromise",null),(0,i.default)(this,"onWorkerMessage",(e=>{const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void s.logger.error("Got reply from worker with no seq");const e=this.inFlight[t.seq];if(void 0===e)return void s.logger.error("Got reply for unknown seq "+t.seq);if(delete this.inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const n=new Error(t.error.message);n.name=t.error.name,e.reject(n)}}else s.logger.warn("Unrecognised message from worker: ",t)}))}connect(){return this.ensureStarted().then((()=>this.doCmd("connect")))}clearDatabase(){return this.ensureStarted().then((()=>this.doCmd("clearDatabase")))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}async saveToDeviceBatches(e){return this.doCmd("saveToDeviceBatches",[e])}async getOldestToDeviceBatch(){return this.doCmd("getOldestToDeviceBatch")}async removeToDeviceBatch(e){return this.doCmd("removeToDeviceBatch",[e])}ensureStarted(){return null===this.startPromise&&(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("_setupWorker",[this.dbName]).then((()=>{s.logger.log("IndexedDB worker is ready")}))),this.startPromise}doCmd(e,t){return Promise.resolve().then((()=>{const n=this.nextSeq++,r=(0,o.defer)();return this.inFlight[n]=r,this.worker.postMessage({command:e,seq:n,args:t}),r.promise}))}}},3764:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBStore=void 0;var i=r(n(3693)),s=n(6124),o=n(2415),a=n(6290),c=n(8057),l=n(224),u=n(9849),d=n(7022);class h extends s.MemoryStore{static exists(e,t){return o.LocalIndexedDBStoreBackend.exists(e,t)}constructor(e){if(super(e),(0,i.default)(this,"backend",void 0),(0,i.default)(this,"startedUp",!1),(0,i.default)(this,"syncTs",0),(0,i.default)(this,"userModifiedMap",{}),(0,i.default)(this,"emitter",new d.TypedEventEmitter),(0,i.default)(this,"on",this.emitter.on.bind(this.emitter)),(0,i.default)(this,"getSavedSync",this.degradable((()=>this.backend.getSavedSync()),"getSavedSync")),(0,i.default)(this,"isNewlyCreated",this.degradable((()=>this.backend.isNewlyCreated()),"isNewlyCreated")),(0,i.default)(this,"getSavedSyncToken",this.degradable((()=>this.backend.getNextBatchToken()),"getSavedSyncToken")),(0,i.default)(this,"deleteAllData",this.degradable((()=>(super.deleteAllData(),this.backend.clearDatabase().then((()=>{u.logger.log("Deleted indexeddb data.")}),(e=>{throw u.logger.error(`Failed to delete indexeddb data: ${e}`),e})))))),(0,i.default)(this,"reallySave",this.degradable((()=>{this.syncTs=Date.now();const e=[];for(const t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)}))),(0,i.default)(this,"setSyncData",this.degradable((e=>this.backend.setSyncData(e)),"setSyncData")),(0,i.default)(this,"getOutOfBandMembers",this.degradable((e=>this.backend.getOutOfBandMembers(e)),"getOutOfBandMembers")),(0,i.default)(this,"setOutOfBandMembers",this.degradable(((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t))),"setOutOfBandMembers")),(0,i.default)(this,"clearOutOfBandMembers",this.degradable((e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e))),"clearOutOfBandMembers")),(0,i.default)(this,"getClientOptions",this.degradable((()=>this.backend.getClientOptions()),"getClientOptions")),(0,i.default)(this,"storeClientOptions",this.degradable((e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e))),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new a.RemoteIndexedDBStoreBackend(e.workerFactory,e.dbName):this.backend=new o.LocalIndexedDBStoreBackend(e.indexedDB,e.dbName)}startup(){return this.startedUp?(u.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(u.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then((()=>(u.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents()))).then((e=>{u.logger.log("IndexedDBStore.startup: processing presence events"),e.forEach((([e,t])=>{const n=new c.User(e);t&&n.setPresenceEvent(new l.MatrixEvent(t)),this.userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)}))})))}wantsSave(){return Date.now()-this.syncTs>3e5}save(e=!1){return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){const n=super[t];return async(...t)=>{try{return await e.call(this,...t)}catch(e){u.logger.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emitter.emit("degraded",e);try{u.logger.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),u.logger.log("IndexedDBStore delete after degrading succeeded")}catch(e){u.logger.warn("IndexedDBStore delete after degrading failed",e)}if(n)return n.call(this,...t)}}}async getPendingEvents(e){if(!this.localStorage)return super.getPendingEvents(e);const t=this.localStorage.getItem(p(e));if(t)try{return JSON.parse(t)}catch(e){u.logger.error("Could not parse persisted pending events",e)}return[]}async setPendingEvents(e,t){if(!this.localStorage)return super.setPendingEvents(e,t);t.length>0?this.localStorage.setItem(p(e),JSON.stringify(t)):this.localStorage.removeItem(p(e))}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function p(e){return`mx_pending_events_${e}`}t.IndexedDBStore=h},6124:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryStore=void 0;var i=r(n(3693)),s=n(8057),o=n(9589);function a(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}t.MemoryStore=class{constructor(e={}){(0,i.default)(this,"rooms",{}),(0,i.default)(this,"users",{}),(0,i.default)(this,"syncToken",null),(0,i.default)(this,"filters",{}),(0,i.default)(this,"accountData",{}),(0,i.default)(this,"localStorage",void 0),(0,i.default)(this,"oobMembers",{}),(0,i.default)(this,"pendingEvents",{}),(0,i.default)(this,"clientOptions",{}),(0,i.default)(this,"pendingToDeviceBatches",[]),(0,i.default)(this,"nextToDeviceBatchId",0),(0,i.default)(this,"onRoomMember",((e,t,n)=>{if("invite"===n.membership)return;const r=this.users[n.userId]||new s.User(n.userId);n.name&&(r.setDisplayName(n.name),n.events.member&&r.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&r.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[r.userId]=r})),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(o.RoomStateEvent.Members,this.onRoomMember),e.currentState.getMembers().forEach((t=>{this.onRoomMember(null,e.currentState,t)}))}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(o.RoomStateEvent.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,r){}storeFilter(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)}getFilter(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null}getFilterIdByName(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(a(e))return e}catch(e){}return null}setFilterIdByName(e,t){if(!this.localStorage)return;const n="mxjssdk_memory_filter_"+e;try{a(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch(e){}}storeAccountDataEvents(e){e.forEach((e=>{this.accountData[e.getType()]=e}))}getAccountData(e){return this.accountData[e]}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers[e]||null)}setOutOfBandMembers(e,t){return this.oobMembers[e]=t,Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers={},Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}async getPendingEvents(e){var t;return null!==(t=this.pendingEvents[e])&&void 0!==t?t:[]}async setPendingEvents(e,t){this.pendingEvents[e]=t}saveToDeviceBatches(e){for(const t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}async getOldestToDeviceBatch(){return 0===this.pendingToDeviceBatches.length?null:this.pendingToDeviceBatches[0]}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter((t=>t.id!==e)),Promise.resolve()}}},1031:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.StubStore=void 0;var i=r(n(3693));t.StubStore=class{constructor(){(0,i.default)(this,"accountData",{}),(0,i.default)(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}storeEvents(e,t,n,r){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve({})}storeClientOptions(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}async saveToDeviceBatches(e){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(e){return Promise.resolve()}}},4589:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncAccumulator=t.Category=void 0;var i=r(n(3693)),s=n(9849),o=n(4148),a=n(4703);let c;function l(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}t.Category=c,function(e){e.Invite="invite",e.Leave="leave",e.Join="join"}(c||(t.Category=c={})),t.SyncAccumulator=class{constructor(e={}){this.opts=e,(0,i.default)(this,"accountData",{}),(0,i.default)(this,"inviteRooms",{}),(0,i.default)(this,"joinRooms",{}),(0,i.default)(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e,t=!1){this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}accumulateRooms(e,t=!1){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((n=>{this.accumulateRoom(n,c.Invite,e.rooms.invite[n],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((n=>{this.accumulateRoom(n,c.Join,e.rooms.join[n],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((n=>{this.accumulateRoom(n,c.Leave,e.rooms.leave[n],t)})))}accumulateRoom(e,t,n,r=!1){switch(t){case c.Invite:this.accumulateInviteState(e,n);break;case c.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,r);break;case c.Leave:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:s.logger.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const n=this.inviteRooms[e];t.invite_state.events.forEach((e=>{let t=!1;for(let r=0;r<n.invite_state.events.length;r++){const i=n.invite_state.events[r];i.type===e.type&&i.state_key==e.state_key&&(n.invite_state.events[r]=e,t=!0)}t||n.invite_state.events.push(e)}))}accumulateJoinState(e,t,n=!1){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const r=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((e=>{r._accountData[e.type]=e})),t.unread_notifications&&(r._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",n="m.invited_member_count",i="m.joined_member_count",s=r._summary,o=t.summary;s[e]=o[e]||s[e],s[i]=o[i]||s[i],s[n]=o[n]||s[n]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach((e=>{e.type===a.EventType.Receipt&&e.content&&Object.keys(e.content).forEach((t=>{Object.entries(e.content[t]).forEach((([n,i])=>{(0,o.isSupportedReceiptType)(n)&&Object.keys(i).forEach((i=>{r._readReceipts[i]={data:e.content[t][n][i],type:n,eventId:t}}))}))}))})),t.timeline&&t.timeline.limited&&(r._timeline=[]),t.state&&t.state.events&&t.state.events.forEach((e=>{l(r._currentState,e)})),t.timeline&&t.timeline.events&&t.timeline.events.forEach(((e,i)=>{let s;if(l(r._currentState,e),n)s=e;else{s=Object.assign({},e),void 0!==s.unsigned&&(s.unsigned=Object.assign({},s.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(s._localTs=Date.now()-t)}r._timeline.push({event:s,token:0===i?t.timeline.prev_batch:null})})),r._timeline.length>this.opts.maxTimelineEntries)for(let e=r._timeline.length-this.opts.maxTimelineEntries;e<r._timeline.length;e++)if(r._timeline[e].token){r._timeline=r._timeline.slice(e,r._timeline.length);break}}getJSON(e=!1){const t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.joinRooms).forEach((n=>{const r=this.joinRooms[n],i={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:r._unreadNotifications,summary:r._summary};Object.keys(r._accountData).forEach((e=>{i.account_data.events.push(r._accountData[e])}));const s={type:a.EventType.Receipt,room_id:n,content:{}};Object.keys(r._readReceipts).forEach((e=>{const t=r._readReceipts[e];s.content[t.eventId]||(s.content[t.eventId]={}),s.content[t.eventId][t.type]||(s.content[t.eventId][t.type]={}),s.content[t.eventId][t.type][e]=t.data})),Object.keys(s.content).length>0&&i.ephemeral.events.push(s),r._timeline.forEach((t=>{if(!i.timeline.prev_batch){if(!t.token)return;i.timeline.prev_batch=t.token}let n;!e&&t.event._localTs?(n=Object.assign({},t.event),void 0!==n.unsigned&&(n.unsigned=Object.assign({},n.unsigned)),delete n._localTs,n.unsigned=n.unsigned||{},n.unsigned.age=Date.now()-t.event._localTs):n=t.event,i.timeline.events.push(n)}));const c=Object.create(null);for(let e=i.timeline.events.length-1;e>=0;e--){const t=i.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const n=(0,o.deepCopy)(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),l(c,n)}Object.keys(r._currentState).forEach((e=>{Object.keys(r._currentState[e]).forEach((t=>{let n=r._currentState[e][t];c[e]&&c[e][t]&&(n=c[e][t]),i.state.events.push(n)}))})),t.join[n]=i}));const n=[];return Object.keys(this.accountData).forEach((e=>{n.push(this.accountData[e])})),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}},7314:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncState=t.SyncApi=void 0,t._createAndReEmitRoom=T;var i=r(n(3693)),s=n(8057),o=n(5489),a=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=_(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148)),c=n(2763),l=n(6418),u=n(5889),d=n(9849),h=n(2382),p=n(642),g=n(84),f=n(4703),m=n(9589),v=n(9948),y=n(1062);function _(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(_=function(e){return e?n:t})(e)}let b;t.SyncState=b,function(e){e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING"}(b||(t.SyncState=b={}));const E=["org.matrix.msc2716v3"];function A(e,t){return`FILTER_SYNC_${e}`+(t?"_"+t:"")}function S(...e){d.logger.log(...e)}var w;function I(e,t){const n=new s.User(t);return e.reEmitter.reEmit(n,[s.UserEvent.AvatarUrl,s.UserEvent.DisplayName,s.UserEvent.Presence,s.UserEvent.CurrentlyActive,s.UserEvent.LastPresenceTs]),n}function T(e,t,n){const{timelineSupport:r}=e,i=new o.Room(t,e,e.getUserId(),{lazyLoadMembers:n.lazyLoadMembers,pendingEventOrdering:n.pendingEventOrdering,timelineSupport:r});return e.reEmitter.reEmit(i,[o.RoomEvent.Name,o.RoomEvent.Redaction,o.RoomEvent.RedactionCancelled,o.RoomEvent.Receipt,o.RoomEvent.Tags,o.RoomEvent.LocalEchoUpdated,o.RoomEvent.AccountData,o.RoomEvent.MyMembership,o.RoomEvent.Timeline,o.RoomEvent.TimelineReset,m.RoomStateEvent.Events,m.RoomStateEvent.Members,m.RoomStateEvent.NewMember,m.RoomStateEvent.Update,y.BeaconEvent.New,y.BeaconEvent.Update,y.BeaconEvent.Destroy,y.BeaconEvent.LivenessChange]),i.on(m.RoomStateEvent.NewMember,((t,n,r)=>{r.user=e.getUser(r.userId),e.reEmitter.reEmit(r,[v.RoomMemberEvent.Name,v.RoomMemberEvent.Typing,v.RoomMemberEvent.PowerLevel,v.RoomMemberEvent.Membership])})),i}!function(e){e.Offline="offline",e.Online="online",e.Unavailable="unavailable"}(w||(w={})),t.SyncApi=class{constructor(e,t={}){var n;this.client=e,this.opts=t,(0,i.default)(this,"_peekRoom",null),(0,i.default)(this,"currentSyncRequest",null),(0,i.default)(this,"syncState",null),(0,i.default)(this,"syncStateData",null),(0,i.default)(this,"catchingUp",!1),(0,i.default)(this,"running",!1),(0,i.default)(this,"keepAliveTimer",null),(0,i.default)(this,"connectionReturnedDefer",null),(0,i.default)(this,"notifEvents",[]),(0,i.default)(this,"failedSyncCount",0),(0,i.default)(this,"storeIsInvalid",!1),(0,i.default)(this,"getPushRules",(async()=>{try{S("Getting push rules...");const e=await this.client.getPushRules();S("Got push rules"),this.client.pushRules=e}catch(e){if(d.logger.error("Getting push rules failed",e),this.shouldAbortSync(e))return;return S("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getPushRules()}})),(0,i.default)(this,"buildDefaultFilter",(()=>new c.Filter(this.client.credentials.userId))),(0,i.default)(this,"checkLazyLoadStatus",(async()=>{if(S("Checking lazy load status..."),this.opts.lazyLoadMembers&&this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers&&(S("Checking server lazy load support..."),await this.client.doesServerSupportLazyLoading()?(S("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)):(S("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)),S("Checking whether lazy loading has changed in store..."),await this.wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this.storeIsInvalid=!0;const e=h.InvalidStoreError.TOGGLED_LAZY_LOADING,t=new h.InvalidStoreError(e,!!this.opts.lazyLoadMembers);return this.updateSyncState(b.Error,{error:t}),void d.logger.warn("InvalidStoreError: store is not usable: stopping sync.")}var e;this.opts.lazyLoadMembers&&(null===(e=this.opts.crypto)||void 0===e||e.enableLazyLoading());try{S("Storing client options..."),await this.client.storeClientOptions(),S("Stored client options")}catch(e){throw d.logger.error("Storing client options failed",e),e}})),(0,i.default)(this,"getFilter",(async()=>{let e,t;S("Getting filter..."),e=this.opts.filter?this.opts.filter:this.buildDefaultFilter();try{t=await this.client.getOrCreateFilter(A(this.client.credentials.userId),e)}catch(e){return d.logger.error("Getting filter failed",e),this.shouldAbortSync(e)?{}:(S("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getFilter())}return{filter:e,filterId:t}})),(0,i.default)(this,"savedSyncPromise",void 0),(0,i.default)(this,"onOnline",(()=>{S("Browser thinks we are back online"),this.startKeepAlives(0)})),this.opts.initialSyncLimit=null!==(n=this.opts.initialSyncLimit)&&void 0!==n?n:8,this.opts.resolveInvitesToProfiles=this.opts.resolveInvitesToProfiles||!1,this.opts.pollTimeout=this.opts.pollTimeout||3e4,this.opts.pendingEventOrdering=this.opts.pendingEventOrdering||p.PendingEventOrdering.Chronological,this.opts.experimentalThreadSupport=!0===this.opts.experimentalThreadSupport,t.canResetEntireTimeline||(t.canResetEntireTimeline=e=>!1),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[o.RoomEvent.Timeline,o.RoomEvent.TimelineReset])}createRoom(e){const t=T(this.client,e,this.opts);return t.on(m.RoomStateEvent.Marker,((e,n)=>{this.onMarkerStateEvent(t,e,n)})),t}onMarkerStateEvent(e,t,{timelineWasEmpty:n}={}){n?d.logger.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`):E.includes(e.getVersion())||t.getSender()===e.getCreator()?(d.logger.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${t.getId()} was sent in roomId=${e.roomId}`),e.setTimelineNeedsRefresh(!0),e.emit(o.RoomEvent.HistoryImportedWithinTimeline,t,e)):d.logger.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}syncLeftRooms(){const e=this.client,t=new c.Filter(this.client.credentials.userId);t.setTimelineLimit(1),t.setIncludeLeaveRooms(!0);const n=this.opts.pollTimeout+8e4,r={timeout:0};return e.getOrCreateFilter(A(e.credentials.userId,"LEFT_ROOMS"),t).then((function(t){return r.filter=t,e.http.authedRequest(void 0,g.Method.Get,"/sync",r,void 0,n)})).then((async t=>{var n;let r=[];return null!==(n=t.rooms)&&void 0!==n&&n.leave&&(r=this.mapSyncResponseToRoomArray(t.rooms.leave)),Promise.all(r.map((async t=>{const n=t.room;if(!t.isBrandNewRoom)return;t.timeline=t.timeline||{};const r=this.mapSyncEventsFormat(t.timeline,n),i=this.mapSyncEventsFormat(t.state,n);return n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.EventTimeline.BACKWARDS),await this.processRoomEvents(n,i,r),n.recalculate(),e.store.storeRoom(n),e.emit(p.ClientEvent.Room,n),this.processEventsForNotifs(n,r),n})))}))}peek(e){if(this._peekRoom&&this._peekRoom.roomId===e)return Promise.resolve(this._peekRoom);const t=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then((e=>{e.messages=e.messages||{chunk:[]},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];const n=a.deepCopy(e.state).map(t.getEventMapper()),r=e.state.map(t.getEventMapper()),i=e.messages.chunk.map(t.getEventMapper());return Array.isArray(e.presence)&&e.presence.map(t.getEventMapper()).forEach((function(e){let n=t.store.getUser(e.getContent().user_id);n?n.setPresenceEvent(e):(n=I(t,e.getContent().user_id),n.setPresenceEvent(e),t.store.storeUser(n)),t.emit(p.ClientEvent.Event,e)})),e.messages.start&&(this._peekRoom.oldState.paginationToken=e.messages.start),this._peekRoom.oldState.setStateEvents(n),this._peekRoom.currentState.setStateEvents(r),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(i.reverse(),!0,this._peekRoom.getLiveTimeline(),e.messages.start),t.store.storeRoom(this._peekRoom),t.emit(p.ClientEvent.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom}))}stopPeeking(){this._peekRoom=null}peekPoll(e,t){this._peekRoom===e?this.client.http.authedRequest(void 0,g.Method.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,5e4).then((t=>{if(this._peekRoom!==e)return void S("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(this.client.getEventMapper()).forEach((e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=I(this.client,e.getContent().user_id),t.setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit(p.ClientEvent.Event,e)}));const n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(this.client.getEventMapper());e.addLiveEvents(n),this.peekPoll(e,t.end)}),(n=>{d.logger.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((()=>{this.peekPoll(e,t)}),3e4)})):S("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){return this.syncStateData}async recoverFromSyncStartupError(e,t){await e;const n=this.startKeepAlives();this.updateSyncState(b.Error,{error:t}),await n}async wasLazyLoadingToggled(e=!1){let t=!1;if(!await this.client.store.isNewlyCreated()){const n=await this.client.store.getClientOptions();return n&&(t=!!n.lazyLoadMembers),t!==e}return!1}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(b.Error,{error:e}),!0)}async sync(){var e,t;if(this.running=!0,null===(e=n.g.window)||void 0===e||null===(t=e.addEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});S("Getting saved sync token...");const r=this.client.store.getSavedSyncToken().then((e=>(S("Got saved sync token"),e)));this.savedSyncPromise=this.client.store.getSavedSync().then((e=>{if(S(`Got reply from saved sync, exists? ${!!e}`),e)return this.syncFromCache(e)})).catch((e=>{d.logger.error("Getting saved sync failed",e)})),await this.getPushRules(),await this.checkLazyLoadStatus();const{filterId:i,filter:s}=await this.getFilter();if(s){if(this.client.resetNotifTimelineSet(),null===this.currentSyncRequest){let e=i;const t=await r;if(t)S("Sending first sync request...");else{S("Sending initial sync request...");const t=this.buildDefaultFilter();t.setDefinition(s.getDefinition()),t.setTimelineLimit(this.opts.initialSyncLimit),e=JSON.stringify(t.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:e},t)}return S("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:i})}}stop(){var e,t,r;S("SyncApi.stop"),null===(e=n.g.window)||void 0===e||null===(t=e.removeEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.running=!1,null===(r=this.currentSyncRequest)||void 0===r||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=null)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){S("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const n={nextSyncToken:t,catchingUp:!1,fromCache:!0},r={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(n,r)}catch(e){d.logger.error("Error processing cached sync",e)}this.storeIsInvalid||this.updateSyncState(b.Prepared,n)}async doSync(e){for(;this.running;){const t=this.client.store.getSyncToken();let n;try{null===this.currentSyncRequest&&(this.currentSyncRequest=this.doSyncRequest(e,t)),n=await this.currentSyncRequest}catch(e){if(await this.onSyncError(e))return;continue}finally{this.currentSyncRequest=null}this.client.store.setSyncToken(n.next_batch),this.failedSyncCount=0,await this.client.store.setSyncData(n);const r={oldSyncToken:t,nextSyncToken:n.next_batch,catchingUp:this.catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(r);try{await this.processSyncResponse(r,n)}catch(e){d.logger.error("Caught /sync error",e),this.client.emit(p.ClientEvent.SyncUnexpectedError,e)}r.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(b.Prepared,r),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(r),this.updateSyncState(b.Syncing,r),this.client.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),this.client.store.save())}this.running||(S("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),this.updateSyncState(b.Stopped))}doSyncRequest(e,t){const n=this.getSyncParams(e,t);return this.client.http.authedRequest(void 0,g.Method.Get,"/sync",n,void 0,n.timeout+8e4)}getSyncParams(e,t){let n=this.opts.pollTimeout;(this.getSyncState()!==b.Syncing||this.catchingUp)&&(this.catchingUp=!0,n=0);let r=e.filter;this.client.isGuest()&&!r&&(r=this.getGuestFilter());const i={filter:r,timeout:n};return this.opts.disablePresence&&(i.set_presence=w.Offline),t?i.since=t:i._cacheBuster=Date.now(),[b.Reconnecting,b.Error].includes(this.getSyncState())&&(i.timeout=0),i}async onSyncError(e){if(!this.running)return S("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),this.updateSyncState(b.Stopped),!0;if(d.logger.error("/sync error %s",e),this.shouldAbortSync(e))return!0;this.failedSyncCount++,d.logger.log("Number of consecutive failed sync requests:",this.failedSyncCount),S("Starting keep-alive");const t=this.startKeepAlives();return this.currentSyncRequest=null,this.updateSyncState(this.failedSyncCount>=3?b.Error:b.Reconnecting,{error:e}),await t&&this.getSyncState()===b.Error&&this.updateSyncState(b.Catchup,{catchingUp:!0}),!1}async processSyncResponse(e,t){var n,r,i;const s=this.client;if(Array.isArray(null===(n=t.presence)||void 0===n?void 0:n.events)&&t.presence.events.map(s.getEventMapper()).forEach((function(e){let t=s.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=I(s,e.getSender()),t.setPresenceEvent(e),s.store.storeUser(t)),s.emit(p.ClientEvent.Event,e)})),Array.isArray(null===(r=t.account_data)||void 0===r?void 0:r.events)){const e=t.account_data.events.map(s.getEventMapper()),n=e.reduce(((e,t)=>(e[t.getId()]=s.store.getAccountData(t.getType()),e)),{});s.store.storeAccountDataEvents(e),e.forEach((function(e){if(e.getType()===f.EventType.PushRules){const t=e.getContent();s.pushRules=u.PushProcessor.rewriteDefaultRules(t)}const t=n[e.getId()];return s.emit(p.ClientEvent.AccountData,e,t),e}))}if(Array.isArray(null===(i=t.to_device)||void 0===i?void 0:i.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.filter((e=>{var t;return!(e.type===f.EventType.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes(null===(t=e.content)||void 0===t?void 0:t.algorithm)&&(d.logger.log("Ignoring invalid encrypted to-device event from "+e.sender),1))})).map(s.getEventMapper({toDevice:!0})).map((t=>{if("m.key.verification.cancel"===t.getType()){const n=t.getContent().transaction_id;n&&e.push(n)}return t})).forEach((function(t){const n=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const r=n.transaction_id;e.includes(r)&&t.flagCancelled()}s.emit(p.ClientEvent.ToDeviceEvent,t)}else d.logger.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this.catchingUp=!1;let c=[],h=[],g=[];if(t.rooms&&(t.rooms.invite&&(c=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(h=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(g=this.mapSyncResponseToRoomArray(t.rooms.leave))),this.notifEvents=[],await a.promiseMapSeries(c,(async e=>{var t;const n=e.room,r=this.mapSyncEventsFormat(e.invite_state,n);await this.processRoomEvents(n,r);const i=null===(t=n.currentState.getStateEvents(f.EventType.RoomMember,s.getUserId()))||void 0===t?void 0:t.getSender();if(s.isCryptoEnabled()){const e=await s.crypto.cryptoStore.takeParkedSharedHistory(n.roomId);for(const t of e)t.senderId===i&&await s.crypto.olmDevice.addInboundGroupSession(n.roomId,t.senderKey,t.forwardingCurve25519KeyChain,t.sessionId,t.sessionKey,t.keysClaimed,!0,{sharedHistory:!0,untrusted:!0})}e.isBrandNewRoom?(n.recalculate(),s.store.storeRoom(n),s.emit(p.ClientEvent.Room,n)):n.recalculate(),r.forEach((function(e){s.emit(p.ClientEvent.Event,e)}))})),await a.promiseMapSeries(h,(async t=>{const n=t.room,r=this.mapSyncEventsFormat(t.state,n),i=this.mapSyncEventsFormat(t.timeline,n,!1),c=this.mapSyncEventsFormat(t.ephemeral),u=this.mapSyncEventsFormat(t.account_data),h=s.isRoomEncrypted(n.roomId);if(t.unread_notifications&&(n.setUnreadNotificationCount(o.NotificationCountType.Total,t.unread_notifications.notification_count),(!h||n.getUnreadNotificationCount(o.NotificationCountType.Highlight)<=0)&&n.setUnreadNotificationCount(o.NotificationCountType.Highlight,t.unread_notifications.highlight_count)),t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.EventTimeline.BACKWARDS);else if(t.timeline.limited){let r=!0;for(let e=i.length-1;e>=0;e--){const t=i[e].getId();if(n.getTimelineForEvent(t)){S("Already have event "+t+" in limited sync - not resetting"),r=!1,i.splice(0,e);break}}r&&(n.resetLiveTimeline(t.timeline.prev_batch,this.opts.canResetEntireTimeline(n.roomId)?null:e.oldSyncToken),s.resetNotifTimelineSet())}try{await this.processRoomEvents(n,r,i,e.fromCache)}catch(e){d.logger.error(`Failed to process events on room ${n.roomId}:`,e)}t.summary&&n.setSummary(t.summary),n.addEphemeralEvents(c),n.addAccountData(u),n.recalculate(),t.isBrandNewRoom&&(s.store.storeRoom(n),s.emit(p.ClientEvent.Room,n)),this.processEventsForNotifs(n,i);const g=async e=>{s.emit(p.ClientEvent.Event,e),e.isState()&&"m.room.encryption"==e.getType()&&this.opts.crypto&&await this.opts.crypto.onCryptoEvent(e)};await a.promiseMapSeries(r,g),await a.promiseMapSeries(i,g),c.forEach((function(e){s.emit(p.ClientEvent.Event,e)})),u.forEach((function(e){s.emit(p.ClientEvent.Event,e)})),n.decryptCriticalEvents()})),await a.promiseMapSeries(g,(async e=>{const t=e.room,n=this.mapSyncEventsFormat(e.state,t),r=this.mapSyncEventsFormat(e.timeline,t),i=this.mapSyncEventsFormat(e.account_data);await this.processRoomEvents(t,n,r),t.addAccountData(i),t.recalculate(),e.isBrandNewRoom&&(s.store.storeRoom(t),s.emit(p.ClientEvent.Room,t)),this.processEventsForNotifs(t,r),n.forEach((function(e){s.emit(p.ClientEvent.Event,e)})),r.forEach((function(e){s.emit(p.ClientEvent.Event,e)})),i.forEach((function(e){s.emit(p.ClientEvent.Event,e)}))})),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((function(e){s.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}if(this.opts.crypto&&(t.device_unused_fallback_key_types||t["org.matrix.msc2732.device_unused_fallback_key_types"])){const e=t.device_unused_fallback_key_types||t["org.matrix.msc2732.device_unused_fallback_key_types"];this.opts.crypto.setNeedsNewFallback(e instanceof Array&&!e.includes("signed_curve25519"))}}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=a.defer()),this.connectionReturnedDefer.promise}pokeKeepAlive(e=!1){const t=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(e),this.connectionReturnedDefer=null)};this.client.http.request(void 0,g.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((()=>{t()}),(n=>{400==n.httpStatus||404==n.httpStatus?this.keepAliveTimer=setTimeout(t,2e3):(e=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,e),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(b.Error,{error:n}))}))}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).map((n=>{const r=e[n];let i=t.store.getRoom(n),s=!1;return i||(i=this.createRoom(n),s=!0),r.room=i,r.isBrandNewRoom=s,r}))}mapSyncEventsFormat(e,t,n=!0){if(!e||!Array.isArray(e.events))return[];const r=this.client.getEventMapper({decrypt:n});return e.events.map((function(e){return t&&(e.room_id=t.roomId),r(e)}))}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n._requestedProfileInfo)return;n._requestedProfileInfo=!0;const r=t.getUser(n.userId);let i;i=r?Promise.resolve({avatar_url:r.avatarUrl,displayname:r.displayName}):t.getProfileInfo(n.userId),i.then((function(t){const r=n.events.member;"invite"===r.getContent().membership&&(r.getContent().avatar_url=t.avatar_url,r.getContent().displayname=t.displayname,n.setMembershipEvent(r,e.currentState))}),(function(e){}))}))}async processRoomEvents(e,t,n,r=!1){const i=e.getLiveTimeline(),s=0==i.getEvents().length;if(s){for(const e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t,{timelineWasEmpty:s})}this.resolveInvites(e),e.recalculate(),s||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(n||[],{fromCache:r,timelineWasEmpty:s}),this.client.processBeaconEvents(e,n)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(let e=0;e<t.length;e++){const n=this.client.getPushActionsForEvent(t[e]);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this.notifEvents.push(t[e])}}getGuestFilter(){return"{}"}updateSyncState(e,t){const n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(p.ClientEvent.Sync,this.syncState,n,t)}}},1215:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.TimelineWindow=t.TimelineIndex=void 0;var i=r(n(3693)),s=n(6418);n(9849);t.TimelineWindow=class{constructor(e,t,n={}){this.client=e,this.timelineSet=t,(0,i.default)(this,"windowLimit",void 0),(0,i.default)(this,"start",null),(0,i.default)(this,"end",null),(0,i.default)(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3}load(e,t=20){const n=n=>{let r;const i=n.getEvents();if(e){if(r=i.findIndex((t=>t.getId()===e)),r<0)throw new Error("getEventTimeline result didn't include requested event")}else r=i.length;const s=Math.min(i.length,r+Math.ceil(t/2)),a=Math.max(0,s-t);this.start=new o(n,a-n.getBaseIndex()),this.end=new o(n,s-n.getBaseIndex()),this.eventCount=s-a};if(e){const t=this.timelineSet.getTimelineForEvent(e);return t?(n(t),Promise.resolve()):this.client.getEventTimeline(this.timelineSet,e).then(n)}return n(this.timelineSet.getLiveTimeline()),Promise.resolve()}getTimelineIndex(e){if(e==s.EventTimeline.BACKWARDS)return this.start;if(e==s.EventTimeline.FORWARDS)return this.end;throw new Error("Invalid direction '"+e+"'")}extend(e,t){const n=this.getTimelineIndex(e);if(!n)return!1;const r=e==s.EventTimeline.BACKWARDS?n.retreat(t):n.advance(t);if(r){this.eventCount+=r,this.eventCount;const t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=s.EventTimeline.BACKWARDS),!0}return!1}canPaginate(e){const t=this.getTimelineIndex(e);if(!t)return!1;if(e==s.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||null!==t.timeline.getPaginationToken(e))}paginate(e,t,n=!0,r=5){const i=this.getTimelineIndex(e);if(!i)return Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!n||0===r)return Promise.resolve(!1);if(null===i.timeline.getPaginationToken(e))return Promise.resolve(!1);const o=this.client.paginateEventTimeline(i.timeline,{backwards:e==s.EventTimeline.BACKWARDS,limit:t}).finally((function(){i.pendingPaginate=null})).then((n=>!!n&&this.paginate(e,t,!0,r-1)));return i.pendingPaginate=o,o}unpaginate(e,t){const n=t?this.start:this.end;if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this.eventCount+" in the timeline");for(;e>0;){const r=t?n.advance(e):n.retreat(e);if(r<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=r,this.eventCount-=r,this.eventCount}}getEvents(){if(!this.start)return[];const e=[];let t=this.start.timeline;for(;;){const n=t.getEvents();let r=0,i=n.length;t===this.start.timeline&&(r=this.start.index+t.getBaseIndex()),t===this.end.timeline&&(i=this.end.index+t.getBaseIndex());for(let t=r;t<i;t++)e.push(n[t]);if(t===this.end.timeline)break;t=t.getNeighbouringTimeline(s.EventTimeline.FORWARDS)}return e}};class o{constructor(e,t){this.timeline=e,this.index=t,(0,i.default)(this,"pendingPaginate",void 0)}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const n=this.timeline.getNeighbouringTimeline(e<0?s.EventTimeline.BACKWARDS:s.EventTimeline.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}t.TimelineIndex=o},4148:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_ALPHABET=void 0,t.alphabetPad=g,t.averageBetweenStrings=function(e,t,n=p){const r=Math.max(e.length,t.length),i=m(g(e,r,n),n),s=m(g(t,r,n),n),o=(i+s)/BigInt(2);return o===i||o==s?f(o,n)+n[0]:f(o,n)},t.baseToString=f,t.checkObjectHasKeys=function(e,t){for(let n=0;n<t.length;n++)if(!e.hasOwnProperty(t[n]))throw new Error("Missing required key: "+t[n])},t.chunkPromises=async function(e,t){const n=[];for(let r=0;r<e.length;r+=t)n.push(...await Promise.all(e.slice(r,r+t).map((e=>e()))));return n},t.compare=function(e,t){return y.compare(e,t)},t.decodeParams=function(e){const t={},n=new URLSearchParams(e);for(const e of n.keys()){const r=n.getAll(e);t[e]=1===r.length?r[0]:r}return t},t.deepCompare=function e(t,n){if(t===n)return!0;if(typeof t!=typeof n)return!1;if("number"==typeof t&&isNaN(t)&&isNaN(n))return!0;if(null===t||null===n)return t===n;if(!(t instanceof Object))return!1;if(t.constructor!==n.constructor||t.prototype!==n.prototype)return!1;if(t instanceof RegExp||t instanceof Date)return t.toString()===n.toString();if(t instanceof Array){if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(!e(t[r],n[r]))return!1}else{for(const e in n)if(n.hasOwnProperty(e)!==t.hasOwnProperty(e))return!1;for(const r in t)if(n.hasOwnProperty(r)!==t.hasOwnProperty(r)||!e(t[r],n[r]))return!1}return!0},t.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},t.deepSortedObjectEntries=function e(t){if("object"!=typeof t)return t;if(null==t||Array.isArray(t))return t;const n=[];for(const[r,i]of Object.entries(t))n.push([r,e(i)]);return n.sort(((e,t)=>v(e[0],t[0]))),n},t.defer=function(){let e,t;const n=new Promise(((n,r)=>{e=n,t=r}));return{resolve:e,reject:t,promise:n}},t.encodeParams=function(e){const t=new URLSearchParams;for(const[n,r]of Object.entries(e))null!=r&&t.set(n,String(r));return t.toString()},t.encodeUri=function(e,t){for(const n in t)t.hasOwnProperty(n)&&(e=e.replace(n,encodeURIComponent(t[n])));return e},t.ensureNoTrailingSlash=function(e){return e&&e.endsWith("/")?e.slice(0,-1):e},t.escapeRegExp=d,t.getCrypto=function(){return h},t.globToRegexp=function(e,t=!1){return[[/\\\*/g,".*"],[/\?/g,"."],!t&&[/\\\[(!|)(.*)\\]/g,(e,t,n)=>["[",t?"^":"",n.replace(/\\-/,"-"),"]"].join("")]].reduce(((e,t)=>t?e.replace(t[0],t[1]):e),d(e))},t.internaliseString=function(e){return e instanceof String&&(e=e.toString()),c.has(e)||c.set(e,e),c.get(e)},t.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)},t.isNullOrUndefined=function(e){return null==e},t.isNumber=function(e){return"number"==typeof e&&isFinite(e)},t.isSupportedReceiptType=function(e){return[a.ReceiptType.Read,a.ReceiptType.ReadPrivate].includes(e)},t.lexicographicCompare=v,t.nextString=function(e,t=p){return f(m(e,t)+BigInt(1),t)},t.normalize=function(e){return l(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()},t.prevString=function(e,t=p){return f(m(e,t)-BigInt(1),t)},t.promiseMapSeries=async function(e,t){for(const n of e)await t(await n)},t.promiseTry=function(e){return Promise.resolve(e())},t.recursivelyAssign=function e(t,n,r=!1){for(const[i,s]of Object.entries(n))t[i]instanceof Object&&s?e(t[i],s):null==s&&r||(t[i]=s);return t},t.removeDirectionOverrideChars=function(e){return"string"==typeof e?e.replace(/[\u202d-\u202e]/g,""):""},t.removeElement=function(e,t,n){let r;if(n){for(r=e.length-1;r>=0;r--)if(t(e[r],r,e))return e.splice(r,1),!0}else for(r=0;r<e.length;r++)if(t(e[r],r,e))return e.splice(r,1),!0;return!1},t.removeHiddenChars=l,t.setCrypto=function(e){h=e},t.simpleRetryOperation=function(e){return(0,s.default)((t=>e(t)),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})},t.sleep=function(e,t){return new Promise((n=>{setTimeout(n,e,t)}))},t.sortEventsByLatestContentTimestamp=function(e,t){return _(t)-_(e)},t.stringToBase=m;var i=r(n(5395)),s=r(n(4116)),o=n(9668),a=n(251);const c=new Map;function l(e){return"string"==typeof e?(0,i.default)(e.normalize("NFD").replace(u,"")):""}const u=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\s]/g;function d(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}let h;const p=(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function g(e,t,n=p){return e.padEnd(t,n[0])}function f(e,t=p){const n=BigInt(t.length);var r;if(e<=n)return null!==(r=t[Number(e)-1])&&void 0!==r?r:"";let i=e/n,s=Number(e%n)-1;return s<0&&(i-=BigInt(Math.abs(s)),s=Number(n)-1),f(i,t)+t[s]}function m(e,t=p){const n=BigInt(t.length);let r=BigInt(0);for(let i=e.length-1,s=BigInt(0);i>=0;i--,s++){const o=e.charCodeAt(i)-t.charCodeAt(0);r+=BigInt(1+o)*n**s}return r}function v(e,t){return e<t?-1:e>t?1:0}t.DEFAULT_ALPHABET=p;const y=new Intl.Collator;function _(e){var t;return null!==(t=o.M_TIMESTAMP.findIn(e.getContent()))&&void 0!==t?t:-1}},9435:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixCall=t.CallType=t.CallState=t.CallParty=t.CallEvent=t.CallErrorCode=t.CallError=t.CallDirection=void 0,t.createNewMatrixCall=function(e,t,n){if(!S())return null;const r=!!n&&n.forceTURN,i={client:e,roomId:t,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||r},s=new E(i);return e.reEmitter.reEmit(s,Object.values(v)),s},t.supportsMatrixCall=S;var i=r(n(3693)),s=n(9849),o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=h(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=i?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(n(4148)),a=n(4703),c=n(3759),l=n(926),u=n(1759),d=n(7022);function h(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(h=function(e){return e?n:t})(e)}let p,g,f,m,v,y;t.CallState=p,function(e){e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended"}(p||(t.CallState=p={})),t.CallType=g,function(e){e.Voice="voice",e.Video="video"}(g||(t.CallType=g={})),t.CallDirection=f,function(e){e.Inbound="inbound",e.Outbound="outbound"}(f||(t.CallDirection=f={})),t.CallParty=m,function(e){e.Local="local",e.Remote="remote"}(m||(t.CallParty=m={})),t.CallEvent=v,function(e){e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel"}(v||(t.CallEvent=v={})),t.CallErrorCode=y,function(e){e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transfered="transferred"}(y||(t.CallErrorCode=y={}));class _ extends Error{constructor(e,t,n){super(t+": "+n),(0,i.default)(this,"code",void 0),this.code=e}}function b(){return Date.now().toString()+(0,c.randomString)(16)}t.CallError=_;class E extends d.TypedEventEmitter{constructor(e){super(),(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"callId",void 0),(0,i.default)(this,"state",p.Fledgling),(0,i.default)(this,"hangupParty",void 0),(0,i.default)(this,"hangupReason",void 0),(0,i.default)(this,"direction",void 0),(0,i.default)(this,"ourPartyId",void 0),(0,i.default)(this,"client",void 0),(0,i.default)(this,"forceTURN",void 0),(0,i.default)(this,"turnServers",void 0),(0,i.default)(this,"candidateSendQueue",[]),(0,i.default)(this,"candidateSendTries",0),(0,i.default)(this,"sentEndOfCandidates",!1),(0,i.default)(this,"peerConn",void 0),(0,i.default)(this,"feeds",[]),(0,i.default)(this,"usermediaSenders",[]),(0,i.default)(this,"screensharingSenders",[]),(0,i.default)(this,"inviteOrAnswerSent",!1),(0,i.default)(this,"waitForLocalAVStream",void 0),(0,i.default)(this,"successor",void 0),(0,i.default)(this,"opponentMember",void 0),(0,i.default)(this,"opponentVersion",void 0),(0,i.default)(this,"opponentPartyId",void 0),(0,i.default)(this,"opponentCaps",void 0),(0,i.default)(this,"inviteTimeout",void 0),(0,i.default)(this,"remoteOnHold",!1),(0,i.default)(this,"callStatsAtEnd",void 0),(0,i.default)(this,"makingOffer",!1),(0,i.default)(this,"ignoreOffer",void 0),(0,i.default)(this,"remoteCandidateBuffer",new Map),(0,i.default)(this,"remoteAssertedIdentity",void 0),(0,i.default)(this,"remoteSDPStreamMetadata",void 0),(0,i.default)(this,"callLengthInterval",void 0),(0,i.default)(this,"callLength",0),(0,i.default)(this,"gotLocalIceCandidate",(e=>{if(e.candidate){if(s.logger.debug("Call "+this.callId+" got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),this.callHasEnded())return;""===e.candidate.candidate&&this.sentEndOfCandidates||(this.queueCandidate(e.candidate),""===e.candidate.candidate&&(this.sentEndOfCandidates=!0))}})),(0,i.default)(this,"onIceGatheringStateChange",(e=>{if(s.logger.debug("ice gathering state changed to "+this.peerConn.iceGatheringState),"complete"===this.peerConn.iceGatheringState&&!this.sentEndOfCandidates){const e={candidate:""};this.queueCandidate(e),this.sentEndOfCandidates=!0}})),(0,i.default)(this,"gotLocalOffer",(async e=>{if(s.logger.debug("Created offer: ",e),this.callHasEnded())return void s.logger.debug("Ignoring newly created offer on call ID "+this.callId+" because the call has ended");try{await this.peerConn.setLocalDescription(e)}catch(e){return s.logger.debug("Error setting local description!",e),void this.terminate(m.Local,y.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;const t=this.state===p.CreateOffer?a.EventType.CallInvite:a.EventType.CallNegotiate,n={lifetime:6e4};this.state===p.CreateOffer?n.offer=this.peerConn.localDescription:n.description=this.peerConn.localDescription,n.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},n[l.SDPStreamMetadataKey]=this.getLocalSDPStreamMetadata(),s.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in offer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(t,n)}catch(e){s.logger.error("Failed to send invite",e),e.event&&this.client.cancelPendingEvent(e.event);let t=y.SignallingFailed,n="Signalling failed";return this.state===p.CreateOffer&&(t=y.SendInvite,n="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=y.UnknownDevices,n="Unknown devices present in the room"),this.emit(v.Error,new _(t,n,e)),void this.terminate(m.Local,t,!1)}this.sendCandidateQueue(),this.state===p.CreateOffer&&(this.inviteOrAnswerSent=!0,this.setState(p.InviteSent),this.inviteTimeout=setTimeout((()=>{this.inviteTimeout=null,this.state===p.InviteSent&&this.hangup(y.InviteTimeout,!1)}),6e4))})),(0,i.default)(this,"getLocalOfferFailed",(e=>{s.logger.error("Failed to get local offer",e),this.emit(v.Error,new _(y.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(m.Local,y.LocalOfferFailed,!1)})),(0,i.default)(this,"getUserMediaFailed",(e=>{this.successor?this.successor.getUserMediaFailed(e):(s.logger.warn("Failed to get user media - ending call",e),this.emit(v.Error,new _(y.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(m.Local,y.NoUserMedia,!1))})),(0,i.default)(this,"onIceConnectionStateChanged",(()=>{this.callHasEnded()||(s.logger.debug("Call ID "+this.callId+": ICE connection state changed to: "+this.peerConn.iceConnectionState),"connected"==this.peerConn.iceConnectionState?(this.setState(p.Connected),this.callLengthInterval||(this.callLengthInterval=setInterval((()=>{this.callLength++,this.emit(v.LengthChanged,this.callLength)}),1e3))):"failed"==this.peerConn.iceConnectionState&&this.hangup(y.IceFailed,!1))})),(0,i.default)(this,"onSignallingStateChanged",(()=>{s.logger.debug("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)})),(0,i.default)(this,"onTrack",(e=>{if(0===e.streams.length)return void s.logger.warn(`Streamless ${e.track.kind} found: ignoring.`);const t=e.streams[0];this.pushRemoteFeed(t),t.addEventListener("removetrack",(()=>{0===t.getTracks().length&&(s.logger.info(`Stream ID ${t.id} has no tracks remaining - removing`),this.deleteFeedByStream(t))}))})),(0,i.default)(this,"onDataChannel",(e=>{this.emit(v.DataChannel,e.channel)})),(0,i.default)(this,"onNegotiationNeeded",(async()=>{if(s.logger.info("Negotiation is needed!"),this.state===p.CreateOffer||0!==this.opponentVersion){this.makingOffer=!0;try{this.getRidOfRTXCodecs();const e=await this.peerConn.createOffer();await this.gotLocalOffer(e)}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}else s.logger.info("Opponent does not support renegotiation: ignoring negotiationneeded event")})),(0,i.default)(this,"onHangupReceived",(e=>{s.logger.debug("Hangup received for call ID "+this.callId),this.partyIdMatches(e)||this.state===p.Ringing?this.terminate(m.Remote,e.reason||y.UserHangup,!0):s.logger.info(`Ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)})),(0,i.default)(this,"onRejectReceived",(e=>{s.logger.debug("Reject received for call ID "+this.callId),[p.InviteSent,p.Ringing].includes(this.state)||this.state===p.Fledgling&&this.direction===f.Inbound?this.terminate(m.Remote,e.reason||y.UserHangup,!0):s.logger.debug(`Call is in state: ${this.state}: ignoring reject`)})),(0,i.default)(this,"onAnsweredElsewhere",(e=>{s.logger.debug("Call ID "+this.callId+" answered elsewhere"),this.terminate(m.Remote,y.AnsweredElsewhere,!0)})),this.roomId=e.roomId,this.client=e.client,this.forceTURN=e.forceTURN,this.ourPartyId=this.client.deviceId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)o.checkObjectHasKeys(e,["urls"]);this.callId=b()}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const n=this.peerConn.createDataChannel(e,t);return this.emit(v.DataChannel,n),s.logger.debug("created data channel"),n}getOpponentMember(){return this.opponentMember}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get type(){return this.hasLocalUserMediaVideoTrack||this.hasRemoteUserMediaVideoTrack?g.Video:g.Voice}get hasLocalUserMediaVideoTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getVideoTracks().length)>0}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia&&e.stream.getVideoTracks().length>0))}get hasLocalUserMediaAudioTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getAudioTracks().length)>0}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia&&e.stream.getAudioTracks().length>0))}get localUsermediaFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia))}get localScreensharingFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Screenshare))}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia))}get remoteScreensharingFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Screenshare))}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find((t=>t.stream.id===e))}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter((e=>e.isLocal()))}getRemoteFeeds(){return this.feeds.filter((e=>!e.isLocal()))}getLocalSDPStreamMetadata(){const e={};for(const t of this.getLocalFeeds())e[t.stream.id]={purpose:t.purpose,audio_muted:t.isAudioMuted(),video_muted:t.isVideoMuted()};return s.logger.debug("Got local SDPStreamMetadata",e),e}noIncomingFeeds(){return!this.feeds.some((e=>!e.isLocal()))}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);const t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,r=this.remoteSDPStreamMetadata[e.id].audio_muted,i=this.remoteSDPStreamMetadata[e.id].video_muted;n?this.getFeedByStreamId(e.id)?s.logger.warn(`Ignoring stream with id ${e.id} because we already have a feed for it`):(this.feeds.push(new u.CallFeed({client:this.client,roomId:this.roomId,userId:t,stream:e,purpose:n,audioMuted:r,videoMuted:i})),this.emit(v.FeedsChanged,this.feeds),s.logger.info(`Pushed remote stream (id="${e.id}", active="${e.active}", purpose=${n})`)):s.logger.warn(`Ignoring stream with id ${e.id} because we didn't get any metadata about it`)}pushRemoteFeedWithoutMetadata(e){var t;const n=this.getOpponentMember().userId,r=l.SDPStreamMetadataPurpose.Usermedia,i=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;i&&e.id!==i.id?s.logger.warn(`Ignoring new stream ID ${e.id}: we already have stream ID ${i.id}`):this.getFeedByStreamId(e.id)?s.logger.warn(`Ignoring stream with id ${e.id} because we already have a feed for it`):(this.feeds.push(new u.CallFeed({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,stream:e,purpose:r})),this.emit(v.FeedsChanged,this.feeds),s.logger.info(`Pushed remote stream (id="${e.id}", active="${e.active}")`))}pushNewLocalFeed(e,t,n=!0){const r=this.client.getUserId();A(e.getAudioTracks(),!0),A(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)?s.logger.warn(`Ignoring stream with id ${e.id} because we already have a feed for it`):this.pushLocalFeed(new u.CallFeed({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,stream:e,purpose:t}),n)}pushLocalFeed(e,t=!0){if(this.feeds.push(e),t){const t=e.purpose===l.SDPStreamMetadataPurpose.Usermedia?this.usermediaSenders:this.screensharingSenders;t.splice(0,t.length);for(const n of e.stream.getTracks())s.logger.info(`Adding track (id="${n.id}", kind="${n.kind}", streamId="${e.stream.id}", streamPurpose="${e.purpose}", enabled=${n.enabled}) to peer connection`),t.push(this.peerConn.addTrack(n,e.stream))}s.logger.info(`Pushed local stream (id="${e.stream.id}", active="${e.stream.active}", purpose="${e.purpose}")`),this.emit(v.FeedsChanged,this.feeds)}removeLocalFeed(e){const t=e.purpose===l.SDPStreamMetadataPurpose.Usermedia?this.usermediaSenders:this.screensharingSenders;for(const e of t)this.peerConn.removeTrack(e);t.splice(0,t.length),this.deleteFeedByStream(e.stream)}deleteAllFeeds(){for(const e of this.feeds)e.dispose();this.feeds=[],this.emit(v.FeedsChanged,this.feeds)}deleteFeedByStream(e){s.logger.debug(`Removing feed with stream id ${e.id}`);const t=this.getFeedByStreamId(e.id);t?(t.dispose(),this.feeds.splice(this.feeds.indexOf(t),1),this.emit(v.FeedsChanged,this.feeds)):s.logger.warn(`Didn't find the feed with stream id ${e.id} to delete`)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];return e.forEach((e=>{t.push(e)})),t}async initWithInvite(e){var t;const n=e.getContent();this.direction=f.Inbound,await this.client.checkTurnServers()||s.logger.warn("Failed to get TURN credentials! Proceeding with call anyway...");const r=n[l.SDPStreamMetadataKey];r?this.updateRemoteSDPStreamMetadata(r):s.logger.debug("Did not get any SDPStreamMetadata! Can not send/receive multiple streams"),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e);try{await this.peerConn.setRemoteDescription(n.offer),await this.addBufferedIceCandidates()}catch(e){return s.logger.debug("Failed to set remote description",e),void this.terminate(m.Local,y.SetRemoteDescription,!1)}const i=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(!i||0===i.getTracks().length)return s.logger.error("No remote stream or no tracks after setting remote description!"),void this.terminate(m.Local,y.SetRemoteDescription,!1);this.setState(p.Ringing),e.getLocalAge()&&setTimeout((()=>{this.state==p.Ringing&&(s.logger.debug("Call invite has expired. Hanging up."),this.hangupParty=m.Remote,this.setState(p.Ended),this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(v.Hangup))}),n.lifetime-e.getLocalAge())}initWithHangup(e){this.setState(p.Ended)}shouldAnswerWithMediaType(e,t,n){return e&&!t?(s.logger.warn(`Unable to answer with ${n} because the other side isn't sending it either.`),!1):o.isNullOrUndefined(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(s.logger.warn(`Unable to answer with ${n}=${e} because the other side doesn't support it. Answering with ${n}=${t}.`),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(s.logger.debug(`Answering call ${this.callId}`),this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&this.setState(p.WaitLocalMedia);else{const n=this.state,r=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),i=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.setState(p.WaitLocalMedia),this.waitForLocalAVStream=!0;try{const e=await this.client.getMediaHandler().getUserMediaStream(r,i);this.waitForLocalAVStream=!1;const t=[new u.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:e,purpose:l.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&t.push(this.localScreensharingFeed),this.answerWithCallFeeds(t)}catch(e){if(!i)return void this.getUserMediaFailed(e);s.logger.warn("Failed to getUserMedia(), trying to getUserMedia() without video"),this.setState(n),this.waitForLocalAVStream=!1,await this.answer(r,!1)}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.gotCallFeedsForAnswer(e)}replacedBy(e){this.state===p.WaitLocalMedia?(s.logger.debug("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):[p.CreateOffer,p.InviteSent].includes(this.state)&&(s.logger.debug("Handing local stream to new call"),e.gotCallFeedsForAnswer(this.getLocalFeeds())),this.successor=e,this.emit(v.Replaced,e),this.hangup(y.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(s.logger.debug("Ending call "+this.callId),this.terminate(m.Local,e,!t),this.state===p.WaitLocalMedia)return;const n={};(this.opponentVersion&&0!==this.opponentVersion||e!==y.UserHangup)&&(n.reason=e),this.sendVoipEvent(a.EventType.CallHangup,n)}reject(){if(this.state!==p.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion)return s.logger.info(`Opponent version is less than 1 (${this.opponentVersion}): sending hangup instead of reject`),void this.hangup(y.UserHangup,!0);s.logger.debug("Rejecting call: "+this.callId),this.terminate(m.Local,y.UserHangup,!0),this.sendVoipEvent(a.EventType.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{const n=e||this.hasLocalUserMediaAudioTrack,r=t||this.hasLocalUserMediaVideoTrack,i=await this.client.getMediaHandler().getUserMediaStream(n,r,!1);await this.updateLocalUsermediaStream(i,e,t)}catch(e){s.logger.error("Failed to upgrade the call",e),this.emit(v.Error,new _(y.NoUserMedia,"Failed to get camera access: ",e))}}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return s.logger.warn("There is already a screensharing stream - there is nothing to do!"),!0;if(!e&&!this.isScreensharing())return s.logger.warn("There already isn't a screensharing stream - there is nothing to do!"),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(s.logger.debug(`Set screensharing enabled? ${e}`),!e){for(const e of this.screensharingSenders)this.peerConn.removeTrack(e);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);return!!e&&(this.pushNewLocalFeed(e,l.SDPStreamMetadataPurpose.Screenshare),!0)}catch(e){return s.logger.error("Failed to get screen-sharing stream:",e),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){if(s.logger.debug(`Set screensharing enabled? ${e} using replaceTrack()`),!e){const e=this.localUsermediaStream.getTracks().find((e=>"video"===e.kind));return this.usermediaSenders.find((e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)})).replaceTrack(e),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;const n=e.getTracks().find((e=>"video"===e.kind));return this.usermediaSenders.find((e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)})).replaceTrack(n),this.pushNewLocalFeed(e,l.SDPStreamMetadataPurpose.Screenshare,!1),!0}catch(e){return s.logger.error("Failed to get screen-sharing stream:",e),!1}}async updateLocalUsermediaStream(e,t=!1,n=!1){const r=this.localUsermediaFeed,i=t||!r.isAudioMuted()&&!this.remoteOnHold,o=n||!r.isVideoMuted()&&!this.remoteOnHold;A(e.getAudioTracks(),i),A(e.getVideoTracks(),o);for(const e of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack(e),e.stop();for(const t of e.getTracks())this.localUsermediaStream.addTrack(t);const a=[];for(const t of e.getTracks()){const n=this.usermediaSenders.find((e=>{var n;return(null===(n=e.track)||void 0===n?void 0:n.kind)===t.kind}));let i;n?(s.logger.info(`Replacing track (id="${t.id}", kind="${t.kind}", streamId="${e.id}", streamPurpose="${r.purpose}") to peer connection`),await n.replaceTrack(t),i=n):(s.logger.info(`Adding track (id="${t.id}", kind="${t.kind}", streamId="${e.id}", streamPurpose="${r.purpose}") to peer connection`),i=this.peerConn.addTrack(t,this.localUsermediaStream)),a.push(i)}this.usermediaSenders=a}async setLocalVideoMuted(e){var t;return await this.client.getMediaHandler().hasVideoDevice()?this.hasLocalUserMediaVideoTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(null,e),this.updateMuteStatus(),this.isLocalVideoMuted()):(await this.upgradeCall(!1,!0),this.isLocalVideoMuted()):this.isLocalVideoMuted()}isLocalVideoMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isVideoMuted()}async setMicrophoneMuted(e){var t;return await this.client.getMediaHandler().hasAudioDevice()?this.hasLocalUserMediaAudioTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(e,null),this.updateMuteStatus(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isAudioMuted()}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.emit(v.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==p.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers())["inactive","recvonly"].includes(t.currentDirection)||(e=!1);return e}sendDtmfDigit(e){for(const t of this.peerConn.getSenders())if("audio"===t.track.kind&&t.dtmf)return void t.dtmf.insertDTMF(e);throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){this.sendVoipEvent(a.EventType.CallSDPStreamMetadataChangedPrefix,{[l.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()});const e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;A(this.localUsermediaStream.getAudioTracks(),!e),A(this.localUsermediaStream.getVideoTracks(),!t)}gotCallFeedsForInvite(e){if(this.successor)this.successor.gotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(const t of e)this.pushLocalFeed(t);this.setState(p.CreateOffer),s.logger.debug("gotUserMediaForInvite")}}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[l.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},s.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(a.EventType.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.setState(p.Ringing),this.client.cancelPendingEvent(e.event);let t=y.SendAnswer,n="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=y.UnknownDevices,n="Unknown devices present in the room"),this.emit(v.Error,new _(t,n,e)),e}this.sendCandidateQueue()}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const t of e)this.pushLocalFeed(t);let t;this.setState(p.CreateAnswer);try{this.getRidOfRTXCodecs(),t=await this.peerConn.createAnswer()}catch(e){return s.logger.debug("Failed to create answer: ",e),void this.terminate(m.Local,y.CreateAnswer,!0)}try{await this.peerConn.setLocalDescription(t),this.setState(p.Connecting),await new Promise((e=>{setTimeout(e,200)})),this.sendAnswer()}catch(e){return s.logger.debug("Error setting local description!",e),void this.terminate(m.Local,y.SetLocalDescription,!0)}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),n=t.candidates;if(!n)return void s.logger.info("Ignoring candidates event with no candidates!");const r=0===t.version?null:t.party_id||null;if(void 0===this.opponentPartyId){s.logger.info(`Buffering ${n.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(r)||[];return e.push(...n),void this.remoteCandidateBuffer.set(r,e)}this.partyIdMatches(t)?await this.addIceCandidates(n):s.logger.info(`Ignoring candidates from party ID ${t.party_id}: we have chosen party ID ${this.opponentPartyId}`)}async onAnswerReceived(e){const t=e.getContent();if(s.logger.debug(`Got answer for call ID ${this.callId} from party ID ${t.party_id}`),this.callHasEnded())return void s.logger.debug(`Ignoring answer because call ID ${this.callId} has ended`);if(void 0!==this.opponentPartyId)return void s.logger.info(`Ignoring answer from party ID ${t.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.setState(p.Connecting);const n=t[l.SDPStreamMetadataKey];n?this.updateRemoteSDPStreamMetadata(n):s.logger.warn("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConn.setRemoteDescription(t.answer)}catch(e){return s.logger.debug("Failed to set remote description",e),void this.terminate(m.Local,y.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(a.EventType.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){s.logger.warn("Failed to send select_answer event",e)}}async onSelectAnswerReceived(e){if(this.direction!==f.Inbound)return void s.logger.warn("Got select_answer for an outbound call: ignoring");const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(s.logger.info(`Got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),await this.terminate(m.Remote,y.AnsweredElsewhere,!0)):s.logger.warn("Got nonsensical select_answer with null/undefined selected_party_id: ignoring")}async onNegotiateReceived(e){const t=e.getContent(),n=t.description;if(!n||!n.sdp||!n.type)return void s.logger.info("Ignoring invalid m.call.negotiate event");const r=this.direction===f.Inbound,i="offer"===n.type&&(this.makingOffer||"stable"!==this.peerConn.signalingState);if(this.ignoreOffer=!r&&i,this.ignoreOffer)return void s.logger.info("Ignoring colliding negotiate event because we're impolite");const o=this.isLocalOnHold(),c=t[l.SDPStreamMetadataKey];c?this.updateRemoteSDPStreamMetadata(c):s.logger.warn("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConn.setRemoteDescription(n),"offer"===n.type){this.getRidOfRTXCodecs();const e=await this.peerConn.createAnswer();await this.peerConn.setLocalDescription(e),this.sendVoipEvent(a.EventType.CallNegotiate,{description:this.peerConn.localDescription,[l.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()})}}catch(e){s.logger.warn("Failed to complete negotiation",e)}const u=this.isLocalOnHold();o!==u&&(this.emit(v.LocalHoldUnhold,u),this.emit(v.HoldUnhold,u))}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=o.recursivelyAssign(this.remoteSDPStreamMetadata||{},e,!0);for(const e of this.getRemoteFeeds()){var t;const n=e.stream.id,r=this.remoteSDPStreamMetadata[n];e.setAudioVideoMuted(null==r?void 0:r.audio_muted,null==r?void 0:r.video_muted),e.purpose=null===(t=this.remoteSDPStreamMetadata[n])||void 0===t?void 0:t.purpose}}onSDPStreamMetadataChangedReceived(e){const t=e.getContent()[l.SDPStreamMetadataKey];this.updateRemoteSDPStreamMetadata(t)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(v.AssertedIdentityChanged))}callHasEnded(){return this.state===p.Ended}getRidOfRTXCodecs(){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const e=RTCRtpReceiver.getCapabilities("video").codecs,t=[...RTCRtpSender.getCapabilities("video").codecs,...e];for(const e of t)if("video/rtx"===e.mimeType){const n=t.indexOf(e);t.splice(n,1)}for(const e of this.peerConn.getTransceivers()){var n,r;!this.screensharingSenders.includes(e.sender)||"video"!==(null===(n=e.sender.track)||void 0===n?void 0:n.kind)&&"video"!==(null===(r=e.receiver.track)||void 0===r?void 0:r.kind)||e.setCodecPreferences(t)}}setState(e){const t=this.state;this.state=e,this.emit(v.State,e,t)}sendVoipEvent(e,t){return this.client.sendEvent(this.roomId,e,Object.assign({},t,{version:"1",call_id:this.callId,party_id:this.ourPartyId}))}queueCandidate(e){if(this.candidateSendQueue.push(e),this.state===p.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===f.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}async transfer(e){const t=await this.client.getProfileInfo(e),n=b(),r={replacement_id:b(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:n};await this.sendVoipEvent(a.EventType.CallReplaces,r),await this.terminate(m.Local,y.Transfered,!0)}async transferToCall(e){const t=await this.client.getProfileInfo(e.getOpponentMember().userId),n=await this.client.getProfileInfo(this.getOpponentMember().userId),r=b(),i={replacement_id:b(),target_user:{id:this.getOpponentMember().userId,display_name:n.displayname,avatar_url:n.avatar_url},await_call:r};await e.sendVoipEvent(a.EventType.CallReplaces,i);const s={replacement_id:b(),target_user:{id:e.getOpponentMember().userId,display_name:t.displayname,avatar_url:t.avatar_url},create_call:r};await this.sendVoipEvent(a.EventType.CallReplaces,s),await this.terminate(m.Local,y.Transfered,!0),await e.terminate(m.Local,y.Transfered,!0)}async terminate(e,t,n){this.callHasEnded()||(this.callStatsAtEnd=await this.collectCallStats(),this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=null),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=null),t!==y.Replaced&&this.stopAllMedia(),this.deleteAllFeeds(),this.hangupParty=e,this.hangupReason=t,this.setState(p.Ended),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),n&&this.emit(v.Hangup))}stopAllMedia(){s.logger.debug("Stopping all media for call",this.callId);for(const e of this.feeds)if(e.isLocal()&&e.purpose===l.SDPStreamMetadataPurpose.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===l.SDPStreamMetadataPurpose.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else{s.logger.debug("Stopping remote stream",e.stream.id);for(const t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(0===this.listeners(d.EventEmitterEvents.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length)return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e};s.logger.debug("Attempting to send "+e.length+" candidates");try{await this.sendVoipEvent(a.EventType.CallCandidates,t),this.candidateSendTries=0}catch(t){if(t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){s.logger.debug("Failed to send candidates on attempt "+this.candidateSendTries+". Giving up on this call.",t);const e=y.SignallingFailed,n="Signalling failed";return this.emit(v.Error,new _(e,n,t)),void this.hangup(e,!1)}const n=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,s.logger.debug("Failed to send candidates. Retrying in "+n+"ms",t),setTimeout((()=>{this.sendCandidateQueue()}),n)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");this.setState(p.WaitLocalMedia);try{const n=await this.client.getMediaHandler().getUserMediaStream(e,t);A(n.getAudioTracks(),!0),A(n.getVideoTracks(),!0);const r=new u.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:n,purpose:l.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1});await this.placeCallWithCallFeeds([r])}catch(e){return void this.getUserMediaFailed(e)}}async placeCallWithCallFeeds(e){this.checkForErrorListener(),this.direction=f.Outbound,this.client.callEventHandler.calls.set(this.callId,this),await this.client.checkTurnServers()||s.logger.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection(),this.gotCallFeedsForInvite(e)}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e.addEventListener("datachannel",this.onDataChannel),e}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){const t=e.getContent();s.logger.debug(`Choosing party ID ${t.party_id} for call ID ${this.callId}`),this.opponentVersion=t.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=e.sender}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(s.logger.info(`Adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer=null}async addIceCandidates(e){for(const t of e)if(null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex){s.logger.debug("Call "+this.callId+" got remote ICE "+t.sdpMid+" candidate: "+t.candidate);try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer||s.logger.info("Failed to add remote ICE candidate",e)}}else s.logger.debug("Ignoring remote ICE candidate with no sdpMid or sdpMLineIndex")}get hasPeerConnection(){return Boolean(this.peerConn)}}function A(e,t){for(let n=0;n<e.length;n++)e[n].enabled=t}function S(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return s.logger.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return s.logger.error("Exception thrown when trying to access WebRTC",e),!1}return!0}t.MatrixCall=E},7367:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.CallEventHandlerEvent=t.CallEventHandler=void 0;var i=r(n(3693)),s=n(224),o=n(9849),a=n(9435),c=n(4703),l=n(642),u=n(7314),d=n(5489);let h;t.CallEventHandlerEvent=h,function(e){e.Incoming="Call.incoming"}(h||(t.CallEventHandlerEvent=h={})),t.CallEventHandler=class{constructor(e){(0,i.default)(this,"client",void 0),(0,i.default)(this,"calls",void 0),(0,i.default)(this,"callEventBuffer",void 0),(0,i.default)(this,"candidateEventsByCall",void 0),(0,i.default)(this,"evaluateEventBuffer",(async()=>{if(this.client.getSyncState()===u.SyncState.Syncing){await Promise.all(this.callEventBuffer.map((e=>{this.client.decryptEventIfNeeded(e)})));const e=new Set;for(const t of this.callEventBuffer)t.getType()!==c.EventType.CallAnswer&&t.getType()!==c.EventType.CallHangup||e.add(t.getContent().call_id);for(const t of this.callEventBuffer)if(t.getType()!==c.EventType.CallInvite||!e.has(t.getContent().call_id))try{await this.handleCallEvent(t)}catch(e){o.logger.error("Caught exception handling call event",e)}this.callEventBuffer=[]}})),(0,i.default)(this,"onRoomTimeline",(e=>{this.client.decryptEventIfNeeded(e),(this.eventIsACall(e)||e.isBeingDecrypted())&&this.callEventBuffer.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once(s.MatrixEventEvent.Decrypted,(async()=>{if(this.eventIsACall(e))if(this.callEventBuffer.includes(e))this.evaluateEventBuffer();else try{await this.handleCallEvent(e)}catch(e){o.logger.error("Caught exception handling call event",e)}}))})),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(l.ClientEvent.Sync,this.evaluateEventBuffer),this.client.on(d.RoomEvent.Timeline,this.onRoomTimeline)}stop(){this.client.removeListener(l.ClientEvent.Sync,this.evaluateEventBuffer),this.client.removeListener(d.RoomEvent.Timeline,this.onRoomTimeline)}eventIsACall(e){const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}async handleCallEvent(e){const t=e.getContent(),n=e.getType(),r=e.getSender()===this.client.credentials.userId;let i=t.call_id?this.calls.get(t.call_id):void 0;if(n!==c.EventType.CallInvite)if(n!==c.EventType.CallCandidates)if([c.EventType.CallHangup,c.EventType.CallReject].includes(n))i?i.state!==a.CallState.Ended&&(n===c.EventType.CallHangup?i.onHangupReceived(t):i.onRejectReceived(t),i.state===a.CallState.Ended&&this.calls.delete(t.call_id)):(i=(0,a.createNewMatrixCall)(this.client,e.getRoomId()),i&&(i.callId=t.call_id,i.initWithHangup(e),this.calls.set(t.call_id,i)));else if(i&&i.hasPeerConnection){if(e.getContent().party_id!==i.ourPartyId)switch(n){case c.EventType.CallAnswer:r?i.state===a.CallState.Ringing&&i.onAnsweredElsewhere(t):i.onAnswerReceived(e);break;case c.EventType.CallSelectAnswer:i.onSelectAnswerReceived(e);break;case c.EventType.CallNegotiate:i.onNegotiateReceived(e);break;case c.EventType.CallAssertedIdentity:case c.EventType.CallAssertedIdentityPrefix:i.onAssertedIdentityReceived(e);break;case c.EventType.CallSDPStreamMetadataChanged:case c.EventType.CallSDPStreamMetadataChangedPrefix:i.onSDPStreamMetadataChangedReceived(e)}}else o.logger.info(`Discarding possible call event ${e.getId()} as we don't have a call/peerConn`,n);else{if(r)return;i?i.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e))}else{if(r)return;if(e.getLocalAge()>t.lifetime-3e3)return;if(i&&i.state===a.CallState.Ended)return;i&&o.logger.log(`WARN: Already have a MatrixCall with id ${t.call_id} but got an invite. Clobbering.`);const n=this.client.getTurnServersExpiry()-Date.now();if(o.logger.info("Current turn creds expire in "+n+" ms"),i=(0,a.createNewMatrixCall)(this.client,e.getRoomId(),{forceTURN:this.client.forceTURN}),!i)return void o.logger.log("Incoming call ID "+t.call_id+" but this client doesn't support WebRTC");if(i.callId=t.call_id,await i.initWithInvite(e),this.calls.set(i.callId,i),this.candidateEventsByCall.get(i.callId))for(const e of this.candidateEventsByCall.get(i.callId))i.onRemoteIceCandidatesReceived(e);let s;for(const e of this.calls.values()){const t=[a.CallState.WaitLocalMedia,a.CallState.CreateOffer,a.CallState.InviteSent].includes(e.state);if(i.roomId===e.roomId&&e.direction===a.CallDirection.Outbound&&t){s=e;break}}s?s.state===a.CallState.WaitLocalMedia||s.state===a.CallState.CreateOffer||s.callId>i.callId?(o.logger.log("Glare detected: answering incoming call "+i.callId+" and canceling outgoing call "+s.callId),s.replacedBy(i),i.answer()):(o.logger.log("Glare detected: rejecting incoming call "+i.callId+" and keeping outgoing call "+s.callId),i.hangup(a.CallErrorCode.Replaced,!0)):this.client.emit(h.Incoming,i)}}}},926:(e,t)=>{"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.SDPStreamMetadataPurpose=t.SDPStreamMetadataKey=void 0,t.SDPStreamMetadataKey="org.matrix.msc3077.sdp_stream_metadata",t.SDPStreamMetadataPurpose=n,function(e){e.Usermedia="m.usermedia",e.Screenshare="m.screenshare"}(n||(t.SDPStreamMetadataPurpose=n={}))},1759:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.SPEAKING_THRESHOLD=t.CallFeedEvent=t.CallFeed=void 0;var i=r(n(3693)),s=n(7022);let o;t.SPEAKING_THRESHOLD=-60,t.CallFeedEvent=o,function(e){e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.VolumeChanged="volume_changed",e.Speaking="speaking"}(o||(t.CallFeedEvent=o={}));class a extends s.TypedEventEmitter{constructor(e){super(),(0,i.default)(this,"stream",void 0),(0,i.default)(this,"userId",void 0),(0,i.default)(this,"purpose",void 0),(0,i.default)(this,"speakingVolumeSamples",void 0),(0,i.default)(this,"client",void 0),(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"audioMuted",void 0),(0,i.default)(this,"videoMuted",void 0),(0,i.default)(this,"measuringVolumeActivity",!1),(0,i.default)(this,"audioContext",void 0),(0,i.default)(this,"analyser",void 0),(0,i.default)(this,"frequencyBinCount",void 0),(0,i.default)(this,"speakingThreshold",-60),(0,i.default)(this,"speaking",!1),(0,i.default)(this,"volumeLooperTimeout",void 0),(0,i.default)(this,"onAddTrack",(()=>{this.emit(o.NewStream,this.stream)})),(0,i.default)(this,"volumeLooper",(()=>{if(!this.analyser)return;if(!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(let t=0;t<this.frequencyBinCount.length;t++)this.frequencyBinCount[t]>e&&(e=this.frequencyBinCount[t]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(o.VolumeChanged,e);let t=!1;for(let e=0;e<this.speakingVolumeSamples.length;e++)if(this.speakingVolumeSamples[e]>this.speakingThreshold){t=!0;break}this.speaking!==t&&(this.speaking=t,this.emit(o.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)})),this.client=e.client,this.roomId=e.roomId,this.userId=e.userId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(8).fill(-1/0),this.updateStream(null,e.stream),this.hasAudioTrack&&this.initVolumeMeasuring()}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){t!==e&&(e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),t&&(this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?this.initVolumeMeasuring():this.measureVolumeActivity(!1)),this.emit(o.NewStream,this.stream))}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;this.hasAudioTrack&&e&&(this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount))}getMember(){return this.client.getRoom(this.roomId).getMember(this.userId)}isLocal(){return this.userId===this.client.getUserId()}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(o.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!(this.audioContext&&this.analyser&&this.frequencyBinCount&&this.hasAudioTrack))return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(o.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}dispose(){clearTimeout(this.volumeLooperTimeout)}}t.CallFeed=a},2547:(e,t,n)=>{"use strict";var r=n(4994);Object.defineProperty(t,"__esModule",{value:!0}),t.MediaHandler=void 0;var i=r(n(3693)),s=n(9849),o=n(9435);t.MediaHandler=class{constructor(e){this.client=e,(0,i.default)(this,"audioInput",void 0),(0,i.default)(this,"videoInput",void 0),(0,i.default)(this,"localUserMediaStream",void 0),(0,i.default)(this,"userMediaStreams",[]),(0,i.default)(this,"screensharingStreams",[])}async setAudioInput(e){s.logger.info("LOG setting audio input to",e),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setVideoInput(e){s.logger.info("LOG setting video input to",e),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;const e=new Map;for(const t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(const t of this.client.callEventHandler.calls.values()){if(t.state===o.CallState.Ended||!e.has(t.callId))continue;const{audio:n,video:r}=e.get(t.callId),i=await this.getUserMediaStream(n,r,!1);await t.updateLocalUsermediaStream(i)}}async hasAudioDevice(){return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind)).length>0}async hasVideoDevice(){return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)).length>0}async getUserMediaStream(e,t,n=!0){var r,i,o,a;const c=e&&await this.hasAudioDevice(),l=t&&await this.hasVideoDevice();let u;if(!this.localUserMediaStream||0===this.localUserMediaStream.getAudioTracks().length&&c||0===this.localUserMediaStream.getVideoTracks().length&&l||(null===(r=this.localUserMediaStream.getAudioTracks()[0])||void 0===r||null===(i=r.getSettings())||void 0===i?void 0:i.deviceId)!==this.audioInput||(null===(o=this.localUserMediaStream.getVideoTracks()[0])||void 0===o||null===(a=o.getSettings())||void 0===a?void 0:a.deviceId)!==this.videoInput){const e=this.getUserMediaContraints(c,l);s.logger.log("Getting user media with constraints",e),u=await navigator.mediaDevices.getUserMedia(e);for(const e of u.getTracks()){const t=e.getSettings();"audio"===e.kind?this.audioInput=t.deviceId:"video"===e.kind&&(this.videoInput=t.deviceId)}n&&(this.localUserMediaStream=u)}else{if(u=this.localUserMediaStream.clone(),!c)for(const e of u.getAudioTracks())u.removeTrack(e);if(!l)for(const e of u.getVideoTracks())u.removeTrack(e)}return n&&this.userMediaStreams.push(u),u}stopUserMediaStream(e){s.logger.debug("Stopping usermedia stream",e.id);for(const t of e.getTracks())t.stop();const t=this.userMediaStreams.indexOf(e);-1!==t&&(s.logger.debug("Splicing usermedia stream out stream array",e.id),this.userMediaStreams.splice(t,1)),this.localUserMediaStream===e&&(this.localUserMediaStream=void 0)}async getScreensharingStream(e,t=!0){let n;if(0===this.screensharingStreams.length){const t=this.getScreenshareContraints(e);if(!t)return null;e?(s.logger.debug("Getting screensharing stream using getUserMedia()",e),n=await navigator.mediaDevices.getUserMedia(t)):(s.logger.debug("Getting screensharing stream using getDisplayMedia()"),n=await navigator.mediaDevices.getDisplayMedia(t))}else{const e=this.screensharingStreams[this.screensharingStreams.length-1];s.logger.log("Cloning screensharing stream",e.id),n=e.clone()}return t&&this.screensharingStreams.push(n),n}stopScreensharingStream(e){s.logger.debug("Stopping screensharing stream",e.id);for(const t of e.getTracks())t.stop();const t=this.screensharingStreams.indexOf(e);-1!==t&&(s.logger.debug("Splicing screensharing stream out stream array",e.id),this.screensharingStreams.splice(t,1))}stopAllStreams(){for(const e of this.userMediaStreams)for(const t of e.getTracks())t.stop();for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0}getUserMediaContraints(e,t){const n=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){return e?(s.logger.debug("Using desktop capturer source",e),{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}}}):(s.logger.debug("Not using desktop capturer source"),{audio:!1,video:!0})}}},8859:(e,t,n)=>{var r="function"==typeof Map&&Map.prototype,i=Object.getOwnPropertyDescriptor&&r?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,s=r&&i&&"function"==typeof i.get?i.get:null,o=r&&Map.prototype.forEach,a="function"==typeof Set&&Set.prototype,c=Object.getOwnPropertyDescriptor&&a?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,l=a&&c&&"function"==typeof c.get?c.get:null,u=a&&Set.prototype.forEach,d="function"==typeof WeakMap&&WeakMap.prototype?WeakMap.prototype.has:null,h="function"==typeof WeakSet&&WeakSet.prototype?WeakSet.prototype.has:null,p="function"==typeof WeakRef&&WeakRef.prototype?WeakRef.prototype.deref:null,g=Boolean.prototype.valueOf,f=Object.prototype.toString,m=Function.prototype.toString,v=String.prototype.match,y=String.prototype.slice,_=String.prototype.replace,b=String.prototype.toUpperCase,E=String.prototype.toLowerCase,A=RegExp.prototype.test,S=Array.prototype.concat,w=Array.prototype.join,I=Array.prototype.slice,T=Math.floor,k="function"==typeof BigInt?BigInt.prototype.valueOf:null,R=Object.getOwnPropertySymbols,O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?Symbol.prototype.toString:null,C="function"==typeof Symbol&&"object"==typeof Symbol.iterator,P="function"==typeof Symbol&&Symbol.toStringTag&&(Symbol.toStringTag,1)?Symbol.toStringTag:null,D=Object.prototype.propertyIsEnumerable,N=("function"==typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function x(e,t){if(e===1/0||e===-1/0||e!=e||e&&e>-1e3&&e<1e3||A.call(/e/,t))return t;var n=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"==typeof e){var r=e<0?-T(-e):T(e);if(r!==e){var i=String(r),s=y.call(t,i.length+1);return _.call(i,n,"$&_")+"."+_.call(_.call(s,/([0-9]{3})/g,"$&_"),/_$/,"")}}return _.call(t,n,"$&_")}var M=n(2634),L=M.custom,B=K(L)?L:null;function U(e,t,n){var r="double"===(n.quoteStyle||t)?'"':"'";return r+e+r}function F(e){return _.call(String(e),/"/g,"&quot;")}function j(e){return!("[object Array]"!==G(e)||P&&"object"==typeof e&&P in e)}function q(e){return!("[object RegExp]"!==G(e)||P&&"object"==typeof e&&P in e)}function K(e){if(C)return e&&"object"==typeof e&&e instanceof Symbol;if("symbol"==typeof e)return!0;if(!e||"object"!=typeof e||!O)return!1;try{return O.call(e),!0}catch(e){}return!1}e.exports=function e(t,r,i,a){var c=r||{};if(V(c,"quoteStyle")&&"single"!==c.quoteStyle&&"double"!==c.quoteStyle)throw new TypeError('option "quoteStyle" must be "single" or "double"');if(V(c,"maxStringLength")&&("number"==typeof c.maxStringLength?c.maxStringLength<0&&c.maxStringLength!==1/0:null!==c.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var f=!V(c,"customInspect")||c.customInspect;if("boolean"!=typeof f&&"symbol"!==f)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(V(c,"indent")&&null!==c.indent&&"\t"!==c.indent&&!(parseInt(c.indent,10)===c.indent&&c.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(V(c,"numericSeparator")&&"boolean"!=typeof c.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var b=c.numericSeparator;if(void 0===t)return"undefined";if(null===t)return"null";if("boolean"==typeof t)return t?"true":"false";if("string"==typeof t)return W(t,c);if("number"==typeof t){if(0===t)return 1/0/t>0?"0":"-0";var A=String(t);return b?x(t,A):A}if("bigint"==typeof t){var T=String(t)+"n";return b?x(t,T):T}var R=void 0===c.depth?5:c.depth;if(void 0===i&&(i=0),i>=R&&R>0&&"object"==typeof t)return j(t)?"[Array]":"[Object]";var L,$=function(e,t){var n;if("\t"===e.indent)n="\t";else{if(!("number"==typeof e.indent&&e.indent>0))return null;n=w.call(Array(e.indent+1)," ")}return{base:n,prev:w.call(Array(t+1),n)}}(c,i);if(void 0===a)a=[];else if(H(a,t)>=0)return"[Circular]";function J(t,n,r){if(n&&(a=I.call(a)).push(n),r){var s={depth:c.depth};return V(c,"quoteStyle")&&(s.quoteStyle=c.quoteStyle),e(t,s,i+1,a)}return e(t,c,i+1,a)}if("function"==typeof t&&!q(t)){var ee=function(e){if(e.name)return e.name;var t=v.call(m.call(e),/^function\s*([\w$]+)/);return t?t[1]:null}(t),te=Z(t,J);return"[Function"+(ee?": "+ee:" (anonymous)")+"]"+(te.length>0?" { "+w.call(te,", ")+" }":"")}if(K(t)){var ne=C?_.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):O.call(t);return"object"!=typeof t||C?ne:Y(ne)}if((L=t)&&"object"==typeof L&&("undefined"!=typeof HTMLElement&&L instanceof HTMLElement||"string"==typeof L.nodeName&&"function"==typeof L.getAttribute)){for(var re="<"+E.call(String(t.nodeName)),ie=t.attributes||[],se=0;se<ie.length;se++)re+=" "+ie[se].name+"="+U(F(ie[se].value),"double",c);return re+=">",t.childNodes&&t.childNodes.length&&(re+="..."),re+"</"+E.call(String(t.nodeName))+">"}if(j(t)){if(0===t.length)return"[]";var oe=Z(t,J);return $&&!function(e){for(var t=0;t<e.length;t++)if(H(e[t],"\n")>=0)return!1;return!0}(oe)?"["+Q(oe,$)+"]":"[ "+w.call(oe,", ")+" ]"}if(function(e){return!("[object Error]"!==G(e)||P&&"object"==typeof e&&P in e)}(t)){var ae=Z(t,J);return"cause"in Error.prototype||!("cause"in t)||D.call(t,"cause")?0===ae.length?"["+String(t)+"]":"{ ["+String(t)+"] "+w.call(ae,", ")+" }":"{ ["+String(t)+"] "+w.call(S.call("[cause]: "+J(t.cause),ae),", ")+" }"}if("object"==typeof t&&f){if(B&&"function"==typeof t[B]&&M)return M(t,{depth:R-i});if("symbol"!==f&&"function"==typeof t.inspect)return t.inspect()}if(function(e){if(!s||!e||"object"!=typeof e)return!1;try{s.call(e);try{l.call(e)}catch(e){return!0}return e instanceof Map}catch(e){}return!1}(t)){var ce=[];return o&&o.call(t,(function(e,n){ce.push(J(n,t,!0)+" => "+J(e,t))})),X("Map",s.call(t),ce,$)}if(function(e){if(!l||!e||"object"!=typeof e)return!1;try{l.call(e);try{s.call(e)}catch(e){return!0}return e instanceof Set}catch(e){}return!1}(t)){var le=[];return u&&u.call(t,(function(e){le.push(J(e,t))})),X("Set",l.call(t),le,$)}if(function(e){if(!d||!e||"object"!=typeof e)return!1;try{d.call(e,d);try{h.call(e,h)}catch(e){return!0}return e instanceof WeakMap}catch(e){}return!1}(t))return z("WeakMap");if(function(e){if(!h||!e||"object"!=typeof e)return!1;try{h.call(e,h);try{d.call(e,d)}catch(e){return!0}return e instanceof WeakSet}catch(e){}return!1}(t))return z("WeakSet");if(function(e){if(!p||!e||"object"!=typeof e)return!1;try{return p.call(e),!0}catch(e){}return!1}(t))return z("WeakRef");if(function(e){return!("[object Number]"!==G(e)||P&&"object"==typeof e&&P in e)}(t))return Y(J(Number(t)));if(function(e){if(!e||"object"!=typeof e||!k)return!1;try{return k.call(e),!0}catch(e){}return!1}(t))return Y(J(k.call(t)));if(function(e){return!("[object Boolean]"!==G(e)||P&&"object"==typeof e&&P in e)}(t))return Y(g.call(t));if(function(e){return!("[object String]"!==G(e)||P&&"object"==typeof e&&P in e)}(t))return Y(J(String(t)));if("undefined"!=typeof window&&t===window)return"{ [object Window] }";if("undefined"!=typeof globalThis&&t===globalThis||void 0!==n.g&&t===n.g)return"{ [object globalThis] }";if(!function(e){return!("[object Date]"!==G(e)||P&&"object"==typeof e&&P in e)}(t)&&!q(t)){var ue=Z(t,J),de=N?N(t)===Object.prototype:t instanceof Object||t.constructor===Object,he=t instanceof Object?"":"null prototype",pe=!de&&P&&Object(t)===t&&P in t?y.call(G(t),8,-1):he?"Object":"",ge=(de||"function"!=typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"")+(pe||he?"["+w.call(S.call([],pe||[],he||[]),": ")+"] ":"");return 0===ue.length?ge+"{}":$?ge+"{"+Q(ue,$)+"}":ge+"{ "+w.call(ue,", ")+" }"}return String(t)};var $=Object.prototype.hasOwnProperty||function(e){return e in this};function V(e,t){return $.call(e,t)}function G(e){return f.call(e)}function H(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}function W(e,t){if(e.length>t.maxStringLength){var n=e.length-t.maxStringLength,r="... "+n+" more character"+(n>1?"s":"");return W(y.call(e,0,t.maxStringLength),t)+r}return U(_.call(_.call(e,/(['\\])/g,"\\$1"),/[\x00-\x1f]/g,J),"single",t)}function J(e){var t=e.charCodeAt(0),n={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return n?"\\"+n:"\\x"+(t<16?"0":"")+b.call(t.toString(16))}function Y(e){return"Object("+e+")"}function z(e){return e+" { ? }"}function X(e,t,n,r){return e+" ("+t+") {"+(r?Q(n,r):w.call(n,", "))+"}"}function Q(e,t){if(0===e.length)return"";var n="\n"+t.prev+t.base;return n+w.call(e,","+n)+"\n"+t.prev}function Z(e,t){var n=j(e),r=[];if(n){r.length=e.length;for(var i=0;i<e.length;i++)r[i]=V(e,i)?t(e[i],e):""}var s,o="function"==typeof R?R(e):[];if(C){s={};for(var a=0;a<o.length;a++)s["$"+o[a]]=o[a]}for(var c in e)V(e,c)&&(n&&String(Number(c))===c&&c<e.length||C&&s["$"+c]instanceof Symbol||(A.call(/[^\w$]/,c)?r.push(t(c,e)+": "+t(e[c],e)):r.push(c+": "+t(e[c],e))));if("function"==typeof R)for(var l=0;l<o.length;l++)D.call(e,o[l])&&r.push("["+t(o[l])+"]: "+t(e[o[l]],e));return r}},4116:(e,t,n)=>{"use strict";const r=n(5617),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const o=(e,t)=>new Promise(((n,o)=>{t={onFailedAttempt:()=>{},retries:10,...t};const a=r.operation(t);a.attempt((async r=>{try{n(await e(r))}catch(e){if(!(e instanceof Error))return void o(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)a.stop(),o(e.originalError);else if(e instanceof TypeError&&(c=e.message,!i.includes(c)))a.stop(),o(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void o(e)}a.retry(e)||o(a.mainError())}}var c}))}));e.exports=o,e.exports.default=o,e.exports.AbortError=s},4765:e=>{"use strict";var t=String.prototype.replace,n=/%20/g,r="RFC3986";e.exports={default:r,formatters:{RFC1738:function(e){return t.call(e,n,"+")},RFC3986:function(e){return String(e)}},RFC1738:"RFC1738",RFC3986:r}},5373:(e,t,n)=>{"use strict";var r=n(8636),i=n(2642),s=n(4765);e.exports={formats:s,parse:i,stringify:r}},2642:(e,t,n)=>{"use strict";var r=n(7720),i=Object.prototype.hasOwnProperty,s=Array.isArray,o={allowDots:!1,allowEmptyArrays:!1,allowPrototypes:!1,allowSparse:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decodeDotInKeys:!1,decoder:r.decode,delimiter:"&",depth:5,duplicates:"combine",ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictDepth:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},c=function(e,t){return e&&"string"==typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},l=function(e,t,n,r){if(e){var s=n.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,o=/(\[[^[\]]*])/g,a=n.depth>0&&/(\[[^[\]]*])/.exec(s),l=a?s.slice(0,a.index):s,u=[];if(l){if(!n.plainObjects&&i.call(Object.prototype,l)&&!n.allowPrototypes)return;u.push(l)}for(var d=0;n.depth>0&&null!==(a=o.exec(s))&&d<n.depth;){if(d+=1,!n.plainObjects&&i.call(Object.prototype,a[1].slice(1,-1))&&!n.allowPrototypes)return;u.push(a[1])}if(a){if(!0===n.strictDepth)throw new RangeError("Input depth exceeded depth option of "+n.depth+" and strictDepth is true");u.push("["+s.slice(a.index)+"]")}return function(e,t,n,r){for(var i=r?t:c(t,n),s=e.length-1;s>=0;--s){var o,a=e[s];if("[]"===a&&n.parseArrays)o=n.allowEmptyArrays&&(""===i||n.strictNullHandling&&null===i)?[]:[].concat(i);else{o=n.plainObjects?Object.create(null):{};var l="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,u=n.decodeDotInKeys?l.replace(/%2E/g,"."):l,d=parseInt(u,10);n.parseArrays||""!==u?!isNaN(d)&&a!==u&&String(d)===u&&d>=0&&n.parseArrays&&d<=n.arrayLimit?(o=[])[d]=i:"__proto__"!==u&&(o[u]=i):o={0:i}}i=o}return i}(u,t,n,r)}};e.exports=function(e,t){var n=function(e){if(!e)return o;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.decodeDotInKeys&&"boolean"!=typeof e.decodeDotInKeys)throw new TypeError("`decodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?o.charset:e.charset,n=void 0===e.duplicates?o.duplicates:e.duplicates;if("combine"!==n&&"first"!==n&&"last"!==n)throw new TypeError("The duplicates option must be either combine, first, or last");return{allowDots:void 0===e.allowDots?!0===e.decodeDotInKeys||o.allowDots:!!e.allowDots,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:o.allowEmptyArrays,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:o.allowPrototypes,allowSparse:"boolean"==typeof e.allowSparse?e.allowSparse:o.allowSparse,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:o.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:o.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:o.comma,decodeDotInKeys:"boolean"==typeof e.decodeDotInKeys?e.decodeDotInKeys:o.decodeDotInKeys,decoder:"function"==typeof e.decoder?e.decoder:o.decoder,delimiter:"string"==typeof e.delimiter||r.isRegExp(e.delimiter)?e.delimiter:o.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:o.depth,duplicates:n,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:o.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:o.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:o.plainObjects,strictDepth:"boolean"==typeof e.strictDepth?!!e.strictDepth:o.strictDepth,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:o.strictNullHandling}}(t);if(""===e||null==e)return n.plainObjects?Object.create(null):{};for(var u="string"==typeof e?function(e,t){var n={__proto__:null},l=t.ignoreQueryPrefix?e.replace(/^\?/,""):e;l=l.replace(/%5B/gi,"[").replace(/%5D/gi,"]");var u,d=t.parameterLimit===1/0?void 0:t.parameterLimit,h=l.split(t.delimiter,d),p=-1,g=t.charset;if(t.charsetSentinel)for(u=0;u<h.length;++u)0===h[u].indexOf("utf8=")&&("utf8=%E2%9C%93"===h[u]?g="utf-8":"utf8=%26%2310003%3B"===h[u]&&(g="iso-8859-1"),p=u,u=h.length);for(u=0;u<h.length;++u)if(u!==p){var f,m,v=h[u],y=v.indexOf("]="),_=-1===y?v.indexOf("="):y+1;-1===_?(f=t.decoder(v,o.decoder,g,"key"),m=t.strictNullHandling?null:""):(f=t.decoder(v.slice(0,_),o.decoder,g,"key"),m=r.maybeMap(c(v.slice(_+1),t),(function(e){return t.decoder(e,o.decoder,g,"value")}))),m&&t.interpretNumericEntities&&"iso-8859-1"===g&&(m=a(m)),v.indexOf("[]=")>-1&&(m=s(m)?[m]:m);var b=i.call(n,f);b&&"combine"===t.duplicates?n[f]=r.combine(n[f],m):b&&"last"!==t.duplicates||(n[f]=m)}return n}(e,n):e,d=n.plainObjects?Object.create(null):{},h=Object.keys(u),p=0;p<h.length;++p){var g=h[p],f=l(g,u[g],n,"string"==typeof e);d=r.merge(d,f,n)}return!0===n.allowSparse?d:r.compact(d)}},8636:(e,t,n)=>{"use strict";var r=n(920),i=n(7720),s=n(4765),o=Object.prototype.hasOwnProperty,a={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},c=Array.isArray,l=Array.prototype.push,u=function(e,t){l.apply(e,c(t)?t:[t])},d=Date.prototype.toISOString,h=s.default,p={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:i.encode,encodeValuesOnly:!1,format:h,formatter:s.formatters[h],indices:!1,serializeDate:function(e){return d.call(e)},skipNulls:!1,strictNullHandling:!1},g={},f=function e(t,n,s,o,a,l,d,h,f,m,v,y,_,b,E,A,S,w){for(var I,T=t,k=w,R=0,O=!1;void 0!==(k=k.get(g))&&!O;){var C=k.get(t);if(R+=1,void 0!==C){if(C===R)throw new RangeError("Cyclic object value");O=!0}void 0===k.get(g)&&(R=0)}if("function"==typeof m?T=m(n,T):T instanceof Date?T=_(T):"comma"===s&&c(T)&&(T=i.maybeMap(T,(function(e){return e instanceof Date?_(e):e}))),null===T){if(l)return f&&!A?f(n,p.encoder,S,"key",b):n;T=""}if("string"==typeof(I=T)||"number"==typeof I||"boolean"==typeof I||"symbol"==typeof I||"bigint"==typeof I||i.isBuffer(T))return f?[E(A?n:f(n,p.encoder,S,"key",b))+"="+E(f(T,p.encoder,S,"value",b))]:[E(n)+"="+E(String(T))];var P,D=[];if(void 0===T)return D;if("comma"===s&&c(T))A&&f&&(T=i.maybeMap(T,f)),P=[{value:T.length>0?T.join(",")||null:void 0}];else if(c(m))P=m;else{var N=Object.keys(T);P=v?N.sort(v):N}var x=h?n.replace(/\./g,"%2E"):n,M=o&&c(T)&&1===T.length?x+"[]":x;if(a&&c(T)&&0===T.length)return M+"[]";for(var L=0;L<P.length;++L){var B=P[L],U="object"==typeof B&&void 0!==B.value?B.value:T[B];if(!d||null!==U){var F=y&&h?B.replace(/\./g,"%2E"):B,j=c(T)?"function"==typeof s?s(M,F):M:M+(y?"."+F:"["+F+"]");w.set(t,R);var q=r();q.set(g,w),u(D,e(U,j,s,o,a,l,d,h,"comma"===s&&A&&c(T)?null:f,m,v,y,_,b,E,A,S,q))}}return D};e.exports=function(e,t){var n,i=e,l=function(e){if(!e)return p;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||p.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var n=s.default;if(void 0!==e.format){if(!o.call(s.formatters,e.format))throw new TypeError("Unknown format option provided.");n=e.format}var r,i=s.formatters[n],l=p.filter;if(("function"==typeof e.filter||c(e.filter))&&(l=e.filter),r=e.arrayFormat in a?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":p.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");var u=void 0===e.allowDots?!0===e.encodeDotInKeys||p.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:p.addQueryPrefix,allowDots:u,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:p.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:p.charsetSentinel,commaRoundTrip:e.commaRoundTrip,delimiter:void 0===e.delimiter?p.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:p.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:p.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:p.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:p.encodeValuesOnly,filter:l,format:n,formatter:i,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:p.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:p.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:p.strictNullHandling}}(t);"function"==typeof l.filter?i=(0,l.filter)("",i):c(l.filter)&&(n=l.filter);var d=[];if("object"!=typeof i||null===i)return"";var h=a[l.arrayFormat],g="comma"===h&&l.commaRoundTrip;n||(n=Object.keys(i)),l.sort&&n.sort(l.sort);for(var m=r(),v=0;v<n.length;++v){var y=n[v];l.skipNulls&&null===i[y]||u(d,f(i[y],y,h,g,l.allowEmptyArrays,l.strictNullHandling,l.skipNulls,l.encodeDotInKeys,l.encode?l.encoder:null,l.filter,l.sort,l.allowDots,l.serializeDate,l.format,l.formatter,l.encodeValuesOnly,l.charset,m))}var _=d.join(l.delimiter),b=!0===l.addQueryPrefix?"?":"";return l.charsetSentinel&&("iso-8859-1"===l.charset?b+="utf8=%26%2310003%3B&":b+="utf8=%E2%9C%93&"),_.length>0?b+_:""}},7720:(e,t,n)=>{"use strict";var r=n(4765),i=Object.prototype.hasOwnProperty,s=Array.isArray,o=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),a=function(e,t){for(var n=t&&t.plainObjects?Object.create(null):{},r=0;r<e.length;++r)void 0!==e[r]&&(n[r]=e[r]);return n},c=1024;e.exports={arrayToObject:a,assign:function(e,t){return Object.keys(t).reduce((function(e,n){return e[n]=t[n],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],n=[],r=0;r<t.length;++r)for(var i=t[r],o=i.obj[i.prop],a=Object.keys(o),c=0;c<a.length;++c){var l=a[c],u=o[l];"object"==typeof u&&null!==u&&-1===n.indexOf(u)&&(t.push({obj:o,prop:l}),n.push(u))}return function(e){for(;e.length>1;){var t=e.pop(),n=t.obj[t.prop];if(s(n)){for(var r=[],i=0;i<n.length;++i)void 0!==n[i]&&r.push(n[i]);t.obj[t.prop]=r}}}(t),e},decode:function(e,t,n){var r=e.replace(/\+/g," ");if("iso-8859-1"===n)return r.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(r)}catch(e){return r}},encode:function(e,t,n,i,s){if(0===e.length)return e;var a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var l="",u=0;u<a.length;u+=c){for(var d=a.length>=c?a.slice(u,u+c):a,h=[],p=0;p<d.length;++p){var g=d.charCodeAt(p);45===g||46===g||95===g||126===g||g>=48&&g<=57||g>=65&&g<=90||g>=97&&g<=122||s===r.RFC1738&&(40===g||41===g)?h[h.length]=d.charAt(p):g<128?h[h.length]=o[g]:g<2048?h[h.length]=o[192|g>>6]+o[128|63&g]:g<55296||g>=57344?h[h.length]=o[224|g>>12]+o[128|g>>6&63]+o[128|63&g]:(p+=1,g=65536+((1023&g)<<10|1023&d.charCodeAt(p)),h[h.length]=o[240|g>>18]+o[128|g>>12&63]+o[128|g>>6&63]+o[128|63&g])}l+=h.join("")}return l},isBuffer:function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},maybeMap:function(e,t){if(s(e)){for(var n=[],r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)},merge:function e(t,n,r){if(!n)return t;if("object"!=typeof n){if(s(t))t.push(n);else{if(!t||"object"!=typeof t)return[t,n];(r&&(r.plainObjects||r.allowPrototypes)||!i.call(Object.prototype,n))&&(t[n]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(n);var o=t;return s(t)&&!s(n)&&(o=a(t,r)),s(t)&&s(n)?(n.forEach((function(n,s){if(i.call(t,s)){var o=t[s];o&&"object"==typeof o&&n&&"object"==typeof n?t[s]=e(o,n,r):t.push(n)}else t[s]=n})),t):Object.keys(n).reduce((function(t,s){var o=n[s];return i.call(t,s)?t[s]=e(t[s],o,r):t[s]=o,t}),o)}}},5617:(e,t,n)=>{e.exports=n(8303)},8303:(e,t,n)=>{var r=n(3961);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],i=0;i<t.retries;i++)r.push(this.createTimeout(i,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(i,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var i in r=[],e)"function"==typeof e[i]&&r.push(i);for(var s=0;s<r.length;s++){var o=r[s],a=e[o];e[o]=function(r){var i=t.operation(n),s=Array.prototype.slice.call(arguments,1),o=s.pop();s.push((function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),o.apply(this,arguments))})),i.attempt((function(){r.apply(e,s)}))}.bind(e,a),e[o].options=n}}},3961:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var i=this._errors[r],s=i.message,o=(e[s]||0)+1;e[s]=o,o>=n&&(t=i,n=o)}return t}},6897:(e,t,n)=>{"use strict";var r=n(453),i=n(41),s=n(592)(),o=n(5795),a=n(9675),c=r("%Math.floor%");e.exports=function(e,t){if("function"!=typeof e)throw new a("`fn` is not a function");if("number"!=typeof t||t<0||t>4294967295||c(t)!==t)throw new a("`length` must be a positive 32-bit integer");var n=arguments.length>2&&!!arguments[2],r=!0,l=!0;if("length"in e&&o){var u=o(e,"length");u&&!u.configurable&&(r=!1),u&&!u.writable&&(l=!1)}return(r||l||!n)&&(s?i(e,"length",t,!0,!0):i(e,"length",t)),e}},920:(e,t,n)=>{"use strict";var r=n(453),i=n(8075),s=n(8859),o=n(9675),a=r("%WeakMap%",!0),c=r("%Map%",!0),l=i("WeakMap.prototype.get",!0),u=i("WeakMap.prototype.set",!0),d=i("WeakMap.prototype.has",!0),h=i("Map.prototype.get",!0),p=i("Map.prototype.set",!0),g=i("Map.prototype.has",!0),f=function(e,t){for(var n,r=e;null!==(n=r.next);r=n)if(n.key===t)return r.next=n.next,n.next=e.next,e.next=n,n};e.exports=function(){var e,t,n,r={assert:function(e){if(!r.has(e))throw new o("Side channel does not contain "+s(e))},get:function(r){if(a&&r&&("object"==typeof r||"function"==typeof r)){if(e)return l(e,r)}else if(c){if(t)return h(t,r)}else if(n)return function(e,t){var n=f(e,t);return n&&n.value}(n,r)},has:function(r){if(a&&r&&("object"==typeof r||"function"==typeof r)){if(e)return d(e,r)}else if(c){if(t)return g(t,r)}else if(n)return function(e,t){return!!f(e,t)}(n,r);return!1},set:function(r,i){a&&r&&("object"==typeof r||"function"==typeof r)?(e||(e=new a),u(e,r,i)):c?(t||(t=new c),p(t,r,i)):(n||(n={key:{},next:null}),function(e,t,n){var r=f(e,t);r?r.value=n:e.next={key:t,next:e.next,value:n}}(n,r,i))}};return r}},5072:(e,t,n)=>{"use strict";var r,i=function(){var e={};return function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}e[t]=n}return e[t]}}(),s=[];function o(e){for(var t=-1,n=0;n<s.length;n++)if(s[n].identifier===e){t=n;break}return t}function a(e,t){for(var n={},r=[],i=0;i<e.length;i++){var a=e[i],c=t.base?a[0]+t.base:a[0],l=n[c]||0,u="".concat(c," ").concat(l);n[c]=l+1;var d=o(u),h={css:a[1],media:a[2],sourceMap:a[3]};-1!==d?(s[d].references++,s[d].updater(h)):s.push({identifier:u,updater:f(h,t),references:1}),r.push(u)}return r}function c(e){var t=document.createElement("style"),r=e.attributes||{};if(void 0===r.nonce){var s=n.nc;s&&(r.nonce=s)}if(Object.keys(r).forEach((function(e){t.setAttribute(e,r[e])})),"function"==typeof e.insert)e.insert(t);else{var o=i(e.insert||"head");if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(t)}return t}var l,u=(l=[],function(e,t){return l[e]=t,l.filter(Boolean).join("\n")});function d(e,t,n,r){var i=n?"":r.media?"@media ".concat(r.media," {").concat(r.css,"}"):r.css;if(e.styleSheet)e.styleSheet.cssText=u(t,i);else{var s=document.createTextNode(i),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(s,o[t]):e.appendChild(s)}}function h(e,t,n){var r=n.css,i=n.media,s=n.sourceMap;if(i?e.setAttribute("media",i):e.removeAttribute("media"),s&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),e.styleSheet)e.styleSheet.cssText=r;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(r))}}var p=null,g=0;function f(e,t){var n,r,i;if(t.singleton){var s=g++;n=p||(p=c(t)),r=d.bind(null,n,s,!1),i=d.bind(null,n,s,!0)}else n=c(t),r=h.bind(null,n,t),i=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)};return r(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;r(e=t)}else i()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=(void 0===r&&(r=Boolean(window&&document&&document.all&&!window.atob)),r));var n=a(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var r=0;r<n.length;r++){var i=o(n[r]);s[i].references--}for(var c=a(e,t),l=0;l<n.length;l++){var u=o(n[l]);0===s[u].references&&(s[u].updater(),s.splice(u,1))}n=c}}}},5395:(e,t,n)=>{"use strict";var r=n(144),i=RegExp(Object.keys(r).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function s(e){return r[e]}e.exports=function(e){return e.replace(i,s)}},2634:()=>{},3693:(e,t,n)=>{var r=n(7736);e.exports=function(e,t,n){return(t=r(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},e.exports.__esModule=!0,e.exports.default=e.exports},4994:e=>{e.exports=function(e){return e&&e.__esModule?e:{default:e}},e.exports.__esModule=!0,e.exports.default=e.exports},9045:(e,t,n)=>{var r=n(3738).default;e.exports=function(e,t){if("object"!=r(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=r(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)},e.exports.__esModule=!0,e.exports.default=e.exports},7736:(e,t,n)=>{var r=n(3738).default,i=n(9045);e.exports=function(e){var t=i(e,"string");return"symbol"==r(t)?t:t+""},e.exports.__esModule=!0,e.exports.default=e.exports},3738:e=>{function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},144:e=>{"use strict";e.exports=JSON.parse('{"0":"O","1":"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","𑒿":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","𑌀":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","𑇊":"̣","𑓃":"̣","𐨺":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ","ﱞ":"ﹲّ","ࣲ":"ٍ","ﱟ":"ﹴّ","ﳲ":"ﹷّ","ﱠ":"ﹶّ","ﳳ":"ﹹّ","ﱡ":"ﹸّ","ؚ":"ِ","̗":"ِ","ﳴ":"ﹻّ","ﱢ":"ﹺّ","ﱣ":"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","𑓁":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\\u2028":" ","\\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","¸":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":","ː":":","ꓽ":":","⩴":"::=","⧴":":→","！":"!","ǃ":"!","ⵑ":"!","‼":"!!","⁉":"!?","ʔ":"?","Ɂ":"?","ॽ":"?","Ꭾ":"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","𝅭":".","․":".","܁":".","܂":".","꘎":".","𐩐":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"·","･":"·","᛫":"·","·":"·","⸱":"·","𐄁":"·","•":"·","‧":"·","∙":"·","⋅":"·","ꞏ":"·","ᐧ":"·","⋯":"···","ⵈ":"···","ᑄ":"·<","⋗":"·>","ᐷ":"·>","ᑀ":"·>","ᔯ":"·4","ᑾ":"·b","ᒀ":"·ḃ","ᑺ":"·d","ᒘ":"·J","ᒶ":"·L","ᑶ":"·P","ᑗ":"·U","ᐺ":"·V","ᐼ":"·Ʌ","ᒮ":"·Γ","ᐎ":"·Δ","ᑙ":"·Ո","ᐌ":"·ᐁ","ᐐ":"·ᐄ","ᐒ":"·ᐅ","ᐔ":"·ᐆ","ᐗ":"·ᐊ","ᐙ":"·ᐋ","ᐾ":"·ᐲ","ᑂ":"·ᐴ","ᑆ":"·ᐹ","ᑛ":"·ᑏ","ᑔ":"·ᑐ","ᑝ":"·ᑐ","ᑟ":"·ᑑ","ᑡ":"·ᑕ","ᑣ":"·ᑖ","ᑴ":"·ᑫ","ᑸ":"·ᑮ","ᑼ":"·ᑰ","ᒒ":"·ᒉ","ᒔ":"·ᒋ","ᒖ":"·ᒌ","ᒚ":"·ᒎ","ᒜ":"·ᒐ","ᒞ":"·ᒑ","ᒬ":"·ᒣ","ᒰ":"·ᒦ","ᒲ":"·ᒧ","ᒴ":"·ᒨ","ᒸ":"·ᒫ","ᓉ":"·ᓀ","ᣆ":"·ᓂ","ᣈ":"·ᓃ","ᣊ":"·ᓄ","ᣌ":"·ᓅ","ᓋ":"·ᓇ","ᓍ":"·ᓈ","ᓜ":"·ᓓ","ᓞ":"·ᓕ","ᓠ":"·ᓖ","ᓢ":"·ᓗ","ᓤ":"·ᓘ","ᓦ":"·ᓚ","ᓨ":"·ᓛ","ᓶ":"·ᓭ","ᓸ":"·ᓯ","ᓺ":"·ᓰ","ᓼ":"·ᓱ","ᓾ":"·ᓲ","ᔀ":"·ᓴ","ᔂ":"·ᓵ","ᔗ":"·ᔐ","ᔙ":"·ᔑ","ᔛ":"·ᔒ","ᔝ":"·ᔓ","ᔟ":"·ᔔ","ᔡ":"·ᔕ","ᔣ":"·ᔖ","ᔱ":"·ᔨ","ᔳ":"·ᔩ","ᔵ":"·ᔪ","ᔷ":"·ᔫ","ᔹ":"·ᔭ","ᔻ":"·ᔮ","ᣎ":"·ᕃ","ᣏ":"·ᕆ","ᣐ":"·ᕇ","ᣑ":"·ᕈ","ᣒ":"·ᕉ","ᣓ":"·ᕋ","ᕎ":"·ᕌ","ᕛ":"·ᕚ","ᕨ":"·ᕧ","ᢳ":"·ᢱ","ᢶ":"·ᢴ","ᢹ":"·ᢸ","ᣂ":"·ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","𐩗":"𐩖𐩖","𑑌":"𑑋𑑋","𑙂":"𑙁𑙁","𑱂":"𑱁𑱁","᱿":"᱾᱾","՝":"\'","＇":"\'","‘":"\'","’":"\'","‛":"\'","′":"\'","‵":"\'","՚":"\'","׳":"\'","`":"\'","`":"\'","｀":"\'","´":"\'","΄":"\'","´":"\'","᾽":"\'","᾿":"\'","῾":"\'","ʹ":"\'","ʹ":"\'","ˈ":"\'","ˊ":"\'","ˋ":"\'","˴":"\'","ʻ":"\'","ʽ":"\'","ʼ":"\'","ʾ":"\'","ꞌ":"\'","י":"\'","ߴ":"\'","ߵ":"\'","ᑊ":"\'","ᛌ":"\'","𖽑":"\'","𖽒":"\'","᳓":"\'\'","\\"":"\'\'","＂":"\'\'","“":"\'\'","”":"\'\'","‟":"\'\'","″":"\'\'","‶":"\'\'","〃":"\'\'","״":"\'\'","˝":"\'\'","ʺ":"\'\'","˶":"\'\'","ˮ":"\'\'","ײ":"\'\'","‴":"\'\'\'","‷":"\'\'\'","⁗":"\'\'\'\'","Ɓ":"\'B","Ɗ":"\'D","ŉ":"\'n","Ƥ":"\'P","Ƭ":"\'T","Ƴ":"\'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","🄐":"(A)","⒝":"(b)","🄑":"(B)","⒞":"(c)","🄒":"(C)","⒟":"(d)","🄓":"(D)","⒠":"(e)","🄔":"(E)","⒡":"(f)","🄕":"(F)","⒢":"(g)","🄖":"(G)","⒣":"(h)","🄗":"(H)","⒤":"(i)","⒥":"(j)","🄙":"(J)","⒦":"(k)","🄚":"(K)","⑴":"(l)","🄘":"(l)","⒧":"(l)","🄛":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","🄜":"(M)","⒩":"(n)","🄝":"(N)","⒪":"(o)","🄞":"(O)","⒫":"(p)","🄟":"(P)","⒬":"(q)","🄠":"(Q)","⒭":"(r)","🄡":"(R)","⒨":"(rn)","⒮":"(s)","🄢":"(S)","🄪":"(S)","⒯":"(t)","🄣":"(T)","⒰":"(u)","🄤":"(U)","⒱":"(v)","🄥":"(V)","⒲":"(w)","🄦":"(W)","⒳":"(x)","🄧":"(X)","⒴":"(y)","🄨":"(Y)","⒵":"(z)","🄩":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","🉁":"(三)","㈨":"(九)","㈡":"(二)","🉂":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","🉇":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","🉃":"(安)","🉅":"(打)","🉈":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","🉀":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","🉄":"(点)","㈵":"(特)","🉆":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","𝄔":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬","く":"❬","𡿨":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"¶","⁎":"*","٭":"*","∗":"*","𐌟":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","𝈺":"/","㇓":"/","〳":"/","Ⳇ":"/","ノ":"/","丿":"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\\\","﹨":"\\\\","∖":"\\\\","⟍":"\\\\","⧵":"\\\\","⧹":"\\\\","𝈏":"\\\\","𝈻":"\\\\","㇔":"\\\\","丶":"\\\\","⼂":"\\\\","⳹":"\\\\\\\\","⑊":"\\\\\\\\","⟈":"\\\\ᑕ","ꝸ":"&","૰":"॰","𑂻":"॰","𑇇":"॰","⚬":"॰","𑇛":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","¯":"ˉ","￣":"ˉ","▔":"ˉ","ъ":"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"°","˚":"°","∘":"°","○":"°","◦":"°","⍜":"°̲","⍤":"°̈","℃":"°C","℉":"°F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"©","Ⓡ":"®","Ⓟ":"℗","𝈛":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","𝛛":"∂","𝜕":"∂","𝝏":"∂","𝞉":"∂","𝟃":"∂","𞣌":"∂","𞣍":"∂̵","ð":"∂̵","⌀":"∅","𝛁":"∇","𝛻":"∇","𝜵":"∇","𝝯":"∇","𝞩":"∇","𑢨":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","𐊛":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"÷","‹":"<","❮":"<","˂":"<","𝈶":"<","ᐸ":"<","ᚲ":"<","⋖":"<·","Ⲵ":"<·","ᑅ":"<·","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","𝈷":">","ᐳ":">","𖼿":">","ᑁ":">·","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","𞣈":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","𑇞":"≈","♎":"≏","🝞":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","𝈸":"⊏","𝈹":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","🝱":"⊠","🝕":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","🜊":"☩","🌒":"☽","🌙":"☽","⏾":"☾","🌘":"☾","⧙":"⦚","🜺":"⧟","⨾":"⨟","𐆠":"⳨","♩":"𝅘𝅥","♪":"𝅘𝅥𝅮","⓪":"🄍","↺":"🄎","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー","ᅳ":"ー","ㅡ":"ー","一":"ー","⼀":"ー","ᆖ":"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ","ᆕ":"ーᅮ","ᅴ":"ー丨","ㅢ":"ー丨","ᆗ":"ー丨ᅮ","🄏":"$⃠","₤":"£","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","𑓑":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","𝟐":"2","𝟚":"2","𝟤":"2","𝟮":"2","𝟸":"2","🯲":"2","Ꝛ":"2","Ƨ":"2","Ϩ":"2","Ꙅ":"2","ᒿ":"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","𑓒":"২","೨":"౨","②":"➁","ƻ":"2̵","🄃":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","𝈆":"3","𝟑":"3","𝟛":"3","𝟥":"3","𝟯":"3","𝟹":"3","🯳":"3","Ɜ":"3","Ȝ":"3","Ʒ":"3","Ꝫ":"3","Ⳍ":"3","З":"3","Ӡ":"3","𖼻":"3","𑣊":"3","۳":"٣","𞣉":"٣","૩":"३","③":"➂","Ҙ":"3̦","🄄":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","𝟒":"4","𝟜":"4","𝟦":"4","𝟰":"4","𝟺":"4","🯴":"4","Ꮞ":"4","𑢯":"4","۴":"٤","૪":"४","④":"➃","🄅":"4,","⒋":"4.","ᔰ":"4·","㏣":"4日","㋃":"4月","㍜":"4点","𝟓":"5","𝟝":"5","𝟧":"5","𝟱":"5","𝟻":"5","🯵":"5","Ƽ":"5","𑢻":"5","⑤":"➄","🄆":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","𝟔":"6","𝟞":"6","𝟨":"6","𝟲":"6","𝟼":"6","🯶":"6","Ⳓ":"6","б":"6","Ꮾ":"6","𑣕":"6","۶":"٦","𑓖":"৬","⑥":"➅","🄇":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","𝈒":"7","𝟕":"7","𝟟":"7","𝟩":"7","𝟳":"7","𝟽":"7","🯷":"7","𐓒":"7","𑣆":"7","⑦":"➆","🄈":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","𞣋":"8","𝟖":"8","𝟠":"8","𝟪":"8","𝟴":"8","𝟾":"8","🯸":"8","ȣ":"8","Ȣ":"8","𐌚":"8","૮":"८","⑧":"➇","🄉":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","𝟗":"9","𝟡":"9","𝟫":"9","𝟵":"9","𝟿":"9","🯹":"9","Ꝯ":"9","Ⳋ":"9","𑣌":"9","𑢬":"9","𑣖":"9","१":"٩","𑣤":"٩","۹":"٩","೯":"౯","⑨":"➈","🄊":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a","ａ":"a","𝐚":"a","𝑎":"a","𝒂":"a","𝒶":"a","𝓪":"a","𝔞":"a","𝕒":"a","𝖆":"a","𝖺":"a","𝗮":"a","𝘢":"a","𝙖":"a","𝚊":"a","ɑ":"a","α":"a","𝛂":"a","𝛼":"a","𝜶":"a","𝝰":"a","𝞪":"a","а":"a","ⷶ":"ͣ","Ａ":"A","𝐀":"A","𝐴":"A","𝑨":"A","𝒜":"A","𝓐":"A","𝔄":"A","𝔸":"A","𝕬":"A","𝖠":"A","𝗔":"A","𝘈":"A","𝘼":"A","𝙰":"A","Α":"A","𝚨":"A","𝛢":"A","𝜜":"A","𝝖":"A","𝞐":"A","А":"A","Ꭺ":"A","ᗅ":"A","ꓮ":"A","𖽀":"A","𐊠":"A","⍶":"a̲","ǎ":"ă","Ǎ":"Ă","ȧ":"å","Ȧ":"Å","ẚ":"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA","æ":"ae","ӕ":"ae","Æ":"AE","Ӕ":"AE","ꜵ":"ao","Ꜵ":"AO","🜇":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","𝈗":"Ɐ","ᗄ":"Ɐ","ꓯ":"Ɐ","𐐟":"Ɒ","𝐛":"b","𝑏":"b","𝒃":"b","𝒷":"b","𝓫":"b","𝔟":"b","𝕓":"b","𝖇":"b","𝖻":"b","𝗯":"b","𝘣":"b","𝙗":"b","𝚋":"b","Ƅ":"b","Ь":"b","Ꮟ":"b","ᑲ":"b","ᖯ":"b","Ｂ":"B","ℬ":"B","𝐁":"B","𝐵":"B","𝑩":"B","𝓑":"B","𝔅":"B","𝔹":"B","𝕭":"B","𝖡":"B","𝗕":"B","𝘉":"B","𝘽":"B","𝙱":"B","Ꞵ":"B","Β":"B","𝚩":"B","𝛣":"B","𝜝":"B","𝝗":"B","𝞑":"B","В":"B","Ᏼ":"B","ᗷ":"B","ꓐ":"B","𐊂":"B","𐊡":"B","𐌁":"B","ɓ":"b̔","ᑳ":"ḃ","ƃ":"b̄","Ƃ":"b̄","Б":"b̄","ƀ":"b̵","ҍ":"b̵","Ҍ":"b̵","ѣ":"b̵","Ѣ":"b̵","ᑿ":"b·","ᒁ":"ḃ·","ᒈ":"b\'","Ы":"bl","в":"ʙ","ᏼ":"ʙ","ｃ":"c","ⅽ":"c","𝐜":"c","𝑐":"c","𝒄":"c","𝒸":"c","𝓬":"c","𝔠":"c","𝕔":"c","𝖈":"c","𝖼":"c","𝗰":"c","𝘤":"c","𝙘":"c","𝚌":"c","ᴄ":"c","ϲ":"c","ⲥ":"c","с":"c","ꮯ":"c","𐐽":"c","ⷭ":"ͨ","🝌":"C","𑣲":"C","𑣩":"C","Ｃ":"C","Ⅽ":"C","ℂ":"C","ℭ":"C","𝐂":"C","𝐶":"C","𝑪":"C","𝒞":"C","𝓒":"C","𝕮":"C","𝖢":"C","𝗖":"C","𝘊":"C","𝘾":"C","𝙲":"C","Ϲ":"C","Ⲥ":"C","С":"C","Ꮯ":"C","ꓚ":"C","𐊢":"C","𐌂":"C","𐐕":"C","𐔜":"C","¢":"c̸","ȼ":"c̸","₡":"C⃫","🅮":"C⃠","ç":"c̦","ҫ":"c̦","Ç":"C̦","Ҫ":"C̦","Ƈ":"C\'","℅":"c/o","℆":"c/u","🅭":"㏄\\t⃝","⋴":"ꞓ","ɛ":"ꞓ","ε":"ꞓ","ϵ":"ꞓ","𝛆":"ꞓ","𝛜":"ꞓ","𝜀":"ꞓ","𝜖":"ꞓ","𝜺":"ꞓ","𝝐":"ꞓ","𝝴":"ꞓ","𝞊":"ꞓ","𝞮":"ꞓ","𝟄":"ꞓ","ⲉ":"ꞓ","є":"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","𑣎":"ꞓ","𐐩":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ","Є":"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","𝐝":"d","𝑑":"d","𝒅":"d","𝒹":"d","𝓭":"d","𝔡":"d","𝕕":"d","𝖉":"d","𝖽":"d","𝗱":"d","𝘥":"d","𝙙":"d","𝚍":"d","ԁ":"d","Ꮷ":"d","ᑯ":"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","𝐃":"D","𝐷":"D","𝑫":"D","𝒟":"D","𝓓":"D","𝔇":"D","𝔻":"D","𝕯":"D","𝖣":"D","𝗗":"D","𝘋":"D","𝘿":"D","𝙳":"D","Ꭰ":"D","ᗞ":"D","ᗪ":"D","ꓓ":"D","ɗ":"d̔","ɖ":"d̨","ƌ":"d̄","đ":"d̵","Đ":"D̵","Ð":"D̵","Ɖ":"D̵","₫":"ḏ̵","ꝺ":"Ꝺ","ᑻ":"d·","ᒇ":"d\'","ʤ":"dȝ","ǳ":"dz","ʣ":"dz","ǲ":"Dz","Ǳ":"DZ","ǆ":"dž","ǅ":"Dž","Ǆ":"DŽ","ʥ":"dʑ","ꭰ":"ᴅ","⸹":"ẟ","δ":"ẟ","𝛅":"ẟ","𝛿":"ẟ","𝜹":"ẟ","𝝳":"ẟ","𝞭":"ẟ","ծ":"ẟ","ᕷ":"ẟ","℮":"e","ｅ":"e","ℯ":"e","ⅇ":"e","𝐞":"e","𝑒":"e","𝒆":"e","𝓮":"e","𝔢":"e","𝕖":"e","𝖊":"e","𝖾":"e","𝗲":"e","𝘦":"e","𝙚":"e","𝚎":"e","ꬲ":"e","е":"e","ҽ":"e","ⷷ":"ͤ","⋿":"E","Ｅ":"E","ℰ":"E","𝐄":"E","𝐸":"E","𝑬":"E","𝓔":"E","𝔈":"E","𝔼":"E","𝕰":"E","𝖤":"E","𝗘":"E","𝘌":"E","𝙀":"E","𝙴":"E","Ε":"E","𝚬":"E","𝛦":"E","𝜠":"E","𝝚":"E","𝞔":"E","Е":"E","ⴹ":"E","Ꭼ":"E","ꓰ":"E","𑢦":"E","𑢮":"E","𐊆":"E","ě":"ĕ","Ě":"Ĕ","ɇ":"e̸","Ɇ":"E̸","ҿ":"ę","ꭼ":"ᴇ","ə":"ǝ","ә":"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ","ɚ":"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵","Ә":"Ə","𝈡":"Ɛ","ℇ":"Ɛ","Ԑ":"Ɛ","Ꮛ":"Ɛ","𖼭":"Ɛ","𐐁":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ","з":"ɜ","ҙ":"ɜ̦","𐑂":"ɞ","ꞝ":"ʚ","𐐪":"ʚ","𝐟":"f","𝑓":"f","𝒇":"f","𝒻":"f","𝓯":"f","𝔣":"f","𝕗":"f","𝖋":"f","𝖿":"f","𝗳":"f","𝘧":"f","𝙛":"f","𝚏":"f","ꬵ":"f","ꞙ":"f","ſ":"f","ẝ":"f","ք":"f","𝈓":"F","ℱ":"F","𝐅":"F","𝐹":"F","𝑭":"F","𝓕":"F","𝔉":"F","𝔽":"F","𝕱":"F","𝖥":"F","𝗙":"F","𝘍":"F","𝙁":"F","𝙵":"F","Ꞙ":"F","Ϝ":"F","𝟊":"F","ᖴ":"F","ꓝ":"F","𑣂":"F","𑢢":"F","𐊇":"F","𐊥":"F","𐔥":"F","ƒ":"f̦","Ƒ":"F̦","ᵮ":"f̴","℻":"FAX","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ʩ":"fŋ","ᖵ":"Ⅎ","ꓞ":"Ⅎ","𝈰":"ꟻ","ᖷ":"ꟻ","ｇ":"g","ℊ":"g","𝐠":"g","𝑔":"g","𝒈":"g","𝓰":"g","𝔤":"g","𝕘":"g","𝖌":"g","𝗀":"g","𝗴":"g","𝘨":"g","𝙜":"g","𝚐":"g","ɡ":"g","ᶃ":"g","ƍ":"g","ց":"g","𝐆":"G","𝐺":"G","𝑮":"G","𝒢":"G","𝓖":"G","𝔊":"G","𝔾":"G","𝕲":"G","𝖦":"G","𝗚":"G","𝘎":"G","𝙂":"G","𝙶":"G","Ԍ":"G","Ꮐ":"G","Ᏻ":"G","ꓖ":"G","ᶢ":"ᵍ","ɠ":"g̔","ǧ":"ğ","Ǧ":"Ğ","ǵ":"ģ","ǥ":"g̵","Ǥ":"G̵","Ɠ":"G\'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ","ｈ":"h","ℎ":"h","𝐡":"h","𝒉":"h","𝒽":"h","𝓱":"h","𝔥":"h","𝕙":"h","𝖍":"h","𝗁":"h","𝗵":"h","𝘩":"h","𝙝":"h","𝚑":"h","һ":"h","հ":"h","Ꮒ":"h","Ｈ":"H","ℋ":"H","ℌ":"H","ℍ":"H","𝐇":"H","𝐻":"H","𝑯":"H","𝓗":"H","𝕳":"H","𝖧":"H","𝗛":"H","𝘏":"H","𝙃":"H","𝙷":"H","Η":"H","𝚮":"H","𝛨":"H","𝜢":"H","𝝜":"H","𝞖":"H","Ⲏ":"H","Н":"H","Ꮋ":"H","ᕼ":"H","ꓧ":"H","𐋏":"H","ᵸ":"ᴴ","ɦ":"h̔","ꚕ":"h̔","Ᏺ":"h̔","Ⱨ":"H̩","Ң":"H̩","ħ":"h̵","ℏ":"h̵","ћ":"h̵","Ħ":"H̵","Ӊ":"H̦","Ӈ":"H̦","н":"ʜ","ꮋ":"ʜ","ң":"ʜ̩","ӊ":"ʜ̦","ӈ":"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ","Ꭸ":"Ⱶ","Ꮀ":"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i","ｉ":"i","ⅰ":"i","ℹ":"i","ⅈ":"i","𝐢":"i","𝑖":"i","𝒊":"i","𝒾":"i","𝓲":"i","𝔦":"i","𝕚":"i","𝖎":"i","𝗂":"i","𝗶":"i","𝘪":"i","𝙞":"i","𝚒":"i","ı":"i","𝚤":"i","ɪ":"i","ɩ":"i","ι":"i","ι":"i","ͺ":"i","𝛊":"i","𝜄":"i","𝜾":"i","𝝸":"i","𝞲":"i","і":"i","ꙇ":"i","ӏ":"i","ꭵ":"i","Ꭵ":"i","𑣃":"i","ⓛ":"Ⓘ","⍸":"i̲","ǐ":"ĭ","Ǐ":"Ĭ","ɨ":"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii","ĳ":"ij","ⅳ":"iv","ⅸ":"ix","ｊ":"j","ⅉ":"j","𝐣":"j","𝑗":"j","𝒋":"j","𝒿":"j","𝓳":"j","𝔧":"j","𝕛":"j","𝖏":"j","𝗃":"j","𝗷":"j","𝘫":"j","𝙟":"j","𝚓":"j","ϳ":"j","ј":"j","Ｊ":"J","𝐉":"J","𝐽":"J","𝑱":"J","𝒥":"J","𝓙":"J","𝔍":"J","𝕁":"J","𝕵":"J","𝖩":"J","𝗝":"J","𝘑":"J","𝙅":"J","𝙹":"J","Ʝ":"J","Ϳ":"J","Ј":"J","Ꭻ":"J","ᒍ":"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵","ᒙ":"J·","𝚥":"ȷ","յ":"ȷ","ꭻ":"ᴊ","𝐤":"k","𝑘":"k","𝒌":"k","𝓀":"k","𝓴":"k","𝔨":"k","𝕜":"k","𝖐":"k","𝗄":"k","𝗸":"k","𝘬":"k","𝙠":"k","𝚔":"k","K":"K","Ｋ":"K","𝐊":"K","𝐾":"K","𝑲":"K","𝒦":"K","𝓚":"K","𝔎":"K","𝕂":"K","𝕶":"K","𝖪":"K","𝗞":"K","𝘒":"K","𝙆":"K","𝙺":"K","Κ":"K","𝚱":"K","𝛫":"K","𝜥":"K","𝝟":"K","𝞙":"K","Ⲕ":"K","К":"K","Ꮶ":"K","ᛕ":"K","ꓗ":"K","𐔘":"K","ƙ":"k̔","Ⱪ":"K̩","Қ":"K̩","₭":"K̵","Ꝁ":"K̵","Ҟ":"K̵","Ƙ":"K\'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","𐌠":"l","𞣇":"l","𝟏":"l","𝟙":"l","𝟣":"l","𝟭":"l","𝟷":"l","🯱":"l","I":"l","Ｉ":"l","Ⅰ":"l","ℐ":"l","ℑ":"l","𝐈":"l","𝐼":"l","𝑰":"l","𝓘":"l","𝕀":"l","𝕴":"l","𝖨":"l","𝗜":"l","𝘐":"l","𝙄":"l","𝙸":"l","Ɩ":"l","ｌ":"l","ⅼ":"l","ℓ":"l","𝐥":"l","𝑙":"l","𝒍":"l","𝓁":"l","𝓵":"l","𝔩":"l","𝕝":"l","𝖑":"l","𝗅":"l","𝗹":"l","𝘭":"l","𝙡":"l","𝚕":"l","ǀ":"l","Ι":"l","𝚰":"l","𝛪":"l","𝜤":"l","𝝞":"l","𝞘":"l","Ⲓ":"l","І":"l","Ӏ":"l","ו":"l","ן":"l","ا":"l","𞸀":"l","𞺀":"l","ﺎ":"l","ﺍ":"l","ߊ":"l","ⵏ":"l","ᛁ":"l","ꓲ":"l","𖼨":"l","𐊊":"l","𐌉":"l","𝈪":"L","Ⅼ":"L","ℒ":"L","𝐋":"L","𝐿":"L","𝑳":"L","𝓛":"L","𝔏":"L","𝕃":"L","𝕷":"L","𝖫":"L","𝗟":"L","𝘓":"L","𝙇":"L","𝙻":"L","Ⳑ":"L","Ꮮ":"L","ᒪ":"L","ꓡ":"L","𖼖":"L","𑢣":"L","𑢲":"L","𐐛":"L","𐔦":"L","ﴼ":"l̋","ﴽ":"l̋","ł":"l̸","Ł":"L̸","ɭ":"l̨","Ɨ":"l̵","ƚ":"l̵","ɫ":"l̴","إ":"lٕ","ﺈ":"lٕ","ﺇ":"lٕ","ٳ":"lٕ","ŀ":"l·","Ŀ":"l·","ᒷ":"l·","🄂":"l,","⒈":"l.","ױ":"l\'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点","ǉ":"lj","Ĳ":"lJ","ǈ":"Lj","Ǉ":"LJ","‖":"ll","∥":"ll","Ⅱ":"ll","ǁ":"ll","װ":"ll","𐆙":"l̵l̵","⒒":"ll.","Ⅲ":"lll","𐆘":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点","Ю":"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点","ʪ":"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX","ɮ":"lȝ","ʫ":"lz","أ":"lٴ","ﺄ":"lٴ","ﺃ":"lٴ","ٲ":"lٴ","ٵ":"lٴ","ﷳ":"lكبر","ﷲ":"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","𐑃":"ʟ","Ｍ":"M","Ⅿ":"M","ℳ":"M","𝐌":"M","𝑀":"M","𝑴":"M","𝓜":"M","𝔐":"M","𝕄":"M","𝕸":"M","𝖬":"M","𝗠":"M","𝘔":"M","𝙈":"M","𝙼":"M","Μ":"M","𝚳":"M","𝛭":"M","𝜧":"M","𝝡":"M","𝞛":"M","Ϻ":"M","Ⲙ":"M","М":"M","Ꮇ":"M","ᗰ":"M","ᛖ":"M","ꓟ":"M","𐊰":"M","𐌑":"M","Ӎ":"M̦","🝫":"MB","ⷨ":"ᷟ","𝐧":"n","𝑛":"n","𝒏":"n","𝓃":"n","𝓷":"n","𝔫":"n","𝕟":"n","𝖓":"n","𝗇":"n","𝗻":"n","𝘯":"n","𝙣":"n","𝚗":"n","ո":"n","ռ":"n","Ｎ":"N","ℕ":"N","𝐍":"N","𝑁":"N","𝑵":"N","𝒩":"N","𝓝":"N","𝔑":"N","𝕹":"N","𝖭":"N","𝗡":"N","𝘕":"N","𝙉":"N","𝙽":"N","Ν":"N","𝚴":"N","𝛮":"N","𝜨":"N","𝝢":"N","𝞜":"N","Ⲛ":"N","ꓠ":"N","𐔓":"N","𐆎":"N̊","ɳ":"n̨","ƞ":"n̩","η":"n̩","𝛈":"n̩","𝜂":"n̩","𝜼":"n̩","𝝶":"n̩","𝞰":"n̩","Ɲ":"N̦","ᵰ":"n̴","ǌ":"nj","ǋ":"Nj","Ǌ":"NJ","№":"No","ͷ":"ᴎ","и":"ᴎ","𐑍":"ᴎ","ņ":"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o","ｏ":"o","ℴ":"o","𝐨":"o","𝑜":"o","𝒐":"o","𝓸":"o","𝔬":"o","𝕠":"o","𝖔":"o","𝗈":"o","𝗼":"o","𝘰":"o","𝙤":"o","𝚘":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o","ο":"o","𝛐":"o","𝜊":"o","𝝄":"o","𝝾":"o","𝞸":"o","σ":"o","𝛔":"o","𝜎":"o","𝝈":"o","𝞂":"o","𝞼":"o","ⲟ":"o","о":"o","ჿ":"o","օ":"o","ס":"o","ه":"o","𞸤":"o","𞹤":"o","𞺄":"o","ﻫ":"o","ﻬ":"o","ﻪ":"o","ﻩ":"o","ھ":"o","ﮬ":"o","ﮭ":"o","ﮫ":"o","ﮪ":"o","ہ":"o","ﮨ":"o","ﮩ":"o","ﮧ":"o","ﮦ":"o","ە":"o","ഠ":"o","ဝ":"o","𐓪":"o","𑣈":"o","𑣗":"o","𐐬":"o","߀":"O","০":"O","୦":"O","〇":"O","𑓐":"O","𑣠":"O","𝟎":"O","𝟘":"O","𝟢":"O","𝟬":"O","𝟶":"O","🯰":"O","Ｏ":"O","𝐎":"O","𝑂":"O","𝑶":"O","𝒪":"O","𝓞":"O","𝔒":"O","𝕆":"O","𝕺":"O","𝖮":"O","𝗢":"O","𝘖":"O","𝙊":"O","𝙾":"O","Ο":"O","𝚶":"O","𝛰":"O","𝜪":"O","𝝤":"O","𝞞":"O","Ⲟ":"O","О":"O","Օ":"O","ⵔ":"O","ዐ":"O","ଠ":"O","𐓂":"O","ꓳ":"O","𑢵":"O","𐊒":"O","𐊫":"O","𐐄":"O","𐔖":"O","⁰":"º","ᵒ":"º","ǒ":"ŏ","Ǒ":"Ŏ","ۿ":"ô","Ő":"Ö","ø":"o̸","ꬾ":"o̸","Ø":"O̸","ⵁ":"O̸","Ǿ":"Ó̸","ɵ":"o̵","ꝋ":"o̵","ө":"o̵","ѳ":"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","𝈚":"O̵","🜔":"O̵","Ɵ":"O̵","Ꝋ":"O̵","θ":"O̵","ϑ":"O̵","𝛉":"O̵","𝛝":"O̵","𝜃":"O̵","𝜗":"O̵","𝜽":"O̵","𝝑":"O̵","𝝷":"O̵","𝞋":"O̵","𝞱":"O̵","𝟅":"O̵","Θ":"O̵","ϴ":"O̵","𝚯":"O̵","𝚹":"O̵","𝛩":"O̵","𝛳":"O̵","𝜣":"O̵","𝜭":"O̵","𝝝":"O̵","𝝧":"O̵","𝞗":"O̵","𝞡":"O̵","Ө":"O̵","Ѳ":"O̵","ⴱ":"O̵","Ꮎ":"O̵","Ꮻ":"O̵","ꭴ":"ơ","ﳙ":"oٰ","🄁":"O,","🄀":"O.","ơ":"o\'","Ơ":"O\'","Ꭴ":"O\'","%":"º/₀","٪":"º/₀","⁒":"º/₀","‰":"º/₀₀","؉":"º/₀₀","‱":"º/₀₀₀","؊":"º/₀₀₀","œ":"oe","Œ":"OE","ɶ":"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO","ﳗ":"oج","ﱑ":"oج","ﳘ":"oم","ﱒ":"oم","ﶓ":"oمج","ﶔ":"oمم","ﱓ":"oى","ﱔ":"oى","ൟ":"oരo","တ":"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","𐑋":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","𐐣":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","𐐿":"ɷ","⍴":"p","ｐ":"p","𝐩":"p","𝑝":"p","𝒑":"p","𝓅":"p","𝓹":"p","𝔭":"p","𝕡":"p","𝖕":"p","𝗉":"p","𝗽":"p","𝘱":"p","𝙥":"p","𝚙":"p","ρ":"p","ϱ":"p","𝛒":"p","𝛠":"p","𝜌":"p","𝜚":"p","𝝆":"p","𝝔":"p","𝞀":"p","𝞎":"p","𝞺":"p","𝟈":"p","ⲣ":"p","р":"p","Ｐ":"P","ℙ":"P","𝐏":"P","𝑃":"P","𝑷":"P","𝒫":"P","𝓟":"P","𝔓":"P","𝕻":"P","𝖯":"P","𝗣":"P","𝘗":"P","𝙋":"P","𝙿":"P","Ρ":"P","𝚸":"P","𝛲":"P","𝜬":"P","𝝦":"P","𝞠":"P","Ⲣ":"P","Р":"P","Ꮲ":"P","ᑭ":"P","ꓑ":"P","𐊕":"P","ƥ":"p̔","ᵽ":"p̵","ᑷ":"p·","ᒆ":"P\'","ᴩ":"ᴘ","ꮲ":"ᴘ","φ":"ɸ","ϕ":"ɸ","𝛗":"ɸ","𝛟":"ɸ","𝜑":"ɸ","𝜙":"ɸ","𝝋":"ɸ","𝝓":"ɸ","𝞅":"ɸ","𝞍":"ɸ","𝞿":"ɸ","𝟇":"ɸ","ⲫ":"ɸ","ф":"ɸ","𝐪":"q","𝑞":"q","𝒒":"q","𝓆":"q","𝓺":"q","𝔮":"q","𝕢":"q","𝖖":"q","𝗊":"q","𝗾":"q","𝘲":"q","𝙦":"q","𝚚":"q","ԛ":"q","գ":"q","զ":"q","ℚ":"Q","𝐐":"Q","𝑄":"Q","𝑸":"Q","𝒬":"Q","𝓠":"Q","𝔔":"Q","𝕼":"Q","𝖰":"Q","𝗤":"Q","𝘘":"Q","𝙌":"Q","𝚀":"Q","ⵕ":"Q","ʠ":"q̔","🜀":"QE","ᶐ":"ɋ","ᴋ":"ĸ","κ":"ĸ","ϰ":"ĸ","𝛋":"ĸ","𝛞":"ĸ","𝜅":"ĸ","𝜘":"ĸ","𝜿":"ĸ","𝝒":"ĸ","𝝹":"ĸ","𝞌":"ĸ","𝞳":"ĸ","𝟆":"ĸ","ⲕ":"ĸ","к":"ĸ","ꮶ":"ĸ","қ":"ĸ̩","ҟ":"ĸ̵","𝐫":"r","𝑟":"r","𝒓":"r","𝓇":"r","𝓻":"r","𝔯":"r","𝕣":"r","𝖗":"r","𝗋":"r","𝗿":"r","𝘳":"r","𝙧":"r","𝚛":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r","г":"r","ꮁ":"r","𝈖":"R","ℛ":"R","ℜ":"R","ℝ":"R","𝐑":"R","𝑅":"R","𝑹":"R","𝓡":"R","𝕽":"R","𝖱":"R","𝗥":"R","𝘙":"R","𝙍":"R","𝚁":"R","Ʀ":"R","Ꭱ":"R","Ꮢ":"R","𐒴":"R","ᖇ":"R","ꓣ":"R","𖼵":"R","ɽ":"r̨","ɼ":"r̩","ɍ":"r̵","ғ":"r̵","ᵲ":"r̴","ґ":"r\'","𑣣":"rn","m":"rn","ⅿ":"rn","𝐦":"rn","𝑚":"rn","𝒎":"rn","𝓂":"rn","𝓶":"rn","𝔪":"rn","𝕞":"rn","𝖒":"rn","𝗆":"rn","𝗺":"rn","𝘮":"rn","𝙢":"rn","𝚖":"rn","𑜀":"rn","₥":"rn̸","ɱ":"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ","я":"ᴙ","ᵳ":"ɾ̴","℩":"ɿ","ｓ":"s","𝐬":"s","𝑠":"s","𝒔":"s","𝓈":"s","𝓼":"s","𝔰":"s","𝕤":"s","𝖘":"s","𝗌":"s","𝘀":"s","𝘴":"s","𝙨":"s","𝚜":"s","ꜱ":"s","ƽ":"s","ѕ":"s","ꮪ":"s","𑣁":"s","𐑈":"s","Ｓ":"S","𝐒":"S","𝑆":"S","𝑺":"S","𝒮":"S","𝓢":"S","𝔖":"S","𝕊":"S","𝕾":"S","𝖲":"S","𝗦":"S","𝘚":"S","𝙎":"S","𝚂":"S","Ѕ":"S","Տ":"S","Ꮥ":"S","Ꮪ":"S","ꓢ":"S","𖼺":"S","𐊖":"S","𐐠":"S","ʂ":"s̨","ᵴ":"s̴","ꞵ":"ß","β":"ß","ϐ":"ß","𝛃":"ß","𝛽":"ß","𝜷":"ß","𝝱":"ß","𝞫":"ß","Ᏸ":"ß","🝜":"sss","ﬆ":"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ","Σ":"Ʃ","𝚺":"Ʃ","𝛴":"Ʃ","𝜮":"Ʃ","𝝨":"Ʃ","𝞢":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","𝐭":"t","𝑡":"t","𝒕":"t","𝓉":"t","𝓽":"t","𝔱":"t","𝕥":"t","𝖙":"t","𝗍":"t","𝘁":"t","𝘵":"t","𝙩":"t","𝚝":"t","⊤":"T","⟙":"T","🝨":"T","Ｔ":"T","𝐓":"T","𝑇":"T","𝑻":"T","𝒯":"T","𝓣":"T","𝔗":"T","𝕋":"T","𝕿":"T","𝖳":"T","𝗧":"T","𝘛":"T","𝙏":"T","𝚃":"T","Τ":"T","𝚻":"T","𝛵":"T","𝜯":"T","𝝩":"T","𝞣":"T","Ⲧ":"T","Т":"T","Ꭲ":"T","ꓔ":"T","𖼊":"T","𑢼":"T","𐊗":"T","𐊱":"T","𐌕":"T","ƭ":"t̔","⍡":"T̈","Ⱦ":"T̸","Ț":"Ţ","Ʈ":"T̨","Ҭ":"T̩","₮":"T⃫","ŧ":"t̵","Ŧ":"T̵","ᵵ":"t̴","Ⴀ":"Ꞇ","Ꜩ":"T3","ʨ":"tɕ","℡":"TEL","ꝷ":"tf","ʦ":"ts","ʧ":"tʃ","ꜩ":"tȝ","τ":"ᴛ","𝛕":"ᴛ","𝜏":"ᴛ","𝝉":"ᴛ","𝞃":"ᴛ","𝞽":"ᴛ","т":"ᴛ","ꭲ":"ᴛ","ҭ":"ᴛ̩","ţ":"ƫ","ț":"ƫ","Ꮏ":"ƫ","𝐮":"u","𝑢":"u","𝒖":"u","𝓊":"u","𝓾":"u","𝔲":"u","𝕦":"u","𝖚":"u","𝗎":"u","𝘂":"u","𝘶":"u","𝙪":"u","𝚞":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u","ʋ":"u","υ":"u","𝛖":"u","𝜐":"u","𝝊":"u","𝞄":"u","𝞾":"u","ս":"u","𐓶":"u","𑣘":"u","∪":"U","⋃":"U","𝐔":"U","𝑈":"U","𝑼":"U","𝒰":"U","𝓤":"U","𝔘":"U","𝕌":"U","𝖀":"U","𝖴":"U","𝗨":"U","𝘜":"U","𝙐":"U","𝚄":"U","Ս":"U","ሀ":"U","𐓎":"U","ᑌ":"U","ꓴ":"U","𖽂":"U","𑢸":"U","ǔ":"ŭ","Ǔ":"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵","Ꮜ":"U̵","ᑘ":"U·","ᑧ":"U\'","ᵫ":"ue","ꭣ":"uo","ṃ":"ꭑ","պ":"ɰ","ሣ":"ɰ","℧":"Ʊ","ᘮ":"Ʊ","ᘴ":"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v","ｖ":"v","ⅴ":"v","𝐯":"v","𝑣":"v","𝒗":"v","𝓋":"v","𝓿":"v","𝔳":"v","𝕧":"v","𝖛":"v","𝗏":"v","𝘃":"v","𝘷":"v","𝙫":"v","𝚟":"v","ᴠ":"v","ν":"v","𝛎":"v","𝜈":"v","𝝂":"v","𝝼":"v","𝞶":"v","ѵ":"v","ט":"v","𑜆":"v","ꮩ":"v","𑣀":"v","𝈍":"V","٧":"V","۷":"V","Ⅴ":"V","𝐕":"V","𝑉":"V","𝑽":"V","𝒱":"V","𝓥":"V","𝔙":"V","𝕍":"V","𝖁":"V","𝖵":"V","𝗩":"V","𝘝":"V","𝙑":"V","𝚅":"V","Ѵ":"V","ⴸ":"V","Ꮩ":"V","ᐯ":"V","ꛟ":"V","ꓦ":"V","𖼈":"V","𑢠":"V","𐔝":"V","𐆗":"V̵","ᐻ":"V·","🝬":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","🜈":"Vᷤ","ᴧ":"ʌ","𐓘":"ʌ","٨":"Ʌ","۸":"Ʌ","Λ":"Ʌ","𝚲":"Ʌ","𝛬":"Ʌ","𝜦":"Ʌ","𝝠":"Ʌ","𝞚":"Ʌ","Л":"Ʌ","ⴷ":"Ʌ","𐒰":"Ʌ","ᐱ":"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","𖼽":"Ʌ","𐊍":"Ʌ","Ӆ":"Ʌ̦","ᐽ":"Ʌ·","ɯ":"w","𝐰":"w","𝑤":"w","𝒘":"w","𝓌":"w","𝔀":"w","𝔴":"w","𝕨":"w","𝖜":"w","𝗐":"w","𝘄":"w","𝘸":"w","𝙬":"w","𝚠":"w","ᴡ":"w","ѡ":"w","ԝ":"w","ա":"w","𑜊":"w","𑜎":"w","𑜏":"w","ꮃ":"w","𑣯":"W","𑣦":"W","𝐖":"W","𝑊":"W","𝑾":"W","𝒲":"W","𝓦":"W","𝔚":"W","𝕎":"W","𝖂":"W","𝖶":"W","𝗪":"W","𝘞":"W","𝙒":"W","𝚆":"W","Ԝ":"W","Ꮃ":"W","Ꮤ":"W","ꓪ":"W","ѽ":"w҆҇","𑓅":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ","м":"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","×":"x","⤫":"x","⤬":"x","⨯":"x","ｘ":"x","ⅹ":"x","𝐱":"x","𝑥":"x","𝒙":"x","𝓍":"x","𝔁":"x","𝔵":"x","𝕩":"x","𝖝":"x","𝗑":"x","𝘅":"x","𝘹":"x","𝙭":"x","𝚡":"x","х":"x","ᕁ":"x","ᕽ":"x","ⷯ":"ͯ","᙭":"X","╳":"X","𐌢":"X","𑣬":"X","Ｘ":"X","Ⅹ":"X","𝐗":"X","𝑋":"X","𝑿":"X","𝒳":"X","𝓧":"X","𝔛":"X","𝕏":"X","𝖃":"X","𝖷":"X","𝗫":"X","𝘟":"X","𝙓":"X","𝚇":"X","Ꭓ":"X","Χ":"X","𝚾":"X","𝛸":"X","𝜲":"X","𝝬":"X","𝞦":"X","Ⲭ":"X","Х":"X","ⵝ":"X","ᚷ":"X","ꓫ":"X","𐊐":"X","𐊴":"X","𐌗":"X","𐔧":"X","⨰":"ẋ","Ҳ":"X̩","𐆖":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll","ɣ":"y","ᶌ":"y","ｙ":"y","𝐲":"y","𝑦":"y","𝒚":"y","𝓎":"y","𝔂":"y","𝔶":"y","𝕪":"y","𝖞":"y","𝗒":"y","𝘆":"y","𝘺":"y","𝙮":"y","𝚢":"y","ʏ":"y","ỿ":"y","ꭚ":"y","γ":"y","ℽ":"y","𝛄":"y","𝛾":"y","𝜸":"y","𝝲":"y","𝞬":"y","у":"y","ү":"y","ყ":"y","𑣜":"y","Ｙ":"Y","𝐘":"Y","𝑌":"Y","𝒀":"Y","𝒴":"Y","𝓨":"Y","𝔜":"Y","𝕐":"Y","𝖄":"Y","𝖸":"Y","𝗬":"Y","𝘠":"Y","𝙔":"Y","𝚈":"Y","Υ":"Y","ϒ":"Y","𝚼":"Y","𝛶":"Y","𝜰":"Y","𝝪":"Y","𝞤":"Y","Ⲩ":"Y","У":"Y","Ү":"Y","Ꭹ":"Y","Ꮍ":"Y","ꓬ":"Y","𖽃":"Y","𑢤":"Y","𐊲":"Y","ƴ":"y̔","ɏ":"y̵","ұ":"y̵","¥":"Y̵","Ɏ":"Y̵","Ұ":"Y̵","ʒ":"ȝ","ꝫ":"ȝ","ⳍ":"ȝ","ӡ":"ȝ","ჳ":"ȝ","𝐳":"z","𝑧":"z","𝒛":"z","𝓏":"z","𝔃":"z","𝔷":"z","𝕫":"z","𝖟":"z","𝗓":"z","𝘇":"z","𝘻":"z","𝙯":"z","𝚣":"z","ᴢ":"z","ꮓ":"z","𑣄":"z","𐋵":"Z","𑣥":"Z","Ｚ":"Z","ℤ":"Z","ℨ":"Z","𝐙":"Z","𝑍":"Z","𝒁":"Z","𝒵":"Z","𝓩":"Z","𝖅":"Z","𝖹":"Z","𝗭":"Z","𝘡":"Z","𝙕":"Z","𝚉":"Z","Ζ":"Z","𝚭":"Z","𝛧":"Z","𝜡":"Z","𝝛":"Z","𝞕":"Z","Ꮓ":"Z","ꓜ":"Z","𑢩":"Z","ʐ":"z̨","ƶ":"z̵","Ƶ":"Z̵","ȥ":"z̦","Ȥ":"Z̦","ᵶ":"z̴","ƿ":"þ","ϸ":"þ","Ϸ":"Þ","𐓄":"Þ","⁹":"ꝰ","ᴤ":"ƨ","ϩ":"ƨ","ꙅ":"ƨ","ь":"ƅ","ꮟ":"ƅ","ы":"ƅi","ꭾ":"ɂ","ˤ":"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","𐓃":"ʘ","ℾ":"Γ","𝚪":"Γ","𝛤":"Γ","𝜞":"Γ","𝝘":"Γ","𝞒":"Γ","Ⲅ":"Γ","Г":"Γ","Ꮁ":"Γ","ᒥ":"Γ","𖼇":"Γ","Ғ":"Γ̵","ᒯ":"Γ·","Ґ":"Γ\'","∆":"Δ","△":"Δ","🜂":"Δ","𝚫":"Δ","𝛥":"Δ","𝜟":"Δ","𝝙":"Δ","𝞓":"Δ","Ⲇ":"Δ","ⵠ":"Δ","ᐃ":"Δ","𖼚":"Δ","𐊅":"Δ","𐊣":"Δ","⍙":"Δ̲","ᐏ":"Δ·","ᐬ":"Δᐠ","𝟋":"ϝ","𝛇":"ζ","𝜁":"ζ","𝜻":"ζ","𝝵":"ζ","𝞯":"ζ","ⳤ":"ϗ","𝛌":"λ","𝜆":"λ","𝝀":"λ","𝝺":"λ","𝞴":"λ","Ⲗ":"λ","𐓛":"λ","µ":"μ","𝛍":"μ","𝜇":"μ","𝝁":"μ","𝝻":"μ","𝞵":"μ","𝛏":"ξ","𝜉":"ξ","𝝃":"ξ","𝝽":"ξ","𝞷":"ξ","𝚵":"Ξ","𝛯":"Ξ","𝜩":"Ξ","𝝣":"Ξ","𝞝":"Ξ","ϖ":"π","ℼ":"π","𝛑":"π","𝛡":"π","𝜋":"π","𝜛":"π","𝝅":"π","𝝕":"π","𝝿":"π","𝞏":"π","𝞹":"π","𝟉":"π","ᴨ":"π","п":"π","∏":"Π","ℿ":"Π","𝚷":"Π","𝛱":"Π","𝜫":"Π","𝝥":"Π","𝞟":"Π","Ⲡ":"Π","П":"Π","ꛛ":"Π","𐊭":"Ϙ","𐌒":"Ϙ","ϛ":"ς","𝛓":"ς","𝜍":"ς","𝝇":"ς","𝞁":"ς","𝞻":"ς","𝚽":"Φ","𝛷":"Φ","𝜱":"Φ","𝝫":"Φ","𝞥":"Φ","Ⲫ":"Φ","Ф":"Φ","Փ":"Φ","ቀ":"Φ","ᛰ":"Φ","𐊳":"Φ","ꭓ":"χ","ꭕ":"χ","𝛘":"χ","𝜒":"χ","𝝌":"χ","𝞆":"χ","𝟀":"χ","ⲭ":"χ","𝛙":"ψ","𝜓":"ψ","𝝍":"ψ","𝞇":"ψ","𝟁":"ψ","ѱ":"ψ","𐓹":"ψ","𝚿":"Ψ","𝛹":"Ψ","𝜳":"Ψ","𝝭":"Ψ","𝞧":"Ψ","Ⲯ":"Ψ","Ѱ":"Ψ","𐓑":"Ψ","ᛘ":"Ψ","𐊵":"Ψ","⍵":"ω","ꞷ":"ω","𝛚":"ω","𝜔":"ω","𝝎":"ω","𝞈":"ω","𝟂":"ω","ⲱ":"ω","ꙍ":"ω","Ω":"Ω","𝛀":"Ω","𝛺":"Ω","𝜴":"Ω","𝝮":"Ω","𝞨":"Ω","ᘯ":"Ω","ᘵ":"Ω","𐊶":"Ω","⍹":"ω̲","ώ":"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ","җ":"ж̩","Җ":"Ж̩","𝈋":"И","Ͷ":"И","ꚡ":"И","𐐥":"И","Й":"Ѝ","Ҋ":"Ѝ̦","ѝ":"й","ҋ":"й̦","𐒼":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","𐓫":"ꙩ","ᷮ":"ⷬ","𐓍":"Ћ","𝈂":"Ӿ","𝈢":"Ѡ","Ꮗ":"Ѡ","ᗯ":"Ѡ","Ѽ":"Ѡ҆҇","ᣭ":"Ѡ·","Ꞷ":"Ꙍ","ӌ":"ҷ","Ӌ":"Ҷ","Ҿ":"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","🜁":"Ꙙ","𖼜":"Ꙙ","ꦒ":"ⰿ","և":"եւ","ኔ":"ձ","ﬔ":"մե","ﬕ":"մի","ﬗ":"մխ","ﬓ":"մն","∩":"Ո","⋂":"Ո","𝉅":"Ո","በ":"Ո","ᑎ":"Ո","ꓵ":"Ո","ᑚ":"Ո·","ᑨ":"Ո\'","ﬖ":"վն","₽":"Ք","˓":"ՙ","ʿ":"ՙ","ℵ":"א","ﬡ":"א","אָ":"אַ","אּ":"אַ","ﭏ":"אל","ℶ":"ב","ℷ":"ג","ℸ":"ד","ﬢ":"ד","ﬣ":"ה","יּ":"יִ","ﬤ":"כ","ﬥ":"ל","ﬦ":"ם","ﬠ":"ע","ﬧ":"ר","שׂ":"שׁ","שּ":"שׁ","שּׂ":"שּׁ","ﬨ":"ת","ﺀ":"ء","۽":"ء͈","ﺂ":"آ","ﺁ":"آ","ﭑ":"ٱ","ﭐ":"ٱ","𞸁":"ب","𞸡":"ب","𞹡":"ب","𞺁":"ب","𞺡":"ب","ﺑ":"ب","ﺒ":"ب","ﺐ":"ب","ﺏ":"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ","ﲠ":"بo","ﳢ":"بo","ﲜ":"بج","ﰅ":"بج","ﲝ":"بح","ﰆ":"بح","ﷂ":"بحى","ﲞ":"بخ","ﰇ":"بخ","ﳒ":"بخ","ﱋ":"بخ","ﶞ":"بخى","ﱪ":"بر","ﱫ":"بز","ﲟ":"بم","ﳡ":"بم","ﱬ":"بم","ﰈ":"بم","ﱭ":"بن","ﱮ":"بى","ﰉ":"بى","ﱯ":"بى","ﰊ":"بى","ﭔ":"ٻ","ﭕ":"ٻ","ﭓ":"ٻ","ﭒ":"ٻ","ې":"ٻ","ﯦ":"ٻ","ﯧ":"ٻ","ﯥ":"ٻ","ﯤ":"ٻ","ﭜ":"ڀ","ﭝ":"ڀ","ﭛ":"ڀ","ﭚ":"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة","ö":"ة","ﺔ":"ة","ﺓ":"ة","ۃ":"ة","𞸕":"ت","𞸵":"ت","𞹵":"ت","𞺕":"ت","𞺵":"ت","ﺗ":"ت","ﺘ":"ت","ﺖ":"ت","ﺕ":"ت","ﲥ":"تo","ﳤ":"تo","ﲡ":"تج","ﰋ":"تج","ﵐ":"تجم","ﶠ":"تجى","ﶟ":"تجى","ﲢ":"تح","ﰌ":"تح","ﵒ":"تحج","ﵑ":"تحج","ﵓ":"تحم","ﲣ":"تخ","ﰍ":"تخ","ﵔ":"تخم","ﶢ":"تخى","ﶡ":"تخى","ﱰ":"تر","ﱱ":"تز","ﲤ":"تم","ﳣ":"تم","ﱲ":"تم","ﰎ":"تم","ﵕ":"تمج","ﵖ":"تمح","ﵗ":"تمخ","ﶤ":"تمى","ﶣ":"تمى","ﱳ":"تن","ﱴ":"تى","ﰏ":"تى","ﱵ":"تى","ﰐ":"تى","ﭠ":"ٺ","ﭡ":"ٺ","ﭟ":"ٺ","ﭞ":"ٺ","ﭤ":"ٿ","ﭥ":"ٿ","ﭣ":"ٿ","ﭢ":"ٿ","𞸂":"ج","𞸢":"ج","𞹂":"ج","𞹢":"ج","𞺂":"ج","𞺢":"ج","ﺟ":"ج","ﺠ":"ج","ﺞ":"ج","ﺝ":"ج","ﲧ":"جح","ﰕ":"جح","ﶦ":"جحى","ﶾ":"جحى","ﷻ":"جل جلlلo","ﲨ":"جم","ﰖ":"جم","ﵙ":"جمح","ﵘ":"جمح","ﶧ":"جمى","ﶥ":"جمى","ﴝ":"جى","ﴁ":"جى","ﴞ":"جى","ﴂ":"جى","ﭸ":"ڃ","ﭹ":"ڃ","ﭷ":"ڃ","ﭶ":"ڃ","ﭴ":"ڄ","ﭵ":"ڄ","ﭳ":"ڄ","ﭲ":"ڄ","ﭼ":"چ","ﭽ":"چ","ﭻ":"چ","ﭺ":"چ","ﮀ":"ڇ","ﮁ":"ڇ","ﭿ":"ڇ","ﭾ":"ڇ","𞸇":"ح","𞸧":"ح","𞹇":"ح","𞹧":"ح","𞺇":"ح","𞺧":"ح","ﺣ":"ح","ﺤ":"ح","ﺢ":"ح","ﺡ":"ح","څ":"حۛ","ځ":"حٔ","ݲ":"حٔ","ﲩ":"حج","ﰗ":"حج","ﶿ":"حجى","ﲪ":"حم","ﰘ":"حم","ﵛ":"حمى","ﵚ":"حمى","ﴛ":"حى","ﳿ":"حى","ﴜ":"حى","ﴀ":"حى","𞸗":"خ","𞸷":"خ","𞹗":"خ","𞹷":"خ","𞺗":"خ","𞺷":"خ","ﺧ":"خ","ﺨ":"خ","ﺦ":"خ","ﺥ":"خ","ﲫ":"خج","ﰙ":"خج","ﰚ":"خح","ﲬ":"خم","ﰛ":"خم","ﴟ":"خى","ﴃ":"خى","ﴠ":"خى","ﴄ":"خى","𐋡":"د","𞸃":"د","𞺃":"د","𞺣":"د","ﺪ":"د","ﺩ":"د","ڈ":"دؕ","ﮉ":"دؕ","ﮈ":"دؕ","ڎ":"دۛ","ﮇ":"دۛ","ﮆ":"دۛ","ۮ":"د̂","ࢮ":"د̤̣","𞸘":"ذ","𞺘":"ذ","𞺸":"ذ","ﺬ":"ذ","ﺫ":"ذ","ﱛ":"ذٰ","ڋ":"ڊؕ","ﮅ":"ڌ","ﮄ":"ڌ","ﮃ":"ڍ","ﮂ":"ڍ","𞸓":"ر","𞺓":"ر","𞺳":"ر","ﺮ":"ر","ﺭ":"ر","ڑ":"رؕ","ﮍ":"رؕ","ﮌ":"رؕ","ژ":"رۛ","ﮋ":"رۛ","ﮊ":"رۛ","ڒ":"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ","ﱜ":"رٰ","ﷶ":"رسول","﷼":"رىlل","𞸆":"ز","𞺆":"ز","𞺦":"ز","ﺰ":"ز","ﺯ":"ز","ࢲ":"ز̂","ݱ":"ڗؕ","𞸎":"س","𞸮":"س","𞹎":"س","𞹮":"س","𞺎":"س","𞺮":"س","ﺳ":"س","ﺴ":"س","ﺲ":"س","ﺱ":"س","ش":"سۛ","𞸔":"سۛ","𞸴":"سۛ","𞹔":"سۛ","𞹴":"سۛ","𞺔":"سۛ","𞺴":"سۛ","ﺷ":"سۛ","ﺸ":"سۛ","ﺶ":"سۛ","ﺵ":"سۛ","ݾ":"س̂","ﴱ":"سo","ﳨ":"سo","ﴲ":"سۛo","ﳪ":"سۛo","ﲭ":"سج","ﴴ":"سج","ﰜ":"سج","ﴭ":"سۛج","ﴷ":"سۛج","ﴥ":"سۛج","ﴉ":"سۛج","ﵝ":"سجح","ﵞ":"سجى","ﵩ":"سۛجى","ﲮ":"سح","ﴵ":"سح","ﰝ":"سح","ﴮ":"سۛح","ﴸ":"سۛح","ﴦ":"سۛح","ﴊ":"سۛح","ﵜ":"سحج","ﵨ":"سۛحم","ﵧ":"سۛحم","ﶪ":"سۛحى","ﲯ":"سخ","ﴶ":"سخ","ﰞ":"سخ","ﴯ":"سۛخ","ﴹ":"سۛخ","ﴧ":"سۛخ","ﴋ":"سۛخ","ﶨ":"سخى","ﷆ":"سخى","ﴪ":"سر","ﴎ":"سر","ﴩ":"سۛر","ﴍ":"سۛر","ﲰ":"سم","ﳧ":"سم","ﰟ":"سم","ﴰ":"سۛم","ﳩ":"سۛم","ﴨ":"سۛم","ﴌ":"سۛم","ﵡ":"سمج","ﵠ":"سمح","ﵟ":"سمح","ﵫ":"سۛمخ","ﵪ":"سۛمخ","ﵣ":"سمم","ﵢ":"سمم","ﵭ":"سۛمم","ﵬ":"سۛمم","ﴗ":"سى","ﳻ":"سى","ﴘ":"سى","ﳼ":"سى","ﴙ":"سۛى","ﳽ":"سۛى","ﴚ":"سۛى","ﳾ":"سۛى","𐋲":"ص","𞸑":"ص","𞸱":"ص","𞹑":"ص","𞹱":"ص","𞺑":"ص","𞺱":"ص","ﺻ":"ص","ﺼ":"ص","ﺺ":"ص","ﺹ":"ص","ڞ":"صۛ","ࢯ":"ص̤̣","ﲱ":"صح","ﰠ":"صح","ﵥ":"صحح","ﵤ":"صحح","ﶩ":"صحى","ﲲ":"صخ","ﴫ":"صر","ﴏ":"صر","ﷵ":"صلعم","ﷹ":"صلى","ﷰ":"صلى","ﷺ":"صلى lللo علىo وسلم","ﲳ":"صم","ﰡ":"صم","ﷅ":"صمم","ﵦ":"صمم","ﴡ":"صى","ﴅ":"صى","ﴢ":"صى","ﴆ":"صى","𞸙":"ض","𞸹":"ض","𞹙":"ض","𞹹":"ض","𞺙":"ض","𞺹":"ض","ﺿ":"ض","ﻀ":"ض","ﺾ":"ض","ﺽ":"ض","ﲴ":"ضج","ﰢ":"ضج","ﲵ":"ضح","ﰣ":"ضح","ﵮ":"ضحى","ﶫ":"ضحى","ﲶ":"ضخ","ﰤ":"ضخ","ﵰ":"ضخم","ﵯ":"ضخم","ﴬ":"ضر","ﴐ":"ضر","ﲷ":"ضم","ﰥ":"ضم","ﴣ":"ضى","ﴇ":"ضى","ﴤ":"ضى","ﴈ":"ضى","𐋨":"ط","𞸈":"ط","𞹨":"ط","𞺈":"ط","𞺨":"ط","ﻃ":"ط","ﻄ":"ط","ﻂ":"ط","ﻁ":"ط","ڟ":"طۛ","ﲸ":"طح","ﰦ":"طح","ﴳ":"طم","ﴺ":"طم","ﰧ":"طم","ﵲ":"طمح","ﵱ":"طمح","ﵳ":"طمم","ﵴ":"طمى","ﴑ":"طى","ﳵ":"طى","ﴒ":"طى","ﳶ":"طى","𞸚":"ظ","𞹺":"ظ","𞺚":"ظ","𞺺":"ظ","ﻇ":"ظ","ﻈ":"ظ","ﻆ":"ظ","ﻅ":"ظ","ﲹ":"ظم","ﴻ":"ظم","ﰨ":"ظم","؏":"ع","𞸏":"ع","𞸯":"ع","𞹏":"ع","𞹯":"ع","𞺏":"ع","𞺯":"ع","ﻋ":"ع","ﻌ":"ع","ﻊ":"ع","ﻉ":"ع","ﲺ":"عج","ﰩ":"عج","ﷄ":"عجم","ﵵ":"عجم","ﷷ":"علىo","ﲻ":"عم","ﰪ":"عم","ﵷ":"عمم","ﵶ":"عمم","ﵸ":"عمى","ﶶ":"عمى","ﴓ":"عى","ﳷ":"عى","ﴔ":"عى","ﳸ":"عى","𞸛":"غ","𞸻":"غ","𞹛":"غ","𞹻":"غ","𞺛":"غ","𞺻":"غ","ﻏ":"غ","ﻐ":"غ","ﻎ":"غ","ﻍ":"غ","ﲼ":"غج","ﰫ":"غج","ﲽ":"غم","ﰬ":"غم","ﵹ":"غمم","ﵻ":"غمى","ﵺ":"غمى","ﴕ":"غى","ﳹ":"غى","ﴖ":"غى","ﳺ":"غى","𞸐":"ف","𞸰":"ف","𞹰":"ف","𞺐":"ف","𞺰":"ف","ﻓ":"ف","ﻔ":"ف","ﻒ":"ف","ﻑ":"ف","ڧ":"ف","ﲾ":"فج","ﰭ":"فج","ﲿ":"فح","ﰮ":"فح","ﳀ":"فخ","ﰯ":"فخ","ﵽ":"فخم","ﵼ":"فخم","ﳁ":"فم","ﰰ":"فم","ﷁ":"فمى","ﱼ":"فى","ﰱ":"فى","ﱽ":"فى","ﰲ":"فى","𞸞":"ڡ","𞹾":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","𞸟":"ڡ","𞹟":"ڡ","ࢼ":"ڡ","ڤ":"ڡۛ","ﭬ":"ڡۛ","ﭭ":"ڡۛ","ﭫ":"ڡۛ","ﭪ":"ڡۛ","ڨ":"ڡۛ","ࢤ":"ڢۛ","ﭰ":"ڦ","ﭱ":"ڦ","ﭯ":"ڦ","ﭮ":"ڦ","𞸒":"ق","𞸲":"ق","𞹒":"ق","𞹲":"ق","𞺒":"ق","𞺲":"ق","ﻗ":"ق","ﻘ":"ق","ﻖ":"ق","ﻕ":"ق","ﳂ":"قح","ﰳ":"قح","ﷱ":"قلى","ﳃ":"قم","ﰴ":"قم","ﶴ":"قمح","ﵾ":"قمح","ﵿ":"قمم","ﶲ":"قمى","ﱾ":"قى","ﰵ":"قى","ﱿ":"قى","ﰶ":"قى","𞸊":"ك","𞸪":"ك","𞹪":"ك","ﻛ":"ك","ﻜ":"ك","ﻚ":"ك","ﻙ":"ك","ک":"ك","ﮐ":"ك","ﮑ":"ك","ﮏ":"ك","ﮎ":"ك","ڪ":"ك","ڭ":"كۛ","ﯕ":"كۛ","ﯖ":"كۛ","ﯔ":"كۛ","ﯓ":"كۛ","ݣ":"كۛ","ﲀ":"كl","ﰷ":"كl","ﳄ":"كج","ﰸ":"كج","ﳅ":"كح","ﰹ":"كح","ﳆ":"كخ","ﰺ":"كخ","ﳇ":"كل","ﳫ":"كل","ﲁ":"كل","ﰻ":"كل","ﳈ":"كم","ﳬ":"كم","ﲂ":"كم","ﰼ":"كم","ﷃ":"كمم","ﶻ":"كمم","ﶷ":"كمى","ﲃ":"كى","ﰽ":"كى","ﲄ":"كى","ﰾ":"كى","ݢ":"ڬ","ﮔ":"گ","ﮕ":"گ","ﮓ":"گ","ﮒ":"گ","ࢰ":"گ","ڴ":"گۛ","ﮜ":"ڱ","ﮝ":"ڱ","ﮛ":"ڱ","ﮚ":"ڱ","ﮘ":"ڳ","ﮙ":"ڳ","ﮗ":"ڳ","ﮖ":"ڳ","𞸋":"ل","𞸫":"ل","𞹋":"ل","𞺋":"ل","𞺫":"ل","ﻟ":"ل","ﻠ":"ل","ﻞ":"ل","ﻝ":"ل","ڷ":"لۛ","ڵ":"ل̆","ﻼ":"لl","ﻻ":"لl","ﻺ":"لlٕ","ﻹ":"لlٕ","ﻸ":"لlٴ","ﻷ":"لlٴ","ﳍ":"لo","ﻶ":"لآ","ﻵ":"لآ","ﳉ":"لج","ﰿ":"لج","ﶃ":"لجج","ﶄ":"لجج","ﶺ":"لجم","ﶼ":"لجم","ﶬ":"لجى","ﳊ":"لح","ﱀ":"لح","ﶵ":"لحم","ﶀ":"لحم","ﶂ":"لحى","ﶁ":"لحى","ﳋ":"لخ","ﱁ":"لخ","ﶆ":"لخم","ﶅ":"لخم","ﳌ":"لم","ﳭ":"لم","ﲅ":"لم","ﱂ":"لم","ﶈ":"لمح","ﶇ":"لمح","ﶭ":"لمى","ﲆ":"لى","ﱃ":"لى","ﲇ":"لى","ﱄ":"لى","𞸌":"م","𞸬":"م","𞹬":"م","𞺌":"م","𞺬":"م","ﻣ":"م","ﻤ":"م","ﻢ":"م","ﻡ":"م","ࢧ":"مۛ","۾":"م͈","ﲈ":"مl","ﳎ":"مج","ﱅ":"مج","ﶌ":"مجح","ﶒ":"مجخ","ﶍ":"مجم","ﷀ":"مجى","ﳏ":"مح","ﱆ":"مح","ﶉ":"محج","ﶊ":"محم","ﷴ":"محمد","ﶋ":"محى","ﳐ":"مخ","ﱇ":"مخ","ﶎ":"مخج","ﶏ":"مخم","ﶹ":"مخى","ﳑ":"مم","ﲉ":"مم","ﱈ":"مم","ﶱ":"ممى","ﱉ":"مى","ﱊ":"مى","𞸍":"ن","𞸭":"ن","𞹍":"ن","𞹭":"ن","𞺍":"ن","𞺭":"ن","ﻧ":"ن","ﻨ":"ن","ﻦ":"ن","ﻥ":"ن","ݨ":"نؕ","ݩ":"ن̆","ﳖ":"نo","ﳯ":"نo","ﶸ":"نجح","ﶽ":"نجح","ﶘ":"نجم","ﶗ":"نجم","ﶙ":"نجى","ﷇ":"نجى","ﳓ":"نح","ﱌ":"نح","ﶕ":"نحم","ﶖ":"نحى","ﶳ":"نحى","ﳔ":"نخ","ﱍ":"نخ","ﲊ":"نر","ﲋ":"نز","ﳕ":"نم","ﳮ":"نم","ﲌ":"نم","ﱎ":"نم","ﶛ":"نمى","ﶚ":"نمى","ﲍ":"نن","ﲎ":"نى","ﱏ":"نى","ﲏ":"نى","ﱐ":"نى","ۂ":"ۀ","ﮥ":"ۀ","ﮤ":"ۀ","𐋤":"و","𞸅":"و","𞺅":"و","𞺥":"و","ﻮ":"و","ﻭ":"و","ࢱ":"و","ۋ":"وۛ","ﯟ":"وۛ","ﯞ":"وۛ","ۇ":"و̓","ﯘ":"و̓","ﯗ":"و̓","ۆ":"و̆","ﯚ":"و̆","ﯙ":"و̆","ۉ":"و̂","ﯣ":"و̂","ﯢ":"و̂","ۈ":"وٰ","ﯜ":"وٰ","ﯛ":"وٰ","ؤ":"وٴ","ﺆ":"وٴ","ﺅ":"وٴ","ٶ":"وٴ","ٷ":"و̓ٴ","ﯝ":"و̓ٴ","ﷸ":"وسلم","ﯡ":"ۅ","ﯠ":"ۅ","ٮ":"ى","𞸜":"ى","𞹼":"ى","ں":"ى","𞸝":"ى","𞹝":"ى","ﮟ":"ى","ﮞ":"ى","ࢽ":"ى","ﯨ":"ى","ﯩ":"ى","ﻰ":"ى","ﻯ":"ى","ي":"ى","𞸉":"ى","𞸩":"ى","𞹉":"ى","𞹩":"ى","𞺉":"ى","𞺩":"ى","ﻳ":"ى","ﻴ":"ى","ﻲ":"ى","ﻱ":"ى","ی":"ى","ﯾ":"ى","ﯿ":"ى","ﯽ":"ى","ﯼ":"ى","ے":"ى","ﮯ":"ى","ﮮ":"ى","ٹ":"ىؕ","ﭨ":"ىؕ","ﭩ":"ىؕ","ﭧ":"ىؕ","ﭦ":"ىؕ","ڻ":"ىؕ","ﮢ":"ىؕ","ﮣ":"ىؕ","ﮡ":"ىؕ","ﮠ":"ىؕ","پ":"ىۛ","ﭘ":"ىۛ","ﭙ":"ىۛ","ﭗ":"ىۛ","ﭖ":"ىۛ","ث":"ىۛ","𞸖":"ىۛ","𞸶":"ىۛ","𞹶":"ىۛ","𞺖":"ىۛ","𞺶":"ىۛ","ﺛ":"ىۛ","ﺜ":"ىۛ","ﺚ":"ىۛ","ﺙ":"ىۛ","ڽ":"ىۛ","ۑ":"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆","ێ":"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ","ﲐ":"ىٰ","ﱝ":"ىٰ","ﳞ":"ىo","ﳱ":"ىo","ﳦ":"ىۛo","ئ":"ىٴ","ﺋ":"ىٴ","ﺌ":"ىٴ","ﺊ":"ىٴ","ﺉ":"ىٴ","ٸ":"ىٴ","ﯫ":"ىٴl","ﯪ":"ىٴl","ﲛ":"ىٴo","ﳠ":"ىٴo","ﯭ":"ىٴo","ﯬ":"ىٴo","ﯸ":"ىٴٻ","ﯷ":"ىٴٻ","ﯶ":"ىٴٻ","ﲗ":"ىٴج","ﰀ":"ىٴج","ﲘ":"ىٴح","ﰁ":"ىٴح","ﲙ":"ىٴخ","ﱤ":"ىٴر","ﱥ":"ىٴز","ﲚ":"ىٴم","ﳟ":"ىٴم","ﱦ":"ىٴم","ﰂ":"ىٴم","ﱧ":"ىٴن","ﯯ":"ىٴو","ﯮ":"ىٴو","ﯱ":"ىٴو̓","ﯰ":"ىٴو̓","ﯳ":"ىٴو̆","ﯲ":"ىٴو̆","ﯵ":"ىٴوٰ","ﯴ":"ىٴوٰ","ﯻ":"ىٴى","ﯺ":"ىٴى","ﱨ":"ىٴى","ﯹ":"ىٴى","ﰃ":"ىٴى","ﱩ":"ىٴى","ﰄ":"ىٴى","ﳚ":"ىج","ﱕ":"ىج","ﰑ":"ىۛج","ﶯ":"ىجى","ﳛ":"ىح","ﱖ":"ىح","ﶮ":"ىحى","ﳜ":"ىخ","ﱗ":"ىخ","ﲑ":"ىر","ﱶ":"ىۛر","ﲒ":"ىز","ﱷ":"ىۛز","ﳝ":"ىم","ﳰ":"ىم","ﲓ":"ىم","ﱘ":"ىم","ﲦ":"ىۛم","ﳥ":"ىۛم","ﱸ":"ىۛم","ﰒ":"ىۛم","ﶝ":"ىمم","ﶜ":"ىمم","ﶰ":"ىمى","ﲔ":"ىن","ﱹ":"ىۛن","ﲕ":"ىى","ﱙ":"ىى","ﲖ":"ىى","ﱚ":"ىى","ﱺ":"ىۛى","ﰓ":"ىۛى","ﱻ":"ىۛى","ﰔ":"ىۛى","ﮱ":"ۓ","ﮰ":"ۓ","𐊸":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ","Մ":"ሆ","Ռ":"ቡ","Ի":"ኮ","Պ":"ጣ","आ":"अा","ऒ":"अाॆ","ओ":"अाे","औ":"अाै","ऄ":"अॆ","ऑ":"अॉ","ऍ":"एॅ","ऎ":"एॆ","ऐ":"एे","ई":"र्इ","ઽ":"ऽ","𑇜":"ꣻ","𑇋":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्","আ":"অা","ৠ":"ঋৃ","ৡ":"ঋৃ","𑒒":"ঘ","𑒔":"চ","𑒖":"জ","𑒘":"ঞ","𑒙":"ট","𑒛":"ড","𑒪":"ণ","𑒞":"ত","𑒟":"থ","𑒠":"দ","𑒡":"ধ","𑒢":"ন","𑒣":"প","𑒩":"ব","𑒧":"ম","𑒨":"য","𑒫":"র","𑒝":"ল","𑒭":"ষ","𑒮":"স","𑓄":"ঽ","𑒰":"া","𑒱":"ি","𑒹":"ে","𑒼":"ো","𑒾":"ৌ","𑓂":"্","𑒽":"ৗ","ਉ":"ੳੁ","ਊ":"ੳੂ","ਆ":"ਅਾ","ਐ":"ਅੈ","ਔ":"ਅੌ","ਇ":"ੲਿ","ਈ":"ੲੀ","ਏ":"ੲੇ","આ":"અા","ઑ":"અાૅ","ઓ":"અાે","ઔ":"અાૈ","ઍ":"અૅ","એ":"અે","ઐ":"અૈ","ଆ":"ଅା","௮":"அ","ர":"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ","ഉ":"உ","ஊ":"உள","ഊ":"உൗ","௭":"எ","௷":"எவ","ஜ":"ஐ","ജ":"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி","ണ":"ண","௺":"நீ","௴":"மீ","௰":"ய","ഴ":"ழ","ௗ":"ள","ை":"ன","ശ":"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ","ಅ":"అ","ಆ":"ఆ","ಇ":"ఇ","ౠ":"ఋా","ౡ":"ఌా","ಒ":"ఒ","ఔ":"ఒౌ","ಔ":"ఒౌ","ఓ":"ఒౕ","ಓ":"ఒౕ","ಜ":"జ","ಞ":"ఞ","ఢ":"డ̣","ಣ":"ణ","థ":"ధּ","భ":"బ̣","ಯ":"య","ఠ":"రּ","ಱ":"ఱ","ಲ":"ల","ష":"వ̣","హ":"వా","మ":"వు","ూ":"ుా","ౄ":"ృా","ೡ":"ಌಾ","ഈ":"ഇൗ","ഐ":"എെ","ഓ":"ഒാ","ഔ":"ഒൗ","ൡ":"ഞ","൫":"ദ്ര","൹":"നു","ഌ":"നു","ങ":"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ","റ":"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","𑐓":"𑐴𑑂𑐒","𑐙":"𑐴𑑂𑐘","𑐤":"𑐴𑑂𑐣","𑐪":"𑐴𑑂𑐩","𑐭":"𑐴𑑂𑐬","𑐯":"𑐴𑑂𑐮","𑗘":"𑖂","𑗙":"𑖂","𑗚":"𑖃","𑗛":"𑖄","𑗜":"𑖲","𑗝":"𑖳","ฃ":"ข","ด":"ค","ต":"ค","ม":"ฆ","ຈ":"จ","ซ":"ช","ฏ":"ฎ","ท":"ฑ","ບ":"บ","ປ":"ป","ຝ":"ฝ","ພ":"พ","ຟ":"ฟ","ฦ":"ภ","ຍ":"ย","។":"ฯ","ๅ":"า","ำ":"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู","แ":"เเ","ໜ":"ຫນ","ໝ":"ຫມ","ຳ":"̊າ","༂":"འུྂཿ","༃":"འུྂ༔","ཪ":"ར","ༀ":"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","𑲲":"𑲪","ႁ":"ဂှ","က":"ဂာ","ၰ":"ဃှ","ၦ":"ပှ","ဟ":"ပာ","ၯ":"ပာှ","ၾ":"ၽှ","ဩ":"သြ","ဪ":"သြော်","႞":"ႃ̊","ឣ":"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ","ᢖ":"ᡜ","ᡕ":"ᠵ","ῶ":"Ꮿ","ᐍ":"ᐁ·","ᐫ":"ᐁᐠ","ᐑ":"ᐄ·","ᐓ":"ᐅ·","ᐭ":"ᐅᐠ","ᐕ":"ᐆ·","ᐘ":"ᐊ·","ᐮ":"ᐊᐠ","ᐚ":"ᐋ·","ᣝ":"ᐞᣟ","ᓑ":"ᐡ","ᕀ":"ᐩ","ᐿ":"ᐲ·","ᑃ":"ᐴ·","⍩":"ᐵ","ᑇ":"ᐹ·","ᑜ":"ᑏ·","⸧":"ᑐ","⊃":"ᑐ","ᑞ":"ᑐ·","ᑩ":"ᑐ\'","⟉":"ᑐ/","⫗":"ᑐᑕ","ᑠ":"ᑑ·","⸦":"ᑕ","⊂":"ᑕ","ᑢ":"ᑕ·","ᑪ":"ᑕ\'","ᑤ":"ᑖ·","ᑵ":"ᑫ·","ᒅ":"ᑫ\'","ᑹ":"ᑮ·","ᑽ":"ᑰ·","ᘃ":"ᒉ","ᒓ":"ᒉ·","ᒕ":"ᒋ·","ᒗ":"ᒌ·","ᒛ":"ᒎ·","ᘂ":"ᒐ","ᒝ":"ᒐ·","ᒟ":"ᒑ·","ᒭ":"ᒣ·","ᒱ":"ᒦ·","ᒳ":"ᒧ·","ᒵ":"ᒨ·","ᒹ":"ᒫ·","ᓊ":"ᓀ·","ᣇ":"ᓂ·","ᣉ":"ᓃ·","ᣋ":"ᓄ·","ᣍ":"ᓅ·","ᓌ":"ᓇ·","ᓎ":"ᓈ·","ᘄ":"ᓓ","ᓝ":"ᓓ·","ᓟ":"ᓕ·","ᓡ":"ᓖ·","ᓣ":"ᓗ·","ᓥ":"ᓘ·","ᘇ":"ᓚ","ᓧ":"ᓚ·","ᓩ":"ᓛ·","ᓷ":"ᓭ·","ᓹ":"ᓯ·","ᓻ":"ᓰ·","ᓽ":"ᓱ·","ᓿ":"ᓲ·","ᔁ":"ᓴ·","ᔃ":"ᓵ·","ᔌ":"ᔋ<","ᔎ":"ᔋb","ᔍ":"ᔋᑕ","ᔏ":"ᔋᒐ","ᔘ":"ᔐ·","ᔚ":"ᔑ·","ᔜ":"ᔒ·","ᔞ":"ᔓ·","ᔠ":"ᔔ·","ᔢ":"ᔕ·","ᔤ":"ᔖ·","ᔲ":"ᔨ·","ᔴ":"ᔩ·","ᔶ":"ᔪ·","ᔸ":"ᔫ·","ᔺ":"ᔭ·","ᔼ":"ᔮ·","ᘢ":"ᕃ","ᣠ":"ᕃ·","ᘣ":"ᕆ","ᘤ":"ᕊ","ᕏ":"ᕌ·","ᖃ":"ᕐb","ᖄ":"ᕐḃ","ᖁ":"ᕐd","ᕿ":"ᕐP","ᙯ":"ᕐᑫ","ᕾ":"ᕐᑬ","ᖀ":"ᕐᑮ","ᖂ":"ᕐᑰ","ᖅ":"ᕐᒃ","ᕜ":"ᕚ·","ᣣ":"ᕞ·","ᣤ":"ᕦ·","ᕩ":"ᕧ·","ᣥ":"ᕫ·","ᣨ":"ᖆ·","ᖑ":"ᖕJ","ᙰ":"ᖕᒉ","ᖎ":"ᖕᒊ","ᖏ":"ᖕᒋ","ᖐ":"ᖕᒌ","ᖒ":"ᖕᒎ","ᖓ":"ᖕᒐ","ᖔ":"ᖕᒑ","ᙳ":"ᖖJ","ᙱ":"ᖖᒋ","ᙲ":"ᖖᒌ","ᙴ":"ᖖᒎ","ᙵ":"ᖖᒐ","ᙶ":"ᖖᒑ","ᣪ":"ᖗ·","ᙷ":"ᖧ·","ᙸ":"ᖨ·","ᙹ":"ᖩ·","ᙺ":"ᖪ·","ᙻ":"ᖫ·","ᙼ":"ᖬ·","ᙽ":"ᖭ·","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ·","ᣲ":"ᘛ·","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ","ˡ":"ᣳ","ʳ":"ᣴ","ˢ":"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ","ᛡ":"ᚼ","⍿":"ᚽ","ᛂ":"ᚽ","𝈿":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","🝔":"ᛜ","𑢷":"ᛜ","𐊔":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","𐓐":"ᛦ","↕":"ᛨ","𐳼":"𐲂","𐳺":"𐲥","ㄱ":"ᄀ","ᆨ":"ᄀ","ᄁ":"ᄀᄀ","ㄲ":"ᄀᄀ","ᆩ":"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ","ᇃ":"ᄀᄅ","ᇻ":"ᄀᄇ","ᆪ":"ᄀᄉ","ㄳ":"ᄀᄉ","ᇄ":"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ","ㄴ":"ᄂ","ᆫ":"ᄂ","ᄓ":"ᄂᄀ","ᇅ":"ᄂᄀ","ᄔ":"ᄂᄂ","ㅥ":"ᄂᄂ","ᇿ":"ᄂᄂ","ᄕ":"ᄂᄃ","ㅦ":"ᄂᄃ","ᇆ":"ᄂᄃ","ퟋ":"ᄂᄅ","ᄖ":"ᄂᄇ","ᅛ":"ᄂᄉ","ᇇ":"ᄂᄉ","ㅧ":"ᄂᄉ","ᅜ":"ᄂᄌ","ᆬ":"ᄂᄌ","ㄵ":"ᄂᄌ","ퟌ":"ᄂᄎ","ᇉ":"ᄂᄐ","ᅝ":"ᄂᄒ","ᆭ":"ᄂᄒ","ㄶ":"ᄂᄒ","ᇈ":"ᄂᅀ","ㅨ":"ᄂᅀ","ㄷ":"ᄃ","ᆮ":"ᄃ","ᄗ":"ᄃᄀ","ᇊ":"ᄃᄀ","ᄄ":"ᄃᄃ","ㄸ":"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ","ᇋ":"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ","ㄹ":"ᄅ","ᆯ":"ᄅ","ꥤ":"ᄅᄀ","ᆰ":"ᄅᄀ","ㄺ":"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ","ᇌ":"ᄅᄀᄉ","ㅩ":"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ","ᄘ":"ᄅᄂ","ᇍ":"ᄅᄂ","ꥦ":"ᄅᄃ","ᇎ":"ᄅᄃ","ㅪ":"ᄅᄃ","ꥧ":"ᄅᄃᄃ","ᇏ":"ᄅᄃᄒ","ᄙ":"ᄅᄅ","ᇐ":"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ","ᆱ":"ᄅᄆ","ㄻ":"ᄅᄆ","ᇑ":"ᄅᄆᄀ","ᇒ":"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ","ᆲ":"ᄅᄇ","ㄼ":"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ","ᇓ":"ᄅᄇᄉ","ㅫ":"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ","ᇕ":"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ","ᇔ":"ᄅᄇᄒ","ꥬ":"ᄅᄉ","ᆳ":"ᄅᄉ","ㄽ":"ᄅᄉ","ᇖ":"ᄅᄉᄉ","ᄛ":"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ","ᇘ":"ᄅᄏ","ᆴ":"ᄅᄐ","ㄾ":"ᄅᄐ","ᆵ":"ᄅᄑ","ㄿ":"ᄅᄑ","ᄚ":"ᄅᄒ","ㅀ":"ᄅᄒ","ᄻ":"ᄅᄒ","ᆶ":"ᄅᄒ","ퟲ":"ᄅᄒ","ᇗ":"ᄅᅀ","ㅬ":"ᄅᅀ","ퟛ":"ᄅᅌ","ᇙ":"ᄅᅙ","ㅭ":"ᄅᅙ","ퟜ":"ᄅᅙᄒ","ㅁ":"ᄆ","ᆷ":"ᄆ","ꥯ":"ᄆᄀ","ᇚ":"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ","ᇛ":"ᄆᄅ","ퟠ":"ᄆᄆ","ᄜ":"ᄆᄇ","ㅮ":"ᄆᄇ","ᇜ":"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ","ᇝ":"ᄆᄉ","ㅯ":"ᄆᄉ","ᇞ":"ᄆᄉᄉ","ᄝ":"ᄆᄋ","ㅱ":"ᄆᄋ","ᇢ":"ᄆᄋ","ퟢ":"ᄆᄌ","ᇠ":"ᄆᄎ","ᇡ":"ᄆᄒ","ᇟ":"ᄆᅀ","ㅰ":"ᄆᅀ","ㅂ":"ᄇ","ᆸ":"ᄇ","ᄞ":"ᄇᄀ","ㅲ":"ᄇᄀ","ᄟ":"ᄇᄂ","ᄠ":"ᄇᄃ","ㅳ":"ᄇᄃ","ퟣ":"ᄇᄃ","ᇣ":"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ","ᄈ":"ᄇᄇ","ㅃ":"ᄇᄇ","ퟦ":"ᄇᄇ","ᄬ":"ᄇᄇᄋ","ㅹ":"ᄇᄇᄋ","ᄡ":"ᄇᄉ","ㅄ":"ᄇᄉ","ᆹ":"ᄇᄉ","ᄢ":"ᄇᄉᄀ","ㅴ":"ᄇᄉᄀ","ᄣ":"ᄇᄉᄃ","ㅵ":"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ","ᄤ":"ᄇᄉᄇ","ᄥ":"ᄇᄉᄉ","ᄦ":"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ","ᄫ":"ᄇᄋ","ㅸ":"ᄇᄋ","ᇦ":"ᄇᄋ","ᄧ":"ᄇᄌ","ㅶ":"ᄇᄌ","ퟨ":"ᄇᄌ","ᄨ":"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ","ᄩ":"ᄇᄐ","ㅷ":"ᄇᄐ","ᄪ":"ᄇᄑ","ᇤ":"ᄇᄑ","ꥴ":"ᄇᄒ","ᇥ":"ᄇᄒ","ㅅ":"ᄉ","ᆺ":"ᄉ","ᄭ":"ᄉᄀ","ㅺ":"ᄉᄀ","ᇧ":"ᄉᄀ","ᄮ":"ᄉᄂ","ㅻ":"ᄉᄂ","ᄯ":"ᄉᄃ","ㅼ":"ᄉᄃ","ᇨ":"ᄉᄃ","ᄰ":"ᄉᄅ","ᇩ":"ᄉᄅ","ᄱ":"ᄉᄆ","ퟪ":"ᄉᄆ","ᄲ":"ᄉᄇ","ㅽ":"ᄉᄇ","ᇪ":"ᄉᄇ","ᄳ":"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ","ᄊ":"ᄉᄉ","ㅆ":"ᄉᄉ","ᆻ":"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ","ᄴ":"ᄉᄉᄉ","ᄵ":"ᄉᄋ","ᄶ":"ᄉᄌ","ㅾ":"ᄉᄌ","ퟯ":"ᄉᄌ","ᄷ":"ᄉᄎ","ퟰ":"ᄉᄎ","ᄸ":"ᄉᄏ","ᄹ":"ᄉᄐ","ퟱ":"ᄉᄐ","ᄺ":"ᄉᄑ","ퟮ":"ᄉᅀ","ㅇ":"ᄋ","ᆼ":"ᄋ","ᅁ":"ᄋᄀ","ᇬ":"ᄋᄀ","ᇭ":"ᄋᄀᄀ","ᅂ":"ᄋᄃ","ꥶ":"ᄋᄅ","ᅃ":"ᄋᄆ","ᅄ":"ᄋᄇ","ᅅ":"ᄋᄉ","ᇱ":"ᄋᄉ","ㆂ":"ᄋᄉ","ᅇ":"ᄋᄋ","ㆀ":"ᄋᄋ","ᇮ":"ᄋᄋ","ᅈ":"ᄋᄌ","ᅉ":"ᄋᄎ","ᇯ":"ᄋᄏ","ᅊ":"ᄋᄐ","ᅋ":"ᄋᄑ","ꥷ":"ᄋᄒ","ᅆ":"ᄋᅀ","ᇲ":"ᄋᅀ","ㆃ":"ᄋᅀ","ㅈ":"ᄌ","ᆽ":"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ","ᅍ":"ᄌᄋ","ᄍ":"ᄌᄌ","ㅉ":"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ","ㅊ":"ᄎ","ᆾ":"ᄎ","ᅒ":"ᄎᄏ","ᅓ":"ᄎᄒ","ㅋ":"ᄏ","ᆿ":"ᄏ","ㅌ":"ᄐ","ᇀ":"ᄐ","ꥹ":"ᄐᄐ","ㅍ":"ᄑ","ᇁ":"ᄑ","ᅖ":"ᄑᄇ","ᇳ":"ᄑᄇ","ퟺ":"ᄑᄉ","ᅗ":"ᄑᄋ","ㆄ":"ᄑᄋ","ᇴ":"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ","ㅎ":"ᄒ","ᇂ":"ᄒ","ᇵ":"ᄒᄂ","ᇶ":"ᄒᄅ","ᇷ":"ᄒᄆ","ᇸ":"ᄒᄇ","ꥻ":"ᄒᄉ","ᅘ":"ᄒᄒ","ㆅ":"ᄒᄒ","ᄽ":"ᄼᄼ","ᄿ":"ᄾᄾ","ㅿ":"ᅀ","ᇫ":"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ","ㆁ":"ᅌ","ᇰ":"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ","ᅏ":"ᅎᅎ","ᅑ":"ᅐᅐ","ㆆ":"ᅙ","ᇹ":"ᅙ","ꥼ":"ᅙᅙ","ㅤ":"ᅠ","ㅏ":"ᅡ","ᆣ":"ᅡー","ᅶ":"ᅡᅩ","ᅷ":"ᅡᅮ","ᅢ":"ᅡ丨","ㅐ":"ᅡ丨","ㅑ":"ᅣ","ᅸ":"ᅣᅩ","ᅹ":"ᅣᅭ","ᆤ":"ᅣᅮ","ᅤ":"ᅣ丨","ㅒ":"ᅣ丨","ㅓ":"ᅥ","ᅼ":"ᅥー","ᅺ":"ᅥᅩ","ᅻ":"ᅥᅮ","ᅦ":"ᅥ丨","ㅔ":"ᅥ丨","ㅕ":"ᅧ","ᆥ":"ᅧᅣ","ᅽ":"ᅧᅩ","ᅾ":"ᅧᅮ","ᅨ":"ᅧ丨","ㅖ":"ᅧ丨","ㅗ":"ᅩ","ᅪ":"ᅩᅡ","ㅘ":"ᅩᅡ","ᅫ":"ᅩᅡ丨","ㅙ":"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨","ᅿ":"ᅩᅥ","ᆀ":"ᅩᅥ丨","ힰ":"ᅩᅧ","ᆁ":"ᅩᅧ丨","ᆂ":"ᅩᅩ","ힱ":"ᅩᅩ丨","ᆃ":"ᅩᅮ","ᅬ":"ᅩ丨","ㅚ":"ᅩ丨","ㅛ":"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨","ᆄ":"ᅭᅣ","ㆇ":"ᅭᅣ","ᆆ":"ᅭᅣ","ᆅ":"ᅭᅣ丨","ㆈ":"ᅭᅣ丨","ힴ":"ᅭᅥ","ᆇ":"ᅭᅩ","ᆈ":"ᅭ丨","ㆉ":"ᅭ丨","ㅜ":"ᅮ","ᆉ":"ᅮᅡ","ᆊ":"ᅮᅡ丨","ᅯ":"ᅮᅥ","ㅝ":"ᅮᅥ","ᆋ":"ᅮᅥー","ᅰ":"ᅮᅥ丨","ㅞ":"ᅮᅥ丨","ힵ":"ᅮᅧ","ᆌ":"ᅮᅧ丨","ᆍ":"ᅮᅮ","ᅱ":"ᅮ丨","ㅟ":"ᅮ丨","ힶ":"ᅮ丨丨","ㅠ":"ᅲ","ᆎ":"ᅲᅡ","ힷ":"ᅲᅡ丨","ᆏ":"ᅲᅥ","ᆐ":"ᅲᅥ丨","ᆑ":"ᅲᅧ","ㆊ":"ᅲᅧ","ᆒ":"ᅲᅧ丨","ㆋ":"ᅲᅧ丨","ힸ":"ᅲᅩ","ᆓ":"ᅲᅮ","ᆔ":"ᅲ丨","ㆌ":"ᅲ丨","ㆍ":"ᆞ","ퟅ":"ᆞᅡ","ᆟ":"ᆞᅥ","ퟆ":"ᆞᅥ丨","ᆠ":"ᆞᅮ","ᆢ":"ᆞᆞ","ᆡ":"ᆞ丨","ㆎ":"ᆞ丨","ヘ":"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","𝈜":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","𝈕":"ꓶ","𝈫":"ꓶ","𖼦":"ꓶ","𐐑":"ꓶ","⅃":"𖼀","𑫦":"𑫥𑫯","𑫨":"𑫥𑫥","𑫩":"𑫥𑫥𑫯","𑫪":"𑫥𑫥𑫰","𑫧":"𑫥𑫰","𑫴":"𑫳𑫯","𑫶":"𑫳𑫳","𑫷":"𑫳𑫳𑫯","𑫸":"𑫳𑫳𑫰","𑫵":"𑫳𑫰","𑫬":"𑫫𑫯","𑫭":"𑫫𑫫","𑫮":"𑫫𑫫𑫯","⊕":"𐊨","⨁":"𐊨","🜨":"𐊨","Ꚛ":"𐊨","▽":"𐊼","𝈔":"𐊼","🜄":"𐊼","⧖":"𐋀","ꞛ":"𐐺","Ꞛ":"𐐒","𐒠":"𐒆","𐏑":"𐎂","𐏓":"𐎓","𒀸":"𐎚","☥":"𐦞","𓋹":"𐦞","〹":"卄","不":"不","丽":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨","ᅵ":"丨","ㅣ":"丨","⼁":"丨","ᆜ":"丨ー","ᆘ":"丨ᅡ","ᆙ":"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨","ᆚ":"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ","ᆛ":"丨ᅮ","ퟃ":"丨ᅲ","ᆝ":"丨ᆞ","ퟄ":"丨丨","串":"串","丸":"丸","丹":"丹","乁":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀","亂":"亂","㇚":"亅","⼅":"亅","了":"了","ニ":"二","⼆":"二","𠄢":"𠄢","⼇":"亠","亮":"亮","⼈":"人","イ":"亻","⺅":"亻","什":"什","仌":"仌","令":"令","你":"你","倂":"併","倂":"併","侀":"侀","來":"來","例":"例","侮":"侮","侮":"侮","侻":"侻","便":"便","值":"値","倫":"倫","偺":"偺","備":"備","像":"像","僚":"僚","僧":"僧","僧":"僧","㒞":"㒞","⼉":"儿","兀":"兀","⺎":"兀","充":"充","免":"免","免":"免","兔":"兔","兤":"兤","⼊":"入","內":"內","全":"全","兩":"兩","ハ":"八","⼋":"八","六":"六","具":"具","𠔜":"𠔜","𠔥":"𠔥","冀":"冀","㒹":"㒹","⼌":"冂","再":"再","𠕋":"𠕋","冒":"冒","冕":"冕","㒻":"㒻","最":"最","⼍":"冖","冗":"冗","冤":"冤","⼎":"冫","冬":"冬","况":"况","况":"况","冷":"冷","凉":"凉","凌":"凌","凜":"凜","凞":"凞","⼏":"几","𠘺":"𠘺","凵":"凵","⼐":"凵","⼑":"刀","⺉":"刂","刃":"刃","切":"切","切":"切","列":"列","利":"利","㓟":"㓟","刺":"刺","刻":"刻","剆":"剆","割":"割","剷":"剷","劉":"劉","𠠄":"𠠄","カ":"力","力":"力","⼒":"力","劣":"劣","㔕":"㔕","劳":"劳","勇":"勇","勇":"勇","勉":"勉","勉":"勉","勒":"勒","勞":"勞","勤":"勤","勤":"勤","勵":"勵","⼓":"勹","勺":"勺","勺":"勺","包":"包","匆":"匆","𠣞":"𠣞","⼔":"匕","北":"北","北":"北","⼕":"匚","⼖":"匸","匿":"匿","⼗":"十","〸":"十","〺":"卅","卉":"卉","࿖":"卍","࿕":"卐","卑":"卑","卑":"卑","博":"博","ト":"卜","⼘":"卜","⼙":"卩","⺋":"㔾","即":"即","卵":"卵","卽":"卽","卿":"卿","卿":"卿","卿":"卿","⼚":"厂","𠨬":"𠨬","⼛":"厶","參":"參","⼜":"又","及":"及","叟":"叟","𠭣":"𠭣","ロ":"口","⼝":"口","囗":"口","⼞":"口","句":"句","叫":"叫","叱":"叱","吆":"吆","吏":"吏","吝":"吝","吸":"吸","呂":"呂","呈":"呈","周":"周","咞":"咞","咢":"咢","咽":"咽","䎛":"㖈","哶":"哶","唐":"唐","啓":"啓","啟":"啓","啕":"啕","啣":"啣","善":"善","善":"善","喇":"喇","喙":"喙","喙":"喙","喝":"喝","喝":"喝","喫":"喫","喳":"喳","嗀":"嗀","嗂":"嗂","嗢":"嗢","嘆":"嘆","嘆":"嘆","噑":"噑","噴":"噴","器":"器","囹":"囹","圖":"圖","圗":"圗","⼟":"土","士":"土","⼠":"土","型":"型","城":"城","㦳":"㘽","埴":"埴","堍":"堍","報":"報","堲":"堲","塀":"塀","塚":"塚","塚":"塚","塞":"塞","填":"塡","壿":"墫","墬":"墬","墳":"墳","壘":"壘","壟":"壟","𡓤":"𡓤","壮":"壮","売":"売","壷":"壷","⼡":"夂","夆":"夆","⼢":"夊","タ":"夕","⼣":"夕","多":"多","夢":"夢","⼤":"大","奄":"奄","奈":"奈","契":"契","奔":"奔","奢":"奢","女":"女","⼥":"女","𡚨":"𡚨","𡛪":"𡛪","姘":"姘","姬":"姬","娛":"娛","娧":"娧","婢":"婢","婦":"婦","嬀":"媯","㛮":"㛮","㛼":"㛼","媵":"媵","嬈":"嬈","嬨":"嬨","嬾":"嬾","嬾":"嬾","⼦":"子","⼧":"宀","宅":"宅","𡧈":"𡧈","寃":"寃","寘":"寘","寧":"寧","寧":"寧","寧":"寧","寮":"寮","寳":"寳","𡬘":"𡬘","⼨":"寸","寿":"寿","将":"将","⼩":"小","尢":"尢","⺐":"尢","⼪":"尢","⺏":"尣","㞁":"㞁","⼫":"尸","尿":"尿","屠":"屠","屢":"屢","層":"層","履":"履","屮":"屮","屮":"屮","⼬":"屮","𡴋":"𡴋","⼭":"山","峀":"峀","岍":"岍","𡷤":"𡷤","𡷦":"𡷦","崙":"崙","嵃":"嵃","嵐":"嵐","嵫":"嵫","嵮":"嵮","嵼":"嵼","嶲":"嶲","嶺":"嶺","⼮":"巛","巢":"巢","エ":"工","⼯":"工","⼰":"己","⺒":"巳","㠯":"㠯","巽":"巽","⼱":"巾","帲":"帡","帨":"帨","帽":"帽","幩":"幩","㡢":"㡢","𢆃":"𢆃","⼲":"干","年":"年","𢆟":"𢆟","⺓":"幺","⼳":"幺","⼴":"广","度":"度","㡼":"㡼","庰":"庰","庳":"庳","庶":"庶","廊":"廊","廊":"廊","廉":"廉","廒":"廒","廓":"廓","廙":"廙","廬":"廬","⼵":"廴","廾":"廾","⼶":"廾","𢌱":"𢌱","𢌱":"𢌱","弄":"弄","⼷":"弋","⼸":"弓","弢":"弢","弢":"弢","⼹":"彐","⺔":"彑","当":"当","㣇":"㣇","⼺":"彡","形":"形","彩":"彩","彫":"彫","⼻":"彳","律":"律","㣣":"㣣","徚":"徚","復":"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","忍":"忍","志":"志","念":"念","忹":"忹","怒":"怒","怜":"怜","恵":"恵","㤜":"㤜","㤺":"㤺","悁":"悁","悔":"悔","悔":"悔","惇":"惇","惘":"惘","惡":"惡","𢛔":"𢛔","愈":"愈","慨":"慨","慄":"慄","慈":"慈","慌":"慌","慌":"慌","慎":"慎","慎":"慎","慠":"慠","慺":"慺","憎":"憎","憎":"憎","憎":"憎","憐":"憐","憤":"憤","憯":"憯","憲":"憲","𢡄":"𢡄","𢡊":"𢡊","懞":"懞","懲":"懲","懲":"懲","懲":"懲","懶":"懶","懶":"懶","戀":"戀","⼽":"戈","成":"成","戛":"戛","戮":"戮","戴":"戴","⼾":"戶","戸":"戶","⼿":"手","⺘":"扌","扝":"扝","抱":"抱","拉":"拉","拏":"拏","拓":"拓","拔":"拔","拼":"拼","拾":"拾","𢬌":"𢬌","挽":"挽","捐":"捐","捨":"捨","捻":"捻","掃":"掃","掠":"掠","掩":"掩","揄":"揄","揤":"揤","摒":"摒","𢯱":"𢯱","搜":"搜","搢":"搢","揅":"揅","摩":"摩","摷":"摷","摾":"摾","㨮":"㨮","搉":"㩁","撚":"撚","撝":"撝","擄":"擄","㩬":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","敏":"敏","敖":"敖","敬":"敬","數":"數","𣀊":"𣀊","⽂":"文","⻫":"斉","⽃":"斗","料":"料","⽄":"斤","⽅":"方","旅":"旅","⽆":"无","⺛":"旡","既":"既","旣":"旣","⽇":"日","易":"易","曶":"㫚","㫤":"㫤","晉":"晉","晩":"晚","晴":"晴","晴":"晴","暑":"暑","暑":"暑","暈":"暈","㬈":"㬈","暜":"暜","暴":"暴","曆":"曆","㬙":"㬙","𣊸":"𣊸","⽈":"曰","更":"更","書":"書","⽉":"月","𣍟":"𣍟","肦":"朌","胐":"朏","胊":"朐","脁":"朓","胶":"㬵","朗":"朗","朗":"朗","朗":"朗","脧":"朘","望":"望","望":"望","幐":"㬺","䐠":"㬻","𣎓":"𣎓","膧":"朣","𣎜":"𣎜","⽊":"木","李":"李","杓":"杓","杖":"杖","杞":"杞","𣏃":"𣏃","柿":"杮","杻":"杻","枅":"枅","林":"林","㭉":"㭉","𣏕":"𣏕","柳":"柳","柺":"柺","栗":"栗","栟":"栟","桒":"桒","𣑭":"𣑭","梁":"梁","梅":"梅","梅":"梅","梎":"梎","梨":"梨","椔":"椔","楂":"楂","㮝":"㮝","㮝":"㮝","槩":"㮣","樧":"榝","榣":"榣","槪":"槪","樂":"樂","樂":"樂","樂":"樂","樓":"樓","𣚣":"𣚣","檨":"檨","櫓":"櫓","櫛":"櫛","欄":"欄","㰘":"㰘","⽋":"欠","次":"次","𣢧":"𣢧","歔":"歔","㱎":"㱎","⽌":"止","⻭":"歯","歲":"歲","歷":"歷","歹":"歹","⽍":"歹","⺞":"歺","殟":"殟","殮":"殮","⽎":"殳","殺":"殺","殺":"殺","殺":"殺","殻":"殻","𣪍":"𣪍","⽏":"毋","⺟":"母","𣫺":"𣫺","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","汎":"汎","汧":"汧","沈":"沈","沿":"沿","泌":"泌","泍":"泍","泥":"泥","𣲼":"𣲼","洛":"洛","洞":"洞","洴":"洴","派":"派","流":"流","流":"流","流":"流","洖":"洖","浩":"浩","浪":"浪","海":"海","海":"海","浸":"浸","涅":"涅","𣴞":"𣴞","淋":"淋","淚":"淚","淪":"淪","淹":"淹","渚":"渚","港":"港","湮":"湮","潙":"溈","滋":"滋","滋":"滋","溜":"溜","溺":"溺","滇":"滇","滑":"滑","滛":"滛","㴳":"㴳","漏":"漏","漢":"漢","漢":"漢","漣":"漣","𣻑":"𣻑","潮":"潮","𣽞":"𣽞","𣾎":"𣾎","濆":"濆","濫":"濫","濾":"濾","瀛":"瀛","瀞":"瀞","瀞":"瀞","瀹":"瀹","灊":"灊","㶖":"㶖","⽕":"火","⺣":"灬","灰":"灰","灷":"灷","災":"災","炙":"炙","炭":"炭","烈":"烈","烙":"烙","煮":"煮","煮":"煮","𤉣":"𤉣","煅":"煅","煉":"煉","𤋮":"𤋮","熜":"熜","燎":"燎","燐":"燐","𤎫":"𤎫","爐":"爐","爛":"爛","爨":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","爵":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","牐":"牐","⽛":"牙","𤘈":"𤘈","⽜":"牛","牢":"牢","犀":"犀","犕":"犕","⽝":"犬","⺨":"犭","犯":"犯","狀":"狀","𤜵":"𤜵","狼":"狼","猪":"猪","猪":"猪","𤠔":"𤠔","獵":"獵","獺":"獺","⽞":"玄","率":"率","率":"率","⽟":"玉","王":"王","㺬":"㺬","玥":"玥","玲":"玲","㺸":"㺸","㺸":"㺸","珞":"珞","琉":"琉","理":"理","琢":"琢","瑇":"瑇","瑜":"瑜","瑩":"瑩","瑱":"瑱","瑱":"瑱","璅":"璅","璉":"璉","璘":"璘","瓊":"瓊","⽠":"瓜","⽡":"瓦","㼛":"㼛","甆":"甆","⽢":"甘","⽣":"生","甤":"甤","⽤":"用","⽥":"田","画":"画","甾":"甾","𤰶":"𤰶","留":"留","略":"略","異":"異","異":"異","𤲒":"𤲒","⽦":"疋","⽧":"疒","痢":"痢","瘐":"瘐","瘟":"瘟","瘝":"瘝","療":"療","癩":"癩","⽨":"癶","⽩":"白","𤾡":"𤾡","𤾸":"𤾸","⽪":"皮","⽫":"皿","𥁄":"𥁄","㿼":"㿼","益":"益","益":"益","盛":"盛","盧":"盧","䀈":"䀈","⽬":"目","直":"直","直":"直","𥃲":"𥃲","𥃳":"𥃳","省":"省","䀘":"䀘","𥄙":"𥄙","眞":"眞","真":"真","真":"真","𥄳":"𥄳","着":"着","睊":"睊","睊":"睊","鿃":"䀹","䀹":"䀹","䀹":"䀹","晣":"䀿","䁆":"䁆","瞋":"瞋","𥉉":"𥉉","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","䂖":"䂖","𥐝":"𥐝","硏":"研","硎":"硎","硫":"硫","碌":"碌","碌":"碌","碑":"碑","磊":"磊","磌":"磌","磌":"磌","磻":"磻","䃣":"䃣","礪":"礪","⽰":"示","⺭":"礻","礼":"礼","社":"社","祈":"祈","祉":"祉","𥘦":"𥘦","祐":"祐","祖":"祖","祖":"祖","祝":"祝","神":"神","祥":"祥","視":"視","視":"視","祿":"祿","𥚚":"𥚚","禍":"禍","禎":"禎","福":"福","福":"福","𥛅":"𥛅","禮":"禮","⽱":"禸","⽲":"禾","秊":"秊","䄯":"䄯","秫":"秫","稜":"稜","穊":"穊","穀":"穀","穀":"穀","穏":"穏","⽳":"穴","突":"突","𥥼":"𥥼","窱":"窱","立":"立","⽴":"立","⻯":"竜","𥪧":"𥪧","𥪧":"𥪧","竮":"竮","⽵":"竹","笠":"笠","節":"節","節":"節","䈂":"䈂","𥮫":"𥮫","篆":"篆","䈧":"䈧","築":"築","𥲀":"𥲀","𥳐":"𥳐","簾":"簾","籠":"籠","⽶":"米","类":"类","粒":"粒","精":"精","糒":"糒","糖":"糖","糨":"糨","䊠":"䊠","糣":"糣","糧":"糧","⽷":"糸","⺯":"糹","𥾆":"𥾆","紀":"紀","紐":"紐","索":"索","累":"累","絶":"絕","絣":"絣","絛":"絛","綠":"綠","綾":"綾","緇":"緇","練":"練","練":"練","練":"練","縂":"縂","䌁":"䌁","縉":"縉","縷":"縷","繁":"繁","繅":"繅","𦇚":"𦇚","䌴":"䌴","⽸":"缶","𦈨":"𦈨","缾":"缾","𦉇":"𦉇","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","䍙":"䍙","署":"署","𦋙":"𦋙","罹":"罹","罺":"罺","羅":"羅","𦌾":"𦌾","⽺":"羊","羕":"羕","羚":"羚","羽":"羽","⽻":"羽","翺":"翺","老":"老","⽼":"老","⺹":"耂","者":"者","者":"者","者":"者","⽽":"而","𦓚":"𦓚","⽾":"耒","𦔣":"𦔣","⽿":"耳","聆":"聆","聠":"聠","𦖨":"𦖨","聯":"聯","聰":"聰","聾":"聾","⾀":"聿","⺺":"肀","⾁":"肉","肋":"肋","肭":"肭","育":"育","䏕":"䏕","䏙":"䏙","腁":"胼","脃":"脃","脾":"脾","䐋":"䐋","朡":"朡","𦞧":"𦞧","𦞵":"𦞵","朦":"䑃","臘":"臘","⾂":"臣","臨":"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","舁":"舁","舁":"舁","舄":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","䑫":"䑫","⾉":"艮","良":"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","芋":"芋","芑":"芑","芝":"芝","花":"花","芳":"芳","芽":"芽","若":"若","若":"若","苦":"苦","𦬼":"𦬼","茶":"茶","荒":"荒","荣":"荣","茝":"茝","茣":"茣","莽":"莽","荓":"荓","菉":"菉","菊":"菊","菌":"菌","菜":"菜","菧":"菧","華":"華","菱":"菱","著":"著","著":"著","𦰶":"𦰶","莭":"莭","落":"落","葉":"葉","蔿":"蒍","𦳕":"𦳕","𦵫":"𦵫","蓮":"蓮","蓱":"蓱","蓳":"蓳","蓼":"蓼","蔖":"蔖","䔫":"䔫","蕤":"蕤","𦼬":"𦼬","藍":"藍","䕝":"䕝","𦾱":"𦾱","䕡":"䕡","藺":"藺","蘆":"蘆","䕫":"䕫","蘒":"蘒","蘭":"蘭","𧃒":"𧃒","虁":"蘷","蘿":"蘿","⾌":"虍","⻁":"虎","虐":"虐","虜":"虜","虜":"虜","虧":"虧","虩":"虩","⾍":"虫","蚩":"蚩","蚈":"蚈","蛢":"蛢","蜎":"蜎","蜨":"蜨","蝫":"蝫","蟡":"蟡","蝹":"蝹","蝹":"蝹","螆":"螆","䗗":"䗗","𧏊":"𧏊","螺":"螺","蠁":"蠁","䗹":"䗹","蠟":"蠟","⾎":"血","行":"行","⾏":"行","衠":"衠","衣":"衣","⾐":"衣","⻂":"衤","裂":"裂","𧙧":"𧙧","裏":"裏","裗":"裗","裞":"裞","裡":"裡","裸":"裸","裺":"裺","䘵":"䘵","褐":"褐","襁":"襁","襤":"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆","見":"見","⾒":"見","𧢮":"𧢮","⻅":"见","⾓":"角","⾔":"言","𧥦":"𧥦","詽":"訮","訞":"䚶","䚾":"䚾","䛇":"䛇","誠":"誠","說":"說","說":"說","調":"調","請":"請","諒":"諒","論":"論","諭":"諭","諭":"諭","諸":"諸","諸":"諸","諾":"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹","識":"識","讀":"讀","讏":"讆","變":"變","變":"變","⻈":"讠","⾕":"谷","⾖":"豆","豈":"豈","豕":"豕","⾗":"豕","豣":"豜","⾘":"豸","𧲨":"𧲨","⾙":"貝","貫":"貫","賁":"賁","賂":"賂","賈":"賈","賓":"賓","贈":"贈","贈":"贈","贛":"贛","⻉":"贝","⾚":"赤","⾛":"走","起":"起","趆":"赿","𧻓":"𧻓","𧼯":"𧼯","⾜":"足","跋":"跋","趼":"趼","跺":"跥","路":"路","跰":"跰","躛":"躗","⾝":"身","車":"車","⾞":"車","軔":"軔","輧":"軿","輦":"輦","輪":"輪","輸":"輸","輸":"輸","輻":"輻","轢":"轢","⻋":"车","⾟":"辛","辞":"辞","辰":"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","巡":"巡","連":"連","逸":"逸","逸":"逸","遲":"遲","遼":"遼","𨗒":"𨗒","𨗭":"𨗭","邏":"邏","⾢":"邑","邔":"邔","郎":"郎","郞":"郎","郞":"郎","郱":"郱","都":"都","𨜮":"𨜮","鄑":"鄑","鄛":"鄛","⾣":"酉","酪":"酪","醙":"醙","醴":"醴","⾤":"釆","里":"里","⾥":"里","量":"量","金":"金","⾦":"金","鈴":"鈴","鈸":"鈸","鉶":"鉶","鋗":"鋗","鋘":"鋘","鉼":"鉼","錄":"錄","鍊":"鍊","鎮":"鎭","鏹":"鏹","鐕":"鐕","𨯺":"𨯺","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","開":"開","䦕":"䦕","閭":"閭","閷":"閷","𨵷":"𨵷","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝","阮":"阮","陋":"陋","降":"降","陵":"陵","陸":"陸","陼":"陼","隆":"隆","隣":"隣","䧦":"䧦","⾪":"隶","隷":"隷","隸":"隷","隸":"隷","⾫":"隹","雃":"雃","離":"離","難":"難","難":"難","⾬":"雨","零":"零","雷":"雷","霣":"霣","𩅅":"𩅅","露":"露","靈":"靈","⾭":"靑","⻘":"青","靖":"靖","靖":"靖","𩇟":"𩇟","⾮":"非","⾯":"面","𩈚":"𩈚","⾰":"革","䩮":"䩮","䩶":"䩶","⾱":"韋","韛":"韛","韠":"韠","⻙":"韦","⾲":"韭","𩐊":"𩐊","⾳":"音","響":"響","響":"響","⾴":"頁","䪲":"䪲","頋":"頋","頋":"頋","頋":"頋","領":"領","頩":"頩","𩒖":"𩒖","頻":"頻","頻":"頻","類":"類","⻚":"页","⾵":"風","𩖶":"𩖶","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","飢":"飢","飯":"飯","飼":"飼","䬳":"䬳","館":"館","餩":"餩","⻠":"饣","⾸":"首","⾹":"香","馧":"馧","⾺":"馬","駂":"駂","駱":"駱","駾":"駾","驪":"驪","⻢":"马","⾻":"骨","䯎":"䯎","⾼":"高","⾽":"髟","𩬰":"𩬰","鬒":"鬒","鬒":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚","魯":"魯","鱀":"鱀","鱗":"鱗","⻥":"鱼","⿃":"鳥","鳽":"鳽","䳎":"䳎","鵧":"鵧","䳭":"䳭","𪃎":"𪃎","鶴":"鶴","𪄅":"𪄅","䳸":"䳸","鷺":"鷺","𪈎":"𪈎","鸞":"鸞","鹃":"鹂","⿄":"鹵","鹿":"鹿","⿅":"鹿","𪊑":"𪊑","麗":"麗","麟":"麟","⿆":"麥","⻨":"麦","麻":"麻","⿇":"麻","𪎒":"𪎒","⿈":"黃","⻩":"黄","⿉":"黍","黎":"黎","䵖":"䵖","⿊":"黑","黒":"黑","墨":"墨","黹":"黹","⿋":"黹","⿌":"黽","鼅":"鼅","黾":"黾","⿍":"鼎","鼏":"鼏","⿎":"鼓","鼖":"鼖","⿏":"鼠","鼻":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","𪘀":"𪘀","⻮":"齿","龍":"龍","⿓":"龍","龎":"龎","⻰":"龙","龜":"龜","龜":"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"}')}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={id:r,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nc=void 0;var r={};return(()=>{"use strict";n.r(r),n.d(r,{_closeChatPopup:()=>Qh,default:()=>fp});var e=n(5072),t=n.n(e),i=n(275);t()(i.A,{insert:"head",singleton:!1}),i.A.locals;var s,o=n(7964),a=n(9849),c={isDevDebug:!1,synapseDomain:"",synapseEndpoint:"",botUserId:"",gRPCBaseUrl:"",posthogUrl:"",posthogToken:"",playerId:"",env:"",accessToken:"",refreshedAccessToken:"",roomId:"",conversationId:"",channel:"",playerName:"",guestName:"",liveChatName:"",forcetoliveagent:!1,botOptionTextReplace:[],isGuest:!1,checkAttachmentActive:!1,checkAttachmentAvailability:!1,isChatPopupOpening:!1,conversationTimeout:0,activityTimeoutID:0,photoUrl:"",matrixSynced:!1,livechatEnabled:!1,isShowBotIcon:!1,welcomeMessage:"",isLiveAgentRequested:!1},l=["isDevDebug","synapseDomain","synapseEndpoint","botUserId","gRPCBaseUrl","posthogUrl","posthogToken","playerId","env","accessToken","roomId","conversationId","channel","playerName","guestName","liveChatName","forcetoliveagent","botOptionTextReplace","isGuest","checkAttachmentActive","checkAttachmentAvailability","isChatPopupOpening","conversationTimeout","activityTimeoutID","photoUrl","matrixSynced","livechatEnabled","isShowBotIcon","welcomeMessage","isLiveAgentRequested"];function u(e,t){if(!l.includes(e))throw new Error("Invalid key: ".concat(e,". Allowed keys are: ").concat(l.join(", ")));c[e]=t}s=window.location.href,u("isDevDebug",/^(https:\/\/cplivechat-(?:qat|uat|omtest)\.casinoplustools\.com|http:\/\/localhost(?::\d+)?|http:\/\/(?:172|192)\.\d+\.\d+\.\d+(?::\d+)?)/.test(s));var d="/chatbot-display-picture.svg";function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}function p(){p=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof _?t:_,o=Object.create(s.prototype),a=new D(r||[]);return i(o,"_invoke",{value:R(e,n,a)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var g="suspendedStart",f="suspendedYield",m="executing",v="completed",y={};function _(){}function b(){}function E(){}var A={};l(A,o,(function(){return this}));var S=Object.getPrototypeOf,w=S&&S(S(N([])));w&&w!==n&&r.call(w,o)&&(A=w);var I=E.prototype=_.prototype=Object.create(A);function T(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(i,s,o,a){var c=d(e[i],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==h(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var s;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return s=s?s.then(i,i):i()}})}function R(t,n,r){var i=g;return function(s,o){if(i===m)throw Error("Generator is already running");if(i===v){if("throw"===s)throw o;return{value:e,done:!0}}for(r.method=s,r.arg=o;;){var a=r.delegate;if(a){var c=O(a,r);if(c){if(c===y)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===g)throw i=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=m;var l=d(t,n,r);if("normal"===l.type){if(i=r.done?v:f,l.arg===y)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=v,r.method="throw",r.arg=l.arg)}}}function O(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,O(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var s=d(i,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,y;var o=s.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,y):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,y)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function D(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,s=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(h(t)+" is not iterable")}return b.prototype=E,i(I,"constructor",{value:E,configurable:!0}),i(E,"constructor",{value:b,configurable:!0}),b.displayName=l(E,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,E):(e.__proto__=E,l(e,c,"GeneratorFunction")),e.prototype=Object.create(I),e},t.awrap=function(e){return{__await:e}},T(k.prototype),l(k.prototype,a,(function(){return this})),t.AsyncIterator=k,t.async=function(e,n,r,i,s){void 0===s&&(s=Promise);var o=new k(u(e,n,r,i),s);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},T(I),l(I,c,"Generator"),l(I,o,(function(){return this})),l(I,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,D.prototype={constructor:D,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return a.type="throw",a.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,y):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;P(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),y}},t}function g(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,m(r.key),r)}}function m(e){var t=function(e){if("object"!=h(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=h(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==h(t)?t:t+""}var v=function(){return function(e,t){return t&&f(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}((function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}),[{key:"_getCurrentTime",value:function(){var e=new Date,t=(e.getHours()%12||12).toString().padStart(2,"0"),n=e.getMinutes().toString().padStart(2,"0");return"".concat(t,":").concat(n," ").concat(e.getHours()>=12?"PM":"AM")}},{key:"displayLoading",value:function(){var e,t=document.querySelector(".chat-message");null===(e=document.querySelector(".chat-loading"))||void 0===e||e.remove(),t.insertAdjacentHTML("beforeend",'\n        <div class="chat-bubble bubble-incoming chat-loading" id="loadingMessage">\n            <span></span><span></span><span></span>\n        </div>\n    '),t.scrollTop=t.scrollHeight}},{key:"removeLoading",value:function(){var e;null===(e=document.querySelector(".chat-loading"))||void 0===e||e.remove(),document.querySelector(".chat-message").scrollTop=document.querySelector(".chat-message").scrollHeight}},{key:"hideChatPopup",value:function(){var e=document.getElementById("chatPopup"),t=document.querySelector(".chat-attachment"),n=Object.fromEntries(["emojiBtn","emojiPopup","sendBtn","attachmentBtn"].map((function(e){return[e,document.getElementById(e)]}))),r=n.emojiBtn,i=n.emojiPopup,s=n.sendBtn,o=n.attachmentBtn;e&&(e.classList.add("chat-hidden"),e.classList.remove("chat-visible"),[r,i,s,o,t].forEach((function(e){return e.classList.remove("active")})),u("checkAttachmentActive",!1),chatInput.disabled=!1)}},{key:"displayWelcomeMessage",value:function(e){var t=document.querySelector(".chat-message"),n=c.welcomeMessage?'<div class="chat-bubble-text"><p>'.concat(c.welcomeMessage.replace(/\n/g,"<br>"),"</p></div>"):'\n      <div class="chat-bubble-text"><p>Welcome!</p></div>\n      <div class="chat-bubble-text"><p>Welcome to CP LiveChat.<br>Pick a topic from the list or type down a question!</p></div>\n    ';t.insertAdjacentHTML("beforeend",'\n        <div class="chat-history chat-divider"></div>\n        <div class="chat-user user-incoming">\n            <div class="chat-user-pic">\n                <img src="'.concat(e).concat(d,'" alt="chatbot-display-picture">\n            </div>\n            <div class="chat-user-name">Lucky <span class="chat-time">').concat(this._getCurrentTime(),'</span></div>\n        </div>\n        <div class="chat-bubble bubble-incoming chat-welcome">\n          ').concat(n,"\n        </div>\n    ")),this.removeLoading(),t.scrollTop=t.scrollHeight}},{key:"addEmoji",value:function(e){document.getElementById("chatInput").value+=e,document.getElementById("emojiPopup").classList.remove("active")}},{key:"updateReadReceipt",value:function(e,t,n){var r=document.querySelector('.bubble-outgoing[data-event-id="'.concat(e,'"]')),i=document.querySelector(".chat-message");if(r){var s=r.querySelector(".bubble-read-receipt");s&&(s.setAttribute("data-status","true"),s.classList.remove("hide"),setTimeout((function(){s.classList.add("hide")}),5e3),i.scrollTop=i.scrollHeight)}}},{key:"_isDuplicateMessage",value:function(e){return document.querySelector('.chat-bubble[data-event-id="'.concat(e,'"]'))?(console.debug("AiLC -- Duplicate message prevented: ".concat(e)),!0):(window._processedMessageIds||(window._processedMessageIds=new Set),window._processedMessageIds.has(e)?(console.debug("AiLC -- Duplicate message caught in tracking set: ".concat(e)),!0):(window._processedMessageIds.add(e),!1))}},{key:"displayMessage",value:(e=function(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){g(s,r,i,o,a,"next",e)}function a(e){g(s,r,i,o,a,"throw",e)}o(void 0)}))}}(p().mark((function e(t){var n,r,i,s,o,a,c,l,u,h,g,f,m,v,y,_,b,E;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.event_id,r=t.messageContent,i=t.timestamp,s=t.senderName,o=t.isUserMessage,a=void 0===o||o,c=t.readReceipts,l=void 0===c?[]:c,u=t.cdnUrl,h=document.querySelector(".chat-message"),!this._isDuplicateMessage(n)){e.next=4;break}return e.abrupt("return",!0);case 4:return g=r.replace(/\n/g,"<br>"),f=a?"user-outgoing":"user-incoming",m=a?"bubble-outgoing":"bubble-incoming",v=a?"User":null!=s&&s.toLowerCase().includes("bot")?"Lucky":s||"Lucky",y=a?'\n        <div class="bubble-read-receipt '.concat(l.length?"show":"hide",'" data-status="false">\n            Read\n        </div>'):"",_=a?"":'\n        <div class="chat-user-pic">\n            <img src="'.concat(u).concat(d,'" alt="').concat(v,'-profile-picture">\n        </div>'),(b=document.createElement("div")).className="chat-user ".concat(f),b.innerHTML="\n        ".concat(_,'\n        <div class="chat-user-name">\n            ').concat(v,' <span class="chat-time">').concat(i,"</span>\n        </div>\n    "),(E=document.createElement("div")).className="chat-bubble ".concat(m),E.setAttribute("data-event-id",n),E.innerHTML='\n        <div class="chat-bubble-text">\n            <p>'.concat(g,"</p>\n        </div>\n        ").concat(y,"\n    "),h.append(b,E),h.scrollTop=h.scrollHeight,e.abrupt("return",!0);case 20:case"end":return e.stop()}}),e,this)}))),function(t){return e.apply(this,arguments)})},{key:"displayMediaMessage",value:function(e){var t=e.event_id,n=e.imageUrl,r=e.timestamp,i=e.senderName,s=e.isUserMessage,o=void 0===s||s,a=e.readReceipts,c=void 0===a?[]:a,l=e.mediaTitle,u=e.cdnUrl,h=document.querySelector(".chat-message");if(this._isDuplicateMessage(t))return!0;var p=o?"user-outgoing":"user-incoming",g=o?"bubble-outgoing":"bubble-incoming",f=o?"User":null!=i&&i.toLowerCase().includes("bot")?"Lucky":i||"Lucky",m=o?'\n        <div class="bubble-read-receipt '.concat(c.length?"show":"hide",'" data-status="false">\n            Read\n        </div>'):"",v=o?"":'\n        <div class="chat-user-pic">\n            <img src="'.concat(u).concat(d,'" alt="').concat(f,'-profile-picture">\n        </div>'),y=document.createElement("div");y.className="chat-user ".concat(p),y.innerHTML="\n        ".concat(v,'\n        <div class="chat-user-name">\n            ').concat(f,' <span class="chat-time">').concat(r,"</span>\n        </div>\n    ");var _=document.createElement("div");return _.className="chat-bubble ".concat(g),_.setAttribute("data-event-id",t),_.innerHTML='\n        <div class="chat-bubble-image">\n            <img src="'.concat(n,'" alt="').concat(l,'">\n        </div>\n        ').concat(m,"\n    "),h.append(y,_),h.scrollTop=h.scrollHeight,!0}},{key:"displayVideoMessage",value:function(e){var t=e.event_id,n=e.videoUrl,r=e.timestamp,i=e.senderName,s=e.isUserMessage,o=void 0===s||s,a=e.readReceipts,c=void 0===a?[]:a,l=e.cdnUrl,u=document.querySelector(".chat-message");if(this._isDuplicateMessage(t))return!0;var h=o?"user-outgoing":"user-incoming",p=o?"bubble-outgoing":"bubble-incoming",g=o?"User":null!=i&&i.toLowerCase().includes("bot")?"Lucky":i||"Lucky",f=o?'\n        <div class="bubble-read-receipt '.concat(c.length?"show":"hide",'" data-status="false">\n            Read\n        </div>'):"",m=o?"":'\n        <div class="chat-user-pic">\n            <img src="'.concat(l).concat(d,'" alt="').concat(g,'-profile-picture">\n        </div>'),v=document.createElement("div");v.className="chat-user ".concat(h),v.innerHTML="\n        ".concat(m,'\n        <div class="chat-user-name">\n            ').concat(g,' <span class="chat-time">').concat(r,"</span>\n        </div>\n    ");var y=document.createElement("div");return y.className="chat-bubble ".concat(p),y.setAttribute("data-event-id",t),y.innerHTML='\n        <div class="chat-bubble-video">\n            <video controls playsinline>\n                <source src="'.concat(n,'" type="video/mp4">\n                Your browser does not support the video tag.\n            </video>\n        </div>\n        ').concat(f,"\n    "),u.append(v,y),u.scrollTop=u.scrollHeight,!0}}]);var e}();const y=new v;var _={1:{synapseDomain:"matrix-nginx.casinoplus.com.ph",synapseEndpoint:"https://matrix-nginx.casinoplus.com.ph",botUserId:"@bot:matrix-nginx.casinoplus.com.ph",gRPCBaseUrl:"https://fpms-nt.fpms10.me/livechat",posthogUrl:"https://posthog.client10.me",posthogToken:"phc_flhwzzPKD5aBulVeeGXWS2SLsRayTQCN0Y8xhgYMJZ",cdnUrl:"https://cp-images.casinoplus.live/images/cp",cdnPath:"/images/ailivechat"},2:{synapseDomain:"matrix.client9.me",synapseEndpoint:"https://matrix.client9.me",botUserId:"@bot:matrix.client9.me",gRPCBaseUrl:"https://fpms-nt.fpms99.me/livechat",posthogUrl:"https://posthog.client88.me",posthogToken:"phc_lsTWT98yyPqH3CBKXFBZMu5mrUvhl493tpAx2QUPrZ3",cdnUrl:"https://cp-images.client99.me/images/cp",cdnPath:"/images/ailivechat"},3:{synapseDomain:"matrix-sg.client8.me",synapseEndpoint:"https://matrix-sg.client8.me",botUserId:"@bot:matrix-sg.client8.me",gRPCBaseUrl:"https://fpms-nt.fpms88.me/livechat",posthogUrl:"https://posthog.client88.me",posthogToken:"phc_lsTWT98yyPqH3CBKXFBZMu5mrUvhl493tpAx2QUPrZ3",cdnUrl:"https://cp-images.client88.me/images/cp",cdnPath:"/images/ailivechat"},4:{synapseDomain:"",synapseEndpoint:"",botUserId:"",gRPCBaseUrl:"",posthogUrl:"",posthogToken:"",cdnUrl:"https://cp-images.client88.me/images/cp",cdnPath:"/images/ailivechat"}};function b(){var e,t;return(null===(e=_[null==c?void 0:c.env])||void 0===e?void 0:e.cdnUrl)+(null===(t=_[null==c?void 0:c.env])||void 0===t?void 0:t.cdnPath)||""}var E=n(2748);function A(e){return A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},A(e)}function S(){S=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof v?t:v,o=Object.create(s.prototype),a=new D(r||[]);return i(o,"_invoke",{value:R(e,n,a)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",g="executing",f="completed",m={};function v(){}function y(){}function _(){}var b={};l(b,o,(function(){return this}));var E=Object.getPrototypeOf,w=E&&E(E(N([])));w&&w!==n&&r.call(w,o)&&(b=w);var I=_.prototype=v.prototype=Object.create(b);function T(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(i,s,o,a){var c=d(e[i],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==A(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var s;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return s=s?s.then(i,i):i()}})}function R(t,n,r){var i=h;return function(s,o){if(i===g)throw Error("Generator is already running");if(i===f){if("throw"===s)throw o;return{value:e,done:!0}}for(r.method=s,r.arg=o;;){var a=r.delegate;if(a){var c=O(a,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===h)throw i=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=g;var l=d(t,n,r);if("normal"===l.type){if(i=r.done?f:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=f,r.method="throw",r.arg=l.arg)}}}function O(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,O(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var s=d(i,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,m;var o=s.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function D(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,s=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(A(t)+" is not iterable")}return y.prototype=_,i(I,"constructor",{value:_,configurable:!0}),i(_,"constructor",{value:y,configurable:!0}),y.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(I),e},t.awrap=function(e){return{__await:e}},T(k.prototype),l(k.prototype,a,(function(){return this})),t.AsyncIterator=k,t.async=function(e,n,r,i,s){void 0===s&&(s=Promise);var o=new k(u(e,n,r,i),s);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},T(I),l(I,c,"Generator"),l(I,o,(function(){return this})),l(I,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,D.prototype={constructor:D,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return a.type="throw",a.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,m):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;P(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function w(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function I(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){w(s,r,i,o,a,"next",e)}function a(e){w(s,r,i,o,a,"throw",e)}o(void 0)}))}}function T(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,k(r.key),r)}}function k(e){var t=function(e){if("object"!=A(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=A(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==A(t)?t:t+""}var R=function(){return function(e,t){return t&&T(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}((function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}),[{key:"_validateLiveChatSwitch",value:(t=I(S().mark((function e(){var t;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t={aiPopupZoho:!0},e.prev=1,(0,E.$p)({type:"aiLivechat",data:t}),e.next=9;break;case 5:throw e.prev=5,e.t0=e.catch(1),console.error("Unexpected error in $p:",e.t0),e.t0;case 9:case"end":return e.stop()}}),e,null,[[1,5]])}))),function(){return t.apply(this,arguments)})},{key:"errorOccurred",value:(e=I(S().mark((function e(){var t,n,r,i,s,o=this;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=document.querySelector(".chat-error"),n=document.querySelector("#errorSubmit .error-timeout"),r=document.querySelector("#errorSubmit"),t&&!t.classList.contains("chat-error-visible")&&(t.classList.add("chat-error-visible"),i=3,n.textContent="(".concat(i,"s)"),s=setInterval(I(S().mark((function e(){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(--i>0)){e.next=5;break}n.textContent="(".concat(i,"s)"),e.next=17;break;case 5:return clearInterval(s),n.textContent="",e.prev=7,e.next=10,o._validateLiveChatSwitch();case 10:t.classList.remove("chat-error-visible"),Qh(),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(7),console.error("Validation failed:",e.t0);case 17:case"end":return e.stop()}}),e,null,[[7,14]])}))),1e3),r.addEventListener("click",I(S().mark((function e(){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return clearInterval(s),n.textContent="",e.prev=2,e.next=5,o._validateLiveChatSwitch();case 5:t.classList.remove("chat-error-visible"),Qh(),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),console.error("Validation failed:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[2,9]])}))),{once:!0}));case 4:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}]);var e,t}();const O=new R;function C(e){return C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},C(e)}function P(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return D(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?D(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function N(){N=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof v?t:v,o=Object.create(s.prototype),a=new P(r||[]);return i(o,"_invoke",{value:T(e,n,a)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",g="executing",f="completed",m={};function v(){}function y(){}function _(){}var b={};l(b,o,(function(){return this}));var E=Object.getPrototypeOf,A=E&&E(E(D([])));A&&A!==n&&r.call(A,o)&&(b=A);var S=_.prototype=v.prototype=Object.create(b);function w(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function I(e,t){function n(i,s,o,a){var c=d(e[i],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==C(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var s;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return s=s?s.then(i,i):i()}})}function T(t,n,r){var i=h;return function(s,o){if(i===g)throw Error("Generator is already running");if(i===f){if("throw"===s)throw o;return{value:e,done:!0}}for(r.method=s,r.arg=o;;){var a=r.delegate;if(a){var c=k(a,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===h)throw i=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=g;var l=d(t,n,r);if("normal"===l.type){if(i=r.done?f:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=f,r.method="throw",r.arg=l.arg)}}}function k(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var s=d(i,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,m;var o=s.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function D(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,s=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(C(t)+" is not iterable")}return y.prototype=_,i(S,"constructor",{value:_,configurable:!0}),i(_,"constructor",{value:y,configurable:!0}),y.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},w(I.prototype),l(I.prototype,a,(function(){return this})),t.AsyncIterator=I,t.async=function(e,n,r,i,s){void 0===s&&(s=Promise);var o=new I(u(e,n,r,i),s);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},w(S),l(S,c,"Generator"),l(S,o,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=D,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(O),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return a.type="throw",a.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,m):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;O(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:D(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function x(e,t,n){return(t=U(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function M(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function L(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){M(s,r,i,o,a,"next",e)}function a(e){M(s,r,i,o,a,"throw",e)}o(void 0)}))}}function B(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,U(r.key),r)}}function U(e){var t=function(e){if("object"!=C(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=C(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==C(t)?t:t+""}var F=function(){return function(e,t){return t&&B(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}((function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a.logger.disableAll()}),[{key:"initInfo",value:function(){this.synapseEndpoint=c.synapseEndpoint||_[3].synapseEndpoint,this.synapseMediaUrl="".concat(this.synapseEndpoint,"/_matrix/media/v3/download/"),this.botUserId=c.botUserId||"default-bot-user-id",this.client=null}},{key:"_validateClient",value:function(){if(null===this.client)throw new Error("Matrix client is null !!!")}},{key:"_convertMatrixURL",value:function(e){if("string"==typeof e){var t=e.replace("mxc://","");return e.startsWith("mxc://")?"".concat(this.synapseMediaUrl).concat(t):null}}},{key:"_fetchHistoryMessages",value:(d=L(N().mark((function e(t){var n,r=this;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this._validateClient(),t&&"function"==typeof this.client.scrollback){e.next=5;break}return console.error("Invalid room or scrollback function not found"),e.abrupt("return");case 5:return e.next=7,this.client.scrollback(t);case 7:if(n=e.sent,c.isDevDebug&&console.log("AiLC -- Matrix -- Room scrollback:",n),c.isDevDebug&&console.log("AiLC -- Matrix -- Room's timeline history:",t.timeline),Array.isArray(t.timeline)){e.next=13;break}return console.error("Room timeline is not an array or is undefined."),e.abrupt("return");case 13:t.timeline.forEach(function(){var e=L(N().mark((function e(t){var n,i,s,o,a,l,u,d,h,p,g,f;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("m.room.message"!==t.getType()){e.next=27;break}n=t.getId(),i=t.getContent(),s=i.msgtype,o=["m.image","m.video"].includes(s)?i.body.replace(/\.[^.]+$/,""):i.body,["m.image","m.video"].includes(s)&&i.info.mimetype.split("/")[1],a=t.getSender(),l=new Date(t.getTs()).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0}),u=a.split(":")[0].replace("@",""),d=c.playerId?u.replace(/^visitor_/,"user_"):u,h=a===r.client.credentials.userId,p="Customer Service",c.isDevDebug&&console.log("AiLC -- Matrix -- Message content:",i),e.t0=s,e.next="m.text"===e.t0?16:"m.image"===e.t0?20:"m.video"===e.t0?23:26;break;case 16:return e.next=18,y.displayMessage({event_id:n,messageContent:o,timestamp:l,senderName:d,isUserMessage:h,cdnUrl:b()});case 18:return h?y.displayLoading():y.removeLoading(),e.abrupt("break",27);case 20:return g=r._convertMatrixURL(i.url),y.displayMediaMessage(x(x(x(x({event_id:n,imageUrl:g,timestamp:l},h?"senderName":"receiverName",h?d:p),"isUserMessage",h),"mediaTitle",o),"cdnUrl",b())),e.abrupt("break",27);case 23:return f=r._convertMatrixURL(i.url),y.displayVideoMessage(x(x(x({event_id:n,videoUrl:f,timestamp:l},h?"senderName":"receiverName",h?d:p),"isUserMessage",h),"cdnUrl",b())),e.abrupt("break",27);case 26:console.warn("Unknown message type from user:",s);case 27:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("Failed to fetch previous messages for room ".concat(t.roomId,":"),e.t0);case 19:case"end":return e.stop()}}),e,this,[[0,16]])}))),function(e){return d.apply(this,arguments)})},{key:"validateAndRefreshToken",value:(l=L(N().mark((function e(){var t,n;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c.matrixSynced){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.client.whoami();case 5:return c.isDevDebug&&console.log("AiLC -- Matrix -- Token is valid."),e.abrupt("return",!1);case 9:if(e.prev=9,e.t0=e.catch(2),"M_UNKNOWN_TOKEN"!==e.t0.errcode){e.next=32;break}if(c.isDevDebug&&console.log("AiLC -- Matrix -- Token expired. Attempting to refresh..."),!(t=sessionStorage.getItem("refreshToken"))){e.next=29;break}return e.prev=15,e.next=18,this.client.refreshToken(t);case 18:return n=e.sent,this.client.setAccessToken(n),sessionStorage.setItem("accessToken",n),u("accessToken",n),c.isDevDebug&&console.log("AiLC -- Matrix -- Access token refreshed successfully."),e.abrupt("return",!0);case 26:e.prev=26,e.t1=e.catch(15),console.warn("Failed to refresh token. Continuing with expired token.");case 29:return e.abrupt("return",!1);case 32:console.error("Token validation encountered an unexpected error:",e.t0);case 33:return e.abrupt("return",!1);case 34:case"end":return e.stop()}}),e,this,[[2,9],[15,26]])}))),function(){return l.apply(this,arguments)})},{key:"init",value:function(e){var t=this,n=e.accessToken,r=e.guestName,i=e.playerId,s=e.liveChatName;try{var a=s?"@".concat(s,":").concat(c.synapseDomain):r?"@".concat(r,":").concat(c.synapseDomain):i?"@user_".concat(i,":").concat(c.synapseDomain):null;if(!a)throw new Error("Invalid user information. Please try again.");this.client=o.createClient({userId:a,accessToken:n,baseUrl:this.synapseEndpoint}),setInterval((function(){try{t.validateAndRefreshToken()}catch(e){console.error("Periodic token refresh failed:",e)}}),3e5)}catch(e){console.error("Matrix init failed:",e)}}},{key:"loginToMatrix",value:(s=L(N().mark((function e(){var t=this;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this._validateClient(),e.next=4,this.validateAndRefreshToken();case 4:return e.next=6,this.client.startClient();case 6:return e.next=8,new Promise((function(e){return t.client.once("sync",(function(t){u("matrixSynced","SYNCING"===t||"PREPARED"===t),e()}))}));case 8:c.isDevDebug&&console.log("AiLC -- Matrix -- startClient"),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(0),console.error("Matrix login failed:",e.t0),O.errorOccurred();case 15:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(){return s.apply(this,arguments)})},{key:"sendMessage",value:(i=L(N().mark((function e(t,n){return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this._validateClient(),e.next=4,this.validateAndRefreshToken();case 4:if(t&&n){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,this.client.sendEvent(n,"m.room.message",{msgtype:"m.text",body:t});case 8:c.isDevDebug&&console.log("AiLC -- Matrix -- Message sent:",t),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),console.error("Failed to send message:",e.t0);case 14:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(e,t){return i.apply(this,arguments)})},{key:"endMatrix",value:(r=L(N().mark((function e(){return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this._validateClient(),!this.client){e.next=6;break}return e.next=5,this.client.stopClient();case 5:this.client.removeAllListeners();case 6:return e.next=8,this.client.logout();case 8:this.client=null,u("matrixSynced",!1),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("Logout failed:",e.t0);case 15:return e.prev=15,c.isDevDebug&&console.log("AiLC -- Matrix -- Matrix client connection ended."),e.finish(15);case 18:case"end":return e.stop()}}),e,this,[[0,12,15,18]])}))),function(){return r.apply(this,arguments)})},{key:"sendMediaMessageToMatrix",value:(n=L(N().mark((function e(t,n){var r,i,s,o,a,l,u,d;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this._validateClient(),t){e.next=5;break}return console.error("No file selected for upload."),e.abrupt("return",null);case 5:return r=t.type,i=new Blob([t],{type:r}),e.next=9,this.client.uploadContent(i,{includeFilename:!0});case 9:if(s=e.sent,c.isDevDebug&&console.log("AiLC -- Matrix -- Media Upload response",s),s.startsWith("mxc://")){e.next=13;break}throw new Error("Upload failed: Invalid content URI returned.");case 13:return o=s.slice(6),a=s.slice(s.lastIndexOf("/")+1),l=this.synapseMediaUrl+o,c.isDevDebug&&console.log("AiLC -- Matrix -- Media uploaded and accessible at:",l),u=r.startsWith("video/")?"m.video":"m.image",d={msgtype:u,body:t.name,url:s,info:{mimetype:r,size:t.size}},c.isDevDebug&&console.log("AiLC -- Matrix -- Media message content:",d),e.next=22,this.client.sendEvent(n,"m.room.message",d);case 22:return c.isDevDebug&&console.log("AiLC -- Matrix -- Media message sent successfully."),e.abrupt("return",{mediaUrl:l,mediaId:o,mediaUId:a});case 26:return e.prev=26,e.t0=e.catch(0),console.error("Failed to upload media or send message:",e.t0),e.abrupt("return");case 30:case"end":return e.stop()}}),e,this,[[0,26]])}))),function(e,t){return n.apply(this,arguments)})},{key:"joinRoom",value:(t=L(N().mark((function e(t){var n,r,i,s,o,a;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this._validateClient(),t){e.next=4;break}throw new Error("Invalid roomId in widgetState.");case 4:return e.next=6,this.client.joinRoom(t);case 6:if(c.isDevDebug&&console.log("AiLC -- Matrix -- Joined room:",t),n=this.client.getRoom(t)){e.next=10;break}throw new Error("Room ".concat(t," could not be loaded."));case 10:return c.isDevDebug&&console.log("AiLC -- Matrix -- Loaded room:",n),e.next=13,this._fetchHistoryMessages(n);case 13:if((r=n.getJoinedMembers())&&0!==r.length){e.next=17;break}return c.isDevDebug&&console.log("AiLC -- Matrix -- No other members in the room except yourself."),e.abrupt("return");case 17:i=P(r),e.prev=18,i.s();case 20:if((s=i.n()).done){e.next=39;break}if(o=s.value,a=o.rawDisplayName||o.userId,o.userId!==this.client.getUserId()){e.next=25;break}return e.abrupt("continue",37);case 25:if(a.toLowerCase().includes("bot")){e.next=36;break}return e.prev=26,e.next=29,this.client.kick(t,o.userId,"Kicking non-bot member");case 29:e.next=34;break;case 31:e.prev=31,e.t0=e.catch(26),c.isDevDebug&&console.log("AiLC -- Matrix -- Failed to kick user: ".concat(o.userId),e.t0);case 34:e.next=37;break;case 36:c.isDevDebug&&console.log("AiLC -- Matrix -- User is a bot, not kicking: ".concat(o.userId));case 37:e.next=20;break;case 39:e.next=44;break;case 41:e.prev=41,e.t1=e.catch(18),i.e(e.t1);case 44:return e.prev=44,i.f(),e.finish(44);case 47:e.next=52;break;case 49:e.prev=49,e.t2=e.catch(0),c.isDevDebug&&console.log("AiLC -- Matrix -- Failed to join room",e.t2);case 52:case"end":return e.stop()}}),e,this,[[0,49],[18,41,44,47],[26,31]])}))),function(e){return t.apply(this,arguments)})},{key:"getOtherRoomMembers",value:(e=L(N().mark((function e(){var t,n,r,i,s,o,a;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c.matrixSynced){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.client.getRoom(c.roomId);case 5:if(n=e.sent){e.next=8;break}throw new Error("Room ".concat(c.roomId," could not be loaded."));case 8:return e.next=10,n.getJoinedMembers();case 10:return r=e.sent,e.next=13,this.client.getUserId();case 13:return i=e.sent,s=r.filter((function(e){return e.userId!==i})),o=s.map((function(e){return e.userId})),a=null===(t=o[0])||void 0===t?void 0:t.split(":")[0].replace("@",""),e.abrupt("return",a);case 20:return e.prev=20,e.t0=e.catch(2),console.error("Error fetching room members:",e.t0),e.abrupt("return",[]);case 24:case"end":return e.stop()}}),e,this,[[2,20]])}))),function(){return e.apply(this,arguments)})},{key:"listenForMessages",value:function(){var e=this;try{c.isDevDebug&&console.log("AiLC -- Matrix -- Listening sync"),this._validateClient(),this.client.on("Room.timeline",function(){var t=L(N().mark((function t(n){var r,i,s,o,a,l,u,d,h,p,g;return N().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("m.room.message"!==n.getType()){t.next=26;break}r=n.getId(),i=n.getContent(),s=i.msgtype,o=["m.image","m.video"].includes(s)?i.body.replace(/\.[^.]+$/,""):i.body,a=n.getSender(),l=new Date(n.getTs()).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0}),u=a.split(":")[0].replace("@",""),d=c.playerId?u.replace(/^visitor_/,"user_"):u,h=a===e.client.credentials.userId,t.t0=s,t.next="m.text"===t.t0?13:"m.image"===t.t0?17:"m.video"===t.t0?21:25;break;case 13:return t.next=15,y.displayMessage({event_id:r,messageContent:o,timestamp:l,senderName:d,isUserMessage:h,cdnUrl:b()});case 15:return h?y.displayLoading():y.removeLoading(),t.abrupt("break",26);case 17:return p=e._convertMatrixURL(i.url),y.displayMediaMessage(x(x(x(x({event_id:r,imageUrl:p,timestamp:l},h?"senderName":"receiverName",h?d:receiverName),"isUserMessage",h),"mediaTitle",o),"cdnUrl",b())),!h&&y.removeLoading(),t.abrupt("break",26);case 21:return g=e._convertMatrixURL(i.url),y.displayVideoMessage(x(x(x({event_id:r,videoUrl:g,timestamp:l},h?"senderName":"receiverName",h?d:receiverName),"isUserMessage",h),"cdnUrl",b())),!h&&y.removeLoading(),t.abrupt("break",26);case 25:console.warn("Unknown message type from user:",s);case 26:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),this.client.on("Room.receipt",(function(t){var n=t.getContent()||{};Object.keys(n).forEach((function(t){var r=n[t];r["m.read"]&&Object.keys(r["m.read"]).forEach((function(n){var i=r["m.read"][n],s=i.ts;i!==e.client.credentials.userId&&y.updateReadReceipt(t,n,s)}))}))}))}catch(e){c.isDevDebug&&console.log("AiLC -- Matrix -- Failed to listenForMessages:",e)}}}]);var e,t,n,r,i,s,l,d}();const j=new F;var q,K,$,V;function G(e){const t=$[e];return"string"!=typeof t?e.toString():t[0].toLowerCase()+t.substring(1).replace(/[A-Z]/g,(e=>"_"+e.toLowerCase()))}!function(e){e[e.Unary=0]="Unary",e[e.ServerStreaming=1]="ServerStreaming",e[e.ClientStreaming=2]="ClientStreaming",e[e.BiDiStreaming=3]="BiDiStreaming"}(q||(q={})),function(e){e[e.NoSideEffects=1]="NoSideEffects",e[e.Idempotent=2]="Idempotent"}(K||(K={})),(V=$||($={}))[V.Canceled=1]="Canceled",V[V.Unknown=2]="Unknown",V[V.InvalidArgument=3]="InvalidArgument",V[V.DeadlineExceeded=4]="DeadlineExceeded",V[V.NotFound=5]="NotFound",V[V.AlreadyExists=6]="AlreadyExists",V[V.PermissionDenied=7]="PermissionDenied",V[V.ResourceExhausted=8]="ResourceExhausted",V[V.FailedPrecondition=9]="FailedPrecondition",V[V.Aborted=10]="Aborted",V[V.OutOfRange=11]="OutOfRange",V[V.Unimplemented=12]="Unimplemented",V[V.Internal=13]="Internal",V[V.Unavailable=14]="Unavailable",V[V.DataLoss=15]="DataLoss",V[V.Unauthenticated=16]="Unauthenticated";class H extends Error{constructor(e,t=$.Unknown,n,r,i){super(function(e,t){return e.length?`[${G(t)}] ${e}`:`[${G(t)}]`}(e,t)),this.name="ConnectError",Object.setPrototypeOf(this,new.target.prototype),this.rawMessage=e,this.code=t,this.metadata=new Headers(null!=n?n:{}),this.details=null!=r?r:[],this.cause=i}static from(e,t=$.Unknown){return e instanceof H?e:e instanceof Error?"AbortError"==e.name?new H(e.message,$.Canceled):new H(e.message,t,void 0,void 0,e):new H(String(e),t,void 0,void 0,e)}static[Symbol.hasInstance](e){return e instanceof Error&&(Object.getPrototypeOf(e)===H.prototype||"ConnectError"===e.name&&"code"in e&&"number"==typeof e.code&&"metadata"in e&&"details"in e&&Array.isArray(e.details)&&"rawMessage"in e&&"string"==typeof e.rawMessage&&"cause"in e)}findDetails(e){const t="typeName"in e?{findMessage:t=>t===e.typeName?e:void 0}:e,n=[];for(const e of this.details){if("getType"in e){t.findMessage(e.getType().typeName)&&n.push(e);continue}const r=t.findMessage(e.type);if(r)try{n.push(r.fromBinary(e.value))}catch(e){}}return n}}var W=function(e){return this instanceof W?(this.v=e,this):new W(e)},J=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}},Y=function(e){return this instanceof Y?(this.v=e,this):new Y(e)};function z(e,t){return function(e,t){const n={};for(const[r,i]of Object.entries(e.methods)){const s=t(Object.assign(Object.assign({},i),{localName:r,service:e}));null!=s&&(n[r]=s)}return n}(e,(n=>{switch(n.kind){case q.Unary:return function(e,t,n){return async function(r,i){var s,o;const a=await e.unary(t,n,null==i?void 0:i.signal,null==i?void 0:i.timeoutMs,null==i?void 0:i.headers,r,null==i?void 0:i.contextValues);return null===(s=null==i?void 0:i.onHeader)||void 0===s||s.call(i,a.header),null===(o=null==i?void 0:i.onTrailer)||void 0===o||o.call(i,a.trailer),a.message}}(t,e,n);case q.ServerStreaming:return function(e,t,n){return function(r,i){return X(e.stream(t,n,null==i?void 0:i.signal,null==i?void 0:i.timeoutMs,null==i?void 0:i.headers,function(e){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return",(function(e){return function(t){return Promise.resolve(t).then(e,l)}})),r[Symbol.asyncIterator]=function(){return this},r;function o(e,t){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))},t&&(r[e]=t(r[e])))}function a(e,t){try{!function(e){e.value instanceof W?Promise.resolve(e.value.v).then(c,l):u(s[0][2],e)}(i[e](t))}catch(e){u(s[0][3],e)}}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,(function*(){yield W(yield*function(e){var t,n;return t={},r("next"),r("throw",(function(e){throw e})),r("return"),t[Symbol.iterator]=function(){return this},t;function r(r,i){t[r]=e[r]?function(t){return(n=!n)?{value:W(e[r](t)),done:!1}:i?i(t):t}:i}}(function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}}(e)))}))}([r]),null==i?void 0:i.contextValues),i)}}(t,e,n);case q.ClientStreaming:return function(e,t,n){return async function(r,i){var s,o,a,c,l,u;const d=await e.stream(t,n,null==i?void 0:i.signal,null==i?void 0:i.timeoutMs,null==i?void 0:i.headers,r,null==i?void 0:i.contextValues);let h;null===(l=null==i?void 0:i.onHeader)||void 0===l||l.call(i,d.header);let p=0;try{for(var g,f=!0,m=J(d.message);!(s=(g=await m.next()).done);f=!0)c=g.value,f=!1,h=c,p++}catch(e){o={error:e}}finally{try{f||s||!(a=m.return)||await a.call(m)}finally{if(o)throw o.error}}if(!h)throw new H("protocol error: missing response message",$.Unimplemented);if(p>1)throw new H("protocol error: received extra messages for client streaming method",$.Unimplemented);return null===(u=null==i?void 0:i.onTrailer)||void 0===u||u.call(i,d.trailer),h}}(t,e,n);case q.BiDiStreaming:return function(e,t,n){return function(r,i){return X(e.stream(t,n,null==i?void 0:i.signal,null==i?void 0:i.timeoutMs,null==i?void 0:i.headers,r,null==i?void 0:i.contextValues),i)}}(t,e,n);default:return null}}))}function X(e,t){const n=function(){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return",(function(e){return function(t){return Promise.resolve(t).then(e,l)}})),r[Symbol.asyncIterator]=function(){return this},r;function o(e,t){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))},t&&(r[e]=t(r[e])))}function a(e,t){try{!function(e){e.value instanceof Y?Promise.resolve(e.value.v).then(c,l):u(s[0][2],e)}(i[e](t))}catch(e){u(s[0][3],e)}}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,(function*(){var n,r;const i=yield Y(e);null===(n=null==t?void 0:t.onHeader)||void 0===n||n.call(t,i.header),yield Y(yield*function(e){var t,n;return t={},r("next"),r("throw",(function(e){throw e})),r("return"),t[Symbol.iterator]=function(){return this},t;function r(r,i){t[r]=e[r]?function(t){return(n=!n)?{value:Y(e[r](t)),done:!1}:i?i(t):t}:i}}(J(i.message))),null===(r=null==t?void 0:t.onTrailer)||void 0===r||r.call(t,i.trailer)}))}()[Symbol.asyncIterator]();return{[Symbol.asyncIterator]:()=>({next:()=>n.next()})}}function Q(){return{get(e){return e.id in this?this[e.id]:e.defaultValue},set(e,t){return this[e.id]=t,this},delete(e){return delete this[e.id],this}}}function Z(e,t,n,r){const i=t?ee(e.I,r):te(e.I,n);return{parse:(t?ee(e.O,r):te(e.O,n)).parse,serialize:i.serialize}}function ee(e,t){return{parse(n){try{return e.fromBinary(n,t)}catch(e){const t=e instanceof Error?e.message:String(e);throw new H(`parse binary: ${t}`,$.Internal)}},serialize(e){try{return e.toBinary(t)}catch(e){const t=e instanceof Error?e.message:String(e);throw new H(`serialize binary: ${t}`,$.Internal)}}}}function te(e,t){var n,r;const i=null!==(n=null==t?void 0:t.textEncoder)&&void 0!==n?n:new TextEncoder,s=null!==(r=null==t?void 0:t.textDecoder)&&void 0!==r?r:new TextDecoder,o=function(e){var t;const n=Object.assign({},e);return null!==(t=n.ignoreUnknownFields)&&void 0!==t||(n.ignoreUnknownFields=!0),n}(t);return{parse(t){try{const n=s.decode(t);return e.fromJsonString(n,o)}catch(e){throw H.from(e,$.InvalidArgument)}},serialize(e){try{const t=e.toJsonString(o);return i.encode(t)}catch(e){throw H.from(e,$.Internal)}}}}function ne(e,t){var n;return null!==(n=null==t?void 0:t.concat().reverse().reduce(((e,t)=>t(e)),e))&&void 0!==n?n:e}function re(e){if(!e.aborted)return;if(void 0!==e.reason)return e.reason;const t=new Error("This operation was aborted");return t.name="AbortError",t}function ie(e,t){return t instanceof e?t:new e(t)}function se(e,t){function n(t){return!0===t.done?t:{done:t.done,value:ie(e,t.value)}}return{[Symbol.asyncIterator](){const e=t[Symbol.asyncIterator](),r={next:()=>e.next().then(n)};return void 0!==e.throw&&(r.throw=t=>e.throw(t).then(n)),void 0!==e.return&&(r.return=t=>e.return(t).then(n)),r}}}function oe(e){const{signal:t,cleanup:n}=function(e){const t=new AbortController,n=()=>{t.abort(new H("the operation timed out",$.DeadlineExceeded))};let r;return void 0!==e&&(e<=0?n():r=setTimeout(n,e)),{signal:t.signal,cleanup:()=>clearTimeout(r)}}(e.timeoutMs),r=function(...e){const t=new AbortController,n=e.filter((e=>void 0!==e)).concat(t.signal);for(const e of n){if(e.aborted){r.apply(e);break}e.addEventListener("abort",r)}function r(){t.signal.aborted||t.abort(re(this));for(const e of n)e.removeEventListener("abort",r)}return t}(e.signal,t);return[r.signal,function(e){const i=H.from(t.aborted?re(t):e);return r.abort(i),n(),Promise.reject(i)},function(){n(),r.abort()}]}function ae(e,t,n){const r="string"==typeof t?t:t.typeName,i="string"==typeof n?n:n.name;return e.toString().replace(/\/?$/,`/${r}/${i}`)}function ce(e){let t,n=new Uint8Array(0);function r(e){const t=new Uint8Array(n.length+e.length);t.set(n),t.set(e,n.length),n=t}return new ReadableStream({start(){t=e.getReader()},async pull(e){let i;for(;;){if(void 0===i&&n.byteLength>=5){let e=0;for(let t=1;t<5;t++)e=(e<<8)+n[t];i={flags:n[0],length:e}}if(void 0!==i&&n.byteLength>=i.length+5)break;const e=await t.read();if(e.done)break;r(e.value)}if(void 0===i)return 0==n.byteLength?void e.close():void e.error(new H("premature end of stream",$.DataLoss));const s=n.subarray(5,5+i.length);n=n.subarray(5+i.length),e.enqueue({flags:i.flags,data:s})}})}function le(e,t){const n=new Uint8Array(t.length+5);n.set(t,5);const r=new DataView(n.buffer,n.byteOffset,n.byteLength);return r.setUint8(0,e),r.setUint32(1,t.length),n}const ue="Grpc-Status",de="Grpc-Message";function he(e,t,n,r){const i=new Headers(null!=n?n:{});return i.set("Content-Type",e?"application/grpc-web+proto":"application/grpc-web+json"),i.set("X-Grpc-Web","1"),i.set("X-User-Agent","connect-es/1.6.1"),r&&i.set("User-Agent","connect-es/1.6.1"),void 0!==t&&i.set("Grpc-Timeout",`${t}m`),i}class pe{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const n=this.getType().runtime.bin,r=n.makeReadOptions(t);return n.readMessage(this,r.readerFactory(e),e.byteLength,r),this}fromJson(e,t){const n=this.getType(),r=n.runtime.json,i=r.makeReadOptions(t);return r.readMessage(n,e,i,this),this}fromJsonString(e,t){let n;try{n=JSON.parse(e)}catch(e){throw new Error(`cannot decode ${this.getType().typeName} from JSON: ${e instanceof Error?e.message:String(e)}`)}return this.fromJson(n,t)}toBinary(e){const t=this.getType().runtime.bin,n=t.makeWriteOptions(e),r=n.writerFactory();return t.writeMessage(this,r,n),r.finish()}toJson(e){const t=this.getType().runtime.json,n=t.makeWriteOptions(e);return t.writeMessage(this,n)}toJsonString(e){var t;const n=this.toJson(e);return JSON.stringify(n,null,null!==(t=null==e?void 0:e.prettySpaces)&&void 0!==t?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function ge(e,t){if(!e)throw new Error(t)}function fe(e){if("number"!=typeof e)throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw new Error("invalid int 32: "+e)}function me(e){if("number"!=typeof e)throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw new Error("invalid uint 32: "+e)}function ve(e){if("number"!=typeof e)throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw new Error("invalid float 32: "+e)}const ye=Symbol("@bufbuild/protobuf/enum-type");function _e(e,t,n,r){e[ye]=be(t,n.map((t=>({no:t.no,name:t.name,localName:e[t.no]}))))}function be(e,t,n){const r=Object.create(null),i=Object.create(null),s=[];for(const e of t){const t=Ee(e);s.push(t),r[e.name]=t,i[e.no]=t}return{typeName:e,values:s,findName:e=>r[e],findNumber:e=>i[e]}}function Ee(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}function Ae(){let e=0,t=0;for(let n=0;n<28;n+=7){let r=this.buf[this.pos++];if(e|=(127&r)<<n,!(128&r))return this.assertBounds(),[e,t]}let n=this.buf[this.pos++];if(e|=(15&n)<<28,t=(112&n)>>4,!(128&n))return this.assertBounds(),[e,t];for(let n=3;n<=31;n+=7){let r=this.buf[this.pos++];if(t|=(127&r)<<n,!(128&r))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function Se(e,t,n){for(let r=0;r<28;r+=7){const i=e>>>r,s=!(i>>>7==0&&0==t),o=255&(s?128|i:i);if(n.push(o),!s)return}const r=e>>>28&15|(7&t)<<4,i=!!(t>>3);if(n.push(255&(i?128|r:r)),i){for(let e=3;e<31;e+=7){const r=t>>>e,i=!(r>>>7==0),s=255&(i?128|r:r);if(n.push(s),!i)return}n.push(t>>>31&1)}}const we=4294967296;function Ie(e){const t="-"===e[0];t&&(e=e.slice(1));const n=1e6;let r=0,i=0;function s(t,s){const o=Number(e.slice(t,s));i*=n,r=r*n+o,r>=we&&(i+=r/we|0,r%=we)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),t?Re(r,i):ke(r,i)}function Te(e,t){if(({lo:e,hi:t}=function(e,t){return{lo:e>>>0,hi:t>>>0}}(e,t)),t<=2097151)return String(we*t+e);const n=16777215&(e>>>24|t<<8),r=t>>16&65535;let i=(16777215&e)+6777216*n+6710656*r,s=n+8147497*r,o=2*r;const a=1e7;return i>=a&&(s+=Math.floor(i/a),i%=a),s>=a&&(o+=Math.floor(s/a),s%=a),o.toString()+Oe(s)+Oe(i)}function ke(e,t){return{lo:0|e,hi:0|t}}function Re(e,t){return t=~t,e?e=1+~e:t+=1,ke(e,t)}const Oe=e=>{const t=String(e);return"0000000".slice(t.length)+t};function Ce(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let n=0;n<9;n++)t.push(127&e|128),e>>=7;t.push(1)}}function Pe(){let e=this.buf[this.pos++],t=127&e;if(!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<7,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<14,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<21,!(128&e))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(15&e)<<28;for(let t=5;128&e&&t<10;t++)e=this.buf[this.pos++];if(128&e)throw new Error("invalid varint");return this.assertBounds(),t>>>0}const De=function(){const e=new DataView(new ArrayBuffer(8));if("function"==typeof BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64&&("object"!=typeof process||"object"!=typeof process.env||"1"!==process.env.BUF_BIGINT_DISABLE)){const t=BigInt("-9223372036854775808"),n=BigInt("9223372036854775807"),r=BigInt("0"),i=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(e){const r="bigint"==typeof e?e:BigInt(e);if(r>n||r<t)throw new Error(`int64 invalid: ${e}`);return r},uParse(e){const t="bigint"==typeof e?e:BigInt(e);if(t>i||t<r)throw new Error(`uint64 invalid: ${e}`);return t},enc(t){return e.setBigInt64(0,this.parse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},uEnc(t){return e.setBigInt64(0,this.uParse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},dec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigInt64(0,!0)),uDec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigUint64(0,!0))}}const t=e=>ge(/^-?[0-9]+$/.test(e),`int64 invalid: ${e}`),n=e=>ge(/^[0-9]+$/.test(e),`uint64 invalid: ${e}`);return{zero:"0",supported:!1,parse:e=>("string"!=typeof e&&(e=e.toString()),t(e),e),uParse:e=>("string"!=typeof e&&(e=e.toString()),n(e),e),enc:e=>("string"!=typeof e&&(e=e.toString()),t(e),Ie(e)),uEnc:e=>("string"!=typeof e&&(e=e.toString()),n(e),Ie(e)),dec:(e,t)=>function(e,t){let n=ke(e,t);const r=2147483648&n.hi;r&&(n=Re(n.lo,n.hi));const i=Te(n.lo,n.hi);return r?"-"+i:i}(e,t),uDec:(e,t)=>Te(e,t)}}();var Ne,xe;function Me(e,t,n){if(t===n)return!0;if(e==Ne.BYTES){if(!(t instanceof Uint8Array&&n instanceof Uint8Array))return!1;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1;return!0}switch(e){case Ne.UINT64:case Ne.FIXED64:case Ne.INT64:case Ne.SFIXED64:case Ne.SINT64:return t==n}return!1}function Le(e,t){switch(e){case Ne.BOOL:return!1;case Ne.UINT64:case Ne.FIXED64:case Ne.INT64:case Ne.SFIXED64:case Ne.SINT64:return 0==t?De.zero:"0";case Ne.DOUBLE:case Ne.FLOAT:return 0;case Ne.BYTES:return new Uint8Array(0);case Ne.STRING:return"";default:return 0}}function Be(e,t){switch(e){case Ne.BOOL:return!1===t;case Ne.STRING:return""===t;case Ne.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return 0==t}}function Ue(e){const t=e.field.localName,n=Object.create(null);return n[t]=function(e){const t=e.field;if(t.repeated)return[];if(void 0!==t.default)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return Le(t.T,t.L);case"message":const e=t.T,n=new e;return e.fieldWrapper?e.fieldWrapper.unwrapField(n):n;case"map":throw"map fields are not allowed to be extensions"}}(e),[n,()=>n[t]]}!function(e){e[e.DOUBLE=1]="DOUBLE",e[e.FLOAT=2]="FLOAT",e[e.INT64=3]="INT64",e[e.UINT64=4]="UINT64",e[e.INT32=5]="INT32",e[e.FIXED64=6]="FIXED64",e[e.FIXED32=7]="FIXED32",e[e.BOOL=8]="BOOL",e[e.STRING=9]="STRING",e[e.BYTES=12]="BYTES",e[e.UINT32=13]="UINT32",e[e.SFIXED32=15]="SFIXED32",e[e.SFIXED64=16]="SFIXED64",e[e.SINT32=17]="SINT32",e[e.SINT64=18]="SINT64"}(Ne||(Ne={})),function(e){e[e.BIGINT=0]="BIGINT",e[e.STRING=1]="STRING"}(xe||(xe={}));let Fe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),je=[];for(let e=0;e<Fe.length;e++)je[Fe[e].charCodeAt(0)]=e;je["-".charCodeAt(0)]=Fe.indexOf("+"),je["_".charCodeAt(0)]=Fe.indexOf("/");const qe={dec(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let n,r=new Uint8Array(t),i=0,s=0,o=0;for(let t=0;t<e.length;t++){if(n=je[e.charCodeAt(t)],void 0===n)switch(e[t]){case"=":s=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(s){case 0:o=n,s=1;break;case 1:r[i++]=o<<2|(48&n)>>4,o=n,s=2;break;case 2:r[i++]=(15&o)<<4|(60&n)>>2,o=n,s=3;break;case 3:r[i++]=(3&o)<<6|n,s=0}}if(1==s)throw Error("invalid base64 string.");return r.subarray(0,i)},enc(e){let t,n="",r=0,i=0;for(let s=0;s<e.length;s++)switch(t=e[s],r){case 0:n+=Fe[t>>2],i=(3&t)<<4,r=1;break;case 1:n+=Fe[i|t>>4],i=(15&t)<<2,r=2;break;case 2:n+=Fe[i|t>>6],n+=Fe[63&t],r=0}return r&&(n+=Fe[i],n+="=",1==r&&(n+="=")),n}};function Ke(e,t,n){Ge(t,e);const r=t.runtime.bin.makeReadOptions(n),i=function(e,t){if(!t.repeated&&("enum"==t.kind||"scalar"==t.kind)){for(let n=e.length-1;n>=0;--n)if(e[n].no==t.no)return[e[n]];return[]}return e.filter((e=>e.no===t.no))}(e.getType().runtime.bin.listUnknownFields(e),t.field),[s,o]=Ue(t);for(const e of i)t.runtime.bin.readField(s,r.readerFactory(e.data),t.field,e.wireType,r);return o()}function $e(e,t,n,r){Ge(t,e);const i=t.runtime.bin.makeReadOptions(r),s=t.runtime.bin.makeWriteOptions(r);if(Ve(e,t)){const n=e.getType().runtime.bin.listUnknownFields(e).filter((e=>e.no!=t.field.no));e.getType().runtime.bin.discardUnknownFields(e);for(const t of n)e.getType().runtime.bin.onUnknownField(e,t.no,t.wireType,t.data)}const o=s.writerFactory();let a=t.field;a.opt||a.repeated||"enum"!=a.kind&&"scalar"!=a.kind||(a=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(a,n,o,s);const c=i.readerFactory(o.finish());for(;c.pos<c.len;){const[t,n]=c.tag(),r=c.skip(n,t);e.getType().runtime.bin.onUnknownField(e,t,n,r)}}function Ve(e,t){const n=e.getType();return t.extendee.typeName===n.typeName&&!!n.runtime.bin.listUnknownFields(e).find((e=>e.no==t.field.no))}function Ge(e,t){ge(e.extendee.typeName==t.getType().typeName,`extension ${e.typeName} can only be applied to message ${e.extendee.typeName}`)}function He(e,t){const n=e.localName;if(e.repeated)return t[n].length>0;if(e.oneof)return t[e.oneof.localName].case===n;switch(e.kind){case"enum":case"scalar":return e.opt||e.req?void 0!==t[n]:"enum"==e.kind?t[n]!==e.T.values[0].no:!Be(e.T,t[n]);case"message":return void 0!==t[n];case"map":return Object.keys(t[n]).length>0}}function We(e,t){const n=e.localName,r=!e.opt&&!e.req;if(e.repeated)t[n]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[n]={};break;case"enum":t[n]=r?e.T.values[0].no:void 0;break;case"scalar":t[n]=r?Le(e.T,e.L):void 0;break;case"message":t[n]=void 0}}function Je(e,t){if(null===e||"object"!=typeof e)return!1;if(!Object.getOwnPropertyNames(pe.prototype).every((t=>t in e&&"function"==typeof e[t])))return!1;const n=e.getType();return null!==n&&"function"==typeof n&&"typeName"in n&&"string"==typeof n.typeName&&(void 0===t||n.typeName==t.typeName)}function Ye(e,t){return Je(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}Ne.DOUBLE,Ne.FLOAT,Ne.INT64,Ne.UINT64,Ne.INT32,Ne.UINT32,Ne.BOOL,Ne.STRING,Ne.BYTES;const ze={ignoreUnknownFields:!1},Xe={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};const Qe=Symbol(),Ze=Symbol();function et(e){if(null===e)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":`"${e.split('"').join('\\"')}"`;default:return String(e)}}function tt(e,t,n,r,i){let s=n.localName;if(n.repeated){if(ge("map"!=n.kind),null===t)return;if(!Array.isArray(t))throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: ${et(t)}`);const o=e[s];for(const e of t){if(null===e)throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: ${et(e)}`);switch(n.kind){case"message":o.push(n.T.fromJson(e,r));break;case"enum":const t=it(n.T,e,r.ignoreUnknownFields,!0);t!==Ze&&o.push(t);break;case"scalar":try{o.push(rt(n.T,e,n.L,!0))}catch(t){let r=`cannot decode field ${i.typeName}.${n.name} from JSON: ${et(e)}`;throw t instanceof Error&&t.message.length>0&&(r+=`: ${t.message}`),new Error(r)}}}}else if("map"==n.kind){if(null===t)return;if("object"!=typeof t||Array.isArray(t))throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: ${et(t)}`);const o=e[s];for(const[e,s]of Object.entries(t)){if(null===s)throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: map value null`);let a;try{a=nt(n.K,e)}catch(e){let r=`cannot decode map key for field ${i.typeName}.${n.name} from JSON: ${et(t)}`;throw e instanceof Error&&e.message.length>0&&(r+=`: ${e.message}`),new Error(r)}switch(n.V.kind){case"message":o[a]=n.V.T.fromJson(s,r);break;case"enum":const e=it(n.V.T,s,r.ignoreUnknownFields,!0);e!==Ze&&(o[a]=e);break;case"scalar":try{o[a]=rt(n.V.T,s,xe.BIGINT,!0)}catch(e){let r=`cannot decode map value for field ${i.typeName}.${n.name} from JSON: ${et(t)}`;throw e instanceof Error&&e.message.length>0&&(r+=`: ${e.message}`),new Error(r)}}}}else switch(n.oneof&&(e=e[n.oneof.localName]={case:s},s="value"),n.kind){case"message":const o=n.T;if(null===t&&"google.protobuf.Value"!=o.typeName)return;let a=e[s];Je(a)?a.fromJson(t,r):(e[s]=a=o.fromJson(t,r),o.fieldWrapper&&!n.oneof&&(e[s]=o.fieldWrapper.unwrapField(a)));break;case"enum":const c=it(n.T,t,r.ignoreUnknownFields,!1);switch(c){case Qe:We(n,e);break;case Ze:break;default:e[s]=c}break;case"scalar":try{const r=rt(n.T,t,n.L,!1);r===Qe?We(n,e):e[s]=r}catch(e){let r=`cannot decode field ${i.typeName}.${n.name} from JSON: ${et(t)}`;throw e instanceof Error&&e.message.length>0&&(r+=`: ${e.message}`),new Error(r)}}}function nt(e,t){if(e===Ne.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1}return rt(e,t,xe.BIGINT,!0).toString()}function rt(e,t,n,r){if(null===t)return r?Le(e,n):Qe;switch(e){case Ne.DOUBLE:case Ne.FLOAT:if("NaN"===t)return Number.NaN;if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if(""===t)break;if("string"==typeof t&&t.trim().length!==t.length)break;if("string"!=typeof t&&"number"!=typeof t)break;const r=Number(t);if(Number.isNaN(r))break;if(!Number.isFinite(r))break;return e==Ne.FLOAT&&ve(r),r;case Ne.INT32:case Ne.FIXED32:case Ne.SFIXED32:case Ne.SINT32:case Ne.UINT32:let i;if("number"==typeof t?i=t:"string"==typeof t&&t.length>0&&t.trim().length===t.length&&(i=Number(t)),void 0===i)break;return e==Ne.UINT32||e==Ne.FIXED32?me(i):fe(i),i;case Ne.INT64:case Ne.SFIXED64:case Ne.SINT64:if("number"!=typeof t&&"string"!=typeof t)break;const s=De.parse(t);return n?s.toString():s;case Ne.FIXED64:case Ne.UINT64:if("number"!=typeof t&&"string"!=typeof t)break;const o=De.uParse(t);return n?o.toString():o;case Ne.BOOL:if("boolean"!=typeof t)break;return t;case Ne.STRING:if("string"!=typeof t)break;try{encodeURIComponent(t)}catch(e){throw new Error("invalid UTF8")}return t;case Ne.BYTES:if(""===t)return new Uint8Array(0);if("string"!=typeof t)break;return qe.dec(t)}throw new Error}function it(e,t,n,r){if(null===t)return"google.protobuf.NullValue"==e.typeName?0:r?e.values[0].no:Qe;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const r=e.findName(t);if(void 0!==r)return r.no;if(n)return Ze}throw new Error(`cannot decode enum ${e.typeName} from JSON: ${et(t)}`)}function st(e){return!(!e.repeated&&"map"!=e.kind&&(e.oneof||"message"==e.kind||e.opt||e.req))}function ot(e,t,n){if("map"==e.kind){ge("object"==typeof t&&null!=t);const r={},i=Object.entries(t);switch(e.V.kind){case"scalar":for(const[t,n]of i)r[t.toString()]=ct(e.V.T,n);break;case"message":for(const[e,t]of i)r[e.toString()]=t.toJson(n);break;case"enum":const t=e.V.T;for(const[e,s]of i)r[e.toString()]=at(t,s,n.enumAsInteger)}return n.emitDefaultValues||i.length>0?r:void 0}if(e.repeated){ge(Array.isArray(t));const r=[];switch(e.kind){case"scalar":for(let n=0;n<t.length;n++)r.push(ct(e.T,t[n]));break;case"enum":for(let i=0;i<t.length;i++)r.push(at(e.T,t[i],n.enumAsInteger));break;case"message":for(let e=0;e<t.length;e++)r.push(t[e].toJson(n))}return n.emitDefaultValues||r.length>0?r:void 0}switch(e.kind){case"scalar":return ct(e.T,t);case"enum":return at(e.T,t,n.enumAsInteger);case"message":return Ye(e.T,t).toJson(n)}}function at(e,t,n){var r;if(ge("number"==typeof t),"google.protobuf.NullValue"==e.typeName)return null;if(n)return t;const i=e.findNumber(t);return null!==(r=null==i?void 0:i.name)&&void 0!==r?r:t}function ct(e,t){switch(e){case Ne.INT32:case Ne.SFIXED32:case Ne.SINT32:case Ne.FIXED32:case Ne.UINT32:return ge("number"==typeof t),t;case Ne.FLOAT:case Ne.DOUBLE:return ge("number"==typeof t),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case Ne.STRING:return ge("string"==typeof t),t;case Ne.BOOL:return ge("boolean"==typeof t),t;case Ne.UINT64:case Ne.FIXED64:case Ne.INT64:case Ne.SFIXED64:case Ne.SINT64:return ge("bigint"==typeof t||"string"==typeof t||"number"==typeof t),t.toString();case Ne.BYTES:return ge(t instanceof Uint8Array),qe.enc(t)}}var lt;!function(e){e[e.Varint=0]="Varint",e[e.Bit64=1]="Bit64",e[e.LengthDelimited=2]="LengthDelimited",e[e.StartGroup=3]="StartGroup",e[e.EndGroup=4]="EndGroup",e[e.Bit32=5]="Bit32"}(lt||(lt={}));class ut{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e),n=0;for(let e=0;e<this.chunks.length;e++)t.set(this.chunks[e],n),n+=this.chunks[e].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(me(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return fe(e),Ce(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){ve(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){me(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){fe(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return fe(e),Ce(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),r=De.enc(e);return n.setInt32(0,r.lo,!0),n.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),r=De.uEnc(e);return n.setInt32(0,r.lo,!0),n.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=De.enc(e);return Se(t.lo,t.hi,this.buf),this}sint64(e){let t=De.enc(e),n=t.hi>>31;return Se(t.lo<<1^n,(t.hi<<1|t.lo>>>31)^n,this.buf),this}uint64(e){let t=De.uEnc(e);return Se(t.lo,t.hi,this.buf),this}}class dt{constructor(e,t){this.varint64=Ae,this.uint32=Pe,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,n=7&e;if(t<=0||n<0||n>5)throw new Error("illegal tag: field no "+t+" wire type "+n);return[t,n]}skip(e,t){let n=this.pos;switch(e){case lt.Varint:for(;128&this.buf[this.pos++];);break;case lt.Bit64:this.pos+=4;case lt.Bit32:this.pos+=4;break;case lt.LengthDelimited:let n=this.uint32();this.pos+=n;break;case lt.StartGroup:for(;;){const[e,n]=this.tag();if(n===lt.EndGroup){if(void 0!==t&&e!==t)throw new Error("invalid end group tag");break}this.skip(n,e)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(n,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return De.dec(...this.varint64())}uint64(){return De.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),n=-(1&e);return e=(e>>>1|(1&t)<<31)^n,t=t>>>1^n,De.dec(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return De.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return De.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}const ht=Symbol("@bufbuild/protobuf/unknown-fields"),pt={readUnknownFields:!0,readerFactory:e=>new dt(e)},gt={writeUnknownFields:!0,writerFactory:()=>new ut};function ft(e,t,n,r,i){let{repeated:s,localName:o}=n;switch(n.oneof&&((e=e[n.oneof.localName]).case!=o&&delete e.value,e.case=o,o="value"),n.kind){case"scalar":case"enum":const a="enum"==n.kind?Ne.INT32:n.T;let c=yt;if("scalar"==n.kind&&n.L>0&&(c=vt),s){let n=e[o];if(r==lt.LengthDelimited&&a!=Ne.STRING&&a!=Ne.BYTES){let e=t.uint32()+t.pos;for(;t.pos<e;)n.push(c(t,a))}else n.push(c(t,a))}else e[o]=c(t,a);break;case"message":const l=n.T;s?e[o].push(mt(t,new l,i,n)):Je(e[o])?mt(t,e[o],i,n):(e[o]=mt(t,new l,i,n),!l.fieldWrapper||n.oneof||n.repeated||(e[o]=l.fieldWrapper.unwrapField(e[o])));break;case"map":let[u,d]=function(e,t,n){const r=t.uint32(),i=t.pos+r;let s,o;for(;t.pos<i;){const[r]=t.tag();switch(r){case 1:s=yt(t,e.K);break;case 2:switch(e.V.kind){case"scalar":o=yt(t,e.V.T);break;case"enum":o=t.int32();break;case"message":o=mt(t,new e.V.T,n,void 0)}}}if(void 0===s&&(s=Le(e.K,xe.BIGINT)),"string"!=typeof s&&"number"!=typeof s&&(s=s.toString()),void 0===o)switch(e.V.kind){case"scalar":o=Le(e.V.T,xe.BIGINT);break;case"enum":o=e.V.T.values[0].no;break;case"message":o=new e.V.T}return[s,o]}(n,t,i);e[o][u]=d}}function mt(e,t,n,r){const i=t.getType().runtime.bin,s=null==r?void 0:r.delimited;return i.readMessage(t,e,s?r.no:e.uint32(),n,s),t}function vt(e,t){const n=yt(e,t);return"bigint"==typeof n?n.toString():n}function yt(e,t){switch(t){case Ne.STRING:return e.string();case Ne.BOOL:return e.bool();case Ne.DOUBLE:return e.double();case Ne.FLOAT:return e.float();case Ne.INT32:return e.int32();case Ne.INT64:return e.int64();case Ne.UINT64:return e.uint64();case Ne.FIXED64:return e.fixed64();case Ne.BYTES:return e.bytes();case Ne.FIXED32:return e.fixed32();case Ne.SFIXED32:return e.sfixed32();case Ne.SFIXED64:return e.sfixed64();case Ne.SINT64:return e.sint64();case Ne.UINT32:return e.uint32();case Ne.SINT32:return e.sint32()}}function _t(e,t,n,r){ge(void 0!==t);const i=e.repeated;switch(e.kind){case"scalar":case"enum":let s="enum"==e.kind?Ne.INT32:e.T;if(i)if(ge(Array.isArray(t)),e.packed)!function(e,t,n,r){if(!r.length)return;e.tag(n,lt.LengthDelimited).fork();let[,i]=St(t);for(let t=0;t<r.length;t++)e[i](r[t]);e.join()}(n,s,e.no,t);else for(const r of t)At(n,s,e.no,r);else At(n,s,e.no,t);break;case"message":if(i){ge(Array.isArray(t));for(const i of t)Et(n,r,e,i)}else Et(n,r,e,t);break;case"map":ge("object"==typeof t&&null!=t);for(const[i,s]of Object.entries(t))bt(n,r,e,i,s)}}function bt(e,t,n,r,i){e.tag(n.no,lt.LengthDelimited),e.fork();let s=r;switch(n.K){case Ne.INT32:case Ne.FIXED32:case Ne.UINT32:case Ne.SFIXED32:case Ne.SINT32:s=Number.parseInt(r);break;case Ne.BOOL:ge("true"==r||"false"==r),s="true"==r}switch(At(e,n.K,1,s),n.V.kind){case"scalar":At(e,n.V.T,2,i);break;case"enum":At(e,Ne.INT32,2,i);break;case"message":ge(void 0!==i),e.tag(2,lt.LengthDelimited).bytes(i.toBinary(t))}e.join()}function Et(e,t,n,r){const i=Ye(n.T,r);n.delimited?e.tag(n.no,lt.StartGroup).raw(i.toBinary(t)).tag(n.no,lt.EndGroup):e.tag(n.no,lt.LengthDelimited).bytes(i.toBinary(t))}function At(e,t,n,r){ge(void 0!==r);let[i,s]=St(t);e.tag(n,i)[s](r)}function St(e){let t=lt.Varint;switch(e){case Ne.BYTES:case Ne.STRING:t=lt.LengthDelimited;break;case Ne.DOUBLE:case Ne.FIXED64:case Ne.SFIXED64:t=lt.Bit64;break;case Ne.FIXED32:case Ne.SFIXED32:case Ne.FLOAT:t=lt.Bit32}return[t,Ne[e].toLowerCase()]}function wt(e){if(void 0===e)return e;if(Je(e))return e.clone();if(e instanceof Uint8Array){const t=new Uint8Array(e.byteLength);return t.set(e),t}return e}function It(e){return e instanceof Uint8Array?e:new Uint8Array(e)}class Tt{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const e={};for(const t of this.list())e[t.jsonName]=e[t.name]=t;this.jsonNames=e}return this.jsonNames[e]}find(e){if(!this.numbers){const e={};for(const t of this.list())e[t.no]=t;this.numbers=e}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort(((e,t)=>e.no-t.no))),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const n of this.list())n.oneof?n.oneof!==t&&(t=n.oneof,e.push(t)):e.push(n)}return this.members}}function kt(e,t){const n=Ot(e);return t?n:xt(Nt(n))}const Rt=Ot;function Ot(e){let t=!1;const n=[];for(let r=0;r<e.length;r++){let i=e.charAt(r);switch(i){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":n.push(i),t=!1;break;default:t&&(t=!1,i=i.toUpperCase()),n.push(i)}}return n.join("")}new Set(["break","case","catch","class","const","continue","debugger","default","delete","do","else","export","extends","false","finally","for","function","if","import","in","instanceof","new","null","return","super","switch","this","throw","true","try","typeof","var","void","while","with","yield","enum","implements","interface","let","package","private","protected","public","static","Object","bigint","number","boolean","string","object","globalThis","Uint8Array","Partial"]);const Ct=new Set(["constructor","toString","toJSON","valueOf"]),Pt=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Dt=e=>`${e}$`,Nt=e=>Pt.has(e)?Dt(e):e,xt=e=>Ct.has(e)?Dt(e):e;class Mt{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=kt(e,!1)}addField(e){ge(e.oneof===this,`field ${e.name} not one of ${this.name}`),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let e=0;e<this.fields.length;e++)this._lookup[this.fields[e].localName]=this.fields[e]}return this._lookup[e]}}const Lt=(Bt=e=>new Tt(e,(e=>function(e){var t,n,r,i,s,o;const a=[];let c;for(const l of"function"==typeof e?e():e){const e=l;if(e.localName=kt(l.name,void 0!==l.oneof),e.jsonName=null!==(t=l.jsonName)&&void 0!==t?t:Rt(l.name),e.repeated=null!==(n=l.repeated)&&void 0!==n&&n,"scalar"==l.kind&&(e.L=null!==(r=l.L)&&void 0!==r?r:xe.BIGINT),e.delimited=null!==(i=l.delimited)&&void 0!==i&&i,e.req=null!==(s=l.req)&&void 0!==s&&s,e.opt=null!==(o=l.opt)&&void 0!==o&&o,void 0===l.packed&&(e.packed="enum"==l.kind||"scalar"==l.kind&&l.T!=Ne.BYTES&&l.T!=Ne.STRING),void 0!==l.oneof){const t="string"==typeof l.oneof?l.oneof:l.oneof.name;c&&c.name==t||(c=new Mt(t)),e.oneof=c,c.addField(e)}a.push(e)}return a}(e))),Ut=e=>{for(const t of e.getType().fields.byMember()){if(t.opt)continue;const n=t.localName,r=e;if(t.repeated)r[n]=[];else switch(t.kind){case"oneof":r[n]={case:void 0};break;case"enum":r[n]=0;break;case"map":r[n]={};break;case"scalar":r[n]=Le(t.T,t.L)}}},{syntax:"proto3",json:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},ze),e):ze},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},Xe),e):Xe},readMessage(e,t,n,r){if(null==t||Array.isArray(t)||"object"!=typeof t)throw new Error(`cannot decode message ${e.typeName} from JSON: ${et(t)}`);r=null!=r?r:new e;const i=new Map,s=n.typeRegistry;for(const[o,a]of Object.entries(t)){const t=e.fields.findJsonName(o);if(t){if(t.oneof){if(null===a&&"scalar"==t.kind)continue;const n=i.get(t.oneof);if(void 0!==n)throw new Error(`cannot decode message ${e.typeName} from JSON: multiple keys for oneof "${t.oneof.name}" present: "${n}", "${o}"`);i.set(t.oneof,o)}tt(r,a,t,n,e)}else{let t=!1;if((null==s?void 0:s.findExtension)&&o.startsWith("[")&&o.endsWith("]")){const i=s.findExtension(o.substring(1,o.length-1));if(i&&i.extendee.typeName==e.typeName){t=!0;const[e,s]=Ue(i);tt(e,a,i.field,n,i),$e(r,i,s(),n)}}if(!t&&!n.ignoreUnknownFields)throw new Error(`cannot decode message ${e.typeName} from JSON: key "${o}" is unknown`)}}return r},writeMessage(e,t){const n=e.getType(),r={};let i;try{for(i of n.fields.byNumber()){if(!He(i,e)){if(i.req)throw"required field not set";if(!t.emitDefaultValues)continue;if(!st(i))continue}const n=ot(i,i.oneof?e[i.oneof.localName].value:e[i.localName],t);void 0!==n&&(r[t.useProtoFieldName?i.name:i.jsonName]=n)}const s=t.typeRegistry;if(null==s?void 0:s.findExtensionFor)for(const i of n.runtime.bin.listUnknownFields(e)){const o=s.findExtensionFor(n.typeName,i.no);if(o&&Ve(e,o)){const n=Ke(e,o,t),i=ot(o.field,n,t);void 0!==i&&(r[o.field.jsonName]=i)}}}catch(e){const t=i?`cannot encode field ${n.typeName}.${i.name} to JSON`:`cannot encode message ${n.typeName} to JSON`,r=e instanceof Error?e.message:String(e);throw new Error(t+(r.length>0?`: ${r}`:""))}return r},readScalar:(e,t,n)=>rt(e,t,null!=n?n:xe.BIGINT,!0),writeScalar(e,t,n){if(void 0!==t)return n||Be(e,t)?ct(e,t):void 0},debug:et},bin:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},pt),e):pt},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},gt),e):gt},listUnknownFields(e){var t;return null!==(t=e[ht])&&void 0!==t?t:[]},discardUnknownFields(e){delete e[ht]},writeUnknownFields(e,t){const n=e[ht];if(n)for(const e of n)t.tag(e.no,e.wireType).raw(e.data)},onUnknownField(e,t,n,r){const i=e;Array.isArray(i[ht])||(i[ht]=[]),i[ht].push({no:t,wireType:n,data:r})},readMessage(e,t,n,r,i){const s=e.getType(),o=i?t.len:t.pos+n;let a,c;for(;t.pos<o&&([a,c]=t.tag(),!0!==i||c!=lt.EndGroup);){const n=s.fields.find(a);if(n)ft(e,t,n,c,r);else{const n=t.skip(c,a);r.readUnknownFields&&this.onUnknownField(e,a,c,n)}}if(i&&(c!=lt.EndGroup||a!==n))throw new Error("invalid end group tag")},readField:ft,writeMessage(e,t,n){const r=e.getType();for(const i of r.fields.byNumber())if(He(i,e))_t(i,i.oneof?e[i.oneof.localName].value:e[i.localName],t,n);else if(i.req)throw new Error(`cannot encode field ${r.typeName}.${i.name} to binary: required field not set`);return n.writeUnknownFields&&this.writeUnknownFields(e,t),t},writeField(e,t,n,r){void 0!==t&&_t(e,t,n,r)}},util:Object.assign(Object.assign({},{setEnumType:_e,initPartial(e,t){if(void 0===e)return;const n=t.getType();for(const r of n.fields.byMember()){const n=r.localName,i=t,s=e;if(null!=s[n])switch(r.kind){case"oneof":const e=s[n].case;if(void 0===e)continue;const t=r.findField(e);let o=s[n].value;t&&"message"==t.kind&&!Je(o,t.T)?o=new t.T(o):t&&"scalar"===t.kind&&t.T===Ne.BYTES&&(o=It(o)),i[n]={case:e,value:o};break;case"scalar":case"enum":let a=s[n];r.T===Ne.BYTES&&(a=r.repeated?a.map(It):It(a)),i[n]=a;break;case"map":switch(r.V.kind){case"scalar":case"enum":if(r.V.T===Ne.BYTES)for(const[e,t]of Object.entries(s[n]))i[n][e]=It(t);else Object.assign(i[n],s[n]);break;case"message":const e=r.V.T;for(const t of Object.keys(s[n])){let r=s[n][t];e.fieldWrapper||(r=new e(r)),i[n][t]=r}}break;case"message":const c=r.T;if(r.repeated)i[n]=s[n].map((e=>Je(e,c)?e:new c(e)));else{const e=s[n];c.fieldWrapper?"google.protobuf.BytesValue"===c.typeName?i[n]=It(e):i[n]=e:i[n]=Je(e,c)?e:new c(e)}}}},equals:(e,t,n)=>t===n||!(!t||!n)&&e.fields.byMember().every((e=>{const r=t[e.localName],i=n[e.localName];if(e.repeated){if(r.length!==i.length)return!1;switch(e.kind){case"message":return r.every(((t,n)=>e.T.equals(t,i[n])));case"scalar":return r.every(((t,n)=>Me(e.T,t,i[n])));case"enum":return r.every(((e,t)=>Me(Ne.INT32,e,i[t])))}throw new Error(`repeated cannot contain ${e.kind}`)}switch(e.kind){case"message":return e.T.equals(r,i);case"enum":return Me(Ne.INT32,r,i);case"scalar":return Me(e.T,r,i);case"oneof":if(r.case!==i.case)return!1;const t=e.findField(r.case);if(void 0===t)return!0;switch(t.kind){case"message":return t.T.equals(r.value,i.value);case"enum":return Me(Ne.INT32,r.value,i.value);case"scalar":return Me(t.T,r.value,i.value)}throw new Error(`oneof cannot contain ${t.kind}`);case"map":const n=Object.keys(r).concat(Object.keys(i));switch(e.V.kind){case"message":const t=e.V.T;return n.every((e=>t.equals(r[e],i[e])));case"enum":return n.every((e=>Me(Ne.INT32,r[e],i[e])));case"scalar":const s=e.V.T;return n.every((e=>Me(s,r[e],i[e])))}}})),clone(e){const t=e.getType(),n=new t,r=n;for(const n of t.fields.byMember()){const t=e[n.localName];let i;if(n.repeated)i=t.map(wt);else if("map"==n.kind){i=r[n.localName];for(const[e,n]of Object.entries(t))i[e]=wt(n)}else i="oneof"==n.kind?n.findField(t.case)?{case:t.case,value:wt(t.value)}:{case:void 0}:wt(t);r[n.localName]=i}for(const n of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(r,n.no,n.wireType,n.data);return n}}),{newFieldList:Bt,initFields:Ut}),makeMessageType(e,t,n){return function(e,t,n,r){var i;const s=null!==(i=null==r?void 0:r.localName)&&void 0!==i?i:t.substring(t.lastIndexOf(".")+1),o={[s]:function(t){e.util.initFields(this),e.util.initPartial(t,this)}}[s];return Object.setPrototypeOf(o.prototype,new pe),Object.assign(o,{runtime:e,typeName:t,fields:e.util.newFieldList(n),fromBinary:(e,t)=>(new o).fromBinary(e,t),fromJson:(e,t)=>(new o).fromJson(e,t),fromJsonString:(e,t)=>(new o).fromJsonString(e,t),equals:(t,n)=>e.util.equals(o,t,n)}),o}(this,e,t,n)},makeEnum:function(e,t,n){const r={};for(const e of t){const t=Ee(e);r[t.localName]=t.no,r[t.no]=t.localName}return _e(r,e,t),r},makeEnumType:be,getEnumType:function(e){const t=e[ye];return ge(t,"missing enum type on enum object"),t},makeExtension(e,t,n){return function(e,t,n,r){let i;return{typeName:t,extendee:n,get field(){if(!i){const n="function"==typeof r?r():r;n.name=t.split(".").pop(),n.jsonName=`[${t}]`,i=e.util.newFieldList([n]).list()[0]}return i},runtime:e}}(this,e,t,n)}});var Bt,Ut;class Ft extends pe{constructor(e){super(),this.typeUrl="",this.value=new Uint8Array(0),Lt.util.initPartial(e,this)}toJson(e){var t;if(""===this.typeUrl)return{};const n=this.typeUrlToName(this.typeUrl),r=null===(t=null==e?void 0:e.typeRegistry)||void 0===t?void 0:t.findMessage(n);if(!r)throw new Error(`cannot encode message google.protobuf.Any to JSON: "${this.typeUrl}" is not in the type registry`);let i=r.fromBinary(this.value).toJson(e);return(n.startsWith("google.protobuf.")||null===i||Array.isArray(i)||"object"!=typeof i)&&(i={value:i}),i["@type"]=this.typeUrl,i}fromJson(e,t){var n;if(null===e||Array.isArray(e)||"object"!=typeof e)throw new Error("cannot decode message google.protobuf.Any from JSON: expected object but got "+(null===e?"null":Array.isArray(e)?"array":typeof e));if(0==Object.keys(e).length)return this;const r=e["@type"];if("string"!=typeof r||""==r)throw new Error('cannot decode message google.protobuf.Any from JSON: "@type" is empty');const i=this.typeUrlToName(r),s=null===(n=null==t?void 0:t.typeRegistry)||void 0===n?void 0:n.findMessage(i);if(!s)throw new Error(`cannot decode message google.protobuf.Any from JSON: ${r} is not in the type registry`);let o;if(i.startsWith("google.protobuf.")&&Object.prototype.hasOwnProperty.call(e,"value"))o=s.fromJson(e.value,t);else{const n=Object.assign({},e);delete n["@type"],o=s.fromJson(n,t)}return this.packFrom(o),this}packFrom(e){this.value=e.toBinary(),this.typeUrl=this.typeNameToUrl(e.getType().typeName)}unpackTo(e){return!!this.is(e.getType())&&(e.fromBinary(this.value),!0)}unpack(e){if(""===this.typeUrl)return;const t=e.findMessage(this.typeUrlToName(this.typeUrl));return t?t.fromBinary(this.value):void 0}is(e){if(""===this.typeUrl)return!1;const t=this.typeUrlToName(this.typeUrl);let n="";return n="string"==typeof e?e:e.typeName,t===n}typeNameToUrl(e){return`type.googleapis.com/${e}`}typeUrlToName(e){if(!e.length)throw new Error(`invalid type url: ${e}`);const t=e.lastIndexOf("/"),n=t>=0?e.substring(t+1):e;if(!n.length)throw new Error(`invalid type url: ${e}`);return n}static pack(e){const t=new Ft;return t.packFrom(e),t}static fromBinary(e,t){return(new Ft).fromBinary(e,t)}static fromJson(e,t){return(new Ft).fromJson(e,t)}static fromJsonString(e,t){return(new Ft).fromJsonString(e,t)}static equals(e,t){return Lt.util.equals(Ft,e,t)}}Ft.runtime=Lt,Ft.typeName="google.protobuf.Any",Ft.fields=Lt.util.newFieldList((()=>[{no:1,name:"type_url",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:12}]));class jt extends pe{constructor(e){super(),this.code=0,this.message="",this.details=[],Lt.util.initPartial(e,this)}static fromBinary(e,t){return(new jt).fromBinary(e,t)}static fromJson(e,t){return(new jt).fromJson(e,t)}static fromJsonString(e,t){return(new jt).fromJsonString(e,t)}static equals(e,t){return Lt.util.equals(jt,e,t)}}function qt(e){var t;const n=e.get("Grpc-Status-Details-Bin");if(null!=n){const t=function(e,t){try{const n=qe.dec(e);return t?t.fromBinary(n,void 0):n}catch(e){throw H.from(e,$.DataLoss)}}(n,jt);if(0==t.code)return;const r=new H(t.message,t.code,e);return r.details=t.details.map((e=>({type:e.typeUrl.substring(e.typeUrl.lastIndexOf("/")+1),value:e.value}))),r}const r=e.get(ue);if(null!=r){if("0"===r)return;const n=parseInt(r,10);return n in $?new H(decodeURIComponent(null!==(t=e.get(de))&&void 0!==t?t:""),n,e):new H(`invalid grpc-status: ${r}`,$.Internal,e)}}function Kt(e,t){var n;if(e>=200&&e<300)return{foundStatus:t.has(ue),headerError:qt(t)};throw new H(decodeURIComponent(null!==(n=t.get(de))&&void 0!==n?n:`HTTP ${e}`),function(e){switch(e){case 400:return $.Internal;case 401:return $.Unauthenticated;case 403:return $.PermissionDenied;case 404:return $.Unimplemented;case 429:case 502:case 503:case 504:return $.Unavailable;default:return $.Unknown}}(e),t)}function $t(e){const t=new Headers,n=(new TextDecoder).decode(e).split("\r\n");for(const e of n){if(""===e)continue;const n=e.indexOf(":");if(n>0){const r=e.substring(0,n).trim(),i=e.substring(n+1).trim();t.append(r,i)}}return t}function Vt(e,t){const n=qt(e);if(n)throw t.forEach(((e,t)=>{n.metadata.append(t,e)})),n;if(!t.has(ue)&&!e.has(ue))throw new H("protocol error: missing status",$.Internal)}jt.runtime=Lt,jt.typeName="google.rpc.Status",jt.fields=Lt.util.newFieldList((()=>[{no:1,name:"code",kind:"scalar",T:5},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"details",kind:"message",T:Ft,repeated:!0}]));var Gt=function(e){return this instanceof Gt?(this.v=e,this):new Gt(e)};function Ht(e){var t;!function(){try{new Headers}catch(e){throw new Error("connect-web requires the fetch API. Are you running on an old version of Node.js? Node.js is not supported in Connect for Web - please stay tuned for Connect for Node.")}}();const n=null===(t=e.useBinaryFormat)||void 0===t||t;return{async unary(t,r,i,s,o,a,c){var l;const{serialize:u,parse:d}=Z(r,n,e.jsonOptions,e.binaryOptions);return s=void 0===s?e.defaultTimeoutMs:s<=0?void 0:s,await function(e){const t=ne(e.next,e.interceptors),[n,r,i]=oe(e);return t(Object.assign(Object.assign({},e.req),{message:ie(e.req.method.I,e.req.message),signal:n})).then((e=>(i(),e)),r)}({interceptors:e.interceptors,signal:i,timeoutMs:s,req:{stream:!1,service:t,method:r,url:ae(e.baseUrl,t,r),init:{method:"POST",credentials:null!==(l=e.credentials)&&void 0!==l?l:"same-origin",redirect:"error",mode:"cors"},header:he(n,s,o,!1),contextValues:null!=c?c:Q(),message:a},next:async n=>{var i;const s=null!==(i=e.fetch)&&void 0!==i?i:globalThis.fetch,o=await s(n.url,Object.assign(Object.assign({},n.init),{headers:n.header,signal:n.signal,body:le(0,u(n.message))})),{headerError:a}=Kt(o.status,o.headers);if(!o.body){if(void 0!==a)throw a;throw"missing response body"}const c=ce(o.body).getReader();let l,h;for(;;){const e=await c.read();if(e.done)break;const{flags:t,data:n}=e.value;if(!(1&~t))throw new H("protocol error: received unsupported compressed output",$.Internal);if(128!==t){if(void 0!==h)throw new H("extra message",$.Unimplemented);h=d(n)}else l=$t(n)}if(void 0===l){if(void 0!==a)throw a;throw new H("missing trailer",o.headers.has(ue)?$.Unimplemented:$.Unknown)}if(Vt(l,o.headers),void 0===h)throw new H("missing message",l.has(ue)?$.Unimplemented:$.Unknown);return{stream:!1,service:t,method:r,header:o.headers,message:h,trailer:l}}})},async stream(t,r,i,s,o,a,c){var l;const{serialize:u,parse:d}=Z(r,n,e.jsonOptions,e.binaryOptions);function h(e,t,n,r,i){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return",(function(e){return function(t){return Promise.resolve(t).then(e,l)}})),r[Symbol.asyncIterator]=function(){return this},r;function o(e,t){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))},t&&(r[e]=t(r[e])))}function a(e,t){try{!function(e){e.value instanceof Gt?Promise.resolve(e.value.v).then(c,l):u(s[0][2],e)}(i[e](t))}catch(e){u(s[0][3],e)}}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,(function*(){const s=ce(e).getReader();if(t){if(!(yield Gt(s.read())).done)throw"extra data for trailers-only";return yield Gt(void 0)}let o=!1;for(;;){const e=yield Gt(s.read());if(e.done)break;const{flags:t,data:i}=e.value;if(128&~t){if(o)throw"extra message";yield yield Gt(d(i))}else{if(o)throw"extra trailer";o=!0;const e=$t(i);Vt(e,r),e.forEach(((e,t)=>n.set(t,e)))}}if("throwIfAborted"in i&&i.throwIfAborted(),!o)throw"missing trailer"}))}async function p(e){if(r.kind!=q.ServerStreaming)throw"The fetch API does not support streaming request bodies";const t=await e[Symbol.asyncIterator]().next();if(1==t.done)throw"missing request message";return le(0,u(t.value))}return s=void 0===s?e.defaultTimeoutMs:s<=0?void 0:s,function(e){const t=ne(e.next,e.interceptors),[n,r,i]=oe(e),s=Object.assign(Object.assign({},e.req),{message:se(e.req.method.I,e.req.message),signal:n});let o=!1;return n.addEventListener("abort",(function(){var t,n;const r=e.req.message[Symbol.asyncIterator]();o||null===(t=r.throw)||void 0===t||t.call(r,this.reason).catch((()=>{})),null===(n=r.return)||void 0===n||n.call(r).catch((()=>{}))})),t(s).then((e=>Object.assign(Object.assign({},e),{message:{[Symbol.asyncIterator](){const t=e.message[Symbol.asyncIterator]();return{next:()=>t.next().then((e=>(1==e.done&&(o=!0,i()),e)),r)}}}})),r)}({interceptors:e.interceptors,signal:i,timeoutMs:s,req:{stream:!0,service:t,method:r,url:ae(e.baseUrl,t,r),init:{method:"POST",credentials:null!==(l=e.credentials)&&void 0!==l?l:"same-origin",redirect:"error",mode:"cors"},header:he(n,s,o,!1),contextValues:null!=c?c:Q(),message:a},next:async t=>{var n;const r=null!==(n=e.fetch)&&void 0!==n?n:globalThis.fetch,i=await r(t.url,Object.assign(Object.assign({},t.init),{headers:t.header,signal:t.signal,body:await p(t.message)})),{foundStatus:s,headerError:o}=Kt(i.status,i.headers);if(null!=o)throw o;if(!i.body)throw"missing response body";const a=new Headers;return Object.assign(Object.assign({},t),{header:i.headers,trailer:a,message:h(i.body,s,a,i.headers,t.signal)})}})}}}function Wt(e,t){if(!e)throw new Error(t)}function Jt(e){if("number"!=typeof e)throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw new Error("invalid int 32: "+e)}function Yt(e){if("number"!=typeof e)throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw new Error("invalid uint 32: "+e)}function zt(e){if("number"!=typeof e)throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw new Error("invalid float 32: "+e)}const Xt=Symbol("@bufbuild/protobuf/enum-type");function Qt(e,t,n,r){e[Xt]=Zt(t,n.map((t=>({no:t.no,name:t.name,localName:e[t.no]}))))}function Zt(e,t,n){const r=Object.create(null),i=Object.create(null),s=[];for(const e of t){const t=en(e);s.push(t),r[e.name]=t,i[e.no]=t}return{typeName:e,values:s,findName:e=>r[e],findNumber:e=>i[e]}}function en(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}class tn{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const n=this.getType().runtime.bin,r=n.makeReadOptions(t);return n.readMessage(this,r.readerFactory(e),e.byteLength,r),this}fromJson(e,t){const n=this.getType(),r=n.runtime.json,i=r.makeReadOptions(t);return r.readMessage(n,e,i,this),this}fromJsonString(e,t){let n;try{n=JSON.parse(e)}catch(e){throw new Error(`cannot decode ${this.getType().typeName} from JSON: ${e instanceof Error?e.message:String(e)}`)}return this.fromJson(n,t)}toBinary(e){const t=this.getType().runtime.bin,n=t.makeWriteOptions(e),r=n.writerFactory();return t.writeMessage(this,r,n),r.finish()}toJson(e){const t=this.getType().runtime.json,n=t.makeWriteOptions(e);return t.writeMessage(this,n)}toJsonString(e){var t;const n=this.toJson(e);return JSON.stringify(n,null,null!==(t=null==e?void 0:e.prettySpaces)&&void 0!==t?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function nn(){let e=0,t=0;for(let n=0;n<28;n+=7){let r=this.buf[this.pos++];if(e|=(127&r)<<n,!(128&r))return this.assertBounds(),[e,t]}let n=this.buf[this.pos++];if(e|=(15&n)<<28,t=(112&n)>>4,!(128&n))return this.assertBounds(),[e,t];for(let n=3;n<=31;n+=7){let r=this.buf[this.pos++];if(t|=(127&r)<<n,!(128&r))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function rn(e,t,n){for(let r=0;r<28;r+=7){const i=e>>>r,s=!(i>>>7==0&&0==t),o=255&(s?128|i:i);if(n.push(o),!s)return}const r=e>>>28&15|(7&t)<<4,i=!!(t>>3);if(n.push(255&(i?128|r:r)),i){for(let e=3;e<31;e+=7){const r=t>>>e,i=!(r>>>7==0),s=255&(i?128|r:r);if(n.push(s),!i)return}n.push(t>>>31&1)}}const sn=4294967296;function on(e){const t="-"===e[0];t&&(e=e.slice(1));const n=1e6;let r=0,i=0;function s(t,s){const o=Number(e.slice(t,s));i*=n,r=r*n+o,r>=sn&&(i+=r/sn|0,r%=sn)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),t?ln(r,i):cn(r,i)}function an(e,t){if(({lo:e,hi:t}=function(e,t){return{lo:e>>>0,hi:t>>>0}}(e,t)),t<=2097151)return String(sn*t+e);const n=16777215&(e>>>24|t<<8),r=t>>16&65535;let i=(16777215&e)+6777216*n+6710656*r,s=n+8147497*r,o=2*r;const a=1e7;return i>=a&&(s+=Math.floor(i/a),i%=a),s>=a&&(o+=Math.floor(s/a),s%=a),o.toString()+un(s)+un(i)}function cn(e,t){return{lo:0|e,hi:0|t}}function ln(e,t){return t=~t,e?e=1+~e:t+=1,cn(e,t)}const un=e=>{const t=String(e);return"0000000".slice(t.length)+t};function dn(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let n=0;n<9;n++)t.push(127&e|128),e>>=7;t.push(1)}}function hn(){let e=this.buf[this.pos++],t=127&e;if(!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<7,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<14,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<21,!(128&e))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(15&e)<<28;for(let t=5;128&e&&t<10;t++)e=this.buf[this.pos++];if(128&e)throw new Error("invalid varint");return this.assertBounds(),t>>>0}const pn=function(){const e=new DataView(new ArrayBuffer(8));if("function"==typeof BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64&&("object"!=typeof process||"object"!=typeof process.env||"1"!==process.env.BUF_BIGINT_DISABLE)){const t=BigInt("-9223372036854775808"),n=BigInt("9223372036854775807"),r=BigInt("0"),i=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(e){const r="bigint"==typeof e?e:BigInt(e);if(r>n||r<t)throw new Error(`int64 invalid: ${e}`);return r},uParse(e){const t="bigint"==typeof e?e:BigInt(e);if(t>i||t<r)throw new Error(`uint64 invalid: ${e}`);return t},enc(t){return e.setBigInt64(0,this.parse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},uEnc(t){return e.setBigInt64(0,this.uParse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},dec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigInt64(0,!0)),uDec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigUint64(0,!0))}}const t=e=>Wt(/^-?[0-9]+$/.test(e),`int64 invalid: ${e}`),n=e=>Wt(/^[0-9]+$/.test(e),`uint64 invalid: ${e}`);return{zero:"0",supported:!1,parse:e=>("string"!=typeof e&&(e=e.toString()),t(e),e),uParse:e=>("string"!=typeof e&&(e=e.toString()),n(e),e),enc:e=>("string"!=typeof e&&(e=e.toString()),t(e),on(e)),uEnc:e=>("string"!=typeof e&&(e=e.toString()),n(e),on(e)),dec:(e,t)=>function(e,t){let n=cn(e,t);const r=2147483648&n.hi;r&&(n=ln(n.lo,n.hi));const i=an(n.lo,n.hi);return r?"-"+i:i}(e,t),uDec:(e,t)=>an(e,t)}}();var gn,fn,mn;function vn(e,t,n){if(t===n)return!0;if(e==gn.BYTES){if(!(t instanceof Uint8Array&&n instanceof Uint8Array))return!1;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1;return!0}switch(e){case gn.UINT64:case gn.FIXED64:case gn.INT64:case gn.SFIXED64:case gn.SINT64:return t==n}return!1}function yn(e,t){switch(e){case gn.BOOL:return!1;case gn.UINT64:case gn.FIXED64:case gn.INT64:case gn.SFIXED64:case gn.SINT64:return 0==t?pn.zero:"0";case gn.DOUBLE:case gn.FLOAT:return 0;case gn.BYTES:return new Uint8Array(0);case gn.STRING:return"";default:return 0}}function _n(e,t){switch(e){case gn.BOOL:return!1===t;case gn.STRING:return""===t;case gn.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return 0==t}}!function(e){e[e.DOUBLE=1]="DOUBLE",e[e.FLOAT=2]="FLOAT",e[e.INT64=3]="INT64",e[e.UINT64=4]="UINT64",e[e.INT32=5]="INT32",e[e.FIXED64=6]="FIXED64",e[e.FIXED32=7]="FIXED32",e[e.BOOL=8]="BOOL",e[e.STRING=9]="STRING",e[e.BYTES=12]="BYTES",e[e.UINT32=13]="UINT32",e[e.SFIXED32=15]="SFIXED32",e[e.SFIXED64=16]="SFIXED64",e[e.SINT32=17]="SINT32",e[e.SINT64=18]="SINT64"}(gn||(gn={})),function(e){e[e.BIGINT=0]="BIGINT",e[e.STRING=1]="STRING"}(fn||(fn={})),function(e){e[e.Varint=0]="Varint",e[e.Bit64=1]="Bit64",e[e.LengthDelimited=2]="LengthDelimited",e[e.StartGroup=3]="StartGroup",e[e.EndGroup=4]="EndGroup",e[e.Bit32=5]="Bit32"}(mn||(mn={}));class bn{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e),n=0;for(let e=0;e<this.chunks.length;e++)t.set(this.chunks[e],n),n+=this.chunks[e].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Yt(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return Jt(e),dn(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){zt(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){Yt(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){Jt(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return Jt(e),dn(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),r=pn.enc(e);return n.setInt32(0,r.lo,!0),n.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),r=pn.uEnc(e);return n.setInt32(0,r.lo,!0),n.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=pn.enc(e);return rn(t.lo,t.hi,this.buf),this}sint64(e){let t=pn.enc(e),n=t.hi>>31;return rn(t.lo<<1^n,(t.hi<<1|t.lo>>>31)^n,this.buf),this}uint64(e){let t=pn.uEnc(e);return rn(t.lo,t.hi,this.buf),this}}class En{constructor(e,t){this.varint64=nn,this.uint32=hn,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,n=7&e;if(t<=0||n<0||n>5)throw new Error("illegal tag: field no "+t+" wire type "+n);return[t,n]}skip(e,t){let n=this.pos;switch(e){case mn.Varint:for(;128&this.buf[this.pos++];);break;case mn.Bit64:this.pos+=4;case mn.Bit32:this.pos+=4;break;case mn.LengthDelimited:let n=this.uint32();this.pos+=n;break;case mn.StartGroup:for(;;){const[e,n]=this.tag();if(n===mn.EndGroup){if(void 0!==t&&e!==t)throw new Error("invalid end group tag");break}this.skip(n,e)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(n,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return pn.dec(...this.varint64())}uint64(){return pn.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),n=-(1&e);return e=(e>>>1|(1&t)<<31)^n,t=t>>>1^n,pn.dec(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return pn.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return pn.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function An(e){const t=e.field.localName,n=Object.create(null);return n[t]=function(e){const t=e.field;if(t.repeated)return[];if(void 0!==t.default)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return yn(t.T,t.L);case"message":const e=t.T,n=new e;return e.fieldWrapper?e.fieldWrapper.unwrapField(n):n;case"map":throw"map fields are not allowed to be extensions"}}(e),[n,()=>n[t]]}let Sn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),wn=[];for(let e=0;e<Sn.length;e++)wn[Sn[e].charCodeAt(0)]=e;wn["-".charCodeAt(0)]=Sn.indexOf("+"),wn["_".charCodeAt(0)]=Sn.indexOf("/");const In={dec(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let n,r=new Uint8Array(t),i=0,s=0,o=0;for(let t=0;t<e.length;t++){if(n=wn[e.charCodeAt(t)],void 0===n)switch(e[t]){case"=":s=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(s){case 0:o=n,s=1;break;case 1:r[i++]=o<<2|(48&n)>>4,o=n,s=2;break;case 2:r[i++]=(15&o)<<4|(60&n)>>2,o=n,s=3;break;case 3:r[i++]=(3&o)<<6|n,s=0}}if(1==s)throw Error("invalid base64 string.");return r.subarray(0,i)},enc(e){let t,n="",r=0,i=0;for(let s=0;s<e.length;s++)switch(t=e[s],r){case 0:n+=Sn[t>>2],i=(3&t)<<4,r=1;break;case 1:n+=Sn[i|t>>4],i=(15&t)<<2,r=2;break;case 2:n+=Sn[i|t>>6],n+=Sn[63&t],r=0}return r&&(n+=Sn[i],n+="=",1==r&&(n+="=")),n}};function Tn(e,t,n){On(t,e);const r=t.runtime.bin.makeReadOptions(n),i=function(e,t){if(!t.repeated&&("enum"==t.kind||"scalar"==t.kind)){for(let n=e.length-1;n>=0;--n)if(e[n].no==t.no)return[e[n]];return[]}return e.filter((e=>e.no===t.no))}(e.getType().runtime.bin.listUnknownFields(e),t.field),[s,o]=An(t);for(const e of i)t.runtime.bin.readField(s,r.readerFactory(e.data),t.field,e.wireType,r);return o()}function kn(e,t,n,r){On(t,e);const i=t.runtime.bin.makeReadOptions(r),s=t.runtime.bin.makeWriteOptions(r);if(Rn(e,t)){const n=e.getType().runtime.bin.listUnknownFields(e).filter((e=>e.no!=t.field.no));e.getType().runtime.bin.discardUnknownFields(e);for(const t of n)e.getType().runtime.bin.onUnknownField(e,t.no,t.wireType,t.data)}const o=s.writerFactory();let a=t.field;a.opt||a.repeated||"enum"!=a.kind&&"scalar"!=a.kind||(a=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(a,n,o,s);const c=i.readerFactory(o.finish());for(;c.pos<c.len;){const[t,n]=c.tag(),r=c.skip(n,t);e.getType().runtime.bin.onUnknownField(e,t,n,r)}}function Rn(e,t){const n=e.getType();return t.extendee.typeName===n.typeName&&!!n.runtime.bin.listUnknownFields(e).find((e=>e.no==t.field.no))}function On(e,t){Wt(e.extendee.typeName==t.getType().typeName,`extension ${e.typeName} can only be applied to message ${e.extendee.typeName}`)}function Cn(e,t){const n=e.localName;if(e.repeated)return t[n].length>0;if(e.oneof)return t[e.oneof.localName].case===n;switch(e.kind){case"enum":case"scalar":return e.opt||e.req?void 0!==t[n]:"enum"==e.kind?t[n]!==e.T.values[0].no:!_n(e.T,t[n]);case"message":return void 0!==t[n];case"map":return Object.keys(t[n]).length>0}}function Pn(e,t){const n=e.localName,r=!e.opt&&!e.req;if(e.repeated)t[n]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[n]={};break;case"enum":t[n]=r?e.T.values[0].no:void 0;break;case"scalar":t[n]=r?yn(e.T,e.L):void 0;break;case"message":t[n]=void 0}}function Dn(e,t){if(null===e||"object"!=typeof e)return!1;if(!Object.getOwnPropertyNames(tn.prototype).every((t=>t in e&&"function"==typeof e[t])))return!1;const n=e.getType();return null!==n&&"function"==typeof n&&"typeName"in n&&"string"==typeof n.typeName&&(void 0===t||n.typeName==t.typeName)}function Nn(e,t){return Dn(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}gn.DOUBLE,gn.FLOAT,gn.INT64,gn.UINT64,gn.INT32,gn.UINT32,gn.BOOL,gn.STRING,gn.BYTES;const xn={ignoreUnknownFields:!1},Mn={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},Ln=Symbol(),Bn=Symbol();function Un(e){if(null===e)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":`"${e.split('"').join('\\"')}"`;default:return String(e)}}function Fn(e,t,n,r,i){let s=n.localName;if(n.repeated){if(Wt("map"!=n.kind),null===t)return;if(!Array.isArray(t))throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: ${Un(t)}`);const o=e[s];for(const s of t){if(null===s)throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: ${Un(s)}`);switch(n.kind){case"message":o.push(n.T.fromJson(s,r));break;case"enum":const t=Kn(n.T,s,r.ignoreUnknownFields,!0);t!==Bn&&o.push(t);break;case"scalar":try{o.push(qn(n.T,s,n.L,!0))}catch(e){let t=`cannot decode field ${i.typeName}.${n.name} from JSON: ${Un(s)}`;throw e instanceof Error&&e.message.length>0&&(t+=`: ${e.message}`),new Error(t)}}}}else if("map"==n.kind){if(null===t)return;if("object"!=typeof t||Array.isArray(t))throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: ${Un(t)}`);const o=e[s];for(const[e,s]of Object.entries(t)){if(null===s)throw new Error(`cannot decode field ${i.typeName}.${n.name} from JSON: map value null`);let a;try{a=jn(n.K,e)}catch(e){let r=`cannot decode map key for field ${i.typeName}.${n.name} from JSON: ${Un(t)}`;throw e instanceof Error&&e.message.length>0&&(r+=`: ${e.message}`),new Error(r)}switch(n.V.kind){case"message":o[a]=n.V.T.fromJson(s,r);break;case"enum":const e=Kn(n.V.T,s,r.ignoreUnknownFields,!0);e!==Bn&&(o[a]=e);break;case"scalar":try{o[a]=qn(n.V.T,s,fn.BIGINT,!0)}catch(e){let r=`cannot decode map value for field ${i.typeName}.${n.name} from JSON: ${Un(t)}`;throw e instanceof Error&&e.message.length>0&&(r+=`: ${e.message}`),new Error(r)}}}}else switch(n.oneof&&(e=e[n.oneof.localName]={case:s},s="value"),n.kind){case"message":const o=n.T;if(null===t&&"google.protobuf.Value"!=o.typeName)return;let a=e[s];Dn(a)?a.fromJson(t,r):(e[s]=a=o.fromJson(t,r),o.fieldWrapper&&!n.oneof&&(e[s]=o.fieldWrapper.unwrapField(a)));break;case"enum":const c=Kn(n.T,t,r.ignoreUnknownFields,!1);switch(c){case Ln:Pn(n,e);break;case Bn:break;default:e[s]=c}break;case"scalar":try{const r=qn(n.T,t,n.L,!1);r===Ln?Pn(n,e):e[s]=r}catch(e){let r=`cannot decode field ${i.typeName}.${n.name} from JSON: ${Un(t)}`;throw e instanceof Error&&e.message.length>0&&(r+=`: ${e.message}`),new Error(r)}}}function jn(e,t){if(e===gn.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1}return qn(e,t,fn.BIGINT,!0).toString()}function qn(e,t,n,r){if(null===t)return r?yn(e,n):Ln;switch(e){case gn.DOUBLE:case gn.FLOAT:if("NaN"===t)return Number.NaN;if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if(""===t)break;if("string"==typeof t&&t.trim().length!==t.length)break;if("string"!=typeof t&&"number"!=typeof t)break;const r=Number(t);if(Number.isNaN(r))break;if(!Number.isFinite(r))break;return e==gn.FLOAT&&zt(r),r;case gn.INT32:case gn.FIXED32:case gn.SFIXED32:case gn.SINT32:case gn.UINT32:let i;if("number"==typeof t?i=t:"string"==typeof t&&t.length>0&&t.trim().length===t.length&&(i=Number(t)),void 0===i)break;return e==gn.UINT32||e==gn.FIXED32?Yt(i):Jt(i),i;case gn.INT64:case gn.SFIXED64:case gn.SINT64:if("number"!=typeof t&&"string"!=typeof t)break;const s=pn.parse(t);return n?s.toString():s;case gn.FIXED64:case gn.UINT64:if("number"!=typeof t&&"string"!=typeof t)break;const o=pn.uParse(t);return n?o.toString():o;case gn.BOOL:if("boolean"!=typeof t)break;return t;case gn.STRING:if("string"!=typeof t)break;try{encodeURIComponent(t)}catch(e){throw new Error("invalid UTF8")}return t;case gn.BYTES:if(""===t)return new Uint8Array(0);if("string"!=typeof t)break;return In.dec(t)}throw new Error}function Kn(e,t,n,r){if(null===t)return"google.protobuf.NullValue"==e.typeName?0:r?e.values[0].no:Ln;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const r=e.findName(t);if(void 0!==r)return r.no;if(n)return Bn}throw new Error(`cannot decode enum ${e.typeName} from JSON: ${Un(t)}`)}function $n(e){return!(!e.repeated&&"map"!=e.kind&&(e.oneof||"message"==e.kind||e.opt||e.req))}function Vn(e,t,n){if("map"==e.kind){Wt("object"==typeof t&&null!=t);const r={},i=Object.entries(t);switch(e.V.kind){case"scalar":for(const[t,n]of i)r[t.toString()]=Hn(e.V.T,n);break;case"message":for(const[e,t]of i)r[e.toString()]=t.toJson(n);break;case"enum":const t=e.V.T;for(const[e,s]of i)r[e.toString()]=Gn(t,s,n.enumAsInteger)}return n.emitDefaultValues||i.length>0?r:void 0}if(e.repeated){Wt(Array.isArray(t));const r=[];switch(e.kind){case"scalar":for(let n=0;n<t.length;n++)r.push(Hn(e.T,t[n]));break;case"enum":for(let i=0;i<t.length;i++)r.push(Gn(e.T,t[i],n.enumAsInteger));break;case"message":for(let e=0;e<t.length;e++)r.push(t[e].toJson(n))}return n.emitDefaultValues||r.length>0?r:void 0}switch(e.kind){case"scalar":return Hn(e.T,t);case"enum":return Gn(e.T,t,n.enumAsInteger);case"message":return Nn(e.T,t).toJson(n)}}function Gn(e,t,n){var r;if(Wt("number"==typeof t),"google.protobuf.NullValue"==e.typeName)return null;if(n)return t;const i=e.findNumber(t);return null!==(r=null==i?void 0:i.name)&&void 0!==r?r:t}function Hn(e,t){switch(e){case gn.INT32:case gn.SFIXED32:case gn.SINT32:case gn.FIXED32:case gn.UINT32:return Wt("number"==typeof t),t;case gn.FLOAT:case gn.DOUBLE:return Wt("number"==typeof t),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case gn.STRING:return Wt("string"==typeof t),t;case gn.BOOL:return Wt("boolean"==typeof t),t;case gn.UINT64:case gn.FIXED64:case gn.INT64:case gn.SFIXED64:case gn.SINT64:return Wt("bigint"==typeof t||"string"==typeof t||"number"==typeof t),t.toString();case gn.BYTES:return Wt(t instanceof Uint8Array),In.enc(t)}}const Wn=Symbol("@bufbuild/protobuf/unknown-fields"),Jn={readUnknownFields:!0,readerFactory:e=>new En(e)},Yn={writeUnknownFields:!0,writerFactory:()=>new bn};function zn(e,t,n,r,i){let{repeated:s,localName:o}=n;switch(n.oneof&&((e=e[n.oneof.localName]).case!=o&&delete e.value,e.case=o,o="value"),n.kind){case"scalar":case"enum":const a="enum"==n.kind?gn.INT32:n.T;let c=Zn;if("scalar"==n.kind&&n.L>0&&(c=Qn),s){let n=e[o];if(r==mn.LengthDelimited&&a!=gn.STRING&&a!=gn.BYTES){let e=t.uint32()+t.pos;for(;t.pos<e;)n.push(c(t,a))}else n.push(c(t,a))}else e[o]=c(t,a);break;case"message":const l=n.T;s?e[o].push(Xn(t,new l,i,n)):Dn(e[o])?Xn(t,e[o],i,n):(e[o]=Xn(t,new l,i,n),!l.fieldWrapper||n.oneof||n.repeated||(e[o]=l.fieldWrapper.unwrapField(e[o])));break;case"map":let[u,d]=function(e,t,n){const r=t.uint32(),i=t.pos+r;let s,o;for(;t.pos<i;){const[r]=t.tag();switch(r){case 1:s=Zn(t,e.K);break;case 2:switch(e.V.kind){case"scalar":o=Zn(t,e.V.T);break;case"enum":o=t.int32();break;case"message":o=Xn(t,new e.V.T,n,void 0)}}}if(void 0===s&&(s=yn(e.K,fn.BIGINT)),"string"!=typeof s&&"number"!=typeof s&&(s=s.toString()),void 0===o)switch(e.V.kind){case"scalar":o=yn(e.V.T,fn.BIGINT);break;case"enum":o=e.V.T.values[0].no;break;case"message":o=new e.V.T}return[s,o]}(n,t,i);e[o][u]=d}}function Xn(e,t,n,r){const i=t.getType().runtime.bin,s=null==r?void 0:r.delimited;return i.readMessage(t,e,s?r.no:e.uint32(),n,s),t}function Qn(e,t){const n=Zn(e,t);return"bigint"==typeof n?n.toString():n}function Zn(e,t){switch(t){case gn.STRING:return e.string();case gn.BOOL:return e.bool();case gn.DOUBLE:return e.double();case gn.FLOAT:return e.float();case gn.INT32:return e.int32();case gn.INT64:return e.int64();case gn.UINT64:return e.uint64();case gn.FIXED64:return e.fixed64();case gn.BYTES:return e.bytes();case gn.FIXED32:return e.fixed32();case gn.SFIXED32:return e.sfixed32();case gn.SFIXED64:return e.sfixed64();case gn.SINT64:return e.sint64();case gn.UINT32:return e.uint32();case gn.SINT32:return e.sint32()}}function er(e,t,n,r){Wt(void 0!==t);const i=e.repeated;switch(e.kind){case"scalar":case"enum":let s="enum"==e.kind?gn.INT32:e.T;if(i)if(Wt(Array.isArray(t)),e.packed)!function(e,t,n,r){if(!r.length)return;e.tag(n,mn.LengthDelimited).fork();let[,i]=ir(t);for(let t=0;t<r.length;t++)e[i](r[t]);e.join()}(n,s,e.no,t);else for(const r of t)rr(n,s,e.no,r);else rr(n,s,e.no,t);break;case"message":if(i){Wt(Array.isArray(t));for(const i of t)nr(n,r,e,i)}else nr(n,r,e,t);break;case"map":Wt("object"==typeof t&&null!=t);for(const[i,s]of Object.entries(t))tr(n,r,e,i,s)}}function tr(e,t,n,r,i){e.tag(n.no,mn.LengthDelimited),e.fork();let s=r;switch(n.K){case gn.INT32:case gn.FIXED32:case gn.UINT32:case gn.SFIXED32:case gn.SINT32:s=Number.parseInt(r);break;case gn.BOOL:Wt("true"==r||"false"==r),s="true"==r}switch(rr(e,n.K,1,s),n.V.kind){case"scalar":rr(e,n.V.T,2,i);break;case"enum":rr(e,gn.INT32,2,i);break;case"message":Wt(void 0!==i),e.tag(2,mn.LengthDelimited).bytes(i.toBinary(t))}e.join()}function nr(e,t,n,r){const i=Nn(n.T,r);n.delimited?e.tag(n.no,mn.StartGroup).raw(i.toBinary(t)).tag(n.no,mn.EndGroup):e.tag(n.no,mn.LengthDelimited).bytes(i.toBinary(t))}function rr(e,t,n,r){Wt(void 0!==r);let[i,s]=ir(t);e.tag(n,i)[s](r)}function ir(e){let t=mn.Varint;switch(e){case gn.BYTES:case gn.STRING:t=mn.LengthDelimited;break;case gn.DOUBLE:case gn.FIXED64:case gn.SFIXED64:t=mn.Bit64;break;case gn.FIXED32:case gn.SFIXED32:case gn.FLOAT:t=mn.Bit32}return[t,gn[e].toLowerCase()]}function sr(e){if(void 0===e)return e;if(Dn(e))return e.clone();if(e instanceof Uint8Array){const t=new Uint8Array(e.byteLength);return t.set(e),t}return e}function or(e){return e instanceof Uint8Array?e:new Uint8Array(e)}class ar{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const e={};for(const t of this.list())e[t.jsonName]=e[t.name]=t;this.jsonNames=e}return this.jsonNames[e]}find(e){if(!this.numbers){const e={};for(const t of this.list())e[t.no]=t;this.numbers=e}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort(((e,t)=>e.no-t.no))),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const n of this.list())n.oneof?n.oneof!==t&&(t=n.oneof,e.push(t)):e.push(n)}return this.members}}function cr(e,t){const n=ur(e);return t?n:fr(gr(n))}const lr=ur;function ur(e){let t=!1;const n=[];for(let r=0;r<e.length;r++){let i=e.charAt(r);switch(i){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":n.push(i),t=!1;break;default:t&&(t=!1,i=i.toUpperCase()),n.push(i)}}return n.join("")}const dr=new Set(["constructor","toString","toJSON","valueOf"]),hr=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),pr=e=>`${e}$`,gr=e=>hr.has(e)?pr(e):e,fr=e=>dr.has(e)?pr(e):e;class mr{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=cr(e,!1)}addField(e){Wt(e.oneof===this,`field ${e.name} not one of ${this.name}`),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let e=0;e<this.fields.length;e++)this._lookup[this.fields[e].localName]=this.fields[e]}return this._lookup[e]}}const vr=(yr=e=>new ar(e,(e=>function(e){var t,n,r,i,s,o;const a=[];let c;for(const l of"function"==typeof e?e():e){const e=l;if(e.localName=cr(l.name,void 0!==l.oneof),e.jsonName=null!==(t=l.jsonName)&&void 0!==t?t:lr(l.name),e.repeated=null!==(n=l.repeated)&&void 0!==n&&n,"scalar"==l.kind&&(e.L=null!==(r=l.L)&&void 0!==r?r:fn.BIGINT),e.delimited=null!==(i=l.delimited)&&void 0!==i&&i,e.req=null!==(s=l.req)&&void 0!==s&&s,e.opt=null!==(o=l.opt)&&void 0!==o&&o,void 0===l.packed&&(e.packed="enum"==l.kind||"scalar"==l.kind&&l.T!=gn.BYTES&&l.T!=gn.STRING),void 0!==l.oneof){const t="string"==typeof l.oneof?l.oneof:l.oneof.name;c&&c.name==t||(c=new mr(t)),e.oneof=c,c.addField(e)}a.push(e)}return a}(e))),_r=e=>{for(const t of e.getType().fields.byMember()){if(t.opt)continue;const n=t.localName,r=e;if(t.repeated)r[n]=[];else switch(t.kind){case"oneof":r[n]={case:void 0};break;case"enum":r[n]=0;break;case"map":r[n]={};break;case"scalar":r[n]=yn(t.T,t.L)}}},{syntax:"proto3",json:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},xn),e):xn},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},Mn),e):Mn},readMessage(e,t,n,r){if(null==t||Array.isArray(t)||"object"!=typeof t)throw new Error(`cannot decode message ${e.typeName} from JSON: ${Un(t)}`);r=null!=r?r:new e;const i=new Map,s=n.typeRegistry;for(const[o,a]of Object.entries(t)){const t=e.fields.findJsonName(o);if(t){if(t.oneof){if(null===a&&"scalar"==t.kind)continue;const n=i.get(t.oneof);if(void 0!==n)throw new Error(`cannot decode message ${e.typeName} from JSON: multiple keys for oneof "${t.oneof.name}" present: "${n}", "${o}"`);i.set(t.oneof,o)}Fn(r,a,t,n,e)}else{let t=!1;if((null==s?void 0:s.findExtension)&&o.startsWith("[")&&o.endsWith("]")){const i=s.findExtension(o.substring(1,o.length-1));if(i&&i.extendee.typeName==e.typeName){t=!0;const[e,s]=An(i);Fn(e,a,i.field,n,i),kn(r,i,s(),n)}}if(!t&&!n.ignoreUnknownFields)throw new Error(`cannot decode message ${e.typeName} from JSON: key "${o}" is unknown`)}}return r},writeMessage(e,t){const n=e.getType(),r={};let i;try{for(i of n.fields.byNumber()){if(!Cn(i,e)){if(i.req)throw"required field not set";if(!t.emitDefaultValues)continue;if(!$n(i))continue}const n=Vn(i,i.oneof?e[i.oneof.localName].value:e[i.localName],t);void 0!==n&&(r[t.useProtoFieldName?i.name:i.jsonName]=n)}const s=t.typeRegistry;if(null==s?void 0:s.findExtensionFor)for(const i of n.runtime.bin.listUnknownFields(e)){const o=s.findExtensionFor(n.typeName,i.no);if(o&&Rn(e,o)){const n=Tn(e,o,t),i=Vn(o.field,n,t);void 0!==i&&(r[o.field.jsonName]=i)}}}catch(e){const t=i?`cannot encode field ${n.typeName}.${i.name} to JSON`:`cannot encode message ${n.typeName} to JSON`,r=e instanceof Error?e.message:String(e);throw new Error(t+(r.length>0?`: ${r}`:""))}return r},readScalar:(e,t,n)=>qn(e,t,null!=n?n:fn.BIGINT,!0),writeScalar(e,t,n){if(void 0!==t)return n||_n(e,t)?Hn(e,t):void 0},debug:Un},bin:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},Jn),e):Jn},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},Yn),e):Yn},listUnknownFields(e){var t;return null!==(t=e[Wn])&&void 0!==t?t:[]},discardUnknownFields(e){delete e[Wn]},writeUnknownFields(e,t){const n=e[Wn];if(n)for(const e of n)t.tag(e.no,e.wireType).raw(e.data)},onUnknownField(e,t,n,r){const i=e;Array.isArray(i[Wn])||(i[Wn]=[]),i[Wn].push({no:t,wireType:n,data:r})},readMessage(e,t,n,r,i){const s=e.getType(),o=i?t.len:t.pos+n;let a,c;for(;t.pos<o&&([a,c]=t.tag(),!0!==i||c!=mn.EndGroup);){const n=s.fields.find(a);if(n)zn(e,t,n,c,r);else{const n=t.skip(c,a);r.readUnknownFields&&this.onUnknownField(e,a,c,n)}}if(i&&(c!=mn.EndGroup||a!==n))throw new Error("invalid end group tag")},readField:zn,writeMessage(e,t,n){const r=e.getType();for(const i of r.fields.byNumber())if(Cn(i,e))er(i,i.oneof?e[i.oneof.localName].value:e[i.localName],t,n);else if(i.req)throw new Error(`cannot encode field ${r.typeName}.${i.name} to binary: required field not set`);return n.writeUnknownFields&&this.writeUnknownFields(e,t),t},writeField(e,t,n,r){void 0!==t&&er(e,t,n,r)}},util:Object.assign(Object.assign({},{setEnumType:Qt,initPartial(e,t){if(void 0===e)return;const n=t.getType();for(const r of n.fields.byMember()){const n=r.localName,i=t,s=e;if(null!=s[n])switch(r.kind){case"oneof":const e=s[n].case;if(void 0===e)continue;const t=r.findField(e);let o=s[n].value;t&&"message"==t.kind&&!Dn(o,t.T)?o=new t.T(o):t&&"scalar"===t.kind&&t.T===gn.BYTES&&(o=or(o)),i[n]={case:e,value:o};break;case"scalar":case"enum":let a=s[n];r.T===gn.BYTES&&(a=r.repeated?a.map(or):or(a)),i[n]=a;break;case"map":switch(r.V.kind){case"scalar":case"enum":if(r.V.T===gn.BYTES)for(const[e,t]of Object.entries(s[n]))i[n][e]=or(t);else Object.assign(i[n],s[n]);break;case"message":const e=r.V.T;for(const t of Object.keys(s[n])){let r=s[n][t];e.fieldWrapper||(r=new e(r)),i[n][t]=r}}break;case"message":const c=r.T;if(r.repeated)i[n]=s[n].map((e=>Dn(e,c)?e:new c(e)));else{const e=s[n];c.fieldWrapper?"google.protobuf.BytesValue"===c.typeName?i[n]=or(e):i[n]=e:i[n]=Dn(e,c)?e:new c(e)}}}},equals:(e,t,n)=>t===n||!(!t||!n)&&e.fields.byMember().every((e=>{const r=t[e.localName],i=n[e.localName];if(e.repeated){if(r.length!==i.length)return!1;switch(e.kind){case"message":return r.every(((t,n)=>e.T.equals(t,i[n])));case"scalar":return r.every(((t,n)=>vn(e.T,t,i[n])));case"enum":return r.every(((e,t)=>vn(gn.INT32,e,i[t])))}throw new Error(`repeated cannot contain ${e.kind}`)}switch(e.kind){case"message":return e.T.equals(r,i);case"enum":return vn(gn.INT32,r,i);case"scalar":return vn(e.T,r,i);case"oneof":if(r.case!==i.case)return!1;const t=e.findField(r.case);if(void 0===t)return!0;switch(t.kind){case"message":return t.T.equals(r.value,i.value);case"enum":return vn(gn.INT32,r.value,i.value);case"scalar":return vn(t.T,r.value,i.value)}throw new Error(`oneof cannot contain ${t.kind}`);case"map":const n=Object.keys(r).concat(Object.keys(i));switch(e.V.kind){case"message":const t=e.V.T;return n.every((e=>t.equals(r[e],i[e])));case"enum":return n.every((e=>vn(gn.INT32,r[e],i[e])));case"scalar":const s=e.V.T;return n.every((e=>vn(s,r[e],i[e])))}}})),clone(e){const t=e.getType(),n=new t,r=n;for(const n of t.fields.byMember()){const t=e[n.localName];let i;if(n.repeated)i=t.map(sr);else if("map"==n.kind){i=r[n.localName];for(const[e,n]of Object.entries(t))i[e]=sr(n)}else i="oneof"==n.kind?n.findField(t.case)?{case:t.case,value:sr(t.value)}:{case:void 0}:sr(t);r[n.localName]=i}for(const n of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(r,n.no,n.wireType,n.data);return n}}),{newFieldList:yr,initFields:_r}),makeMessageType(e,t,n){return function(e,t,n,r){var i;const s=null!==(i=null==r?void 0:r.localName)&&void 0!==i?i:t.substring(t.lastIndexOf(".")+1),o={[s]:function(t){e.util.initFields(this),e.util.initPartial(t,this)}}[s];return Object.setPrototypeOf(o.prototype,new tn),Object.assign(o,{runtime:e,typeName:t,fields:e.util.newFieldList(n),fromBinary:(e,t)=>(new o).fromBinary(e,t),fromJson:(e,t)=>(new o).fromJson(e,t),fromJsonString:(e,t)=>(new o).fromJsonString(e,t),equals:(t,n)=>e.util.equals(o,t,n)}),o}(this,e,t,n)},makeEnum:function(e,t,n){const r={};for(const e of t){const t=en(e);r[t.localName]=t.no,r[t.no]=t.localName}return Qt(r,e,t),r},makeEnumType:Zt,getEnumType:function(e){const t=e[Xt];return Wt(t,"missing enum type on enum object"),t},makeExtension(e,t,n){return function(e,t,n,r){let i;return{typeName:t,extendee:n,get field(){if(!i){const n="function"==typeof r?r():r;n.name=t.split(".").pop(),n.jsonName=`[${t}]`,i=e.util.newFieldList([n]).list()[0]}return i},runtime:e}}(this,e,t,n)}});var yr,_r,br,Er;!function(e){e[e.Unary=0]="Unary",e[e.ServerStreaming=1]="ServerStreaming",e[e.ClientStreaming=2]="ClientStreaming",e[e.BiDiStreaming=3]="BiDiStreaming"}(br||(br={})),function(e){e[e.NoSideEffects=1]="NoSideEffects",e[e.Idempotent=2]="Idempotent"}(Er||(Er={}));class Ar extends tn{roomId="";message="";matrixClientType=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="chat.SendMessageRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"matrixClientType",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Ar).fromBinary(e,t)}static fromJson(e,t){return(new Ar).fromJson(e,t)}static fromJsonString(e,t){return(new Ar).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ar,e,t)}}class Sr extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="chat.SendMessageResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Sr).fromBinary(e,t)}static fromJson(e,t){return(new Sr).fromJson(e,t)}static fromJsonString(e,t){return(new Sr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Sr,e,t)}}class wr extends tn{eventId="";roomId="";internalMetadata="";json="";formatVersion=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="chat.Chat";static fields=vr.util.newFieldList((()=>[{no:1,name:"eventId",kind:"scalar",T:9},{no:2,name:"roomId",kind:"scalar",T:9},{no:3,name:"internalMetadata",kind:"scalar",T:9},{no:4,name:"json",kind:"scalar",T:9},{no:5,name:"formatVersion",kind:"scalar",T:5}]));static fromBinary(e,t){return(new wr).fromBinary(e,t)}static fromJson(e,t){return(new wr).fromJson(e,t)}static fromJsonString(e,t){return(new wr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(wr,e,t)}}Object.freeze({__proto__:null,Chat:wr,SendMessageRequest:Ar,SendMessageResponse:Sr});const Ir={typeName:"chat.ChatService",methods:{sendMessage:{name:"sendMessage",I:Ar,O:Sr,kind:br.Unary}}};var Tr,kr,Rr,Or;Object.freeze({__proto__:null,ChatService:Ir}),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.VALID=1]="VALID",e[e.INVALID=2]="INVALID",e[e.INCORRECT=3]="INCORRECT",e[e.PENDING=4]="PENDING",e[e.UNDERAGE=5]="UNDERAGE"}(Tr||(Tr={})),vr.util.setEnumType(Tr,"common.IDStatus",[{no:0,name:"DEFAULT"},{no:1,name:"VALID"},{no:2,name:"INVALID"},{no:3,name:"INCORRECT"},{no:4,name:"PENDING"},{no:5,name:"UNDERAGE"}]),function(e){e[e.STATUS_UNSPECIFIED=0]="STATUS_UNSPECIFIED",e[e.STATUS_SUCCESS=200]="STATUS_SUCCESS",e[e.STATUS_UNAUTHORIZED=401]="STATUS_UNAUTHORIZED",e[e.STATUS_FORBIDDEN=403]="STATUS_FORBIDDEN",e[e.STATUS_NOT_FOUND=404]="STATUS_NOT_FOUND",e[e.STATUS_INTERNAL_ERROR=500]="STATUS_INTERNAL_ERROR",e[e.STATUS_ILLEGAL_ARGS=550]="STATUS_ILLEGAL_ARGS",e[e.STATUS_ALREADY_EXISTS=409]="STATUS_ALREADY_EXISTS",e[e.STATUS_AML_TRIGGERED=601]="STATUS_AML_TRIGGERED",e[e.STATUS_AML_NOT_TRIGGERED=602]="STATUS_AML_NOT_TRIGGERED",e[e.DUPLICATE_ID=1201]="DUPLICATE_ID",e[e.HASH_CODE_ERROR=1202]="HASH_CODE_ERROR",e[e.INVALID_DATE_RANGE=1203]="INVALID_DATE_RANGE",e[e.INVALID_OR_MISSING_PARAM=1204]="INVALID_OR_MISSING_PARAM",e[e.INVALID_DATE_FORMAT=1205]="INVALID_DATE_FORMAT",e[e.COMMON_ERROR=1400]="COMMON_ERROR",e[e.DB_ERROR=1500]="DB_ERROR",e[e.INVALID_API_USER=1420]="INVALID_API_USER",e[e.INVALID_SIGNATURE=1484]="INVALID_SIGNATURE",e[e.FAILED_LINK_FACEBOOK=1483]="FAILED_LINK_FACEBOOK",e[e.INVALID_USER_PASSWORD=1401]="INVALID_USER_PASSWORD",e[e.INVALID_CAPTCHA=1402]="INVALID_CAPTCHA",e[e.GENERATE_VALIDATION_CODE_ERROR=1403]="GENERATE_VALIDATION_CODE_ERROR",e[e.USERNAME_ALREADY_EXIST=1404]="USERNAME_ALREADY_EXIST",e[e.INVALID_PARAM=1405]="INVALID_PARAM",e[e.INVALID_PHONE_NUMBER=1406]="INVALID_PHONE_NUMBER",e[e.INVALID_OLD_PASSWORD=1407]="INVALID_OLD_PASSWORD",e[e.DATABASE_CONNECTION_FAILURE=1408]="DATABASE_CONNECTION_FAILURE",e[e.PERMISSION_DENIED=1409]="PERMISSION_DENIED",e[e.SEARCH_OUT_OF_RANGE=1410]="SEARCH_OUT_OF_RANGE",e[e.SESSION_EXPIRED=1411]="SESSION_EXPIRED",e[e.INVALID_PROPOSAL=1412]="INVALID_PROPOSAL",e[e.PAYMENT_NOT_AVAILABLE=1413]="PAYMENT_NOT_AVAILABLE",e[e.PLAYER_NOT_ENOUGH_CREDIT=1415]="PLAYER_NOT_ENOUGH_CREDIT",e[e.PLAYER_CREDIT_BALANCE_NOT_ENOUGH=1416]="PLAYER_CREDIT_BALANCE_NOT_ENOUGH",e[e.PLAYER_INVALID_PAYMENT_INFO=1417]="PLAYER_INVALID_PAYMENT_INFO",e[e.PLAYER_NO_PERMISSION=1418]="PLAYER_NO_PERMISSION",e[e.PLAYER_PENDING_PROPOSAL=1419]="PLAYER_PENDING_PROPOSAL",e[e.PLAYER_TOP_UP_FAIL=1426]="PLAYER_TOP_UP_FAIL",e[e.REWARD_EVENT_INVALID=1421]="REWARD_EVENT_INVALID",e[e.PLAYER_NOT_VALID_FOR_REWARD=1422]="PLAYER_NOT_VALID_FOR_REWARD",e[e.PLAYER_APPLY_REWARD_FAIL=1423]="PLAYER_APPLY_REWARD_FAIL",e[e.PLAYER_HAS_REWARD_TASK=1424]="PLAYER_HAS_REWARD_TASK",e[e.CP_NOT_AVAILABLE=1425]="CP_NOT_AVAILABLE",e[e.PLAYER_REWARD_INFO=1427]="PLAYER_REWARD_INFO",e[e.PLAYER_TRANSFER_OUT_ERROR=1428]="PLAYER_TRANSFER_OUT_ERROR",e[e.PLAYER_TRANSFER_IN_ERROR=1429]="PLAYER_TRANSFER_IN_ERROR",e[e.PLAYER_IS_FORBIDDEN=1430]="PLAYER_IS_FORBIDDEN",e[e.DATA_INVALID=1431]="DATA_INVALID",e[e.PLAYER_NAME_INVALID=1432]="PLAYER_NAME_INVALID",e[e.PARTNER_NAME_INVALID=1433]="PARTNER_NAME_INVALID",e[e.VALIDATION_CODE_INVALID=1434]="VALIDATION_CODE_INVALID",e[e.VALIDATION_CODE_EXPIRED=1435]="VALIDATION_CODE_EXPIRED",e[e.PLAYER_PENDING_REWARD_PROPOSAL=1436]="PLAYER_PENDING_REWARD_PROPOSAL",e[e.INVALID_REFERRAL=1437]="INVALID_REFERRAL",e[e.INVALID_PLATFORM=1438]="INVALID_PLATFORM",e[e.FAILED_UPDATE_REWARD_TASK=1439]="FAILED_UPDATE_REWARD_TASK",e[e.NO_USER_FOUND=1440]="NO_USER_FOUND",e[e.USERNAME_LENGTH_INCORRECT=1441]="USERNAME_LENGTH_INCORRECT",e[e.PLAYER_REALNAME_EXIST=1442]="PLAYER_REALNAME_EXIST",e[e.PLAYER_REALNAME_MUST_BE_CHINESE=1443]="PLAYER_REALNAME_MUST_BE_CHINESE",e[e.FAILED_PROMO_CODE_CONDITION=1444]="FAILED_PROMO_CODE_CONDITION",e[e.FAILED_LIMITED_OFFER_CONDITION=1445]="FAILED_LIMITED_OFFER_CONDITION",e[e.NO_PROMO_CODE_MATCH=1446]="NO_PROMO_CODE_MATCH",e[e.TEST_GAME_REQUIRE_LOGIN=1447]="TEST_GAME_REQUIRE_LOGIN",e[e.PLAYER_IS_CANCELLED=1448]="PLAYER_IS_CANCELLED",e[e.PLAYER_NOT_MINTOPUP=1450]="PLAYER_NOT_MINTOPUP",e[e.NO_REACH_TOPUP=1451]="NO_REACH_TOPUP",e[e.NO_REACH_CONSUMPTION=1452]="NO_REACH_CONSUMPTION",e[e.NO_REACH_TOPUP_CONSUMPTION=1453]="NO_REACH_TOPUP_CONSUMPTION",e[e.PHONENUMBER_ALREADY_EXIST=1454]="PHONENUMBER_ALREADY_EXIST",e[e.ABNORMAL_CREDIT_DEDUCTION=1455]="ABNORMAL_CREDIT_DEDUCTION",e[e.PLAYER_CONVERT_REWARD_POINTS_FAIL=1456]="PLAYER_CONVERT_REWARD_POINTS_FAIL",e[e.VALIDATION_CODE_EXCEED_ATTEMPT=1457]="VALIDATION_CODE_EXCEED_ATTEMPT",e[e.PLAYER_NOT_ENOUGH_REWARD_POINTS=1458]="PLAYER_NOT_ENOUGH_REWARD_POINTS",e[e.GROUP_REWARD_NOT_ALLOWED=1459]="GROUP_REWARD_NOT_ALLOWED",e[e.SMS_RETRY_FAILS_EXCEED=1460]="SMS_RETRY_FAILS_EXCEED",e[e.NOT_ENOUGH_CONSUMPTION=1461]="NOT_ENOUGH_CONSUMPTION",e[e.REALNAME_ALREADY_EXIST=1462]="REALNAME_ALREADY_EXIST",e[e.REWARD_POINTS_CONVERT_FAIL=1465]="REWARD_POINTS_CONVERT_FAIL",e[e.CONCURRENT_DETECTED=1466]="CONCURRENT_DETECTED",e[e.PROMO_METHOD_NOT_FOUND=1467]="PROMO_METHOD_NOT_FOUND",e[e.CS_OFFICER_NOT_FOUND=1468]="CS_OFFICER_NOT_FOUND",e[e.REMARK_NOT_FOUND=1469]="REMARK_NOT_FOUND",e[e.EXTERNAL_API_FAILURE=1470]="EXTERNAL_API_FAILURE",e[e.INVALID_OLD_PHONENUMBER=1471]="INVALID_OLD_PHONENUMBER",e[e.OLD_PHONE_NUMBER_REQUIRED=1472]="OLD_PHONE_NUMBER_REQUIRED",e[e.SPENDING_TIMES_REQUIRED=1473]="SPENDING_TIMES_REQUIRED",e[e.BLACKLIST_IP=1474]="BLACKLIST_IP",e[e.CONFIRMATION_TO_COMPLETE_ACTIVITY=1475]="CONFIRMATION_TO_COMPLETE_ACTIVITY",e[e.INTERVAL_REWARD_CAPPED=1476]="INTERVAL_REWARD_CAPPED",e[e.DEVICE_ID_ERROR=1477]="DEVICE_ID_ERROR",e[e.NO_BIRTHDAY=1478]="NO_BIRTHDAY",e[e.PARTNER_NOT_FOUND=1479]="PARTNER_NOT_FOUND",e[e.PARTNER_RATE_INAPPROPRIATE=1480]="PARTNER_RATE_INAPPROPRIATE",e[e.DISABLE_PLATFORM_LOGIN=1482]="DISABLE_PLATFORM_LOGIN",e[e.LOGIN_CONDITION_NOT_MATCHED=1487]="LOGIN_CONDITION_NOT_MATCHED",e[e.INVALID_GLIFE_ACCOUNT=1489]="INVALID_GLIFE_ACCOUNT",e[e.GLIFE_COMMON_ERROR=1490]="GLIFE_COMMON_ERROR",e[e.INVALID_GCASH_ACCOUNT=1492]="INVALID_GCASH_ACCOUNT",e[e.INVALID_REFRESH_TOKEN=1502]="INVALID_REFRESH_TOKEN",e[e.INVALID_AUTH_CODE=1503]="INVALID_AUTH_CODE",e[e.TOKEN_EXPIRED=1493]="TOKEN_EXPIRED",e[e.INVALID_MAYA_ACCOUNT=1494]="INVALID_MAYA_ACCOUNT",e[e.NOT_GLIFE_REGISTERED_USER=1491]="NOT_GLIFE_REGISTERED_USER",e[e.PLAYER_NEED_BANK_INFORMATION=4231]="PLAYER_NEED_BANK_INFORMATION",e[e.PLAYER_NEED_PHONE_NUMBER=4232]="PLAYER_NEED_PHONE_NUMBER",e[e.PLAYER_NEED_PHONENUMBER_AND_BANK=4233]="PLAYER_NEED_PHONENUMBER_AND_BANK",e[e.CANT_FIND_DEPOSIT_RECORD=4234]="CANT_FIND_DEPOSIT_RECORD",e[e.TOPUP_RECORD_HAS_BEEN_USED=4235]="TOPUP_RECORD_HAS_BEEN_USED",e[e.NO_FULFILL_DEPOSIT_CONDITION=4236]="NO_FULFILL_DEPOSIT_CONDITION",e[e.NO_FULFILL_BETTING_CONDITION=4237]="NO_FULFILL_BETTING_CONDITION",e[e.PLAYER_NEED_EMAIL=4238]="PLAYER_NEED_EMAIL",e[e.INVALID_2_STEPS_VERIFICATION=1485]="INVALID_2_STEPS_VERIFICATION",e[e.INVALID_2_STEPS_VERIFICATION_CODE=1486]="INVALID_2_STEPS_VERIFICATION_CODE",e[e.USER_INFO_INCOMPLETE=1488]="USER_INFO_INCOMPLETE",e[e.GCASH_ACCOUNT_GCASHLIMIT=1495]="GCASH_ACCOUNT_GCASHLIMIT",e[e.INVALID_MAYA_APP_ACCOUNT=1496]="INVALID_MAYA_APP_ACCOUNT",e[e.INVALID_MAYA_APP_PROFILE=1497]="INVALID_MAYA_APP_PROFILE",e[e.FAILED_TO_REFRESH_MAYA_APP_TOKEN=1498]="FAILED_TO_REFRESH_MAYA_APP_TOKEN",e[e.PLAYER_BELOW_21_AGE=1499]="PLAYER_BELOW_21_AGE",e[e.REGENERATING_MINUTE_SUMMARY=4999]="REGENERATING_MINUTE_SUMMARY",e[e.REGENERATING_HOUR_SUMMARY=4998]="REGENERATING_HOUR_SUMMARY",e[e.FUNCTION_IS_DISABLED=1501]="FUNCTION_IS_DISABLED",e[e.INVALID_ACCOUNT=1504]="INVALID_ACCOUNT",e[e.PARTNER_NOT_ENOUGH_CREDIT=1505]="PARTNER_NOT_ENOUGH_CREDIT",e[e.MAYA_ACCOUNT_MAYALIMIT=1506]="MAYA_ACCOUNT_MAYALIMIT",e[e.INVALID_PAYMENT_SERVICE_GATEWAY=1507]="INVALID_PAYMENT_SERVICE_GATEWAY",e[e.CONSUMPTION_ORDERNO_ERROR=1508]="CONSUMPTION_ORDERNO_ERROR",e[e.API_REQUEST_FREQUENTLY=1555]="API_REQUEST_FREQUENTLY",e[e.INVALID_AMOUNT=1701]="INVALID_AMOUNT",e[e.GLIFE_DEPOSIT_MAINTENANCE=1702]="GLIFE_DEPOSIT_MAINTENANCE",e[e.GLIFE_WITHDRAW_MAINTENANCE=1703]="GLIFE_WITHDRAW_MAINTENANCE",e[e.GLIFE_BANKTYPE_MAINTENANCE=1704]="GLIFE_BANKTYPE_MAINTENANCE",e[e.INVALID_CONTENT_PROVIDER=1705]="INVALID_CONTENT_PROVIDER",e[e.OPERATION_FAIL=1706]="OPERATION_FAIL",e[e.INVALID_DATA=1707]="INVALID_DATA",e[e.DOCUMENT_NOT_FOUND=1708]="DOCUMENT_NOT_FOUND",e[e.CONSUMPTION_ORDERNO_NOT_FOUND=1709]="CONSUMPTION_ORDERNO_NOT_FOUND",e[e.CONSUMPTION_UPDATE_NOT_SUCCESS=1710]="CONSUMPTION_UPDATE_NOT_SUCCESS",e[e.INVALID_UPDATE_CONSUMPTION_PARAM=1711]="INVALID_UPDATE_CONSUMPTION_PARAM",e[e.EXTERNAL_API_TIMEOUT=1712]="EXTERNAL_API_TIMEOUT",e[e.PARTNER_IS_FORBIDDEN=1713]="PARTNER_IS_FORBIDDEN",e[e.PARTNER_NO_PERMISSION=1714]="PARTNER_NO_PERMISSION",e[e.PROVIDER_GROUP_IS_OFF=1715]="PROVIDER_GROUP_IS_OFF",e[e.EXTERNAL_API_ERROR=1481]="EXTERNAL_API_ERROR",e[e.USER_NO_TRANSFER_RECORD=1716]="USER_NO_TRANSFER_RECORD",e[e.GAME_NOT_AVAILABLE=1717]="GAME_NOT_AVAILABLE",e[e.HEADER_SIGN_ERROR=1600]="HEADER_SIGN_ERROR",e[e.UNKNOWN_APIKEY=1601]="UNKNOWN_APIKEY",e[e.REQUEST_EXPIRED=1603]="REQUEST_EXPIRED",e[e.INCORRECT_SIGNATURE=1604]="INCORRECT_SIGNATURE",e[e.AUDIT_APPROVAL_FAILED=1605]="AUDIT_APPROVAL_FAILED"}(kr||(kr={})),vr.util.setEnumType(kr,"common.StatusCode",[{no:0,name:"STATUS_UNSPECIFIED"},{no:200,name:"STATUS_SUCCESS"},{no:401,name:"STATUS_UNAUTHORIZED"},{no:403,name:"STATUS_FORBIDDEN"},{no:404,name:"STATUS_NOT_FOUND"},{no:500,name:"STATUS_INTERNAL_ERROR"},{no:550,name:"STATUS_ILLEGAL_ARGS"},{no:409,name:"STATUS_ALREADY_EXISTS"},{no:601,name:"STATUS_AML_TRIGGERED"},{no:602,name:"STATUS_AML_NOT_TRIGGERED"},{no:1201,name:"DUPLICATE_ID"},{no:1202,name:"HASH_CODE_ERROR"},{no:1203,name:"INVALID_DATE_RANGE"},{no:1204,name:"INVALID_OR_MISSING_PARAM"},{no:1205,name:"INVALID_DATE_FORMAT"},{no:1400,name:"COMMON_ERROR"},{no:1500,name:"DB_ERROR"},{no:1420,name:"INVALID_API_USER"},{no:1484,name:"INVALID_SIGNATURE"},{no:1483,name:"FAILED_LINK_FACEBOOK"},{no:1401,name:"INVALID_USER_PASSWORD"},{no:1402,name:"INVALID_CAPTCHA"},{no:1403,name:"GENERATE_VALIDATION_CODE_ERROR"},{no:1404,name:"USERNAME_ALREADY_EXIST"},{no:1405,name:"INVALID_PARAM"},{no:1406,name:"INVALID_PHONE_NUMBER"},{no:1407,name:"INVALID_OLD_PASSWORD"},{no:1408,name:"DATABASE_CONNECTION_FAILURE"},{no:1409,name:"PERMISSION_DENIED"},{no:1410,name:"SEARCH_OUT_OF_RANGE"},{no:1411,name:"SESSION_EXPIRED"},{no:1412,name:"INVALID_PROPOSAL"},{no:1413,name:"PAYMENT_NOT_AVAILABLE"},{no:1415,name:"PLAYER_NOT_ENOUGH_CREDIT"},{no:1416,name:"PLAYER_CREDIT_BALANCE_NOT_ENOUGH"},{no:1417,name:"PLAYER_INVALID_PAYMENT_INFO"},{no:1418,name:"PLAYER_NO_PERMISSION"},{no:1419,name:"PLAYER_PENDING_PROPOSAL"},{no:1426,name:"PLAYER_TOP_UP_FAIL"},{no:1421,name:"REWARD_EVENT_INVALID"},{no:1422,name:"PLAYER_NOT_VALID_FOR_REWARD"},{no:1423,name:"PLAYER_APPLY_REWARD_FAIL"},{no:1424,name:"PLAYER_HAS_REWARD_TASK"},{no:1425,name:"CP_NOT_AVAILABLE"},{no:1427,name:"PLAYER_REWARD_INFO"},{no:1428,name:"PLAYER_TRANSFER_OUT_ERROR"},{no:1429,name:"PLAYER_TRANSFER_IN_ERROR"},{no:1430,name:"PLAYER_IS_FORBIDDEN"},{no:1431,name:"DATA_INVALID"},{no:1432,name:"PLAYER_NAME_INVALID"},{no:1433,name:"PARTNER_NAME_INVALID"},{no:1434,name:"VALIDATION_CODE_INVALID"},{no:1435,name:"VALIDATION_CODE_EXPIRED"},{no:1436,name:"PLAYER_PENDING_REWARD_PROPOSAL"},{no:1437,name:"INVALID_REFERRAL"},{no:1438,name:"INVALID_PLATFORM"},{no:1439,name:"FAILED_UPDATE_REWARD_TASK"},{no:1440,name:"NO_USER_FOUND"},{no:1441,name:"USERNAME_LENGTH_INCORRECT"},{no:1442,name:"PLAYER_REALNAME_EXIST"},{no:1443,name:"PLAYER_REALNAME_MUST_BE_CHINESE"},{no:1444,name:"FAILED_PROMO_CODE_CONDITION"},{no:1445,name:"FAILED_LIMITED_OFFER_CONDITION"},{no:1446,name:"NO_PROMO_CODE_MATCH"},{no:1447,name:"TEST_GAME_REQUIRE_LOGIN"},{no:1448,name:"PLAYER_IS_CANCELLED"},{no:1450,name:"PLAYER_NOT_MINTOPUP"},{no:1451,name:"NO_REACH_TOPUP"},{no:1452,name:"NO_REACH_CONSUMPTION"},{no:1453,name:"NO_REACH_TOPUP_CONSUMPTION"},{no:1454,name:"PHONENUMBER_ALREADY_EXIST"},{no:1455,name:"ABNORMAL_CREDIT_DEDUCTION"},{no:1456,name:"PLAYER_CONVERT_REWARD_POINTS_FAIL"},{no:1457,name:"VALIDATION_CODE_EXCEED_ATTEMPT"},{no:1458,name:"PLAYER_NOT_ENOUGH_REWARD_POINTS"},{no:1459,name:"GROUP_REWARD_NOT_ALLOWED"},{no:1460,name:"SMS_RETRY_FAILS_EXCEED"},{no:1461,name:"NOT_ENOUGH_CONSUMPTION"},{no:1462,name:"REALNAME_ALREADY_EXIST"},{no:1465,name:"REWARD_POINTS_CONVERT_FAIL"},{no:1466,name:"CONCURRENT_DETECTED"},{no:1467,name:"PROMO_METHOD_NOT_FOUND"},{no:1468,name:"CS_OFFICER_NOT_FOUND"},{no:1469,name:"REMARK_NOT_FOUND"},{no:1470,name:"EXTERNAL_API_FAILURE"},{no:1471,name:"INVALID_OLD_PHONENUMBER"},{no:1472,name:"OLD_PHONE_NUMBER_REQUIRED"},{no:1473,name:"SPENDING_TIMES_REQUIRED"},{no:1474,name:"BLACKLIST_IP"},{no:1475,name:"CONFIRMATION_TO_COMPLETE_ACTIVITY"},{no:1476,name:"INTERVAL_REWARD_CAPPED"},{no:1477,name:"DEVICE_ID_ERROR"},{no:1478,name:"NO_BIRTHDAY"},{no:1479,name:"PARTNER_NOT_FOUND"},{no:1480,name:"PARTNER_RATE_INAPPROPRIATE"},{no:1482,name:"DISABLE_PLATFORM_LOGIN"},{no:1487,name:"LOGIN_CONDITION_NOT_MATCHED"},{no:1489,name:"INVALID_GLIFE_ACCOUNT"},{no:1490,name:"GLIFE_COMMON_ERROR"},{no:1492,name:"INVALID_GCASH_ACCOUNT"},{no:1502,name:"INVALID_REFRESH_TOKEN"},{no:1503,name:"INVALID_AUTH_CODE"},{no:1493,name:"TOKEN_EXPIRED"},{no:1494,name:"INVALID_MAYA_ACCOUNT"},{no:1491,name:"NOT_GLIFE_REGISTERED_USER"},{no:4231,name:"PLAYER_NEED_BANK_INFORMATION"},{no:4232,name:"PLAYER_NEED_PHONE_NUMBER"},{no:4233,name:"PLAYER_NEED_PHONENUMBER_AND_BANK"},{no:4234,name:"CANT_FIND_DEPOSIT_RECORD"},{no:4235,name:"TOPUP_RECORD_HAS_BEEN_USED"},{no:4236,name:"NO_FULFILL_DEPOSIT_CONDITION"},{no:4237,name:"NO_FULFILL_BETTING_CONDITION"},{no:4238,name:"PLAYER_NEED_EMAIL"},{no:1485,name:"INVALID_2_STEPS_VERIFICATION"},{no:1486,name:"INVALID_2_STEPS_VERIFICATION_CODE"},{no:1488,name:"USER_INFO_INCOMPLETE"},{no:1495,name:"GCASH_ACCOUNT_GCASHLIMIT"},{no:1496,name:"INVALID_MAYA_APP_ACCOUNT"},{no:1497,name:"INVALID_MAYA_APP_PROFILE"},{no:1498,name:"FAILED_TO_REFRESH_MAYA_APP_TOKEN"},{no:1499,name:"PLAYER_BELOW_21_AGE"},{no:4999,name:"REGENERATING_MINUTE_SUMMARY"},{no:4998,name:"REGENERATING_HOUR_SUMMARY"},{no:1501,name:"FUNCTION_IS_DISABLED"},{no:1504,name:"INVALID_ACCOUNT"},{no:1505,name:"PARTNER_NOT_ENOUGH_CREDIT"},{no:1506,name:"MAYA_ACCOUNT_MAYALIMIT"},{no:1507,name:"INVALID_PAYMENT_SERVICE_GATEWAY"},{no:1508,name:"CONSUMPTION_ORDERNO_ERROR"},{no:1555,name:"API_REQUEST_FREQUENTLY"},{no:1701,name:"INVALID_AMOUNT"},{no:1702,name:"GLIFE_DEPOSIT_MAINTENANCE"},{no:1703,name:"GLIFE_WITHDRAW_MAINTENANCE"},{no:1704,name:"GLIFE_BANKTYPE_MAINTENANCE"},{no:1705,name:"INVALID_CONTENT_PROVIDER"},{no:1706,name:"OPERATION_FAIL"},{no:1707,name:"INVALID_DATA"},{no:1708,name:"DOCUMENT_NOT_FOUND"},{no:1709,name:"CONSUMPTION_ORDERNO_NOT_FOUND"},{no:1710,name:"CONSUMPTION_UPDATE_NOT_SUCCESS"},{no:1711,name:"INVALID_UPDATE_CONSUMPTION_PARAM"},{no:1712,name:"EXTERNAL_API_TIMEOUT"},{no:1713,name:"PARTNER_IS_FORBIDDEN"},{no:1714,name:"PARTNER_NO_PERMISSION"},{no:1715,name:"PROVIDER_GROUP_IS_OFF"},{no:1481,name:"EXTERNAL_API_ERROR"},{no:1716,name:"USER_NO_TRANSFER_RECORD"},{no:1717,name:"GAME_NOT_AVAILABLE"},{no:1600,name:"HEADER_SIGN_ERROR"},{no:1601,name:"UNKNOWN_APIKEY"},{no:1603,name:"REQUEST_EXPIRED"},{no:1604,name:"INCORRECT_SIGNATURE"},{no:1605,name:"AUDIT_APPROVAL_FAILED"}]);class Cr extends tn{constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="common.Empty";static fields=vr.util.newFieldList((()=>[]));static fromBinary(e,t){return(new Cr).fromBinary(e,t)}static fromJson(e,t){return(new Cr).fromJson(e,t)}static fromJsonString(e,t){return(new Cr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Cr,e,t)}}class Pr extends tn{status=kr.STATUS_UNSPECIFIED;message="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="common.BaseResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"status",kind:"enum",T:vr.getEnumType(kr)},{no:2,name:"message",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Pr).fromBinary(e,t)}static fromJson(e,t){return(new Pr).fromJson(e,t)}static fromJsonString(e,t){return(new Pr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Pr,e,t)}}class Dr extends tn{limit=0;offset=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="common.Pagination";static fields=vr.util.newFieldList((()=>[{no:1,name:"limit",kind:"scalar",T:5},{no:2,name:"offset",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Dr).fromBinary(e,t)}static fromJson(e,t){return(new Dr).fromJson(e,t)}static fromJsonString(e,t){return(new Dr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Dr,e,t)}}class Nr extends tn{field="";filterType=Rr.STRING;operator=Or.EQUALS;stringValue="";numberValue=0;dateValue="";boolValue=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="common.Filter";static fields=vr.util.newFieldList((()=>[{no:1,name:"field",kind:"scalar",T:9},{no:2,name:"filterType",kind:"enum",T:vr.getEnumType(Rr)},{no:3,name:"operator",kind:"enum",T:vr.getEnumType(Or)},{no:4,name:"stringValue",kind:"scalar",T:9},{no:5,name:"numberValue",kind:"scalar",T:5},{no:6,name:"dateValue",kind:"scalar",T:9},{no:7,name:"boolValue",kind:"scalar",T:8}]));static fromBinary(e,t){return(new Nr).fromBinary(e,t)}static fromJson(e,t){return(new Nr).fromJson(e,t)}static fromJsonString(e,t){return(new Nr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Nr,e,t)}}!function(e){e[e.STRING=0]="STRING",e[e.NUMBER=1]="NUMBER",e[e.DATE=2]="DATE",e[e.OBJECT_ID=3]="OBJECT_ID",e[e.BOOLEAN=4]="BOOLEAN"}(Rr||(Rr={})),vr.util.setEnumType(Rr,"common.Filter.FilterType",[{no:0,name:"STRING"},{no:1,name:"NUMBER"},{no:2,name:"DATE"},{no:3,name:"OBJECT_ID"},{no:4,name:"BOOLEAN"}]),function(e){e[e.EQUALS=0]="EQUALS",e[e.LIKE=1]="LIKE",e[e.GT=2]="GT",e[e.LT=3]="LT",e[e.GTE=4]="GTE",e[e.LTE=5]="LTE"}(Or||(Or={})),vr.util.setEnumType(Or,"common.Filter.Operator",[{no:0,name:"EQUALS"},{no:1,name:"LIKE"},{no:2,name:"GT"},{no:3,name:"LT"},{no:4,name:"GTE"},{no:5,name:"LTE"}]),Object.freeze({__proto__:null,BaseResponse:Pr,Empty:Cr,Filter:Nr,get Filter_FilterType(){return Rr},get Filter_Operator(){return Or},get IDStatus(){return Tr},Pagination:Dr,get StatusCode(){return kr}});class xr extends tn{roomId="";mainType="";limit=0;isOperationData=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.PlayerProposalReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"mainType",kind:"scalar",T:9},{no:3,name:"limit",kind:"scalar",T:5},{no:4,name:"isOperationData",kind:"scalar",T:8}]));static fromBinary(e,t){return(new xr).fromBinary(e,t)}static fromJson(e,t){return(new xr).fromJson(e,t)}static fromJsonString(e,t){return(new xr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(xr,e,t)}}class Mr extends tn{playerId="";roomId="";liveChatName="";isVip=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.PlayerEnterChatReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"playerId",kind:"scalar",T:9},{no:2,name:"roomId",kind:"scalar",T:9},{no:3,name:"liveChatName",kind:"scalar",T:9},{no:4,name:"isVip",kind:"scalar",T:8}]));static fromBinary(e,t){return(new Mr).fromBinary(e,t)}static fromJson(e,t){return(new Mr).fromJson(e,t)}static fromJsonString(e,t){return(new Mr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Mr,e,t)}}class Lr extends tn{agentName="";status=0;accessToken="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.UpdateAgentStatusReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"agentName",kind:"scalar",T:9},{no:2,name:"status",kind:"scalar",T:5},{no:3,name:"accessToken",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Lr).fromBinary(e,t)}static fromJson(e,t){return(new Lr).fromJson(e,t)}static fromJsonString(e,t){return(new Lr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Lr,e,t)}}class Br extends tn{agentName="";roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.AgentLeaveRoomReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"agentName",kind:"scalar",T:9},{no:2,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Br).fromBinary(e,t)}static fromJson(e,t){return(new Br).fromJson(e,t)}static fromJsonString(e,t){return(new Br).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Br,e,t)}}class Ur extends tn{playerId="";guestName="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LoginOrRegisterReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"playerId",kind:"scalar",T:9},{no:2,name:"guestName",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Ur).fromBinary(e,t)}static fromJson(e,t){return(new Ur).fromJson(e,t)}static fromJsonString(e,t){return(new Ur).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ur,e,t)}}class Fr extends tn{playerId="";roomId="";accessToken="";playerName="";guestName="";message="";conversationId="";channel=0;photoUrl="";transferLiveAgent=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.MessageReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"playerId",kind:"scalar",T:9},{no:2,name:"roomId",kind:"scalar",T:9},{no:3,name:"accessToken",kind:"scalar",T:9},{no:4,name:"playerName",kind:"scalar",T:9},{no:5,name:"guestName",kind:"scalar",T:9},{no:6,name:"message",kind:"scalar",T:9},{no:7,name:"conversationId",kind:"scalar",T:9},{no:8,name:"channel",kind:"scalar",T:5},{no:9,name:"photoUrl",kind:"scalar",T:9},{no:10,name:"transferLiveAgent",kind:"scalar",T:8}]));static fromBinary(e,t){return(new Fr).fromBinary(e,t)}static fromJson(e,t){return(new Fr).fromJson(e,t)}static fromJsonString(e,t){return(new Fr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Fr,e,t)}}class jr extends tn{playerId="";roomId="";accessToken="";agentName="";agentAccessToken="";playerName="";guestName="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.EndSessionReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"playerId",kind:"scalar",T:9},{no:2,name:"roomId",kind:"scalar",T:9},{no:3,name:"accessToken",kind:"scalar",T:9},{no:4,name:"agentName",kind:"scalar",T:9},{no:5,name:"agentAccessToken",kind:"scalar",T:9},{no:6,name:"playerName",kind:"scalar",T:9},{no:7,name:"guestName",kind:"scalar",T:9}]));static fromBinary(e,t){return(new jr).fromBinary(e,t)}static fromJson(e,t){return(new jr).fromJson(e,t)}static fromJsonString(e,t){return(new jr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(jr,e,t)}}class qr extends tn{roomId="";matrixClientType=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LeaveRoomReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"matrixClientType",kind:"scalar",T:5}]));static fromBinary(e,t){return(new qr).fromBinary(e,t)}static fromJson(e,t){return(new qr).fromJson(e,t)}static fromJsonString(e,t){return(new qr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(qr,e,t)}}class Kr extends tn{roomId="";agentName="";matrixClientType=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.KickUserReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"agentName",kind:"scalar",T:9},{no:3,name:"matrixClientType",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Kr).fromBinary(e,t)}static fromJson(e,t){return(new Kr).fromJson(e,t)}static fromJsonString(e,t){return(new Kr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Kr,e,t)}}class $r extends tn{roomId="";userName="";matrixClientType=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.MemberInRoomReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"userName",kind:"scalar",T:9},{no:3,name:"matrixClientType",kind:"scalar",T:5}]));static fromBinary(e,t){return(new $r).fromBinary(e,t)}static fromJson(e,t){return(new $r).fromJson(e,t)}static fromJsonString(e,t){return(new $r).fromJsonString(e,t)}static equals(e,t){return vr.util.equals($r,e,t)}}class Vr extends tn{roomId="";curAgentName="";newAgentName="";agentAccessToken="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.SwitchAgentReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"curAgentName",kind:"scalar",T:9},{no:3,name:"newAgentName",kind:"scalar",T:9},{no:4,name:"agentAccessToken",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Vr).fromBinary(e,t)}static fromJson(e,t){return(new Vr).fromJson(e,t)}static fromJsonString(e,t){return(new Vr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Vr,e,t)}}class Gr extends tn{agentName="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.AgentLogoutReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"agentName",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Gr).fromBinary(e,t)}static fromJson(e,t){return(new Gr).fromJson(e,t)}static fromJsonString(e,t){return(new Gr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Gr,e,t)}}class Hr extends tn{agentName="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetAgentListReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"agentName",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Hr).fromBinary(e,t)}static fromJson(e,t){return(new Hr).fromJson(e,t)}static fromJsonString(e,t){return(new Hr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Hr,e,t)}}class Wr extends tn{roomId="";roomRemarks="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.UpdatePlayerRoomRemarksReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"roomRemarks",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Wr).fromBinary(e,t)}static fromJson(e,t){return(new Wr).fromJson(e,t)}static fromJsonString(e,t){return(new Wr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Wr,e,t)}}class Jr extends tn{playerId="";playerObjId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetConsumptionDataReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"playerId",kind:"scalar",T:9},{no:2,name:"playerObjId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Jr).fromBinary(e,t)}static fromJson(e,t){return(new Jr).fromJson(e,t)}static fromJsonString(e,t){return(new Jr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Jr,e,t)}}class Yr extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetPlayerDataReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Yr).fromBinary(e,t)}static fromJson(e,t){return(new Yr).fromJson(e,t)}static fromJsonString(e,t){return(new Yr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Yr,e,t)}}class zr extends tn{tag="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.CreateTagReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"tag",kind:"scalar",T:9}]));static fromBinary(e,t){return(new zr).fromBinary(e,t)}static fromJson(e,t){return(new zr).fromJson(e,t)}static fromJsonString(e,t){return(new zr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(zr,e,t)}}class Xr extends tn{title="";description="";ticketId=0;roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.UpdateTicketReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"title",kind:"scalar",T:9},{no:2,name:"description",kind:"scalar",T:9},{no:3,name:"ticketId",kind:"scalar",T:5},{no:4,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Xr).fromBinary(e,t)}static fromJson(e,t){return(new Xr).fromJson(e,t)}static fromJsonString(e,t){return(new Xr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Xr,e,t)}}class Qr extends tn{message="";startTime="";endTime="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.UpdateAnnouncementReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"message",kind:"scalar",T:9},{no:2,name:"startTime",kind:"scalar",T:9},{no:3,name:"endTime",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Qr).fromBinary(e,t)}static fromJson(e,t){return(new Qr).fromJson(e,t)}static fromJsonString(e,t){return(new Qr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Qr,e,t)}}class Zr extends tn{roomId="";limit=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetTransitionDataReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"limit",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Zr).fromBinary(e,t)}static fromJson(e,t){return(new Zr).fromJson(e,t)}static fromJsonString(e,t){return(new Zr).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Zr,e,t)}}class ei extends tn{agentName="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetVisitingPlayerReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"agentName",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ei).fromBinary(e,t)}static fromJson(e,t){return(new ei).fromJson(e,t)}static fromJsonString(e,t){return(new ei).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ei,e,t)}}class ti extends tn{agentName="";refreshToken="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.AgentRegisterReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"agentName",kind:"scalar",T:9},{no:2,name:"refreshToken",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ti).fromBinary(e,t)}static fromJson(e,t){return(new ti).fromJson(e,t)}static fromJsonString(e,t){return(new ti).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ti,e,t)}}class ni extends tn{conversationId="";roomId="";agentName="";message="";rating=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.RateReviewReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"conversationId",kind:"scalar",T:9},{no:2,name:"roomId",kind:"scalar",T:9},{no:3,name:"agentName",kind:"scalar",T:9},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"rating",kind:"scalar",T:2}]));static fromBinary(e,t){return(new ni).fromBinary(e,t)}static fromJson(e,t){return(new ni).fromJson(e,t)}static fromJsonString(e,t){return(new ni).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ni,e,t)}}class ri extends tn{tag="";roomId="";startTime="";endTime="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.UpdateConversationTagReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"tag",kind:"scalar",T:9},{no:2,name:"roomId",kind:"scalar",T:9},{no:3,name:"startTime",kind:"scalar",T:9},{no:4,name:"endTime",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ri).fromBinary(e,t)}static fromJson(e,t){return(new ri).fromJson(e,t)}static fromJsonString(e,t){return(new ri).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ri,e,t)}}class ii extends tn{roomId="";startTime="";endTime="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetConversationTagReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"startTime",kind:"scalar",T:9},{no:3,name:"endTime",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ii).fromBinary(e,t)}static fromJson(e,t){return(new ii).fromJson(e,t)}static fromJsonString(e,t){return(new ii).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ii,e,t)}}class si extends tn{agentName="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.RegisterMatrixUserReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"agentName",kind:"scalar",T:9}]));static fromBinary(e,t){return(new si).fromBinary(e,t)}static fromJson(e,t){return(new si).fromJson(e,t)}static fromJsonString(e,t){return(new si).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(si,e,t)}}class oi extends tn{baseResponse;cacheTime=0;conversationTimeout=0;conversationTimeoutCS=0;csChatLimit=0;vipChatLimit=0;vipCriteria="";timeoutReminder=0;timeoutAutoAgentTransfer=0;tag=[];announcement;livechatEnabled=!1;welcomeMessage="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LiveChatConfigRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"cacheTime",kind:"scalar",T:2},{no:3,name:"conversationTimeout",kind:"scalar",T:2},{no:4,name:"conversationTimeoutCS",kind:"scalar",T:2},{no:5,name:"csChatLimit",kind:"scalar",T:5},{no:6,name:"vipChatLimit",kind:"scalar",T:5},{no:7,name:"vipCriteria",kind:"scalar",T:9},{no:8,name:"timeoutReminder",kind:"scalar",T:2},{no:9,name:"timeoutAutoAgentTransfer",kind:"scalar",T:2},{no:10,name:"tag",kind:"scalar",T:9,repeated:!0},{no:11,name:"announcement",kind:"message",T:Di},{no:12,name:"livechatEnabled",kind:"scalar",T:8},{no:13,name:"welcomeMessage",kind:"scalar",T:9}]));static fromBinary(e,t){return(new oi).fromBinary(e,t)}static fromJson(e,t){return(new oi).fromJson(e,t)}static fromJsonString(e,t){return(new oi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(oi,e,t)}}class ai extends tn{baseResponse;result=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LiveChatFaqRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"result",kind:"message",T:Si,repeated:!0}]));static fromBinary(e,t){return(new ai).fromBinary(e,t)}static fromJson(e,t){return(new ai).fromJson(e,t)}static fromJsonString(e,t){return(new ai).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ai,e,t)}}class ci extends tn{baseResponse;proposal=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.PlayerProposalRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"proposal",kind:"message",T:Ti,repeated:!0}]));static fromBinary(e,t){return(new ci).fromBinary(e,t)}static fromJson(e,t){return(new ci).fromJson(e,t)}static fromJsonString(e,t){return(new ci).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ci,e,t)}}class li extends tn{success=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.PlayerEnterChatRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"success",kind:"scalar",T:8}]));static fromBinary(e,t){return(new li).fromBinary(e,t)}static fromJson(e,t){return(new li).fromJson(e,t)}static fromJsonString(e,t){return(new li).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(li,e,t)}}class ui extends tn{baseResponse;accessToken="";roomId="";guestName="";liveChatName="";refreshToken="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LoginOrRegisterRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"accessToken",kind:"scalar",T:9},{no:3,name:"roomId",kind:"scalar",T:9},{no:4,name:"guestName",kind:"scalar",T:9},{no:5,name:"liveChatName",kind:"scalar",T:9},{no:6,name:"refreshToken",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ui).fromBinary(e,t)}static fromJson(e,t){return(new ui).fromJson(e,t)}static fromJsonString(e,t){return(new ui).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ui,e,t)}}class di extends tn{baseResponse;botMessage="";conversationId="";botOptions;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.MessageRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"botMessage",kind:"scalar",T:9},{no:3,name:"conversationId",kind:"scalar",T:9},{no:4,name:"botOptions",kind:"message",T:Oi}]));static fromBinary(e,t){return(new di).fromBinary(e,t)}static fromJson(e,t){return(new di).fromJson(e,t)}static fromJsonString(e,t){return(new di).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(di,e,t)}}class hi extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LeaveRoomRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new hi).fromBinary(e,t)}static fromJson(e,t){return(new hi).fromJson(e,t)}static fromJsonString(e,t){return(new hi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(hi,e,t)}}class pi extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.KickUserRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new pi).fromBinary(e,t)}static fromJson(e,t){return(new pi).fromJson(e,t)}static fromJsonString(e,t){return(new pi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(pi,e,t)}}class gi extends tn{isMemberInRoom=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.MemberInRoomRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"isMemberInRoom",kind:"scalar",T:8}]));static fromBinary(e,t){return(new gi).fromBinary(e,t)}static fromJson(e,t){return(new gi).fromJson(e,t)}static fromJsonString(e,t){return(new gi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(gi,e,t)}}class fi extends tn{baseResponse;agents=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetAgentListRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"agents",kind:"scalar",T:9,repeated:!0}]));static fromBinary(e,t){return(new fi).fromBinary(e,t)}static fromJson(e,t){return(new fi).fromJson(e,t)}static fromJsonString(e,t){return(new fi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(fi,e,t)}}class mi extends tn{baseResponse;consumptionData=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetConsumptionDataRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"consumptionData",kind:"message",T:Ri,repeated:!0}]));static fromBinary(e,t){return(new mi).fromBinary(e,t)}static fromJson(e,t){return(new mi).fromJson(e,t)}static fromJsonString(e,t){return(new mi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(mi,e,t)}}class vi extends tn{baseResponse;playerId="";name="";realName="";level="";kycStatus=Tr.DEFAULT;birthday="";contactChannel="";roomRemarks="";lastBetLobby="";lastTicketStatus="";contactTime=0;kycVerifiedDate="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetPlayerDataRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"playerId",kind:"scalar",T:9},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"realName",kind:"scalar",T:9},{no:5,name:"level",kind:"scalar",T:9},{no:6,name:"kycStatus",kind:"enum",T:vr.getEnumType(Tr)},{no:7,name:"birthday",kind:"scalar",T:9},{no:8,name:"contactChannel",kind:"scalar",T:9},{no:9,name:"roomRemarks",kind:"scalar",T:9},{no:10,name:"lastBetLobby",kind:"scalar",T:9},{no:11,name:"lastTicketStatus",kind:"scalar",T:9},{no:12,name:"contactTime",kind:"scalar",T:5},{no:13,name:"kycVerifiedDate",kind:"scalar",T:9}]));static fromBinary(e,t){return(new vi).fromBinary(e,t)}static fromJson(e,t){return(new vi).fromJson(e,t)}static fromJsonString(e,t){return(new vi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(vi,e,t)}}class yi extends tn{baseResponse;transitionData=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetTransitionDataRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"transitionData",kind:"message",T:ki,repeated:!0}]));static fromBinary(e,t){return(new yi).fromBinary(e,t)}static fromJson(e,t){return(new yi).fromJson(e,t)}static fromJsonString(e,t){return(new yi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(yi,e,t)}}class _i extends tn{baseResponse;currentTreatingCounter=0;totalTreatingCounter=0;agentStatus=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetVisitingPlayerRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"currentTreatingCounter",kind:"scalar",T:5},{no:3,name:"totalTreatingCounter",kind:"scalar",T:5},{no:4,name:"agentStatus",kind:"scalar",T:5}]));static fromBinary(e,t){return(new _i).fromBinary(e,t)}static fromJson(e,t){return(new _i).fromJson(e,t)}static fromJsonString(e,t){return(new _i).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(_i,e,t)}}class bi extends tn{baseResponse;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GeneralRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr}]));static fromBinary(e,t){return(new bi).fromBinary(e,t)}static fromJson(e,t){return(new bi).fromJson(e,t)}static fromJsonString(e,t){return(new bi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(bi,e,t)}}class Ei extends tn{baseResponse;tag=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.GetConversationTagRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"tag",kind:"scalar",T:9,repeated:!0}]));static fromBinary(e,t){return(new Ei).fromBinary(e,t)}static fromJson(e,t){return(new Ei).fromJson(e,t)}static fromJsonString(e,t){return(new Ei).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ei,e,t)}}class Ai extends tn{baseResponse;ticketId=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.UpdateTicketRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"ticketId",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Ai).fromBinary(e,t)}static fromJson(e,t){return(new Ai).fromJson(e,t)}static fromJsonString(e,t){return(new Ai).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ai,e,t)}}class Si extends tn{categoryName="";subCategory=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LiveChatFaqCategory";static fields=vr.util.newFieldList((()=>[{no:1,name:"categoryName",kind:"scalar",T:9},{no:2,name:"subCategory",kind:"message",T:wi,repeated:!0}]));static fromBinary(e,t){return(new Si).fromBinary(e,t)}static fromJson(e,t){return(new Si).fromJson(e,t)}static fromJsonString(e,t){return(new Si).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Si,e,t)}}class wi extends tn{subCategoryName="";list=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LiveChatFaqSubCategory";static fields=vr.util.newFieldList((()=>[{no:1,name:"subCategoryName",kind:"scalar",T:9},{no:2,name:"list",kind:"message",T:Ii,repeated:!0}]));static fromBinary(e,t){return(new wi).fromBinary(e,t)}static fromJson(e,t){return(new wi).fromJson(e,t)}static fromJsonString(e,t){return(new wi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(wi,e,t)}}class Ii extends tn{question="";answer="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.LiveChatFaqEntry";static fields=vr.util.newFieldList((()=>[{no:1,name:"question",kind:"scalar",T:9},{no:2,name:"answer",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Ii).fromBinary(e,t)}static fromJson(e,t){return(new Ii).fromJson(e,t)}static fromJsonString(e,t){return(new Ii).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ii,e,t)}}class Ti extends tn{proposalId="";mainType="";status="";createTime="";type="";merchantName="";amount=0;rewardAmount=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.proposalEntry";static fields=vr.util.newFieldList((()=>[{no:1,name:"proposalId",kind:"scalar",T:9},{no:2,name:"mainType",kind:"scalar",T:9},{no:3,name:"status",kind:"scalar",T:9},{no:4,name:"createTime",kind:"scalar",T:9},{no:5,name:"type",kind:"scalar",T:9},{no:6,name:"merchantName",kind:"scalar",T:9},{no:7,name:"amount",kind:"scalar",T:2},{no:8,name:"rewardAmount",kind:"scalar",T:2}]));static fromBinary(e,t){return(new Ti).fromBinary(e,t)}static fromJson(e,t){return(new Ti).fromJson(e,t)}static fromJsonString(e,t){return(new Ti).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ti,e,t)}}class ki extends tn{transferId="";type="";createTime="";providerName="";providerId="";amount=0;status="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.transitionEntry";static fields=vr.util.newFieldList((()=>[{no:1,name:"transferId",kind:"scalar",T:9},{no:2,name:"type",kind:"scalar",T:9},{no:3,name:"createTime",kind:"scalar",T:9},{no:4,name:"providerName",kind:"scalar",T:9},{no:5,name:"providerId",kind:"scalar",T:9},{no:6,name:"amount",kind:"scalar",T:2},{no:7,name:"status",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ki).fromBinary(e,t)}static fromJson(e,t){return(new ki).fromJson(e,t)}static fromJsonString(e,t){return(new ki).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ki,e,t)}}class Ri extends tn{providerId="";providerName="";gameId="";createTime="";amount=0;validAmount=0;bonusAmount=0;orderNo=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.consumptionEntry";static fields=vr.util.newFieldList((()=>[{no:1,name:"providerId",kind:"scalar",T:9},{no:2,name:"providerName",kind:"scalar",T:9},{no:3,name:"gameId",kind:"scalar",T:9},{no:4,name:"createTime",kind:"scalar",T:9},{no:5,name:"amount",kind:"scalar",T:2},{no:6,name:"validAmount",kind:"scalar",T:2},{no:7,name:"bonusAmount",kind:"scalar",T:2},{no:8,name:"orderNo",kind:"scalar",T:2}]));static fromBinary(e,t){return(new Ri).fromBinary(e,t)}static fromJson(e,t){return(new Ri).fromJson(e,t)}static fromJsonString(e,t){return(new Ri).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ri,e,t)}}class Oi extends tn{type="";data=[];constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.Options";static fields=vr.util.newFieldList((()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"data",kind:"message",T:Ci,repeated:!0}]));static fromBinary(e,t){return(new Oi).fromBinary(e,t)}static fromJson(e,t){return(new Oi).fromJson(e,t)}static fromJsonString(e,t){return(new Oi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Oi,e,t)}}class Ci extends tn{order="";display={case:void 0};constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.Option";static fields=vr.util.newFieldList((()=>[{no:1,name:"order",kind:"scalar",T:9},{no:2,name:"displayText",kind:"scalar",T:9,oneof:"display"},{no:3,name:"displayData",kind:"message",T:Pi,oneof:"display"}]));static fromBinary(e,t){return(new Ci).fromBinary(e,t)}static fromJson(e,t){return(new Ci).fromJson(e,t)}static fromJsonString(e,t){return(new Ci).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ci,e,t)}}class Pi extends tn{Amount="";Merchant="";Time="";Status="";Proposal="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.DisplayData";static fields=vr.util.newFieldList((()=>[{no:1,name:"Amount",kind:"scalar",T:9},{no:2,name:"Merchant",kind:"scalar",T:9},{no:3,name:"Time",kind:"scalar",T:9},{no:4,name:"Status",kind:"scalar",T:9},{no:5,name:"Proposal",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Pi).fromBinary(e,t)}static fromJson(e,t){return(new Pi).fromJson(e,t)}static fromJsonString(e,t){return(new Pi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Pi,e,t)}}class Di extends tn{message="";startTime="";endTime="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.Announcement";static fields=vr.util.newFieldList((()=>[{no:1,name:"message",kind:"scalar",T:9},{no:2,name:"startTime",kind:"scalar",T:9},{no:3,name:"endTime",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Di).fromBinary(e,t)}static fromJson(e,t){return(new Di).fromJson(e,t)}static fromJsonString(e,t){return(new Di).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Di,e,t)}}Object.freeze({__proto__:null,AgentLeaveRoomReq:Br,AgentLogoutReq:Gr,AgentRegisterReq:ti,Announcement:Di,CreateTagReq:zr,DisplayData:Pi,EndSessionReq:jr,GeneralRes:bi,GetAgentListReq:Hr,GetAgentListRes:fi,GetConsumptionDataReq:Jr,GetConsumptionDataRes:mi,GetConversationTagReq:ii,GetConversationTagRes:Ei,GetPlayerDataReq:Yr,GetPlayerDataRes:vi,GetTransitionDataReq:Zr,GetTransitionDataRes:yi,GetVisitingPlayerReq:ei,GetVisitingPlayerRes:_i,KickUserReq:Kr,KickUserRes:pi,LeaveRoomReq:qr,LeaveRoomRes:hi,LiveChatConfigRes:oi,LiveChatFaqCategory:Si,LiveChatFaqEntry:Ii,LiveChatFaqRes:ai,LiveChatFaqSubCategory:wi,LoginOrRegisterReq:Ur,LoginOrRegisterRes:ui,MemberInRoomReq:$r,MemberInRoomRes:gi,MessageReq:Fr,MessageRes:di,Option:Ci,Options:Oi,PlayerEnterChatReq:Mr,PlayerEnterChatRes:li,PlayerProposalReq:xr,PlayerProposalRes:ci,RateReviewReq:ni,RegisterMatrixUserReq:si,SwitchAgentReq:Vr,UpdateAgentStatusReq:Lr,UpdateAnnouncementReq:Qr,UpdateConversationTagReq:ri,UpdatePlayerRoomRemarksReq:Wr,UpdateTicketReq:Xr,UpdateTicketRes:Ai,consumptionEntry:Ri,proposalEntry:Ti,transitionEntry:ki});const Ni={typeName:"livechat.LiveChatService",methods:{getLiveChatConfig:{name:"GetLiveChatConfig",I:Cr,O:oi,kind:br.Unary},getLiveChatFaq:{name:"GetLiveChatFaq",I:Cr,O:ai,kind:br.Unary},getPlayerProposal:{name:"GetPlayerProposal",I:xr,O:ci,kind:br.Unary},playerEnterChat:{name:"PlayerEnterChat",I:Mr,O:li,kind:br.Unary},updateAgentStatus:{name:"UpdateAgentStatus",I:Lr,O:bi,kind:br.Unary},agentLeaveRoom:{name:"AgentLeaveRoom",I:Br,O:bi,kind:br.Unary},loginOrRegister:{name:"LoginOrRegister",I:Ur,O:ui,kind:br.Unary},message:{name:"Message",I:Fr,O:di,kind:br.Unary},endSession:{name:"EndSession",I:jr,O:bi,kind:br.Unary},leaveRoom:{name:"LeaveRoom",I:qr,O:hi,kind:br.Unary},kickUser:{name:"KickUser",I:Kr,O:pi,kind:br.Unary},memberInRoom:{name:"MemberInRoom",I:$r,O:gi,kind:br.Unary},switchAgent:{name:"SwitchAgent",I:Vr,O:bi,kind:br.Unary},agentLogout:{name:"AgentLogout",I:Gr,O:bi,kind:br.Unary},getAgentList:{name:"GetAgentList",I:Hr,O:fi,kind:br.Unary},updatePlayerRoomRemarks:{name:"UpdatePlayerRoomRemarks",I:Wr,O:bi,kind:br.Unary},getConsumptionData:{name:"GetConsumptionData",I:Jr,O:mi,kind:br.Unary},getPlayerData:{name:"GetPlayerData",I:Yr,O:vi,kind:br.Unary},createTag:{name:"CreateTag",I:zr,O:bi,kind:br.Unary},updateTicket:{name:"UpdateTicket",I:Xr,O:Ai,kind:br.Unary},updateAnnouncement:{name:"UpdateAnnouncement",I:Qr,O:bi,kind:br.Unary},getTransitionData:{name:"GetTransitionData",I:Zr,O:yi,kind:br.Unary},getVisitingPlayer:{name:"GetVisitingPlayer",I:ei,O:_i,kind:br.Unary},agentRegister:{name:"AgentRegister",I:ti,O:bi,kind:br.Unary},rateReview:{name:"RateReview",I:ni,O:bi,kind:br.Unary},updateConversationTag:{name:"UpdateConversationTag",I:ri,O:bi,kind:br.Unary},getConversationTag:{name:"GetConversationTag",I:ii,O:Ei,kind:br.Unary},registerMatrixUser:{name:"RegisterMatrixUser",I:si,O:bi,kind:br.Unary}}};var xi=Object.freeze({__proto__:null,LiveChatService:Ni});class Mi extends tn{name="";topic="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.CreateRoomRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"topic",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Mi).fromBinary(e,t)}static fromJson(e,t){return(new Mi).fromJson(e,t)}static fromJsonString(e,t){return(new Mi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Mi,e,t)}}class Li extends tn{roomId="";matrixClientType=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.JoinRoomRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"matrixClientType",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Li).fromBinary(e,t)}static fromJson(e,t){return(new Li).fromJson(e,t)}static fromJsonString(e,t){return(new Li).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Li,e,t)}}class Bi extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.LeaveRoomRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Bi).fromBinary(e,t)}static fromJson(e,t){return(new Bi).fromJson(e,t)}static fromJsonString(e,t){return(new Bi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Bi,e,t)}}class Ui extends tn{roomId="";userId="";matrixClientType=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.InviteUserRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"userId",kind:"scalar",T:9},{no:3,name:"matrixClientType",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Ui).fromBinary(e,t)}static fromJson(e,t){return(new Ui).fromJson(e,t)}static fromJsonString(e,t){return(new Ui).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ui,e,t)}}class Fi extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.CreateRoomResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Fi).fromBinary(e,t)}static fromJson(e,t){return(new Fi).fromJson(e,t)}static fromJsonString(e,t){return(new Fi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Fi,e,t)}}class ji extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.JoinRoomResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ji).fromBinary(e,t)}static fromJson(e,t){return(new ji).fromJson(e,t)}static fromJsonString(e,t){return(new ji).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(ji,e,t)}}class qi extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.LeaveRoomResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new qi).fromBinary(e,t)}static fromJson(e,t){return(new qi).fromJson(e,t)}static fromJsonString(e,t){return(new qi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(qi,e,t)}}class Ki extends tn{roomId="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.InviteUserResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Ki).fromBinary(e,t)}static fromJson(e,t){return(new Ki).fromJson(e,t)}static fromJsonString(e,t){return(new Ki).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ki,e,t)}}class $i extends tn{roomId="";isPublic=!1;creator="";roomVersion="";hasAuthChainIndex=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="room.Room";static fields=vr.util.newFieldList((()=>[{no:1,name:"roomId",kind:"scalar",T:9},{no:2,name:"isPublic",kind:"scalar",T:8},{no:3,name:"creator",kind:"scalar",T:9},{no:4,name:"roomVersion",kind:"scalar",T:9},{no:5,name:"hasAuthChainIndex",kind:"scalar",T:8}]));static fromBinary(e,t){return(new $i).fromBinary(e,t)}static fromJson(e,t){return(new $i).fromJson(e,t)}static fromJsonString(e,t){return(new $i).fromJsonString(e,t)}static equals(e,t){return vr.util.equals($i,e,t)}}Object.freeze({__proto__:null,CreateRoomRequest:Mi,CreateRoomResponse:Fi,InviteUserRequest:Ui,InviteUserResponse:Ki,JoinRoomRequest:Li,JoinRoomResponse:ji,LeaveRoomRequest:Bi,LeaveRoomResponse:qi,Room:$i});const Vi={typeName:"room.RoomService",methods:{createRoom:{name:"createRoom",I:Mi,O:Fi,kind:br.Unary},joinRoom:{name:"joinRoom",I:Li,O:ji,kind:br.Unary},leaveRoom:{name:"leaveRoom",I:Bi,O:qi,kind:br.Unary},inviteUser:{name:"inviteUser",I:Ui,O:Ki,kind:br.Unary}}};Object.freeze({__proto__:null,RoomService:Vi});class Gi extends tn{username="";password="";matrixClientType=0;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.LoginRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"username",kind:"scalar",T:9},{no:2,name:"password",kind:"scalar",T:9},{no:3,name:"matrixClientType",kind:"scalar",T:5}]));static fromBinary(e,t){return(new Gi).fromBinary(e,t)}static fromJson(e,t){return(new Gi).fromJson(e,t)}static fromJsonString(e,t){return(new Gi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Gi,e,t)}}class Hi extends tn{username="";password="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.RegisterRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"username",kind:"scalar",T:9},{no:2,name:"password",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Hi).fromBinary(e,t)}static fromJson(e,t){return(new Hi).fromJson(e,t)}static fromJsonString(e,t){return(new Hi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Hi,e,t)}}class Wi extends tn{user="";newPassword="";oldPassword="";logoutDevices=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.UpdatePasswordRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"user",kind:"scalar",T:9},{no:2,name:"newPassword",kind:"scalar",T:9},{no:3,name:"oldPassword",kind:"scalar",T:9},{no:4,name:"logoutDevices",kind:"scalar",T:8}]));static fromBinary(e,t){return(new Wi).fromBinary(e,t)}static fromJson(e,t){return(new Wi).fromJson(e,t)}static fromJsonString(e,t){return(new Wi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Wi,e,t)}}class Ji extends tn{username="";password="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.DeleteUserRequest";static fields=vr.util.newFieldList((()=>[{no:1,name:"username",kind:"scalar",T:9},{no:2,name:"password",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Ji).fromBinary(e,t)}static fromJson(e,t){return(new Ji).fromJson(e,t)}static fromJsonString(e,t){return(new Ji).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Ji,e,t)}}class Yi extends tn{userId="";accessToken="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.LoginResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"userId",kind:"scalar",T:9},{no:2,name:"accessToken",kind:"scalar",T:9}]));static fromBinary(e,t){return(new Yi).fromBinary(e,t)}static fromJson(e,t){return(new Yi).fromJson(e,t)}static fromJsonString(e,t){return(new Yi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Yi,e,t)}}class zi extends tn{userId="";accessToken="";refreshToken="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.RegisterResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"userId",kind:"scalar",T:9},{no:2,name:"accessToken",kind:"scalar",T:9},{no:3,name:"refreshToken",kind:"scalar",T:9}]));static fromBinary(e,t){return(new zi).fromBinary(e,t)}static fromJson(e,t){return(new zi).fromJson(e,t)}static fromJsonString(e,t){return(new zi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(zi,e,t)}}class Xi extends tn{success=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.UpdatePasswordResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"success",kind:"scalar",T:8}]));static fromBinary(e,t){return(new Xi).fromBinary(e,t)}static fromJson(e,t){return(new Xi).fromJson(e,t)}static fromJsonString(e,t){return(new Xi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Xi,e,t)}}class Qi extends tn{success=!1;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="user.DeleteUserResponse";static fields=vr.util.newFieldList((()=>[{no:1,name:"success",kind:"scalar",T:8}]));static fromBinary(e,t){return(new Qi).fromBinary(e,t)}static fromJson(e,t){return(new Qi).fromJson(e,t)}static fromJsonString(e,t){return(new Qi).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(Qi,e,t)}}Object.freeze({__proto__:null,DeleteUserRequest:Ji,DeleteUserResponse:Qi,LoginRequest:Gi,LoginResponse:Yi,RegisterRequest:Hi,RegisterResponse:zi,UpdatePasswordRequest:Wi,UpdatePasswordResponse:Xi});const Zi={typeName:"user.UserService",methods:{login:{name:"Login",I:Gi,O:Yi,kind:br.Unary},register:{name:"Register",I:Hi,O:zi,kind:br.Unary},updatePassword:{name:"UpdatePassword",I:Wi,O:Xi,kind:br.Unary},deleteUser:{name:"DeleteUser",I:Ji,O:Qi,kind:br.Unary}}};Object.freeze({__proto__:null,UserService:Zi});class es extends tn{baseResponse;data="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="livechat.VersionRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"baseResponse",kind:"message",T:Pr},{no:2,name:"data",kind:"scalar",T:9}]));static fromBinary(e,t){return(new es).fromBinary(e,t)}static fromJson(e,t){return(new es).fromJson(e,t)}static fromJsonString(e,t){return(new es).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(es,e,t)}}Object.freeze({__proto__:null,VersionRes:es});const ts={typeName:"livechat.VersionService",methods:{version:{name:"Version",I:Cr,O:es,kind:br.Unary}}};var ns;Object.freeze({__proto__:null,VersionService:ts});class rs extends tn{service="";constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="grpc.health.v1.HealthCheckReq";static fields=vr.util.newFieldList((()=>[{no:1,name:"service",kind:"scalar",T:9}]));static fromBinary(e,t){return(new rs).fromBinary(e,t)}static fromJson(e,t){return(new rs).fromJson(e,t)}static fromJsonString(e,t){return(new rs).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(rs,e,t)}}class is extends tn{status=ns.UNKNOWN;constructor(e){super(),vr.util.initPartial(e,this)}static runtime=vr;static typeName="grpc.health.v1.HealthCheckRes";static fields=vr.util.newFieldList((()=>[{no:1,name:"status",kind:"enum",T:vr.getEnumType(ns)}]));static fromBinary(e,t){return(new is).fromBinary(e,t)}static fromJson(e,t){return(new is).fromJson(e,t)}static fromJsonString(e,t){return(new is).fromJsonString(e,t)}static equals(e,t){return vr.util.equals(is,e,t)}}!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SERVING=1]="SERVING",e[e.NOT_SERVING=2]="NOT_SERVING",e[e.SERVICE_UNKNOWN=3]="SERVICE_UNKNOWN"}(ns||(ns={})),vr.util.setEnumType(ns,"grpc.health.v1.HealthCheckRes.ServingStatus",[{no:0,name:"UNKNOWN"},{no:1,name:"SERVING"},{no:2,name:"NOT_SERVING"},{no:3,name:"SERVICE_UNKNOWN"}]),Object.freeze({__proto__:null,HealthCheckReq:rs,HealthCheckRes:is,get HealthCheckRes_ServingStatus(){return ns}});const ss={typeName:"grpc.health.v1.Health",methods:{check:{name:"Check",I:rs,O:is,kind:br.Unary}}};function os(e){return os="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},os(e)}function as(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function cs(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?as(Object(n),!0).forEach((function(t){ls(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):as(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ls(e,t,n){return(t=gs(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function us(){us=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof v?t:v,o=Object.create(s.prototype),a=new C(r||[]);return i(o,"_invoke",{value:T(e,n,a)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",g="executing",f="completed",m={};function v(){}function y(){}function _(){}var b={};l(b,o,(function(){return this}));var E=Object.getPrototypeOf,A=E&&E(E(P([])));A&&A!==n&&r.call(A,o)&&(b=A);var S=_.prototype=v.prototype=Object.create(b);function w(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function I(e,t){function n(i,s,o,a){var c=d(e[i],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==os(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var s;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return s=s?s.then(i,i):i()}})}function T(t,n,r){var i=h;return function(s,o){if(i===g)throw Error("Generator is already running");if(i===f){if("throw"===s)throw o;return{value:e,done:!0}}for(r.method=s,r.arg=o;;){var a=r.delegate;if(a){var c=k(a,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===h)throw i=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=g;var l=d(t,n,r);if("normal"===l.type){if(i=r.done?f:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=f,r.method="throw",r.arg=l.arg)}}}function k(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var s=d(i,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,m;var o=s.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function P(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,s=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(os(t)+" is not iterable")}return y.prototype=_,i(S,"constructor",{value:_,configurable:!0}),i(_,"constructor",{value:y,configurable:!0}),y.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},w(I.prototype),l(I.prototype,a,(function(){return this})),t.AsyncIterator=I,t.async=function(e,n,r,i,s){void 0===s&&(s=Promise);var o=new I(u(e,n,r,i),s);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},w(S),l(S,c,"Generator"),l(S,o,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=P,C.prototype={constructor:C,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(O),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return a.type="throw",a.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,m):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;O(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:P(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function ds(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function hs(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){ds(s,r,i,o,a,"next",e)}function a(e){ds(s,r,i,o,a,"throw",e)}o(void 0)}))}}function ps(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,gs(r.key),r)}}function gs(e){var t=function(e){if("object"!=os(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=os(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==os(t)?t:t+""}Object.freeze({__proto__:null,Health:ss});var fs=function(){return function(e,t){return t&&ps(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}((function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}),[{key:"init",value:function(){this.baseUrl=c.gRPCBaseUrl?String(c.gRPCBaseUrl):_[3].gRPCBaseUrl,this.transport=Ht({baseUrl:this.baseUrl}),this.client=z(xi.LiveChatService,this.transport)}},{key:"loginOrRegister",value:(s=hs(us().mark((function e(t){var n,r;return us().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={playerId:t.playerId,guestName:t.guestName},t.playerId&&(n.playerId=t.playerId),t.isDevDebug&&console.log("AiLC -- gRPC -- login request:",n),e.next=6,this.client.loginOrRegister(n);case 6:return r=e.sent,t.isDevDebug&&console.log("AiLC -- gRPC -- login response:",r),e.abrupt("return",{accessToken:r.accessToken,roomId:r.roomId,guestName:r.guestName||null,liveChatName:r.liveChatName||null,refreshToken:r.refreshToken});case 11:throw e.prev=11,e.t0=e.catch(0),console.error("Error fetching live chat config:",e.t0),O.errorOccurred(),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(e){return s.apply(this,arguments)})},{key:"getLiveChatConfig",value:(i=hs(us().mark((function e(){var t;return us().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.client.getLiveChatConfig();case 3:return t=e.sent,c.isDevDebug&&console.log("AiLC -- gRPC -- getLiveChatConfig response:",t),e.abrupt("return",t||{conversationTimeout:10});case 8:throw e.prev=8,e.t0=e.catch(0),console.error("Error request get live chat config from gRPC:",e.t0),e.t0;case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(){return i.apply(this,arguments)})},{key:"sendMessage",value:(r=hs(us().mark((function e(t,n,r){var i,s,o,a;return us().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=cs(cs(cs(cs({playerId:n.playerId,accessToken:n.accessToken,roomId:n.roomId},t&&{message:t}),n.guestName&&{guestName:n.guestName}),n.conversationId&&{conversationId:n.conversationId}),r&&{transferLiveAgent:r}),n.isDevDebug&&console.log("AiLC -- gRPC -- Message sent:",o),e.next=5,this.client.message(o);case 5:if(!((null==(a=e.sent)||null===(i=a.baseResponse)||void 0===i?void 0:i.status)<200||(null==a||null===(s=a.baseResponse)||void 0===s?void 0:s.status)>=400)){e.next=9;break}throw O.errorOccurred(),new Error("Error ".concat(a.baseResponse.status,": ").concat(a.baseResponse.message));case 9:return e.abrupt("return",a);case 12:throw e.prev=12,e.t0=e.catch(0),console.error("Error sending message:",e.t0),O.errorOccurred(),e.t0;case 17:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(e,t,n){return r.apply(this,arguments)})},{key:"sendMedia",value:(n=hs(us().mark((function e(t,n){var r,i,s,o;return us().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=cs(cs({playerId:n.playerId,accessToken:n.accessToken,roomId:n.roomId,photoUrl:t},n.guestName&&{guestName:n.guestName}),n.conversationId&&{conversationId:n.conversationId}),n.isDevDebug&&console.log("AiLC -- gRPC -- Media message sent:",s),e.next=5,this.client.message(s);case 5:if(o=e.sent,n.isDevDebug&&console.log("AiLC -- gRPC -- Media message response:",o),!((null==o||null===(r=o.baseResponse)||void 0===r?void 0:r.status)<200||(null==o||null===(i=o.baseResponse)||void 0===i?void 0:i.status)>=400)){e.next=10;break}throw O.errorOccurred(),new Error("Error ".concat(o.baseResponse.status,": ").concat(o.baseResponse.message));case 10:return e.abrupt("return",o);case 13:throw e.prev=13,e.t0=e.catch(0),console.error("Error sending media to gRPC:",e.t0),O.errorOccurred(),e.t0;case 18:case"end":return e.stop()}}),e,this,[[0,13]])}))),function(e,t){return n.apply(this,arguments)})},{key:"rateReview",value:(t=hs(us().mark((function e(t){var n,r,i,s,o;return us().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.rating,r=t.message,i=t.widgetState,e.prev=1,s={conversationId:i.conversationId,roomId:i.roomId,agentName:i.agentName,message:r,rating:+n},e.next=5,this.client.rateReview(s);case 5:return o=e.sent,i.isDevDebug&&console.log("AiLC -- gRPC -- rateReview response:",o),e.abrupt("return",o);case 10:throw e.prev=10,e.t0=e.catch(1),console.error("Error request rate and review from gRPC:",e.t0),e.t0;case 14:case"end":return e.stop()}}),e,this,[[1,10]])}))),function(e){return t.apply(this,arguments)})},{key:"endSession",value:(e=hs(us().mark((function e(t,n){var r,i;return us().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=cs(cs(cs({},t.playerId&&{playerId:t.playerId}),{},{roomId:t.roomId,accessToken:t.accessToken,agentName:n},t.playerName&&{playerName:t.playerName}),t.guestName&&{guestName:t.guestName}),t.isDevDebug&&console.log("AiLC -- gRPC -- endSession grpc:",r),e.next=5,this.client.endSession(r);case 5:return i=e.sent,t.isDevDebug&&console.log("AiLC -- gRPC -- endSession response:",i),e.abrupt("return",i);case 10:throw e.prev=10,e.t0=e.catch(0),console.error("Error request end session from gRPC:",e.t0),e.t0;case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(t,n){return e.apply(this,arguments)})}]);var e,t,n,r,i,s}(),ms=new fs,vs=!1,ys=!1,_s={x:0,y:0},bs={x:0,y:0},Es=!0,As=null;function Ss(e){e.preventDefault(),vs=!0,ys=!0,Es=!1;var t=e.clientX||(e.touches?e.touches[0].clientX:0),n=e.clientY||(e.touches?e.touches[0].clientY:0);_s.x=t-bs.x,_s.y=n-bs.y,window.addEventListener("mousemove",ws),window.addEventListener("touchmove",ws,{passive:!1}),window.addEventListener("mouseup",Is),window.addEventListener("touchend",Is)}function ws(e){if(ys){var t=e.clientX||(e.touches?e.touches[0].clientX:0),n=e.clientY||(e.touches?e.touches[0].clientY:0),r=Math.abs(t-(bs.x+_s.x)),i=Math.abs(n-(bs.y+_s.y));(r>5||i>5)&&(vs=!1,e.preventDefault()),bs.x=t-_s.x,bs.y=n-_s.y,Ts()}}function Is(){var e,t,n,r;ys=!1,Es=!0,n=window.innerHeight,r=document.querySelector(".btn-livechat").clientHeight,bs.y<18?bs.y=18:bs.y>n-r-18&&(bs.y=n-r-18),e=window.innerWidth,t=document.querySelector(".btn-livechat").clientWidth,bs.x<e/2?bs.x=18:bs.x=e-t-18,Ts();var i=document.querySelector(".btn-livechat");window.removeEventListener("mousemove",ws),window.removeEventListener("mouseup",Is),window.removeEventListener("touchmove",ws),window.removeEventListener("touchend",Is),!ys&&vs&&i.addEventListener("click",As())}function Ts(){var e=document.querySelector(".btn-livechat");e.style.transition=Es?"left 0.5s ease, top 0.5s ease":"none",e.style.left="".concat(bs.x,"px"),e.style.top="".concat(bs.y,"px")}function ks(){var e=document.querySelector(".btn-livechat");if(e){var t=e.getBoundingClientRect();(t.right<0||t.bottom<0||t.left>window.innerWidth||t.top>window.innerHeight)&&(bs.x=window.innerWidth-e.clientWidth-18,bs.y=window.innerHeight-e.clientHeight-55,Ts())}}var Rs,Os="undefined"!=typeof window?window:void 0,Cs="undefined"!=typeof globalThis?globalThis:Os,Ps=Array.prototype,Ds=Ps.forEach,Ns=Ps.indexOf,xs=null==Cs?void 0:Cs.navigator,Ms=null==Cs?void 0:Cs.document,Ls=null==Cs?void 0:Cs.location,Bs=null==Cs?void 0:Cs.fetch,Us=null!=Cs&&Cs.XMLHttpRequest&&"withCredentials"in new Cs.XMLHttpRequest?Cs.XMLHttpRequest:void 0,Fs=null==Cs?void 0:Cs.AbortController,js=null==xs?void 0:xs.userAgent,qs=null!=Os?Os:{},Ks={DEBUG:!1,LIB_VERSION:"1.219.6"},$s="$copy_autocapture",Vs=["$snapshot","$pageview","$pageleave","$set","survey dismissed","survey sent","survey shown","$identify","$groupidentify","$create_alias","$$client_ingestion_warning","$web_experiment_applied","$feature_enrollment_update","$feature_flag_called"];function Gs(e,t){return-1!==e.indexOf(t)}!function(e){e.GZipJS="gzip-js",e.Base64="base64"}(Rs||(Rs={}));var Hs=function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},Ws=function(e){return e.replace(/^\$/,"")},Js=Array.isArray,Ys=Object.prototype,zs=Ys.hasOwnProperty,Xs=Ys.toString,Qs=Js||function(e){return"[object Array]"===Xs.call(e)},Zs=e=>"function"==typeof e,eo=e=>e===Object(e)&&!Qs(e),to=e=>{if(eo(e)){for(var t in e)if(zs.call(e,t))return!1;return!0}return!1},no=e=>void 0===e,ro=e=>"[object String]"==Xs.call(e),io=e=>ro(e)&&0===e.trim().length,so=e=>null===e,oo=e=>no(e)||so(e),ao=e=>"[object Number]"==Xs.call(e),co=e=>"[object Boolean]"===Xs.call(e),lo=e=>e instanceof Error,uo=e=>Gs(Vs,e),ho=e=>{var t={_log:function(t){if(Os&&(Ks.DEBUG||qs.POSTHOG_DEBUG)&&!no(Os.console)&&Os.console){for(var n=("__rrweb_original__"in Os.console[t]?Os.console[t].__rrweb_original__:Os.console[t]),r=arguments.length,i=new Array(r>1?r-1:0),s=1;s<r;s++)i[s-1]=arguments[s];n(e,...i)}},info:function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];t._log("log",...n)},warn:function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];t._log("warn",...n)},error:function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];t._log("error",...n)},critical:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];console.error(e,...n)},uninitializedWarning:e=>{t.error("You must initialize PostHog before calling ".concat(e))},createLogger:t=>ho("".concat(e," ").concat(t))};return t},po=ho("[PostHog.js]"),go=po.createLogger,fo=go("[ExternalScriptsLoader]"),mo=(e,t,n)=>{if(e.config.disable_external_dependency_loading)return fo.warn("".concat(t," was requested but loading of external scripts is disabled.")),n("Loading of external scripts is disabled");var r=()=>{if(!Ms)return n("document not found");var r=Ms.createElement("script");if(r.type="text/javascript",r.crossOrigin="anonymous",r.src=t,r.onload=e=>n(void 0,e),r.onerror=e=>n(e),e.config.prepare_external_dependency_script&&(r=e.config.prepare_external_dependency_script(r)),!r)return n("prepare_external_dependency_script returned null");var i,s=Ms.querySelectorAll("body > script");s.length>0?null===(i=s[0].parentNode)||void 0===i||i.insertBefore(r,s[0]):Ms.body.appendChild(r)};null!=Ms&&Ms.body?r():null==Ms||Ms.addEventListener("DOMContentLoaded",r)};function vo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function yo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vo(Object(n),!0).forEach((function(t){_o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function bo(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}qs.__PosthogExtensions__=qs.__PosthogExtensions__||{},qs.__PosthogExtensions__.loadExternalDependency=(e,t,n)=>{var r="/static/".concat(t,".js")+"?v=".concat(e.version);if("remote-config"===t&&(r="/array/".concat(e.config.token,"/config.js")),"toolbar"===t){var i=3e5,s=Math.floor(Date.now()/i)*i;r="".concat(r,"&t=").concat(s)}var o=e.requestRouter.endpointFor("assets",r);mo(e,o,n)},qs.__PosthogExtensions__.loadSiteApp=(e,t,n)=>{var r=e.requestRouter.endpointFor("api",t);mo(e,r,n)};var Eo={};function Ao(e,t,n){if(Qs(e))if(Ds&&e.forEach===Ds)e.forEach(t,n);else if("length"in e&&e.length===+e.length)for(var r=0,i=e.length;r<i;r++)if(r in e&&t.call(n,e[r],r)===Eo)return}function So(e,t,n){if(!oo(e)){if(Qs(e))return Ao(e,t,n);if((e=>e instanceof FormData)(e)){for(var r of e.entries())if(t.call(n,r[1],r[0])===Eo)return}else for(var i in e)if(zs.call(e,i)&&t.call(n,e[i],i)===Eo)return}}var wo=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Ao(n,(function(t){for(var n in t)void 0!==t[n]&&(e[n]=t[n])})),e},Io=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Ao(n,(function(t){Ao(t,(function(t){e.push(t)}))})),e};function To(e){for(var t=Object.keys(e),n=t.length,r=new Array(n);n--;)r[n]=[t[n],e[t[n]]];return r}var ko=function(e){try{return e()}catch(e){return}},Ro=function(e){return function(){try{for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.apply(this,n)}catch(e){po.critical("Implementation error. Please turn on debug mode and open a ticket on https://app.posthog.com/home#panel=support%3Asupport%3A."),po.critical(e)}}},Oo=function(e){var t={};return So(e,(function(e,n){ro(e)&&e.length>0&&(t[n]=e)})),t},Co=["herokuapp.com","vercel.app","netlify.app"];function Po(e){var t=null==e?void 0:e.hostname;if(!ro(t))return!1;var n=t.split(".").slice(-2).join(".");for(var r of Co)if(n===r)return!1;return!0}function Do(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n]}function No(e,t,n,r){var{capture:i=!1,passive:s=!0}=null!=r?r:{};null==e||e.addEventListener(t,n,{capture:i,passive:s})}var xo="$people_distinct_id",Mo="__alias",Lo="__timers",Bo="$autocapture_disabled_server_side",Uo="$heatmaps_enabled_server_side",Fo="$exception_capture_enabled_server_side",jo="$web_vitals_enabled_server_side",qo="$dead_clicks_enabled_server_side",Ko="$web_vitals_allowed_metrics",$o="$session_recording_enabled_server_side",Vo="$console_log_recording_enabled_server_side",Go="$session_recording_network_payload_capture",Ho="$session_recording_canvas_recording",Wo="$replay_sample_rate",Jo="$replay_minimum_duration",Yo="$replay_script_config",zo="$sesid",Xo="$session_is_sampled",Qo="$session_recording_url_trigger_activated_session",Zo="$session_recording_event_trigger_activated_session",ea="$enabled_feature_flags",ta="$early_access_features",na="$stored_person_properties",ra="$stored_group_properties",ia="$surveys",sa="$surveys_activated",oa="$flag_call_reported",aa="$user_state",ca="$client_session_props",la="$capture_rate_limit",ua="$initial_campaign_params",da="$initial_referrer_info",ha="$initial_person_info",pa="$epp",ga="__POSTHOG_TOOLBAR__",fa="$posthog_cookieless",ma=[xo,Mo,"__cmpns",Lo,$o,Uo,zo,ea,aa,ta,ra,na,ia,oa,ca,la,ua,da,pa],va=go("[FeatureFlags]"),ya="$active_feature_flags",_a="$override_feature_flags",ba="$feature_flag_payloads",Ea="$override_feature_flag_payloads",Aa=e=>{var t={};for(var[n,r]of To(e||{}))r&&(t[n]=r);return t};class Sa{constructor(e){_o(this,"_override_warning",!1),_o(this,"_hasLoadedFlags",!1),_o(this,"_requestInFlight",!1),_o(this,"_reloadingDisabled",!1),_o(this,"_additionalReloadRequested",!1),_o(this,"_decideCalled",!1),_o(this,"_flagsLoadedFromRemote",!1),this.instance=e,this.featureFlagEventHandlers=[]}decide(){if(this.instance.config.__preview_remote_config)this._decideCalled=!0;else{var e=!this._reloadDebouncer&&(this.instance.config.advanced_disable_feature_flags||this.instance.config.advanced_disable_feature_flags_on_first_load);this._callDecideEndpoint({disableFlags:e})}}get hasLoadedFlags(){return this._hasLoadedFlags}getFlags(){return Object.keys(this.getFlagVariants())}getFlagVariants(){var e=this.instance.get_property(ea),t=this.instance.get_property(_a);if(!t)return e||{};for(var n=wo({},e),r=Object.keys(t),i=0;i<r.length;i++)n[r[i]]=t[r[i]];return this._override_warning||(va.warn(" Overriding feature flags!",{enabledFlags:e,overriddenFlags:t,finalFlags:n}),this._override_warning=!0),n}getFlagPayloads(){var e=this.instance.get_property(ba),t=this.instance.get_property(Ea);if(!t)return e||{};for(var n=wo({},e||{}),r=Object.keys(t),i=0;i<r.length;i++)n[r[i]]=t[r[i]];return this._override_warning||(va.warn(" Overriding feature flag payloads!",{flagPayloads:e,overriddenPayloads:t,finalPayloads:n}),this._override_warning=!0),n}reloadFeatureFlags(){this._reloadingDisabled||this.instance.config.advanced_disable_feature_flags||this._reloadDebouncer||(this._reloadDebouncer=setTimeout((()=>{this._callDecideEndpoint()}),5))}clearDebouncer(){clearTimeout(this._reloadDebouncer),this._reloadDebouncer=void 0}ensureFlagsLoaded(){this._hasLoadedFlags||this._requestInFlight||this._reloadDebouncer||this.reloadFeatureFlags()}setAnonymousDistinctId(e){this.$anon_distinct_id=e}setReloadingPaused(e){this._reloadingDisabled=e}_callDecideEndpoint(e){if(this.clearDebouncer(),!this.instance.config.advanced_disable_decide)if(this._requestInFlight)this._additionalReloadRequested=!0;else{var t={token:this.instance.config.token,distinct_id:this.instance.get_distinct_id(),groups:this.instance.getGroups(),$anon_distinct_id:this.$anon_distinct_id,person_properties:this.instance.get_property(na),group_properties:this.instance.get_property(ra)};(null!=e&&e.disableFlags||this.instance.config.advanced_disable_feature_flags)&&(t.disable_flags=!0),this._requestInFlight=!0,this.instance._send_request({method:"POST",url:this.instance.requestRouter.endpointFor("api","/decide/?v=3"),data:t,compression:this.instance.config.disable_compression?void 0:Rs.Base64,timeout:this.instance.config.feature_flag_request_timeout_ms,callback:e=>{var n,r,i=!0;200===e.statusCode&&(this.$anon_distinct_id=void 0,i=!1),this._requestInFlight=!1,this._decideCalled||(this._decideCalled=!0,this.instance._onRemoteConfig(null!==(r=e.json)&&void 0!==r?r:{})),t.disable_flags||(this._flagsLoadedFromRemote=!i,this.receivedFeatureFlags(null!==(n=e.json)&&void 0!==n?n:{},i),this._additionalReloadRequested&&(this._additionalReloadRequested=!1,this._callDecideEndpoint()))}})}}getFeatureFlag(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this._hasLoadedFlags||this.getFlags()&&this.getFlags().length>0){var n,r,i,s,o,a=this.getFlagVariants()[e],c="".concat(a),l=this.instance.get_property(oa)||{};return!t.send_event&&"send_event"in t||e in l&&l[e].includes(c)||(Qs(l[e])?l[e].push(c):l[e]=[c],null===(n=this.instance.persistence)||void 0===n||n.register({[oa]:l}),this.instance.capture("$feature_flag_called",{$feature_flag:e,$feature_flag_response:a,$feature_flag_payload:this.getFeatureFlagPayload(e)||null,$feature_flag_bootstrapped_response:(null===(r=this.instance.config.bootstrap)||void 0===r||null===(i=r.featureFlags)||void 0===i?void 0:i[e])||null,$feature_flag_bootstrapped_payload:(null===(s=this.instance.config.bootstrap)||void 0===s||null===(o=s.featureFlagPayloads)||void 0===o?void 0:o[e])||null,$used_bootstrap_value:!this._flagsLoadedFromRemote})),a}va.warn('getFeatureFlag for key "'+e+"\" failed. Feature flags didn't load in time.")}getFeatureFlagPayload(e){return this.getFlagPayloads()[e]}getRemoteConfigPayload(e,t){var n=this.instance.config.token;this.instance._send_request({method:"POST",url:this.instance.requestRouter.endpointFor("api","/decide/?v=3"),data:{distinct_id:this.instance.get_distinct_id(),token:n},compression:this.instance.config.disable_compression?void 0:Rs.Base64,timeout:this.instance.config.feature_flag_request_timeout_ms,callback:n=>{var r,i=null===(r=n.json)||void 0===r?void 0:r.featureFlagPayloads;t((null==i?void 0:i[e])||void 0)}})}isFeatureEnabled(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this._hasLoadedFlags||this.getFlags()&&this.getFlags().length>0)return!!this.getFeatureFlag(e,t);va.warn('isFeatureEnabled for key "'+e+"\" failed. Feature flags didn't load in time.")}addFeatureFlagsHandler(e){this.featureFlagEventHandlers.push(e)}removeFeatureFlagsHandler(e){this.featureFlagEventHandlers=this.featureFlagEventHandlers.filter((t=>t!==e))}receivedFeatureFlags(e,t){if(this.instance.persistence){this._hasLoadedFlags=!0;var n=this.getFlagVariants(),r=this.getFlagPayloads();!function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=e.featureFlags,s=e.featureFlagPayloads;if(i)if(Qs(i)){var o={};if(i)for(var a=0;a<i.length;a++)o[i[a]]=!0;t&&t.register({[ya]:i,[ea]:o})}else{var c=i,l=s;e.errorsWhileComputingFlags&&(c=yo(yo({},n),c),l=yo(yo({},r),l)),t&&t.register({[ya]:Object.keys(Aa(c)),[ea]:c||{},[ba]:l||{}})}}(e,this.instance.persistence,n,r),this._fireFeatureFlagsCallbacks(t)}}override(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];va.warn("override is deprecated. Please use overrideFeatureFlags instead."),this.overrideFeatureFlags({flags:e,suppressWarning:t})}overrideFeatureFlags(e){if(!this.instance.__loaded||!this.instance.persistence)return va.uninitializedWarning("posthog.feature_flags.overrideFeatureFlags");if(!1===e)return this.instance.persistence.unregister(_a),this.instance.persistence.unregister(Ea),void this._fireFeatureFlagsCallbacks();if(e&&"object"==typeof e&&("flags"in e||"payloads"in e)){var t,n=e;if(this._override_warning=Boolean(null!==(t=n.suppressWarning)&&void 0!==t&&t),"flags"in n)if(!1===n.flags)this.instance.persistence.unregister(_a);else if(n.flags)if(Qs(n.flags)){for(var r={},i=0;i<n.flags.length;i++)r[n.flags[i]]=!0;this.instance.persistence.register({[_a]:r})}else this.instance.persistence.register({[_a]:n.flags});return"payloads"in n&&(!1===n.payloads?this.instance.persistence.unregister(Ea):n.payloads&&this.instance.persistence.register({[Ea]:n.payloads})),void this._fireFeatureFlagsCallbacks()}this._fireFeatureFlagsCallbacks()}onFeatureFlags(e){if(this.addFeatureFlagsHandler(e),this._hasLoadedFlags){var{flags:t,flagVariants:n}=this._prepareFeatureFlagsForCallbacks();e(t,n)}return()=>this.removeFeatureFlagsHandler(e)}updateEarlyAccessFeatureEnrollment(e,t){var n,r=(this.instance.get_property(ta)||[]).find((t=>t.flagKey===e)),i={["$feature_enrollment/".concat(e)]:t},s={$feature_flag:e,$feature_enrollment:t,$set:i};r&&(s.$early_access_feature_name=r.name),this.instance.capture("$feature_enrollment_update",s),this.setPersonPropertiesForFlags(i,!1);var o=yo(yo({},this.getFlagVariants()),{},{[e]:t});null===(n=this.instance.persistence)||void 0===n||n.register({[ya]:Object.keys(Aa(o)),[ea]:o}),this._fireFeatureFlagsCallbacks()}getEarlyAccessFeatures(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.instance.get_property(ta);if(n&&!t)return e(n);this.instance._send_request({url:this.instance.requestRouter.endpointFor("api","/api/early_access_features/?token=".concat(this.instance.config.token)),method:"GET",callback:t=>{var n;if(t.json){var r=t.json.earlyAccessFeatures;return null===(n=this.instance.persistence)||void 0===n||n.register({[ta]:r}),e(r)}}})}_prepareFeatureFlagsForCallbacks(){var e=this.getFlags(),t=this.getFlagVariants();return{flags:e.filter((e=>t[e])),flagVariants:Object.keys(t).filter((e=>t[e])).reduce(((e,n)=>(e[n]=t[n],e)),{})}}_fireFeatureFlagsCallbacks(e){var{flags:t,flagVariants:n}=this._prepareFeatureFlagsForCallbacks();this.featureFlagEventHandlers.forEach((r=>r(t,n,{errorsLoading:e})))}setPersonPropertiesForFlags(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.instance.get_property(na)||{};this.instance.register({[na]:yo(yo({},n),e)}),t&&this.instance.reloadFeatureFlags()}resetPersonPropertiesForFlags(){this.instance.unregister(na)}setGroupPropertiesForFlags(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.instance.get_property(ra)||{};0!==Object.keys(n).length&&Object.keys(n).forEach((t=>{n[t]=yo(yo({},n[t]),e[t]),delete e[t]})),this.instance.register({[ra]:yo(yo({},n),e)}),t&&this.instance.reloadFeatureFlags()}resetGroupPropertiesForFlags(e){if(e){var t=this.instance.get_property(ra)||{};this.instance.register({[ra]:yo(yo({},t),{},{[e]:{}})})}else this.instance.unregister(ra)}}Math.trunc||(Math.trunc=function(e){return e<0?Math.ceil(e):Math.floor(e)}),Number.isInteger||(Number.isInteger=function(e){return ao(e)&&isFinite(e)&&Math.floor(e)===e});var wa="0123456789abcdef";class Ia{constructor(e){if(this.bytes=e,16!==e.length)throw new TypeError("not 128-bit length")}static fromFieldsV7(e,t,n,r){if(!Number.isInteger(e)||!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(r)||e<0||t<0||n<0||r<0||e>0xffffffffffff||t>4095||n>1073741823||r>4294967295)throw new RangeError("invalid field value");var i=new Uint8Array(16);return i[0]=e/Math.pow(2,40),i[1]=e/Math.pow(2,32),i[2]=e/Math.pow(2,24),i[3]=e/Math.pow(2,16),i[4]=e/Math.pow(2,8),i[5]=e,i[6]=112|t>>>8,i[7]=t,i[8]=128|n>>>24,i[9]=n>>>16,i[10]=n>>>8,i[11]=n,i[12]=r>>>24,i[13]=r>>>16,i[14]=r>>>8,i[15]=r,new Ia(i)}toString(){for(var e="",t=0;t<this.bytes.length;t++)e=e+wa.charAt(this.bytes[t]>>>4)+wa.charAt(15&this.bytes[t]),3!==t&&5!==t&&7!==t&&9!==t||(e+="-");if(36!==e.length)throw new Error("Invalid UUIDv7 was generated");return e}clone(){return new Ia(this.bytes.slice(0))}equals(e){return 0===this.compareTo(e)}compareTo(e){for(var t=0;t<16;t++){var n=this.bytes[t]-e.bytes[t];if(0!==n)return Math.sign(n)}return 0}}class Ta{constructor(){_o(this,"timestamp",0),_o(this,"counter",0),_o(this,"random",new Oa)}generate(){var e=this.generateOrAbort();if(no(e)){this.timestamp=0;var t=this.generateOrAbort();if(no(t))throw new Error("Could not generate UUID after timestamp reset");return t}return e}generateOrAbort(){var e=Date.now();if(e>this.timestamp)this.timestamp=e,this.resetCounter();else{if(!(e+1e4>this.timestamp))return;this.counter++,this.counter>4398046511103&&(this.timestamp++,this.resetCounter())}return Ia.fromFieldsV7(this.timestamp,Math.trunc(this.counter/Math.pow(2,30)),this.counter&Math.pow(2,30)-1,this.random.nextUint32())}resetCounter(){this.counter=1024*this.random.nextUint32()+(1023&this.random.nextUint32())}}var ka,Ra=e=>{if("undefined"!=typeof UUIDV7_DENY_WEAK_RNG&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");for(var t=0;t<e.length;t++)e[t]=65536*Math.trunc(65536*Math.random())+Math.trunc(65536*Math.random());return e};Os&&!no(Os.crypto)&&crypto.getRandomValues&&(Ra=e=>crypto.getRandomValues(e));class Oa{constructor(){_o(this,"buffer",new Uint32Array(8)),_o(this,"cursor",1/0)}nextUint32(){return this.cursor>=this.buffer.length&&(Ra(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}var Ca=()=>Pa().toString(),Pa=()=>(ka||(ka=new Ta)).generate(),Da="",Na=/[a-z0-9][a-z0-9-]+\.[a-z]{2,}$/i,xa={is_supported:()=>!!Ms,error:function(e){po.error("cookieStore error: "+e)},get:function(e){if(Ms){try{for(var t=e+"=",n=Ms.cookie.split(";").filter((e=>e.length)),r=0;r<n.length;r++){for(var i=n[r];" "==i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return decodeURIComponent(i.substring(t.length,i.length))}}catch(e){}return null}},parse:function(e){var t;try{t=JSON.parse(xa.get(e))||{}}catch(e){}return t},set:function(e,t,n,r,i){if(Ms)try{var s="",o="",a=function(e,t){if(t){var n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ms;if(Da)return Da;if(!t)return"";if(["localhost","127.0.0.1"].includes(e))return"";for(var n=e.split("."),r=Math.min(n.length,8),i="dmn_chk_"+Ca(),s=new RegExp("(^|;)\\s*"+i+"=1");!Da&&r--;){var o=n.slice(r).join("."),a=i+"=1;domain=."+o;t.cookie=a,s.test(t.cookie)&&(t.cookie=a+";expires=Thu, 01 Jan 1970 00:00:00 GMT",Da=o)}return Da}(e);if(!n){var r=(e=>{var t=e.match(Na);return t?t[0]:""})(e);r!==n&&po.info("Warning: cookie subdomain discovery mismatch",r,n),n=r}return n?"; domain=."+n:""}return""}(Ms.location.hostname,r);if(n){var c=new Date;c.setTime(c.getTime()+24*n*60*60*1e3),s="; expires="+c.toUTCString()}i&&(o="; secure");var l=e+"="+encodeURIComponent(JSON.stringify(t))+s+"; SameSite=Lax; path=/"+a+o;return l.length>3686.4&&po.warn("cookieStore warning: large cookie, len="+l.length),Ms.cookie=l,l}catch(e){return}},remove:function(e,t){try{xa.set(e,"",-1,t)}catch(e){return}}},Ma=null,La={is_supported:function(){if(!so(Ma))return Ma;var e=!0;if(no(Os))e=!1;else try{var t="__mplssupport__";La.set(t,"xyz"),'"xyz"'!==La.get(t)&&(e=!1),La.remove(t)}catch(t){e=!1}return e||po.error("localStorage unsupported; falling back to cookie store"),Ma=e,e},error:function(e){po.error("localStorage error: "+e)},get:function(e){try{return null==Os?void 0:Os.localStorage.getItem(e)}catch(e){La.error(e)}return null},parse:function(e){try{return JSON.parse(La.get(e))||{}}catch(e){}return null},set:function(e,t){try{null==Os||Os.localStorage.setItem(e,JSON.stringify(t))}catch(e){La.error(e)}},remove:function(e){try{null==Os||Os.localStorage.removeItem(e)}catch(e){La.error(e)}}},Ba=["distinct_id",zo,Xo,pa,ha],Ua=yo(yo({},La),{},{parse:function(e){try{var t={};try{t=xa.parse(e)||{}}catch(e){}var n=wo(t,JSON.parse(La.get(e)||"{}"));return La.set(e,n),n}catch(e){}return null},set:function(e,t,n,r,i,s){try{La.set(e,t,void 0,void 0,s);var o={};Ba.forEach((e=>{t[e]&&(o[e]=t[e])})),Object.keys(o).length&&xa.set(e,o,n,r,i,s)}catch(e){La.error(e)}},remove:function(e,t){try{null==Os||Os.localStorage.removeItem(e),xa.remove(e,t)}catch(e){La.error(e)}}}),Fa={},ja={is_supported:function(){return!0},error:function(e){po.error("memoryStorage error: "+e)},get:function(e){return Fa[e]||null},parse:function(e){return Fa[e]||null},set:function(e,t){Fa[e]=t},remove:function(e){delete Fa[e]}},qa=null,Ka={is_supported:function(){if(!so(qa))return qa;if(qa=!0,no(Os))qa=!1;else try{var e="__support__";Ka.set(e,"xyz"),'"xyz"'!==Ka.get(e)&&(qa=!1),Ka.remove(e)}catch(e){qa=!1}return qa},error:function(e){po.error("sessionStorage error: ",e)},get:function(e){try{return null==Os?void 0:Os.sessionStorage.getItem(e)}catch(e){Ka.error(e)}return null},parse:function(e){try{return JSON.parse(Ka.get(e))||null}catch(e){}return null},set:function(e,t){try{null==Os||Os.sessionStorage.setItem(e,JSON.stringify(t))}catch(e){Ka.error(e)}},remove:function(e){try{null==Os||Os.sessionStorage.removeItem(e)}catch(e){Ka.error(e)}}},$a=["localhost","127.0.0.1"],Va=e=>{var t=null==Ms?void 0:Ms.createElement("a");return no(t)?null:(t.href=e,t)},Ga=function(e,t){for(var n,r=((e.split("#")[0]||"").split("?")[1]||"").split("&"),i=0;i<r.length;i++){var s=r[i].split("=");if(s[0]===t){n=s;break}}if(!Qs(n)||n.length<2)return"";var o=n[1];try{o=decodeURIComponent(o)}catch(e){po.error("Skipping decoding for malformed query param: "+o)}return o.replace(/\+/g," ")},Ha=function(e,t,n){if(!e||!t||!t.length)return e;for(var r=e.split("#"),i=r[0]||"",s=r[1],o=i.split("?"),a=o[1],c=o[0],l=(a||"").split("&"),u=[],d=0;d<l.length;d++){var h=l[d].split("=");Qs(h)&&(t.includes(h[0])?u.push(h[0]+"="+n):u.push(l[d]))}var p=c;return null!=a&&(p+="?"+u.join("&")),null!=s&&(p+="#"+s),p},Wa=function(e,t){var n=e.match(new RegExp(t+"=([^&]*)"));return n?n[1]:null},Ja="Mobile",Ya="iOS",za="Android",Xa="Tablet",Qa=za+" "+Xa,Za="iPad",ec="Apple",tc=ec+" Watch",nc="Safari",rc="BlackBerry",ic="Samsung",sc=ic+"Browser",oc=ic+" Internet",ac="Chrome",cc=ac+" OS",lc=ac+" "+Ya,uc="Internet Explorer",dc=uc+" "+Ja,hc="Opera",pc=hc+" Mini",gc="Edge",fc="Microsoft "+gc,mc="Firefox",vc=mc+" "+Ya,yc="Nintendo",_c="PlayStation",bc="Xbox",Ec=za+" "+Ja,Ac=Ja+" "+nc,Sc="Windows",wc=Sc+" Phone",Ic="Nokia",Tc="Ouya",kc="Generic",Rc=kc+" "+Ja.toLowerCase(),Oc=kc+" "+Xa.toLowerCase(),Cc="Konqueror",Pc="(\\d+(\\.\\d+)?)",Dc=new RegExp("Version/"+Pc),Nc=new RegExp(bc,"i"),xc=new RegExp(_c+" \\w+","i"),Mc=new RegExp(yc+" \\w+","i"),Lc=new RegExp(rc+"|PlayBook|BB10","i"),Bc={"NT3.51":"NT 3.11","NT4.0":"NT 4.0","5.0":"2000",5.1:"XP",5.2:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1",6.4:"10","10.0":"10"},Uc=function(e,t){return t=t||"",Gs(e," OPR/")&&Gs(e,"Mini")?pc:Gs(e," OPR/")?hc:Lc.test(e)?rc:Gs(e,"IE"+Ja)||Gs(e,"WPDesktop")?dc:Gs(e,sc)?oc:Gs(e,gc)||Gs(e,"Edg/")?fc:Gs(e,"FBIOS")?"Facebook "+Ja:Gs(e,"UCWEB")||Gs(e,"UCBrowser")?"UC Browser":Gs(e,"CriOS")?lc:Gs(e,"CrMo")||Gs(e,ac)?ac:Gs(e,za)&&Gs(e,nc)?Ec:Gs(e,"FxiOS")?vc:Gs(e.toLowerCase(),Cc.toLowerCase())?Cc:((e,t)=>t&&Gs(t,ec)||function(e){return Gs(e,nc)&&!Gs(e,ac)&&!Gs(e,za)}(e))(e,t)?Gs(e,Ja)?Ac:nc:Gs(e,mc)?mc:Gs(e,"MSIE")||Gs(e,"Trident/")?uc:Gs(e,"Gecko")?mc:""},Fc={[dc]:[new RegExp("rv:"+Pc)],[fc]:[new RegExp(gc+"?\\/"+Pc)],[ac]:[new RegExp("("+ac+"|CrMo)\\/"+Pc)],[lc]:[new RegExp("CriOS\\/"+Pc)],"UC Browser":[new RegExp("(UCBrowser|UCWEB)\\/"+Pc)],[nc]:[Dc],[Ac]:[Dc],[hc]:[new RegExp("(Opera|OPR)\\/"+Pc)],[mc]:[new RegExp(mc+"\\/"+Pc)],[vc]:[new RegExp("FxiOS\\/"+Pc)],[Cc]:[new RegExp("Konqueror[:/]?"+Pc,"i")],[rc]:[new RegExp(rc+" "+Pc),Dc],[Ec]:[new RegExp("android\\s"+Pc,"i")],[oc]:[new RegExp(sc+"\\/"+Pc)],[uc]:[new RegExp("(rv:|MSIE )"+Pc)],Mozilla:[new RegExp("rv:"+Pc)]},jc=[[new RegExp(bc+"; "+bc+" (.*?)[);]","i"),e=>[bc,e&&e[1]||""]],[new RegExp(yc,"i"),[yc,""]],[new RegExp(_c,"i"),[_c,""]],[Lc,[rc,""]],[new RegExp(Sc,"i"),(e,t)=>{if(/Phone/.test(t)||/WPDesktop/.test(t))return[wc,""];if(new RegExp(Ja).test(t)&&!/IEMobile\b/.test(t))return[Sc+" "+Ja,""];var n=/Windows NT ([0-9.]+)/i.exec(t);if(n&&n[1]){var r=n[1],i=Bc[r]||"";return/arm/i.test(t)&&(i="RT"),[Sc,i]}return[Sc,""]}],[/((iPhone|iPad|iPod).*?OS (\d+)_(\d+)_?(\d+)?|iPhone)/,e=>{if(e&&e[3]){var t=[e[3],e[4],e[5]||"0"];return[Ya,t.join(".")]}return[Ya,""]}],[/(watch.*\/(\d+\.\d+\.\d+)|watch os,(\d+\.\d+),)/i,e=>{var t="";return e&&e.length>=3&&(t=no(e[2])?e[3]:e[2]),["watchOS",t]}],[new RegExp("("+za+" (\\d+)\\.(\\d+)\\.?(\\d+)?|"+za+")","i"),e=>{if(e&&e[2]){var t=[e[2],e[3],e[4]||"0"];return[za,t.join(".")]}return[za,""]}],[/Mac OS X (\d+)[_.](\d+)[_.]?(\d+)?/i,e=>{var t=["Mac OS X",""];if(e&&e[1]){var n=[e[1],e[2],e[3]||"0"];t[1]=n.join(".")}return t}],[/Mac/i,["Mac OS X",""]],[/CrOS/,[cc,""]],[/Linux|debian/i,["Linux",""]]],qc=function(e){return Mc.test(e)?yc:xc.test(e)?_c:Nc.test(e)?bc:new RegExp(Tc,"i").test(e)?Tc:new RegExp("("+wc+"|WPDesktop)","i").test(e)?wc:/iPad/.test(e)?Za:/iPod/.test(e)?"iPod Touch":/iPhone/.test(e)?"iPhone":/(watch)(?: ?os[,/]|\d,\d\/)[\d.]+/i.test(e)?tc:Lc.test(e)?rc:/(kobo)\s(ereader|touch)/i.test(e)?"Kobo":new RegExp(Ic,"i").test(e)?Ic:/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i.test(e)||/(kf[a-z]+)( bui|\)).+silk\//i.test(e)?"Kindle Fire":/(Android|ZTE)/i.test(e)?!new RegExp(Ja).test(e)||/(9138B|TB782B|Nexus [97]|pixel c|HUAWEISHT|BTV|noble nook|smart ultra 6)/i.test(e)?/pixel[\daxl ]{1,6}/i.test(e)&&!/pixel c/i.test(e)||/(huaweimed-al00|tah-|APA|SM-G92|i980|zte|U304AA)/i.test(e)||/lmy47v/i.test(e)&&!/QTAQZ3/i.test(e)?za:Qa:za:new RegExp("(pda|"+Ja+")","i").test(e)?Rc:new RegExp(Xa,"i").test(e)&&!new RegExp(Xa+" pc","i").test(e)?Oc:""},Kc="https?://(.*)",$c=["gclid","gclsrc","dclid","gbraid","wbraid","fbclid","msclkid","twclid","li_fat_id","igshid","ttclid","rdt_cid","irclid","_kx"],Vc=Io(["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gad_source","mc_cid"],$c),Gc="<masked>",Hc={campaignParams:function(){var{customTrackedParams:e,maskPersonalDataProperties:t,customPersonalDataProperties:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!Ms)return{};var r=t?Io([],$c,n||[]):[];return this._campaignParamsFromUrl(Ha(Ms.URL,r,Gc),e)},_campaignParamsFromUrl:function(e,t){var n=Vc.concat(t||[]),r={};return So(n,(function(t){var n=Ga(e,t);r[t]=n||null})),r},_searchEngine:function(e){return e?0===e.search(Kc+"google.([^/?]*)")?"google":0===e.search(Kc+"bing.com")?"bing":0===e.search(Kc+"yahoo.com")?"yahoo":0===e.search(Kc+"duckduckgo.com")?"duckduckgo":null:null},_searchInfoFromReferrer:function(e){var t=Hc._searchEngine(e),n="yahoo"!=t?"q":"p",r={};if(!so(t)){r.$search_engine=t;var i=Ms?Ga(Ms.referrer,n):"";i.length&&(r.ph_keyword=i)}return r},searchInfo:function(){var e=null==Ms?void 0:Ms.referrer;return e?this._searchInfoFromReferrer(e):{}},browser:Uc,browserVersion:function(e,t){var n=Uc(e,t),r=Fc[n];if(no(r))return null;for(var i=0;i<r.length;i++){var s=r[i],o=e.match(s);if(o)return parseFloat(o[o.length-2])}return null},browserLanguage:function(){return navigator.language||navigator.userLanguage},browserLanguagePrefix:function(){var e=this.browserLanguage();return"string"==typeof e?e.split("-")[0]:void 0},os:function(e){for(var t=0;t<jc.length;t++){var[n,r]=jc[t],i=n.exec(e),s=i&&(Zs(r)?r(i,e):r);if(s)return s}return["",""]},device:qc,deviceType:function(e){var t=qc(e);return t===Za||t===Qa||"Kobo"===t||"Kindle Fire"===t||t===Oc?Xa:t===yc||t===bc||t===_c||t===Tc?"Console":t===tc?"Wearable":t?Ja:"Desktop"},referrer:function(){return(null==Ms?void 0:Ms.referrer)||"$direct"},referringDomain:function(){var e;return null!=Ms&&Ms.referrer&&(null===(e=Va(Ms.referrer))||void 0===e?void 0:e.host)||"$direct"},referrerInfo:function(){return{$referrer:this.referrer(),$referring_domain:this.referringDomain()}},personInfo:function(){var{maskPersonalDataProperties:e,customPersonalDataProperties:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e?Io([],$c,t||[]):[],r=null==Ls?void 0:Ls.href.substring(0,1e3);return{r:this.referrer().substring(0,1e3),u:r?Ha(r,n,Gc):void 0}},personPropsFromInfo:function(e){var t,{r:n,u:r}=e,i={$referrer:n,$referring_domain:null==n?void 0:"$direct"==n?"$direct":null===(t=Va(n))||void 0===t?void 0:t.host};if(r){i.$current_url=r;var s=Va(r);i.$host=null==s?void 0:s.host,i.$pathname=null==s?void 0:s.pathname;var o=this._campaignParamsFromUrl(r);wo(i,o)}if(n){var a=this._searchInfoFromReferrer(n);wo(i,a)}return i},initialPersonPropsFromInfo:function(e){var t=this.personPropsFromInfo(e),n={};return So(t,(function(e,t){n["$initial_".concat(Ws(t))]=e})),n},timezone:function(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){return}},timezoneOffset:function(){try{return(new Date).getTimezoneOffset()}catch(e){return}},properties:function(){var{maskPersonalDataProperties:e,customPersonalDataProperties:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!js)return{};var n=e?Io([],$c,t||[]):[],[r,i]=Hc.os(js);return wo(Oo({$os:r,$os_version:i,$browser:Hc.browser(js,navigator.vendor),$device:Hc.device(js),$device_type:Hc.deviceType(js),$timezone:Hc.timezone(),$timezone_offset:Hc.timezoneOffset()}),{$current_url:Ha(null==Ls?void 0:Ls.href,n,Gc),$host:null==Ls?void 0:Ls.host,$pathname:null==Ls?void 0:Ls.pathname,$raw_user_agent:js.length>1e3?js.substring(0,997)+"...":js,$browser_version:Hc.browserVersion(js,navigator.vendor),$browser_language:Hc.browserLanguage(),$browser_language_prefix:Hc.browserLanguagePrefix(),$screen_height:null==Os?void 0:Os.screen.height,$screen_width:null==Os?void 0:Os.screen.width,$viewport_height:null==Os?void 0:Os.innerHeight,$viewport_width:null==Os?void 0:Os.innerWidth,$lib:"web",$lib_version:Ks.LIB_VERSION,$insert_id:Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10),$time:Date.now()/1e3})},people_properties:function(){if(!js)return{};var[e,t]=Hc.os(js);return wo(Oo({$os:e,$os_version:t,$browser:Hc.browser(js,navigator.vendor)}),{$browser_version:Hc.browserVersion(js,navigator.vendor)})}},Wc=["cookie","localstorage","localstorage+cookie","sessionstorage","memory"];class Jc{constructor(e){this.config=e,this.props={},this.campaign_params_saved=!1,this.name=(e=>{var t="";return e.token&&(t=e.token.replace(/\+/g,"PL").replace(/\//g,"SL").replace(/=/g,"EQ")),e.persistence_name?"ph_"+e.persistence_name:"ph_"+t+"_posthog"})(e),this.storage=this.buildStorage(e),this.load(),e.debug&&po.info("Persistence loaded",e.persistence,yo({},this.props)),this.update_config(e,e),this.save()}buildStorage(e){-1===Wc.indexOf(e.persistence.toLowerCase())&&(po.critical("Unknown persistence type "+e.persistence+"; falling back to localStorage+cookie"),e.persistence="localStorage+cookie");var t=e.persistence.toLowerCase();return"localstorage"===t&&La.is_supported()?La:"localstorage+cookie"===t&&Ua.is_supported()?Ua:"sessionstorage"===t&&Ka.is_supported()?Ka:"memory"===t?ja:"cookie"===t?xa:Ua.is_supported()?Ua:xa}properties(){var e={};return So(this.props,(function(t,n){if(n===ea&&eo(t))for(var r=Object.keys(t),i=0;i<r.length;i++)e["$feature/".concat(r[i])]=t[r[i]];else o=n,a=!1,(so(s=ma)?a:Ns&&s.indexOf===Ns?-1!=s.indexOf(o):(So(s,(function(e){if(a||(a=e===o))return Eo})),a))||(e[n]=t);var s,o,a})),e}load(){if(!this.disabled){var e=this.storage.parse(this.name);e&&(this.props=wo({},e))}}save(){this.disabled||this.storage.set(this.name,this.props,this.expire_days,this.cross_subdomain,this.secure,this.config.debug)}remove(){this.storage.remove(this.name,!1),this.storage.remove(this.name,!0)}clear(){this.remove(),this.props={}}register_once(e,t,n){if(eo(e)){no(t)&&(t="None"),this.expire_days=no(n)?this.default_expiry:n;var r=!1;if(So(e,((e,n)=>{this.props.hasOwnProperty(n)&&this.props[n]!==t||(this.props[n]=e,r=!0)})),r)return this.save(),!0}return!1}register(e,t){if(eo(e)){this.expire_days=no(t)?this.default_expiry:t;var n=!1;if(So(e,((t,r)=>{e.hasOwnProperty(r)&&this.props[r]!==t&&(this.props[r]=t,n=!0)})),n)return this.save(),!0}return!1}unregister(e){e in this.props&&(delete this.props[e],this.save())}update_campaign_params(){if(!this.campaign_params_saved){var e=Hc.campaignParams({customTrackedParams:this.config.custom_campaign_params,maskPersonalDataProperties:this.config.mask_personal_data_properties,customPersonalDataProperties:this.config.custom_personal_data_properties});to(Oo(e))||this.register(e),this.campaign_params_saved=!0}}update_search_keyword(){this.register(Hc.searchInfo())}update_referrer_info(){this.register_once(Hc.referrerInfo(),void 0)}set_initial_person_info(){this.props[ua]||this.props[da]||this.register_once({[ha]:Hc.personInfo({maskPersonalDataProperties:this.config.mask_personal_data_properties,customPersonalDataProperties:this.config.custom_personal_data_properties})},void 0)}get_referrer_info(){return Oo({$referrer:this.props.$referrer,$referring_domain:this.props.$referring_domain})}get_initial_props(){var e={};So([da,ua],(t=>{var n=this.props[t];n&&So(n,(function(t,n){e["$initial_"+Ws(n)]=t}))}));var t=this.props[ha];if(t){var n=Hc.initialPersonPropsFromInfo(t);wo(e,n)}return e}safe_merge(e){return So(this.props,(function(t,n){n in e||(e[n]=t)})),e}update_config(e,t){if(this.default_expiry=this.expire_days=e.cookie_expiration,this.set_disabled(e.disable_persistence),this.set_cross_subdomain(e.cross_subdomain_cookie),this.set_secure(e.secure_cookie),e.persistence!==t.persistence){var n=this.buildStorage(e),r=this.props;this.clear(),this.storage=n,this.props=r,this.save()}}set_disabled(e){this.disabled=e,this.disabled?this.remove():this.save()}set_cross_subdomain(e){e!==this.cross_subdomain&&(this.cross_subdomain=e,this.remove(),this.save())}get_cross_subdomain(){return!!this.cross_subdomain}set_secure(e){e!==this.secure&&(this.secure=e,this.remove(),this.save())}set_event_timer(e,t){var n=this.props[Lo]||{};n[e]=t,this.props[Lo]=n,this.save()}remove_event_timer(e){var t=(this.props[Lo]||{})[e];return no(t)||(delete this.props[Lo][e],this.save()),t}get_property(e){return this.props[e]}set_property(e,t){this.props[e]=t,this.save()}}function Yc(e){var t,n;return(null===(t=JSON.stringify(e,(n=[],function(e,t){if(eo(t)){for(;n.length>0&&n[n.length-1]!==this;)n.pop();return n.includes(t)?"[Circular]":(n.push(t),t)}return t})))||void 0===t?void 0:t.length)||0}function zc(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6606028.8;if(e.size>=t&&e.data.length>1){var n=Math.floor(e.data.length/2),r=e.data.slice(0,n),i=e.data.slice(n);return[zc({size:Yc(r),data:r,sessionId:e.sessionId,windowId:e.windowId}),zc({size:Yc(i),data:i,sessionId:e.sessionId,windowId:e.windowId})].flatMap((e=>e))}return[e]}var Xc=(e=>(e[e.DomContentLoaded=0]="DomContentLoaded",e[e.Load=1]="Load",e[e.FullSnapshot=2]="FullSnapshot",e[e.IncrementalSnapshot=3]="IncrementalSnapshot",e[e.Meta=4]="Meta",e[e.Custom=5]="Custom",e[e.Plugin=6]="Plugin",e))(Xc||{}),Qc=(e=>(e[e.Mutation=0]="Mutation",e[e.MouseMove=1]="MouseMove",e[e.MouseInteraction=2]="MouseInteraction",e[e.Scroll=3]="Scroll",e[e.ViewportResize=4]="ViewportResize",e[e.Input=5]="Input",e[e.TouchMove=6]="TouchMove",e[e.MediaInteraction=7]="MediaInteraction",e[e.StyleSheetRule=8]="StyleSheetRule",e[e.CanvasMutation=9]="CanvasMutation",e[e.Font=10]="Font",e[e.Log=11]="Log",e[e.Drag=12]="Drag",e[e.StyleDeclaration=13]="StyleDeclaration",e[e.Selection=14]="Selection",e[e.AdoptedStyleSheet=15]="AdoptedStyleSheet",e[e.CustomElement=16]="CustomElement",e))(Qc||{});function Zc(e){var t;return e instanceof Element&&(e.id===ga||!(null===(t=e.closest)||void 0===t||!t.call(e,".toolbar-global-fade-container")))}function el(e){return!!e&&1===e.nodeType}function tl(e,t){return!!e&&!!e.tagName&&e.tagName.toLowerCase()===t.toLowerCase()}function nl(e){return!!e&&3===e.nodeType}function rl(e){return!!e&&11===e.nodeType}function il(e){return e?Hs(e).split(/\s+/):[]}function sl(e){var t=null==Os?void 0:Os.location.href;return!!(t&&e&&e.some((e=>t.match(e))))}function ol(e){var t="";switch(typeof e.className){case"string":t=e.className;break;case"object":t=(e.className&&"baseVal"in e.className?e.className.baseVal:null)||e.getAttribute("class")||"";break;default:t=""}return il(t)}function al(e){return oo(e)?null:Hs(e).split(/(\s+)/).filter((e=>bl(e))).join("").replace(/[\r\n]/g," ").replace(/[ ]+/g," ").substring(0,255)}function cl(e){var t="";return hl(e)&&!pl(e)&&e.childNodes&&e.childNodes.length&&So(e.childNodes,(function(e){var n;nl(e)&&e.textContent&&(t+=null!==(n=al(e.textContent))&&void 0!==n?n:"")})),Hs(t)}function ll(e){return no(e.target)?e.srcElement||null:null!==(t=e.target)&&void 0!==t&&t.shadowRoot?e.composedPath()[0]||null:e.target||null;var t}var ul=["a","button","form","input","select","textarea","label"];function dl(e){var t=e.parentNode;return!(!t||!el(t))&&t}function hl(e){for(var t=e;t.parentNode&&!tl(t,"body");t=t.parentNode){var n=ol(t);if(Gs(n,"ph-sensitive")||Gs(n,"ph-no-capture"))return!1}if(Gs(ol(e),"ph-include"))return!0;var r=e.type||"";if(ro(r))switch(r.toLowerCase()){case"hidden":case"password":return!1}var i=e.name||e.id||"";return!ro(i)||!/^cc|cardnum|ccnum|creditcard|csc|cvc|cvv|exp|pass|pwd|routing|seccode|securitycode|securitynum|socialsec|socsec|ssn/i.test(i.replace(/[^a-zA-Z0-9]/g,""))}function pl(e){return!!(tl(e,"input")&&!["button","checkbox","submit","reset"].includes(e.type)||tl(e,"select")||tl(e,"textarea")||"true"===e.getAttribute("contenteditable"))}var gl="(4[0-9]{12}(?:[0-9]{3})?)|(5[1-5][0-9]{14})|(6(?:011|5[0-9]{2})[0-9]{12})|(3[47][0-9]{13})|(3(?:0[0-5]|[68][0-9])[0-9]{11})|((?:2131|1800|35[0-9]{3})[0-9]{11})",fl=new RegExp("^(?:".concat(gl,")$")),ml=new RegExp(gl),vl="\\d{3}-?\\d{2}-?\\d{4}",yl=new RegExp("^(".concat(vl,")$")),_l=new RegExp("(".concat(vl,")"));function bl(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(oo(e))return!1;if(ro(e)){if(e=Hs(e),(t?fl:ml).test((e||"").replace(/[- ]/g,"")))return!1;if((t?yl:_l).test(e))return!1}return!0}function El(e){var t=cl(e);return bl(t="".concat(t," ").concat(Al(e)).trim())?t:""}function Al(e){var t="";return e&&e.childNodes&&e.childNodes.length&&So(e.childNodes,(function(e){var n;if(e&&"span"===(null===(n=e.tagName)||void 0===n?void 0:n.toLowerCase()))try{var r=cl(e);t="".concat(t," ").concat(r).trim(),e.childNodes&&e.childNodes.length&&(t="".concat(t," ").concat(Al(e)).trim())}catch(e){po.error("[AutoCapture]",e)}})),t}function Sl(e){return function(e){var t=e.map((e=>{var t,n,r="";if(e.tag_name&&(r+=e.tag_name),e.attr_class)for(var i of(e.attr_class.sort(),e.attr_class))r+=".".concat(i.replace(/"/g,""));var s=yo(yo(yo(yo({},e.text?{text:e.text}:{}),{},{"nth-child":null!==(t=e.nth_child)&&void 0!==t?t:0,"nth-of-type":null!==(n=e.nth_of_type)&&void 0!==n?n:0},e.href?{href:e.href}:{}),e.attr_id?{attr_id:e.attr_id}:{}),e.attributes),o={};return To(s).sort(((e,t)=>{var[n]=e,[r]=t;return n.localeCompare(r)})).forEach((e=>{var[t,n]=e;return o[wl(t.toString())]=wl(n.toString())})),(r+=":")+To(s).map((e=>{var[t,n]=e;return"".concat(t,'="').concat(n,'"')})).join("")}));return t.join(";")}(function(e){return e.map((e=>{var t,n,r={text:null===(t=e.$el_text)||void 0===t?void 0:t.slice(0,400),tag_name:e.tag_name,href:null===(n=e.attr__href)||void 0===n?void 0:n.slice(0,2048),attr_class:Il(e),attr_id:e.attr__id,nth_child:e.nth_child,nth_of_type:e.nth_of_type,attributes:{}};return To(e).filter((e=>{var[t]=e;return 0===t.indexOf("attr__")})).forEach((e=>{var[t,n]=e;return r.attributes[t]=n})),r}))}(e))}function wl(e){return e.replace(/"|\\"/g,'\\"')}function Il(e){var t=e.attr__class;return t?Qs(t)?t:il(t):void 0}var Tl="[SessionRecording]",kl="redacted",Rl={initiatorTypes:["audio","beacon","body","css","early-hint","embed","fetch","frame","iframe","icon","image","img","input","link","navigation","object","ping","script","track","video","xmlhttprequest"],maskRequestFn:e=>e,recordHeaders:!1,recordBody:!1,recordInitialRequests:!1,recordPerformance:!1,performanceEntryTypeToObserve:["first-input","navigation","paint","resource"],payloadSizeLimitBytes:1e6,payloadHostDenyList:[".lr-ingest.io",".ingest.sentry.io",".clarity.ms","analytics.google.com"]},Ol=["authorization","x-forwarded-for","authorization","cookie","set-cookie","x-api-key","x-real-ip","remote-addr","forwarded","proxy-authorization","x-csrf-token","x-csrftoken","x-xsrf-token"],Cl=["password","secret","passwd","api_key","apikey","auth","credentials","mysql_pwd","privatekey","private_key","token"],Pl=["/s/","/e/","/i/"];function Dl(e,t,n,r){if(oo(e))return e;var i=(null==t?void 0:t["content-length"])||function(e){return new Blob([e]).size}(e);return ro(i)&&(i=parseInt(i)),i>n?Tl+" ".concat(r," body too large to record (").concat(i," bytes)"):e}function Nl(e,t){if(oo(e))return e;var n=e;return bl(n,!1)||(n=Tl+" "+t+" body "+kl),So(Cl,(e=>{var r,i;null!==(r=n)&&void 0!==r&&r.length&&-1!==(null===(i=n)||void 0===i?void 0:i.indexOf(e))&&(n=Tl+" "+t+" body "+kl+" as might contain: "+e)})),n}function xl(e,t,n,r,i){return t>n&&(po.warn("min cannot be greater than max."),t=n),ao(e)?e>n?(r&&po.warn(r+" cannot be  greater than max: "+n+". Using max value instead."),n):e<t?(r&&po.warn(r+" cannot be less than min: "+t+". Using min value instead."),t):e:(r&&po.warn(r+" must be a number. using max or fallback. max: "+n+", fallback: "+i),xl(i||n,t,n,r))}class Ml{constructor(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_o(this,"bucketSize",100),_o(this,"refillRate",10),_o(this,"mutationBuckets",{}),_o(this,"loggedTracker",{}),_o(this,"refillBuckets",(()=>{Object.keys(this.mutationBuckets).forEach((e=>{this.mutationBuckets[e]=this.mutationBuckets[e]+this.refillRate,this.mutationBuckets[e]>=this.bucketSize&&delete this.mutationBuckets[e]}))})),_o(this,"getNodeOrRelevantParent",(e=>{var t=this.rrweb.mirror.getNode(e);if("svg"!==(null==t?void 0:t.nodeName)&&t instanceof Element){var n=t.closest("svg");if(n)return[this.rrweb.mirror.getId(n),n]}return[e,t]})),_o(this,"numberOfChanges",(e=>{var t,n,r,i,s,o,a,c;return(null!==(t=null===(n=e.removes)||void 0===n?void 0:n.length)&&void 0!==t?t:0)+(null!==(r=null===(i=e.attributes)||void 0===i?void 0:i.length)&&void 0!==r?r:0)+(null!==(s=null===(o=e.texts)||void 0===o?void 0:o.length)&&void 0!==s?s:0)+(null!==(a=null===(c=e.adds)||void 0===c?void 0:c.length)&&void 0!==a?a:0)})),_o(this,"throttleMutations",(e=>{if(3!==e.type||0!==e.data.source)return e;var t=e.data,n=this.numberOfChanges(t);t.attributes&&(t.attributes=t.attributes.filter((e=>{var t,n,r,[i,s]=this.getNodeOrRelevantParent(e.id);return 0!==this.mutationBuckets[i]&&(this.mutationBuckets[i]=null!==(t=this.mutationBuckets[i])&&void 0!==t?t:this.bucketSize,this.mutationBuckets[i]=Math.max(this.mutationBuckets[i]-1,0),0===this.mutationBuckets[i]&&(this.loggedTracker[i]||(this.loggedTracker[i]=!0,null===(n=(r=this.options).onBlockedNode)||void 0===n||n.call(r,i,s))),e)})));var r=this.numberOfChanges(t);return 0!==r||n===r?e:void 0})),this.rrweb=e,this.options=r,this.refillRate=xl(null!==(t=this.options.refillRate)&&void 0!==t?t:this.refillRate,0,100,"mutation throttling refill rate"),this.bucketSize=xl(null!==(n=this.options.bucketSize)&&void 0!==n?n:this.bucketSize,0,100,"mutation throttling bucket size"),setInterval((()=>{this.refillBuckets()}),1e3)}}var Ll=Uint8Array,Bl=Uint16Array,Ul=Uint32Array,Fl=new Ll([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),jl=new Ll([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ql=new Ll([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Kl=function(e,t){for(var n=new Bl(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];var i=new Ul(n[30]);for(r=1;r<30;++r)for(var s=n[r];s<n[r+1];++s)i[s]=s-n[r]<<5|r;return[n,i]},$l=Kl(Fl,2),Vl=$l[0],Gl=$l[1];Vl[28]=258,Gl[258]=28;for(var Hl=Kl(jl,0)[1],Wl=new Bl(32768),Jl=0;Jl<32768;++Jl){var Yl=(43690&Jl)>>>1|(21845&Jl)<<1;Yl=(61680&(Yl=(52428&Yl)>>>2|(13107&Yl)<<2))>>>4|(3855&Yl)<<4,Wl[Jl]=((65280&Yl)>>>8|(255&Yl)<<8)>>>1}var zl=function(e,t,n){for(var r=e.length,i=0,s=new Bl(t);i<r;++i)++s[e[i]-1];var o,a=new Bl(t);for(i=0;i<t;++i)a[i]=a[i-1]+s[i-1]<<1;if(n){o=new Bl(1<<t);var c=15-t;for(i=0;i<r;++i)if(e[i])for(var l=i<<4|e[i],u=t-e[i],d=a[e[i]-1]++<<u,h=d|(1<<u)-1;d<=h;++d)o[Wl[d]>>>c]=l}else for(o=new Bl(r),i=0;i<r;++i)o[i]=Wl[a[e[i]-1]++]>>>15-e[i];return o},Xl=new Ll(288);for(Jl=0;Jl<144;++Jl)Xl[Jl]=8;for(Jl=144;Jl<256;++Jl)Xl[Jl]=9;for(Jl=256;Jl<280;++Jl)Xl[Jl]=7;for(Jl=280;Jl<288;++Jl)Xl[Jl]=8;var Ql=new Ll(32);for(Jl=0;Jl<32;++Jl)Ql[Jl]=5;var Zl=zl(Xl,9,0),eu=zl(Ql,5,0),tu=function(e){return(e/8|0)+(7&e&&1)},nu=function(e,t,n){(null==n||n>e.length)&&(n=e.length);var r=new(e instanceof Bl?Bl:e instanceof Ul?Ul:Ll)(n-t);return r.set(e.subarray(t,n)),r},ru=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8},iu=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8,e[r+2]|=n>>>16},su=function(e,t){for(var n=[],r=0;r<e.length;++r)e[r]&&n.push({s:r,f:e[r]});var i=n.length,s=n.slice();if(!i)return[new Ll(0),0];if(1==i){var o=new Ll(n[0].s+1);return o[n[0].s]=1,[o,1]}n.sort((function(e,t){return e.f-t.f})),n.push({s:-1,f:25001});var a=n[0],c=n[1],l=0,u=1,d=2;for(n[0]={s:-1,f:a.f+c.f,l:a,r:c};u!=i-1;)a=n[n[l].f<n[d].f?l++:d++],c=n[l!=u&&n[l].f<n[d].f?l++:d++],n[u++]={s:-1,f:a.f+c.f,l:a,r:c};var h=s[0].s;for(r=1;r<i;++r)s[r].s>h&&(h=s[r].s);var p=new Bl(h+1),g=ou(n[u-1],p,0);if(g>t){r=0;var f=0,m=g-t,v=1<<m;for(s.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));r<i;++r){var y=s[r].s;if(!(p[y]>t))break;f+=v-(1<<g-p[y]),p[y]=t}for(f>>>=m;f>0;){var _=s[r].s;p[_]<t?f-=1<<t-p[_]++-1:++r}for(;r>=0&&f;--r){var b=s[r].s;p[b]==t&&(--p[b],++f)}g=t}return[new Ll(p),g]},ou=function(e,t,n){return-1==e.s?Math.max(ou(e.l,t,n+1),ou(e.r,t,n+1)):t[e.s]=n},au=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new Bl(++t),r=0,i=e[0],s=1,o=function(e){n[r++]=e},a=1;a<=t;++a)if(e[a]==i&&a!=t)++s;else{if(!i&&s>2){for(;s>138;s-=138)o(32754);s>2&&(o(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(o(i),--s;s>6;s-=6)o(8304);s>2&&(o(s-3<<5|8208),s=0)}for(;s--;)o(i);s=1,i=e[a]}return[n.subarray(0,r),t]},cu=function(e,t){for(var n=0,r=0;r<t.length;++r)n+=e[r]*t[r];return n},lu=function(e,t,n){var r=n.length,i=tu(t+2);e[i]=255&r,e[i+1]=r>>>8,e[i+2]=255^e[i],e[i+3]=255^e[i+1];for(var s=0;s<r;++s)e[i+s+4]=n[s];return 8*(i+4+r)},uu=function(e,t,n,r,i,s,o,a,c,l,u){ru(t,u++,n),++i[256];for(var d=su(i,15),h=d[0],p=d[1],g=su(s,15),f=g[0],m=g[1],v=au(h),y=v[0],_=v[1],b=au(f),E=b[0],A=b[1],S=new Bl(19),w=0;w<y.length;++w)S[31&y[w]]++;for(w=0;w<E.length;++w)S[31&E[w]]++;for(var I=su(S,7),T=I[0],k=I[1],R=19;R>4&&!T[ql[R-1]];--R);var O,C,P,D,N=l+5<<3,x=cu(i,Xl)+cu(s,Ql)+o,M=cu(i,h)+cu(s,f)+o+14+3*R+cu(S,T)+(2*S[16]+3*S[17]+7*S[18]);if(N<=x&&N<=M)return lu(t,u,e.subarray(c,c+l));if(ru(t,u,1+(M<x)),u+=2,M<x){O=zl(h,p,0),C=h,P=zl(f,m,0),D=f;var L=zl(T,k,0);for(ru(t,u,_-257),ru(t,u+5,A-1),ru(t,u+10,R-4),u+=14,w=0;w<R;++w)ru(t,u+3*w,T[ql[w]]);u+=3*R;for(var B=[y,E],U=0;U<2;++U){var F=B[U];for(w=0;w<F.length;++w){var j=31&F[w];ru(t,u,L[j]),u+=T[j],j>15&&(ru(t,u,F[w]>>>5&127),u+=F[w]>>>12)}}}else O=Zl,C=Xl,P=eu,D=Ql;for(w=0;w<a;++w)if(r[w]>255){j=r[w]>>>18&31,iu(t,u,O[j+257]),u+=C[j+257],j>7&&(ru(t,u,r[w]>>>23&31),u+=Fl[j]);var q=31&r[w];iu(t,u,P[q]),u+=D[q],q>3&&(iu(t,u,r[w]>>>5&8191),u+=jl[q])}else iu(t,u,O[r[w]]),u+=C[r[w]];return iu(t,u,O[256]),u+C[256]},du=new Ul([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),hu=function(){for(var e=new Ul(256),t=0;t<256;++t){for(var n=t,r=9;--r;)n=(1&n&&3988292384)^n>>>1;e[t]=n}return e}(),pu=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8};function gu(e,t){void 0===t&&(t={});var n=function(){var e=4294967295;return{p:function(t){for(var n=e,r=0;r<t.length;++r)n=hu[255&n^t[r]]^n>>>8;e=n},d:function(){return 4294967295^e}}}(),r=e.length;n.p(e);var i=function(e,t,n){return function(e,t,n,r,i,s){var o=e.length,a=new Ll(r+o+5*(1+Math.floor(o/7e3))+8),c=a.subarray(r,a.length-8),l=0;if(!t||o<8)for(var u=0;u<=o;u+=65535){var d=u+65535;d<o?l=lu(c,l,e.subarray(u,d)):(c[u]=s,l=lu(c,l,e.subarray(u,o)))}else{for(var h=du[t-1],p=h>>>13,g=8191&h,f=(1<<n)-1,m=new Bl(32768),v=new Bl(f+1),y=Math.ceil(n/3),_=2*y,b=function(t){return(e[t]^e[t+1]<<y^e[t+2]<<_)&f},E=new Ul(25e3),A=new Bl(288),S=new Bl(32),w=0,I=0,T=(u=0,0),k=0,R=0;u<o;++u){var O=b(u),C=32767&u,P=v[O];if(m[C]=P,v[O]=C,k<=u){var D=o-u;if((w>7e3||T>24576)&&D>423){l=uu(e,c,0,E,A,S,I,T,R,u-R,l),T=w=I=0,R=u;for(var N=0;N<286;++N)A[N]=0;for(N=0;N<30;++N)S[N]=0}var x=2,M=0,L=g,B=C-P&32767;if(D>2&&O==b(u-B))for(var U=Math.min(p,D)-1,F=Math.min(32767,u),j=Math.min(258,D);B<=F&&--L&&C!=P;){if(e[u+x]==e[u+x-B]){for(var q=0;q<j&&e[u+q]==e[u+q-B];++q);if(q>x){if(x=q,M=B,q>U)break;var K=Math.min(B,q-2),$=0;for(N=0;N<K;++N){var V=u-B+N+32768&32767,G=V-m[V]+32768&32767;G>$&&($=G,P=V)}}}B+=(C=P)-(P=m[C])+32768&32767}if(M){E[T++]=268435456|Gl[x]<<18|Hl[M];var H=31&Gl[x],W=31&Hl[M];I+=Fl[H]+jl[W],++A[257+H],++S[W],k=u+x,++w}else E[T++]=e[u],++A[e[u]]}}l=uu(e,c,s,E,A,S,I,T,R,u-R,l)}return nu(a,0,r+tu(l)+8)}(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,n,0,!0)}(e,t,function(e){return 10+(e.filename&&e.filename.length+1||0)}(t)),s=i.length;return function(e,t){var n=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&pu(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),n){e[3]=8;for(var r=0;r<=n.length;++r)e[r+10]=n.charCodeAt(r)}}(i,t),pu(i,s-8,n.d()),pu(i,s-4,r),i}function fu(e,t){var n=e.length;if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e);for(var r=new Ll(e.length+(e.length>>>1)),i=0,s=function(e){r[i++]=e},o=0;o<n;++o){if(i+5>r.length){var a=new Ll(i+8+(n-o<<1));a.set(r),r=a}var c=e.charCodeAt(o);c<128||t?s(c):c<2048?(s(192|c>>>6),s(128|63&c)):c>55295&&c<57344?(s(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++o))>>>18),s(128|c>>>12&63),s(128|c>>>6&63),s(128|63&c)):(s(224|c>>>12),s(128|c>>>6&63),s(128|63&c))}return nu(r,0,i)}var mu="[SessionRecording]",vu=go(mu),yu=[Qc.MouseMove,Qc.MouseInteraction,Qc.Scroll,Qc.ViewportResize,Qc.Input,Qc.TouchMove,Qc.MediaInteraction,Qc.Drag],_u=e=>({rrwebMethod:e,enqueuedAt:Date.now(),attempt:1});function bu(e){return function(e){for(var t="",n=0;n<e.length;){var r=e[n++];t+=String.fromCharCode(r)}return t}(gu(fu(JSON.stringify(e))))}function Eu(e){return e.type===Xc.Custom&&"sessionIdle"===e.data.tag}function Au(e,t){return t.some((t=>"regex"===t.matching&&new RegExp(t.url).test(e)))}class Su{get sessionIdleThresholdMilliseconds(){return this.instance.config.session_recording.session_idle_threshold_ms||3e5}get rrwebRecord(){var e,t;return null==qs||null===(e=qs.__PosthogExtensions__)||void 0===e||null===(t=e.rrweb)||void 0===t?void 0:t.record}get started(){return this._captureStarted}get sessionManager(){if(!this.instance.sessionManager)throw new Error(mu+" must be started with a valid sessionManager.");return this.instance.sessionManager}get fullSnapshotIntervalMillis(){var e,t;return"trigger_pending"===this.triggerStatus?6e4:null!==(e=null===(t=this.instance.config.session_recording)||void 0===t?void 0:t.full_snapshot_interval_millis)&&void 0!==e?e:3e5}get isSampled(){var e=this.instance.get_property(Xo);return co(e)?e:null}get sessionDuration(){var e,t,n=null===(e=this.buffer)||void 0===e?void 0:e.data[(null===(t=this.buffer)||void 0===t?void 0:t.data.length)-1],{sessionStartTimestamp:r}=this.sessionManager.checkAndGetSessionAndWindowId(!0);return n?n.timestamp-r:null}get isRecordingEnabled(){var e=!!this.instance.get_property($o),t=!this.instance.config.disable_session_recording;return Os&&e&&t}get isConsoleLogCaptureEnabled(){var e=!!this.instance.get_property(Vo),t=this.instance.config.enable_recording_console_log;return null!=t?t:e}get canvasRecording(){var e,t,n,r,i,s,o=this.instance.config.session_recording.captureCanvas,a=this.instance.get_property(Ho),c=null!==(e=null!==(t=null==o?void 0:o.recordCanvas)&&void 0!==t?t:null==a?void 0:a.enabled)&&void 0!==e&&e,l=null!==(n=null!==(r=null==o?void 0:o.canvasFps)&&void 0!==r?r:null==a?void 0:a.fps)&&void 0!==n?n:4,u=null!==(i=null!==(s=null==o?void 0:o.canvasQuality)&&void 0!==s?s:null==a?void 0:a.quality)&&void 0!==i?i:.4;if("string"==typeof u){var d=parseFloat(u);u=isNaN(d)?.4:d}return{enabled:c,fps:xl(l,0,12,"canvas recording fps",4),quality:xl(u,0,1,"canvas recording quality",.4)}}get networkPayloadCapture(){var e,t,n=this.instance.get_property(Go),r={recordHeaders:null===(e=this.instance.config.session_recording)||void 0===e?void 0:e.recordHeaders,recordBody:null===(t=this.instance.config.session_recording)||void 0===t?void 0:t.recordBody},i=(null==r?void 0:r.recordHeaders)||(null==n?void 0:n.recordHeaders),s=(null==r?void 0:r.recordBody)||(null==n?void 0:n.recordBody),o=eo(this.instance.config.capture_performance)?this.instance.config.capture_performance.network_timing:this.instance.config.capture_performance,a=!!(co(o)?o:null==n?void 0:n.capturePerformance);return i||s||a?{recordHeaders:i,recordBody:s,recordPerformance:a}:void 0}get sampleRate(){var e=this.instance.get_property(Wo);return ao(e)?e:null}get minimumDuration(){var e=this.instance.get_property(Jo);return ao(e)?e:null}get status(){return this.receivedDecide?this.isRecordingEnabled?!1===this.isSampled?"disabled":this._urlBlocked?"paused":oo(this._linkedFlag)||this._linkedFlagSeen?"trigger_pending"===this.triggerStatus?"buffering":co(this.isSampled)?this.isSampled?"sampled":"disabled":"active":"buffering":"disabled":"buffering"}get urlTriggerStatus(){var e;return 0===this._urlTriggers.length?"trigger_disabled":(null===(e=this.instance)||void 0===e?void 0:e.get_property(Qo))===this.sessionId?"trigger_activated":"trigger_pending"}get eventTriggerStatus(){var e;return 0===this._eventTriggers.length?"trigger_disabled":(null===(e=this.instance)||void 0===e?void 0:e.get_property(Zo))===this.sessionId?"trigger_activated":"trigger_pending"}get triggerStatus(){var e="trigger_activated"===this.eventTriggerStatus||"trigger_activated"===this.urlTriggerStatus,t="trigger_pending"===this.eventTriggerStatus||"trigger_pending"===this.urlTriggerStatus;return e?"trigger_activated":t?"trigger_pending":"trigger_disabled"}constructor(e){if(_o(this,"queuedRRWebEvents",[]),_o(this,"isIdle",!1),_o(this,"_linkedFlagSeen",!1),_o(this,"_lastActivityTimestamp",Date.now()),_o(this,"_linkedFlag",null),_o(this,"_removePageViewCaptureHook",void 0),_o(this,"_onSessionIdListener",void 0),_o(this,"_persistDecideOnSessionListener",void 0),_o(this,"_samplingSessionListener",void 0),_o(this,"_urlTriggers",[]),_o(this,"_urlBlocklist",[]),_o(this,"_urlBlocked",!1),_o(this,"_eventTriggers",[]),_o(this,"_removeEventTriggerCaptureHook",void 0),_o(this,"_forceAllowLocalhostNetworkCapture",!1),_o(this,"_onBeforeUnload",(()=>{this._flushBuffer()})),_o(this,"_onOffline",(()=>{this._tryAddCustomEvent("browser offline",{})})),_o(this,"_onOnline",(()=>{this._tryAddCustomEvent("browser online",{})})),_o(this,"_onVisibilityChange",(()=>{if(null!=Ms&&Ms.visibilityState){var e="window "+Ms.visibilityState;this._tryAddCustomEvent(e,{})}})),this.instance=e,this._captureStarted=!1,this._endpoint="/s/",this.stopRrweb=void 0,this.receivedDecide=!1,!this.instance.sessionManager)throw vu.error("started without valid sessionManager"),new Error(mu+" started without valid sessionManager. This is a bug.");if(this.instance.config.__preview_experimental_cookieless_mode)throw new Error(mu+" cannot be used with __preview_experimental_cookieless_mode.");var{sessionId:t,windowId:n}=this.sessionManager.checkAndGetSessionAndWindowId();this.sessionId=t,this.windowId=n,this.buffer=this.clearBuffer(),this.sessionIdleThresholdMilliseconds>=this.sessionManager.sessionTimeoutMs&&vu.warn("session_idle_threshold_ms (".concat(this.sessionIdleThresholdMilliseconds,") is greater than the session timeout (").concat(this.sessionManager.sessionTimeoutMs,"). Session will never be detected as idle"))}startIfEnabledOrStop(e){this.isRecordingEnabled?(this._startCapture(e),No(Os,"beforeunload",this._onBeforeUnload),No(Os,"offline",this._onOffline),No(Os,"online",this._onOnline),No(Os,"visibilitychange",this._onVisibilityChange),this._setupSampling(),this._addEventTriggerListener(),oo(this._removePageViewCaptureHook)&&(this._removePageViewCaptureHook=this.instance.on("eventCaptured",(e=>{try{if("$pageview"===e.event){var t=null!=e&&e.properties.$current_url?this._maskUrl(null==e?void 0:e.properties.$current_url):"";if(!t)return;this._tryAddCustomEvent("$pageview",{href:t})}}catch(e){vu.error("Could not add $pageview to rrweb session",e)}}))),this._onSessionIdListener||(this._onSessionIdListener=this.sessionManager.onSessionId(((e,t,n)=>{var r,i,s,o;n&&(this._tryAddCustomEvent("$session_id_change",{sessionId:e,windowId:t,changeReason:n}),null===(r=this.instance)||void 0===r||null===(i=r.persistence)||void 0===i||i.unregister(Zo),null===(s=this.instance)||void 0===s||null===(o=s.persistence)||void 0===o||o.unregister(Qo))})))):this.stopRecording()}stopRecording(){var e,t,n,r;this._captureStarted&&this.stopRrweb&&(this.stopRrweb(),this.stopRrweb=void 0,this._captureStarted=!1,null==Os||Os.removeEventListener("beforeunload",this._onBeforeUnload),null==Os||Os.removeEventListener("offline",this._onOffline),null==Os||Os.removeEventListener("online",this._onOnline),null==Os||Os.removeEventListener("visibilitychange",this._onVisibilityChange),this.clearBuffer(),clearInterval(this._fullSnapshotTimer),null===(e=this._removePageViewCaptureHook)||void 0===e||e.call(this),this._removePageViewCaptureHook=void 0,null===(t=this._removeEventTriggerCaptureHook)||void 0===t||t.call(this),this._removeEventTriggerCaptureHook=void 0,null===(n=this._onSessionIdListener)||void 0===n||n.call(this),this._onSessionIdListener=void 0,null===(r=this._samplingSessionListener)||void 0===r||r.call(this),this._samplingSessionListener=void 0,vu.info("stopped"))}makeSamplingDecision(e){var t,n=this.sessionId!==e,r=this.sampleRate;if(ao(r)){var i=this.isSampled,s=n||!co(i),o=s?function(e,t){return function(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t)}(e)%100<xl(100*t,0,100)}(e,r):i;s&&(o?this._reportStarted("sampled"):vu.warn("Sample rate (".concat(r,") has determined that this sessionId (").concat(e,") will not be sent to the server.")),this._tryAddCustomEvent("samplingDecisionMade",{sampleRate:r,isSampled:o})),null===(t=this.instance.persistence)||void 0===t||t.register({[Xo]:o})}else{var a;null===(a=this.instance.persistence)||void 0===a||a.register({[Xo]:null})}}onRemoteConfig(e){var t,n,r,i,s,o;if(this._tryAddCustomEvent("$remote_config_received",e),this._persistRemoteConfig(e),this._linkedFlag=(null===(t=e.sessionRecording)||void 0===t?void 0:t.linkedFlag)||null,null!==(n=e.sessionRecording)&&void 0!==n&&n.endpoint&&(this._endpoint=null===(o=e.sessionRecording)||void 0===o?void 0:o.endpoint),this._setupSampling(),!oo(this._linkedFlag)&&!this._linkedFlagSeen){var a=ro(this._linkedFlag)?this._linkedFlag:this._linkedFlag.flag,c=ro(this._linkedFlag)?null:this._linkedFlag.variant;this.instance.onFeatureFlags(((e,t)=>{var n=eo(t)&&a in t,r=c?t[a]===c:n;r&&this._reportStarted("linked_flag_matched",{linkedFlag:a,linkedVariant:c}),this._linkedFlagSeen=r}))}null!==(r=e.sessionRecording)&&void 0!==r&&r.urlTriggers&&(this._urlTriggers=e.sessionRecording.urlTriggers),null!==(i=e.sessionRecording)&&void 0!==i&&i.urlBlocklist&&(this._urlBlocklist=e.sessionRecording.urlBlocklist),null!==(s=e.sessionRecording)&&void 0!==s&&s.eventTriggers&&(this._eventTriggers=e.sessionRecording.eventTriggers),this.receivedDecide=!0,this.startIfEnabledOrStop()}_setupSampling(){ao(this.sampleRate)&&oo(this._samplingSessionListener)&&(this._samplingSessionListener=this.sessionManager.onSessionId((e=>{this.makeSamplingDecision(e)})))}_persistRemoteConfig(e){if(this.instance.persistence){var t,n=this.instance.persistence,r=()=>{var t,r,i,s,o,a,c,l,u=null===(t=e.sessionRecording)||void 0===t?void 0:t.sampleRate,d=oo(u)?null:parseFloat(u),h=null===(r=e.sessionRecording)||void 0===r?void 0:r.minimumDurationMilliseconds;n.register({[$o]:!!e.sessionRecording,[Vo]:null===(i=e.sessionRecording)||void 0===i?void 0:i.consoleLogRecordingEnabled,[Go]:yo({capturePerformance:e.capturePerformance},null===(s=e.sessionRecording)||void 0===s?void 0:s.networkPayloadCapture),[Ho]:{enabled:null===(o=e.sessionRecording)||void 0===o?void 0:o.recordCanvas,fps:null===(a=e.sessionRecording)||void 0===a?void 0:a.canvasFps,quality:null===(c=e.sessionRecording)||void 0===c?void 0:c.canvasQuality},[Wo]:d,[Jo]:no(h)?null:h,[Yo]:null===(l=e.sessionRecording)||void 0===l?void 0:l.scriptConfig})};r(),null===(t=this._persistDecideOnSessionListener)||void 0===t||t.call(this),this._persistDecideOnSessionListener=this.sessionManager.onSessionId(r)}}log(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"log";null===(t=this.instance.sessionRecording)||void 0===t||t.onRRwebEmit({type:6,data:{plugin:"rrweb/console@1",payload:{level:n,trace:[],payload:[JSON.stringify(e)]}},timestamp:Date.now()})}_startCapture(e){var t,n;no(Object.assign)||no(Array.from)||this._captureStarted||this.instance.config.disable_session_recording||this.instance.consent.isOptedOut()||(this._captureStarted=!0,this.sessionManager.checkAndGetSessionAndWindowId(),this.rrwebRecord?this._onScriptLoaded():null===(t=qs.__PosthogExtensions__)||void 0===t||null===(n=t.loadExternalDependency)||void 0===n||n.call(t,this.instance,this.scriptName,(e=>{if(e)return vu.error("could not load recorder",e);this._onScriptLoaded()})),vu.info("starting"),"active"===this.status&&this._reportStarted(e||"recording_initialized"))}get scriptName(){var e,t,n;return(null===(e=this.instance)||void 0===e||null===(t=e.persistence)||void 0===t||null===(n=t.get_property(Yo))||void 0===n?void 0:n.script)||"recorder"}isInteractiveEvent(e){var t;return 3===e.type&&-1!==yu.indexOf(null===(t=e.data)||void 0===t?void 0:t.source)}_updateWindowAndSessionIds(e){var t=this.isInteractiveEvent(e);t||this.isIdle||e.timestamp-this._lastActivityTimestamp>this.sessionIdleThresholdMilliseconds&&(this.isIdle=!0,clearInterval(this._fullSnapshotTimer),this._tryAddCustomEvent("sessionIdle",{eventTimestamp:e.timestamp,lastActivityTimestamp:this._lastActivityTimestamp,threshold:this.sessionIdleThresholdMilliseconds,bufferLength:this.buffer.data.length,bufferSize:this.buffer.size}),this._flushBuffer());var n=!1;if(t&&(this._lastActivityTimestamp=e.timestamp,this.isIdle&&(this.isIdle=!1,this._tryAddCustomEvent("sessionNoLongerIdle",{reason:"user activity",type:e.type}),n=!0)),!this.isIdle){var{windowId:r,sessionId:i}=this.sessionManager.checkAndGetSessionAndWindowId(!t,e.timestamp),s=this.sessionId!==i,o=this.windowId!==r;this.windowId=r,this.sessionId=i,s||o?(this.stopRecording(),this.startIfEnabledOrStop("session_id_changed")):n&&this._scheduleFullSnapshot()}}_tryRRWebMethod(e){try{return e.rrwebMethod(),!0}catch(t){return this.queuedRRWebEvents.length<10?this.queuedRRWebEvents.push({enqueuedAt:e.enqueuedAt||Date.now(),attempt:e.attempt++,rrwebMethod:e.rrwebMethod}):vu.warn("could not emit queued rrweb event.",t,e),!1}}_tryAddCustomEvent(e,t){return this._tryRRWebMethod(_u((()=>this.rrwebRecord.addCustomEvent(e,t))))}_tryTakeFullSnapshot(){return this._tryRRWebMethod(_u((()=>this.rrwebRecord.takeFullSnapshot())))}_onScriptLoaded(){var e,t={blockClass:"ph-no-capture",blockSelector:void 0,ignoreClass:"ph-ignore-input",maskTextClass:"ph-mask",maskTextSelector:void 0,maskTextFn:void 0,maskAllInputs:!0,maskInputOptions:{password:!0},maskInputFn:void 0,slimDOMOptions:{},collectFonts:!1,inlineStylesheet:!0,recordCrossOriginIframes:!1},n=this.instance.config.session_recording;for(var[r,i]of Object.entries(n||{}))r in t&&("maskInputOptions"===r?t.maskInputOptions=yo({password:!0},i):t[r]=i);if(this.canvasRecording&&this.canvasRecording.enabled&&(t.recordCanvas=!0,t.sampling={canvas:this.canvasRecording.fps},t.dataURLOptions={type:"image/webp",quality:this.canvasRecording.quality}),this.rrwebRecord){this.mutationRateLimiter=null!==(e=this.mutationRateLimiter)&&void 0!==e?e:new Ml(this.rrwebRecord,{refillRate:this.instance.config.session_recording.__mutationRateLimiterRefillRate,bucketSize:this.instance.config.session_recording.__mutationRateLimiterBucketSize,onBlockedNode:(e,t)=>{var n="Too many mutations on node '".concat(e,"'. Rate limiting. This could be due to SVG animations or something similar");vu.info(n,{node:t}),this.log(mu+" "+n,"warn")}});var s=this._gatherRRWebPlugins();this.stopRrweb=this.rrwebRecord(yo({emit:e=>{this.onRRwebEmit(e)},plugins:s},t)),this._lastActivityTimestamp=Date.now(),this.isIdle=!1,this._tryAddCustomEvent("$session_options",{sessionRecordingOptions:t,activePlugins:s.map((e=>null==e?void 0:e.name))}),this._tryAddCustomEvent("$posthog_config",{config:this.instance.config})}else vu.error("onScriptLoaded was called but rrwebRecord is not available. This indicates something has gone wrong.")}_scheduleFullSnapshot(){if(this._fullSnapshotTimer&&clearInterval(this._fullSnapshotTimer),!this.isIdle){var e=this.fullSnapshotIntervalMillis;e&&(this._fullSnapshotTimer=setInterval((()=>{this._tryTakeFullSnapshot()}),e))}}_gatherRRWebPlugins(){var e,t,n,r,i=[],s=null===(e=qs.__PosthogExtensions__)||void 0===e||null===(t=e.rrwebPlugins)||void 0===t?void 0:t.getRecordConsolePlugin;s&&this.isConsoleLogCaptureEnabled&&i.push(s());var o=null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.rrwebPlugins)||void 0===r?void 0:r.getRecordNetworkPlugin;return this.networkPayloadCapture&&Zs(o)&&(!$a.includes(location.hostname)||this._forceAllowLocalhostNetworkCapture?i.push(o(((e,t)=>{var n,r,i,s={payloadSizeLimitBytes:Rl.payloadSizeLimitBytes,performanceEntryTypeToObserve:[...Rl.performanceEntryTypeToObserve],payloadHostDenyList:[...t.payloadHostDenyList||[],...Rl.payloadHostDenyList]},o=!1!==e.session_recording.recordHeaders&&t.recordHeaders,a=!1!==e.session_recording.recordBody&&t.recordBody,c=!1!==e.capture_performance&&t.recordPerformance,l=(n=s,i=Math.min(1e6,null!==(r=n.payloadSizeLimitBytes)&&void 0!==r?r:1e6),e=>(null!=e&&e.requestBody&&(e.requestBody=Dl(e.requestBody,e.requestHeaders,i,"Request")),null!=e&&e.responseBody&&(e.responseBody=Dl(e.responseBody,e.responseHeaders,i,"Response")),e)),u=t=>{return l(((e,t)=>{var n,r=Va(e.name),i=0===t.indexOf("http")?null===(n=Va(t))||void 0===n?void 0:n.pathname:t;"/"===i&&(i="");var s=null==r?void 0:r.pathname.replace(i||"","");if(!(r&&s&&Pl.some((e=>0===s.indexOf(e)))))return e})((r=(n=t).requestHeaders,oo(r)||So(Object.keys(null!=r?r:{}),(e=>{Ol.includes(e.toLowerCase())&&(r[e]=kl)})),n),e.api_host));var n,r},d=Zs(e.session_recording.maskNetworkRequestFn);return d&&Zs(e.session_recording.maskCapturedNetworkRequestFn)&&po.warn("Both `maskNetworkRequestFn` and `maskCapturedNetworkRequestFn` are defined. `maskNetworkRequestFn` will be ignored."),d&&(e.session_recording.maskCapturedNetworkRequestFn=t=>{var n=e.session_recording.maskNetworkRequestFn({url:t.name});return yo(yo({},t),{},{name:null==n?void 0:n.url})}),s.maskRequestFn=Zs(e.session_recording.maskCapturedNetworkRequestFn)?t=>{var n,r,i,s=u(t);return s&&null!==(n=null===(r=(i=e.session_recording).maskCapturedNetworkRequestFn)||void 0===r?void 0:r.call(i,s))&&void 0!==n?n:void 0}:e=>function(e){if(!no(e))return e.requestBody=Nl(e.requestBody,"Request"),e.responseBody=Nl(e.responseBody,"Response"),e}(u(e)),yo(yo(yo({},Rl),s),{},{recordHeaders:o,recordBody:a,recordPerformance:c,recordInitialRequests:c})})(this.instance.config,this.networkPayloadCapture))):vu.info("NetworkCapture not started because we are on localhost.")),i}onRRwebEmit(e){var t;if(this._processQueuedEvents(),e&&eo(e)){if(e.type===Xc.Meta){var n=this._maskUrl(e.data.href);if(this._lastHref=n,!n)return;e.data.href=n}else this._pageViewFallBack();if(this._checkUrlTriggerConditions(),!this._urlBlocked||function(e){return e.type===Xc.Custom&&"recording paused"===e.data.tag}(e)){e.type===Xc.FullSnapshot&&this._scheduleFullSnapshot(),e.type===Xc.FullSnapshot&&"trigger_pending"===this.triggerStatus&&this.clearBuffer();var r=this.mutationRateLimiter?this.mutationRateLimiter.throttleMutations(e):e;if(r){var i=function(e){var t=e;if(t&&eo(t)&&6===t.type&&eo(t.data)&&"rrweb/console@1"===t.data.plugin){t.data.payload.payload.length>10&&(t.data.payload.payload=t.data.payload.payload.slice(0,10),t.data.payload.payload.push("...[truncated]"));for(var n=[],r=0;r<t.data.payload.payload.length;r++)t.data.payload.payload[r]&&t.data.payload.payload[r].length>2e3?n.push(t.data.payload.payload[r].slice(0,2e3)+"...[truncated]"):n.push(t.data.payload.payload[r]);return t.data.payload.payload=n,e}return e}(r);if(this._updateWindowAndSessionIds(i),!this.isIdle||Eu(i)){if(Eu(i)){var s=i.data.payload;if(s){var o=s.lastActivityTimestamp,a=s.threshold;i.timestamp=o+a}}var c=null===(t=this.instance.config.session_recording.compress_events)||void 0===t||t?function(e){if(Yc(e)<1024)return e;try{if(e.type===Xc.FullSnapshot)return yo(yo({},e),{},{data:bu(e.data),cv:"2024-10"});if(e.type===Xc.IncrementalSnapshot&&e.data.source===Qc.Mutation)return yo(yo({},e),{},{cv:"2024-10",data:yo(yo({},e.data),{},{texts:bu(e.data.texts),attributes:bu(e.data.attributes),removes:bu(e.data.removes),adds:bu(e.data.adds)})});if(e.type===Xc.IncrementalSnapshot&&e.data.source===Qc.StyleSheetRule)return yo(yo({},e),{},{cv:"2024-10",data:yo(yo({},e.data),{},{adds:e.data.adds?bu(e.data.adds):void 0,removes:e.data.removes?bu(e.data.removes):void 0})})}catch(e){vu.error("could not compress event - will use uncompressed event",e)}return e}(i):i,l={$snapshot_bytes:Yc(c),$snapshot_data:c,$session_id:this.sessionId,$window_id:this.windowId};"disabled"!==this.status?this._captureSnapshotBuffered(l):this.clearBuffer()}}}}}_pageViewFallBack(){if(!this.instance.config.capture_pageview&&Os){var e=this._maskUrl(Os.location.href);this._lastHref!==e&&(this._tryAddCustomEvent("$url_changed",{href:e}),this._lastHref=e)}}_processQueuedEvents(){if(this.queuedRRWebEvents.length){var e=[...this.queuedRRWebEvents];this.queuedRRWebEvents=[],e.forEach((e=>{Date.now()-e.enqueuedAt<=2e3&&this._tryRRWebMethod(e)}))}}_maskUrl(e){var t=this.instance.config.session_recording;if(t.maskNetworkRequestFn){var n,r={url:e};return null===(n=r=t.maskNetworkRequestFn(r))||void 0===n?void 0:n.url}return e}clearBuffer(){return this.buffer={size:0,data:[],sessionId:this.sessionId,windowId:this.windowId},this.buffer}_flushBuffer(){this.flushBufferTimer&&(clearTimeout(this.flushBufferTimer),this.flushBufferTimer=void 0);var e=this.minimumDuration,t=this.sessionDuration,n=ao(t)&&t>=0,r=ao(e)&&n&&t<e;return"buffering"===this.status||"paused"===this.status||"disabled"===this.status||r?(this.flushBufferTimer=setTimeout((()=>{this._flushBuffer()}),2e3),this.buffer):(this.buffer.data.length>0&&zc(this.buffer).forEach((e=>{this._captureSnapshot({$snapshot_bytes:e.size,$snapshot_data:e.data,$session_id:e.sessionId,$window_id:e.windowId,$lib:"web",$lib_version:Ks.LIB_VERSION})})),this.clearBuffer())}_captureSnapshotBuffered(e){var t,n=2+((null===(t=this.buffer)||void 0===t?void 0:t.data.length)||0);!this.isIdle&&(this.buffer.size+e.$snapshot_bytes+n>943718.4||this.buffer.sessionId!==this.sessionId)&&(this.buffer=this._flushBuffer()),this.buffer.size+=e.$snapshot_bytes,this.buffer.data.push(e.$snapshot_data),this.flushBufferTimer||this.isIdle||(this.flushBufferTimer=setTimeout((()=>{this._flushBuffer()}),2e3))}_captureSnapshot(e){this.instance.capture("$snapshot",e,{_url:this.instance.requestRouter.endpointFor("api",this._endpoint),_noTruncate:!0,_batchKey:"recordings",skip_client_rate_limiting:!0})}_checkUrlTriggerConditions(){if(void 0!==Os&&Os.location.href){var e=Os.location.href,t=this._urlBlocked,n=Au(e,this._urlBlocklist);n&&!t?this._pauseRecording():!n&&t&&this._resumeRecording(),Au(e,this._urlTriggers)&&this._activateTrigger("url")}}_activateTrigger(e){var t,n;"trigger_pending"===this.triggerStatus&&(null===(t=this.instance)||void 0===t||null===(n=t.persistence)||void 0===n||n.register({["url"===e?Qo:Zo]:this.sessionId}),this._flushBuffer(),this._reportStarted(e+"_trigger_matched"))}_pauseRecording(){this._urlBlocked||(this._urlBlocked=!0,clearInterval(this._fullSnapshotTimer),vu.info("recording paused due to URL blocker"),this._tryAddCustomEvent("recording paused",{reason:"url blocker"}))}_resumeRecording(){this._urlBlocked&&(this._urlBlocked=!1,this._tryTakeFullSnapshot(),this._scheduleFullSnapshot(),this._tryAddCustomEvent("recording resumed",{reason:"left blocked url"}),vu.info("recording resumed"))}_addEventTriggerListener(){0!==this._eventTriggers.length&&oo(this._removeEventTriggerCaptureHook)&&(this._removeEventTriggerCaptureHook=this.instance.on("eventCaptured",(e=>{try{this._eventTriggers.includes(e.event)&&this._activateTrigger("event")}catch(e){vu.error("Could not activate event trigger",e)}})))}overrideLinkedFlag(){this._linkedFlagSeen=!0,this._tryTakeFullSnapshot(),this._reportStarted("linked_flag_overridden")}overrideSampling(){var e;null===(e=this.instance.persistence)||void 0===e||e.register({[Xo]:!0}),this._tryTakeFullSnapshot(),this._reportStarted("sampling_overridden")}overrideTrigger(e){this._activateTrigger(e)}_reportStarted(e,t){this.instance.register_for_session({$session_recording_start_reason:e}),vu.info(e.replace("_"," "),t),Gs(["recording_initialized","session_id_changed"],e)||this._tryAddCustomEvent(e,t)}}var wu=go("[RemoteConfig]");class Iu{constructor(e){this.instance=e}get remoteConfig(){var e,t;return null===(e=qs._POSTHOG_REMOTE_CONFIG)||void 0===e||null===(t=e[this.instance.config.token])||void 0===t?void 0:t.config}_loadRemoteConfigJs(e){var t,n,r;null!==(t=qs.__PosthogExtensions__)&&void 0!==t&&t.loadExternalDependency?null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.loadExternalDependency)||void 0===r||r.call(n,this.instance,"remote-config",(()=>e(this.remoteConfig))):(wu.error("PostHog Extensions not found. Cannot load remote config."),e())}_loadRemoteConfigJSON(e){this.instance._send_request({method:"GET",url:this.instance.requestRouter.endpointFor("assets","/array/".concat(this.instance.config.token,"/config")),callback:t=>{e(t.json)}})}load(){try{if(this.remoteConfig)return wu.info("Using preloaded remote config",this.remoteConfig),void this.onRemoteConfig(this.remoteConfig);if(this.instance.config.advanced_disable_decide)return void wu.warn("Remote config is disabled. Falling back to local config.");this._loadRemoteConfigJs((e=>{if(!e)return wu.info("No config found after loading remote JS config. Falling back to JSON."),void this._loadRemoteConfigJSON((e=>{this.onRemoteConfig(e)}));this.onRemoteConfig(e)}))}catch(e){wu.error("Error loading remote config",e)}}onRemoteConfig(e){e?this.instance.config.__preview_remote_config?(this.instance._onRemoteConfig(e),!1!==e.hasFeatureFlags&&this.instance.featureFlags.ensureFlagsLoaded()):wu.info("__preview_remote_config is disabled. Logging config instead",e):wu.error("Failed to fetch remote config from PostHog.")}}var Tu,ku=null!=Os&&Os.location?Wa(Os.location.hash,"__posthog")||Wa(location.hash,"state"):null,Ru="_postHogToolbarParams",Ou=go("[Toolbar]");!function(e){e[e.UNINITIALIZED=0]="UNINITIALIZED",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED"}(Tu||(Tu={}));class Cu{constructor(e){this.instance=e}setToolbarState(e){qs.ph_toolbar_state=e}getToolbarState(){var e;return null!==(e=qs.ph_toolbar_state)&&void 0!==e?e:Tu.UNINITIALIZED}maybeLoadToolbar(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(!Os||!Ms)return!1;n=null!==(e=n)&&void 0!==e?e:Os.location,i=null!==(t=i)&&void 0!==t?t:Os.history;try{if(!r){try{Os.localStorage.setItem("test","test"),Os.localStorage.removeItem("test")}catch(e){return!1}r=null==Os?void 0:Os.localStorage}var s,o=ku||Wa(n.hash,"__posthog")||Wa(n.hash,"state"),a=o?ko((()=>JSON.parse(atob(decodeURIComponent(o)))))||ko((()=>JSON.parse(decodeURIComponent(o)))):null;return a&&"ph_authorize"===a.action?((s=a).source="url",s&&Object.keys(s).length>0&&(a.desiredHash?n.hash=a.desiredHash:i?i.replaceState(i.state,"",n.pathname+n.search):n.hash="")):((s=JSON.parse(r.getItem(Ru)||"{}")).source="localstorage",delete s.userIntent),!(!s.token||this.instance.config.token!==s.token||(this.loadToolbar(s),0))}catch(e){return!1}}_callLoadToolbar(e){var t=qs.ph_load_toolbar||qs.ph_load_editor;!oo(t)&&Zs(t)?t(e,this.instance):Ou.warn("No toolbar load function found")}loadToolbar(e){var t=!(null==Ms||!Ms.getElementById(ga));if(!Os||t)return!1;var n="custom"===this.instance.requestRouter.region&&this.instance.config.advanced_disable_toolbar_metrics,r=yo(yo({token:this.instance.config.token},e),{},{apiURL:this.instance.requestRouter.endpointFor("ui")},n?{instrument:!1}:{});if(Os.localStorage.setItem(Ru,JSON.stringify(yo(yo({},r),{},{source:void 0}))),this.getToolbarState()===Tu.LOADED)this._callLoadToolbar(r);else if(this.getToolbarState()===Tu.UNINITIALIZED){var i,s;this.setToolbarState(Tu.LOADING),null===(i=qs.__PosthogExtensions__)||void 0===i||null===(s=i.loadExternalDependency)||void 0===s||s.call(i,this.instance,"toolbar",(e=>{if(e)return Ou.error("[Toolbar] Failed to load",e),void this.setToolbarState(Tu.UNINITIALIZED);this.setToolbarState(Tu.LOADED),this._callLoadToolbar(r)})),No(Os,"turbolinks:load",(()=>{this.setToolbarState(Tu.UNINITIALIZED),this.loadToolbar(r)}))}return!0}_loadEditor(e){return this.loadToolbar(e)}maybeLoadEditor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;return this.maybeLoadToolbar(e,t,n)}}var Pu=3e3;class Du{constructor(e,t){_o(this,"isPaused",!0),_o(this,"queue",[]),this.flushTimeoutMs=xl((null==t?void 0:t.flush_interval_ms)||Pu,250,5e3,"flush interval",Pu),this.sendRequest=e}enqueue(e){this.queue.push(e),this.flushTimeout||this.setFlushTimeout()}unload(){this.clearFlushTimeout();var e=this.queue.length>0?this.formatQueue():{},t=Object.values(e),n=[...t.filter((e=>0===e.url.indexOf("/e"))),...t.filter((e=>0!==e.url.indexOf("/e")))];n.map((e=>{this.sendRequest(yo(yo({},e),{},{transport:"sendBeacon"}))}))}enable(){this.isPaused=!1,this.setFlushTimeout()}setFlushTimeout(){var e=this;this.isPaused||(this.flushTimeout=setTimeout((()=>{if(this.clearFlushTimeout(),this.queue.length>0){var t=this.formatQueue(),n=function(n){var r=t[n],i=(new Date).getTime();r.data&&Qs(r.data)&&So(r.data,(e=>{e.offset=Math.abs(e.timestamp-i),delete e.timestamp})),e.sendRequest(r)};for(var r in t)n(r)}}),this.flushTimeoutMs))}clearFlushTimeout(){clearTimeout(this.flushTimeout),this.flushTimeout=void 0}formatQueue(){var e={};return So(this.queue,(t=>{var n,r=t,i=(r?r.batchKey:null)||r.url;no(e[i])&&(e[i]=yo(yo({},r),{},{data:[]})),null===(n=e[i].data)||void 0===n||n.push(r.data)})),this.queue=[],e}}var Nu=!!Us||!!Bs,xu="text/plain",Mu=(e,t)=>{var[n,r]=e.split("?"),i=yo({},t);null==r||r.split("&").forEach((e=>{var[t]=e.split("=");delete i[t]}));var s=function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"&",i=[];return So(e,(function(e,r){no(e)||no(r)||"undefined"===r||(t=encodeURIComponent((e=>e instanceof File)(e)?e.name:e.toString()),n=encodeURIComponent(r),i[i.length]=n+"="+t)})),i.join(r)}(i);return s=s?(r?r+"&":"")+s:r,"".concat(n,"?").concat(s)},Lu=(e,t)=>JSON.stringify(e,((e,t)=>"bigint"==typeof t?t.toString():t),t),Bu=e=>{var{data:t,compression:n}=e;if(t){if(n===Rs.GZipJS){var r=gu(fu(Lu(t)),{mtime:0}),i=new Blob([r],{type:xu});return{contentType:xu,body:i,estimatedSize:i.size}}if(n===Rs.Base64){var s=function(e){var t,n,r,i,s,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=0,c=0,l="",u=[];if(!e)return e;e=function(e){var t,n,r,i,s="";for(t=n=0,r=(e=(e+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,i=0;i<r;i++){var o=e.charCodeAt(i),a=null;o<128?n++:a=o>127&&o<2048?String.fromCharCode(o>>6|192,63&o|128):String.fromCharCode(o>>12|224,o>>6&63|128,63&o|128),so(a)||(n>t&&(s+=e.substring(t,n)),s+=a,t=n=i+1)}return n>t&&(s+=e.substring(t,e.length)),s}(e);do{t=(s=e.charCodeAt(a++)<<16|e.charCodeAt(a++)<<8|e.charCodeAt(a++))>>18&63,n=s>>12&63,r=s>>6&63,i=63&s,u[c++]=o.charAt(t)+o.charAt(n)+o.charAt(r)+o.charAt(i)}while(a<e.length);switch(l=u.join(""),e.length%3){case 1:l=l.slice(0,-2)+"==";break;case 2:l=l.slice(0,-1)+"="}return l}(Lu(t)),o=(e=>"data="+encodeURIComponent("string"==typeof e?e:Lu(e)))(s);return{contentType:"application/x-www-form-urlencoded",body:o,estimatedSize:new Blob([o]).size}}var a=Lu(t);return{contentType:"application/json",body:a,estimatedSize:new Blob([a]).size}}},Uu=[];Bs&&Uu.push({transport:"fetch",method:e=>{var t,n,{contentType:r,body:i,estimatedSize:s}=null!==(t=Bu(e))&&void 0!==t?t:{},o=new Headers;So(e.headers,(function(e,t){o.append(t,e)})),r&&o.append("Content-Type",r);var a=e.url,c=null;if(Fs){var l=new Fs;c={signal:l.signal,timeout:setTimeout((()=>l.abort()),e.timeout)}}Bs(a,yo({method:(null==e?void 0:e.method)||"GET",headers:o,keepalive:"POST"===e.method&&(s||0)<52428.8,body:i,signal:null===(n=c)||void 0===n?void 0:n.signal},e.fetchOptions)).then((t=>t.text().then((n=>{var r,i={statusCode:t.status,text:n};if(200===t.status)try{i.json=JSON.parse(n)}catch(e){po.error(e)}null===(r=e.callback)||void 0===r||r.call(e,i)})))).catch((t=>{var n;po.error(t),null===(n=e.callback)||void 0===n||n.call(e,{statusCode:0,text:t})})).finally((()=>c?clearTimeout(c.timeout):null))}}),Us&&Uu.push({transport:"XHR",method:e=>{var t,n=new Us;n.open(e.method||"GET",e.url,!0);var{contentType:r,body:i}=null!==(t=Bu(e))&&void 0!==t?t:{};So(e.headers,(function(e,t){n.setRequestHeader(t,e)})),r&&n.setRequestHeader("Content-Type",r),e.timeout&&(n.timeout=e.timeout),n.withCredentials=!0,n.onreadystatechange=()=>{if(4===n.readyState){var t,r={statusCode:n.status,text:n.responseText};if(200===n.status)try{r.json=JSON.parse(n.responseText)}catch(e){}null===(t=e.callback)||void 0===t||t.call(e,r)}},n.send(i)}}),null!=xs&&xs.sendBeacon&&Uu.push({transport:"sendBeacon",method:e=>{var t=Mu(e.url,{beacon:"1"});try{var n,{contentType:r,body:i}=null!==(n=Bu(e))&&void 0!==n?n:{},s="string"==typeof i?new Blob([i],{type:r}):i;xs.sendBeacon(t,s)}catch(e){}}});var Fu=["retriesPerformedSoFar"];class ju{constructor(e){_o(this,"isPolling",!1),_o(this,"pollIntervalMs",3e3),_o(this,"queue",[]),this.instance=e,this.queue=[],this.areWeOnline=!0,!no(Os)&&"onLine"in Os.navigator&&(this.areWeOnline=Os.navigator.onLine,No(Os,"online",(()=>{this.areWeOnline=!0,this.flush()})),No(Os,"offline",(()=>{this.areWeOnline=!1})))}retriableRequest(e){var{retriesPerformedSoFar:t}=e,n=bo(e,Fu);ao(t)&&t>0&&(n.url=Mu(n.url,{retry_count:t})),this.instance._send_request(yo(yo({},n),{},{callback:e=>{var r;200!==e.statusCode&&(e.statusCode<400||e.statusCode>=500)&&(null!=t?t:0)<10?this.enqueue(yo({retriesPerformedSoFar:t},n)):null===(r=n.callback)||void 0===r||r.call(n,e)}}))}enqueue(e){var t=e.retriesPerformedSoFar||0;e.retriesPerformedSoFar=t+1;var n=function(e){var t=3e3*Math.pow(2,e),n=t/2,r=Math.min(18e5,t),i=(Math.random()-.5)*(r-n);return Math.ceil(r+i)}(t),r=Date.now()+n;this.queue.push({retryAt:r,requestOptions:e});var i="Enqueued failed request for retry in ".concat(n);navigator.onLine||(i+=" (Browser is offline)"),po.warn(i),this.isPolling||(this.isPolling=!0,this.poll())}poll(){this.poller&&clearTimeout(this.poller),this.poller=setTimeout((()=>{this.areWeOnline&&this.queue.length>0&&this.flush(),this.poll()}),this.pollIntervalMs)}flush(){var e=Date.now(),t=[],n=this.queue.filter((n=>n.retryAt<e||(t.push(n),!1)));if(this.queue=t,n.length>0)for(var{requestOptions:r}of n)this.retriableRequest(r)}unload(){for(var{requestOptions:e}of(this.poller&&(clearTimeout(this.poller),this.poller=void 0),this.queue))try{this.instance._send_request(yo(yo({},e),{},{transport:"sendBeacon"}))}catch(e){po.error(e)}this.queue=[]}}var qu,Ku=go("[SessionId]");class $u{constructor(e,t,n){var r;if(_o(this,"_sessionIdChangedHandlers",[]),!e.persistence)throw new Error("SessionIdManager requires a PostHogPersistence instance");if(e.config.__preview_experimental_cookieless_mode)throw new Error("SessionIdManager cannot be used with __preview_experimental_cookieless_mode");this.config=e.config,this.persistence=e.persistence,this._windowId=void 0,this._sessionId=void 0,this._sessionStartTimestamp=null,this._sessionActivityTimestamp=null,this._sessionIdGenerator=t||Ca,this._windowIdGenerator=n||Ca;var i=this.config.persistence_name||this.config.token,s=this.config.session_idle_timeout_seconds||1800;if(this._sessionTimeoutMs=1e3*xl(s,60,36e3,"session_idle_timeout_seconds",1800),e.register({$configured_session_timeout_ms:this._sessionTimeoutMs}),this.resetIdleTimer(),this._window_id_storage_key="ph_"+i+"_window_id",this._primary_window_exists_storage_key="ph_"+i+"_primary_window_exists",this._canUseSessionStorage()){var o=Ka.parse(this._window_id_storage_key),a=Ka.parse(this._primary_window_exists_storage_key);o&&!a?this._windowId=o:Ka.remove(this._window_id_storage_key),Ka.set(this._primary_window_exists_storage_key,!0)}if(null!==(r=this.config.bootstrap)&&void 0!==r&&r.sessionID)try{var c=(()=>{var e=this.config.bootstrap.sessionID.replace(/-/g,"");if(32!==e.length)throw new Error("Not a valid UUID");if("7"!==e[12])throw new Error("Not a UUIDv7");return parseInt(e.substring(0,12),16)})();this._setSessionId(this.config.bootstrap.sessionID,(new Date).getTime(),c)}catch(e){Ku.error("Invalid sessionID in bootstrap",e)}this._listenToReloadWindow()}get sessionTimeoutMs(){return this._sessionTimeoutMs}onSessionId(e){return no(this._sessionIdChangedHandlers)&&(this._sessionIdChangedHandlers=[]),this._sessionIdChangedHandlers.push(e),this._sessionId&&e(this._sessionId,this._windowId),()=>{this._sessionIdChangedHandlers=this._sessionIdChangedHandlers.filter((t=>t!==e))}}_canUseSessionStorage(){return"memory"!==this.config.persistence&&!this.persistence.disabled&&Ka.is_supported()}_setWindowId(e){e!==this._windowId&&(this._windowId=e,this._canUseSessionStorage()&&Ka.set(this._window_id_storage_key,e))}_getWindowId(){return this._windowId?this._windowId:this._canUseSessionStorage()?Ka.parse(this._window_id_storage_key):null}_setSessionId(e,t,n){e===this._sessionId&&t===this._sessionActivityTimestamp&&n===this._sessionStartTimestamp||(this._sessionStartTimestamp=n,this._sessionActivityTimestamp=t,this._sessionId=e,this.persistence.register({[zo]:[t,e,n]}))}_getSessionId(){if(this._sessionId&&this._sessionActivityTimestamp&&this._sessionStartTimestamp)return[this._sessionActivityTimestamp,this._sessionId,this._sessionStartTimestamp];var e=this.persistence.props[zo];return Qs(e)&&2===e.length&&e.push(e[0]),e||[0,null,0]}resetSessionId(){this._setSessionId(null,null,null)}_listenToReloadWindow(){No(Os,"beforeunload",(()=>{this._canUseSessionStorage()&&Ka.remove(this._primary_window_exists_storage_key)}),{capture:!1})}checkAndGetSessionAndWindowId(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.config.__preview_experimental_cookieless_mode)throw new Error("checkAndGetSessionAndWindowId should not be called in __preview_experimental_cookieless_mode");var n=t||(new Date).getTime(),[r,i,s]=this._getSessionId(),o=this._getWindowId(),a=ao(s)&&s>0&&Math.abs(n-s)>864e5,c=!1,l=!i,u=!e&&Math.abs(n-r)>this.sessionTimeoutMs;l||u||a?(i=this._sessionIdGenerator(),o=this._windowIdGenerator(),Ku.info("new session ID generated",{sessionId:i,windowId:o,changeReason:{noSessionId:l,activityTimeout:u,sessionPastMaximumLength:a}}),s=n,c=!0):o||(o=this._windowIdGenerator(),c=!0);var d=0===r||!e||a?n:r,h=0===s?(new Date).getTime():s;return this._setWindowId(o),this._setSessionId(i,d,h),e||this.resetIdleTimer(),c&&this._sessionIdChangedHandlers.forEach((e=>e(i,o,c?{noSessionId:l,activityTimeout:u,sessionPastMaximumLength:a}:void 0))),{sessionId:i,windowId:o,sessionStartTimestamp:h,changeReason:c?{noSessionId:l,activityTimeout:u,sessionPastMaximumLength:a}:void 0,lastActivityTimestamp:r}}resetIdleTimer(){clearTimeout(this._enforceIdleTimeout),this._enforceIdleTimeout=setTimeout((()=>{this.resetSessionId()}),1.1*this.sessionTimeoutMs)}}!function(e){e.US="us",e.EU="eu",e.CUSTOM="custom"}(qu||(qu={}));var Vu="i.posthog.com";class Gu{constructor(e){_o(this,"_regionCache",{}),this.instance=e}get apiHost(){var e=this.instance.config.api_host.trim().replace(/\/$/,"");return"https://app.posthog.com"===e?"https://us.i.posthog.com":e}get uiHost(){var e,t=null===(e=this.instance.config.ui_host)||void 0===e?void 0:e.replace(/\/$/,"");return t||(t=this.apiHost.replace(".".concat(Vu),".posthog.com")),"https://app.posthog.com"===t?"https://us.posthog.com":t}get region(){return this._regionCache[this.apiHost]||(/https:\/\/(app|us|us-assets)(\.i)?\.posthog\.com/i.test(this.apiHost)?this._regionCache[this.apiHost]=qu.US:/https:\/\/(eu|eu-assets)(\.i)?\.posthog\.com/i.test(this.apiHost)?this._regionCache[this.apiHost]=qu.EU:this._regionCache[this.apiHost]=qu.CUSTOM),this._regionCache[this.apiHost]}endpointFor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(t&&(t="/"===t[0]?t:"/".concat(t)),"ui"===e)return this.uiHost+t;if(this.region===qu.CUSTOM)return this.apiHost+t;var n=Vu+t;switch(e){case"assets":return"https://".concat(this.region,"-assets.").concat(n);case"api":return"https://".concat(this.region,".").concat(n)}}}var Hu="posthog-js";function Wu(e){var{organization:t,projectId:n,prefix:r,severityAllowList:i=["error"]}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s=>{var o,a,c,l,u;if("*"!==i&&!i.includes(s.level)||!e.__loaded)return s;s.tags||(s.tags={});var d=e.requestRouter.endpointFor("ui","/project/".concat(e.config.token,"/person/").concat(e.get_distinct_id()));s.tags["PostHog Person URL"]=d,e.sessionRecordingStarted()&&(s.tags["PostHog Recording URL"]=e.get_session_replay_url({withTimestamp:!0}));var h=(null===(o=s.exception)||void 0===o?void 0:o.values)||[];h.forEach((e=>{e.stacktrace&&(e.stacktrace.type="raw",e.stacktrace.frames.forEach((e=>{e.platform="web:javascript"})))}));var p={$exception_message:(null===(a=h[0])||void 0===a?void 0:a.value)||s.message,$exception_type:null===(c=h[0])||void 0===c?void 0:c.type,$exception_personURL:d,$exception_level:s.level,$exception_list:h,$sentry_event_id:s.event_id,$sentry_exception:s.exception,$sentry_exception_message:(null===(l=h[0])||void 0===l?void 0:l.value)||s.message,$sentry_exception_type:null===(u=h[0])||void 0===u?void 0:u.type,$sentry_tags:s.tags};return t&&n&&(p.$sentry_url=(r||"https://sentry.io/organizations/")+t+"/issues/?project="+n+"&query="+s.event_id),e.exceptions.sendExceptionEvent(p),s}}class Ju{constructor(e,t,n,r,i){this.name=Hu,this.setupOnce=function(s){s(Wu(e,{organization:t,projectId:n,prefix:r,severityAllowList:i}))}}}var Yu=go("[SegmentIntegration]");class zu{constructor(e){this._instance=e}doPageView(e,t){var n,r=this._previousPageViewProperties(e,t);return this._currentPageview={pathname:null!==(n=null==Os?void 0:Os.location.pathname)&&void 0!==n?n:"",pageViewId:t,timestamp:e},this._instance.scrollManager.resetContext(),r}doPageLeave(e){var t;return this._previousPageViewProperties(e,null===(t=this._currentPageview)||void 0===t?void 0:t.pageViewId)}doEvent(){var e;return{$pageview_id:null===(e=this._currentPageview)||void 0===e?void 0:e.pageViewId}}_previousPageViewProperties(e,t){var n=this._currentPageview;if(!n)return{$pageview_id:t};var r={$pageview_id:t,$prev_pageview_id:n.pageViewId},i=this._instance.scrollManager.getContext();if(i&&!this._instance.config.disable_scroll_properties){var{maxScrollHeight:s,lastScrollY:o,maxScrollY:a,maxContentHeight:c,lastContentY:l,maxContentY:u}=i;if(!(no(s)||no(o)||no(a)||no(c)||no(l)||no(u))){s=Math.ceil(s),o=Math.ceil(o),a=Math.ceil(a),c=Math.ceil(c),l=Math.ceil(l),u=Math.ceil(u);var d=s<=1?1:xl(o/s,0,1),h=s<=1?1:xl(a/s,0,1),p=c<=1?1:xl(l/c,0,1),g=c<=1?1:xl(u/c,0,1);r=wo(r,{$prev_pageview_last_scroll:o,$prev_pageview_last_scroll_percentage:d,$prev_pageview_max_scroll:a,$prev_pageview_max_scroll_percentage:h,$prev_pageview_last_content:l,$prev_pageview_last_content_percentage:p,$prev_pageview_max_content:u,$prev_pageview_max_content_percentage:g})}}return n.pathname&&(r.$prev_pageview_pathname=n.pathname),n.timestamp&&(r.$prev_pageview_duration=(e.getTime()-n.timestamp.getTime())/1e3),r}}var Xu,Qu,Zu,ed,td,nd,rd,id,sd,od,ad,cd={},ld=[],ud=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,dd=Array.isArray;function hd(e,t){for(var n in t)e[n]=t[n];return e}function pd(e){var t=e.parentNode;t&&t.removeChild(e)}function gd(e,t,n,r,i){var s={type:e,props:t,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,constructor:void 0,__v:null==i?++Zu:i,__i:-1,__u:0};return null==i&&null!=Qu.vnode&&Qu.vnode(s),s}function fd(e){return e.children}function md(e,t){this.props=e,this.context=t}function vd(e,t){if(null==t)return e.__?vd(e.__,e.__i+1):null;for(var n;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e)return n.__e;return"function"==typeof e.type?vd(e):null}function yd(e){var t,n;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e){e.__e=e.__c.base=n.__e;break}return yd(e)}}function _d(e){(!e.__d&&(e.__d=!0)&&ed.push(e)&&!bd.__r++||td!==Qu.debounceRendering)&&((td=Qu.debounceRendering)||nd)(bd)}function bd(){var e,t,n,r,i,s,o,a,c;for(ed.sort(rd);e=ed.shift();)e.__d&&(t=ed.length,r=void 0,s=(i=(n=e).__v).__e,a=[],c=[],(o=n.__P)&&((r=hd({},i)).__v=i.__v+1,Qu.vnode&&Qu.vnode(r),Rd(o,r,i,n.__n,void 0!==o.ownerSVGElement,32&i.__u?[s]:null,a,null==s?vd(i):s,!!(32&i.__u),c),r.__.__k[r.__i]=r,Od(a,r,c),r.__e!=s&&yd(r)),ed.length>t&&ed.sort(rd));bd.__r=0}function Ed(e,t,n,r,i,s,o,a,c,l,u){var d,h,p,g,f,m=r&&r.__k||ld,v=t.length;for(n.__d=c,function(e,t,n){var r,i,s,o,a,c=t.length,l=n.length,u=l,d=0;for(e.__k=[],r=0;r<c;r++)null!=(i=e.__k[r]=null==(i=t[r])||"boolean"==typeof i||"function"==typeof i?null:"string"==typeof i||"number"==typeof i||"bigint"==typeof i||i.constructor==String?gd(null,i,null,null,i):dd(i)?gd(fd,{children:i},null,null,null):void 0===i.constructor&&i.__b>0?gd(i.type,i.props,i.key,i.ref?i.ref:null,i.__v):i)?(i.__=e,i.__b=e.__b+1,a=Sd(i,n,o=r+d,u),i.__i=a,s=null,-1!==a&&(u--,(s=n[a])&&(s.__u|=131072)),null==s||null===s.__v?(-1==a&&d--,"function"!=typeof i.type&&(i.__u|=65536)):a!==o&&(a===o+1?d++:a>o?u>c-o?d+=a-o:d--:d=a<o&&a==o-1?a-o:0,a!==r+d&&(i.__u|=65536))):(s=n[r])&&null==s.key&&s.__e&&(s.__e==e.__d&&(e.__d=vd(s)),Pd(s,s,!1),n[r]=null,u--);if(u)for(r=0;r<l;r++)null!=(s=n[r])&&!(131072&s.__u)&&(s.__e==e.__d&&(e.__d=vd(s)),Pd(s,s))}(n,t,m),c=n.__d,d=0;d<v;d++)null!=(p=n.__k[d])&&"boolean"!=typeof p&&"function"!=typeof p&&(h=-1===p.__i?cd:m[p.__i]||cd,p.__i=d,Rd(e,p,h,i,s,o,a,c,l,u),g=p.__e,p.ref&&h.ref!=p.ref&&(h.ref&&Cd(h.ref,null,p),u.push(p.ref,p.__c||g,p)),null==f&&null!=g&&(f=g),65536&p.__u||h.__k===p.__k?c=Ad(p,c,e):"function"==typeof p.type&&void 0!==p.__d?c=p.__d:g&&(c=g.nextSibling),p.__d=void 0,p.__u&=-196609);n.__d=c,n.__e=f}function Ad(e,t,n){var r,i;if("function"==typeof e.type){for(r=e.__k,i=0;r&&i<r.length;i++)r[i]&&(r[i].__=e,t=Ad(r[i],t,n));return t}return e.__e!=t&&(n.insertBefore(e.__e,t||null),t=e.__e),t&&t.nextSibling}function Sd(e,t,n,r){var i=e.key,s=e.type,o=n-1,a=n+1,c=t[n];if(null===c||c&&i==c.key&&s===c.type)return n;if(r>(null==c||131072&c.__u?0:1))for(;o>=0||a<t.length;){if(o>=0){if((c=t[o])&&!(131072&c.__u)&&i==c.key&&s===c.type)return o;o--}if(a<t.length){if((c=t[a])&&!(131072&c.__u)&&i==c.key&&s===c.type)return a;a++}}return-1}function wd(e,t,n){"-"===t[0]?e.setProperty(t,null==n?"":n):e[t]=null==n?"":"number"!=typeof n||ud.test(t)?n:n+"px"}function Id(e,t,n,r,i){var s;e:if("style"===t)if("string"==typeof n)e.style.cssText=n;else{if("string"==typeof r&&(e.style.cssText=r=""),r)for(t in r)n&&t in n||wd(e.style,t,"");if(n)for(t in n)r&&n[t]===r[t]||wd(e.style,t,n[t])}else if("o"===t[0]&&"n"===t[1])s=t!==(t=t.replace(/(PointerCapture)$|Capture$/,"$1")),t=t.toLowerCase()in e?t.toLowerCase().slice(2):t.slice(2),e.l||(e.l={}),e.l[t+s]=n,n?r?n.u=r.u:(n.u=Date.now(),e.addEventListener(t,s?kd:Td,s)):e.removeEventListener(t,s?kd:Td,s);else{if(i)t=t.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if("width"!==t&&"height"!==t&&"href"!==t&&"list"!==t&&"form"!==t&&"tabIndex"!==t&&"download"!==t&&"rowSpan"!==t&&"colSpan"!==t&&"role"!==t&&t in e)try{e[t]=null==n?"":n;break e}catch(e){}"function"==typeof n||(null==n||!1===n&&"-"!==t[4]?e.removeAttribute(t):e.setAttribute(t,n))}}function Td(e){var t=this.l[e.type+!1];if(e.t){if(e.t<=t.u)return}else e.t=Date.now();return t(Qu.event?Qu.event(e):e)}function kd(e){return this.l[e.type+!0](Qu.event?Qu.event(e):e)}function Rd(e,t,n,r,i,s,o,a,c,l){var u,d,h,p,g,f,m,v,y,_,b,E,A,S,w,I=t.type;if(void 0!==t.constructor)return null;128&n.__u&&(c=!!(32&n.__u),s=[a=t.__e=n.__e]),(u=Qu.__b)&&u(t);e:if("function"==typeof I)try{if(v=t.props,y=(u=I.contextType)&&r[u.__c],_=u?y?y.props.value:u.__:r,n.__c?m=(d=t.__c=n.__c).__=d.__E:("prototype"in I&&I.prototype.render?t.__c=d=new I(v,_):(t.__c=d=new md(v,_),d.constructor=I,d.render=Dd),y&&y.sub(d),d.props=v,d.state||(d.state={}),d.context=_,d.__n=r,h=d.__d=!0,d.__h=[],d._sb=[]),null==d.__s&&(d.__s=d.state),null!=I.getDerivedStateFromProps&&(d.__s==d.state&&(d.__s=hd({},d.__s)),hd(d.__s,I.getDerivedStateFromProps(v,d.__s))),p=d.props,g=d.state,d.__v=t,h)null==I.getDerivedStateFromProps&&null!=d.componentWillMount&&d.componentWillMount(),null!=d.componentDidMount&&d.__h.push(d.componentDidMount);else{if(null==I.getDerivedStateFromProps&&v!==p&&null!=d.componentWillReceiveProps&&d.componentWillReceiveProps(v,_),!d.__e&&(null!=d.shouldComponentUpdate&&!1===d.shouldComponentUpdate(v,d.__s,_)||t.__v===n.__v)){for(t.__v!==n.__v&&(d.props=v,d.state=d.__s,d.__d=!1),t.__e=n.__e,t.__k=n.__k,t.__k.forEach((function(e){e&&(e.__=t)})),b=0;b<d._sb.length;b++)d.__h.push(d._sb[b]);d._sb=[],d.__h.length&&o.push(d);break e}null!=d.componentWillUpdate&&d.componentWillUpdate(v,d.__s,_),null!=d.componentDidUpdate&&d.__h.push((function(){d.componentDidUpdate(p,g,f)}))}if(d.context=_,d.props=v,d.__P=e,d.__e=!1,E=Qu.__r,A=0,"prototype"in I&&I.prototype.render){for(d.state=d.__s,d.__d=!1,E&&E(t),u=d.render(d.props,d.state,d.context),S=0;S<d._sb.length;S++)d.__h.push(d._sb[S]);d._sb=[]}else do{d.__d=!1,E&&E(t),u=d.render(d.props,d.state,d.context),d.state=d.__s}while(d.__d&&++A<25);d.state=d.__s,null!=d.getChildContext&&(r=hd(hd({},r),d.getChildContext())),h||null==d.getSnapshotBeforeUpdate||(f=d.getSnapshotBeforeUpdate(p,g)),Ed(e,dd(w=null!=u&&u.type===fd&&null==u.key?u.props.children:u)?w:[w],t,n,r,i,s,o,a,c,l),d.base=t.__e,t.__u&=-161,d.__h.length&&o.push(d),m&&(d.__E=d.__=null)}catch(e){t.__v=null,c||null!=s?(t.__e=a,t.__u|=c?160:32,s[s.indexOf(a)]=null):(t.__e=n.__e,t.__k=n.__k),Qu.__e(e,t,n)}else null==s&&t.__v===n.__v?(t.__k=n.__k,t.__e=n.__e):t.__e=function(e,t,n,r,i,s,o,a,c){var l,u,d,h,p,g,f,m=n.props,v=t.props,y=t.type;if("svg"===y&&(i=!0),null!=s)for(l=0;l<s.length;l++)if((p=s[l])&&"setAttribute"in p==!!y&&(y?p.localName===y:3===p.nodeType)){e=p,s[l]=null;break}if(null==e){if(null===y)return document.createTextNode(v);e=i?document.createElementNS("http://www.w3.org/2000/svg",y):document.createElement(y,v.is&&v),s=null,a=!1}if(null===y)m===v||a&&e.data===v||(e.data=v);else{if(s=s&&Xu.call(e.childNodes),m=n.props||cd,!a&&null!=s)for(m={},l=0;l<e.attributes.length;l++)m[(p=e.attributes[l]).name]=p.value;for(l in m)p=m[l],"children"==l||("dangerouslySetInnerHTML"==l?d=p:"key"===l||l in v||Id(e,l,null,p,i));for(l in v)p=v[l],"children"==l?h=p:"dangerouslySetInnerHTML"==l?u=p:"value"==l?g=p:"checked"==l?f=p:"key"===l||a&&"function"!=typeof p||m[l]===p||Id(e,l,p,m[l],i);if(u)a||d&&(u.__html===d.__html||u.__html===e.innerHTML)||(e.innerHTML=u.__html),t.__k=[];else if(d&&(e.innerHTML=""),Ed(e,dd(h)?h:[h],t,n,r,i&&"foreignObject"!==y,s,o,s?s[0]:n.__k&&vd(n,0),a,c),null!=s)for(l=s.length;l--;)null!=s[l]&&pd(s[l]);a||(l="value",void 0!==g&&(g!==e[l]||"progress"===y&&!g||"option"===y&&g!==m[l])&&Id(e,l,g,m[l],!1),l="checked",void 0!==f&&f!==e[l]&&Id(e,l,f,m[l],!1))}return e}(n.__e,t,n,r,i,s,o,c,l);(u=Qu.diffed)&&u(t)}function Od(e,t,n){t.__d=void 0;for(var r=0;r<n.length;r++)Cd(n[r],n[++r],n[++r]);Qu.__c&&Qu.__c(t,e),e.some((function(t){try{e=t.__h,t.__h=[],e.some((function(e){e.call(t)}))}catch(e){Qu.__e(e,t.__v)}}))}function Cd(e,t,n){try{"function"==typeof e?e(t):e.current=t}catch(e){Qu.__e(e,n)}}function Pd(e,t,n){var r,i;if(Qu.unmount&&Qu.unmount(e),(r=e.ref)&&(r.current&&r.current!==e.__e||Cd(r,null,t)),null!=(r=e.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(e){Qu.__e(e,t)}r.base=r.__P=null,e.__c=void 0}if(r=e.__k)for(i=0;i<r.length;i++)r[i]&&Pd(r[i],t,n||"function"!=typeof e.type);n||null==e.__e||pd(e.__e),e.__=e.__e=e.__d=void 0}function Dd(e,t,n){return this.constructor(e,n)}Xu=ld.slice,Qu={__e:function(e,t,n,r){for(var i,s,o;t=t.__;)if((i=t.__c)&&!i.__)try{if((s=i.constructor)&&null!=s.getDerivedStateFromError&&(i.setState(s.getDerivedStateFromError(e)),o=i.__d),null!=i.componentDidCatch&&(i.componentDidCatch(e,r||{}),o=i.__d),o)return i.__E=i}catch(t){e=t}throw e}},Zu=0,md.prototype.setState=function(e,t){var n;n=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=hd({},this.state),"function"==typeof e&&(e=e(hd({},n),this.props)),e&&hd(n,e),null!=e&&this.__v&&(t&&this._sb.push(t),_d(this))},md.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),_d(this))},md.prototype.render=fd,ed=[],nd="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,rd=function(e,t){return e.__v.__b-t.__v.__b},bd.__r=0,id=0,function(e,t){var n={__c:t="__cC"+id++,__:{isPreviewMode:!1,previewPageIndex:0,handleCloseSurveyPopup:()=>{},isPopup:!0,onPreviewSubmit:()=>{}},Consumer:function(e,t){return e.children(t)},Provider:function(e){var n,r;return this.getChildContext||(n=[],(r={})[t]=this,this.getChildContext=function(){return r},this.shouldComponentUpdate=function(e){this.props.value!==e.value&&n.some((function(e){e.__e=!0,_d(e)}))},this.sub=function(e){n.push(e);var t=e.componentWillUnmount;e.componentWillUnmount=function(){n.splice(n.indexOf(e),1),t&&t.call(e)}}),e.children}};n.Provider.__=n.Consumer.contextType=n}(),function(e){e.Popover="popover",e.API="api",e.Widget="widget"}(sd||(sd={})),function(e){e.Open="open",e.MultipleChoice="multiple_choice",e.SingleChoice="single_choice",e.Rating="rating",e.Link="link"}(od||(od={})),function(e){e.NextQuestion="next_question",e.End="end",e.ResponseBased="response_based",e.SpecificQuestion="specific_question"}(ad||(ad={}));var Nd=function(e,t){if(!function(e){try{new RegExp(e)}catch(e){return!1}return!0}(t))return!1;try{return new RegExp(t).test(e)}catch(e){return!1}};class xd{constructor(){_o(this,"events",{}),this.events={}}on(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),()=>{this.events[e]=this.events[e].filter((e=>e!==t))}}emit(e,t){for(var n of this.events[e]||[])n(t);for(var r of this.events["*"]||[])r(e,t)}}class Md{constructor(e){_o(this,"_debugEventEmitter",new xd),_o(this,"checkStep",((e,t)=>this.checkStepEvent(e,t)&&this.checkStepUrl(e,t)&&this.checkStepElement(e,t))),_o(this,"checkStepEvent",((e,t)=>null==t||!t.event||(null==e?void 0:e.event)===(null==t?void 0:t.event))),this.instance=e,this.actionEvents=new Set,this.actionRegistry=new Set}init(){var e,t;no(null===(e=this.instance)||void 0===e?void 0:e._addCaptureHook)||null===(t=this.instance)||void 0===t||t._addCaptureHook(((e,t)=>{this.on(e,t)}))}register(e){var t,n;if(!no(null===(t=this.instance)||void 0===t?void 0:t._addCaptureHook)&&(e.forEach((e=>{var t,n;null===(t=this.actionRegistry)||void 0===t||t.add(e),null===(n=e.steps)||void 0===n||n.forEach((e=>{var t;null===(t=this.actionEvents)||void 0===t||t.add((null==e?void 0:e.event)||"")}))})),null!==(n=this.instance)&&void 0!==n&&n.autocapture)){var r,i=new Set;e.forEach((e=>{var t;null===(t=e.steps)||void 0===t||t.forEach((e=>{null!=e&&e.selector&&i.add(null==e?void 0:e.selector)}))})),null===(r=this.instance)||void 0===r||r.autocapture.setElementSelectors(i)}}on(e,t){var n;null!=t&&0!=e.length&&(this.actionEvents.has(e)||this.actionEvents.has(null==t?void 0:t.event))&&this.actionRegistry&&(null===(n=this.actionRegistry)||void 0===n?void 0:n.size)>0&&this.actionRegistry.forEach((e=>{this.checkAction(t,e)&&this._debugEventEmitter.emit("actionCaptured",e.name)}))}_addActionHook(e){this.onAction("actionCaptured",(t=>e(t)))}checkAction(e,t){if(null==(null==t?void 0:t.steps))return!1;for(var n of t.steps)if(this.checkStep(e,n))return!0;return!1}onAction(e,t){return this._debugEventEmitter.on(e,t)}checkStepUrl(e,t){if(null!=t&&t.url){var n,r=null==e||null===(n=e.properties)||void 0===n?void 0:n.$current_url;if(!r||"string"!=typeof r)return!1;if(!Md.matchString(r,null==t?void 0:t.url,(null==t?void 0:t.url_matching)||"contains"))return!1}return!0}static matchString(e,t,n){switch(n){case"regex":return!!Os&&Nd(e,t);case"exact":return t===e;case"contains":var r=Md.escapeStringRegexp(t).replace(/_/g,".").replace(/%/g,".*");return Nd(e,r);default:return!1}}static escapeStringRegexp(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}checkStepElement(e,t){if((null!=t&&t.href||null!=t&&t.tag_name||null!=t&&t.text)&&!this.getElementsList(e).some((e=>!(null!=t&&t.href&&!Md.matchString(e.href||"",null==t?void 0:t.href,(null==t?void 0:t.href_matching)||"exact")||null!=t&&t.tag_name&&e.tag_name!==(null==t?void 0:t.tag_name)||null!=t&&t.text&&!Md.matchString(e.text||"",null==t?void 0:t.text,(null==t?void 0:t.text_matching)||"exact")&&!Md.matchString(e.$el_text||"",null==t?void 0:t.text,(null==t?void 0:t.text_matching)||"exact")))))return!1;if(null!=t&&t.selector){var n,r=null==e||null===(n=e.properties)||void 0===n?void 0:n.$element_selectors;if(!r)return!1;if(!r.includes(null==t?void 0:t.selector))return!1}return!0}getElementsList(e){return null==(null==e?void 0:e.properties.$elements)?[]:null==e?void 0:e.properties.$elements}}class Ld{constructor(e){this.instance=e,this.eventToSurveys=new Map,this.actionToSurveys=new Map}register(e){var t;no(null===(t=this.instance)||void 0===t?void 0:t._addCaptureHook)||(this.setupEventBasedSurveys(e),this.setupActionBasedSurveys(e))}setupActionBasedSurveys(e){var t=e.filter((e=>{var t,n,r,i;return(null===(t=e.conditions)||void 0===t?void 0:t.actions)&&(null===(n=e.conditions)||void 0===n||null===(r=n.actions)||void 0===r||null===(i=r.values)||void 0===i?void 0:i.length)>0}));0!==t.length&&(null==this.actionMatcher&&(this.actionMatcher=new Md(this.instance),this.actionMatcher.init(),this.actionMatcher._addActionHook((e=>{this.onAction(e)}))),t.forEach((e=>{var t,n,r,i,s,o,a,c,l,u;e.conditions&&null!==(t=e.conditions)&&void 0!==t&&t.actions&&null!==(n=e.conditions)&&void 0!==n&&null!==(r=n.actions)&&void 0!==r&&r.values&&(null===(i=e.conditions)||void 0===i||null===(s=i.actions)||void 0===s||null===(o=s.values)||void 0===o?void 0:o.length)>0&&(null===(a=this.actionMatcher)||void 0===a||a.register(e.conditions.actions.values),null===(c=e.conditions)||void 0===c||null===(l=c.actions)||void 0===l||null===(u=l.values)||void 0===u||u.forEach((t=>{if(t&&t.name){var n=this.actionToSurveys.get(t.name);n&&n.push(e.id),this.actionToSurveys.set(t.name,n||[e.id])}})))})))}setupEventBasedSurveys(e){var t;0!==e.filter((e=>{var t,n,r,i;return(null===(t=e.conditions)||void 0===t?void 0:t.events)&&(null===(n=e.conditions)||void 0===n||null===(r=n.events)||void 0===r||null===(i=r.values)||void 0===i?void 0:i.length)>0})).length&&(null===(t=this.instance)||void 0===t||t._addCaptureHook(((e,t)=>{this.onEvent(e,t)})),e.forEach((e=>{var t,n,r;null===(t=e.conditions)||void 0===t||null===(n=t.events)||void 0===n||null===(r=n.values)||void 0===r||r.forEach((t=>{if(t&&t.name){var n=this.eventToSurveys.get(t.name);n&&n.push(e.id),this.eventToSurveys.set(t.name,n||[e.id])}}))})))}onEvent(e,t){var n,r,i=(null===(n=this.instance)||void 0===n||null===(r=n.persistence)||void 0===r?void 0:r.props[sa])||[];if(Ld.SURVEY_SHOWN_EVENT_NAME==e&&t&&i.length>0){var s,o=null==t||null===(s=t.properties)||void 0===s?void 0:s.$survey_id;if(o){var a=i.indexOf(o);a>=0&&(i.splice(a,1),this._updateActivatedSurveys(i))}}else this.eventToSurveys.has(e)&&this._updateActivatedSurveys(i.concat(this.eventToSurveys.get(e)||[]))}onAction(e){var t,n,r=(null===(t=this.instance)||void 0===t||null===(n=t.persistence)||void 0===n?void 0:n.props[sa])||[];this.actionToSurveys.has(e)&&this._updateActivatedSurveys(r.concat(this.actionToSurveys.get(e)||[]))}_updateActivatedSurveys(e){var t,n;null===(t=this.instance)||void 0===t||null===(n=t.persistence)||void 0===n||n.register({[sa]:[...new Set(e)]})}getSurveys(){var e,t;return(null===(e=this.instance)||void 0===e||null===(t=e.persistence)||void 0===t?void 0:t.props[sa])||[]}getEventToSurveys(){return this.eventToSurveys}_getActionMatcher(){return this.actionMatcher}}_o(Ld,"SURVEY_SHOWN_EVENT_NAME","survey shown");var Bd=go("[Surveys]"),Ud={icontains:(e,t)=>e.some((e=>t.toLowerCase().includes(e.toLowerCase()))),not_icontains:(e,t)=>e.every((e=>!t.toLowerCase().includes(e.toLowerCase()))),regex:(e,t)=>e.some((e=>Nd(t,e))),not_regex:(e,t)=>e.every((e=>!Nd(t,e))),exact:(e,t)=>e.some((e=>t===e)),is_not:(e,t)=>e.every((e=>t!==e))};function Fd(e,t,n){var r,i=e.questions[t],s=t+1;if(null===(r=i.branching)||void 0===r||!r.type)return t===e.questions.length-1?ad.End:s;if(i.branching.type===ad.End)return ad.End;if(i.branching.type===ad.SpecificQuestion){if(Number.isInteger(i.branching.index))return i.branching.index}else if(i.branching.type===ad.ResponseBased){if(i.type===od.SingleChoice){var o,a,c=i.choices.indexOf("".concat(n));if(null!==(o=i.branching)&&void 0!==o&&null!==(a=o.responseValues)&&void 0!==a&&a.hasOwnProperty(c)){var l=i.branching.responseValues[c];return Number.isInteger(l)?l:l===ad.End?ad.End:s}}else if(i.type===od.Rating){var u,d;if("number"!=typeof n||!Number.isInteger(n))throw new Error("The response type must be an integer");var h=function(e,t){if(3===t){if(e<1||e>3)throw new Error("The response must be in range 1-3");return 1===e?"negative":2===e?"neutral":"positive"}if(5===t){if(e<1||e>5)throw new Error("The response must be in range 1-5");return e<=2?"negative":3===e?"neutral":"positive"}if(7===t){if(e<1||e>7)throw new Error("The response must be in range 1-7");return e<=3?"negative":4===e?"neutral":"positive"}if(10===t){if(e<0||e>10)throw new Error("The response must be in range 0-10");return e<=6?"detractors":e<=8?"passives":"promoters"}throw new Error("The scale must be one of: 3, 5, 7, 10")}(n,i.scale);if(null!==(u=i.branching)&&void 0!==u&&null!==(d=u.responseValues)&&void 0!==d&&d.hasOwnProperty(h)){var p=i.branching.responseValues[h];return Number.isInteger(p)?p:p===ad.End?ad.End:s}}return s}return Bd.warn("Falling back to next question index due to unexpected branching type"),s}function jd(e){return null!=e?e:"icontains"}class qd{constructor(e){_o(this,"getNextSurveyStep",Fd),this.instance=e,this._surveyEventReceiver=null}onRemoteConfig(e){this._decideServerResponse=!!e.surveys,Bd.info("decideServerResponse set to ".concat(this._decideServerResponse)),this.loadIfEnabled()}reset(){localStorage.removeItem("lastSeenSurveyDate");var e=(()=>{for(var e=[],t=0;t<localStorage.length;t++){var n=localStorage.key(t);null!=n&&n.startsWith("seenSurvey_")&&e.push(n)}return e})();e.forEach((e=>localStorage.removeItem(e)))}loadIfEnabled(){if(!this._surveyManager)if(this.instance.config.disable_surveys)Bd.info("Disabled. Not loading surveys.");else{var e=null==qs?void 0:qs.__PosthogExtensions__;if(e){var t=e.generateSurveys;if(this._decideServerResponse)if(null==this._surveyEventReceiver&&(this._surveyEventReceiver=new Ld(this.instance)),t)this._surveyManager=t(this.instance);else{var n=e.loadExternalDependency;n?n(this.instance,"surveys",(t=>{var n;t?Bd.error("Could not load surveys script",t):this._surveyManager=null===(n=e.generateSurveys)||void 0===n?void 0:n.call(e,this.instance)})):Bd.error("PostHog loadExternalDependency extension not found. Cannot load remote config.")}else Bd.warn("Decide not loaded yet. Not loading surveys.")}else Bd.error("PostHog Extensions not found.")}}getSurveys(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.instance.config.disable_surveys)return Bd.info("Disabled. Not loading surveys."),e([]);null==this._surveyEventReceiver&&(this._surveyEventReceiver=new Ld(this.instance));var n=this.instance.get_property(ia);if(n&&!t)return e(n);this.instance._send_request({url:this.instance.requestRouter.endpointFor("api","/api/surveys/?token=".concat(this.instance.config.token)),method:"GET",callback:t=>{var n,r=t.statusCode;if(200!==r||!t.json)return Bd.error("Surveys API could not be loaded, status: ".concat(r)),e([]);var i,s=t.json.surveys||[],o=s.filter((e=>{var t,n,r,i,s,o,a,c,l,u,d,h;return(null===(t=e.conditions)||void 0===t?void 0:t.events)&&(null===(n=e.conditions)||void 0===n||null===(r=n.events)||void 0===r?void 0:r.values)&&(null===(i=e.conditions)||void 0===i||null===(s=i.events)||void 0===s||null===(o=s.values)||void 0===o?void 0:o.length)>0||(null===(a=e.conditions)||void 0===a?void 0:a.actions)&&(null===(c=e.conditions)||void 0===c||null===(l=c.actions)||void 0===l?void 0:l.values)&&(null===(u=e.conditions)||void 0===u||null===(d=u.actions)||void 0===d||null===(h=d.values)||void 0===h?void 0:h.length)>0}));return o.length>0&&(null===(i=this._surveyEventReceiver)||void 0===i||i.register(o)),null===(n=this.instance.persistence)||void 0===n||n.register({[ia]:s}),e(s)}})}isSurveyFeatureFlagEnabled(e){return!e||this.instance.featureFlags.isFeatureEnabled(e)}getActiveMatchingSurveys(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.getSurveys((t=>{var n,r=t.filter((e=>!(!e.start_date||e.end_date))).filter((e=>{var t;if(!e.conditions)return!0;var n=function(e){var t,n,r;if(null===(t=e.conditions)||void 0===t||!t.url)return!0;var i=null==Os||null===(n=Os.location)||void 0===n?void 0:n.href;if(!i)return!1;var s=[e.conditions.url];return Ud[jd(null===(r=e.conditions)||void 0===r?void 0:r.urlMatchType)](s,i)}(e),r=null===(t=e.conditions)||void 0===t||!t.selector||(null==Ms?void 0:Ms.querySelector(e.conditions.selector)),i=function(e){var t,n,r;if(null===(t=e.conditions)||void 0===t||!t.deviceTypes||0===(null===(n=e.conditions)||void 0===n?void 0:n.deviceTypes.length))return!0;if(!js)return!1;var i=Hc.deviceType(js);return Ud[jd(null===(r=e.conditions)||void 0===r?void 0:r.deviceTypesMatchType)](e.conditions.deviceTypes,i)}(e);return n&&r&&i})),i=null===(n=this._surveyEventReceiver)||void 0===n?void 0:n.getSurveys(),s=r.filter((e=>{var t,n,r,s,o,a,c,l,u;if(!(e.linked_flag_key||e.targeting_flag_key||e.internal_targeting_flag_key||null!==(t=e.feature_flag_keys)&&void 0!==t&&t.length))return!0;var d=this.isSurveyFeatureFlagEnabled(e.linked_flag_key),h=this.isSurveyFeatureFlagEnabled(e.targeting_flag_key),p=(null!==(n=null===(r=e.conditions)||void 0===r||null===(s=r.events)||void 0===s||null===(o=s.values)||void 0===o?void 0:o.length)&&void 0!==n?n:0)>0,g=(null!==(a=null===(c=e.conditions)||void 0===c||null===(l=c.actions)||void 0===l||null===(u=l.values)||void 0===u?void 0:u.length)&&void 0!==a?a:0)>0,f=!p&&!g||(null==i?void 0:i.includes(e.id)),m=this._canActivateRepeatedly(e)||this.isSurveyFeatureFlagEnabled(e.internal_targeting_flag_key),v=this.checkFlags(e);return d&&h&&m&&f&&v}));return e(s)}),t)}checkFlags(e){var t;return null===(t=e.feature_flag_keys)||void 0===t||!t.length||e.feature_flag_keys.every((e=>{var{key:t,value:n}=e;return!t||!n||this.instance.featureFlags.isFeatureEnabled(n)}))}_canActivateRepeatedly(e){var t;return oo(null===(t=qs.__PosthogExtensions__)||void 0===t?void 0:t.canActivateRepeatedly)?(Bd.warn("init was not called"),!1):qs.__PosthogExtensions__.canActivateRepeatedly(e)}canRenderSurvey(e){oo(this._surveyManager)?Bd.warn("init was not called"):this.getSurveys((t=>{var n=t.filter((t=>t.id===e))[0];this._surveyManager.canRenderSurvey(n)}))}renderSurvey(e,t){oo(this._surveyManager)?Bd.warn("init was not called"):this.getSurveys((n=>{var r=n.filter((t=>t.id===e))[0];this._surveyManager.renderSurvey(r,null==Ms?void 0:Ms.querySelector(t))}))}}var Kd=go("[RateLimiter]");class $d{constructor(e){var t,n;_o(this,"serverLimits",{}),_o(this,"lastEventRateLimited",!1),_o(this,"checkForLimiting",(e=>{var t=e.text;if(t&&t.length)try{(JSON.parse(t).quota_limited||[]).forEach((e=>{Kd.info("".concat(e||"events"," is quota limited.")),this.serverLimits[e]=(new Date).getTime()+6e4}))}catch(e){return void Kd.warn('could not rate limit - continuing. Error: "'.concat(null==e?void 0:e.message,'"'),{text:t})}})),this.instance=e,this.captureEventsPerSecond=(null===(t=e.config.rate_limiting)||void 0===t?void 0:t.events_per_second)||10,this.captureEventsBurstLimit=Math.max((null===(n=e.config.rate_limiting)||void 0===n?void 0:n.events_burst_limit)||10*this.captureEventsPerSecond,this.captureEventsPerSecond),this.lastEventRateLimited=this.clientRateLimitContext(!0).isRateLimited}clientRateLimitContext(){var e,t,n,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=(new Date).getTime(),s=null!==(e=null===(t=this.instance.persistence)||void 0===t?void 0:t.get_property(la))&&void 0!==e?e:{tokens:this.captureEventsBurstLimit,last:i};s.tokens+=(i-s.last)/1e3*this.captureEventsPerSecond,s.last=i,s.tokens>this.captureEventsBurstLimit&&(s.tokens=this.captureEventsBurstLimit);var o=s.tokens<1;return o||r||(s.tokens=Math.max(0,s.tokens-1)),!o||this.lastEventRateLimited||r||this.instance.capture("$$client_ingestion_warning",{$$client_ingestion_warning_message:"posthog-js client rate limited. Config is set to ".concat(this.captureEventsPerSecond," events per second and ").concat(this.captureEventsBurstLimit," events burst limit.")},{skip_client_rate_limiting:!0}),this.lastEventRateLimited=o,null===(n=this.instance.persistence)||void 0===n||n.set_property(la,s),{isRateLimited:o,remainingTokens:s.tokens}}isServerRateLimited(e){var t=this.serverLimits[e||"events"]||!1;return!1!==t&&(new Date).getTime()<t}}var Vd=e=>Hc.personInfo({maskPersonalDataProperties:null==e?void 0:e.config.mask_personal_data_properties,customPersonalDataProperties:null==e?void 0:e.config.custom_personal_data_properties});class Gd{constructor(e,t,n,r){_o(this,"_onSessionIdCallback",(e=>{var t=this._getStored();if(!t||t.sessionId!==e){var n={sessionId:e,props:this._sessionSourceParamGenerator(this.instance)};this._persistence.register({[ca]:n})}})),this.instance=e,this._sessionIdManager=t,this._persistence=n,this._sessionSourceParamGenerator=r||Vd,this._sessionIdManager.onSessionId(this._onSessionIdCallback)}_getStored(){return this._persistence.props[ca]}getSetOnceInitialSessionPropsProps(){var e,t=null===(e=this._getStored())||void 0===e?void 0:e.props;return t?"r"in t?Hc.personPropsFromInfo(t):{$referring_domain:t.referringDomain,$pathname:t.initialPathName,utm_source:t.utm_source,utm_campaign:t.utm_campaign,utm_medium:t.utm_medium,utm_content:t.utm_content,utm_term:t.utm_term}:{}}}var Hd=["ahrefsbot","ahrefssiteaudit","applebot","baiduspider","better uptime bot","bingbot","bingpreview","bot.htm","bot.php","chrome-lighthouse","crawler","deepscan","duckduckbot","facebookexternal","facebookcatalog","http://yandex.com/bots","hubspot","ia_archiver","linkedinbot","mj12bot","msnbot","nessus","petalbot","pinterest","prerender","rogerbot","screaming frog","semrushbot","sitebulb","slurp","turnitin","twitterbot","vercelbot","yahoo! slurp","yandexbot","gptbot","oai-searchbot","chatgpt-user","headlesschrome","cypress","Google-HotelAdsVerifier","adsbot-google","apis-google","duplexweb-google","feedfetcher-google","google favicon","google web preview","google-read-aloud","googlebot","googleweblight","mediapartners-google","storebot-google","Bytespider;"],Wd=function(e,t){if(!e)return!1;var n=e.toLowerCase();return Hd.concat(t||[]).some((e=>{var t=e.toLowerCase();return-1!==n.indexOf(t)}))},Jd=function(e,t){if(!e)return!1;var n=e.userAgent;if(n&&Wd(n,t))return!0;try{var r=null==e?void 0:e.userAgentData;if(null!=r&&r.brands&&r.brands.some((e=>Wd(null==e?void 0:e.brand,t))))return!0}catch(e){}return!!e.webdriver};class Yd{constructor(){this.clicks=[]}isRageClick(e,t,n){var r=this.clicks[this.clicks.length-1];if(r&&Math.abs(e-r.x)+Math.abs(t-r.y)<30&&n-r.timestamp<1e3){if(this.clicks.push({x:e,y:t,timestamp:n}),3===this.clicks.length)return!0}else this.clicks=[{x:e,y:t,timestamp:n}];return!1}}var zd=go("[Dead Clicks]"),Xd=()=>!0,Qd=e=>{var t,n=!(null===(t=e.instance.persistence)||void 0===t||!t.get_property(qo)),r=e.instance.config.capture_dead_clicks;return co(r)?r:n};class Zd{get lazyLoadedDeadClicksAutocapture(){return this._lazyLoadedDeadClicksAutocapture}constructor(e,t,n){this.instance=e,this.isEnabled=t,this.onCapture=n,this.startIfEnabled()}onRemoteConfig(e){this.instance.persistence&&this.instance.persistence.register({[qo]:null==e?void 0:e.captureDeadClicks}),this.startIfEnabled()}startIfEnabled(){this.isEnabled(this)&&this.loadScript((()=>{this.start()}))}loadScript(e){var t,n,r;null!==(t=qs.__PosthogExtensions__)&&void 0!==t&&t.initDeadClicksAutocapture&&e(),null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.loadExternalDependency)||void 0===r||r.call(n,this.instance,"dead-clicks-autocapture",(t=>{t?zd.error("failed to load script",t):e()}))}start(){var e;if(Ms){if(!this._lazyLoadedDeadClicksAutocapture&&null!==(e=qs.__PosthogExtensions__)&&void 0!==e&&e.initDeadClicksAutocapture){var t=eo(this.instance.config.capture_dead_clicks)?this.instance.config.capture_dead_clicks:{};t.__onCapture=this.onCapture,this._lazyLoadedDeadClicksAutocapture=qs.__PosthogExtensions__.initDeadClicksAutocapture(this.instance,t),this._lazyLoadedDeadClicksAutocapture.start(Ms),zd.info("starting...")}}else zd.error("`document` not found. Cannot start.")}stop(){this._lazyLoadedDeadClicksAutocapture&&(this._lazyLoadedDeadClicksAutocapture.stop(),this._lazyLoadedDeadClicksAutocapture=void 0,zd.info("stopping..."))}}var eh=go("[Heatmaps]");function th(e){return eo(e)&&"clientX"in e&&"clientY"in e&&ao(e.clientX)&&ao(e.clientY)}class nh{constructor(e){var t;_o(this,"rageclicks",new Yd),_o(this,"_enabledServerSide",!1),_o(this,"_initialized",!1),_o(this,"_flushInterval",null),this.instance=e,this._enabledServerSide=!(null===(t=this.instance.persistence)||void 0===t||!t.props[Uo])}get flushIntervalMilliseconds(){var e=5e3;return eo(this.instance.config.capture_heatmaps)&&this.instance.config.capture_heatmaps.flush_interval_milliseconds&&(e=this.instance.config.capture_heatmaps.flush_interval_milliseconds),e}get isEnabled(){return no(this.instance.config.capture_heatmaps)?no(this.instance.config.enable_heatmaps)?this._enabledServerSide:this.instance.config.enable_heatmaps:!1!==this.instance.config.capture_heatmaps}startIfEnabled(){if(this.isEnabled){if(this._initialized)return;eh.info("starting..."),this._setupListeners(),this._flushInterval=setInterval(this.flush.bind(this),this.flushIntervalMilliseconds)}else{var e,t;clearInterval(null!==(e=this._flushInterval)&&void 0!==e?e:void 0),null===(t=this.deadClicksCapture)||void 0===t||t.stop(),this.getAndClearBuffer()}}onRemoteConfig(e){var t=!!e.heatmaps;this.instance.persistence&&this.instance.persistence.register({[Uo]:t}),this._enabledServerSide=t,this.startIfEnabled()}getAndClearBuffer(){var e=this.buffer;return this.buffer=void 0,e}_onDeadClick(e){this._onClick(e.originalEvent,"deadclick")}_setupListeners(){Os&&Ms&&(No(Os,"beforeunload",this.flush.bind(this)),No(Ms,"click",(e=>this._onClick(e||(null==Os?void 0:Os.event))),{capture:!0}),No(Ms,"mousemove",(e=>this._onMouseMove(e||(null==Os?void 0:Os.event))),{capture:!0}),this.deadClicksCapture=new Zd(this.instance,Xd,this._onDeadClick.bind(this)),this.deadClicksCapture.startIfEnabled(),this._initialized=!0)}_getProperties(e,t){var n=this.instance.scrollManager.scrollY(),r=this.instance.scrollManager.scrollX(),i=this.instance.scrollManager.scrollElement(),s=function(e,t,n){for(var r=e;r&&el(r)&&!tl(r,"body");){if(r===n)return!1;if(Gs(t,null==Os?void 0:Os.getComputedStyle(r).position))return!0;r=dl(r)}return!1}(ll(e),["fixed","sticky"],i);return{x:e.clientX+(s?0:r),y:e.clientY+(s?0:n),target_fixed:s,type:t}}_onClick(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"click";if(!Zc(e.target)&&th(e)){var r=this._getProperties(e,n);null!==(t=this.rageclicks)&&void 0!==t&&t.isRageClick(e.clientX,e.clientY,(new Date).getTime())&&this._capture(yo(yo({},r),{},{type:"rageclick"})),this._capture(r)}}_onMouseMove(e){!Zc(e.target)&&th(e)&&(clearTimeout(this._mouseMoveTimeout),this._mouseMoveTimeout=setTimeout((()=>{this._capture(this._getProperties(e,"mousemove"))}),500))}_capture(e){if(Os){var t=Os.location.href;this.buffer=this.buffer||{},this.buffer[t]||(this.buffer[t]=[]),this.buffer[t].push(e)}}flush(){this.buffer&&!to(this.buffer)&&this.instance.capture("$$heatmap",{$heatmap_data:this.getAndClearBuffer()})}}class rh{constructor(e){_o(this,"_updateScrollData",(()=>{var e,t,n,r;this.context||(this.context={});var i=this.scrollElement(),s=this.scrollY(),o=i?Math.max(0,i.scrollHeight-i.clientHeight):0,a=s+((null==i?void 0:i.clientHeight)||0),c=(null==i?void 0:i.scrollHeight)||0;this.context.lastScrollY=Math.ceil(s),this.context.maxScrollY=Math.max(s,null!==(e=this.context.maxScrollY)&&void 0!==e?e:0),this.context.maxScrollHeight=Math.max(o,null!==(t=this.context.maxScrollHeight)&&void 0!==t?t:0),this.context.lastContentY=a,this.context.maxContentY=Math.max(a,null!==(n=this.context.maxContentY)&&void 0!==n?n:0),this.context.maxContentHeight=Math.max(c,null!==(r=this.context.maxContentHeight)&&void 0!==r?r:0)})),this.instance=e}getContext(){return this.context}resetContext(){var e=this.context;return setTimeout(this._updateScrollData,0),e}startMeasuringScrollPosition(){No(Os,"scroll",this._updateScrollData,{capture:!0}),No(Os,"scrollend",this._updateScrollData,{capture:!0}),No(Os,"resize",this._updateScrollData)}scrollElement(){if(!this.instance.config.scroll_root_selector)return null==Os?void 0:Os.document.documentElement;var e=Qs(this.instance.config.scroll_root_selector)?this.instance.config.scroll_root_selector:[this.instance.config.scroll_root_selector];for(var t of e){var n=null==Os?void 0:Os.document.querySelector(t);if(n)return n}}scrollY(){if(this.instance.config.scroll_root_selector){var e=this.scrollElement();return e&&e.scrollTop||0}return Os&&(Os.scrollY||Os.pageYOffset||Os.document.documentElement.scrollTop)||0}scrollX(){if(this.instance.config.scroll_root_selector){var e=this.scrollElement();return e&&e.scrollLeft||0}return Os&&(Os.scrollX||Os.pageXOffset||Os.document.documentElement.scrollLeft)||0}}var ih=go("[AutoCapture]");function sh(e,t){return t.length>e?t.slice(0,e)+"...":t}function oh(e){if(e.previousElementSibling)return e.previousElementSibling;var t=e;do{t=t.previousSibling}while(t&&!el(t));return t}class ah{constructor(e){_o(this,"_initialized",!1),_o(this,"_isDisabledServerSide",null),_o(this,"rageclicks",new Yd),_o(this,"_elementsChainAsString",!1),this.instance=e,this._elementSelectors=null}get config(){var e,t,n=eo(this.instance.config.autocapture)?this.instance.config.autocapture:{};return n.url_allowlist=null===(e=n.url_allowlist)||void 0===e?void 0:e.map((e=>new RegExp(e))),n.url_ignorelist=null===(t=n.url_ignorelist)||void 0===t?void 0:t.map((e=>new RegExp(e))),n}_addDomEventHandlers(){if(this.isBrowserSupported()){if(Os&&Ms){var e=e=>{e=e||(null==Os?void 0:Os.event);try{this._captureEvent(e)}catch(e){ih.error("Failed to capture event",e)}};if(No(Ms,"submit",e,{capture:!0}),No(Ms,"change",e,{capture:!0}),No(Ms,"click",e,{capture:!0}),this.config.capture_copied_text){var t=e=>{e=e||(null==Os?void 0:Os.event),this._captureEvent(e,$s)};No(Ms,"copy",t,{capture:!0}),No(Ms,"cut",t,{capture:!0})}}}else ih.info("Disabling Automatic Event Collection because this browser is not supported")}startIfEnabled(){this.isEnabled&&!this._initialized&&(this._addDomEventHandlers(),this._initialized=!0)}onRemoteConfig(e){e.elementsChainAsString&&(this._elementsChainAsString=e.elementsChainAsString),this.instance.persistence&&this.instance.persistence.register({[Bo]:!!e.autocapture_opt_out}),this._isDisabledServerSide=!!e.autocapture_opt_out,this.startIfEnabled()}setElementSelectors(e){this._elementSelectors=e}getElementSelectors(e){var t,n=[];return null===(t=this._elementSelectors)||void 0===t||t.forEach((t=>{var r=null==Ms?void 0:Ms.querySelectorAll(t);null==r||r.forEach((r=>{e===r&&n.push(t)}))})),n}get isEnabled(){var e,t,n=null===(e=this.instance.persistence)||void 0===e?void 0:e.props[Bo],r=this._isDisabledServerSide;if(so(r)&&!co(n)&&!this.instance.config.advanced_disable_decide)return!1;var i=null!==(t=this._isDisabledServerSide)&&void 0!==t?t:!!n;return!!this.instance.config.autocapture&&!i}_captureEvent(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"$autocapture";if(this.isEnabled){var n,r=ll(e);nl(r)&&(r=r.parentNode||null),"$autocapture"===t&&"click"===e.type&&e instanceof MouseEvent&&this.instance.config.rageclick&&null!==(n=this.rageclicks)&&void 0!==n&&n.isRageClick(e.clientX,e.clientY,(new Date).getTime())&&this._captureEvent(e,"$rageclick");var i=t===$s;if(r&&function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;if(!Os||!e||tl(e,"html")||!el(e))return!1;if(null!=n&&n.url_allowlist&&!sl(n.url_allowlist))return!1;if(null!=n&&n.url_ignorelist&&sl(n.url_ignorelist))return!1;if(null!=n&&n.dom_event_allowlist){var s=n.dom_event_allowlist;if(s&&!s.some((e=>t.type===e)))return!1}for(var o=!1,a=[e],c=!0,l=e;l.parentNode&&!tl(l,"body");)if(rl(l.parentNode))a.push(l.parentNode.host),l=l.parentNode.host;else{if(!(c=dl(l)))break;if(r||ul.indexOf(c.tagName.toLowerCase())>-1)o=!0;else{var u=Os.getComputedStyle(c);u&&"pointer"===u.getPropertyValue("cursor")&&(o=!0)}a.push(c),l=c}if(!function(e,t){var n=null==t?void 0:t.element_allowlist;if(no(n))return!0;var r=function(e){if(n.some((t=>e.tagName.toLowerCase()===t)))return{v:!0}};for(var i of e){var s=r(i);if("object"==typeof s)return s.v}return!1}(a,n))return!1;if(!function(e,t){var n=null==t?void 0:t.css_selector_allowlist;if(no(n))return!0;var r=function(e){if(n.some((t=>e.matches(t))))return{v:!0}};for(var i of e){var s=r(i);if("object"==typeof s)return s.v}return!1}(a,n))return!1;var d=Os.getComputedStyle(e);if(d&&"pointer"===d.getPropertyValue("cursor")&&"click"===t.type)return!0;var h=e.tagName.toLowerCase();switch(h){case"html":return!1;case"form":return(i||["submit"]).indexOf(t.type)>=0;case"input":case"select":case"textarea":return(i||["change","click"]).indexOf(t.type)>=0;default:return o?(i||["click"]).indexOf(t.type)>=0:(i||["click"]).indexOf(t.type)>=0&&(ul.indexOf(h)>-1||"true"===e.getAttribute("contenteditable"))}}(r,e,this.config,i,i?["copy","cut"]:void 0)){var{props:s,explicitNoCapture:o}=function(e,t){for(var n,r,{e:i,maskAllElementAttributes:s,maskAllText:o,elementAttributeIgnoreList:a,elementsChainAsString:c}=t,l=[e],u=e;u.parentNode&&!tl(u,"body");)rl(u.parentNode)?(l.push(u.parentNode.host),u=u.parentNode.host):(l.push(u.parentNode),u=u.parentNode);var d,h=[],p={},g=!1,f=!1;if(So(l,(e=>{var t=hl(e);"a"===e.tagName.toLowerCase()&&(g=e.getAttribute("href"),g=t&&g&&bl(g)&&g),Gs(ol(e),"ph-no-capture")&&(f=!0),h.push(function(e,t,n,r){var i=e.tagName.toLowerCase(),s={tag_name:i};ul.indexOf(i)>-1&&!n&&("a"===i.toLowerCase()||"button"===i.toLowerCase()?s.$el_text=sh(1024,El(e)):s.$el_text=sh(1024,cl(e)));var o=ol(e);o.length>0&&(s.classes=o.filter((function(e){return""!==e}))),So(e.attributes,(function(n){var i;if((!pl(e)||-1!==["name","id","class","aria-label"].indexOf(n.name))&&(null==r||!r.includes(n.name))&&!t&&bl(n.value)&&(i=n.name,!ro(i)||"_ngcontent"!==i.substring(0,10)&&"_nghost"!==i.substring(0,7))){var o=n.value;"class"===n.name&&(o=il(o).join(" ")),s["attr__"+n.name]=sh(1024,o)}}));for(var a=1,c=1,l=e;l=oh(l);)a++,l.tagName===e.tagName&&c++;return s.nth_child=a,s.nth_of_type=c,s}(e,s,o,a));var n=function(e){if(!hl(e))return{};var t={};return So(e.attributes,(function(e){if(e.name&&0===e.name.indexOf("data-ph-capture-attribute")){var n=e.name.replace("data-ph-capture-attribute-",""),r=e.value;n&&r&&bl(r)&&(t[n]=r)}})),t}(e);wo(p,n)})),f)return{props:{},explicitNoCapture:f};if(o||("a"===e.tagName.toLowerCase()||"button"===e.tagName.toLowerCase()?h[0].$el_text=El(e):h[0].$el_text=cl(e)),g){var m,v;h[0].attr__href=g;var y=null===(m=Va(g))||void 0===m?void 0:m.host,_=null==Os||null===(v=Os.location)||void 0===v?void 0:v.host;y&&_&&y!==_&&(d=g)}return{props:wo({$event_type:i.type,$ce_version:1},c?{}:{$elements:h},{$elements_chain:Sl(h)},null!==(n=h[0])&&void 0!==n&&n.$el_text?{$el_text:null===(r=h[0])||void 0===r?void 0:r.$el_text}:{},d&&"click"===i.type?{$external_click_url:d}:{},p)}}(r,{e,maskAllElementAttributes:this.instance.config.mask_all_element_attributes,maskAllText:this.instance.config.mask_all_text,elementAttributeIgnoreList:this.config.element_attribute_ignorelist,elementsChainAsString:this._elementsChainAsString});if(o)return!1;var a=this.getElementSelectors(r);if(a&&a.length>0&&(s.$element_selectors=a),t===$s){var c,l=al(null==Os||null===(c=Os.getSelection())||void 0===c?void 0:c.toString()),u=e.type||"clipboard";if(!l)return!1;s.$selected_content=l,s.$copy_type=u}return this.instance.capture(t,s),!0}}}isBrowserSupported(){return Zs(null==Ms?void 0:Ms.querySelectorAll)}}var ch,lh=go("[TracingHeaders]");class uh{constructor(e){_o(this,"_restoreXHRPatch",void 0),_o(this,"_restoreFetchPatch",void 0),_o(this,"_startCapturing",(()=>{var e,t,n,r;no(this._restoreXHRPatch)&&(null===(e=qs.__PosthogExtensions__)||void 0===e||null===(t=e.tracingHeadersPatchFns)||void 0===t||t._patchXHR(this.instance.sessionManager)),no(this._restoreFetchPatch)&&(null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.tracingHeadersPatchFns)||void 0===r||r._patchFetch(this.instance.sessionManager))})),this.instance=e}_loadScript(e){var t,n,r;null!==(t=qs.__PosthogExtensions__)&&void 0!==t&&t.tracingHeadersPatchFns&&e(),null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.loadExternalDependency)||void 0===r||r.call(n,this.instance,"tracing-headers",(t=>{if(t)return lh.error("failed to load script",t);e()}))}startIfEnabledOrStop(){var e,t;this.instance.config.__add_tracing_headers?this._loadScript(this._startCapturing):(null===(e=this._restoreXHRPatch)||void 0===e||e.call(this),null===(t=this._restoreFetchPatch)||void 0===t||t.call(this),this._restoreXHRPatch=void 0,this._restoreFetchPatch=void 0)}}!function(e){e[e.PENDING=-1]="PENDING",e[e.DENIED=0]="DENIED",e[e.GRANTED=1]="GRANTED"}(ch||(ch={}));class dh{constructor(e){this.instance=e}get config(){return this.instance.config}get consent(){return this.getDnt()?ch.DENIED:this.storedConsent}isOptedOut(){return this.consent===ch.DENIED||this.consent===ch.PENDING&&this.config.opt_out_capturing_by_default}isOptedIn(){return!this.isOptedOut()}optInOut(e){this.storage.set(this.storageKey,e?1:0,this.config.cookie_expiration,this.config.cross_subdomain_cookie,this.config.secure_cookie)}reset(){this.storage.remove(this.storageKey,this.config.cross_subdomain_cookie)}get storageKey(){var{token:e,opt_out_capturing_cookie_prefix:t}=this.instance.config;return(t||"__ph_opt_in_out_")+e}get storedConsent(){var e=this.storage.get(this.storageKey);return"1"===e?ch.GRANTED:"0"===e?ch.DENIED:ch.PENDING}get storage(){if(!this._storage){var e=this.config.opt_out_capturing_persistence_type;this._storage="localStorage"===e?La:xa;var t="localStorage"===e?xa:La;t.get(this.storageKey)&&(this._storage.get(this.storageKey)||this.optInOut("1"===t.get(this.storageKey)),t.remove(this.storageKey,this.config.cross_subdomain_cookie))}return this._storage}getDnt(){return!!this.config.respect_dnt&&!!Do([null==xs?void 0:xs.doNotTrack,null==xs?void 0:xs.msDoNotTrack,qs.doNotTrack],(e=>Gs([!0,1,"1","yes"],e)))}}var hh=go("[ExceptionAutocapture]");class ph{constructor(e){var t;_o(this,"startCapturing",(()=>{var e,t,n,r;if(Os&&this.isEnabled&&!this.hasHandlers){var i=null===(e=qs.__PosthogExtensions__)||void 0===e||null===(t=e.errorWrappingFunctions)||void 0===t?void 0:t.wrapOnError,s=null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.errorWrappingFunctions)||void 0===r?void 0:r.wrapUnhandledRejection;if(i&&s)try{this.unwrapOnError=i(this.captureException.bind(this)),this.unwrapUnhandledRejection=s(this.captureException.bind(this))}catch(e){hh.error("failed to start",e),this.stopCapturing()}else hh.error("failed to load error wrapping functions - cannot start")}})),this.instance=e,this.remoteEnabled=!(null===(t=this.instance.persistence)||void 0===t||!t.props[Fo]),this.startIfEnabled()}get isEnabled(){var e;return co(this.instance.config.capture_exceptions)?this.instance.config.capture_exceptions:null!==(e=this.remoteEnabled)&&void 0!==e&&e}get hasHandlers(){return!no(this.unwrapOnError)}startIfEnabled(){this.isEnabled&&!this.hasHandlers&&(hh.info("enabled, starting..."),this.loadScript(this.startCapturing))}loadScript(e){var t,n;this.hasHandlers&&e(),null===(t=qs.__PosthogExtensions__)||void 0===t||null===(n=t.loadExternalDependency)||void 0===n||n.call(t,this.instance,"exception-autocapture",(t=>{if(t)return hh.error("failed to load script",t);e()}))}stopCapturing(){var e,t;null===(e=this.unwrapOnError)||void 0===e||e.call(this),this.unwrapOnError=void 0,null===(t=this.unwrapUnhandledRejection)||void 0===t||t.call(this),this.unwrapUnhandledRejection=void 0}onRemoteConfig(e){var t=e.autocaptureExceptions;this.remoteEnabled=!!t||!1,this.instance.persistence&&this.instance.persistence.register({[Fo]:this.remoteEnabled}),this.startIfEnabled()}captureException(e){var t=this.instance.requestRouter.endpointFor("ui");e.$exception_personURL="".concat(t,"/project/").concat(this.instance.config.token,"/person/").concat(this.instance.get_distinct_id()),this.instance.exceptions.sendExceptionEvent(e)}}var gh=go("[Web Vitals]"),fh=9e5;class mh{constructor(e){var t;_o(this,"_enabledServerSide",!1),_o(this,"_initialized",!1),_o(this,"buffer",{url:void 0,metrics:[],firstMetricTimestamp:void 0}),_o(this,"_flushToCapture",(()=>{clearTimeout(this._delayedFlushTimer),0!==this.buffer.metrics.length&&(this.instance.capture("$web_vitals",this.buffer.metrics.reduce(((e,t)=>yo(yo({},e),{},{["$web_vitals_".concat(t.name,"_event")]:yo({},t),["$web_vitals_".concat(t.name,"_value")]:t.value})),{})),this.buffer={url:void 0,metrics:[],firstMetricTimestamp:void 0})})),_o(this,"_addToBuffer",(e=>{var t,n=null===(t=this.instance.sessionManager)||void 0===t?void 0:t.checkAndGetSessionAndWindowId(!0);if(no(n))gh.error("Could not read session ID. Dropping metrics!");else{this.buffer=this.buffer||{url:void 0,metrics:[],firstMetricTimestamp:void 0};var r=this._currentURL();no(r)||(oo(null==e?void 0:e.name)||oo(null==e?void 0:e.value)?gh.error("Invalid metric received",e):this._maxAllowedValue&&e.value>=this._maxAllowedValue?gh.error("Ignoring metric with value >= "+this._maxAllowedValue,e):(this.buffer.url!==r&&(this._flushToCapture(),this._delayedFlushTimer=setTimeout(this._flushToCapture,this.flushToCaptureTimeoutMs)),no(this.buffer.url)&&(this.buffer.url=r),this.buffer.firstMetricTimestamp=no(this.buffer.firstMetricTimestamp)?Date.now():this.buffer.firstMetricTimestamp,e.attribution&&e.attribution.interactionTargetElement&&(e.attribution.interactionTargetElement=void 0),this.buffer.metrics.push(yo(yo({},e),{},{$current_url:r,$session_id:n.sessionId,$window_id:n.windowId,timestamp:Date.now()})),this.buffer.metrics.length===this.allowedMetrics.length&&this._flushToCapture()))}})),_o(this,"_startCapturing",(()=>{var e,t,n,r,i=qs.__PosthogExtensions__;no(i)||no(i.postHogWebVitalsCallbacks)||({onLCP:e,onCLS:t,onFCP:n,onINP:r}=i.postHogWebVitalsCallbacks),e&&t&&n&&r?(this.allowedMetrics.indexOf("LCP")>-1&&e(this._addToBuffer.bind(this)),this.allowedMetrics.indexOf("CLS")>-1&&t(this._addToBuffer.bind(this)),this.allowedMetrics.indexOf("FCP")>-1&&n(this._addToBuffer.bind(this)),this.allowedMetrics.indexOf("INP")>-1&&r(this._addToBuffer.bind(this)),this._initialized=!0):gh.error("web vitals callbacks not loaded - not starting")})),this.instance=e,this._enabledServerSide=!(null===(t=this.instance.persistence)||void 0===t||!t.props[jo]),this.startIfEnabled()}get allowedMetrics(){var e,t,n=eo(this.instance.config.capture_performance)?null===(e=this.instance.config.capture_performance)||void 0===e?void 0:e.web_vitals_allowed_metrics:void 0;return no(n)?(null===(t=this.instance.persistence)||void 0===t?void 0:t.props[Ko])||["CLS","FCP","INP","LCP"]:n}get flushToCaptureTimeoutMs(){return(eo(this.instance.config.capture_performance)?this.instance.config.capture_performance.web_vitals_delayed_flush_ms:void 0)||5e3}get _maxAllowedValue(){var e=eo(this.instance.config.capture_performance)&&ao(this.instance.config.capture_performance.__web_vitals_max_value)?this.instance.config.capture_performance.__web_vitals_max_value:fh;return 0<e&&e<=6e4?fh:e}get isEnabled(){var e=eo(this.instance.config.capture_performance)?this.instance.config.capture_performance.web_vitals:void 0;return co(e)?e:this._enabledServerSide}startIfEnabled(){this.isEnabled&&!this._initialized&&(gh.info("enabled, starting..."),this.loadScript(this._startCapturing))}onRemoteConfig(e){var t=eo(e.capturePerformance)&&!!e.capturePerformance.web_vitals,n=eo(e.capturePerformance)?e.capturePerformance.web_vitals_allowed_metrics:void 0;this.instance.persistence&&(this.instance.persistence.register({[jo]:t}),this.instance.persistence.register({[Ko]:n})),this._enabledServerSide=t,this.startIfEnabled()}loadScript(e){var t,n,r;null!==(t=qs.__PosthogExtensions__)&&void 0!==t&&t.postHogWebVitalsCallbacks&&e(),null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.loadExternalDependency)||void 0===r||r.call(n,this.instance,"web-vitals",(t=>{t?gh.error("failed to load script",t):e()}))}_currentURL(){var e=Os?Os.location.href:void 0;return e||gh.error("Could not determine current URL"),e}}var vh={icontains:(e,t)=>!!Os&&t.href.toLowerCase().indexOf(e.toLowerCase())>-1,not_icontains:(e,t)=>!!Os&&-1===t.href.toLowerCase().indexOf(e.toLowerCase()),regex:(e,t)=>!!Os&&Nd(t.href,e),not_regex:(e,t)=>!!Os&&!Nd(t.href,e),exact:(e,t)=>t.href===e,is_not:(e,t)=>t.href!==e};class yh{constructor(e){var t=this;_o(this,"getWebExperimentsAndEvaluateDisplayLogic",(function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t.getWebExperiments((e=>{yh.logInfo("retrieved web experiments from the server"),t._flagToExperiments=new Map,e.forEach((e=>{if(e.feature_flag_key){var n;t._flagToExperiments&&(yh.logInfo("setting flag key ",e.feature_flag_key," to web experiment ",e),null===(n=t._flagToExperiments)||void 0===n||n.set(e.feature_flag_key,e));var r=t.instance.getFeatureFlag(e.feature_flag_key);ro(r)&&e.variants[r]&&t.applyTransforms(e.name,r,e.variants[r].transforms)}else if(e.variants)for(var i in e.variants){var s=e.variants[i];yh.matchesTestVariant(s)&&t.applyTransforms(e.name,i,s.transforms)}}))}),e)})),this.instance=e,this.instance.onFeatureFlags((e=>{this.onFeatureFlags(e)}))}onFeatureFlags(e){if(this._is_bot())yh.logInfo("Refusing to render web experiment since the viewer is a likely bot");else if(!this.instance.config.disable_web_experiments){if(oo(this._flagToExperiments))return this._flagToExperiments=new Map,this.loadIfEnabled(),void this.previewWebExperiment();yh.logInfo("applying feature flags",e),e.forEach((e=>{var t;if(this._flagToExperiments&&null!==(t=this._flagToExperiments)&&void 0!==t&&t.has(e)){var n,r=this.instance.getFeatureFlag(e),i=null===(n=this._flagToExperiments)||void 0===n?void 0:n.get(e);r&&null!=i&&i.variants[r]&&this.applyTransforms(i.name,r,i.variants[r].transforms)}}))}}previewWebExperiment(){var e=yh.getWindowLocation();if(null!=e&&e.search){var t=Ga(null==e?void 0:e.search,"__experiment_id"),n=Ga(null==e?void 0:e.search,"__experiment_variant");t&&n&&(yh.logInfo("previewing web experiments ".concat(t," && ").concat(n)),this.getWebExperiments((e=>{this.showPreviewWebExperiment(parseInt(t),n,e)}),!1,!0))}}loadIfEnabled(){this.instance.config.disable_web_experiments||this.getWebExperimentsAndEvaluateDisplayLogic()}getWebExperiments(e,t,n){if(this.instance.config.disable_web_experiments&&!n)return e([]);var r=this.instance.get_property("$web_experiments");if(r&&!t)return e(r);this.instance._send_request({url:this.instance.requestRouter.endpointFor("api","/api/web_experiments/?token=".concat(this.instance.config.token)),method:"GET",callback:t=>{if(200!==t.statusCode||!t.json)return e([]);var n=t.json.experiments||[];return e(n)}})}showPreviewWebExperiment(e,t,n){var r=n.filter((t=>t.id===e));r&&r.length>0&&(yh.logInfo("Previewing web experiment [".concat(r[0].name,"] with variant [").concat(t,"]")),this.applyTransforms(r[0].name,t,r[0].variants[t].transforms))}static matchesTestVariant(e){return!oo(e.conditions)&&yh.matchUrlConditions(e)&&yh.matchUTMConditions(e)}static matchUrlConditions(e){var t;if(oo(e.conditions)||oo(null===(t=e.conditions)||void 0===t?void 0:t.url))return!0;var n,r,i,s=yh.getWindowLocation();return!!s&&(null===(n=e.conditions)||void 0===n||!n.url||vh[null!==(r=null===(i=e.conditions)||void 0===i?void 0:i.urlMatchType)&&void 0!==r?r:"icontains"](e.conditions.url,s))}static getWindowLocation(){return null==Os?void 0:Os.location}static matchUTMConditions(e){var t;if(oo(e.conditions)||oo(null===(t=e.conditions)||void 0===t?void 0:t.utm))return!0;var n=Hc.campaignParams();if(n.utm_source){var r,i,s,o,a,c,l,u,d,h,p,g,f,m,v,y,_=null===(r=e.conditions)||void 0===r||null===(i=r.utm)||void 0===i||!i.utm_campaign||(null===(s=e.conditions)||void 0===s||null===(o=s.utm)||void 0===o?void 0:o.utm_campaign)==n.utm_campaign,b=null===(a=e.conditions)||void 0===a||null===(c=a.utm)||void 0===c||!c.utm_source||(null===(l=e.conditions)||void 0===l||null===(u=l.utm)||void 0===u?void 0:u.utm_source)==n.utm_source,E=null===(d=e.conditions)||void 0===d||null===(h=d.utm)||void 0===h||!h.utm_medium||(null===(p=e.conditions)||void 0===p||null===(g=p.utm)||void 0===g?void 0:g.utm_medium)==n.utm_medium,A=null===(f=e.conditions)||void 0===f||null===(m=f.utm)||void 0===m||!m.utm_term||(null===(v=e.conditions)||void 0===v||null===(y=v.utm)||void 0===y?void 0:y.utm_term)==n.utm_term;return _&&E&&A&&b}return!1}static logInfo(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];po.info("[WebExperiments] ".concat(e),n)}applyTransforms(e,t,n){this._is_bot()?yh.logInfo("Refusing to render web experiment since the viewer is a likely bot"):"control"!==t?n.forEach((n=>{if(n.selector){var r;yh.logInfo("applying transform of variant ".concat(t," for experiment ").concat(e," "),n);var i=null===(r=document)||void 0===r?void 0:r.querySelectorAll(n.selector);null==i||i.forEach((e=>{var t=e;n.html&&(t.innerHTML=n.html),n.css&&t.setAttribute("style",n.css)}))}})):yh.logInfo("Control variants leave the page unmodified.")}_is_bot(){return xs&&this.instance?Jd(xs,this.instance.config.custom_blocked_useragents):void 0}}class _h{constructor(e){this.instance=e}sendExceptionEvent(e){this.instance.capture("$exception",e,{_noTruncate:!0,_batchKey:"exceptionEvent"})}}var bh=["$set_once","$set"],Eh=go("[SiteApps]");class Ah{constructor(e){this.instance=e,this.bufferedInvocations=[],this.apps={}}get isEnabled(){return!!this.instance.config.opt_in_site_apps}eventCollector(e,t){if(t){var n=this.globalsForEvent(t);this.bufferedInvocations.push(n),this.bufferedInvocations.length>1e3&&(this.bufferedInvocations=this.bufferedInvocations.slice(10))}}get siteAppLoaders(){var e,t;return null===(e=qs._POSTHOG_REMOTE_CONFIG)||void 0===e||null===(t=e[this.instance.config.token])||void 0===t?void 0:t.siteApps}init(){if(this.isEnabled){var e=this.instance._addCaptureHook(this.eventCollector.bind(this));this.stopBuffering=()=>{e(),this.bufferedInvocations=[],this.stopBuffering=void 0}}}globalsForEvent(e){var t,n,r,i,s,o,a;if(!e)throw new Error("Event payload is required");var c={},l=this.instance.get_property("$groups")||[],u=this.instance.get_property("$stored_group_properties")||{};for(var[d,h]of Object.entries(u))c[d]={id:l[d],type:d,properties:h};var{$set_once:p,$set:g}=e;return{event:yo(yo({},bo(e,bh)),{},{properties:yo(yo(yo({},e.properties),g?{$set:yo(yo({},null!==(t=null===(n=e.properties)||void 0===n?void 0:n.$set)&&void 0!==t?t:{}),g)}:{}),p?{$set_once:yo(yo({},null!==(r=null===(i=e.properties)||void 0===i?void 0:i.$set_once)&&void 0!==r?r:{}),p)}:{}),elements_chain:null!==(s=null===(o=e.properties)||void 0===o?void 0:o.$elements_chain)&&void 0!==s?s:"",distinct_id:null===(a=e.properties)||void 0===a?void 0:a.distinct_id}),person:{properties:this.instance.get_property("$stored_person_properties")},groups:c}}setupSiteApp(e){var t={id:e.id,loaded:!1,errored:!1};this.apps[e.id]=t;var n=n=>{var r;for(var i of(this.apps[e.id].errored=!n,this.apps[e.id].loaded=!0,Eh.info("Site app with id ".concat(e.id," ").concat(n?"loaded":"errored")),n&&this.bufferedInvocations.length&&(Eh.info("Processing ".concat(this.bufferedInvocations.length," events for site app with id ").concat(e.id)),this.bufferedInvocations.forEach((e=>{var n;return null===(n=t.processEvent)||void 0===n?void 0:n.call(t,e)}))),Object.values(this.apps)))if(!i.loaded)return;null===(r=this.stopBuffering)||void 0===r||r.call(this)};try{var{processEvent:r}=e.init({posthog:this.instance,callback:e=>{n(e)}});r&&(t.processEvent=r)}catch(t){Eh.error("Error while initializing PostHog app with config id ".concat(e.id),t),n(!1)}}onCapturedEvent(e){if(0!==Object.keys(this.apps).length){var t=this.globalsForEvent(e);for(var n of Object.values(this.apps))try{var r;null===(r=n.processEvent)||void 0===r||r.call(n,t)}catch(t){Eh.error("Error while processing event ".concat(e.event," for site app ").concat(n.id),t)}}}onRemoteConfig(e){var t,n,r,i=this;if(null!==(t=this.siteAppLoaders)&&void 0!==t&&t.length){if(!this.isEnabled)return void Eh.error('PostHog site apps are disabled. Enable the "opt_in_site_apps" config to proceed.');for(var s of this.siteAppLoaders)this.setupSiteApp(s);this.instance.on("eventCaptured",(e=>this.onCapturedEvent(e)))}else if(null===(n=this.stopBuffering)||void 0===n||n.call(this),null!==(r=e.siteApps)&&void 0!==r&&r.length)if(this.isEnabled){var o=function(e,t){var n,r;qs["__$$ph_site_app_".concat(e)]=i.instance,null===(n=qs.__PosthogExtensions__)||void 0===n||null===(r=n.loadSiteApp)||void 0===r||r.call(n,i.instance,t,(t=>{if(t)return Eh.error("Error while initializing PostHog app with config id ".concat(e),t)}))};for(var{id:a,url:c}of e.siteApps)o(a,c)}else Eh.error('PostHog site apps are disabled. Enable the "opt_in_site_apps" config to proceed.')}}function Sh(e,t,n){return Lu({distinct_id:e,userPropertiesToSet:t,userPropertiesToSetOnce:n})}var wh={},Ih=()=>{},Th="posthog",kh=!Nu&&-1===(null==js?void 0:js.indexOf("MSIE"))&&-1===(null==js?void 0:js.indexOf("Mozilla")),Rh=()=>{var e;return{api_host:"https://us.i.posthog.com",ui_host:null,token:"",autocapture:!0,rageclick:!0,cross_subdomain_cookie:Po(null==Ms?void 0:Ms.location),persistence:"localStorage+cookie",persistence_name:"",loaded:Ih,save_campaign_params:!0,custom_campaign_params:[],custom_blocked_useragents:[],save_referrer:!0,capture_pageview:!0,capture_pageleave:"if_capture_pageview",debug:Ls&&ro(null==Ls?void 0:Ls.search)&&-1!==Ls.search.indexOf("__posthog_debug=true")||!1,cookie_expiration:365,upgrade:!1,disable_session_recording:!1,disable_persistence:!1,disable_web_experiments:!0,disable_surveys:!1,disable_external_dependency_loading:!1,enable_recording_console_log:void 0,secure_cookie:"https:"===(null==Os||null===(e=Os.location)||void 0===e?void 0:e.protocol),ip:!0,opt_out_capturing_by_default:!1,opt_out_persistence_by_default:!1,opt_out_useragent_filter:!1,opt_out_capturing_persistence_type:"localStorage",opt_out_capturing_cookie_prefix:null,opt_in_site_apps:!1,property_denylist:[],respect_dnt:!1,sanitize_properties:null,request_headers:{},request_batching:!0,properties_string_max_length:65535,session_recording:{},mask_all_element_attributes:!1,mask_all_text:!1,mask_personal_data_properties:!1,custom_personal_data_properties:[],advanced_disable_decide:!1,advanced_disable_feature_flags:!1,advanced_disable_feature_flags_on_first_load:!1,advanced_disable_toolbar_metrics:!1,feature_flag_request_timeout_ms:3e3,on_request_error:e=>{var t="Bad HTTP status: "+e.statusCode+" "+e.text;po.error(t)},get_device_id:e=>e,capture_performance:void 0,name:"posthog",bootstrap:{},disable_compression:!1,session_idle_timeout_seconds:1800,person_profiles:"identified_only",before_send:void 0,request_queue_config:{flush_interval_ms:Pu},_onCapture:Ih}},Oh=e=>{var t={};no(e.process_person)||(t.person_profiles=e.process_person),no(e.xhr_headers)||(t.request_headers=e.xhr_headers),no(e.cookie_name)||(t.persistence_name=e.cookie_name),no(e.disable_cookie)||(t.disable_persistence=e.disable_cookie),no(e.store_google)||(t.save_campaign_params=e.store_google),no(e.verbose)||(t.debug=e.verbose);var n=wo({},t,e);return Qs(e.property_blacklist)&&(no(e.property_denylist)?n.property_denylist=e.property_blacklist:Qs(e.property_denylist)?n.property_denylist=[...e.property_blacklist,...e.property_denylist]:po.error("Invalid value for property_denylist config: "+e.property_denylist)),n};class Ch{constructor(){_o(this,"__forceAllowLocalhost",!1)}get _forceAllowLocalhost(){return this.__forceAllowLocalhost}set _forceAllowLocalhost(e){po.error("WebPerformanceObserver is deprecated and has no impact on network capture. Use `_forceAllowLocalhostNetworkCapture` on `posthog.sessionRecording`"),this.__forceAllowLocalhost=e}}class Ph{get decideEndpointWasHit(){var e,t;return null!==(e=null===(t=this.featureFlags)||void 0===t?void 0:t.hasLoadedFlags)&&void 0!==e&&e}constructor(){_o(this,"webPerformance",new Ch),_o(this,"_personProcessingSetOncePropertiesSent",!1),_o(this,"version",Ks.LIB_VERSION),_o(this,"_internalEventEmitter",new xd),this.config=Rh(),this.SentryIntegration=Ju,this.sentryIntegration=e=>function(e,t){var n=Wu(e,t);return{name:Hu,processEvent:e=>n(e)}}(this,e),this.__request_queue=[],this.__loaded=!1,this.analyticsDefaultEndpoint="/e/",this._initialPageviewCaptured=!1,this._initialPersonProfilesConfig=null,this._cachedIdentify=null,this.featureFlags=new Sa(this),this.toolbar=new Cu(this),this.scrollManager=new rh(this),this.pageViewManager=new zu(this),this.surveys=new qd(this),this.experiments=new yh(this),this.exceptions=new _h(this),this.rateLimiter=new $d(this),this.requestRouter=new Gu(this),this.consent=new dh(this),this.people={set:(e,t,n)=>{var r=ro(e)?{[e]:t}:e;this.setPersonProperties(r),null==n||n({})},set_once:(e,t,n)=>{var r=ro(e)?{[e]:t}:e;this.setPersonProperties(void 0,r),null==n||n({})}},this.on("eventCaptured",(e=>po.info('send "'.concat(null==e?void 0:e.event,'"'),e)))}init(e,t,n){if(n&&n!==Th){var r,i=null!==(r=wh[n])&&void 0!==r?r:new Ph;return i._init(e,t,n),wh[n]=i,wh[Th][n]=i,i}return this._init(e,t,n)}_init(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;if(no(e)||io(e))return po.critical("PostHog was initialized without a token. This likely indicates a misconfiguration. Please check the first argument passed to posthog.init()"),this;if(this.__loaded)return po.warn("You have already initialized PostHog! Re-initializing is a no-op"),this;this.__loaded=!0,this.config={},this._triggered_notifs=[],r.person_profiles&&(this._initialPersonProfilesConfig=r.person_profiles),this.set_config(wo({},Rh(),Oh(r),{name:i,token:e})),this.config.on_xhr_error&&po.error("on_xhr_error is deprecated. Use on_request_error instead"),this.compression=r.disable_compression?void 0:Rs.GZipJS,this.persistence=new Jc(this.config),this.sessionPersistence="sessionStorage"===this.config.persistence||"memory"===this.config.persistence?this.persistence:new Jc(yo(yo({},this.config),{},{persistence:"sessionStorage"}));var s=yo({},this.persistence.props),o=yo({},this.sessionPersistence.props);if(this._requestQueue=new Du((e=>this._send_retriable_request(e)),this.config.request_queue_config),this._retryQueue=new ju(this),this.__request_queue=[],this.config.__preview_experimental_cookieless_mode||(this.sessionManager=new $u(this),this.sessionPropsManager=new Gd(this,this.sessionManager,this.persistence)),new uh(this).startIfEnabledOrStop(),this.siteApps=new Ah(this),null===(t=this.siteApps)||void 0===t||t.init(),this.config.__preview_experimental_cookieless_mode||(this.sessionRecording=new Su(this),this.sessionRecording.startIfEnabledOrStop()),this.config.disable_scroll_properties||this.scrollManager.startMeasuringScrollPosition(),this.autocapture=new ah(this),this.autocapture.startIfEnabled(),this.surveys.loadIfEnabled(),this.heatmaps=new nh(this),this.heatmaps.startIfEnabled(),this.webVitalsAutocapture=new mh(this),this.exceptionObserver=new ph(this),this.exceptionObserver.startIfEnabled(),this.deadClicksAutocapture=new Zd(this,Qd),this.deadClicksAutocapture.startIfEnabled(),Ks.DEBUG=Ks.DEBUG||this.config.debug,Ks.DEBUG&&po.info("Starting in debug mode",{this:this,config:r,thisC:yo({},this.config),p:s,s:o}),this._sync_opt_out_with_persistence(),void 0!==(null===(n=r.bootstrap)||void 0===n?void 0:n.distinctID)){var a,c,l=this.config.get_device_id(Ca()),u=null!==(a=r.bootstrap)&&void 0!==a&&a.isIdentifiedID?l:r.bootstrap.distinctID;this.persistence.set_property(aa,null!==(c=r.bootstrap)&&void 0!==c&&c.isIdentifiedID?"identified":"anonymous"),this.register({distinct_id:r.bootstrap.distinctID,$device_id:u})}if(this._hasBootstrappedFeatureFlags()){var d,h,p=Object.keys((null===(d=r.bootstrap)||void 0===d?void 0:d.featureFlags)||{}).filter((e=>{var t,n;return!(null===(t=r.bootstrap)||void 0===t||null===(n=t.featureFlags)||void 0===n||!n[e])})).reduce(((e,t)=>{var n,i;return e[t]=(null===(n=r.bootstrap)||void 0===n||null===(i=n.featureFlags)||void 0===i?void 0:i[t])||!1,e}),{}),g=Object.keys((null===(h=r.bootstrap)||void 0===h?void 0:h.featureFlagPayloads)||{}).filter((e=>p[e])).reduce(((e,t)=>{var n,i,s,o;return null!==(n=r.bootstrap)&&void 0!==n&&null!==(i=n.featureFlagPayloads)&&void 0!==i&&i[t]&&(e[t]=null===(s=r.bootstrap)||void 0===s||null===(o=s.featureFlagPayloads)||void 0===o?void 0:o[t]),e}),{});this.featureFlags.receivedFeatureFlags({featureFlags:p,featureFlagPayloads:g})}if(this.config.__preview_experimental_cookieless_mode)this.register_once({distinct_id:fa,$device_id:null},"");else if(!this.get_distinct_id()){var f=this.config.get_device_id(Ca());this.register_once({distinct_id:f,$device_id:f},""),this.persistence.set_property(aa,"anonymous")}return No(Os,"onpagehide"in self?"pagehide":"unload",this._handle_unload.bind(this),{passive:!1}),this.toolbar.maybeLoadToolbar(),r.segment?function(e,t){var n=e.config.segment;if(!n)return t();!function(e,t){var n=e.config.segment;if(!n)return t();var r=n=>{var r=()=>n.anonymousId()||Ca();e.config.get_device_id=r,n.id()&&(e.register({distinct_id:n.id(),$device_id:r()}),e.persistence.set_property(aa,"identified")),t()},i=n.user();"then"in i&&Zs(i.then)?i.then((e=>r(e))):r(i)}(e,(()=>{n.register((e=>{Promise&&Promise.resolve||Yu.warn("This browser does not have Promise support, and can not use the segment integration");var t=(t,n)=>{var r;if(!n)return t;t.event.userId||t.event.anonymousId===e.get_distinct_id()||(Yu.info("No userId set, resetting PostHog"),e.reset()),t.event.userId&&t.event.userId!==e.get_distinct_id()&&(Yu.info("UserId set, identifying with PostHog"),e.identify(t.event.userId));var i=e._calculate_event_properties(n,null!==(r=t.event.properties)&&void 0!==r?r:{},new Date);return t.event.properties=Object.assign({},i,t.event.properties),t};return{name:"PostHog JS",type:"enrichment",version:"1.0.0",isLoaded:()=>!0,load:()=>Promise.resolve(),track:e=>t(e,e.event.event),page:e=>t(e,"$pageview"),identify:e=>t(e,"$identify"),screen:e=>t(e,"$screen")}})(e)).then((()=>{t()}))}))}(this,(()=>this._loaded())):this._loaded(),Zs(this.config._onCapture)&&this.config._onCapture!==Ih&&(po.warn("onCapture is deprecated. Please use `before_send` instead"),this.on("eventCaptured",(e=>this.config._onCapture(e.event,e)))),this}_onRemoteConfig(e){var t,n,r,i,s,o,a,c;if(!Ms||!Ms.body)return po.info("document not ready yet, trying again in 500 milliseconds..."),void setTimeout((()=>{this._onRemoteConfig(e)}),500);this.compression=void 0,e.supportedCompression&&!this.config.disable_compression&&(this.compression=Gs(e.supportedCompression,Rs.GZipJS)?Rs.GZipJS:Gs(e.supportedCompression,Rs.Base64)?Rs.Base64:void 0),null!==(t=e.analytics)&&void 0!==t&&t.endpoint&&(this.analyticsDefaultEndpoint=e.analytics.endpoint),this.set_config({person_profiles:this._initialPersonProfilesConfig?this._initialPersonProfilesConfig:"identified_only"}),null===(n=this.siteApps)||void 0===n||n.onRemoteConfig(e),null===(r=this.sessionRecording)||void 0===r||r.onRemoteConfig(e),null===(i=this.autocapture)||void 0===i||i.onRemoteConfig(e),null===(s=this.heatmaps)||void 0===s||s.onRemoteConfig(e),this.surveys.onRemoteConfig(e),null===(o=this.webVitalsAutocapture)||void 0===o||o.onRemoteConfig(e),null===(a=this.exceptionObserver)||void 0===a||a.onRemoteConfig(e),null===(c=this.deadClicksAutocapture)||void 0===c||c.onRemoteConfig(e)}_loaded(){try{this.config.loaded(this)}catch(e){po.critical("`loaded` function failed",e)}this._start_queue_if_opted_in(),this.config.capture_pageview&&setTimeout((()=>{this.consent.isOptedIn()&&this._captureInitialPageview()}),1),new Iu(this).load(),this.featureFlags.decide()}_start_queue_if_opted_in(){var e;this.has_opted_out_capturing()||this.config.request_batching&&(null===(e=this._requestQueue)||void 0===e||e.enable())}_dom_loaded(){this.has_opted_out_capturing()||Ao(this.__request_queue,(e=>this._send_retriable_request(e))),this.__request_queue=[],this._start_queue_if_opted_in()}_handle_unload(){var e,t;this.config.request_batching?(this._shouldCapturePageleave()&&this.capture("$pageleave"),null===(e=this._requestQueue)||void 0===e||e.unload(),null===(t=this._retryQueue)||void 0===t||t.unload()):this._shouldCapturePageleave()&&this.capture("$pageleave",null,{transport:"sendBeacon"})}_send_request(e){this.__loaded&&(kh?this.__request_queue.push(e):this.rateLimiter.isServerRateLimited(e.batchKey)||(e.transport=e.transport||this.config.api_transport,e.url=Mu(e.url,{ip:this.config.ip?1:0}),e.headers=yo({},this.config.request_headers),e.compression="best-available"===e.compression?this.compression:e.compression,e.fetchOptions=e.fetchOptions||this.config.fetch_options,(e=>{var t,n,r,i=yo({},e);i.timeout=i.timeout||6e4,i.url=Mu(i.url,{_:(new Date).getTime().toString(),ver:Ks.LIB_VERSION,compression:i.compression});var s=null!==(t=i.transport)&&void 0!==t?t:"fetch",o=null!==(n=null===(r=Do(Uu,(e=>e.transport===s)))||void 0===r?void 0:r.method)&&void 0!==n?n:Uu[0].method;if(!o)throw new Error("No available transport method");o(i)})(yo(yo({},e),{},{callback:t=>{var n,r,i;this.rateLimiter.checkForLimiting(t),t.statusCode>=400&&(null===(r=(i=this.config).on_request_error)||void 0===r||r.call(i,t)),null===(n=e.callback)||void 0===n||n.call(e,t)}}))))}_send_retriable_request(e){this._retryQueue?this._retryQueue.retriableRequest(e):this._send_request(e)}_execute_array(e){var t,n=[],r=[],i=[];Ao(e,(e=>{e&&(t=e[0],Qs(t)?i.push(e):Zs(e)?e.call(this):Qs(e)&&"alias"===t?n.push(e):Qs(e)&&-1!==t.indexOf("capture")&&Zs(this[t])?i.push(e):r.push(e))}));var s=function(e,t){Ao(e,(function(e){if(Qs(e[0])){var n=t;So(e,(function(e){n=n[e[0]].apply(n,e.slice(1))}))}else this[e[0]].apply(this,e.slice(1))}),t)};s(n,this),s(r,this),s(i,this)}_hasBootstrappedFeatureFlags(){var e,t;return(null===(e=this.config.bootstrap)||void 0===e?void 0:e.featureFlags)&&Object.keys(null===(t=this.config.bootstrap)||void 0===t?void 0:t.featureFlags).length>0||!1}push(e){this._execute_array([e])}capture(e,t,n){var r;if(this.__loaded&&this.persistence&&this.sessionPersistence&&this._requestQueue){if(!this.consent.isOptedOut())if(!no(e)&&ro(e)){if(this.config.opt_out_useragent_filter||!this._is_bot()){var i=null!=n&&n.skip_client_rate_limiting?void 0:this.rateLimiter.clientRateLimitContext();if(null==i||!i.isRateLimited){this.sessionPersistence.update_search_keyword(),this.config.save_campaign_params&&this.sessionPersistence.update_campaign_params(),this.config.save_referrer&&this.sessionPersistence.update_referrer_info(),(this.config.save_campaign_params||this.config.save_referrer)&&this.persistence.set_initial_person_info();var s=new Date,o=(null==n?void 0:n.timestamp)||s,a=Ca(),c={uuid:a,event:e,properties:this._calculate_event_properties(e,t||{},o,a)};i&&(c.properties.$lib_rate_limit_remaining_tokens=i.remainingTokens),(null==n?void 0:n.$set)&&(c.$set=null==n?void 0:n.$set);var l=this._calculate_set_once_properties(null==n?void 0:n.$set_once);l&&(c.$set_once=l),(c=function(e,t){return n=e,r=e=>ro(e)&&!so(t)?e.slice(0,t):e,i=new Set,function e(t,n){return t!==Object(t)?r?r(t):t:i.has(t)?void 0:(i.add(t),Qs(t)?(s=[],Ao(t,(t=>{s.push(e(t))}))):(s={},So(t,((t,n)=>{i.has(t)||(s[n]=e(t))}))),s);var s}(n);var n,r,i}(c,null!=n&&n._noTruncate?null:this.config.properties_string_max_length)).timestamp=o,no(null==n?void 0:n.timestamp)||(c.properties.$event_time_override_provided=!0,c.properties.$event_time_override_system_time=s);var u=yo(yo({},c.properties.$set),c.$set);if(to(u)||this.setPersonPropertiesForFlags(u),!oo(this.config.before_send)){var d=this._runBeforeSend(c);if(!d)return;c=d}this._internalEventEmitter.emit("eventCaptured",c);var h={method:"POST",url:null!==(r=null==n?void 0:n._url)&&void 0!==r?r:this.requestRouter.endpointFor("api",this.analyticsDefaultEndpoint),data:c,compression:"best-available",batchKey:null==n?void 0:n._batchKey};return!this.config.request_batching||n&&(null==n||!n._batchKey)||null!=n&&n.send_instantly?this._send_retriable_request(h):this._requestQueue.enqueue(h),c}po.critical("This capture call is ignored due to client rate limiting.")}}else po.error("No event name provided to posthog.capture")}else po.uninitializedWarning("posthog.capture")}_addCaptureHook(e){return this.on("eventCaptured",(t=>e(t.event,t)))}_calculate_event_properties(e,t,n,r){if(n=n||new Date,!this.persistence||!this.sessionPersistence)return t;var i=this.persistence.remove_event_timer(e),s=yo({},t);if(s.token=this.config.token,this.config.__preview_experimental_cookieless_mode&&(s.$cookieless_mode=!0),"$snapshot"===e){var o=yo(yo({},this.persistence.properties()),this.sessionPersistence.properties());return s.distinct_id=o.distinct_id,(!ro(s.distinct_id)&&!ao(s.distinct_id)||io(s.distinct_id))&&po.error("Invalid distinct_id for replay event. This indicates a bug in your implementation"),s}var a,c=Hc.properties({maskPersonalDataProperties:this.config.mask_personal_data_properties,customPersonalDataProperties:this.config.custom_personal_data_properties});if(this.sessionManager){var{sessionId:l,windowId:u}=this.sessionManager.checkAndGetSessionAndWindowId();s.$session_id=l,s.$window_id=u}try{var d,h;this.sessionRecording&&(s.$recording_status=this.sessionRecording.status,s.$sdk_debug_replay_internal_buffer_length=this.sessionRecording.buffer.data.length,s.$sdk_debug_replay_internal_buffer_size=this.sessionRecording.buffer.size),s.$sdk_debug_retry_queue_size=null===(d=this._retryQueue)||void 0===d||null===(h=d.queue)||void 0===h?void 0:h.length}catch(e){s.$sdk_debug_error_capturing_properties=String(e)}if(this.requestRouter.region===qu.CUSTOM&&(s.$lib_custom_api_host=this.config.api_host),a="$pageview"===e?this.pageViewManager.doPageView(n,r):"$pageleave"===e?this.pageViewManager.doPageLeave(n):this.pageViewManager.doEvent(),s=wo(s,a),"$pageview"===e&&Ms&&(s.title=Ms.title),!no(i)){var p=n.getTime()-i;s.$duration=parseFloat((p/1e3).toFixed(3))}js&&this.config.opt_out_useragent_filter&&(s.$browser_type=this._is_bot()?"bot":"browser"),(s=wo({},c,this.persistence.properties(),this.sessionPersistence.properties(),s)).$is_identified=this._isIdentified(),Qs(this.config.property_denylist)?So(this.config.property_denylist,(function(e){delete s[e]})):po.error("Invalid value for property_denylist config: "+this.config.property_denylist+" or property_blacklist config: "+this.config.property_blacklist);var g=this.config.sanitize_properties;g&&(po.error("sanitize_properties is deprecated. Use before_send instead"),s=g(s,e));var f=this._hasPersonProcessing();return s.$process_person_profile=f,f&&this._requirePersonProcessing("_calculate_event_properties"),s}_calculate_set_once_properties(e){var t;if(!this.persistence||!this._hasPersonProcessing())return e;if(this._personProcessingSetOncePropertiesSent)return e;var n=this.persistence.get_initial_props(),r=null===(t=this.sessionPropsManager)||void 0===t?void 0:t.getSetOnceInitialSessionPropsProps(),i=wo({},n,r||{},e||{}),s=this.config.sanitize_properties;return s&&(po.error("sanitize_properties is deprecated. Use before_send instead"),i=s(i,"$set_once")),this._personProcessingSetOncePropertiesSent=!0,to(i)?void 0:i}register(e,t){var n;null===(n=this.persistence)||void 0===n||n.register(e,t)}register_once(e,t,n){var r;null===(r=this.persistence)||void 0===r||r.register_once(e,t,n)}register_for_session(e){var t;null===(t=this.sessionPersistence)||void 0===t||t.register(e)}unregister(e){var t;null===(t=this.persistence)||void 0===t||t.unregister(e)}unregister_for_session(e){var t;null===(t=this.sessionPersistence)||void 0===t||t.unregister(e)}_register_single(e,t){this.register({[e]:t})}getFeatureFlag(e,t){return this.featureFlags.getFeatureFlag(e,t)}getFeatureFlagPayload(e){var t=this.featureFlags.getFeatureFlagPayload(e);try{return JSON.parse(t)}catch(e){return t}}isFeatureEnabled(e,t){return this.featureFlags.isFeatureEnabled(e,t)}reloadFeatureFlags(){this.featureFlags.reloadFeatureFlags()}updateEarlyAccessFeatureEnrollment(e,t){this.featureFlags.updateEarlyAccessFeatureEnrollment(e,t)}getEarlyAccessFeatures(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.featureFlags.getEarlyAccessFeatures(e,t)}on(e,t){return this._internalEventEmitter.on(e,t)}onFeatureFlags(e){return this.featureFlags.onFeatureFlags(e)}onSessionId(e){var t,n;return null!==(t=null===(n=this.sessionManager)||void 0===n?void 0:n.onSessionId(e))&&void 0!==t?t:()=>{}}getSurveys(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.surveys.getSurveys(e,t)}getActiveMatchingSurveys(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.surveys.getActiveMatchingSurveys(e,t)}renderSurvey(e,t){this.surveys.renderSurvey(e,t)}canRenderSurvey(e){this.surveys.canRenderSurvey(e)}getNextSurveyStep(e,t,n){return this.surveys.getNextSurveyStep(e,t,n)}identify(e,t,n){if(!this.__loaded||!this.persistence)return po.uninitializedWarning("posthog.identify");if(ao(e)&&(e=e.toString(),po.warn("The first argument to posthog.identify was a number, but it should be a string. It has been converted to a string.")),e){if(["distinct_id","distinctid"].includes(e.toLowerCase()))po.critical('The string "'.concat(e,'" was set in posthog.identify which indicates an error. This ID should be unique to the user and not a hardcoded string.'));else if(this._requirePersonProcessing("posthog.identify")){var r=this.get_distinct_id();if(this.register({$user_id:e}),!this.get_property("$device_id")){var i=r;this.register_once({$had_persisted_distinct_id:!0,$device_id:i},"")}e!==r&&e!==this.get_property(Mo)&&(this.unregister(Mo),this.register({distinct_id:e}));var s="anonymous"===(this.persistence.get_property(aa)||"anonymous");e!==r&&s?(this.persistence.set_property(aa,"identified"),this.setPersonPropertiesForFlags(yo(yo({},n||{}),t||{}),!1),this.capture("$identify",{distinct_id:e,$anon_distinct_id:r},{$set:t||{},$set_once:n||{}}),this.featureFlags.setAnonymousDistinctId(r),this._cachedIdentify=Sh(e,t,n)):(t||n)&&(this._cachedIdentify!==Sh(e,t,n)?(this.setPersonProperties(t,n),this._cachedIdentify=Sh(e,t,n)):po.info("A duplicate posthog.identify call was made with the same properties. It has been ignored.")),e!==r&&(this.reloadFeatureFlags(),this.unregister(oa))}}else po.error("Unique user id has not been set in posthog.identify")}setPersonProperties(e,t){(e||t)&&this._requirePersonProcessing("posthog.setPersonProperties")&&(this.setPersonPropertiesForFlags(yo(yo({},t||{}),e||{})),this.capture("$set",{$set:e||{},$set_once:t||{}}))}group(e,t,n){if(e&&t){if(this._requirePersonProcessing("posthog.group")){var r=this.getGroups();r[e]!==t&&this.resetGroupPropertiesForFlags(e),this.register({$groups:yo(yo({},r),{},{[e]:t})}),n&&(this.capture("$groupidentify",{$group_type:e,$group_key:t,$group_set:n}),this.setGroupPropertiesForFlags({[e]:n})),r[e]===t||n||this.reloadFeatureFlags()}}else po.error("posthog.group requires a group type and group key")}resetGroups(){this.register({$groups:{}}),this.resetGroupPropertiesForFlags(),this.reloadFeatureFlags()}setPersonPropertiesForFlags(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.featureFlags.setPersonPropertiesForFlags(e,t)}resetPersonPropertiesForFlags(){this.featureFlags.resetPersonPropertiesForFlags()}setGroupPropertiesForFlags(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._requirePersonProcessing("posthog.setGroupPropertiesForFlags")&&this.featureFlags.setGroupPropertiesForFlags(e,t)}resetGroupPropertiesForFlags(e){this.featureFlags.resetGroupPropertiesForFlags(e)}reset(e){var t,n,r,i;if(po.info("reset"),!this.__loaded)return po.uninitializedWarning("posthog.reset");var s=this.get_property("$device_id");if(this.consent.reset(),null===(t=this.persistence)||void 0===t||t.clear(),null===(n=this.sessionPersistence)||void 0===n||n.clear(),this.surveys.reset(),null===(r=this.persistence)||void 0===r||r.set_property(aa,"anonymous"),null===(i=this.sessionManager)||void 0===i||i.resetSessionId(),this._cachedIdentify=null,this.config.__preview_experimental_cookieless_mode)this.register_once({distinct_id:fa,$device_id:null},"");else{var o=this.config.get_device_id(Ca());this.register_once({distinct_id:o,$device_id:e?o:s},"")}this.register({$last_posthog_reset:(new Date).toISOString()},1)}get_distinct_id(){return this.get_property("distinct_id")}getGroups(){return this.get_property("$groups")||{}}get_session_id(){var e,t;return null!==(e=null===(t=this.sessionManager)||void 0===t?void 0:t.checkAndGetSessionAndWindowId(!0).sessionId)&&void 0!==e?e:""}get_session_replay_url(e){if(!this.sessionManager)return"";var{sessionId:t,sessionStartTimestamp:n}=this.sessionManager.checkAndGetSessionAndWindowId(!0),r=this.requestRouter.endpointFor("ui","/project/".concat(this.config.token,"/replay/").concat(t));if(null!=e&&e.withTimestamp&&n){var i,s=null!==(i=e.timestampLookBack)&&void 0!==i?i:10;if(!n)return r;var o=Math.max(Math.floor(((new Date).getTime()-n)/1e3)-s,0);r+="?t=".concat(o)}return r}alias(e,t){return e===this.get_property(xo)?(po.critical("Attempting to create alias for existing People user - aborting."),-2):this._requirePersonProcessing("posthog.alias")?(no(t)&&(t=this.get_distinct_id()),e!==t?(this._register_single(Mo,e),this.capture("$create_alias",{alias:e,distinct_id:t})):(po.warn("alias matches current distinct_id - skipping api call."),this.identify(e),-1)):void 0}set_config(e){var t,n,r,i,s=yo({},this.config);eo(e)&&(wo(this.config,Oh(e)),null===(t=this.persistence)||void 0===t||t.update_config(this.config,s),this.sessionPersistence="sessionStorage"===this.config.persistence||"memory"===this.config.persistence?this.persistence:new Jc(yo(yo({},this.config),{},{persistence:"sessionStorage"})),La.is_supported()&&"true"===La.get("ph_debug")&&(this.config.debug=!0),this.config.debug&&(Ks.DEBUG=!0,po.info("set_config",{config:e,oldConfig:s,newConfig:yo({},this.config)})),null===(n=this.sessionRecording)||void 0===n||n.startIfEnabledOrStop(),null===(r=this.autocapture)||void 0===r||r.startIfEnabled(),null===(i=this.heatmaps)||void 0===i||i.startIfEnabled(),this.surveys.loadIfEnabled(),this._sync_opt_out_with_persistence())}startSessionRecording(e){var t,n,r,i,s,o=!0===e,a={sampling:o||!(null==e||!e.sampling),linked_flag:o||!(null==e||!e.linked_flag),url_trigger:o||!(null==e||!e.url_trigger),event_trigger:o||!(null==e||!e.event_trigger)};Object.values(a).some(Boolean)&&(null===(t=this.sessionManager)||void 0===t||t.checkAndGetSessionAndWindowId(),a.sampling&&(null===(n=this.sessionRecording)||void 0===n||n.overrideSampling()),a.linked_flag&&(null===(r=this.sessionRecording)||void 0===r||r.overrideLinkedFlag()),a.url_trigger&&(null===(i=this.sessionRecording)||void 0===i||i.overrideTrigger("url")),a.event_trigger&&(null===(s=this.sessionRecording)||void 0===s||s.overrideTrigger("event"))),this.set_config({disable_session_recording:!1})}stopSessionRecording(){this.set_config({disable_session_recording:!0})}sessionRecordingStarted(){var e;return!(null===(e=this.sessionRecording)||void 0===e||!e.started)}captureException(e,t){var n,r=new Error("PostHog syntheticException"),i=Zs(null===(n=qs.__PosthogExtensions__)||void 0===n?void 0:n.parseErrorAsProperties)?yo(yo({},qs.__PosthogExtensions__.parseErrorAsProperties(lo(e)?{error:e,event:e.message}:{event:e},{syntheticException:r})),t):yo({$exception_level:"error",$exception_list:[{type:lo(e)?e.name:"Error",value:lo(e)?e.message:e,mechanism:{handled:!0,synthetic:!1}}]},t);this.exceptions.sendExceptionEvent(i)}loadToolbar(e){return this.toolbar.loadToolbar(e)}get_property(e){var t;return null===(t=this.persistence)||void 0===t?void 0:t.props[e]}getSessionProperty(e){var t;return null===(t=this.sessionPersistence)||void 0===t?void 0:t.props[e]}toString(){var e,t=null!==(e=this.config.name)&&void 0!==e?e:Th;return t!==Th&&(t=Th+"."+t),t}_isIdentified(){var e,t;return"identified"===(null===(e=this.persistence)||void 0===e?void 0:e.get_property(aa))||"identified"===(null===(t=this.sessionPersistence)||void 0===t?void 0:t.get_property(aa))}_hasPersonProcessing(){var e,t,n,r;return!("never"===this.config.person_profiles||"identified_only"===this.config.person_profiles&&!this._isIdentified()&&to(this.getGroups())&&(null===(e=this.persistence)||void 0===e||null===(t=e.props)||void 0===t||!t[Mo])&&(null===(n=this.persistence)||void 0===n||null===(r=n.props)||void 0===r||!r[pa]))}_shouldCapturePageleave(){return!0===this.config.capture_pageleave||"if_capture_pageview"===this.config.capture_pageleave&&this.config.capture_pageview}createPersonProfile(){this._hasPersonProcessing()||this._requirePersonProcessing("posthog.createPersonProfile")&&this.setPersonProperties({},{})}_requirePersonProcessing(e){return"never"===this.config.person_profiles?(po.error(e+' was called, but process_person is set to "never". This call will be ignored.'),!1):(this._register_single(pa,!0),!0)}_sync_opt_out_with_persistence(){var e,t,n,r,i=this.consent.isOptedOut(),s=this.config.opt_out_persistence_by_default,o=this.config.disable_persistence||i&&!!s;(null===(e=this.persistence)||void 0===e?void 0:e.disabled)!==o&&(null===(n=this.persistence)||void 0===n||n.set_disabled(o)),(null===(t=this.sessionPersistence)||void 0===t?void 0:t.disabled)!==o&&(null===(r=this.sessionPersistence)||void 0===r||r.set_disabled(o))}opt_in_capturing(e){var t;this.consent.optInOut(!0),this._sync_opt_out_with_persistence(),(no(null==e?void 0:e.captureEventName)||null!=e&&e.captureEventName)&&this.capture(null!==(t=null==e?void 0:e.captureEventName)&&void 0!==t?t:"$opt_in",null==e?void 0:e.captureProperties,{send_instantly:!0}),this.config.capture_pageview&&this._captureInitialPageview()}opt_out_capturing(){this.consent.optInOut(!1),this._sync_opt_out_with_persistence()}has_opted_in_capturing(){return this.consent.isOptedIn()}has_opted_out_capturing(){return this.consent.isOptedOut()}clear_opt_in_out_capturing(){this.consent.reset(),this._sync_opt_out_with_persistence()}_is_bot(){return xs?Jd(xs,this.config.custom_blocked_useragents):void 0}_captureInitialPageview(){Ms&&!this._initialPageviewCaptured&&(this._initialPageviewCaptured=!0,this.capture("$pageview",{title:Ms.title},{send_instantly:!0}))}debug(e){!1===e?(null==Os||Os.console.log("You've disabled debug mode."),localStorage&&localStorage.removeItem("ph_debug"),this.set_config({debug:!1})):(null==Os||Os.console.log("You're now in debug mode. All calls to PostHog will be logged in your console.\nYou can disable this with `posthog.debug(false)`."),localStorage&&localStorage.setItem("ph_debug","true"),this.set_config({debug:!0}))}_runBeforeSend(e){if(oo(this.config.before_send))return e;var t=Qs(this.config.before_send)?this.config.before_send:[this.config.before_send],n=e;for(var r of t){if(n=r(n),oo(n)){var i="Event '".concat(e.event,"' was rejected in beforeSend function");return uo(e.event)?po.warn("".concat(i,". This can cause unexpected behavior.")):po.info(i),null}n.properties&&!to(n.properties)||po.warn("Event '".concat(e.event,"' has no properties after beforeSend function, this is likely an error."))}return n}getPageViewId(){var e;return null===(e=this.pageViewManager._currentPageview)||void 0===e?void 0:e.pageViewId}}!function(e,t){for(var n=0;n<t.length;n++)e.prototype[t[n]]=Ro(e.prototype[t[n]])}(Ph,["identify"]);var Dh,Nh=(Dh=wh[Th]=new Ph,function(){function e(){e.done||(e.done=!0,kh=!1,So(wh,(function(e){e._dom_loaded()})))}null!=Ms&&Ms.addEventListener?"complete"===Ms.readyState?e():No(Ms,"DOMContentLoaded",e,{capture:!1}):Os&&po.error("Browser doesn't support `document.addEventListener` so PostHog couldn't be initialized")}(),Dh);function xh(e){return xh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},xh(e)}function Mh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Lh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Mh(Object(n),!0).forEach((function(t){Bh(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Mh(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Bh(e,t,n){return(t=qh(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Uh(){Uh=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof v?t:v,o=Object.create(s.prototype),a=new C(r||[]);return i(o,"_invoke",{value:T(e,n,a)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",g="executing",f="completed",m={};function v(){}function y(){}function _(){}var b={};l(b,o,(function(){return this}));var E=Object.getPrototypeOf,A=E&&E(E(P([])));A&&A!==n&&r.call(A,o)&&(b=A);var S=_.prototype=v.prototype=Object.create(b);function w(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function I(e,t){function n(i,s,o,a){var c=d(e[i],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==xh(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var s;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return s=s?s.then(i,i):i()}})}function T(t,n,r){var i=h;return function(s,o){if(i===g)throw Error("Generator is already running");if(i===f){if("throw"===s)throw o;return{value:e,done:!0}}for(r.method=s,r.arg=o;;){var a=r.delegate;if(a){var c=k(a,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===h)throw i=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=g;var l=d(t,n,r);if("normal"===l.type){if(i=r.done?f:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=f,r.method="throw",r.arg=l.arg)}}}function k(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var s=d(i,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,m;var o=s.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function P(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,s=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(xh(t)+" is not iterable")}return y.prototype=_,i(S,"constructor",{value:_,configurable:!0}),i(_,"constructor",{value:y,configurable:!0}),y.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},w(I.prototype),l(I.prototype,a,(function(){return this})),t.AsyncIterator=I,t.async=function(e,n,r,i,s){void 0===s&&(s=Promise);var o=new I(u(e,n,r,i),s);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},w(S),l(S,c,"Generator"),l(S,o,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=P,C.prototype={constructor:C,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(O),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return a.type="throw",a.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,m):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;O(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:P(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function Fh(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function jh(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,qh(r.key),r)}}function qh(e){var t=function(e){if("object"!=xh(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=xh(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==xh(t)?t:t+""}var Kh=function(){return function(e,t){return t&&jh(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}((function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.pendingEvents=[],this.init()}),[{key:"init",value:(e=function(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){Fh(s,r,i,o,a,"next",e)}function a(e){Fh(s,r,i,o,a,"throw",e)}o(void 0)}))}}(Uh().mark((function e(){return Uh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{window.posthog&&Nh.init(c.posthogToken,{api_host:c.posthogUrl,autocapture:!1,advanced_disable_decide:!0})}catch(e){console.error("Error during Posthog initialization:",e)}case 1:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})},{key:"getSession",value:function(e){try{var t=sessionStorage.getItem(e);return"undefined"===t||""===t?{}:JSON.parse(t)}catch(e){console.error(e)}}},{key:"removeSession",value:function(e){try{sessionStorage.removeItem(e)}catch(e){console.error(e)}}},{key:"getLocal",value:function(e){try{var t=localStorage.getItem(e);return"undefined"===t||""===t?{}:JSON.parse(t)}catch(e){console.error(e)}}},{key:"getMobileOperatingSystem",value:function(){var e=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(e)?"Windows Phone":/android/i.test(e)?"Android":/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"iOS":"unknown"}},{key:"massagePosthogPostEvent",value:function(e,t){try{var n,r=this.getLocal("visitorId"),i=this.getSession("mdGameId")||"",s=this.getSession("gameImgUrl")||"",o=this.getSession("fromGame")||"",a=this.getLocal("uKey")||"",l=this.getMobileOperatingSystem(),u=null===(n=this.getSession("player"))||void 0===n?void 0:n.playerId,d=Lh(Lh(Lh(Lh(Lh({eventName:e,userGuid:a,phoneType:l,liveChatName:c.liveChatName,visitorId:r},u&&{playerId:u}),o&&{fromGame:o}),i&&{gameId:i}),s&&{imageUrl:s}),t||{});return JSON.stringify(d)}catch(e){console.log(e)}}},{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!this.getLocal("visitorId"))return void this.pendingEvents.push({type:"click_event",eventName:e,data:t});Nh.capture("click_event",{property:this.massagePosthogPostEvent(e,t)}),3===c.env&&console.log("click_event",this.massagePosthogPostEvent(e,t))}catch(e){console.error("Posthog click event failed",e)}}},{key:"pageView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!this.getLocal("visitorId"))return void this.pendingEvents.push({type:"$pageview",data:t});Nh.capture("$pageview",{property:this.massagePosthogPostEvent(e,t)}),3===c.env&&console.log("$pageview",this.massagePosthogPostEvent(e,t))}catch(e){console.error("Posthog pageview failed",e)}}}]);var e}();const $h=new Kh;function Vh(e){return Vh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Vh(e)}function Gh(){Gh=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof v?t:v,o=Object.create(s.prototype),a=new C(r||[]);return i(o,"_invoke",{value:T(e,n,a)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",g="executing",f="completed",m={};function v(){}function y(){}function _(){}var b={};l(b,o,(function(){return this}));var E=Object.getPrototypeOf,A=E&&E(E(P([])));A&&A!==n&&r.call(A,o)&&(b=A);var S=_.prototype=v.prototype=Object.create(b);function w(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function I(e,t){function n(i,s,o,a){var c=d(e[i],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==Vh(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var s;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return s=s?s.then(i,i):i()}})}function T(t,n,r){var i=h;return function(s,o){if(i===g)throw Error("Generator is already running");if(i===f){if("throw"===s)throw o;return{value:e,done:!0}}for(r.method=s,r.arg=o;;){var a=r.delegate;if(a){var c=k(a,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===h)throw i=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=g;var l=d(t,n,r);if("normal"===l.type){if(i=r.done?f:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=f,r.method="throw",r.arg=l.arg)}}}function k(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var s=d(i,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,m;var o=s.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function P(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,s=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(Vh(t)+" is not iterable")}return y.prototype=_,i(S,"constructor",{value:_,configurable:!0}),i(_,"constructor",{value:y,configurable:!0}),y.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},w(I.prototype),l(I.prototype,a,(function(){return this})),t.AsyncIterator=I,t.async=function(e,n,r,i,s){void 0===s&&(s=Promise);var o=new I(u(e,n,r,i),s);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},w(S),l(S,c,"Generator"),l(S,o,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=P,C.prototype={constructor:C,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(O),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return a.type="throw",a.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,m):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;O(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:P(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function Hh(e){return function(e){if(Array.isArray(e))return Wh(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return Wh(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Wh(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Wh(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Jh(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function Yh(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){Jh(s,r,i,o,a,"next",e)}function a(e){Jh(s,r,i,o,a,"throw",e)}o(void 0)}))}}function zh(e){var t,n,r=(null===(t=_[c.env])||void 0===t?void 0:t.cdnUrl)||"",i=(null===(n=_[c.env])||void 0===n?void 0:n.cdnPath)||"";return e.replace(/data-src="([^"]+)"/g,(function(e,t){return'src="'.concat(r).concat(i).concat(t,'"')}))}function Xh(e){if(!document.querySelector(".btn-livechat")&&c.isShowBotIcon&&document.body.insertAdjacentHTML("beforeend",zh('<button class="btn-livechat"> <img data-src="/chat-icon.svg" alt="chat-icon"> </button>')),!document.getElementById("chatPopup")){document.body.insertAdjacentHTML("beforeend",zh('<div id="chatPopup" class="chat-window" data-version="2.5.0" data-env="3"> <div class="chat-header"> <button class="btn-widget-back"> <img data-src="/icon-back.svg" alt="icon-back"> </button> <div class="chatbot-user"> <div class="chatbot-pic"> <img data-src="/chatbot-display-picture.svg" alt="chatbot-display-picture"> <span class="chatbot-status"></span> </div> <div class="chatbot-title"> <h2>Chatbot</h2> <h6>Customer Service</h6> </div> </div> <button id="endChat" class="endchat-btn">End Chat</button> </div> <div class="chat-area" id="chatArea"> <div class="chat-message"> </div> <div class="chat-attachment"> <div class="attachment-wrap"> <div class="attachment-btn"> <div class="file-upload" id="uploadBtn"> <div class="file-preview" id="filePreview"></div> <div class="file-icon"> <img data-src="/icon-upload.svg" alt="icon-upload"> </div> <h5>Browse files to upload</h5> <p class="file-supported">Supported formats: MP4, MKV, MOV, WEBM, JPEG/JPG, PNG, GIF, WEBP</p> </div> <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.png" style="display:none"> </div> </div> </div> </div> <div class="chat-input-wrap"> <div class="emoji-popup" id="emojiPopup"> <div class="emoji-list"> <div class="emoji-row"> <div class="emoji" data-emoji="😀">😀</div> <div class="emoji" data-emoji="😅">😅</div> <div class="emoji" data-emoji="🥰">🥰</div> <div class="emoji" data-emoji="😇">😇</div> <div class="emoji" data-emoji="🙂">🙂</div> <div class="emoji" data-emoji="😋">😋</div> </div> <div class="emoji-row"> <div class="emoji" data-emoji="🤪">🤪</div> <div class="emoji" data-emoji="🤐">🤐</div> <div class="emoji" data-emoji="😏">😏</div> <div class="emoji" data-emoji="🤗">🤗</div> <div class="emoji" data-emoji="😪">😪</div> <div class="emoji" data-emoji="🙄">🙄</div> </div> <div class="emoji-row"> <div class="emoji" data-emoji="🤫">🤫</div> <div class="emoji" data-emoji="😴">😴</div> <div class="emoji" data-emoji="🥵">🥵</div> <div class="emoji" data-emoji="😫">😫</div> <div class="emoji" data-emoji="😭">😭</div> <div class="emoji" data-emoji="😱">😱</div> </div> </div> </div> <div class="chat-input"> <textarea id="chatInput" placeholder="Write a message" rows="1"></textarea> <div class="chat-tool"> <button id="emojiBtn" class="emoji-btn"> <img data-src="/icon-emoji.svg" alt="icon-emoji"> </button> <button id="attachmentBtn" class="attachment-btn"> <img data-src="/icon-attachment.svg" alt="icon-attachment"> <img data-src="/icon-bubble.svg" alt="icon-bubble"> </button> <button id="liveagentBtn" class="liveagent-btn"> <img data-src="/icon-liveagent.svg" alt="icon-liveagent"> </button> <button id="sendBtn" class="send-btn"> <img data-src="/icon-send.svg" alt="icon-send"> </button> </div> </div> </div> </div>'));var t=document.getElementById("chatPopup").querySelector(".chat-input-wrap"),n=document.getElementById("attachmentBtn"),r=document.getElementById("emojiPopup");t&&(t.insertAdjacentHTML("afterend",zh('<div class="chat-rate-review"> <div class="rate-review-wrap"> <a class="rate-review-close"> <img data-src="/icon-close.svg" alt="icon-close"> </a> <div class="rate-review-content"> <h2>Rate & Review</h2> <div class="rate"> <input type="radio" id="rateStar5" name="rate" value="5"/> <label for="rateStar5" title="text">5 stars</label> <input type="radio" id="rateStar4" name="rate" value="4"/> <label for="rateStar4" title="text">4 stars</label> <input type="radio" id="rateStar3" name="rate" value="3"/> <label for="rateStar3" title="text">3 stars</label> <input type="radio" id="rateStar2" name="rate" value="2"/> <label for="rateStar2" title="text">2 stars</label> <input type="radio" id="rateStar1" name="rate" value="1"/> <label for="rateStar1" title="text">1 star</label> </div> <h6>Please rate my service</h6> <div class="review"> <textarea id="chatReview" placeholder="Add your thoughts here..." rows="3"></textarea> </div> <div id="rateError" class="error-message"> Please provide a rating or add a message. </div> <div class="rate-review-btn"> <button id="rateCancel" class="btn-ratereview">Cancel</button> <button id="rateSubmit" class="btn-ratereview">Submit</button> </div> </div> </div> </div>')),t.insertAdjacentHTML("afterend",zh('<div class="chat-error"> <div class="error-wrap"> <div class="error-content"> <h2>Reminder</h2> <p>Contacting CS...</p> <div class="error-btn"> <button id="errorSubmit" class="btn-error">Confirm <span class="error-timeout"></span></button> </div> </div> </div> </div>')),2===c.channel&&(null==n||n.classList.add("hide"),null==r||r.classList.add("attachment-hidden")))}e&&e()}function Qh(){return Zh.apply(this,arguments)}function Zh(){return(Zh=Yh(Gh().mark((function e(){var t,n,r,i,s,o,a,l,d,h;return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("chatPopup"),n=document.getElementById("chatInput"),r=Object.fromEntries(["emojiBtn","emojiPopup","sendBtn","attachmentBtn"].map((function(e){return[e,document.getElementById(e)]}))),i=r.emojiBtn,s=r.emojiPopup,o=r.sendBtn,a=r.attachmentBtn,l=document.querySelector(".chat-attachment"),d=document.getElementById("rateError"),!t){e.next=32;break}if(window._processedMessageIds&&window._processedMessageIds.clear(),t.classList.remove("chat-visible","user-logged-in"),t.classList.add("chat-ended","user-logged-out"),e.prev=9,!c.matrixSynced){e.next=18;break}return e.next=13,j.getOtherRoomMembers();case 13:return h=e.sent,c.isDevDebug&&console.log("AiLC -- main -- Other user IDs in the room:",h),e.next=17,ms.endSession(c,h);case 17:j.endMatrix();case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(9),console.error("Failed to end chat:",e.t0);case 23:document.querySelector(".chat-message").innerHTML="",u("checkAttachmentActive",!1),n.disabled=!1,n.value="",[i,s,o,a,l].forEach((function(e){return e.classList.remove("active")})),u("conversationId",""),u("forcetoliveagent",!1),u("isLiveAgentRequested",!1),d.style.display="none";case 32:case"end":return e.stop()}}),e,null,[[9,20]])})))).apply(this,arguments)}function ep(){var e,t=document.getElementById("chatReview");document.querySelector('.rate input[type="radio"]:checked'),null===(e=document.querySelector(".chat-rate-review"))||void 0===e||e.classList.remove("rate-review-visible"),document.querySelectorAll('.chat-rate-review .rate input[type="radio"]').forEach((function(e){return e.checked=!1})),t.value="",document.querySelectorAll('.rate input[type="radio"]').checked=!1,Qh()}function tp(){var e=document.querySelector('.rate input[type="radio"]:checked'),t=(document.getElementById("chatReview"),document.getElementById("chatReview").value.trim()),n=document.getElementById("rateError");if(e||t){n&&(n.style.display="none");var r=(null==e?void 0:e.value)||null,i=t||null;try{$h.send("H5-Ai-Livechat-RateAndReview"),ms.rateReview({rating:r,message:i,widgetState:c}),ep()}catch(e){console.error("Failed to submit rate and review:",e)}}else n&&(n.style.display="block")}function np(e){var t={aiLoading:e};try{(0,E.$p)({type:"aiLivechat",data:t})}catch(e){throw console.error("Unexpected error in $p:",e),e}}function rp(){return ip.apply(this,arguments)}function ip(){return(ip=Yh(Gh().mark((function e(){var t,n,r,i,s,o,a,l,d,h,p,g;return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!c.isChatPopupOpening){e.next=3;break}return console.warn("Chat popup is already opening. Please wait."),e.abrupt("return");case 3:if(u("isChatPopupOpening",!0),np(!0),t=document.getElementById("chatPopup")){e.next=11;break}return console.error("Chat popup element not found"),u("isChatPopupOpening",!1),np(!1),e.abrupt("return");case 11:if(t.classList.contains("chat-init")||((n=document.querySelector(".btn-widget-back"))&&n.addEventListener("click",y.hideChatPopup),(r=document.getElementById("endChat"))&&r.addEventListener("click",(function(){var e=document.querySelector(".chat-rate-review");c.conversationId?e.classList.add("rate-review-visible"):Qh()})),i=document.getElementById("rateCancel"),s=document.querySelector(".rate-review-close"),o=document.getElementById("rateSubmit"),i.addEventListener("click",ep),s.addEventListener("click",ep),o.addEventListener("click",tp)),t.classList.contains("chat-init")&&!t.classList.contains("chat-ended")&&!t.classList.contains("user-logged-out")){e.next=51;break}return t.classList.remove("chat-hidden","chat-ended","user-logged-out"),y.displayLoading(),e.prev=14,e.next=17,ms.loginOrRegister(c);case 17:return a=e.sent,l=a.accessToken,d=a.roomId,h=a.guestName,p=a.liveChatName,g=a.refreshToken,u("accessToken",l),u("roomId",d),(null==h?void 0:h.length)>0&&u("guestName",h),u("liveChatName",p),sessionStorage.setItem("refreshToken",g),e.next=30,j.init({accessToken:c.accessToken,guestName:c.guestName,playerId:c.playerId,liveChatName:c.liveChatName});case 30:return e.next=32,j.loginToMatrix();case 32:return t.classList.add("user-logged-in"),$h.pageView("H5-Ai-Livechat-Popup"),e.next=36,j.joinRoom(c.roomId);case 36:y.displayWelcomeMessage(b()),j.listenForMessages(),e.next=45;break;case 40:return e.prev=40,e.t0=e.catch(14),console.error("Failed to login or join room:",e.t0),np(!1),e.abrupt("return");case 45:return e.prev=45,u("isChatPopupOpening",!1),e.finish(45);case 48:t.classList.add("chat-init","chat-visible"),e.next=56;break;case 51:return t.classList.remove("chat-hidden"),t.classList.add("chat-visible"),e.next=55,j.validateAndRefreshToken();case 55:u("isChatPopupOpening",!1);case 56:np(!1);case 57:case"end":return e.stop()}}),e,null,[[14,40,45,48]])})))).apply(this,arguments)}function sp(){return op.apply(this,arguments)}function op(){return(op=Yh(Gh().mark((function e(){var t,n;return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,c.isDevDebug&&console.log("AiLC -- main -- widgetState",c),c.forcetoliveagent||c.isLiveAgentRequested){e.next=19;break}return c.isDevDebug&&console.log("AiLC -- main -- transferLiveAgent:","execute"),$h.send("H5-Ai-Livechat-TransferLiveAgent"),e.prev=5,e.next=8,ms.sendMessage("",c,!0);case 8:return n=e.sent,c.isDevDebug&&console.log("AiLC -- main -- bot response",n),c.conversationId||u("conversationId",n.conversationId),u("isLiveAgentRequested",!0),"forcetoliveagent"===(null==n||null===(t=n.botOptions)||void 0===t?void 0:t.type)?(u("forcetoliveagent",!0),c.isDevDebug&&console.log('AiLC -- main -- bot options shows "forcetoliveagent".')):c.isDevDebug&&console.log("AiLC -- main -- UI not ready for this type of bot options"),e.abrupt("return",!0);case 16:e.prev=16,e.t0=e.catch(5),console.error("Error sending gRPC message:",e.t0);case 19:return e.abrupt("return",!1);case 22:e.prev=22,e.t1=e.catch(0),console.error("Error in transferring live agent:",e.t1);case 25:case"end":return e.stop()}}),e,null,[[0,22],[5,16]])})))).apply(this,arguments)}function ap(e){return cp.apply(this,arguments)}function cp(){return(cp=Yh(Gh().mark((function e(t){var n,r,i,s;return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null===(n=t.value)||void 0===n?void 0:n.trim()){e.next=3;break}return e.abrupt("return");case 3:if(t.value="",e.prev=4,$h.send("H5-Ai-Livechat-SendMessage"),!c.forcetoliveagent){e.next=9;break}return j.sendMessage(r,c.roomId),e.abrupt("return");case 9:return e.next=11,ms.sendMessage(r,c);case 11:if(s=e.sent,c.conversationId||u("conversationId",botResponseMedia.conversationId),c.isDevDebug&&console.log("AiLC -- main -- bot response",s),s.botOptions){e.next=16;break}return e.abrupt("return");case 16:"forcetoliveagent"===(null==s||null===(i=s.botOptions)||void 0===i?void 0:i.type)?(u("forcetoliveagent",!0),c.isDevDebug&&console.log('AiLC -- main -- bot options shows "forcetoliveagent".')):c.isDevDebug&&console.log("AiLC -- main -- UI not ready for this type of bot options"),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(4),console.error("Error in sending transfer live agent to bot:",e.t0);case 22:case"end":return e.stop()}}),e,null,[[4,19]])})))).apply(this,arguments)}function lp(){var e=document.getElementById("emojiBtn"),t=document.getElementById("emojiPopup");if(e&&t){var n=e.getBoundingClientRect(),r=window.innerWidth-(n.left+n.width/2);window.innerWidth<316&&(r-=33),t.style.right="".concat(r,"px")}}function up(){var e=document.getElementById("chatInput"),t=document.getElementById("sendBtn"),n=document.getElementById("attachmentBtn"),r=document.querySelector(".chat-attachment");document.querySelector(".btn-livechat")&&function(e){var t=document.querySelector(".btn-livechat");As=e,t&&(bs.x=window.innerWidth-t.clientWidth-18,bs.y=window.innerHeight-t.clientHeight-55,Ts(),t.addEventListener("mousedown",Ss),t.addEventListener("touchstart",Ss,{passive:!1}),window.addEventListener("resize",ks))}(rp);var i=document.getElementById("emojiBtn"),s=document.getElementById("emojiPopup");chatPopup.classList.contains("chat-init")||(i&&i.addEventListener("click",(function(){i.classList.toggle("active"),s.classList.toggle("active"),r.classList.remove("active"),n.classList.remove("active"),e.disabled=!1,u("checkAttachmentActive",!1)})),document.querySelectorAll(".emoji-popup .emoji").forEach((function(e){e.addEventListener("click",(function(){i.classList.toggle("active"),s.classList.toggle("active"),t.classList.add("active");var n=e.getAttribute("data-emoji");y.addEmoji(n)}))}))),n.addEventListener("click",(function(){i.classList.remove("active"),s.classList.remove("active"),t.classList.remove("active"),r.classList.toggle("active"),n.classList.toggle("active"),u("checkAttachmentActive",!c.checkAttachmentActive);var o=c.checkAttachmentActive;e.disabled=o}));var o={video:["mp4","mkv","x-matroska","mov","quicktime","webm"],photo:["jpg","jpeg","png","gif","webp"]},a=[].concat(Hh(o.video.map((function(e){return"video/".concat(e)}))),Hh(o.photo.map((function(e){return"image/".concat(e)})))).join(","),l=document.getElementById("uploadBtn"),d=document.getElementById("fileInput");d.accept=a,l.addEventListener("click",(function(){document.getElementById("fileInput").click()})),d.addEventListener("change",(function(e){var n,r=null===(n=e.target)||void 0===n?void 0:n.files[0],i=document.querySelector(".attachment-wrap"),s=document.getElementById("filePreview"),a=document.querySelector(".file-supported");if(s.innerHTML="",a&&(null==a||a.classList.remove("c-red")),r){var c=r.name.split(".").pop().toLowerCase();if(![].concat(Hh(o.video),Hh(o.photo)).includes(c))return a.classList.add("c-red"),s.innerHTML="<p>Unsupported file type</p>",i.classList.remove("inserted"),t.classList.remove("active"),void u("checkAttachmentAvailability",!1);if(t.classList.add("active"),i.classList.add("inserted"),o.photo.includes(c)){var l=document.createElement("img");l.src=URL.createObjectURL(r),l.alt=r.name,l.className="file-img-preview";var d=document.createElement("p");d.innerHTML=r.name,s.appendChild(l),s.appendChild(d)}else o.video.includes(c)&&(s.innerHTML="<p>Selected video: ".concat(r.name,"</p>"));u("checkAttachmentAvailability",!0)}else u("checkAttachmentAvailability",!1),t.classList.remove("active"),i.classList.remove("inserted")})),window.addEventListener("focus",Yh(Gh().mark((function e(){return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!chatPopup.classList.contains("chat-visible")){e.next=9;break}return e.prev=1,e.next=4,j.validateAndRefreshToken();case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(1),console.error("Token validation on tab focus failed:",e.t0);case 9:case"end":return e.stop()}}),e,null,[[1,6]])})))),e.addEventListener("input",(function(){var e;t.classList.toggle("active",(null===(e=this.value)||void 0===e||null===(e=e.trim())||void 0===e?void 0:e.length)>0)})),e.addEventListener("keypress",function(){var n=Yh(Gh().mark((function n(r){return Gh().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:"Enter"!==r.key||r.shiftKey||(r.preventDefault(),c.checkAttachmentActive||(ap(e),t.classList.remove("active")));case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()),t.addEventListener("click",Yh(Gh().mark((function i(){var s,o,a,l,h,p,g,f;return Gh().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(c.checkAttachmentActive){i.next=4;break}return ap(e),t.classList.remove("active"),i.abrupt("return");case 4:if(!c.checkAttachmentAvailability){i.next=40;break}return np(!0),document.querySelector(".attachment-wrap").classList.remove("inserted"),(s=document.getElementById("filePreview")).innerHTML="",(o=document.getElementsByClassName("file-img-preview")).length>0&&o.forEach((function(e,t){s.removeChild(o[t])})),i.prev=12,$h.send("H5-Ai-Livechat-SendMedia"),i.next=16,j.sendMediaMessageToMatrix(d.files[0],c.roomId);case 16:if(l=i.sent,0!==(null===(a=Object.keys(l||{}))||void 0===a?void 0:a.length)){i.next=19;break}return i.abrupt("return");case 19:if(h=l.mediaUrl,l.mediaId,p=l.mediaUId,g=d.files[0].type,d.value="",h&&(u("photoUrl",h),n.classList.toggle("active"),r.classList.toggle("active"),e.disabled=!1,c.isDevDebug&&console.log("AiLC -- main -- Media Image URL stored:",c.photoUrl)),!g.startsWith("image/")){i.next=28;break}return i.next=26,ms.sendMedia(p,c);case 26:f=i.sent,c.conversationId||u("conversationId",f.conversationId);case 28:np(!1),u("checkAttachmentActive",!1),u("checkAttachmentAvailability",!1),i.next=37;break;case 33:return i.prev=33,i.t0=i.catch(12),console.error("Failed to send media:",i.t0),i.abrupt("return");case 37:return i.prev=37,np(!1),i.finish(37);case 40:case"end":return i.stop()}}),i,null,[[12,33,37,40]])}))));var h=document.getElementById("liveagentBtn");h&&h.addEventListener("click",Yh(Gh().mark((function e(){return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,sp();case 3:e.sent&&h.classList.add("disabled"),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("Failed to transfer to live agent:",e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])}))))}function dp(){clearTimeout(c.activityTimeoutID);var e=c.conversationTimeout||5;u("activityTimeoutID",setTimeout((function(){Qh(),c.isDevDebug&&console.log("AiLC -- main -- User is inactive, closing popup......")}),60*e*1e3))}function hp(e){_[e]&&(u("synapseDomain",_[e].synapseDomain),u("synapseEndpoint",_[e].synapseEndpoint),u("botUserId",_[e].botUserId),u("gRPCBaseUrl",_[e].gRPCBaseUrl),u("env",e))}function pp(){return(pp=Yh(Gh().mark((function e(t){var n,r,i,s,o;return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.playerId,r=t.env,i=t.channel,s=t.isShowBotIcon,console.time("AiLC -- main -- Render time"),c.isDevDebug&&console.log("AiLC -- main -- Environment:",r),e.prev=3,hp("number"==typeof r&&r>=1&&r<=3?r:3),"number"==typeof i&&u("channel",i),u("isShowBotIcon",s),ms.init(),Xh(up),document.querySelector("#chatPopup").dataset.env=r,e.next=12,ms.getLiveChatConfig();case 12:o=e.sent,j.initInfo(),null!=o&&o.conversationTimeout&&(u("conversationTimeout",o.conversationTimeout),dp(),document.addEventListener("mousemove",dp),document.addEventListener("keydown",dp),document.addEventListener("click",dp)),u("welcomeMessage",(null==o?void 0:o.welcomeMessage)||""),u("livechatEnabled",!!o.livechatEnabled),u("playerId",n||""),u("playerName",n||""),u("isGuest",!n),u("livechatEnabled",!!o.livechatEnabled),console.timeEnd("AiLC -- main -- Render time"),e.next=27;break;case 24:e.prev=24,e.t0=e.catch(3),console.error("Failed to initialize chat widget:",e.t0);case 27:return e.prev=27,lp(),e.finish(27);case 30:case"end":return e.stop()}}),e,null,[[3,24,27,30]])})))).apply(this,arguments)}function gp(){return(gp=Yh(Gh().mark((function e(t){var n;return Gh().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c.livechatEnabled){e.next=2;break}return e.abrupt("return");case 2:if(t){e.next=4;break}throw new Error("playerId is not updated.");case 4:if(!(n=document.getElementById("chatPopup")).classList.contains("user-logged-in")){e.next=18;break}return n.classList.remove("chat-visible","user-logged-in"),n.classList.add("chat-ended","user-logged-out"),document.querySelector(".chat-message").innerHTML="",e.prev=9,e.next=12,j.getOtherRoomMembers(c).then((function(e){c.isDevDebug&&console.log("AiLC -- main -- Other user IDs in the room:",e),ms.endSession(c,e)}));case 12:j.endMatrix(),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(9),console.error("Failed to end chat upon playerId update:",e.t0);case 18:u("playerId",t),u("playerName",t),u("isGuest",!1),u("accessToken",""),u("roomId",""),u("conversationId",""),document.querySelector(".chat-message").innerHTML="",c.isDevDebug&&console.log("AiLC -- main -- Update, playerId:",c);case 26:case"end":return e.stop()}}),e,null,[[9,15]])})))).apply(this,arguments)}window.addEventListener("resize",lp);const fp={initLiveChatWidget:function(e){return pp.apply(this,arguments)},updatePlayerId:function(e){return gp.apply(this,arguments)},hideLiveChatWidget:function(){var e=document.querySelector(".btn-livechat"),t=document.getElementById("chatPopup");t&&(null==e||e.classList.add("btn-livechat-hide"),t.classList.add("chat-window-hide"))},showLiveChatWidget:function(){var e=document.querySelector(".btn-livechat"),t=document.getElementById("chatPopup");t&&(null==e||e.classList.remove("btn-livechat-hide"),t.classList.remove("chat-window-hide"))},openChatPopup:rp}})(),r})()));
//# sourceMappingURL=livechat-widget.js.map